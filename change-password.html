<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Neues Passwort setzen</title>
<link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{
    --rot:#c8102e; --rot-dunkel:#a30d25; --bg:#f7f7f7; --card:#fff; --txt:#1f2937;
    --border:#e5e7eb; --ok:#2e7d32; --err:#c8102e;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--txt);
    font-family:'Atkinson Hyperlegible',system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  header{
    background:var(--rot); color:#fff; padding:12px 16px;
    display:flex; align-items:center; gap:12px; position:sticky; top:0; z-index:5;
  }
  header img{height:40px;width:auto}
  header strong{font-size:1.05rem}
  .wrap{
    max-width:520px; margin:0 auto; padding:16px; padding-bottom:calc(16px + env(safe-area-inset-bottom,0));
  }
  .card{
    background:var(--card); border-radius:14px; box-shadow:0 3px 12px rgba(0,0,0,.06);
    padding:16px;
  }
  h1{margin:.2rem 0 10px; font-size:1.35rem; color:var(--rot)}
  p{margin:0 0 12px; line-height:1.5}

  label{display:block; font-weight:700; color:var(--rot); margin-top:12px}
  .field{
    position:relative; margin-top:6px;
  }
  input[type="password"], input[type="text"]{
    width:100%; font-size:1.05rem; padding:14px 44px 14px 12px;
    background:#fafafa; border:1px solid var(--border); border-radius:10px;
  }
  .toggle{
    position:absolute; right:8px; top:50%; transform:translateY(-50%);
    border:0; background:#fff; border:1px solid var(--border);
    border-radius:8px; padding:8px 10px; font-weight:700; cursor:pointer;
  }
  .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}
  button.primary{
    flex:1; min-height:48px; font-size:1.05rem; font-weight:700;
    background:var(--rot); color:#fff; border:0; border-radius:10px; cursor:pointer;
  }
  button.primary:active{transform:translateY(1px)}
  button.primary:disabled{opacity:.6; pointer-events:none}
  .link{
    display:inline-block; margin-top:10px; color:var(--rot); text-decoration:underline;
  }
  .msg{min-height:1.2em; margin-top:10px}
  .ok{color:var(--ok)} .err{color:var(--err)}
  .info{
    background:#fff5f5; border:1px solid #f2c9d1; color:#8b0e22;
    border-radius:10px; padding:10px; margin-bottom:12px; font-size:.95rem;
  }

  /* Mobile polish */
  @media (max-width:480px){
    header strong{font-size:1rem}
    h1{font-size:1.25rem}
    input{font-size:1.05rem}
  }
</style>
</head>
<body>
<header>
  <img src="logo.png" onerror="this.src='assets/logo.png'" alt="Logo">
  <strong>FFW – Passwort ändern</strong>
</header>

<div class="wrap">
  <div id="guardInfo" class="info" style="display:none">
    Du bist nicht angemeldet. Bitte öffne diese Seite über den Link aus der E-Mail
    <br>(oder <a href="admin-login.html" class="link">zum Admin-Login</a>).
  </div>

  <div class="card">
    <h1>Neues Passwort setzen</h1>
    <p>Bitte neues Passwort eingeben und bestätigen.</p>

    <label for="npw1">Neues Passwort</label>
    <div class="field">
      <input id="npw1" type="password" placeholder="mindestens 8 Zeichen" autocomplete="new-password" inputmode="text" />
      <button class="toggle" type="button" data-for="npw1">Anzeigen</button>
    </div>

    <label for="npw2">Wiederholen</label>
    <div class="field">
      <input id="npw2" type="password" placeholder="nochmal eingeben" autocomplete="new-password" inputmode="text" />
      <button class="toggle" type="button" data-for="npw2">Anzeigen</button>
    </div>

    <div id="msg" class="msg" aria-live="polite"></div>

    <div class="row">
      <button id="save" class="primary">Speichern</button>
    </div>

    <a href="admin-dashboard.html" class="link">Zum Dashboard</a>
  </div>
</div>

<script type="module">
  import { NhostClient } from "https://esm.sh/@nhost/nhost-js@2.2.9";
  const nhost = new NhostClient({ subdomain:"hpjfrhktprpuuxvvlpsb", region:"eu-central-1" });

  const msgEl = document.getElementById('msg');
  const guardInfo = document.getElementById('guardInfo');
  const saveBtn = document.getElementById('save');

  const showMsg = (t, ok=false)=>{ msgEl.textContent = t; msgEl.className = 'msg ' + (ok?'ok':'err'); };

  // Passwort anzeigen/ausblenden
  document.querySelectorAll('.toggle').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-for');
      const inp = document.getElementById(id);
      const isPwd = inp.type === 'password';
      inp.type = isPwd ? 'text' : 'password';
      btn.textContent = isPwd ? 'Verbergen' : 'Anzeigen';
      inp.focus();
    });
  });

  // Prüfen, ob der Benutzer eingeloggt ist (typisch nach Klick in der Reset-Mail)
  const isAuth = await nhost.auth.isAuthenticatedAsync();
  if (!isAuth) {
    // Felder deaktivieren, wenn kein Login besteht
    guardInfo.style.display = 'block';
    document.getElementById('npw1').disabled = true;
    document.getElementById('npw2').disabled = true;
    saveBtn.disabled = true;
  }

  async function changePassword() {
    const p1 = (document.getElementById('npw1').value || '').trim();
    const p2 = (document.getElementById('npw2').value || '').trim();

    if (!p1 || p1.length < 8) { showMsg('Mindestens 8 Zeichen.'); return; }
    if (p1 !== p2) { showMsg('Passwörter stimmen nicht überein.'); return; }

    saveBtn.disabled = true;
    showMsg('Speichere …', true);
    try{
      await nhost.auth.changePassword(p1);
      showMsg('Passwort gespeichert. Weiter zum Dashboard …', true);
      setTimeout(()=> location.href = 'admin-dashboard.html', 900);
    }catch(e){
      showMsg(e?.message || 'Fehler beim Speichern.');
      saveBtn.disabled = false;
    }
  }

  // Button & Enter-Handling
  saveBtn.addEventListener('click', (e)=>{ e.preventDefault(); changePassword(); });
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){ e.preventDefault(); changePassword(); }
  });
</script>
</body>
</html>