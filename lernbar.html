<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Lernbar ‚Äì Responda</title>
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/pocketbase@0.21.3/dist/pocketbase.umd.js"></script>

  <style>
    :root{
      --primary:#c8102e;
      --primary-light:#fee2e2;
      --success:#16a34a;
      --warning:#f59e0b;
      --bg:#f8fafc;
      --card:#fff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --gradient-start:#667eea;
      --gradient-end:#764ba2;
    }
    
    *{box-sizing:border-box;margin:0;padding:0}
    
    body{
      font-family:'Atkinson Hyperlegible',-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
      min-height:100vh;
      color:var(--text);
      line-height:1.5;
    }
    
    /* HEADER */
    header{
      background:rgba(102,126,234,0.95);
      backdrop-filter:blur(10px);
      color:#fff;
      padding:1rem 0;
      box-shadow:0 2px 20px rgba(0,0,0,.1);
      position:sticky;
      top:0;
      z-index:100;
    }
    .header-content{
      max-width:1400px;
      margin:0 auto;
      padding:0 1.5rem;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:1rem;
      flex-wrap:wrap;
    }
    .logo{
      display:flex;
      align-items:center;
      gap:.75rem;
      font-size:1.5rem;
      font-weight:800;
    }
    .logo i{font-size:2rem}
    
    .header-actions{
      display:flex;
      gap:.75rem;
      align-items:center;
    }
    .header-btn{
      background:rgba(255,255,255,0.1);
      color:#fff;
      border:none;
      padding:.6rem 1rem;
      border-radius:.5rem;
      cursor:pointer;
      font-weight:700;
      font-size:.9rem;
      transition:all 0.2s;
      display:flex;
      align-items:center;
      gap:.5rem;
      text-decoration:none;
      font-family:inherit;
    }
    .header-btn:hover{
      background:rgba(255,255,255,0.2);
      transform:translateY(-2px);
    }
    
    /* CONTAINER */
    .container{
      max-width:1400px;
      margin:0 auto;
      padding:2rem 1.5rem;
    }
    
    /* WELCOME */
    .welcome{
      background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius:1rem;
      padding:2.5rem;
      color:#fff;
      margin-bottom:2rem;
      box-shadow:0 10px 40px rgba(0,0,0,.2);
      position:relative;
      overflow:hidden;
    }
    .welcome::before{
      content:'';
      position:absolute;
      top:-50%;
      right:-10%;
      width:300px;
      height:300px;
      background:rgba(255,255,255,0.1);
      border-radius:50%;
    }
    .welcome-content{
      position:relative;
      z-index:1;
    }
    .welcome h1{
      font-size:2rem;
      margin-bottom:.5rem;
      font-weight:800;
    }
    .welcome p{
      font-size:1.1rem;
      opacity:0.95;
      margin-bottom:1.5rem;
    }
    
    .welcome-stats{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:1rem;
      margin-top:1.5rem;
    }
    .stat{
      background:rgba(255,255,255,0.15);
      backdrop-filter:blur(10px);
      padding:1.25rem;
      border-radius:.75rem;
      border:1px solid rgba(255,255,255,0.2);
    }
    .stat-label{
      font-size:.9rem;
      opacity:0.9;
      margin-bottom:.5rem;
    }
    .stat-value{
      font-size:1.8rem;
      font-weight:800;
    }
    
    /* SECTION */
    .section{
      background:#fff;
      border-radius:1rem;
      padding:2rem;
      margin-bottom:2rem;
      box-shadow:0 4px 20px rgba(0,0,0,.08);
    }
    .section-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:1.5rem;
      padding-bottom:1rem;
      border-bottom:2px solid var(--border);
    }
    .section-title{
      font-size:1.5rem;
      font-weight:800;
      color:var(--primary);
      display:flex;
      align-items:center;
      gap:.75rem;
    }
    
    /* MODULE CARDS */
    .modules-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
      gap:1.5rem;
    }
    
    .module-card{
      background:#fff;
      border:2px solid var(--border);
      border-radius:1rem;
      padding:1.5rem;
      cursor:pointer;
      transition:all 0.3s;
      position:relative;
      overflow:hidden;
    }
    .module-card:hover{
      transform:translateY(-5px);
      box-shadow:0 10px 30px rgba(0,0,0,.15);
      border-color:var(--primary);
    }
    
    .module-icon{
      width:60px;
      height:60px;
      background:linear-gradient(135deg, var(--primary) 0%, #a00d25 100%);
      border-radius:1rem;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:1.8rem;
      margin-bottom:1rem;
    }
    
    .module-title{
      font-size:1.25rem;
      font-weight:800;
      color:var(--text);
      margin-bottom:.5rem;
    }
    
    .module-meta{
      display:flex;
      gap:1rem;
      margin-bottom:1rem;
      font-size:.9rem;
      color:var(--muted);
      flex-wrap:wrap;
    }
    .module-meta span{
      display:flex;
      align-items:center;
      gap:.35rem;
    }
    
    .progress-bar{
      background:var(--border);
      height:8px;
      border-radius:1rem;
      overflow:hidden;
      margin-bottom:.5rem;
    }
    .progress-fill{
      background:linear-gradient(90deg, var(--success) 0%, #22c55e 100%);
      height:100%;
      transition:width 0.3s;
    }
    .progress-text{
      font-size:.85rem;
      color:var(--muted);
      font-weight:700;
    }
    
    .module-status{
      position:absolute;
      top:1rem;
      right:1rem;
      background:var(--success);
      color:#fff;
      padding:.35rem .75rem;
      border-radius:2rem;
      font-size:.8rem;
      font-weight:700;
    }
    .module-status.pending{
      background:var(--warning);
    }
    
    /* TERMINE */
    .termine-list{
      display:flex;
      flex-direction:column;
      gap:1rem;
    }
    
    .termin-card{
      background:#fafafa;
      border-left:4px solid var(--primary);
      padding:1.5rem;
      border-radius:.75rem;
      display:grid;
      grid-template-columns:auto 1fr auto;
      gap:1.5rem;
      align-items:center;
      transition:all 0.2s;
    }
    .termin-card:hover{
      background:#f5f5f5;
      transform:translateX(5px);
    }
    
    .termin-date{
      background:#fff;
      padding:1rem;
      border-radius:.75rem;
      text-align:center;
      min-width:80px;
      box-shadow:0 2px 8px rgba(0,0,0,.08);
    }
    .termin-day{
      font-size:1.8rem;
      font-weight:800;
      color:var(--primary);
      line-height:1;
    }
    .termin-month{
      font-size:.85rem;
      color:var(--muted);
      font-weight:700;
      text-transform:uppercase;
    }
    
    .termin-info h3{
      font-size:1.1rem;
      font-weight:800;
      color:var(--text);
      margin-bottom:.35rem;
    }
    .termin-details{
      display:flex;
      gap:1.5rem;
      font-size:.9rem;
      color:var(--muted);
      flex-wrap:wrap;
    }
    .termin-details span{
      display:flex;
      align-items:center;
      gap:.35rem;
    }
    
    .termin-status{
      padding:.5rem 1rem;
      border-radius:2rem;
      font-weight:700;
      font-size:.85rem;
    }
    .termin-status.zugesagt{
      background:#d1fae5;
      color:#065f46;
    }
    .termin-status.eingeladen{
      background:#fef3c7;
      color:#92400e;
    }
    
    .empty{
      text-align:center;
      padding:3rem 1rem;
      color:var(--muted);
    }
    .empty i{
      font-size:4rem;
      margin-bottom:1rem;
      opacity:0.3;
    }
    
    @media (max-width:768px){
      .header-content{
        flex-direction:column;
        align-items:stretch;
      }
      .header-actions{
        flex-direction:column;
      }
      .header-btn{
        width:100%;
        justify-content:center;
      }
      .welcome{
        padding:1.5rem;
      }
      .welcome h1{
        font-size:1.5rem;
      }
      .welcome-stats{
        grid-template-columns:1fr;
      }
      .modules-grid{
        grid-template-columns:1fr;
      }
      .termin-card{
        grid-template-columns:1fr;
        text-align:center;
      }
      .termin-date{
        margin:0 auto;
      }
      .termin-details{
        justify-content:center;
      }
    }
  </style>
</head>

<body>

<!-- HEADER -->
<header>
  <div class="header-content">
    <div class="logo">
      <i class="fa-solid fa-graduation-cap"></i>
      <span>Lernbar</span>
    </div>
    <div class="header-actions">
      <button class="header-btn" id="logoutBtn">
        <i class="fa-solid fa-right-from-bracket"></i>
        Logout
      </button>
    </div>
  </div>
</header>

<!-- MAIN -->
<div class="container">
  
  <!-- WELCOME -->
  <div class="welcome">
    <div class="welcome-content">
      <h1 id="welcomeTitle">Willkommen zur√ºck!</h1>
      <p id="welcomeSubtitle">Bereit f√ºr deine n√§chste Lerneinheit?</p>
      
      <div class="welcome-stats">
        <div class="stat">
          <div class="stat-label">Meine Module</div>
          <div class="stat-value" id="statModules">0</div>
        </div>
        <div class="stat">
          <div class="stat-label">Abgeschlossen</div>
          <div class="stat-value" id="statCompleted">0</div>
        </div>
        <div class="stat">
          <div class="stat-label">N√§chster Termin</div>
          <div class="stat-value" id="statNextDate">-</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- MEINE MODULE -->
  <div class="section">
    <div class="section-header">
      <h2 class="section-title">
        <i class="fa-solid fa-book"></i>
        Meine Lernmodule
      </h2>
    </div>
    <div class="modules-grid" id="modulesGrid">
      <div class="empty">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Lade Module...</p>
      </div>
    </div>
  </div>
  
  <!-- MEINE TERMINE -->
  <div class="section">
    <div class="section-header">
      <h2 class="section-title">
        <i class="fa-solid fa-calendar"></i>
        Meine Schulungstermine
      </h2>
    </div>
    <div class="termine-list" id="termineList">
      <div class="empty">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Lade Termine...</p>
      </div>
    </div>
  </div>
  
</div>

<script type="module">
  // ========================================
  // POCKETBASE & AUTH
  // ========================================
  const pb = new PocketBase('https://api.responda.systems');

  // Strenge Auth-Pr√ºfung
  if (!pb.authStore.isValid || !pb.authStore.model) {
    console.log('‚ùå Nicht angemeldet');
    location.href = "/lernbar-login.html";
  }

  const currentUser = pb.authStore.model;
  
  // Pr√ºfe ob Student (hat access_code)
  if (!currentUser.access_code) {
    console.log('‚ùå Kein Student-Account');
    pb.authStore.clear();
    location.href = "/lernbar-login.html";
  }

  console.log('‚úÖ Angemeldet als:', currentUser.name);
  
  document.getElementById('logoutBtn').onclick = () => {
    pb.authStore.clear();
    location.href = "/lernbar-login.html";
  };

  // ========================================
  // WELCOME MESSAGE
  // ========================================
  function getGreeting() {
    const hour = new Date().getHours();
    if (hour < 12) return 'Guten Morgen';
    if (hour < 18) return 'Guten Tag';
    return 'Guten Abend';
  }

  const userName = currentUser.name || 'Student';
  document.getElementById('welcomeTitle').textContent = `${getGreeting()}, ${userName}!`;

  // ========================================
  // LOAD DATA (MIT MOCK-DATEN F√úR JETZT)
  // ========================================
  let myModules = [];
  let myTermine = [];

  async function loadData() {
    try {
      // MOCK MODULE (bis Collections angelegt sind)
      myModules = [
        {
          id: 'mock1',
          title: 'Einf√ºhrung in die Erste Hilfe',
          slide_count: 12,
          duration: 30,
          completed: false,
          progress: 0
        },
        {
          id: 'mock2',
          title: 'Hygiene im Rettungsdienst',
          slide_count: 8,
          duration: 20,
          completed: false,
          progress: 45
        }
      ];
      
      // Lade echte Schulungstermine
      try {
        const participations = await pb.collection('schulung_teilnahme').getFullList({
          filter: `member_id = "${currentUser.id}"`,
          expand: 'session_id,session_id.course_id'
        });
        
        myTermine = participations.map(p => ({
          ...p,
          session: p.expand?.session_id,
          course: p.expand?.session_id?.expand?.course_id
        })).filter(t => t.session);
        
        // Sortiere nach Datum
        myTermine.sort((a, b) => new Date(a.session.date) - new Date(b.session.date));
        
        // N√§chster Termin
        const nextTermin = myTermine.find(t => new Date(t.session.date) >= new Date());
        if (nextTermin) {
          const date = new Date(nextTermin.session.date);
          document.getElementById('statNextDate').textContent = date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
        }
      } catch(e) {
        console.log('‚ö†Ô∏è Keine Termine geladen:', e);
      }
      
      // Update Stats
      document.getElementById('statModules').textContent = myModules.length;
      document.getElementById('statCompleted').textContent = myModules.filter(m => m.completed).length;
      
      renderModules();
      renderTermine();
      
    } catch(e) {
      console.error('Error loading data:', e);
    }
  }

  // ========================================
  // RENDER MODULES
  // ========================================
  function renderModules() {
    const grid = document.getElementById('modulesGrid');
    
    if (!myModules.length) {
      grid.innerHTML = `
        <div class="empty" style="grid-column:1/-1">
          <i class="fas fa-book"></i>
          <p>Keine Module zugewiesen</p>
        </div>
      `;
      return;
    }
    
    grid.innerHTML = myModules.map(module => `
      <div class="module-card" onclick="openModule('${module.id}')">
        <div class="module-status ${module.completed ? '' : 'pending'}">
          ${module.completed ? '‚úì Abgeschlossen' : 'In Bearbeitung'}
        </div>
        <div class="module-icon">
          <i class="fa-solid fa-book-open"></i>
        </div>
        <h3 class="module-title">${module.title}</h3>
        <div class="module-meta">
          <span><i class="fa-solid fa-layer-group"></i> ${module.slide_count || 0} Folien</span>
          <span><i class="fa-solid fa-clock"></i> ${module.duration || 30} Min</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width:${module.progress}%"></div>
        </div>
        <div class="progress-text">${module.progress}% abgeschlossen</div>
      </div>
    `).join('');
  }

  window.openModule = (moduleId) => {
    alert('Modul-Viewer wird bald verf√ºgbar sein! üöß\n\nModul ID: ' + moduleId);
    // location.href = `/lernbar-modul.html?id=${moduleId}`;
  };

  // ========================================
  // RENDER TERMINE
  // ========================================
  function renderTermine() {
    const list = document.getElementById('termineList');
    
    if (!myTermine.length) {
      list.innerHTML = `
        <div class="empty">
          <i class="fas fa-calendar"></i>
          <p>Keine anstehenden Termine</p>
        </div>
      `;
      return;
    }
    
    list.innerHTML = myTermine.map(termin => {
      const date = new Date(termin.session.date);
      const day = date.getDate();
      const month = date.toLocaleDateString('de-DE', { month: 'short' });
      
      return `
        <div class="termin-card">
          <div class="termin-date">
            <div class="termin-day">${day}</div>
            <div class="termin-month">${month}</div>
          </div>
          <div class="termin-info">
            <h3>${termin.course?.title || 'Schulung'}</h3>
            <div class="termin-details">
              <span><i class="fa-solid fa-clock"></i> ${termin.session.start_time || 'Ganzt√§gig'}</span>
              <span><i class="fa-solid fa-location-dot"></i> ${termin.session.location || 'TBA'}</span>
            </div>
          </div>
          <div class="termin-status ${termin.status}">
            ${termin.status === 'zugesagt' ? '‚úì Zugesagt' : termin.status === 'abgesagt' ? '‚úó Abgesagt' : '‚è≥ Eingeladen'}
          </div>
        </div>
      `;
    }).join('');
  }

  // ========================================
  // INIT
  // ========================================
  loadData();

</script>

</body>
</html>
