<!DOCTYPE html>

<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Responda</title>

  <meta name="theme-color" content="#667eea">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      user-select: none;
    }
    
    /* Status Bar */
    .status-bar {
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      color: #fff;
      font-size: 15px;
      font-weight: 600;
    }
    
    .time { font-feature-settings: "tnum"; }
    
    .logout-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 0.5px solid rgba(255, 255, 255, 0.3);
      color: #fff;
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }
    
    .logout-btn:active {
      transform: scale(0.95);
      background: rgba(255, 255, 255, 0.3);
    }
    
    
    /* Main Content */
    .content {
      height: calc(100vh - 44px);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 20px 20px 120px;
    }
    
    /* Widgets */
    .widgets {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 32px;
    }
    
    .widget {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(40px);
      -webkit-backdrop-filter: blur(40px);
      border-radius: 20px;
      padding: 16px;
      color: #fff;
      min-height: 120px;
      border: 0.5px solid rgba(255, 255, 255, 0.3);
    }
    
    .widget.large {
      grid-column: span 2;
    }
    
    .widget-title {
      font-size: 13px;
      font-weight: 600;
      opacity: 0.8;
      margin-bottom: 8px;
    }
    
    .widget-value {
      font-size: 28px;
      font-weight: 700;
    }
    
    .widget-label {
      font-size: 14px;
      opacity: 0.8;
      margin-top: 4px;
    }
    
    /* Apps Grid */
    .apps {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 24px 16px;
      padding: 0 8px;
      margin-bottom: 48px;
    }
    
    .app {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      position: relative;
      transition: transform 0.2s;
    }
    
    .app:active { transform: scale(0.9); }
    
    .edit-mode .app {
      animation: wiggle 0.4s ease-in-out infinite;
    }
    
    @keyframes wiggle {
      0%, 100% { transform: rotate(-1deg); }
      50% { transform: rotate(1deg); }
    }
    
    .app-icon {
      width: 60px;
      height: 60px;
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(30px);
      -webkit-backdrop-filter: blur(30px);
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      border: 0.5px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .app-icon svg {
      width: 28px;
      height: 28px;
      stroke: currentColor;
      fill: none;
      stroke-width: 2;
    }
    
    .app-name {
      font-size: 11px;
      font-weight: 500;
      color: #fff;
      text-align: center;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      max-width: 65px;
      line-height: 1.2;
    }
    
    .remove-btn {
      position: absolute;
      top: -5px;
      left: -5px;
      width: 20px;
      height: 20px;
      background: #ff3b30;
      border: 2px solid #fff;
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      z-index: 10;
    }
    
    .edit-mode .remove-btn {
      display: flex;
    }
    
    /* Edit Button */
    .edit-button {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 0.5px solid rgba(255, 255, 255, 0.3);
      color: #fff;
      padding: 8px 16px;
      border-radius: 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      z-index: 200;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .edit-button:active {
      transform: translateX(-50%) scale(0.95);
      background: rgba(255, 255, 255, 0.3);
    }
    
    /* Hide page indicator */
    .page-indicator {
      display: none;
    }
    
    .edit-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .edit-btn {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 14px;
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 15px;
      color: #1a1a1a;
      font-weight: 500;
    }
    
    .edit-btn:active {
      transform: scale(0.98);
      background: #f5f5f5;
    }
    
    .edit-btn-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .edit-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
    }
    
    .edit-icon svg {
      width: 18px;
      height: 18px;
      stroke: currentColor;
      fill: none;
      stroke-width: 2;
    }
    
    .edit-arrow {
      color: #999;
      font-size: 18px;
    }
    
    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: flex-end;
      z-index: 1000;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      width: 100%;
      background: #fff;
      border-radius: 28px 28px 0 0;
      padding: 24px 24px 40px;
      max-height: 75vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease-out;
    }
    
    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 700;
      color: #1a1a1a;
    }
    
    .modal-close {
      width: 32px;
      height: 32px;
      background: #f0f0f0;
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: #666;
      cursor: pointer;
    }
    
    /* Available Apps Grid */
    .available-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 24px 16px;
    }
    
    .available-app {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    
    .available-app:active {
      transform: scale(0.9);
    }
    
    .available-icon {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      position: relative;
    }
    
    .available-icon svg {
      width: 28px;
      height: 28px;
      stroke: currentColor;
      fill: none;
      stroke-width: 2;
    }
    
    .available-icon::after {
      content: '+';
      position: absolute;
      bottom: -4px;
      right: -4px;
      width: 18px;
      height: 18px;
      background: #34c759;
      border: 2px solid #fff;
      border-radius: 50%;
      font-size: 12px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .available-name {
      font-size: 11px;
      font-weight: 500;
      color: #1a1a1a;
      text-align: center;
      max-width: 65px;
    }
    
    /* Dock - REMOVED */
    .dock {
      display: none;
    }
    
    /* Widget Options */
    .widget-options {
      display: grid;
      gap: 12px;
    }
    
    .widget-option {
      background: #f8f8f8;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
    }
    
    .widget-option:active {
      background: #f0f0f0;
    }
    
    .widget-option-title {
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 4px;
    }
    
    .widget-option-desc {
      font-size: 13px;
      color: #666;
    }
    
    /* Settings Tabs */
    .settings-tab {
      padding: 10px 16px;
      border: none;
      background: #f0f0f0;
      color: #666;
      border-radius: 10px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    
    .settings-tab.active {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
    }
    
    .settings-content {
      display: none;
    }
    
    .settings-content.active {
      display: block;
    }
    
    .field {
      margin-bottom: 16px;
    }
    
    .field label {
      display: block;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .field input, .field select, .field textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      font-size: 15px;
      font-family: inherit;
      background: #fff;
    }
    
    .field input:focus, .field select:focus, .field textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      transition: all 0.2s;
      font-family: inherit;
    }
    
    .btn:active {
      transform: scale(0.98);
    }
    
    /* Loading */
    body.loading { opacity: 0; }
    body.loaded { 
      opacity: 1;
      transition: opacity 0.3s;
    }
    
    @media (min-width: 768px) {
      .content {
        max-width: 600px;
        margin: 0 auto;
      }
    }
  </style>

</head>

<body class="loading">

<!-- Status Bar -->

<div class="status-bar">
  <div class="time" id="time">9:41</div>
  <div id="userName">‚Äî</div>
  <button class="logout-btn" id="logoutBtn">Abmelden</button>
</div>

<!-- Main Content -->

<div class="content">
  <!-- Widgets -->
  <div class="widgets" id="widgets"></div>

  <!-- Apps -->

  <div class="apps" id="apps"></div>
</div>

<!-- Dock -->

<div class="dock" id="dock"></div>

<!-- Edit Button -->

<button class="edit-button" id="editButton">Hub bearbeiten</button>

<!-- Edit Modal -->

<div class="modal" id="editModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">Hub bearbeiten</div>
      <button class="modal-close" onclick="closeModal('editModal')">√ó</button>
    </div>
    <div class="edit-options">
      <button class="edit-btn" id="editAppsBtn">
        <div class="edit-btn-left">
          <div class="edit-icon">
            <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
          </div>
          <span>Apps verwalten</span>
        </div>
        <span class="edit-arrow">‚Ä∫</span>
      </button>

```
  <button class="edit-btn" id="editWidgetsBtn">
    <div class="edit-btn-left">
      <div class="edit-icon">
        <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></svg>
      </div>
      <span>Widgets anpassen</span>
    </div>
    <span class="edit-arrow">‚Ä∫</span>
  </button>
</div>
```

  </div>
</div>

<!-- Apps Modal -->

<div class="modal" id="appsModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">Apps verwalten</div>
      <button class="modal-close" onclick="closeModal('appsModal')">√ó</button>
    </div>
    <div class="available-grid" id="availableApps"></div>
  </div>
</div>

<!-- Widgets Modal -->

<div class="modal" id="widgetsModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">Widgets anpassen</div>
      <button class="modal-close" onclick="closeModal('widgetsModal')">√ó</button>
    </div>
    <div class="widget-options">
      <div class="widget-option">
        <div class="widget-option-title">Datum & Uhrzeit</div>
        <div class="widget-option-desc">Zeigt aktuelles Datum und Wochentag</div>
      </div>
      <div class="widget-option">
        <div class="widget-option-title">Organisation</div>
        <div class="widget-option-desc">Logo und Name der Organisation</div>
      </div>
    </div>
  </div>
</div>

<!-- Settings Modal -->

<div class="modal" id="settingsModal">
  <div class="modal-content" style="max-height: 80vh;">
    <div class="modal-header">
      <div class="modal-title">Einstellungen</div>
      <button class="modal-close" onclick="closeModal('settingsModal')">√ó</button>
    </div>

```
<!-- Settings Tabs -->
<div style="display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto;">
  <button class="settings-tab active" onclick="showSettingsTab('profile')">Profil</button>
  <button class="settings-tab" onclick="showSettingsTab('password')">Passwort</button>
  <button class="settings-tab" onclick="showSettingsTab('users')" id="usersTabBtn" style="display:none;">Benutzer</button>
  <button class="settings-tab" onclick="showSettingsTab('license')" id="licenseTabBtn" style="display:none;">Lizenz</button>
</div>

<!-- Profile Tab -->
<div class="settings-content active" id="settings-profile">
  <div class="field">
    <label>E-Mail</label>
    <input type="email" id="profileEmail" readonly style="background:#f5f5f5;">
  </div>
  <div class="field">
    <label>Name</label>
    <input type="text" id="profileName" placeholder="Dein Name">
  </div>
  <div class="field">
    <label>Telefon</label>
    <input type="tel" id="profilePhone" placeholder="+49 123 456789">
  </div>
  <div id="profileMsg" style="margin-top:12px; font-size:14px;"></div>
  <button class="btn" onclick="saveProfile()" style="margin-top:16px; width:100%;">Profil speichern</button>
</div>

<!-- Password Tab -->
<div class="settings-content" id="settings-password">
  <div class="field">
    <label>Aktuelles Passwort</label>
    <input type="password" id="pwCurrent" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
  </div>
  <div class="field">
    <label>Neues Passwort (min. 8 Zeichen)</label>
    <input type="password" id="pwNew1" placeholder="Neues Passwort">
  </div>
  <div class="field">
    <label>Passwort wiederholen</label>
    <input type="password" id="pwNew2" placeholder="Wiederholen">
  </div>
  <div id="pwMsg" style="margin-top:12px; font-size:14px;"></div>
  <button class="btn" onclick="changePassword()" style="margin-top:16px; width:100%;">Passwort √§ndern</button>
</div>

<!-- Users Tab -->
<div class="settings-content" id="settings-users">
  <button class="btn" onclick="openUserModal()" style="margin-bottom:16px; width:100%;">+ Neuen Benutzer anlegen</button>
  
  <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
    <table style="width:100%; border-collapse: collapse; min-width: 600px;">
      <thead>
        <tr style="background:#f8f8f8;">
          <th style="padding:12px; text-align:left; font-weight:600; color:#1a1a1a; border-bottom:2px solid #e0e0e0;">Name</th>
          <th style="padding:12px; text-align:left; font-weight:600; color:#1a1a1a; border-bottom:2px solid #e0e0e0;">E-Mail</th>
          <th style="padding:12px; text-align:left; font-weight:600; color:#1a1a1a; border-bottom:2px solid #e0e0e0;">Rolle</th>
          <th style="padding:12px; text-align:left; font-weight:600; color:#1a1a1a; border-bottom:2px solid #e0e0e0;">Aktionen</th>
        </tr>
      </thead>
      <tbody id="usersTableBody">
        <tr>
          <td colspan="4" style="text-align:center; padding:40px; color:#999;">Lade Benutzer...</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- License Tab -->
<div class="settings-content" id="settings-license">
  <div style="background:linear-gradient(135deg, #16a34a, #15803d); border-radius:16px; padding:24px; color:#fff; margin-bottom:20px;">
    <h3 style="margin:0 0 20px 0; font-size:20px;">‚úì Aktive Lizenz</h3>
    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:16px;">
      <div>
        <div style="font-size:12px; opacity:0.8; margin-bottom:4px;">Organisation</div>
        <div style="font-weight:700; font-size:18px;" id="licenseOrg">‚Äî</div>
      </div>
      <div>
        <div style="font-size:12px; opacity:0.8; margin-bottom:4px;">Lizenztyp</div>
        <div style="font-weight:700; font-size:18px;" id="licenseType">‚Äî</div>
      </div>
      <div>
        <div style="font-size:12px; opacity:0.8; margin-bottom:4px;">Max. Benutzer</div>
        <div style="font-weight:700; font-size:18px;" id="licenseMaxUsers">‚Äî</div>
      </div>
      <div>
        <div style="font-size:12px; opacity:0.8; margin-bottom:4px;">Aktuelle Benutzer</div>
        <div style="font-weight:700; font-size:18px;" id="licenseCurrentUsers">‚Äî</div>
      </div>
      <div>
        <div style="font-size:12px; opacity:0.8; margin-bottom:4px;">G√ºltig bis</div>
        <div style="font-weight:700; font-size:18px;" id="licenseExpiry">‚Äî</div>
      </div>
      <div>
        <div style="font-size:12px; opacity:0.8; margin-bottom:4px;">Status</div>
        <div style="font-weight:700; font-size:18px;" id="licenseStatus">‚úì Aktiv</div>
      </div>
    </div>
  </div>
  
  <div style="background:#f8f8f8; border-radius:12px; padding:20px;">
    <strong style="color:#1a1a1a;">üìû Support kontaktieren</strong><br>
    <span style="color:#666; font-size:14px;">Bei Fragen zur Lizenz kontaktieren Sie uns unter:<br><strong>support@responda.systems</strong></span>
  </div>
</div>
```

  </div>
</div>

<!-- User Modal -->

<div class="modal" id="userModal">
  <div class="modal-content" style="max-height: 80vh;">
    <div class="modal-header">
      <div class="modal-title" id="userModalTitle">Neuen Benutzer anlegen</div>
      <button class="modal-close" onclick="closeModal('userModal')">√ó</button>
    </div>

```
<div class="field">
  <label>E-Mail *</label>
  <input type="email" id="userEmail" placeholder="benutzer@example.com" required>
</div>

<div class="field">
  <label>Name *</label>
  <input type="text" id="userName" placeholder="Max Mustermann" required>
</div>

<div class="field">
  <label>Telefon</label>
  <input type="tel" id="userPhone" placeholder="+49 123 456789">
</div>

<div class="field">
  <label>Rolle *</label>
  <select id="userRole" required>
    <option value="">-- Bitte w√§hlen --</option>
    <option value="mpg">üëë MPG-Beauftragter</option>
    <option value="lager">üì¶ Lagerverwaltung</option>
    <option value="ausbildung">üéì Ausbildungen</option>
    <option value="qm">üìã Qualit√§tsmanagement</option>
    <option value="benutzer">üë§ Benutzer</option>
  </select>
</div>

<div id="userMsg" style="margin:12px 0; font-size:14px;"></div>

<div style="display:flex; gap:8px; margin-top:20px;">
  <button class="btn" onclick="closeModal('userModal')" style="background:#e0e0e0; color:#666; flex:1;">Abbrechen</button>
  <button class="btn" onclick="saveUser()" style="flex:1;" id="saveUserBtn">Speichern</button>
</div>
```

  </div>
</div>

<script type="module">
  import PocketBase from 'https://cdn.jsdelivr.net/npm/pocketbase@0.21.3/dist/pocketbase.es.mjs';
  const pb = new PocketBase('https://api.responda.systems');

  // Icons
  const ICONS = {
    siren: '<svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5M2 12l10 5 10-5"/></svg>',
    clipboard: '<svg viewBox="0 0 24 24"><rect x="8" y="2" width="8" height="4" rx="1"/><rect x="4" y="4" width="16" height="18" rx="2"/></svg>',
    file: '<svg viewBox="0 0 24 24"><path d="M13 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V9l-7-7z"/><path d="M13 2v7h7"/></svg>',
    package: '<svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5M2 12l10 5 10-5"/></svg>',
    check: '<svg viewBox="0 0 24 24"><rect x="8" y="2" width="8" height="4" rx="1"/><rect x="4" y="4" width="16" height="18" rx="2"/><path d="M9 11l3 3 6-6"/></svg>',
    folder: '<svg viewBox="0 0 24 24"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>',
    qrcode: '<svg viewBox="0 0 24 24" fill="currentColor"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="3" height="3"/><rect x="18" y="14" width="3" height="3"/><rect x="14" y="18" width="3" height="3"/><rect x="18" y="18" width="3" height="3"/></svg>',
    graduation: '<svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5M22 12v5M6 10v8c0 2 4 4 6 4s6-2 6-4v-8"/></svg>',
    book: '<svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>',
    chat: '<svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>',
    dashboard: '<svg viewBox="0 0 24 24"><path d="M3 3h7v9H3zM14 3h7v5h-7zM14 12h7v9h-7zM3 16h7v5H3z"/></svg>',
    settings: '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6m5.66-13.66l-4.24 4.24m0 6l4.24 4.24M23 12h-6m-6 0H1m18.66-5.66l-4.24 4.24m0 6l4.24 4.24"/></svg>',
  };

  // Apps
  const ALL_APPS = {
    einsaetze: { id: 'einsaetze', name: 'Eins√§tze', icon: 'siren', url: 'einsaetze.html', permission: 'einsaetze' },
    patienten: { id: 'patienten', name: 'Patienten', icon: 'clipboard', url: 'patientendokumentation-dateien.html', permission: 'patienten' },
    dokumente: { id: 'dokumente', name: 'Vorg√§nge', icon: 'file', url: 'dokumente-bearbeiten.html', permission: 'dokumente' },
    lager: { id: 'lager', name: 'Lager', icon: 'package', url: 'lagerverwaltung.html', permission: 'lager' },
    produktausgabe: { id: 'produktausgabe', name: 'Ausgabe', icon: 'check', url: 'produktausgabe.html', permission: 'produktausgabe' },
    dateien: { id: 'dateien', name: 'Dateien', icon: 'folder', url: 'dateien.html', permission: 'dateien' },
    qr: { id: 'qr', name: 'QR-Codes', icon: 'qrcode', url: 'qr-code-generator.html', permission: 'qr' },
    lernbar: { id: 'lernbar', name: 'Lernbar', icon: 'graduation', url: 'lernbar.html', permission: 'lernbar' },
    ausbildungen: { id: 'ausbildungen', name: 'Ausbildungen', icon: 'book', url: 'ausbildungen.html', permission: 'ausbildungen_manage' },
    dashboard: { id: 'dashboard', name: 'Dashboard', icon: 'dashboard', url: 'mpg-dashboard.html', permission: 'dashboard' },
    settings: { id: 'settings', name: 'Einstellungen', icon: 'settings', url: '#settings', permission: 'dashboard', isInternal: true }
  };

  const ROLES = {
    mpg: { permissions: { dashboard: true, einsaetze: true, lager: true, produktausgabe: true, lernbar: true, ausbildungen_manage: true, dokumente: true, patienten: true, dateien: true, qr: true, chat: true } },
    lager: { permissions: { dashboard: true, lager: true, produktausgabe: true, dateien: true, qr: true, chat: true } },
    ausbildung: { permissions: { dashboard: true, einsaetze: true, lernbar: true, ausbildungen_manage: true, patienten: true, dateien: true, qr: true, chat: true } },
    qm: { permissions: { dashboard: true, dokumente: true, dateien: true, qr: true, chat: true } },
    benutzer: { permissions: { dashboard: true, lernbar: true, chat: true } }
  };

  let user, userApps = [], availableApps = [], editMode = false;

  async function init() {
    if (!pb.authStore.isValid) return window.location.href = 'mpg-login.html';
    try {
      await pb.collection('users').authRefresh();
      user = pb.authStore.model;
      if (!user) return window.location.href = 'mpg-login.html';
      
      // Load organization info
      if (user.organization_id) {
        try {
          const org = await pb.collection('organizations').getOne(user.organization_id);
          user.organization_name = org.org_name;
          user.organization_logo = org.logo || 'üè¢';
        } catch (e) {
          console.log('Could not load organization:', e);
        }
      }
      
      document.body.classList.add('loaded');
      updateTime();
      setInterval(updateTime, 60000);
      
      document.getElementById('userName').textContent = user.name || user.email.split('@')[0];
      
      loadPrefs();
      render();
    } catch (e) {
      pb.authStore.clear();
      window.location.href = 'mpg-login.html';
    }
  }

  function updateTime() {
    const now = new Date();
    document.getElementById('time').textContent = 
      `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
  }

  function hasPermission(perm) {
    if (user.supervisor) return true;
    const perms = user.permissions || {};
    const role = ROLES[user.role || 'benutzer'];
    if (perms[perm]) return true;
    if (role?.permissions[perm]) return true;
    if (perm === 'lernbar' && user.lernbar_access) return true;
    return false;
  }

  function loadPrefs() {
    const saved = localStorage.getItem(`hub_apps_${user.id}`);
    
    if (saved) {
      userApps = JSON.parse(saved);
      // Ensure settings is always included
      if (!userApps.includes('settings')) {
        userApps.push('settings');
      }
    } else {
      // Default apps including settings
      userApps = Object.keys(ALL_APPS).filter(id => {
        const app = ALL_APPS[id];
        return hasPermission(app.permission);
      });
    }
    
    availableApps = Object.keys(ALL_APPS).filter(id => {
      const app = ALL_APPS[id];
      return hasPermission(app.permission) && !userApps.includes(id);
    });
  }

  function savePrefs() {
    localStorage.setItem(`hub_apps_${user.id}`, JSON.stringify(userApps));
  }

  function render() {
    renderWidgets();
    renderApps();
    renderAvailable();
  }

  function renderWidgets() {
    const today = new Date();
    
    // Get organization info
    const orgName = user.organization_name || 'Responda';
    const orgLogo = user.organization_logo || 'üè¢'; // Falls kein Logo, Emoji als Fallback
    
    document.getElementById('widgets').innerHTML = `
      <div class="widget">
        <div class="widget-title">Heute</div>
        <div class="widget-value">${today.getDate()}</div>
        <div class="widget-label">${today.toLocaleDateString('de-DE', { weekday: 'long' })}</div>
      </div>
      <div class="widget">
        <div class="widget-title">Organisation</div>
        <div class="widget-value" style="font-size:40px">${orgLogo}</div>
        <div class="widget-label">${orgName}</div>
      </div>
    `;
  }

  function renderApps() {
    document.getElementById('apps').innerHTML = userApps.map(id => {
      const app = ALL_APPS[id];
      if (!app) return '';
      
      // Settings app opens modal instead of navigating
      const clickHandler = app.isInternal ? `onclick="openSettings(event)"` : '';
      const href = app.isInternal ? 'javascript:void(0)' : app.url;
      
      return `
        <a href="${href}" class="app" ${clickHandler}>
          <div class="remove-btn" onclick="removeApp(event, '${id}')">‚àí</div>
          <div class="app-icon">${ICONS[app.icon]}</div>
          <div class="app-name">${app.name}</div>
        </a>
      `;
    }).join('');
  }

  function renderAvailable() {
    document.getElementById('availableApps').innerHTML = availableApps.length ? availableApps.map(id => {
      const app = ALL_APPS[id];
      if (!app) return '';
      return `
        <div class="available-app" onclick="addApp('${id}')">
          <div class="available-icon">${ICONS[app.icon]}</div>
          <div class="available-name">${app.name}</div>
        </div>
      `;
    }).join('') : '<p style="text-align:center;color:#999;padding:40px">Alle Apps hinzugef√ºgt</p>';
  }

  window.addApp = function(id) {
    if (userApps.includes(id)) return;
    userApps.push(id);
    availableApps = availableApps.filter(x => x !== id);
    savePrefs();
    render();
  };

  window.removeApp = function(e, id) {
    e.preventDefault();
    e.stopPropagation();
    
    // Prevent removing settings
    if (id === 'settings') {
      alert('Einstellungen k√∂nnen nicht entfernt werden');
      return;
    }
    
    userApps = userApps.filter(x => x !== id);
    availableApps.push(id);
    savePrefs();
    render();
  };

  window.closeModal = function(id) {
    document.getElementById(id).classList.remove('show');
    if (id === 'appsModal') {
      editMode = false;
      document.querySelector('.content').classList.remove('edit-mode');
    }
  };

  document.getElementById('editButton').onclick = () => {
    document.getElementById('editModal').classList.add('show');
  };

  document.getElementById('editAppsBtn').onclick = () => {
    closeModal('editModal');
    editMode = true;
    document.querySelector('.content').classList.add('edit-mode');
    document.getElementById('appsModal').classList.add('show');
  };

  document.getElementById('editWidgetsBtn').onclick = () => {
    closeModal('editModal');
    document.getElementById('widgetsModal').classList.add('show');
  };

  document.getElementById('logoutBtn').onclick = () => {
    if (confirm('Wirklich abmelden?')) {
      pb.authStore.clear();
      localStorage.clear();
      window.location.href = 'mpg-login.html';
    }
  };

  // Settings functions
  window.openSettings = function(e) {
    e.preventDefault();
    document.getElementById('settingsModal').classList.add('show');
    loadProfileData();
    
    // Show users tab only for supervisors/mpg
    if (user.supervisor || user.role === 'mpg') {
      document.getElementById('usersTabBtn').style.display = 'block';
      document.getElementById('licenseTabBtn').style.display = 'block';
    }
  };

  window.showSettingsTab = function(tab) {
    document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.settings-content').forEach(c => c.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(`settings-${tab}`).classList.add('active');
    
    // Load data when switching tabs
    if (tab === 'users') loadUsers();
    if (tab === 'license') loadLicense();
  };

  function loadProfileData() {
    document.getElementById('profileEmail').value = user.email;
    document.getElementById('profileName').value = user.name || '';
    document.getElementById('profilePhone').value = user.phone || '';
  }

  async function loadUsers() {
    const tbody = document.getElementById('usersTableBody');
    try {
      const users = await pb.collection('users').getFullList({
        filter: `organization_id = "${user.organization_id}"`,
        sort: '-created'
      });
      
      if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:40px;color:#999;">Keine Benutzer</td></tr>';
        return;
      }
      
      tbody.innerHTML = users.map(u => {
        const roleLabels = {
          mpg: 'üëë MPG',
          lager: 'üì¶ Lager',
          ausbildung: 'üéì Ausbildung',
          qm: 'üìã QM',
          benutzer: 'üë§ Benutzer'
        };
        const roleLabel = roleLabels[u.role] || 'üë§ Benutzer';
        
        return `
          <tr style="border-bottom:1px solid #e0e0e0;">
            <td style="padding:12px;">${escapeHtml(u.name || '‚Äî')}</td>
            <td style="padding:12px;">${escapeHtml(u.email)}</td>
            <td style="padding:12px;">${roleLabel}</td>
            <td style="padding:12px;">
              <button onclick="editUser('${u.id}')" style="background:#dbeafe; color:#1e40af; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; margin-right:4px;">‚úèÔ∏è</button>
              ${u.id !== user.id ? `<button onclick="deleteUser('${u.id}', '${escapeHtml(u.name || u.email).replace(/'/g, "\\'")}')}" style="background:#fee2e2; color:#ef4444; border:none; padding:6px 12px; border-radius:6px; cursor:pointer;">üóëÔ∏è</button>` : ''}
            </td>
          </tr>
        `;
      }).join('');
    } catch (e) {
      tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;padding:40px;color:#ef4444;">Fehler: ${e.message}</td></tr>`;
    }
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  let editingUserId = null;

  window.openUserModal = function() {
    editingUserId = null;
    document.getElementById('userModalTitle').textContent = 'Neuen Benutzer anlegen';
    document.getElementById('userEmail').value = '';
    document.getElementById('userEmail').disabled = false;
    document.getElementById('userName').value = '';
    document.getElementById('userPhone').value = '';
    document.getElementById('userRole').value = '';
    document.getElementById('userMsg').textContent = '';
    document.getElementById('saveUserBtn').textContent = 'Speichern';
    document.getElementById('userModal').classList.add('show');
  };

  window.editUser = async function(userId) {
    try {
      const editUser = await pb.collection('users').getOne(userId);
      editingUserId = userId;
      
      document.getElementById('userModalTitle').textContent = 'Benutzer bearbeiten';
      document.getElementById('userEmail').value = editUser.email;
      document.getElementById('userEmail').disabled = true;
      document.getElementById('userName').value = editUser.name || '';
      document.getElementById('userPhone').value = editUser.phone || '';
      document.getElementById('userRole').value = editUser.role || 'benutzer';
      document.getElementById('userMsg').textContent = '';
      document.getElementById('saveUserBtn').textContent = 'Aktualisieren';
      document.getElementById('userModal').classList.add('show');
    } catch (e) {
      alert('Fehler beim Laden: ' + e.message);
    }
  };

  window.deleteUser = async function(userId, userName) {
    if (!confirm(`Benutzer "${userName}" wirklich l√∂schen?`)) return;
    
    try {
      await pb.collection('users').delete(userId);
      alert('‚úÖ Benutzer gel√∂scht!');
      loadUsers();
    } catch (e) {
      alert('‚ùå Fehler: ' + e.message);
    }
  };

  window.saveUser = async function() {
    const msg = document.getElementById('userMsg');
    const saveBtn = document.getElementById('saveUserBtn');
    
    saveBtn.disabled = true;
    saveBtn.textContent = 'Speichere...';
    
    try {
      const email = document.getElementById('userEmail').value.trim();
      const name = document.getElementById('userName').value.trim();
      const phone = document.getElementById('userPhone').value.trim();
      const role = document.getElementById('userRole').value;
      
      if (!email || !name || !role) {
        msg.textContent = '‚ùå Bitte alle Pflichtfelder ausf√ºllen';
        msg.style.color = '#ef4444';
        saveBtn.disabled = false;
        saveBtn.textContent = editingUserId ? 'Aktualisieren' : 'Speichern';
        return;
      }
      
      if (editingUserId) {
        // Update existing user
        await pb.collection('users').update(editingUserId, {
          name,
          phone: phone || '',
          role
        });
        
        msg.textContent = '‚úÖ Benutzer aktualisiert!';
        msg.style.color = '#16a34a';
        
        setTimeout(() => {
          closeModal('userModal');
          loadUsers();
        }, 1500);
      } else {
        // Create new user
        const tempPassword = Array.from({length: 16}, () => 
          'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789!@#$%&*'[Math.floor(Math.random() * 66)]
        ).join('');
        
        await pb.collection('users').create({
          email,
          emailVisibility: true,
          password: tempPassword,
          passwordConfirm: tempPassword,
          name,
          phone: phone || '',
          role,
          organization_id: user.organization_id,
          supervisor: false,
          verified: false,
          permissions: {}
        });
        
        // Send password reset email
        try {
          await pb.collection('users').requestPasswordReset(email);
          msg.textContent = '‚úÖ Benutzer angelegt! Passwort-E-Mail versendet.';
        } catch (e) {
          msg.textContent = '‚ö†Ô∏è Benutzer angelegt, aber E-Mail-Versand fehlgeschlagen.';
        }
        msg.style.color = '#16a34a';
        
        setTimeout(() => {
          closeModal('userModal');
          loadUsers();
        }, 3000);
      }
    } catch (e) {
      msg.textContent = '‚ùå Fehler: ' + e.message;
      msg.style.color = '#ef4444';
    } finally {
      saveBtn.disabled = false;
      saveBtn.textContent = editingUserId ? 'Aktualisieren' : 'Speichern';
    }
  };

  async function loadLicense() {
    try {
      const org = await pb.collection('organizations').getOne(user.organization_id);
      
      document.getElementById('licenseOrg').textContent = org.org_name || '‚Äî';
      document.getElementById('licenseType').textContent = (org.license_type || 'standard').charAt(0).toUpperCase() + (org.license_type || 'standard').slice(1);
      document.getElementById('licenseMaxUsers').textContent = org.max_users || '‚Äî';
      
      if (org.license_valid_until) {
        const validUntil = new Date(org.license_valid_until);
        document.getElementById('licenseExpiry').textContent = validUntil.toLocaleDateString('de-DE');
        
        const now = new Date();
        if (validUntil < now) {
          document.getElementById('licenseStatus').textContent = '‚ùå Abgelaufen';
        }
      } else {
        document.getElementById('licenseExpiry').textContent = 'Unbegrenzt';
      }
      
      // Count users
      const users = await pb.collection('users').getFullList({
        filter: `organization_id = "${user.organization_id}"`
      });
      
      document.getElementById('licenseCurrentUsers').textContent = users.length;
      
    } catch (e) {
      console.error('Fehler beim Laden der Lizenz:', e);
    }
  }

  window.saveProfile = async function() {
    const msg = document.getElementById('profileMsg');
    try {
      const name = document.getElementById('profileName').value.trim();
      const phone = document.getElementById('profilePhone').value.trim();
      
      await pb.collection('users').update(user.id, { name, phone });
      
      user.name = name;
      user.phone = phone;
      document.getElementById('userName').textContent = name || user.email.split('@')[0];
      
      msg.textContent = '‚úÖ Profil gespeichert!';
      msg.style.color = '#16a34a';
      
      setTimeout(() => { msg.textContent = ''; }, 3000);
    } catch (e) {
      msg.textContent = '‚ùå Fehler: ' + e.message;
      msg.style.color = '#ef4444';
    }
  };

  window.changePassword = async function() {
    const msg = document.getElementById('pwMsg');
    try {
      const current = document.getElementById('pwCurrent').value.trim();
      const new1 = document.getElementById('pwNew1').value.trim();
      const new2 = document.getElementById('pwNew2').value.trim();

      if (!current) { msg.textContent = '‚ùå Aktuelles Passwort eingeben'; msg.style.color = '#ef4444'; return; }
      if (!new1 || new1.length < 8) { msg.textContent = '‚ùå Neues Passwort: mind. 8 Zeichen'; msg.style.color = '#ef4444'; return; }
      if (new1 !== new2) { msg.textContent = '‚ùå Passw√∂rter stimmen nicht √ºberein'; msg.style.color = '#ef4444'; return; }

      // Verify current password
      try {
        await pb.collection('users').authWithPassword(user.email, current);
      } catch (e) {
        msg.textContent = '‚ùå Aktuelles Passwort falsch';
        msg.style.color = '#ef4444';
        return;
      }

      // Update password
      await pb.collection('users').update(user.id, {
        password: new1,
        passwordConfirm: new1,
        oldPassword: current
      });
      
      msg.textContent = '‚úÖ Passwort ge√§ndert! Du wirst abgemeldet...';
      msg.style.color = '#16a34a';
      
      setTimeout(() => {
        pb.authStore.clear();
        localStorage.clear();
        window.location.href = 'mpg-login.html';
      }, 2000);
      
    } catch (e) {
      msg.textContent = '‚ùå Fehler: ' + e.message;
      msg.style.color = '#ef4444';
    }
  };

  // Close modals on background click
  document.querySelectorAll('.modal').forEach(modal => {
    modal.onclick = (e) => {
      if (e.target === modal) closeModal(modal.id);
    };
  });

  init();
</script>

</body>
</html>
