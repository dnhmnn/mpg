<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lagerverwaltung</title>

  <!-- NEU: Atkinson Hyperlegible -->
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet">

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>

  <style>
    :root{--primary:#c8102e;--primary-light:#fee2e2;--success:#16a34a;--warning:#f59e0b;
      --bg:#f8fafc;--card:#fff;--text:#1e293b;--text-light:#64748b;--border:#e2e8f0;--low:#2563eb}
    *{box-sizing:border-box}
    /* NEU: Schriftart auf Atkinson gestellt */
    body{
      margin:0;
      font-family:'Atkinson Hyperlegible', system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      padding-bottom:80px
    }
    .app-header{background:var(--primary);color:#fff;padding:1rem;position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between}
    .header-title{font-weight:700}
    .main{max-width:600px;margin:0 auto;padding:1rem}
    .stats{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-bottom:1rem}
    .card{background:var(--card);padding:1rem;border-radius:.75rem;box-shadow:0 2px 4px rgba(0,0,0,.05)}
    .stat-num{font-size:1.4rem;font-weight:700}
    .ok{color:var(--success)} .warn{color:#d97706} .exp{color:var(--primary)}
    .list{display:flex;flex-direction:column;gap:.75rem}
    .row{background:var(--card);border-left:4px solid;border-radius:.75rem;padding:1rem;box-shadow:0 2px 4px rgba(0,0,0,.05)}
    .row.ok{border-color:var(--success)} .row.warn{border-color:#f59e0b} .row.exp{border-color:var(--primary)}
    .rhead{display:flex;justify-content:space-between;margin-bottom:.5rem}
    .badge{padding:.25rem .6rem;border-radius:1rem;font-size:.75rem;font-weight:700}
    .qtyline{font-weight:700}
    .qtyline.low{color:var(--low)}
    .toolbar{display:flex;gap:.5rem;justify-content:space-between;align-items:center;flex-wrap:wrap;margin:.5rem 0}
    .chip{border:1px solid var(--border);background:#fff;padding:.35rem .6rem;border-radius:999px;font-size:.8rem;cursor:pointer}
    .chip.active{background:var(--primary-light);color:var(--primary);border-color:var(--primary)}
    .btn{border:1px solid var(--border);background:#fff;color:var(--text);padding:.5rem .75rem;border-radius:.5rem;cursor:pointer;font-weight:700}
    .bicon{display:inline-flex;align-items:center;gap:.35rem;font-size:.85rem}
    .nav{position:fixed;bottom:0;left:0;right:0;background:var(--card);border-top:1px solid var(--border);padding:.75rem;z-index:5}
    .navg{display:grid;grid-template-columns:repeat(6,1fr);gap:.5rem;max-width:600px;margin:0 auto}
    .nav a{display:flex;flex-direction:column;align-items:center;gap:.25rem;padding:.5rem;color:var(--text-light);font-size:.8rem;font-weight:600;border-radius:.5rem;text-decoration:none}
    .nav a.active{color:var(--primary);background:var(--primary-light)}
    .center-muted{color:var(--text-light);text-align:center;padding:1.25rem}
    .error{background:#fff5f5;border:1px solid #f2c9d1;color:#8b0e22;border-radius:10px;padding:10px}
    .hist{width:100%;border-collapse:collapse;margin-top:.5rem}
    .hist th,.hist td{border:1px solid #eee;padding:.4rem .5rem;font-size:.9rem;text-align:left}
    .hist th{background:#fafafa}
  </style>
</head>
<body>
<header class="app-header">
  <h1 class="header-title">Lagerverwaltung</h1>
  <i class="fas fa-warehouse"></i>
</header>

<main class="main">
  <div class="stats">
    <div class="card"><div class="stat-num ok" id="s-ok">0</div><div>In Ordnung</div></div>
    <div class="card"><div class="stat-num warn" id="s-warn">0</div><div>Bald fällig</div></div>
    <div class="card"><div class="stat-num exp" id="s-exp">0</div><div>Abgelaufen</div></div>
    <div class="card"><div class="stat-num" id="s-total">0</div><div>Gesamt</div></div>
  </div>

  <!-- Toolbar (Suche + Filter + Einbestellen + Export + Neu) -->
  <div id="toolbar" class="toolbar"></div>

  <div id="list" class="list">
    <div class="card center-muted" id="loading">Lade Lagerdaten…</div>
  </div>
</main>

<nav class="nav">
  <div class="navg" id="navg">
    <a href="#" class="active" data-loc="Lager"><i class="fas fa-box"></i><span>Lager</span></a>
    <a href="#" data-loc="46/1"><i class="fas fa-briefcase-medical"></i><span>46/1</span></a>
    <a href="#" data-loc="12/1"><i class="fas fa-briefcase-medical"></i><span>12/1</span></a>
    <a href="#" data-loc="40/2"><i class="fas fa-briefcase-medical"></i><span>40/2</span></a>
    <a href="#" data-loc="30/1"><i class="fas fa-briefcase-medical"></i><span>30/1</span></a>
    <a href="#" data-loc="14/1"><i class="fas fa-briefcase-medical"></i><span>14/1</span></a>
  </div>
</nav>

<script type="module">
  import { NhostClient } from "https://esm.sh/@nhost/nhost-js@2.2.9";

  const nhost = new NhostClient({
    subdomain: "hpjfrhktprpuuxvvlpsb",
    region: "eu-central-1"
  });

  async function guard() {
    const isAuth = await nhost.auth.isAuthenticatedAsync();
    if (!isAuth) {
      const back = encodeURIComponent(location.pathname + location.search);
      location.href = "admin-login.html?redirect=" + back;
      return false;
    }
    return true;
  }
  if (!await guard()) throw new Error("redirecting");

  /* ==== STATE ==== */
  const LOCATIONS = ["Lager","46/1","12/1","40/2","30/1","14/1"];
  let currentLocation="Lager", items=[], search="", statusFilter="all", lowOnly=false;

  const listEl = document.getElementById('list');
  const toolbarEl = document.getElementById('toolbar');

  /* ==== HELPERS ==== */
  function computeExpiryStatus(exp){
    if(!exp) return 'ok';
    const today=new Date(), base=new Date(today.getFullYear(),today.getMonth(),today.getDate());
    const diff=(new Date(exp)-base)/86400000;
    if(diff<0) return 'exp'; if(diff<30) return 'warn'; return 'ok';
  }
  function qtyIsLow(qty, target){ return (typeof target==='number' && target>0 && qty<target); }

  async function gql(q,v){
    const {data,error}=await nhost.graphql.request(q,v);
    if(error){ throw new Error(error.message || JSON.stringify(error)); }
    return data;
  }
  function showError(message){
    listEl.innerHTML = `<div class="card error">
      <strong>Fehler beim Laden der Lagerdaten:</strong><br>${message}<br>
      <div style="margin-top:6px;font-size:.92rem">
        Prüfe in Hasura:<br>
        – Spalte <code>target_qty</code> in <code>inventory_items</code>?<br>
        – Tabelle <code>inventory_movements</code> vorhanden?<br>
        – Rollen-Rechte (select/insert/update/delete) gesetzt?
      </div>
    </div>`;
    document.getElementById('s-ok').textContent=0;
    document.getElementById('s-warn').textContent=0;
    document.getElementById('s-exp').textContent=0;
    document.getElementById('s-total').textContent=0;
  }

  /* ==== TOOLBAR ==== */
  function renderToolbar(){
    toolbarEl.innerHTML='';
    const left=document.createElement('div'); left.style.cssText='flex:1;min-width:200px;position:relative';
    left.innerHTML=`<i class="fas fa-search" style="position:absolute;left:.6rem;top:50%;transform:translateY(-50%);color:var(--text-light)"></i>
      <input id="q" value="${search}" placeholder="Im Lager „${currentLocation}“ suchen…"
        style="width:100%;padding:.55rem .75rem .55rem 2rem;border:1px solid var(--border);border-radius:.5rem;background:#fff">`;
    const right=document.createElement('div'); right.innerHTML=`
      <button class="chip ${statusFilter==='all'?'active':''}" data-f="all">Alle</button>
      <button class="chip ${statusFilter==='warning'?'active':''}" data-f="warning">Bald fällig</button>
      <button class="chip ${statusFilter==='expired'?'active':''}" data-f="expired">Abgelaufen</button>

      <button class="chip ${lowOnly?'active':''}" id="chip-low">
        <i class="fas fa-truck-moving"></i> Einbestellen
      </button>

      <button class="btn" id="btn-export-view"><span class="bicon"><i class="fas fa-file-export"></i> Export (Ansicht)</span></button>
      <button class="btn" id="btn-export-all"><span class="bicon"><i class="fas fa-file-arrow-down"></i> Export (Alle)</span></button>
      <button class="btn" id="btn-new"><span class="bicon"><i class="fas fa-plus"></i> Neu</span></button>`;
    toolbarEl.appendChild(left); toolbarEl.appendChild(right);

    left.querySelector('#q').oninput=(e)=>{ search=e.target.value.trim(); clearTimeout(window._qT); window._qT=setTimeout(fetchItems,250); };
    right.querySelectorAll('button[data-f]').forEach(b=>b.onclick=()=>{ statusFilter=b.dataset.f; renderToolbar(); fetchItems(); });
    right.querySelector('#btn-new').onclick=()=>openEditor();
    right.querySelector('#btn-export-view').onclick=exportCurrent;
    right.querySelector('#btn-export-all').onclick=exportAll;
    right.querySelector('#chip-low').onclick=()=>{ lowOnly=!lowOnly; renderToolbar(); fetchItems(); };
  }

  /* ==== CSV Export ==== */
  function toCSV(rows){
    const headers=["id","name","qty","target_qty","expiry","bemerkung","location"];
    const esc=v=>`"${String(v??'').replace(/"/g,'""')}"`;
    const lines=[headers.join(",")];
    for(const r of rows){ lines.push([r.id,r.name,r.qty,r.target_qty??"",r.expiry||"",r.bemerkung||"",r.location].map(esc).join(",")); }
    return lines.join("\n");
  }
  function download(filename, text, mime='text/csv'){
    const blob=new Blob([text],{type:mime});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href),1000);
  }
  function today(){ return new Date().toISOString().slice(0,10); }
  function exportCurrent(){
    const csv=toCSV(items);
    download(`inventory_${currentLocation}_${today()}.csv`, csv);
  }
  async function exportAll(){
    try{
      const data=await gql(`query{
        inventory_items(order_by:{location:asc,name:asc}){ id name qty target_qty expiry bemerkung location }
      }`);
      const csv=toCSV(data.inventory_items);
      download(`inventory_all_${today()}.csv`, csv);
    }catch(e){ showError(e.message||e); }
  }

  /* ==== FETCH ==== */
  async function fetchItems(){
    try{
      const today=new Date(), base=new Date(today.getFullYear(),today.getMonth(),today.getDate());
      const in30=new Date(base); in30.setDate(in30.getDate()+30);
      const t=base.toISOString().slice(0,10), t30=in30.toISOString().slice(0,10);
      const needle=search?`%${search}%`:'%';

      const where={location:{_eq:currentLocation}, _or:[{name:{_ilike:needle}},{bemerkung:{_ilike:needle}}]};
      const ands=[];
      if(statusFilter==='expired') ands.push({expiry:{_lt:t}});
      if(statusFilter==='warning'){ ands.push({expiry:{_gte:t}}); ands.push({expiry:{_lt:t30}}); }
      if(ands.length) where._and=ands;

      const data=await gql(`query($w:inventory_items_bool_exp!){
        inventory_items(where:$w, order_by:{name:asc}){
          id name qty target_qty expiry bemerkung location
        }
      }`,{w:where});

      const baseList = data.inventory_items;
      items = lowOnly ? baseList.filter(it => (it.target_qty ?? 0) > (it.qty ?? 0)) : baseList;

      renderList();
    }catch(e){
      console.error(e);
      showError(e.message || String(e));
    }
  }

  /* ==== LISTE & AKTIONEN ==== */
  function renderList(){
    const el=document.getElementById('list'); el.innerHTML='';
    let ok=0,w=0,e=0;
    if(!items.length){
      el.insertAdjacentHTML('beforeend','<div class="card center-muted"><i class="fas fa-search"></i> Keine Artikel gefunden</div>');
    }
    items.forEach(it=>{
      const s=computeExpiryStatus(it.expiry);
      if(s==='ok')ok++; else if(s==='warn')w++; else e++;
      const low = qtyIsLow(it.qty, it.target_qty);
      el.insertAdjacentHTML('beforeend',`
        <div class="row ${s}">
          <div class="rhead">
            <div>
              <b>${it.name}</b>
              ${it.bemerkung?`<div style="color:var(--text-light);font-size:.9rem">${it.bemerkung}</div>`:''}
            </div>
            <div class="qtyline ${low?'low':''}">IST: ${it.qty} / SOLL: ${it.target_qty ?? 0}</div>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem;flex-wrap:wrap">
            <span class="badge ${s}">${it.expiry||'kein Ablaufdatum'}</span>
            <div>
              <button class="btn bicon" onclick="adjustQty('${it.id}',-1)"><i class="fas fa-minus"></i> -1</button>
              <button class="btn bicon" onclick="adjustQty('${it.id}', 1)"><i class="fas fa-plus"></i> +1</button>
              <button class="btn bicon" onclick="openEditor('${it.id}')"><i class="fas fa-edit"></i> Bearbeiten</button>
              <button class="btn bicon" onclick="deleteItem('${it.id}')"><i class="fas fa-trash"></i> Löschen</button>
            </div>
          </div>
        </div>`);
    });
    document.getElementById('s-ok').textContent=ok;
    document.getElementById('s-warn').textContent=w;
    document.getElementById('s-exp').textContent=e;
    document.getElementById('s-total').textContent=items.length;
  }

  async function logMovement(itemId, delta, note){
    try{
      const user = nhost.auth.getUser();
      const actor = user?.email || user?.displayName || 'unbekannt';
      await gql(`mutation($obj:inventory_movements_insert_input!){
        insert_inventory_movements_one(object:$obj){ id }
      }`, { obj: { item_id: itemId, delta, actor, note } });
    }catch(e){
      console.warn('Bewegungs-Log fehlgeschlagen:', e.message||e);
    }
  }

  async function adjustQty(id, delta){
    const it=items.find(i=>i.id===id); if(!it) return;
    if(delta<0 && it.qty<=0){ alert('Nicht genügend Bestand'); return; }
    try{
      await gql(`mutation($id:uuid!,$d:Int!){
        update_inventory_items_by_pk(pk_columns:{id:$id}, _inc:{qty:$d}){ id }
      }`,{id,d:delta});
      await logMovement(id, delta, delta>0? 'Einbuchung': 'Ausbuchung');
      await fetchItems();
    }catch(e){ showError(e.message||e); }
  }

  async function deleteItem(id){
    const it=items.find(i=>i.id===id); if(!it) return;
    if(!confirm(`„${it.name}“ löschen?`)) return;
    try{
      await gql(`mutation($id:uuid!){ delete_inventory_items_by_pk(id:$id){ id } }`,{id});
      await logMovement(id, 0, 'Artikel gelöscht');
      await fetchItems();
    }catch(e){ showError(e.message||e); }
  }
  window.adjustQty=adjustQty;
  window.deleteItem=deleteItem;

  /* ==== EDITOR + HISTORIE ==== */
  window.openEditor = async function(id){
    const it=id? items.find(i=>i.id===id) : {name:'',qty:1,target_qty:0,expiry:'',bemerkung:'',location:currentLocation};
    const html=`
    <div id="modal" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:999">
      <div class="card" style="width:92%;max-width:520px">
        <h3 style="margin:0 0 .5rem 0">${id?'Artikel bearbeiten':'Neuen Artikel anlegen'}</h3>
        <div style="display:grid;gap:.5rem">
          <label>Name <input id="m-name" value="${it.name||''}" style="width:100%;padding:.5rem;border:1px solid var(--border);border-radius:.5rem"></label>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem">
            <label>IST <input id="m-qty" type="number" min="0" value="${it.qty||0}" style="width:100%;padding:.5rem;border:1px solid var(--border);border-radius:.5rem"></label>
            <label>SOLL <input id="m-target" type="number" min="0" value="${it.target_qty??0}" style="width:100%;padding:.5rem;border:1px solid var(--border);border-radius:.5rem"></label>
          </div>
          <label>Ablaufdatum <input id="m-exp" type="date" value="${it.expiry||''}" style="width:100%;padding:.5rem;border:1px solid var(--border);border-radius:.5rem"></label>
          <label>Lagerort
            <select id="m-loc" style="width:100%;padding:.5rem;border:1px solid var(--border);border-radius:.5rem">
              ${LOCATIONS.map(l=>`<option ${l===(it.location||currentLocation)?'selected':''}>${l}</option>`).join('')}
            </select>
          </label>
          <label>Bemerkung <textarea id="m-note" rows="3" style="width:100%;padding:.5rem;border:1px solid var(--border);border-radius:.5rem">${it.bemerkung||''}</textarea></label>
        </div>

        <div id="hist-wrap" style="margin-top:.5rem;display:none">
          <h4 style="margin:.5rem 0">Historie</h4>
          <div class="center-muted" id="hist-loading">Lade…</div>
          <div id="hist-table"></div>
        </div>

        <div style="display:flex;gap:.5rem;justify-content:space-between;margin-top:.75rem;flex-wrap:wrap">
          <div style="display:flex;gap:.5rem;flex-wrap:wrap">
            ${id?`<button class="btn" id="btn-hist"><i class="fas fa-clock"></i> Historie</button>`:''}
          </div>
          <div style="display:flex;gap:.5rem;flex-wrap:wrap">
            ${id?`<button class="btn" onclick="(async()=>{ if(confirm('Wirklich löschen?')){ await deleteItem('${id}'); document.getElementById('modal').remove(); } })()">Löschen</button>`:''}
            <button class="btn" onclick="document.getElementById('modal').remove()">Abbrechen</button>
            <button class="btn" style="background:var(--primary);color:#fff;border:none" id="btn-save">Speichern</button>
          </div>
        </div>
      </div>
    </div>`;
    document.body.insertAdjacentHTML('beforeend', html);

    if(id){
      document.getElementById('btn-hist')?.addEventListener('click', async ()=>{
        const box=document.getElementById('hist-wrap');
        box.style.display = box.style.display==='none' ? 'block' : 'none';
        if(box.style.display==='block'){
          document.getElementById('hist-loading').style.display='block';
          document.getElementById('hist-table').innerHTML='';
          try{
            const data=await gql(`query($id:uuid!){
              inventory_movements(where:{item_id:{_eq:$id}}, order_by:{created_at:desc}, limit:50){
                id delta actor note created_at
              }
            }`,{id});
            const rows=data.inventory_movements;
            document.getElementById('hist-loading').style.display='none';
            if(!rows.length){
              document.getElementById('hist-table').innerHTML='<div class="center-muted">Keine Bewegungen</div>';
            }else{
              const html=`
                <table class="hist">
                  <thead><tr><th>Zeit</th><th>Delta</th><th>Aktion</th><th>von</th></tr></thead>
                  <tbody>
                    ${rows.map(r=>`<tr>
                      <td>${new Date(r.created_at).toLocaleString()}</td>
                      <td>${r.delta>0?`+${r.delta}`:r.delta}</td>
                      <td>${r.note|| (r.delta>0?'Einbuchung':'Ausbuchung')}</td>
                      <td>${r.actor||''}</td>
                    </tr>`).join('')}
                  </tbody>
                </table>`;
              document.getElementById('hist-table').innerHTML=html;
            }
          }catch(e){
            document.getElementById('hist-loading').style.display='none';
            document.getElementById('hist-table').innerHTML = `<div class="error">Historie konnte nicht geladen werden: ${e.message||e}</div>`;
          }
        }
      });
    }

    document.getElementById('btn-save').onclick = async ()=>{
      const vName = document.getElementById('m-name').value.trim();
      const vQty  = parseInt(document.getElementById('m-qty').value,10)||0;
      const vTgt  = parseInt(document.getElementById('m-target').value,10)||0;
      const vExp  = document.getElementById('m-exp').value||null;
      const vLoc  = document.getElementById('m-loc').value;
      const vNote = document.getElementById('m-note').value.trim();
      if(!vName){ alert('Name erforderlich'); return; }

      try{
        if(id){
          const before = items.find(i=>i.id===id);
          await gql(`mutation($id:uuid!,$set:inventory_items_set_input!){
            update_inventory_items_by_pk(pk_columns:{id:$id}, _set:$set){ id }
          }`,{id,set:{name:vName,qty:vQty,target_qty:vTgt,expiry:vExp,location:vLoc,bemerkung:vNote}});
          const delta = (vQty - (before?.qty??0));
          if(delta!==0){ await logMovement(id, delta, 'Menge geändert (Bearbeiten)'); }
        }else{
          const res = await gql(`mutation($obj:inventory_items_insert_input!){
            insert_inventory_items_one(object:$obj){ id }
          }`,{obj:{name:vName,qty:vQty,target_qty:vTgt,expiry:vExp,location:vLoc,bemerkung:vNote}});
          const newId = res.insert_inventory_items_one.id;
          if(vQty!==0){ await logMovement(newId, vQty, 'Neuanlage'); }
        }
        document.getElementById('modal').remove();
        await fetchItems();
      }catch(e){ showError(e.message||e); }
    };
  };

  /* ==== NAV ==== */
  document.getElementById('navg').addEventListener('click',e=>{
    const a=e.target.closest('a[data-loc]'); if(!a) return;
    e.preventDefault();
    document.querySelectorAll('#navg a').forEach(x=>x.classList.remove('active'));
    a.classList.add('active');
    currentLocation=a.dataset.loc;
    renderToolbar();
    fetchItems();
  });

  /* ==== START ==== */
  renderToolbar();
  await fetchItems();
</script>
</body>
</html>
