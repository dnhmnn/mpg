<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>CIRS-Meldung</title>
<link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{ --rot:#c8102e; --bg:#f7f7f7; --card:#fff; --border:#e5e7eb; --muted:#6b7280; }
  *{ box-sizing:border-box }
  body{ 
    margin:0; 
    background:var(--bg); 
    font-family:'Atkinson Hyperlegible',system-ui,Arial,sans-serif;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  header{ 
    background:var(--rot); 
    color:#fff; 
    padding:16px; 
    font-weight:700;
    font-size:1.2rem;
    text-align:center;
    box-shadow:0 2px 8px rgba(0,0,0,.1);
  }
  .wrap{ 
    max-width:820px; 
    margin:0 auto; 
    padding:16px;
  }
  .card{ 
    background:var(--card); 
    border-radius:12px; 
    box-shadow:0 2px 8px rgba(0,0,0,.08); 
    padding:20px; 
    margin-bottom:16px;
  }
  h2{ 
    color:var(--rot); 
    margin:0 0 16px;
    font-size:1.3rem;
  }
  label{ 
    color:var(--rot); 
    font-weight:700; 
    margin-top:12px; 
    margin-bottom:6px;
    display:block;
    font-size:1rem;
  }
  input, select, textarea{
    width:100%; 
    padding:14px; 
    border:2px solid var(--border); 
    border-radius:10px; 
    background:#fafafa; 
    font-size:16px;
    font-family:inherit;
    transition:border-color 0.2s;
  }
  /* Wichtig: datetime-local spezifisch auf gleiche Gr√∂√üe setzen */
  input[type="datetime-local"]{
    font-size:16px;
    padding:14px;
    line-height:normal;
    height:auto;
  }
  input:focus, select:focus, textarea:focus{
    outline:none;
    border-color:var(--rot);
    background:#fff;
  }
  input:disabled{
    background:#f0f0f0;
    color:#999;
    cursor:not-allowed;
  }
  textarea{ 
    min-height:120px; 
    resize:vertical;
    line-height:1.5;
  }
  .row{ 
    display:flex; 
    gap:12px; 
    flex-wrap:wrap;
  }
  .row > div{
    flex:1;
    min-width:0;
  }
  .checkbox-group{
    display:flex;
    align-items:center;
    gap:8px;
    margin-top:10px;
    padding:12px;
    background:#f9f9f9;
    border-radius:8px;
  }
  .checkbox-group input[type="checkbox"]{
    width:auto;
    margin:0;
    cursor:pointer;
    width:20px;
    height:20px;
  }
  .checkbox-group label{
    margin:0;
    cursor:pointer;
    font-weight:600;
    font-size:0.95rem;
  }
  .btn-group{
    display:flex;
    gap:10px;
    flex-direction:column;
    margin-top:16px;
  }
  .btn{ 
    background:var(--rot); 
    color:#fff; 
    border:none; 
    border-radius:10px; 
    padding:16px 20px; 
    font-weight:700; 
    cursor:pointer;
    font-size:1.05rem;
    width:100%;
    transition:background 0.2s, transform 0.1s;
    -webkit-tap-highlight-color:transparent;
  }
  .btn:active{
    transform:scale(0.98);
  }
  .btn:disabled{
    opacity:0.6;
    cursor:not-allowed;
  }
  .btn.ghost{ 
    background:#fff; 
    color:var(--rot); 
    border:2px solid var(--rot);
  }
  .btn.ghost:active{
    background:#f7f7f7;
  }
  .hint{ 
    color:var(--muted); 
    font-size:.95rem;
    line-height:1.5;
    margin-top:12px;
  }
  .msg{ 
    border-radius:10px; 
    padding:16px; 
    background:#fff5f5; 
    border:2px solid #f2c9d1; 
    color:#b00020; 
    margin-top:16px;
    font-size:1rem;
    font-weight:600;
    text-align:center;
    animation:slideIn 0.3s ease-out;
  }
  .ok{ 
    background:#dcfce7; 
    border-color:#16a34a; 
    color:#15803d;
  }
  
  @keyframes slideIn{
    from{
      opacity:0;
      transform:translateY(-10px);
    }
    to{
      opacity:1;
      transform:translateY(0);
    }
  }
  
  /* Bessere Touch-Targets f√ºr Mobile */
  @media (max-width: 600px){
    body{
      font-size:16px;
    }
    header{ 
      font-size:1.1rem;
      padding:14px;
    }
    .wrap{
      padding:12px;
    }
    .card{
      padding:16px;
      margin-bottom:12px;
    }
    h2{
      font-size:1.2rem;
      margin-bottom:14px;
    }
    input, select, textarea{
      font-size:16px;
      padding:14px 12px;
    }
    input[type="datetime-local"]{
      font-size:16px;
      padding:14px 12px;
    }
    textarea{
      min-height:100px;
    }
    .row{
      flex-direction:column;
      gap:0;
    }
    .btn{
      padding:16px;
      font-size:1rem;
    }
    .msg{
      font-size:0.95rem;
      padding:14px;
    }
  }
  
  /* Extra kleine Displays */
  @media (max-width: 380px){
    .wrap{
      padding:10px;
    }
    .card{
      padding:14px;
    }
    input, select, textarea{
      padding:12px 10px;
    }
    input[type="datetime-local"]{
      padding:12px 10px;
    }
  }
</style>
</head>
<body>
<header>üöë CIRS-Meldung</header>

<div class="wrap">

  <!-- Kopfdaten -->
  <section class="card">
    <h2>üìã Kopfdaten</h2>
    <div class="row">
      <div>
        <label for="dt">Datum & Uhrzeit</label>
        <input id="dt" type="datetime-local" />
      </div>
      <div>
        <label for="einsatz">Einsatznummer (optional)</label>
        <input id="einsatz" placeholder="z. B. 2025-001" />
      </div>
    </div>

    <label for="kat">Kategorie</label>
    <select id="kat">
      <option value="Material/Technik">Material/Technik</option>
      <option value="Kommunikation">Kommunikation</option>
      <option value="Organisation/Prozess">Organisation/Prozess</option>
      <option value="Sonstiges">Sonstiges</option>
    </select>

    <label for="desc">Beschreibung (Was ist passiert?)</label>
    <textarea id="desc" placeholder="Kurz und pr√§gnant beschreiben ‚Ä¶"></textarea>

    <label for="measures">Ma√ünahmen / Vorschl√§ge</label>
    <textarea id="measures" placeholder="Was wurde unternommen? Was schlagen Sie vor?"></textarea>
  </section>

  <!-- Melder -->
  <section class="card">
    <h2>üë§ Melder (optional)</h2>
    <label for="melder">Name</label>
    <input id="melder" placeholder="Ihr Name oder leer lassen f√ºr anonym" />
    
    <div class="checkbox-group">
      <input type="checkbox" id="anonym" />
      <label for="anonym">Anonym melden (Name wird gel√∂scht)</label>
    </div>
    <p class="hint" style="margin-top:8px">üí° Wenn Sie anonym bleiben m√∂chten, aktivieren Sie die Checkbox. Ihr Name wird dann nicht gespeichert.</p>
  </section>

  <!-- Absenden -->
  <section class="card">
    <div class="btn-group">
      <button id="saveBtn" class="btn" type="button">‚úÖ Meldung speichern</button>
      <button id="draftBtn" class="btn ghost" type="button">üíæ Zwischenspeichern</button>
    </div>
    <p class="hint">Die Meldung erscheint in <strong>Dokumente bearbeiten</strong> (Status: ‚Äûoffen") und kann dort auf ‚Äûerledigt" gesetzt werden.</p>
    <div id="msg" class="msg" style="display:none"></div>
  </section>

</div>

<script>
/* -------- Einstellungen -------- */
const GRAPHQL_FN = '/.netlify/functions/graphql';
const DRAFT_KEY = 'draft_cirs_v1';

/* -------- Helfer -------- */
const $ = id => document.getElementById(id);
const msgEl = $('msg');
const melderInput = $('melder');
const anonymCheckbox = $('anonym');

function showMsg(text, ok=false){
  msgEl.textContent = text;
  msgEl.className = 'msg ' + (ok ? 'ok' : '');
  msgEl.style.display = 'block';
  
  // Scroll zur Nachricht
  msgEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function hideMsg(){
  msgEl.style.display = 'none';
}

function pad(n){ return String(n).padStart(2,'0'); }
function setNow(){
  const d = new Date();
  const val = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  $('dt').value = val;
}

function collect(){
  const isAnonym = anonymCheckbox.checked;
  return {
    dt: $('dt').value,
    einsatz: ($('einsatz').value || '').trim(),
    kat: $('kat').value,
    desc: ($('desc').value || '').trim(),
    measures: ($('measures').value || '').trim(),
    melder: isAnonym ? 'Anonym' : (melderInput.value || '').trim() || 'Anonym'
  };
}

/* -------- Anonym-Checkbox Logik -------- */
anonymCheckbox.addEventListener('change', ()=>{
  if(anonymCheckbox.checked){
    melderInput.value = '';
    melderInput.disabled = true;
    melderInput.placeholder = 'Anonym';
  } else {
    melderInput.disabled = false;
    melderInput.placeholder = 'Ihr Name oder leer lassen f√ºr anonym';
  }
});

/* -------- Draft lokal -------- */
$('draftBtn').addEventListener('click', ()=>{
  const d = collect();
  const draftData = {
    dt: $('dt').value,
    einsatz: $('einsatz').value,
    kat: $('kat').value,
    desc: $('desc').value,
    measures: $('measures').value,
    melder: melderInput.value,
    anonym: anonymCheckbox.checked
  };
  localStorage.setItem(DRAFT_KEY, JSON.stringify(draftData));
  showMsg('üíæ Entwurf lokal gespeichert!', true);
  setTimeout(hideMsg, 3000);
});

(function loadDraft(){
  const raw = localStorage.getItem(DRAFT_KEY);
  if(!raw) return;
  try{
    const d = JSON.parse(raw);
    if(d.dt) $('dt').value = d.dt;
    if(d.einsatz) $('einsatz').value = d.einsatz;
    if(d.kat) $('kat').value = d.kat;
    if(d.desc) $('desc').value = d.desc;
    if(d.measures) $('measures').value = d.measures;
    if(d.melder) melderInput.value = d.melder;
    if(d.anonym) {
      anonymCheckbox.checked = true;
      melderInput.disabled = true;
      melderInput.placeholder = 'Anonym';
    }
  }catch(_){}
})();

/* -------- Absenden -------- */
$('saveBtn').addEventListener('click', saveCIRS);

async function saveCIRS(){
  try{
    showMsg('‚è≥ Speichere Meldung ‚Ä¶', true);
    const btn = $('saveBtn');
    btn.disabled = true;
    
    const d = collect();

    const datePart = d.dt ? formatDateDE(d.dt) : formatDateDE(new Date().toISOString());
    const title = `CIRS${d.einsatz ? ' '+d.einsatz : ''} (${datePart})`;

    const payload = {
      datetime: d.dt || null,
      einsatznummer: d.einsatz || null,
      kategorie: d.kat,
      beschreibung: d.desc,
      massnahmen: d.measures,
      melder: d.melder
    };

    const query = `
      mutation InsertCirs($obj: documents_insert_input!) {
        insert_documents_one(object: $obj) { id }
      }`;

    const variables = {
      obj: { type:'cirs', title, status:'offen', payload }
    };

    const res = await fetch(GRAPHQL_FN, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ query, variables })
    });

    const ctype = (res.headers.get('content-type') || '').toLowerCase();
    if (!ctype.includes('application/json')) {
      const text = await res.text();
      throw new Error(`HTTP ${res.status}: ${text.substring(0,200)}`);
    }
    const json = await res.json();
    if (json.errors) throw new Error(json.errors[0]?.message || 'Unbekannter GraphQL-Fehler');

    // Erfolg
    localStorage.removeItem(DRAFT_KEY);
    
    // ERFOLGS-MELDUNG - 4 Sekunden sichtbar
    showMsg('‚úÖ CIRS-Meldung erfolgreich gespeichert! Sie erscheint jetzt in "Dokumente bearbeiten".', true);

    // Formular zur√ºcksetzen nach 4 Sekunden
    setTimeout(()=>{
      $('einsatz').value=''; 
      $('desc').value=''; 
      $('measures').value=''; 
      melderInput.value='';
      anonymCheckbox.checked = false;
      melderInput.disabled = false;
      melderInput.placeholder = 'Ihr Name oder leer lassen f√ºr anonym';
      setNow(); 
      hideMsg();
      btn.disabled = false;
    }, 4000);

  }catch(err){
    showMsg('‚ùå Fehler beim Speichern: ' + (err?.message || String(err)));
    $('saveBtn').disabled = false;
  }
}

function formatDateDE(dtLocal){
  const d = new Date(dtLocal);
  return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()}`;
}

/* -------- Start -------- */
setNow();
</script>
</body>
</html>
