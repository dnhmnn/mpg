<!DOCTYPE html>

<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Supervisor Dashboard – Responda</title>

  <meta name="theme-color" content="#667eea">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/pocketbase@0.21.3/dist/pocketbase.umd.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #f97316 50%, #764ba2 100%);
      background-attachment: fixed;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      user-select: none;
      margin: 0;
      padding: 0;
    }
    
    /* Status Bar */
    .status-bar {
      height: 54px;
      padding-top: env(safe-area-inset-top);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-left: max(24px, env(safe-area-inset-left));
      padding-right: max(24px, env(safe-area-inset-right));
      color: #fff;
      font-size: 15px;
      font-weight: 600;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }
    
    .logo {
      display: flex;
      align-items: center;
      height: 32px;
    }
    
    .logo svg {
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }
    
    .logout-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 0.5px solid rgba(255, 255, 255, 0.3);
      color: #fff;
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      font-family: inherit;
    }
    
    .logout-btn:active {
      transform: scale(0.95);
      background: rgba(255, 255, 255, 0.3);
    }
    
    /* Main Content */
    .content {
      height: 100vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding-top: calc(54px + env(safe-area-inset-top) + 30px);
      padding-left: max(20px, env(safe-area-inset-left));
      padding-right: max(20px, env(safe-area-inset-right));
      padding-bottom: max(40px, env(safe-area-inset-bottom));
    }
    
    /* Login Screen */
    #loginSection {
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: max(20px, env(safe-area-inset-top)) max(20px, env(safe-area-inset-right)) max(20px, env(safe-area-inset-bottom)) max(20px, env(safe-area-inset-left));
    }
    
    .login-card {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(40px);
      -webkit-backdrop-filter: blur(40px);
      border-radius: 20px;
      border: 0.5px solid rgba(255, 255, 255, 0.3);
      padding: 32px;
      max-width: 440px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    .login-card h2 {
      color: #fff;
      font-size: 24px;
      margin-bottom: 8px;
    }
    
    .login-card p {
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 24px;
    }
    
    /* Widgets */
    .widgets {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 32px;
    }
    
    .widget {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(40px);
      -webkit-backdrop-filter: blur(40px);
      border-radius: 20px;
      padding: 16px;
      color: #fff;
      min-height: 120px;
      border: 0.5px solid rgba(255, 255, 255, 0.3);
    }
    
    .widget.large {
      grid-column: span 2;
    }
    
    .widget-title {
      font-size: 13px;
      font-weight: 600;
      opacity: 0.8;
      margin-bottom: 8px;
    }
    
    .widget-value {
      font-size: 28px;
      font-weight: 700;
    }
    
    /* Cards */
    .card {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(40px);
      -webkit-backdrop-filter: blur(40px);
      border-radius: 20px;
      border: 0.5px solid rgba(255, 255, 255, 0.3);
      padding: 20px;
      margin-bottom: 16px;
      color: #fff;
    }
    
    .card h2 {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 16px;
      color: #fff;
    }
    
    /* Buttons */
    .btn {
      background: rgba(255, 255, 255, 0.95);
      color: #667eea;
      border: none;
      border-radius: 12px;
      padding: 12px 16px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
      width: 100%;
    }
    
    .btn:active {
      transform: scale(0.98);
      background: #fff;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn.secondary {
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      border: 0.5px solid rgba(255, 255, 255, 0.3);
    }
    
    .btn.success {
      background: #16a34a;
      color: #fff;
    }
    
    .btn.danger {
      background: #dc2626;
      color: #fff;
    }
    
    /* Forms */
    .field {
      margin-bottom: 16px;
    }
    
    .field label {
      display: block;
      font-weight: 600;
      color: #fff;
      margin-bottom: 6px;
      font-size: 14px;
    }
    
    input, textarea, select {
      width: 100%;
      padding: 12px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      font-size: 16px;
      font-family: inherit;
      background: rgba(255, 255, 255, 0.95);
      color: #1a1a1a;
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #fff;
      background: #fff;
    }
    
    input::placeholder, textarea::placeholder {
      color: #9ca3af;
    }
    
    /* Table */
    .table-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 8px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 900px;
    }
    
    th {
      background: rgba(255, 255, 255, 0.2);
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #fff;
      font-size: 14px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    td {
      padding: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 14px;
      color: rgba(255, 255, 255, 0.95);
    }
    
    tr:hover {
      background: rgba(255, 255, 255, 0.05);
    }
    
    /* Badges */
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
    }
    
    .badge-active { background: #dcfce7; color: #16a34a; }
    .badge-inactive { background: #fee2e2; color: #dc2626; }
    .badge-trial { background: #fef3c7; color: #d97706; }
    .badge-basic { background: #dbeafe; color: #1e40af; }
    .badge-professional { background: #e2d9f3; color: #4a148c; }
    .badge-enterprise { background: #fee2e2; color: #dc2626; }
    .badge-info { background: #dbeafe; color: #1e40af; }
    .badge-warning { background: #fef3c7; color: #d97706; }
    .badge-success { background: #dcfce7; color: #16a34a; }
    .badge-update { background: #e2d9f3; color: #4a148c; }
    
    /* Action Buttons */
    .action-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.2s;
      font-family: inherit;
      min-width: 44px;
      min-height: 44px;
    }
    
    .action-btn.edit { background: #dbeafe; color: #1e40af; }
    .action-btn.edit:active { background: #bfdbfe; }
    .action-btn.delete { background: #fee2e2; color: #dc2626; }
    .action-btn.delete:active { background: #fecaca; }
    .action-btn.user { background: #dcfce7; color: #16a34a; }
    .action-btn.user:active { background: #bbf7d0; }
    
    .table-actions {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }
    
    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 16px;
      overflow-y: auto;
    }
    
    .modal.show { display: flex; }
    
    .modal-box {
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(40px);
      -webkit-backdrop-filter: blur(40px);
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      padding: 24px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      border: 0.5px solid rgba(255, 255, 255, 0.3);
    }
    
    .modal-h {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .modal-h h3 {
      margin: 0;
      color: #667eea;
      font-size: 20px;
      font-weight: 700;
    }
    
    .x {
      margin-left: auto;
      border: none;
      background: #f3f4f6;
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      font-weight: 700;
      font-size: 24px;
      min-width: 40px;
      min-height: 40px;
      color: #667eea;
    }
    
    .x:active {
      background: #e5e7eb;
    }
    
    .actions {
      display: flex;
      gap: 8px;
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid #e5e7eb;
    }
    
    .modal-box .field label {
      color: #667eea;
    }
    
    /* Messages */
    .msg {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-weight: 600;
      font-size: 14px;
    }
    
    .msg.error {
      background: #fee2e2;
      color: #dc2626;
    }
    
    .msg.success {
      background: #d1fae5;
      color: #16a34a;
    }
    
    .msg.info {
      background: #dbeafe;
      color: #1e40af;
    }
    
    .info-box {
      background: #dbeafe;
      border-left: 4px solid #3b82f6;
      padding: 12px;
      border-radius: 6px;
      margin: 12px 0;
      font-size: 14px;
      color: #1e40af;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: rgba(255, 255, 255, 0.8);
      font-size: 16px;
    }
    
    @media (max-width: 768px) {
      .widgets {
        grid-template-columns: 1fr;
      }
      
      .status-bar {
        padding-left: 16px;
        padding-right: 16px;
      }
      
      .content {
        padding-left: 16px;
        padding-right: 16px;
      }
    }
  </style>

</head>
<body>

<!-- Login Section -->

<div id="loginSection">
  <div class="login-card">
    <h2>Supervisor Login</h2>
    <p>Responda System Administration</p>

```
<div id="loginError" class="msg error" style="display:none;"></div>

<form id="loginForm" onsubmit="handleLogin(event)">
  <div class="field">
    <label for="loginEmail">E-Mail</label>
    <input type="email" id="loginEmail" value="supervisor@responda.systems" required>
  </div>
  
  <div class="field">
    <label for="loginPassword">Passwort</label>
    <input type="password" id="loginPassword" required>
  </div>
  
  <button type="submit" class="btn">Einloggen</button>
</form>
```

  </div>
</div>

<!-- Dashboard Section -->

<div id="dashboardSection" style="display:none">
  <div class="status-bar">
    <div class="logo">
      <svg width="120" height="32" viewBox="0 0 2800 700">
        <defs>
          <linearGradient id="logoGrad" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#fff;stop-opacity:1" />
            <stop offset="50%" style="stop-color:#fff;stop-opacity:0.95" />
            <stop offset="100%" style="stop-color:#fff;stop-opacity:0.9" />
          </linearGradient>
        </defs>
        <rect x="50" y="50" width="600" height="600" rx="150" fill="rgba(255,255,255,0.2)"/>
        <path d="M 175 175 L 175 525 L 287.5 525 L 287.5 400 L 362.5 400 L 437.5 525 L 575 525 L 475 390.625 Q 512.5 371.875 512.5 306.25 Q 512.5 175 431.25 175 Z M 287.5 237.5 L 393.75 237.5 Q 437.5 237.5 437.5 293.75 Q 437.5 350 393.75 350 L 287.5 350 Z" fill="white"/>
        <text x="750" y="450" font-family="Archivo, sans-serif" font-size="280" font-weight="600" fill="url(#logoGrad)" letter-spacing="-5">Responda</text>
      </svg>
    </div>
    <button class="logout-btn" id="logoutBtn">Abmelden</button>
  </div>

  <div class="content">
    <!-- Statistics -->
    <div class="widgets">
      <div class="widget">
        <div class="widget-title">Organisationen</div>
        <div class="widget-value" id="totalOrgs">0</div>
      </div>
      <div class="widget">
        <div class="widget-title">Benutzer</div>
        <div class="widget-value" id="totalUsers">0</div>
      </div>
      <div class="widget">
        <div class="widget-title">Aktive Orgas</div>
        <div class="widget-value" id="activeOrgs">0</div>
      </div>
      <div class="widget">
        <div class="widget-title">Info-Meldungen</div>
        <div class="widget-value" id="totalNotifications">0</div>
      </div>
    </div>

```
<!-- Action Buttons -->
<div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:16px">
  <button class="btn success" onclick="showCreateModal()">+ Neue Organisation</button>
  <button class="btn success" onclick="showNotificationModal()">+ Neue Info-Meldung</button>
</div>

<!-- Organizations -->
<div class="card">
  <h2>Alle Organisationen</h2>
  
  <div id="loadingOrgs" class="loading">Lade Organisationen...</div>
  <div id="orgsContainer" style="display:none;">
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Code</th>
            <th>Name</th>
            <th>Lizenz</th>
            <th>Max Users</th>
            <th>User Count</th>
            <th>Status</th>
            <th>Aktionen</th>
          </tr>
        </thead>
        <tbody id="orgsTableBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Info-Meldungen -->
<div class="card">
  <h2>Info-Meldungen</h2>
  
  <div id="loadingNotifications" class="loading">Lade Meldungen...</div>
  <div id="notificationsContainer" style="display:none;">
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Titel</th>
            <th>Typ</th>
            <th>Organisation</th>
            <th>Status</th>
            <th>Erstellt</th>
            <th>Aktionen</th>
          </tr>
        </thead>
        <tbody id="notificationsTableBody"></tbody>
      </table>
    </div>
  </div>
</div>
```

  </div>
</div>

<!-- Org Modal -->

<div id="orgModal" class="modal" onclick="closeModalOnBackdrop(event, 'orgModal')">
  <div class="modal-box" onclick="event.stopPropagation()">
    <div class="modal-h">
      <h3 id="modalTitle">Neue Organisation</h3>
      <button class="x" onclick="closeOrgModal()">&times;</button>
    </div>

```
<div id="modalError" class="msg error" style="display:none;"></div>
<div id="modalSuccess" class="msg success" style="display:none;"></div>

<form id="orgForm" onsubmit="handleSaveOrg(event)">
  <input type="hidden" id="orgId">
  
  <div class="field">
    <label for="orgCode">Organisations-Code *</label>
    <input type="text" id="orgCode" pattern="[a-z0-9]+" required placeholder="z.B. ffwmuenchen">
  </div>
  
  <div class="field">
    <label for="orgName">Name *</label>
    <input type="text" id="orgName" required placeholder="z.B. FFW München">
  </div>
  
  <div class="field">
    <label for="licenseType">Lizenz-Typ *</label>
    <select id="licenseType" required>
      <option value="trial">Trial</option>
      <option value="basic">Basic</option>
      <option value="professional">Professional</option>
      <option value="enterprise">Enterprise</option>
    </select>
  </div>
  
  <div class="field">
    <label for="licenseValidUntil">Lizenz gültig bis</label>
    <input type="date" id="licenseValidUntil">
  </div>
  
  <div class="field">
    <label for="maxUsers">Max. Benutzer *</label>
    <input type="number" id="maxUsers" value="10" min="1" required>
  </div>
  
  <div class="field">
    <label for="contactEmail">Kontakt E-Mail</label>
    <input type="email" id="contactEmail" placeholder="admin@organisation.de">
  </div>
  
  <div class="field">
    <label for="contactPerson">Kontaktperson</label>
    <input type="text" id="contactPerson" placeholder="Max Mustermann">
  </div>
  
  <div class="field">
    <label for="contactPhone">Telefon</label>
    <input type="text" id="contactPhone" placeholder="0123456789">
  </div>
  
  <div class="field">
    <label>
      <input type="checkbox" id="isActive" checked> Aktiv
    </label>
  </div>
  
  <div class="actions">
    <button type="button" onclick="closeOrgModal()" class="btn secondary">Abbrechen</button>
    <button type="submit" class="btn success">Speichern</button>
  </div>
</form>
```

  </div>
</div>

<!-- User Modal -->

<div id="userModal" class="modal" onclick="closeModalOnBackdrop(event, 'userModal')">
  <div class="modal-box" onclick="event.stopPropagation()">
    <div class="modal-h">
      <h3>Ersten Benutzer anlegen</h3>
      <button class="x" onclick="closeUserModal()">&times;</button>
    </div>

```
<div class="info-box">
  <strong>Ersten MPG-Beauftragten anlegen</strong><br>
  Dieser User erhält automatisch die Rolle "MPG-Beauftragter" mit vollen Berechtigungen.
</div>

<div id="userModalError" class="msg error" style="display:none;"></div>
<div id="userModalSuccess" class="msg success" style="display:none;"></div>

<form id="userForm" onsubmit="handleCreateFirstUser(event)">
  <input type="hidden" id="userOrgId">
  <input type="hidden" id="userOrgName">
  
  <div class="field">
    <label for="userEmail">E-Mail *</label>
    <input type="email" id="userEmail" required placeholder="admin@organisation.de">
  </div>
  
  <div class="field">
    <label for="userName">Name *</label>
    <input type="text" id="userName" required placeholder="Max Mustermann">
  </div>
  
  <div class="field">
    <label for="userPhone">Telefon (optional)</label>
    <input type="tel" id="userPhone" placeholder="+49 123 456789">
  </div>
  
  <div class="actions">
    <button type="button" onclick="closeUserModal()" class="btn secondary">Abbrechen</button>
    <button type="submit" class="btn success" id="createUserBtn">Benutzer anlegen</button>
  </div>
</form>
```

  </div>
</div>

<!-- Notification Modal -->

<div id="notificationModal" class="modal" onclick="closeModalOnBackdrop(event, 'notificationModal')">
  <div class="modal-box" onclick="event.stopPropagation()">
    <div class="modal-h">
      <h3 id="notificationModalTitle">Neue Info-Meldung</h3>
      <button class="x" onclick="closeNotificationModal()">&times;</button>
    </div>

```
<div id="notificationModalError" class="msg error" style="display:none;"></div>
<div id="notificationModalSuccess" class="msg success" style="display:none;"></div>

<form id="notificationForm" onsubmit="handleSaveNotification(event)">
  <input type="hidden" id="notificationId">
  
  <div class="field">
    <label for="notificationOrg">Organisation *</label>
    <select id="notificationOrg" required>
      <option value="">Bitte wählen...</option>
    </select>
  </div>
  
  <div class="field">
    <label for="notificationTitle">Titel *</label>
    <input type="text" id="notificationTitle" required placeholder="z.B. Wichtige Info">
  </div>
  
  <div class="field">
    <label for="notificationMessage">Nachricht *</label>
    <textarea id="notificationMessage" rows="4" required placeholder="Deine Info-Meldung..."></textarea>
  </div>
  
  <div class="field">
    <label for="notificationType">Typ *</label>
    <select id="notificationType" required>
      <option value="info">Info</option>
      <option value="warning">Warnung</option>
      <option value="success">Erfolg</option>
      <option value="update">Update</option>
    </select>
  </div>
  
  <div class="field">
    <label>
      <input type="checkbox" id="notificationActive" checked> Aktiv
    </label>
  </div>
  
  <div class="actions">
    <button type="button" onclick="closeNotificationModal()" class="btn secondary">Abbrechen</button>
    <button type="submit" class="btn success">Speichern</button>
  </div>
</form>
```

  </div>
</div>

<script>
  const pb = new PocketBase('https://api.responda.systems');
  let currentUser = null;
  let orgUsersCount = {};
  let allOrgs = [];

  // Login Handler
  async function handleLogin(event) {
    event.preventDefault();
    
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    const errorDiv = document.getElementById('loginError');
    
    try {
      const authData = await pb.collection('users').authWithPassword(email, password);
      
      if (!authData.record.supervisor) {
        errorDiv.textContent = 'Zugriff verweigert! Nur für Supervisors.';
        errorDiv.style.display = 'block';
        pb.authStore.clear();
        return;
      }
      
      currentUser = authData.record;
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('dashboardSection').style.display = 'block';
      
      loadDashboard();
      
    } catch (error) {
      errorDiv.textContent = 'Login fehlgeschlagen!';
      errorDiv.style.display = 'block';
      console.error(error);
    }
  }

  // Logout
  document.getElementById('logoutBtn').addEventListener('click', () => {
    pb.authStore.clear();
    location.reload();
  });

  // Check if already logged in
  if (pb.authStore.isValid && pb.authStore.model?.supervisor) {
    currentUser = pb.authStore.model;
    document.getElementById('loginSection').style.display = 'none';
    document.getElementById('dashboardSection').style.display = 'block';
    loadDashboard();
  }

  // Load Dashboard
  async function loadDashboard() {
    try {
      const [orgs, users, notifications] = await Promise.all([
        pb.collection('organizations').getFullList(),
        pb.collection('users').getFullList(),
        pb.collection('hub_notifications').getFullList({ sort: '-created' }).catch(() => [])
      ]);
      
      allOrgs = orgs;
      
      orgUsersCount = {};
      users.forEach(u => {
        if (u.organization_id) {
          orgUsersCount[u.organization_id] = (orgUsersCount[u.organization_id] || 0) + 1;
        }
      });
      
      document.getElementById('totalOrgs').textContent = orgs.length;
      document.getElementById('totalUsers').textContent = users.length;
      document.getElementById('activeOrgs').textContent = orgs.filter(o => o.is_active).length;
      document.getElementById('totalNotifications').textContent = notifications.length;
      
      loadOrganizations(orgs);
      loadNotifications(notifications);
      loadOrgSelector();
      
    } catch (error) {
      console.error('Fehler beim Laden:', error);
    }
  }

  // Load Organizations Table
  function loadOrganizations(orgs) {
    const tbody = document.getElementById('orgsTableBody');
    tbody.innerHTML = '';
    
    if (orgs.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px">Keine Organisationen</td></tr>';
      document.getElementById('loadingOrgs').style.display = 'none';
      document.getElementById('orgsContainer').style.display = 'block';
      return;
    }
    
    orgs.forEach(org => {
      const userCount = orgUsersCount[org.id] || 0;
      const hasUsers = userCount > 0;
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><strong>${escapeHtml(org.org_code)}</strong></td>
        <td>${escapeHtml(org.org_name)}</td>
        <td><span class="badge badge-${org.license_type}">${org.license_type}</span></td>
        <td>${org.max_users}</td>
        <td>${userCount} / ${org.max_users}</td>
        <td><span class="badge ${org.is_active ? 'badge-active' : 'badge-inactive'}">${org.is_active ? 'Aktiv' : 'Inaktiv'}</span></td>
        <td>
          <div class="table-actions">
            ${!hasUsers ? `<button class="action-btn user" onclick="showCreateUserModal('${org.id}', '${escapeHtml(org.org_name).replace(/'/g, "\\'")}')">User</button>` : ''}
            <button class="action-btn edit" onclick="editOrg('${org.id}')">Edit</button>
            <button class="action-btn delete" onclick="deleteOrg('${org.id}', '${escapeHtml(org.org_name).replace(/'/g, "\\'")}')">Del</button>
          </div>
        </td>
      `;
      tbody.appendChild(row);
    });
    
    document.getElementById('loadingOrgs').style.display = 'none';
    document.getElementById('orgsContainer').style.display = 'block';
  }

  // Load Notifications Table
  function loadNotifications(notifications) {
    const tbody = document.getElementById('notificationsTableBody');
    tbody.innerHTML = '';
    
    if (notifications.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px">Keine Meldungen</td></tr>';
      document.getElementById('loadingNotifications').style.display = 'none';
      document.getElementById('notificationsContainer').style.display = 'block';
      return;
    }
    
    notifications.forEach(notif => {
      const org = allOrgs.find(o => o.id === notif.organization_id);
      const orgName = org ? org.org_name : 'Unbekannt';
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><strong>${escapeHtml(notif.title)}</strong></td>
        <td><span class="badge badge-${notif.type}">${notif.type}</span></td>
        <td>${escapeHtml(orgName)}</td>
        <td><span class="badge ${notif.active ? 'badge-active' : 'badge-inactive'}">${notif.active ? 'Aktiv' : 'Inaktiv'}</span></td>
        <td>${new Date(notif.created).toLocaleDateString('de-DE')}</td>
        <td>
          <div class="table-actions">
            <button class="action-btn delete" onclick="deleteNotification('${notif.id}')">Del</button>
          </div>
        </td>
      `;
      tbody.appendChild(row);
    });
    
    document.getElementById('loadingNotifications').style.display = 'none';
    document.getElementById('notificationsContainer').style.display = 'block';
  }

  // Load Org Selector
  function loadOrgSelector() {
    const select = document.getElementById('notificationOrg');
    select.innerHTML = '<option value="">Bitte wählen...</option>';
    
    allOrgs.forEach(org => {
      const option = document.createElement('option');
      option.value = org.id;
      option.textContent = `${org.org_name} (${org.org_code})`;
      select.appendChild(option);
    });
  }

  // Show Create Org Modal
  function showCreateModal() {
    document.getElementById('modalTitle').textContent = 'Neue Organisation';
    document.getElementById('orgForm').reset();
    document.getElementById('orgId').value = '';
    document.getElementById('isActive').checked = true;
    document.getElementById('modalError').style.display = 'none';
    document.getElementById('modalSuccess').style.display = 'none';
    document.getElementById('orgModal').classList.add('show');
    document.body.style.overflow = 'hidden';
  }

  // Edit Org
  async function editOrg(orgId) {
    try {
      const org = await pb.collection('organizations').getOne(orgId);
      
      document.getElementById('modalTitle').textContent = 'Organisation bearbeiten';
      document.getElementById('orgId').value = org.id;
      document.getElementById('orgCode').value = org.org_code;
      document.getElementById('orgName').value = org.org_name;
      document.getElementById('licenseType').value = org.license_type;
      document.getElementById('licenseValidUntil').value = org.license_valid_until || '';
      document.getElementById('maxUsers').value = org.max_users;
      document.getElementById('contactEmail').value = org.contact_email || '';
      document.getElementById('contactPerson').value = org.contact_person || '';
      document.getElementById('contactPhone').value = org.contact_phone || '';
      document.getElementById('isActive').checked = org.is_active;
      document.getElementById('modalError').style.display = 'none';
      document.getElementById('modalSuccess').style.display = 'none';
      
      document.getElementById('orgModal').classList.add('show');
      document.body.style.overflow = 'hidden';
      
    } catch (error) {
      alert('Fehler beim Laden!');
      console.error(error);
    }
  }

  // Save Org
  async function handleSaveOrg(event) {
    event.preventDefault();
    
    const orgId = document.getElementById('orgId').value;
    const orgData = {
      org_code: document.getElementById('orgCode').value,
      org_name: document.getElementById('orgName').value,
      license_type: document.getElementById('licenseType').value,
      license_valid_until: document.getElementById('licenseValidUntil').value || null,
      max_users: parseInt(document.getElementById('maxUsers').value),
      contact_email: document.getElementById('contactEmail').value || null,
      contact_person: document.getElementById('contactPerson').value || null,
      contact_phone: document.getElementById('contactPhone').value || null,
      is_active: document.getElementById('isActive').checked
    };
    
    try {
      if (orgId) {
        await pb.collection('organizations').update(orgId, orgData);
      } else {
        await pb.collection('organizations').create(orgData);
      }
      
      document.getElementById('modalSuccess').textContent = 'Organisation gespeichert!';
      document.getElementById('modalSuccess').style.display = 'block';
      document.getElementById('modalError').style.display = 'none';
      
      setTimeout(() => {
        closeOrgModal();
        loadDashboard();
      }, 1500);
      
    } catch (error) {
      document.getElementById('modalError').textContent = 'Fehler: ' + error.message;
      document.getElementById('modalError').style.display = 'block';
      console.error(error);
    }
  }

  // Delete Org
  async function deleteOrg(orgId, orgName) {
    if (!confirm(`Organisation "${orgName}" wirklich löschen?`)) return;
    
    try {
      await pb.collection('organizations').delete(orgId);
      loadDashboard();
    } catch (error) {
      alert('Fehler beim Löschen: ' + error.message);
      console.error(error);
    }
  }

  // Close Org Modal
  function closeOrgModal() {
    document.getElementById('orgModal').classList.remove('show');
    document.body.style.overflow = '';
  }

  // Show Create User Modal
  function showCreateUserModal(orgId, orgName) {
    document.getElementById('userOrgId').value = orgId;
    document.getElementById('userOrgName').value = orgName;
    document.getElementById('userForm').reset();
    document.getElementById('userModalError').style.display = 'none';
    document.getElementById('userModalSuccess').style.display = 'none';
    document.getElementById('userModal').classList.add('show');
    document.body.style.overflow = 'hidden';
  }

  // Close User Modal
  function closeUserModal() {
    document.getElementById('userModal').classList.remove('show');
    document.body.style.overflow = '';
  }

  // Create First User
  async function handleCreateFirstUser(event) {
    event.preventDefault();
    
    const createBtn = document.getElementById('createUserBtn');
    createBtn.disabled = true;
    createBtn.textContent = 'Erstelle...';
    
    const orgId = document.getElementById('userOrgId').value;
    const email = document.getElementById('userEmail').value.trim();
    const name = document.getElementById('userName').value.trim();
    const phone = document.getElementById('userPhone').value.trim();
    
    try {
      const tempPassword = Array.from({length: 16}, () => 
        'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789!@#$%&*'[Math.floor(Math.random() * 66)]
      ).join('');
      
      const permissions = {
        dashboard: true,
        einsaetze: true,
        lager: true,
        produktausgabe: true,
        ausbildungen: true,
        ausbildungen_manage: true,
        dokumente: true,
        patienten: true,
        dateien: true,
        qr: true,
        chat: true,
        users_manage: true
      };
      
      const userData = {
        email: email,
        emailVisibility: true,
        password: tempPassword,
        passwordConfirm: tempPassword,
        name: name,
        phone: phone || '',
        role: 'mpg',
        permissions: permissions,
        organization_id: orgId,
        supervisor: false,
        verified: false
      };
      
      await pb.collection('users').create(userData);
      await pb.collection('users').requestPasswordReset(email);
      
      document.getElementById('userModalSuccess').textContent = 'Benutzer angelegt! Password-Link versendet.';
      document.getElementById('userModalSuccess').style.display = 'block';
      
      setTimeout(() => {
        closeUserModal();
        loadDashboard();
      }, 2000);
      
    } catch (error) {
      document.getElementById('userModalError').textContent = 'Fehler: ' + error.message;
      document.getElementById('userModalError').style.display = 'block';
      console.error(error);
    } finally {
      createBtn.disabled = false;
      createBtn.textContent = 'Benutzer anlegen';
    }
  }

  // Show Notification Modal
  function showNotificationModal() {
    document.getElementById('notificationModalTitle').textContent = 'Neue Info-Meldung';
    document.getElementById('notificationForm').reset();
    document.getElementById('notificationId').value = '';
    document.getElementById('notificationActive').checked = true;
    document.getElementById('notificationModalError').style.display = 'none';
    document.getElementById('notificationModalSuccess').style.display = 'none';
    document.getElementById('notificationModal').classList.add('show');
    document.body.style.overflow = 'hidden';
  }

  // Close Notification Modal
  function closeNotificationModal() {
    document.getElementById('notificationModal').classList.remove('show');
    document.body.style.overflow = '';
  }

  // Save Notification
  async function handleSaveNotification(event) {
    event.preventDefault();
    
    const notificationData = {
      organization_id: document.getElementById('notificationOrg').value,
      title: document.getElementById('notificationTitle').value,
      message: document.getElementById('notificationMessage').value,
      type: document.getElementById('notificationType').value,
      active: document.getElementById('notificationActive').checked,
      created_by: currentUser.id
    };
    
    try {
      await pb.collection('hub_notifications').create(notificationData);
      
      document.getElementById('notificationModalSuccess').textContent = 'Info-Meldung erstellt!';
      document.getElementById('notificationModalSuccess').style.display = 'block';
      
      setTimeout(() => {
        closeNotificationModal();
        loadDashboard();
      }, 1500);
      
    } catch (error) {
      document.getElementById('notificationModalError').textContent = 'Fehler: ' + error.message;
      document.getElementById('notificationModalError').style.display = 'block';
      console.error(error);
    }
  }

  // Delete Notification
  async function deleteNotification(notifId) {
    if (!confirm('Info-Meldung wirklich löschen?')) return;
    
    try {
      await pb.collection('hub_notifications').delete(notifId);
      loadDashboard();
    } catch (error) {
      alert('Fehler: ' + error.message);
      console.error(error);
    }
  }

  // Helper
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
  }

  function closeModalOnBackdrop(event, modalId) {
    if (event.target.id === modalId) {
      if (modalId === 'orgModal') closeOrgModal();
      else if (modalId === 'userModal') closeUserModal();
      else if (modalId === 'notificationModal') closeNotificationModal();
    }
  }
</script>

</body>
</html>
