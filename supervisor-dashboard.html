<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Supervisor Dashboard ‚Äì Responda</title>
  
  <!-- Theme Color -->
  <meta name="theme-color" content="#667eea">
  
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/pocketbase@0.21.3/dist/pocketbase.umd.js"></script>
  
  <style>
    :root { 
      --rot: #c8102e; 
      --gradient-start: #667eea; 
      --gradient-end: #764ba2; 
    }
    
    * { box-sizing: border-box; }
    
    body { 
      font-family: 'Atkinson Hyperlegible', Arial, sans-serif; 
      background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
      min-height: 100vh;
      margin: 0;
      opacity: 0;
      transition: opacity 0.3s;
    }
    body.loaded { opacity: 1; }
    
    /* Header */
    header { 
      background: var(--gradient-start);
      color: #fff;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      position: sticky;
      top: 0;
      z-index: 10;
      flex-wrap: wrap;
    }
    header h1 { 
      margin: 0; 
      font-size: clamp(1rem, 4vw, 1.15rem);
      font-weight: 700; 
      letter-spacing: .2px; 
    }
    .spacer { flex: 1; }
    .topbtn { 
      color: #fff;
      text-decoration: none;
      background: rgba(255,255,255,0.2);
      padding: 7px 10px;
      border-radius: 8px;
      font-weight: 700;
      transition: all 0.2s;
      border: none;
      cursor: pointer;
      font-family: inherit;
      font-size: clamp(0.85rem, 3vw, 1rem);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .topbtn:hover {
      background: rgba(255,255,255,0.3);
    }
    
    /* Greeting */
    .greeting { 
      font-family: 'Atkinson Hyperlegible', Arial, sans-serif;
      font-size: clamp(2rem, 8vw, 3rem);
      font-weight: 700;
      color: #fff;
      text-align: center;
      margin: 24px 0;
      letter-spacing: 1px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
      padding: 0 14px;
    }
    
    /* Container */
    .container { 
      max-width: 1400px;
      margin: 0 auto 16px;
      padding: 0 14px;
    }
    
    /* Cards */
    .card { 
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 3px 12px rgba(0,0,0,.06);
      padding: 20px;
      margin-bottom: 16px;
    }
    .card h2 { 
      margin: 0 0 16px; 
      color: var(--rot); 
      font-size: clamp(1.2rem, 4vw, 1.5rem);
    }
    
    /* Stats Grid */
    .stats-grid { 
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    .stat-box { 
      background: #fff;
      border: 2px solid #f2c9d1;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
    }
    .stat-num { 
      font-size: clamp(2rem, 8vw, 2.5rem);
      font-weight: 700; 
      color: var(--rot); 
    }
    .stat-label { 
      font-size: clamp(0.85rem, 3vw, 0.95rem);
      color: #555; 
      margin-top: 4px; 
    }
    
    /* Table */
    .table-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }
    th {
      background: #f8f9fa;
      padding: 12px;
      text-align: left;
      font-weight: 700;
      color: var(--rot);
      border-bottom: 2px solid #dee2e6;
      font-size: clamp(0.85rem, 2.5vw, 0.95rem);
    }
    td {
      padding: 12px;
      border-bottom: 1px solid #dee2e6;
      font-size: clamp(0.85rem, 2.5vw, 0.95rem);
    }
    tr:hover {
      background: #f8f9fa;
    }
    
    /* Badges */
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: clamp(0.7rem, 2vw, 0.85rem);
      font-weight: 700;
      white-space: nowrap;
    }
    .badge-active {
      background: #dcfce7;
      color: #16a34a;
    }
    .badge-inactive {
      background: #fee2e2;
      color: var(--rot);
    }
    .badge-trial {
      background: #fef3c7;
      color: #d97706;
    }
    .badge-basic {
      background: #dbeafe;
      color: #1e40af;
    }
    .badge-professional {
      background: #e2d9f3;
      color: #4a148c;
    }
    .badge-enterprise {
      background: #fee2e2;
      color: var(--rot);
    }
    
    /* Buttons */
    .btn { 
      background: var(--rot);
      color: #fff;
      border: 0;
      border-radius: 8px;
      padding: 10px 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
      font-size: clamp(0.9rem, 3vw, 1rem);
      width: 100%;
    }
    .btn:hover {
      background: #a00d26;
    }
    .btn.sec { 
      background: #eee; 
      color: var(--rot); 
      border: 1px solid var(--rot); 
    }
    .btn.success {
      background: #16a34a;
    }
    .btn.success:hover {
      background: #15803d;
    }
    
    .action-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: clamp(0.8rem, 2.5vw, 0.9rem);
      transition: all 0.2s;
      font-family: inherit;
      min-width: 44px;
      min-height: 44px;
    }
    .action-btn.edit {
      background: #dbeafe;
      color: #1e40af;
    }
    .action-btn.edit:hover {
      background: #bfdbfe;
    }
    .action-btn.delete {
      background: #fee2e2;
      color: var(--rot);
    }
    .action-btn.delete:hover {
      background: #fecaca;
    }
    
    /* Forms */
    .field { 
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin: 12px 0;
    }
    .field label { 
      font-weight: 700; 
      color: var(--rot); 
      font-size: clamp(0.9rem, 3vw, 1rem);
    }
    input, textarea, select { 
      font-family: inherit; 
      font-size: 16px;
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #fafafa;
    }
    
    /* Modal */
    .modal { 
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 16px;
      overflow-y: auto;
    }
    .modal.show { display: flex; }
    .modal-box { 
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 6px 24px rgba(0,0,0,.2);
      padding: 20px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-h { 
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid #eee;
    }
    .modal-h h3 {
      margin: 0;
      color: var(--rot);
      font-size: clamp(1.2rem, 4vw, 1.4rem);
    }
    .x { 
      margin-left: auto;
      border: 0;
      background: #f1f1f1;
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      font-weight: 700;
      min-width: 40px;
      min-height: 40px;
      font-size: 24px;
    }
    .x:hover {
      background: #e2e2e2;
    }
    
    .actions { 
      display: flex;
      gap: 8px;
      flex-direction: column;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 2px solid #eee;
    }
    
    /* Messages */
    .msg { 
      min-height: 1.2em; 
      margin-top: 8px; 
      font-size: clamp(0.9rem, 3vw, 1rem);
    }
    .ok { color: #16a34a; }
    .err { color: var(--rot); }
    
    .loading {
      text-align: center;
      padding: 40px 20px;
      color: #666;
      font-size: clamp(0.9rem, 3vw, 1rem);
    }
    
    .table-actions {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }
    
    @media (min-width: 640px) {
      .actions {
        flex-direction: row;
        justify-content: flex-end;
      }
      .btn {
        width: auto;
      }
    }
    
    @media (min-width: 768px) {
      .card {
        padding: 30px;
      }
      .modal-box {
        padding: 30px;
      }
    }
  </style>
</head>
<body>

<header>
  <h1>üëë Supervisor Dashboard</h1>
  <div class="spacer"></div>
  <span id="welcomeText" style="font-size:0.9rem"></span>
  <button class="topbtn" id="logoutBtn">Abmelden</button>
</header>

<div class="greeting">Servus, Supervisor!</div>

<div class="container">
  <!-- Statistics -->
  <div class="stats-grid">
    <div class="stat-box">
      <div class="stat-num" id="totalOrgs">0</div>
      <div class="stat-label">Organisationen</div>
    </div>
    <div class="stat-box">
      <div class="stat-num" id="totalUsers">0</div>
      <div class="stat-label">Benutzer</div>
    </div>
    <div class="stat-box">
      <div class="stat-num" id="activeOrgs">0</div>
      <div class="stat-label">Aktive Orgas</div>
    </div>
  </div>

  <!-- Organizations -->
  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px; margin-bottom:16px">
      <h2 style="margin:0">üìã Alle Organisationen</h2>
      <button class="btn success" onclick="showCreateModal()" style="width:auto">+ Neue Organisation</button>
    </div>
    
    <div id="loadingOrgs" class="loading">Lade Organisationen...</div>
    <div id="orgsContainer" style="display:none;">
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Code</th>
              <th>Name</th>
              <th>Lizenz</th>
              <th>Max Users</th>
              <th>Status</th>
              <th>Kontakt</th>
              <th>Aktionen</th>
            </tr>
          </thead>
          <tbody id="orgsTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Create/Edit Modal -->
<div id="orgModal" class="modal" onclick="closeModalOnBackdrop(event)">
  <div class="modal-box" onclick="event.stopPropagation()">
    <div class="modal-h">
      <h3 id="modalTitle">Neue Organisation</h3>
      <button class="x" onclick="closeModal()">&times;</button>
    </div>
    
    <div id="modalError" class="msg err" style="display:none;"></div>
    <div id="modalSuccess" class="msg ok" style="display:none;"></div>
    
    <form id="orgForm" onsubmit="handleSaveOrg(event)">
      <input type="hidden" id="orgId">
      
      <div class="field">
        <label for="orgCode">Organisations-Code *</label>
        <input type="text" id="orgCode" pattern="[a-z0-9]+" required 
               placeholder="z.B. ffwmuenchen">
      </div>
      
      <div class="field">
        <label for="orgName">Name *</label>
        <input type="text" id="orgName" required placeholder="z.B. FFW M√ºnchen">
      </div>
      
      <div class="field">
        <label for="licenseType">Lizenz-Typ *</label>
        <select id="licenseType" required>
          <option value="trial">Trial</option>
          <option value="basic">Basic</option>
          <option value="professional">Professional</option>
          <option value="enterprise">Enterprise</option>
        </select>
      </div>
      
      <div class="field">
        <label for="licenseValidUntil">Lizenz g√ºltig bis</label>
        <input type="date" id="licenseValidUntil">
      </div>
      
      <div class="field">
        <label for="maxUsers">Max. Benutzer *</label>
        <input type="number" id="maxUsers" value="10" min="1" required>
      </div>
      
      <div class="field">
        <label for="contactEmail">Kontakt E-Mail</label>
        <input type="email" id="contactEmail" placeholder="admin@organisation.de">
      </div>
      
      <div class="field">
        <label for="contactPerson">Kontaktperson</label>
        <input type="text" id="contactPerson" placeholder="Max Mustermann">
      </div>
      
      <div class="field">
        <label for="contactPhone">Telefon</label>
        <input type="text" id="contactPhone" placeholder="0123456789">
      </div>
      
      <div class="field">
        <label>
          <input type="checkbox" id="isActive" checked> Aktiv
        </label>
      </div>
      
      <div class="actions">
        <button type="button" onclick="closeModal()" class="btn sec">Abbrechen</button>
        <button type="submit" class="btn success">Speichern</button>
      </div>
    </form>
  </div>
</div>

<script>
  const pb = new PocketBase('https://api.responda.systems');
  let currentUser = null;

  // Auth Check & Init
  async function init() {
    try {
      if (!pb.authStore.isValid) {
        // Redirect to login if not authenticated
        window.location.href = 'supervisor-login.html';
        return;
      }
      
      // Refresh auth
      const authData = await pb.collection('users').authRefresh();
      
      if (!authData.record.supervisor) {
        alert('Zugriff verweigert! Nur f√ºr Supervisors.');
        pb.authStore.clear();
        window.location.href = 'supervisor-login.html';
        return;
      }
      
      currentUser = authData.record;
      document.getElementById('welcomeText').textContent = currentUser.name;
      
      // Show body
      document.body.classList.add('loaded');
      
      // Load dashboard
      await loadDashboard();
      
    } catch (error) {
      console.error('Auth error:', error);
      window.location.href = 'supervisor-login.html';
    }
  }

  // Logout
  document.getElementById('logoutBtn').addEventListener('click', () => {
    pb.authStore.clear();
    window.location.href = 'supervisor-login.html';
  });

  // Load Dashboard Data
  async function loadDashboard() {
    try {
      const [orgs, users] = await Promise.all([
        pb.collection('organizations').getFullList(),
        pb.collection('users').getFullList()
      ]);
      
      // Update Stats
      document.getElementById('totalOrgs').textContent = orgs.length;
      document.getElementById('totalUsers').textContent = users.length;
      document.getElementById('activeOrgs').textContent = orgs.filter(o => o.is_active).length;
      
      // Load Organizations Table
      loadOrganizations(orgs);
      
    } catch (error) {
      console.error('Fehler beim Laden:', error);
    }
  }

  // Load Organizations Table
  function loadOrganizations(orgs) {
    const tbody = document.getElementById('orgsTableBody');
    tbody.innerHTML = '';
    
    if (orgs.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Keine Organisationen vorhanden</td></tr>';
      document.getElementById('loadingOrgs').style.display = 'none';
      document.getElementById('orgsContainer').style.display = 'block';
      return;
    }
    
    orgs.forEach(org => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><strong>${org.org_code}</strong></td>
        <td>${org.org_name}</td>
        <td><span class="badge badge-${org.license_type}">${org.license_type}</span></td>
        <td>${org.max_users}</td>
        <td><span class="badge ${org.is_active ? 'badge-active' : 'badge-inactive'}">${org.is_active ? 'Aktiv' : 'Inaktiv'}</span></td>
        <td>${org.contact_email || '-'}</td>
        <td>
          <div class="table-actions">
            <button class="action-btn edit" onclick="editOrg('${org.id}')">‚úèÔ∏è</button>
            <button class="action-btn delete" onclick="deleteOrg('${org.id}', '${org.org_name}')">üóëÔ∏è</button>
          </div>
        </td>
      `;
      tbody.appendChild(row);
    });
    
    document.getElementById('loadingOrgs').style.display = 'none';
    document.getElementById('orgsContainer').style.display = 'block';
  }

  // Show Create Modal
  function showCreateModal() {
    document.getElementById('modalTitle').textContent = 'Neue Organisation';
    document.getElementById('orgForm').reset();
    document.getElementById('orgId').value = '';
    document.getElementById('isActive').checked = true;
    document.getElementById('modalError').style.display = 'none';
    document.getElementById('modalSuccess').style.display = 'none';
    document.getElementById('orgModal').classList.add('show');
    document.body.style.overflow = 'hidden';
  }

  // Edit Organization
  async function editOrg(orgId) {
    try {
      const org = await pb.collection('organizations').getOne(orgId);
      
      document.getElementById('modalTitle').textContent = 'Organisation bearbeiten';
      document.getElementById('orgId').value = org.id;
      document.getElementById('orgCode').value = org.org_code;
      document.getElementById('orgName').value = org.org_name;
      document.getElementById('licenseType').value = org.license_type;
      document.getElementById('licenseValidUntil').value = org.license_valid_until || '';
      document.getElementById('maxUsers').value = org.max_users;
      document.getElementById('contactEmail').value = org.contact_email || '';
      document.getElementById('contactPerson').value = org.contact_person || '';
      document.getElementById('contactPhone').value = org.contact_phone || '';
      document.getElementById('isActive').checked = org.is_active;
      document.getElementById('modalError').style.display = 'none';
      document.getElementById('modalSuccess').style.display = 'none';
      
      document.getElementById('orgModal').classList.add('show');
      document.body.style.overflow = 'hidden';
      
    } catch (error) {
      alert('Fehler beim Laden der Organisation!');
      console.error(error);
    }
  }

  // Save Organization
  async function handleSaveOrg(event) {
    event.preventDefault();
    
    const orgId = document.getElementById('orgId').value;
    const orgData = {
      org_code: document.getElementById('orgCode').value,
      org_name: document.getElementById('orgName').value,
      license_type: document.getElementById('licenseType').value,
      license_valid_until: document.getElementById('licenseValidUntil').value || null,
      max_users: parseInt(document.getElementById('maxUsers').value),
      contact_email: document.getElementById('contactEmail').value || null,
      contact_person: document.getElementById('contactPerson').value || null,
      contact_phone: document.getElementById('contactPhone').value || null,
      is_active: document.getElementById('isActive').checked
    };
    
    try {
      if (orgId) {
        await pb.collection('organizations').update(orgId, orgData);
      } else {
        await pb.collection('organizations').create(orgData);
      }
      
      document.getElementById('modalSuccess').textContent = '‚úÖ Organisation erfolgreich gespeichert!';
      document.getElementById('modalSuccess').style.display = 'block';
      document.getElementById('modalError').style.display = 'none';
      
      setTimeout(() => {
        closeModal();
        loadDashboard();
      }, 1500);
      
    } catch (error) {
      document.getElementById('modalError').textContent = '‚ùå Fehler: ' + error.message;
      document.getElementById('modalError').style.display = 'block';
      document.getElementById('modalSuccess').style.display = 'none';
      console.error(error);
    }
  }

  // Delete Organization
  async function deleteOrg(orgId, orgName) {
    if (!confirm(`Organisation "${orgName}" wirklich l√∂schen?\n\nACHTUNG: Alle zugeh√∂rigen Daten werden gel√∂scht!`)) {
      return;
    }
    
    try {
      await pb.collection('organizations').delete(orgId);
      alert('‚úÖ Organisation gel√∂scht!');
      loadDashboard();
    } catch (error) {
      alert('‚ùå Fehler beim L√∂schen: ' + error.message);
      console.error(error);
    }
  }

  // Close Modal
  function closeModal() {
    document.getElementById('orgModal').classList.remove('show');
    document.body.style.overflow = '';
    document.getElementById('modalError').style.display = 'none';
    document.getElementById('modalSuccess').style.display = 'none';
  }

  // Close modal when clicking backdrop
  function closeModalOnBackdrop(event) {
    if (event.target.id === 'orgModal') {
      closeModal();
    }
  }

  // Initialize
  init();
</script>

</body>
</html>
