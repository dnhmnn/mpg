<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ausbildungsmanagement</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pocketbase@0.21.1/dist/pocketbase.umd.js"></script>
  
<style>
:root {
  --primary: #7c3aed;
  --primary-dark: #6d28d9;
  --secondary: #ec4899;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --text: #1f2937;
  --muted: #6b7280;
  --border: #e5e7eb;
  --bg: #f9fafb;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  opacity: 0;
  transition: opacity 0.3s;
}

body.loaded { opacity: 1; }

.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 2rem;
}

header {
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(10px);
  border-radius: 1rem;
  padding: 1.5rem 2rem;
  margin-bottom: 2rem;
  box-shadow: 0 8px 32px rgba(0,0,0,0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.logo {
  font-size: 1.75rem;
  font-weight: 800;
  background: linear-gradient(135deg, var(--primary), var(--secondary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 1rem;
  color: var(--text);
  font-weight: 600;
}

.tabs {
  display: flex;
  gap: 0.5rem;
  background: rgba(255,255,255,0.95);
  padding: 0.5rem;
  border-radius: 1rem;
  margin-bottom: 2rem;
  box-shadow: 0 4px 16px rgba(0,0,0,0.1);
}

.tab {
  flex: 1;
  padding: 1rem 1.5rem;
  border: none;
  background: transparent;
  color: var(--muted);
  font-weight: 600;
  cursor: pointer;
  border-radius: 0.75rem;
  transition: all 0.2s;
  font-size: 1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

.tab:hover { background: rgba(124,58,237,0.1); color: var(--primary); }
.tab.active { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; box-shadow: 0 4px 12px rgba(124,58,237,0.3); }

.tab-content { display: none; }
.tab-content.active { display: block; }

.action-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
  gap: 1rem;
  flex-wrap: wrap;
}

.btn {
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 0.75rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.95rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

.btn.primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; }
.btn.success { background: var(--success); color: white; }
.btn.danger { background: var(--danger); color: white; }
.btn.warning { background: var(--warning); color: white; }
.btn.secondary { background: white; color: var(--text); border: 2px solid var(--border); }

.btn.btn-sm {
  padding: 0.5rem 1rem;
  font-size: 0.85rem;
}

.search-box {
  position: relative;
  flex: 1;
  max-width: 400px;
}

.search-box input {
  width: 100%;
  padding: 0.75rem 1rem 0.75rem 2.75rem;
  border: 2px solid var(--border);
  border-radius: 0.75rem;
  font-size: 0.95rem;
  transition: all 0.2s;
}

.search-box input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(124,58,237,0.1);
}

.search-box i {
  position: absolute;
  left: 1rem;
  top: 50%;
  transform: translateY(-50%);
  color: var(--muted);
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
  gap: 1.5rem;
}

.course-card, .module-card {
  background: white;
  border-radius: 1rem;
  padding: 1.5rem;
  box-shadow: 0 4px 16px rgba(0,0,0,0.08);
  transition: all 0.3s;
  cursor: pointer;
}

.course-card:hover, .module-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 24px rgba(0,0,0,0.12);
}

.card-title {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 0.75rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.card-meta {
  display: flex;
  gap: 1rem;
  font-size: 0.9rem;
  color: var(--muted);
  flex-wrap: wrap;
}

.card-meta span {
  display: flex;
  align-items: center;
  gap: 0.35rem;
}

.badge {
  display: inline-block;
  padding: 0.35rem 0.75rem;
  border-radius: 0.5rem;
  font-size: 0.8rem;
  font-weight: 700;
  text-transform: uppercase;
}

.badge.Pflicht { background: #fee2e2; color: #991b1b; }
.badge.Wahlfrei { background: #dbeafe; color: #1e40af; }
.badge.Auffrischung { background: #fef3c7; color: #92400e; }
.badge.text { background: #dbeafe; color: #1e40af; }
.badge.image { background: #dcfce7; color: #166534; }
.badge.video { background: #fef3c7; color: #92400e; }
.badge.quiz { background: #fee2e2; color: #991b1b; }

.empty {
  text-align: center;
  padding: 4rem 2rem;
  color: var(--muted);
  background: white;
  border-radius: 1rem;
}

.empty i { font-size: 4rem; margin-bottom: 1rem; opacity: 0.3; }

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(4px);
  z-index: 1000;
  overflow-y: auto;
  padding: 2rem;
}

.modal.show { display: flex; align-items: center; justify-content: center; }

.modal-content {
  background: white;
  border-radius: 1rem;
  padding: 2rem;
  max-width: 800px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 2px solid var(--border);
}

.modal-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.close-btn {
  background: none;
  border: none;
  font-size: 1.5rem;
  color: var(--muted);
  cursor: pointer;
  width: 2rem;
  height: 2rem;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 0.5rem;
  transition: all 0.2s;
}

.close-btn:hover { background: var(--bg); color: var(--danger); }

.form-group {
  margin-bottom: 1.5rem;
}

.form-group label {
  display: block;
  font-weight: 600;
  margin-bottom: 0.5rem;
  color: var(--text);
}

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 0.75rem;
  border: 2px solid var(--border);
  border-radius: 0.5rem;
  font-size: 0.95rem;
  font-family: inherit;
  transition: all 0.2s;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(124,58,237,0.1);
}

.form-group textarea {
  min-height: 100px;
  resize: vertical;
}

.checkbox-group {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-top: 1rem;
}

.checkbox-group input[type="checkbox"] {
  width: 20px;
  height: 20px;
  cursor: pointer;
}

.form-actions {
  display: flex;
  gap: 1rem;
  justify-content: flex-end;
  margin-top: 2rem;
  padding-top: 1.5rem;
  border-top: 2px solid var(--border);
}

.table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  border-radius: 0.75rem;
  overflow: hidden;
}

.table thead {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
}

.table th,
.table td {
  padding: 1rem;
  text-align: left;
}

.table tbody tr {
  border-bottom: 1px solid var(--border);
  transition: background 0.2s;
}

.table tbody tr:hover {
  background: var(--bg);
}

.status-icon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 1.5rem;
  height: 1.5rem;
  border-radius: 50%;
  font-weight: 700;
  font-size: 0.85rem;
}

.status-icon.completed { background: var(--success); color: white; }
.status-icon.enrolled { background: var(--warning); color: white; }
.status-icon.cancelled { background: var(--danger); color: white; }
.status-icon.progress { background: var(--warning); color: white; }
.status-icon.pending { background: var(--muted); color: white; }

.details-section {
  background: var(--bg);
  padding: 1.5rem;
  border-radius: 0.75rem;
  margin-bottom: 1.5rem;
}

.details-section h4 {
  color: var(--text);
  margin-bottom: 1rem;
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.progress-bar {
  width: 100%;
  height: 8px;
  background: var(--border);
  border-radius: 4px;
  overflow: hidden;
}

.progress-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--success), #34d399);
  transition: width 0.3s;
}

.qr-code-container {
  text-align: center;
  padding: 2rem;
  background: white;
  border-radius: 0.75rem;
  box-shadow: 0 4px 16px rgba(0,0,0,0.1);
}

.qr-code-container canvas {
  margin: 1rem auto;
}

.slide-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  background: white;
  border: 2px solid var(--border);
  border-radius: 0.75rem;
  margin-bottom: 0.75rem;
  transition: all 0.2s;
}

.slide-item:hover {
  border-color: var(--primary);
  box-shadow: 0 4px 12px rgba(124,58,237,0.1);
}

.slide-type-icon {
  width: 3rem;
  height: 3rem;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 0.75rem;
  font-size: 1.5rem;
  flex-shrink: 0;
}

.msg {
  position: fixed;
  top: 2rem;
  right: 2rem;
  padding: 1rem 1.5rem;
  background: white;
  border-radius: 0.75rem;
  box-shadow: 0 8px 24px rgba(0,0,0,0.15);
  z-index: 10000;
  animation: slideIn 0.3s ease-out;
  display: flex;
  align-items: center;
  gap: 0.75rem;
  font-weight: 600;
}

@keyframes slideIn {
  from { opacity: 0; transform: translateX(100%); }
  to { opacity: 1; transform: translateX(0); }
}

.msg.success { border-left: 4px solid var(--success); color: var(--success); }
.msg.error { border-left: 4px solid var(--danger); color: var(--danger); }
.msg.info { border-left: 4px solid var(--primary); color: var(--primary); }

@media (max-width: 768px) {
  .container { padding: 1rem; }
  header { flex-direction: column; gap: 1rem; }
  .tabs { flex-direction: column; }
  .grid { grid-template-columns: 1fr; }
  .action-bar { flex-direction: column; align-items: stretch; }
  .search-box { max-width: 100%; }
}
</style>
</head>
<body>

<div class="container">
  <header>
    <div class="logo">
      <i class="fas fa-graduation-cap"></i>
      Ausbildungsmanagement
    </div>
    <div class="user-info">
      <span id="username"></span>
      <button class="btn btn-sm danger" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </header>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('schulungen')">
      <i class="fas fa-book-medical"></i> Schulungen
    </button>
    <button class="tab" onclick="switchTab('team')">
      <i class="fas fa-users"></i> Team
    </button>
    <button class="tab" onclick="switchTab('zugaenge')">
      <i class="fas fa-key"></i> Zug√§nge
    </button>
    <button class="tab" onclick="switchTab('lernbereich')">
      <i class="fas fa-laptop"></i> Lernbereich
    </button>
  </div>

  <!-- SCHULUNGEN TAB -->
  <div id="schulungen-tab" class="tab-content active">
    <div class="action-bar">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" placeholder="Schulungen durchsuchen..." id="search-schulungen">
      </div>
      <button class="btn primary" onclick="openSchulungModal()">
        <i class="fas fa-plus"></i> Neue Schulung
      </button>
    </div>
    <div class="grid" id="schulungen-list"></div>
  </div>

  <!-- TEAM TAB -->
  <div id="team-tab" class="tab-content">
    <div class="action-bar">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" placeholder="Team durchsuchen..." id="search-team">
      </div>
      <button class="btn primary" onclick="openMemberModal()">
        <i class="fas fa-user-plus"></i> Neues Mitglied
      </button>
    </div>
    <div class="grid" id="team-list"></div>
  </div>

  <!-- ZUG√ÑNGE TAB -->
  <div id="zugaenge-tab" class="tab-content">
    <div class="action-bar">
      <button class="btn success" onclick="exportAllAccessPDF()">
        <i class="fas fa-file-pdf"></i> Alle als PDF exportieren
      </button>
    </div>
    <div class="grid" id="zugaenge-list"></div>
  </div>

  <!-- LERNBEREICH TAB -->
  <div id="lernbereich-tab" class="tab-content">
    <div class="action-bar">
      <button class="btn primary" onclick="openModuleModal()">
        <i class="fas fa-plus"></i> Neues Lernmodul
      </button>
    </div>
    <div class="grid" id="lernbereich-list"></div>
  </div>
</div>
<!-- SCHULUNG ERSTELLEN/BEARBEITEN MODAL -->
<div id="schulungModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="schulungModalTitle">
        <i class="fas fa-book-medical"></i> Neue Schulung
      </h2>
      <button class="close-btn" onclick="closeSchulungModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <form id="schulungForm">
      <div class="form-group">
        <label>Titel *</label>
        <input type="text" name="title" required>
      </div>
      
      <div class="form-group">
        <label>Typ *</label>
        <select name="type" required>
          <option value="Pflicht">Pflicht</option>
          <option value="Wahlfrei">Wahlfrei</option>
          <option value="Auffrischung">Auffrischung</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Dozent</label>
        <input type="text" name="instructor" placeholder="z.B. Dr. Max Mustermann">
      </div>
      
      <div class="form-group">
        <label>Beschreibung</label>
        <textarea name="description" placeholder="Kurze Beschreibung der Schulung"></textarea>
      </div>
      
      <div class="form-group">
        <label>Dauer (Stunden)</label>
        <input type="number" name="duration" min="1" placeholder="z.B. 8">
      </div>
      
      <div class="form-group">
        <label>Standardort</label>
        <input type="text" name="location" placeholder="z.B. Ausbildungszentrum Berlin">
      </div>
      
      <div class="form-group">
        <label>Zertifikatsg√ºltigkeit (Monate)</label>
        <input type="number" name="certificate_validity" min="1" placeholder="z.B. 24">
      </div>
      
      <div class="form-actions">
        <button type="button" class="btn secondary" onclick="closeSchulungModal()">
          Abbrechen
        </button>
        <button type="submit" class="btn primary">
          <i class="fas fa-save"></i> Speichern
        </button>
      </div>
    </form>
  </div>
</div>

<!-- SCHULUNG DETAILS MODAL -->
<div id="schulungDetailsModal" class="modal">
  <div class="modal-content" style="max-width: 1000px;">
    <div class="modal-header">
      <h2 class="modal-title" id="schulungDetailsTitle"></h2>
      <button class="close-btn" onclick="closeSchulungDetailsModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div id="schulungDetailsBody"></div>
  </div>
</div>

<!-- TERMIN ERSTELLEN MODAL -->
<div id="terminModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">
        <i class="fas fa-calendar-plus"></i> Neuer Termin
      </h2>
      <button class="close-btn" onclick="closeTerminModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <form id="terminForm">
      <div class="form-group">
        <label>Datum & Uhrzeit *</label>
        <input type="datetime-local" name="date" required>
      </div>
      
      <div class="form-group">
        <label>Ort</label>
        <input type="text" name="location" placeholder="√úberschreibt Standardort falls angegeben">
      </div>
      
      <div class="form-actions">
        <button type="button" class="btn secondary" onclick="closeTerminModal()">
          Abbrechen
        </button>
        <button type="submit" class="btn primary">
          <i class="fas fa-save"></i> Termin erstellen
        </button>
      </div>
    </form>
  </div>
</div>

<!-- TEAM MITGLIED MODAL -->
<div id="memberModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="memberModalTitle">
        <i class="fas fa-user-plus"></i> Neues Mitglied
      </h2>
      <button class="close-btn" onclick="closeMemberModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <form id="memberForm">
      <div class="form-group">
        <label>Vorname *</label>
        <input type="text" name="vorname" required>
      </div>
      
      <div class="form-group">
        <label>Nachname *</label>
        <input type="text" name="name" required>
      </div>
      
      <div class="form-group">
        <label>E-Mail</label>
        <input type="email" name="email">
      </div>
      
      <div class="form-group">
        <label>Telefon</label>
        <input type="tel" name="telefon">
      </div>
      
      <div class="form-group">
        <label>Rolle</label>
        <input type="text" name="rolle" placeholder="z.B. Rettungssanit√§ter">
      </div>
      
      <div class="checkbox-group">
        <input type="checkbox" id="member-aktiv" name="aktiv" checked>
        <label for="member-aktiv">Aktiv</label>
      </div>
      
      <div class="form-actions">
        <button type="button" class="btn secondary" onclick="closeMemberModal()">
          Abbrechen
        </button>
        <button type="submit" class="btn primary">
          <i class="fas fa-save"></i> Speichern
        </button>
      </div>
    </form>
  </div>
</div>

<!-- MITGLIED DETAILS MODAL -->
<div id="memberDetailsModal" class="modal">
  <div class="modal-content" style="max-width: 1000px;">
    <div class="modal-header">
      <h2 class="modal-title" id="memberDetailsTitle"></h2>
      <button class="close-btn" onclick="closeMemberDetailsModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div id="memberDetailsBody"></div>
  </div>
</div>

<!-- TEILNEHMER ZUWEISEN MODAL -->
<div id="assignSessionModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">
        <i class="fas fa-users"></i> Teilnehmer zu Termin zuweisen
      </h2>
      <button class="close-btn" onclick="closeAssignSessionModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div style="margin-bottom: 1rem;">
      <input type="text" id="assignSearchInput" placeholder="Mitglied suchen..." 
        style="width:100%;padding:0.75rem;border:2px solid var(--border);border-radius:0.5rem"
        oninput="filterAssignList()">
    </div>
    <div id="assignMembersList" style="max-height: 400px; overflow-y: auto; border: 2px solid var(--border); border-radius: 0.75rem;"></div>
    <div class="form-actions">
      <button class="btn secondary" onclick="closeAssignSessionModal()">Abbrechen</button>
      <button class="btn primary" onclick="saveSessionAssignments()">
        <i class="fas fa-save"></i> Speichern
      </button>
    </div>
  </div>
</div>

<!-- ZUGANG DETAILS MODAL -->
<div id="accessModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="accessModalTitle"></h2>
      <button class="close-btn" onclick="closeAccessModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div id="accessModalBody"></div>
  </div>
</div>

<!-- LERNMODUL MODAL -->
<div id="moduleModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="moduleModalTitle">
        <i class="fas fa-laptop"></i> Neues Lernmodul
      </h2>
      <button class="close-btn" onclick="closeModuleModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <form id="moduleForm">
      <div class="form-group">
        <label>Titel *</label>
        <input type="text" name="title" required>
      </div>
      
      <div class="form-group">
        <label>Dozent</label>
        <input type="text" name="instructor" placeholder="z.B. Dr. Max Mustermann">
      </div>
      
      <div class="form-group">
        <label>Beschreibung</label>
        <textarea name="description"></textarea>
      </div>
      
      <div class="form-group">
        <label>Bestehensgrenze (%)</label>
        <input type="number" name="passing_score" min="0" max="100" value="80">
      </div>
      
      <div class="form-group">
        <label>Max. Versuche (0 = unbegrenzt)</label>
        <input type="number" name="max_attempts" min="0" value="3">
      </div>
      
      <div class="checkbox-group">
        <input type="checkbox" id="require-quiz" name="require_quiz">
        <label for="require-quiz">Pr√ºfung erforderlich</label>
      </div>
      
      <div class="form-actions">
        <button type="button" class="btn secondary" onclick="closeModuleModal()">
          Abbrechen
        </button>
        <button type="submit" class="btn primary">
          <i class="fas fa-save"></i> Speichern
        </button>
      </div>
    </form>
  </div>
</div>

<!-- MODUL DETAILS MODAL -->
<div id="moduleDetailsModal" class="modal">
  <div class="modal-content" style="max-width: 1000px;">
    <div class="modal-header">
      <h2 class="modal-title" id="moduleDetailsTitle"></h2>
      <button class="close-btn" onclick="closeModuleDetailsModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div id="moduleDetailsBody"></div>
  </div>
</div>

<!-- PERSONEN ZUWEISEN MODAL -->
<div id="assignMembersModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">
        <i class="fas fa-users"></i> Personen zuweisen
      </h2>
      <button class="close-btn" onclick="closeAssignMembersModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div id="assignMembersList" style="max-height: 400px; overflow-y: auto; border: 2px solid var(--border); border-radius: 0.75rem;"></div>
    <div class="form-actions">
      <button class="btn secondary" onclick="closeAssignMembersModal()">Abbrechen</button>
      <button class="btn primary" onclick="saveAssignments()">
        <i class="fas fa-save"></i> Speichern
      </button>
    </div>
  </div>
</div>
<!-- FOLIEN-EDITOR MODAL -->
<div id="slideEditorModal" class="modal">
  <div class="modal-content" style="max-width: 1200px;">
    <div class="modal-header">
      <h2 class="modal-title" id="slideEditorTitle">
        <i class="fas fa-edit"></i> Folien bearbeiten
      </h2>
      <button class="close-btn" onclick="closeSlideEditor()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div style="margin-bottom: 1.5rem;">
      <button class="btn primary" onclick="openNewSlideModal()">
        <i class="fas fa-plus"></i> Neue Folie
      </button>
    </div>
    
    <div id="slides-list"></div>
  </div>
</div>

<!-- NEUE FOLIE MODAL -->
<div id="newSlideModal" class="modal">
  <div class="modal-content" style="max-width: 900px;">
    <div class="modal-header">
      <h2 class="modal-title">
        <i class="fas fa-plus"></i> Folie erstellen/bearbeiten
      </h2>
      <button class="close-btn" onclick="closeNewSlideModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <form id="newSlideForm" onsubmit="event.preventDefault(); saveSlide();">
      <div class="form-group">
        <label>Folien-Typ *</label>
        <select id="slide-type" onchange="updateSlideTypeFields()" required>
          <option value="text">Text-Folie</option>
          <option value="image">Bild-Folie</option>
          <option value="video">Video-Folie</option>
          <option value="quiz">Quiz-Folie</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Titel *</label>
        <input type="text" id="slide-title" required>
      </div>
      
      <div class="form-group">
        <label>Dauer (Minuten)</label>
        <input type="number" id="slide-duration" min="1" value="5">
      </div>
      
      <!-- TEXT FOLIE -->
      <div id="text-slide-fields" style="display:none;">
        <div class="form-group">
          <label>Inhalt</label>
          <div id="slide-content-editor" style="background:white;border:2px solid var(--border);border-radius:0.5rem;min-height:200px;"></div>
        </div>
      </div>
      
      <!-- BILD FOLIE -->
      <div id="image-slide-fields" style="display:none;">
        <div class="form-group">
          <label>Bild-URL *</label>
          <input type="url" id="slide-image-url" placeholder="https://example.com/image.jpg">
        </div>
        <div class="form-group">
          <label>Beschreibung</label>
          <textarea id="slide-image-description" rows="3"></textarea>
        </div>
      </div>
      
      <!-- VIDEO FOLIE -->
      <div id="video-slide-fields" style="display:none;">
        <div class="form-group">
          <label>YouTube-URL *</label>
          <input type="url" id="slide-video-url" placeholder="https://youtube.com/watch?v=...">
        </div>
        <div class="form-group">
          <label>Beschreibung</label>
          <textarea id="slide-video-description" rows="3"></textarea>
        </div>
      </div>
      
      <!-- QUIZ FOLIE -->
      <div id="quiz-slide-fields" style="display:none;">
        <div class="form-group">
          <label>Frage *</label>
          <textarea id="slide-quiz-question" rows="3"></textarea>
        </div>
        
        <div class="form-group">
          <label>Antworten</label>
          <div id="quiz-answers-list"></div>
          <button type="button" class="btn btn-sm primary" onclick="addQuizAnswer()" style="margin-top:8px">
            <i class="fas fa-plus"></i> Antwort hinzuf√ºgen
          </button>
        </div>
        
        <div class="form-group">
          <label>Erkl√§rung (optional)</label>
          <textarea id="slide-quiz-explanation" rows="2" placeholder="Wird nach Beantwortung angezeigt"></textarea>
        </div>
      </div>
      
      <div class="form-actions">
        <button type="button" class="btn secondary" onclick="closeNewSlideModal()">
          Abbrechen
        </button>
        <button type="submit" class="btn primary">
          <i class="fas fa-save"></i> Folie speichern
        </button>
      </div>
    </form>
  </div>
</div>

<!-- MODUL VORSCHAU MODAL -->
<div id="modulePreviewModal" class="modal">
  <div class="modal-content" style="max-width: 1200px;">
    <div class="modal-header">
      <h2 class="modal-title" id="previewModuleTitle">
        <i class="fas fa-play"></i> Vorschau
      </h2>
      <button class="close-btn" onclick="closePreviewModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div id="previewContent" style="min-height: 400px;"></div>
    
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:1.5rem;padding-top:1.5rem;border-top:2px solid var(--border)">
      <button class="btn secondary" id="prevSlideBtn" onclick="prevPreviewSlide()">
        <i class="fas fa-chevron-left"></i> Zur√ºck
      </button>
      
      <div id="slideCounter" style="font-weight:700;color:var(--primary);font-size:1.1rem"></div>
      
      <button class="btn primary" id="nextSlideBtn" onclick="nextPreviewSlide()">
        Weiter <i class="fas fa-chevron-right"></i>
      </button>
    </div>
  </div>
</div>

<script>
  const pb = new PocketBase('/');
  let currentUser = null;
  
  // Globale Variablen
  let allCourses = [];
  let allSessions = [];
  let allMembers = [];
  let allModules = [];
  let currentSlides = [];
  let previewSlides = [];
  let currentPreviewIndex = 0;
  
  let currentEditCourse = null;
  let currentEditMember = null;
  let currentEditModule = null;
  let currentEditSlide = null;
  let currentLearningModule = null;
  let currentSessionId = null;
  
  let selectedSessionMembers = [];
  let selectedAssignments = [];
  let quizAnswers = [];
  
  let slideContentEditor = null;

  // ========================================
  // INIT & AUTH
  // ========================================
  (async function init() {
    if (!pb.authStore.isValid) {
      window.location.href = '/mpg-login.html';
      return;
    }
    
    currentUser = pb.authStore.model;
    document.getElementById('username').textContent = currentUser.username;
    
    await loadCourses();
    generatePreviewCode();
    document.body.classList.add('loaded');
  })();

  function logout() {
    pb.authStore.clear();
    window.location.href = '/mpg-login.html';
  }

  // ========================================
  // TAB SWITCHING
  // ========================================
  async function switchTab(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(tab + '-tab').classList.add('active');
    
    if (tab === 'schulungen') await loadCourses();
    if (tab === 'team') await loadTeam();
    if (tab === 'zugaenge') await loadZugaenge();
    if (tab === 'lernbereich') await loadLernbereich();
  }

  // ========================================
  // HELPER FUNCTIONS
  // ========================================
  function showMsg(text, type = 'success') {
    const msg = document.createElement('div');
    msg.className = `msg ${type}`;
    msg.innerHTML = `
      <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
      ${text}
    `;
    document.body.appendChild(msg);
    setTimeout(() => msg.remove(), 3000);
  }

  function formatDate(dateStr) {
    const d = new Date(dateStr);
    return d.toLocaleDateString('de-DE', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  // ========================================
  // SCHULUNGEN LADEN
  // ========================================
  async function loadCourses() {
    try {
      try {
        allCourses = await pb.collection('courses').getFullList({
          filter: `organization_id = "${currentUser.organization_id}"`,
          sort: '-created'
        });
      } catch(err) {
        console.warn('courses collection fehlt:', err);
        allCourses = [];
      }
      
      try {
        allSessions = await pb.collection('course_sessions').getFullList({
          filter: `organization_id = "${currentUser.organization_id}"`,
          sort: '-created'
        });
      } catch(err) {
        console.warn('course_sessions collection fehlt:', err);
        allSessions = [];
      }
      
      await renderCourses();
    } catch(e) {
      console.error('Error loading courses:', e);
      document.getElementById('schulungen-list').innerHTML = `
        <div class="empty" style="background:#fff;border-radius:.75rem;padding:2rem">
          <i class="fas fa-exclamation-triangle" style="font-size:3rem;color:#f59e0b"></i>
          <div style="color:#f59e0b;margin-top:1rem;font-weight:700">Fehler beim Laden!</div>
          <p style="color:#6b7280;margin-top:.5rem">${e.message}</p>
        </div>
      `;
    }
  }

  // ========================================
  // SCHULUNGEN RENDERN (VERBESSERTE KACHELN!)
  // ========================================
  async function renderCourses() {
    const list = document.getElementById('schulungen-list');
    
    if (allCourses.length === 0) {
      list.innerHTML = '<div class="empty" style="background:#fff;border-radius:.75rem"><i class="fas fa-graduation-cap"></i><div>Noch keine Schulungen</div></div>';
      return;
    }
    
    let html = '';
    
    for (const course of allCourses) {
      const courseSessions = allSessions.filter(s => s.course_id === course.id);
      const nextSession = courseSessions.find(s => new Date(s.date) >= new Date());
      
      html += `
        <div class="course-card" onclick="viewSchulungDetails('${course.id}')">
          <div class="card-title">
            <i class="fa-solid fa-book-medical"></i> ${course.title}
          </div>
          
          ${course.instructor ? `
            <div style="margin-top:8px;color:#6b7280;font-size:.9rem">
              <i class="fa-solid fa-user"></i> <strong>Dozent:</strong> ${course.instructor}
            </div>
          ` : ''}
          
          ${course.description ? `
            <div style="margin-top:8px;color:#6b7280;font-size:.9rem;line-height:1.5">
              ${course.description}
            </div>
          ` : ''}
          
          ${nextSession ? `
            <div style="margin-top:12px;padding:8px;background:#f0fdf4;border-left:3px solid #16a34a;border-radius:4px">
              <div style="font-size:.85rem;color:#166534;font-weight:700">
                <i class="fa-solid fa-calendar"></i> N√§chster Termin
              </div>
              <div style="font-size:.9rem;color:#166534;margin-top:4px">
                ${formatDate(nextSession.date)}
              </div>
            </div>
          ` : `
            <div style="margin-top:12px;padding:8px;background:#fef3c7;border-left:3px solid #f59e0b;border-radius:4px">
              <div style="font-size:.85rem;color:#92400e">
                <i class="fa-solid fa-calendar-xmark"></i> Keine anstehenden Termine
              </div>
            </div>
          `}
          
          <div class="card-meta" style="margin-top:12px">
            <span><i class="fa-solid fa-calendar"></i> ${courseSessions.length} Termin(e)</span>
            <span class="badge ${course.type}">${course.type}</span>
          </div>
        </div>
      `;
    }
    
    list.innerHTML = html;
  }
  // ========================================
  // SCHULUNGS-DETAILS (VOLLST√ÑNDIGE INFOS!)
  // ========================================
  window.viewSchulungDetails = async (courseId) => {
    try {
      const course = await pb.collection('courses').getOne(courseId);
      const sessions = await pb.collection('course_sessions').getFullList({
        filter: `course_id = "${courseId}"`,
        sort: 'date'
      });
      
      const enrollments = await pb.collection('course_enrollments').getFullList({
        filter: `course_id = "${courseId}"`,
        expand: 'member_id'
      });
      
      document.getElementById('schulungDetailsTitle').innerHTML = 
        `<i class="fa-solid fa-book-medical"></i> ${course.title}`;
      
      let html = `
        <div class="details-section">
          <h4><i class="fa-solid fa-info-circle"></i> Schulungsinformationen</h4>
          <div style="display:grid;grid-template-columns:150px 1fr;gap:12px;line-height:1.8">
            
            <div style="font-weight:700;color:#6b7280">Typ:</div>
            <div><span class="badge ${course.type}">${course.type}</span></div>
            
            ${course.instructor ? `
            <div style="font-weight:700;color:#6b7280">Dozent:</div>
            <div>${course.instructor}</div>
            ` : ''}
            
            ${course.description ? `
            <div style="font-weight:700;color:#6b7280">Beschreibung:</div>
            <div>${course.description}</div>
            ` : ''}
            
            ${course.duration ? `
            <div style="font-weight:700;color:#6b7280">Dauer:</div>
            <div>${course.duration} Stunden</div>
            ` : ''}
            
            ${course.location ? `
            <div style="font-weight:700;color:#6b7280">Ort:</div>
            <div>${course.location}</div>
            ` : ''}
            
            ${course.certificate_validity ? `
            <div style="font-weight:700;color:#6b7280">Zertifikat g√ºltig:</div>
            <div>${course.certificate_validity} Monate</div>
            ` : ''}
            
            <div style="font-weight:700;color:#6b7280">Erstellt am:</div>
            <div>${formatDate(course.created)}</div>
          </div>
        </div>
      `;
      
      // TERMINE
      html += `
        <div class="details-section">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h4 style="margin:0"><i class="fa-solid fa-calendar"></i> Termine (${sessions.length})</h4>
            <button class="btn btn-sm primary" onclick="closeSchulungDetailsModal();openTerminModal('${courseId}')">
              <i class="fas fa-plus"></i> Termin
            </button>
          </div>
      `;
      
      if (sessions.length > 0) {
        const now = new Date();
        const upcoming = sessions.filter(s => new Date(s.date) >= now);
        const past = sessions.filter(s => new Date(s.date) < now);
        
        if (upcoming.length > 0) {
          html += '<h5 style="margin-top:1rem;color:var(--success)">Anstehende Termine</h5>';
          upcoming.forEach(session => {
            const sessionEnrollments = enrollments.filter(e => e.session_id === session.id);
            html += `
              <div style="padding:12px;margin-top:8px;background:#f0fdf4;border-left:3px solid #16a34a;border-radius:6px">
                <div style="display:flex;justify-content:space-between;align-items:start">
                  <div style="flex:1">
                    <div style="font-weight:700;color:#166534">${formatDate(session.date)}</div>
                    ${session.location ? `<div style="font-size:.9rem;color:#166534;margin-top:4px"><i class="fa-solid fa-location-dot"></i> ${session.location}</div>` : ''}
                    <div style="font-size:.85rem;color:#166534;margin-top:4px">
                      ${sessionEnrollments.length} Teilnehmer
                    </div>
                  </div>
                  <div style="display:flex;gap:4px">
                    <button class="btn btn-sm primary" onclick="event.stopPropagation();openAssignSession('${session.id}','${courseId}')">
                      <i class="fas fa-users"></i>
                    </button>
                    <button class="btn btn-sm danger" onclick="event.stopPropagation();deleteSession('${session.id}','${courseId}')">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
              </div>
            `;
          });
        }
        
        if (past.length > 0) {
          html += '<h5 style="margin-top:1rem;color:#6b7280">Vergangene Termine</h5>';
          past.forEach(session => {
            const sessionEnrollments = enrollments.filter(e => e.session_id === session.id);
            html += `
              <div style="padding:12px;margin-top:8px;background:#f9fafb;border-left:3px solid #6b7280;border-radius:6px">
                <div style="display:flex;justify-content:space-between;align-items:start">
                  <div style="flex:1">
                    <div style="font-weight:700;color:#6b7280">${formatDate(session.date)}</div>
                    ${session.location ? `<div style="font-size:.9rem;color:#6b7280;margin-top:4px"><i class="fa-solid fa-location-dot"></i> ${session.location}</div>` : ''}
                    <div style="font-size:.85rem;color:#6b7280;margin-top:4px">
                      ${sessionEnrollments.length} Teilnehmer
                    </div>
                  </div>
                  <button class="btn btn-sm" onclick="event.stopPropagation();deleteSession('${session.id}','${courseId}')">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
            `;
          });
        }
      } else {
        html += '<p style="color:#999;padding:16px;text-align:center">Noch keine Termine angelegt</p>';
      }
      
      html += '</div>';
      
      // TEILNEHMER
      html += `
        <div class="details-section">
          <h4><i class="fa-solid fa-users"></i> Alle Teilnehmer (${enrollments.length})</h4>
      `;
      
      if (enrollments.length > 0) {
        html += '<table class="table" style="margin-top:1rem"><thead><tr><th>Name</th><th>Termin</th><th>Status</th></tr></thead><tbody>';
        
        enrollments.forEach(enrollment => {
          const member = enrollment.expand?.member_id;
          if (!member) return;
          
          const session = sessions.find(s => s.id === enrollment.session_id);
          
          html += `
            <tr>
              <td style="font-weight:700">${member.vorname} ${member.name}</td>
              <td>${session ? formatDate(session.date) : '-'}</td>
              <td>
                <span class="status-icon ${enrollment.status}">
                  ${enrollment.status === 'completed' ? '‚úì' : enrollment.status === 'enrolled' ? 'üìã' : '‚ùå'}
                </span>
                ${enrollment.status === 'completed' ? 'Abgeschlossen' : enrollment.status === 'enrolled' ? 'Angemeldet' : 'Abgebrochen'}
              </td>
            </tr>
          `;
        });
        
        html += '</tbody></table>';
      } else {
        html += '<p style="color:#999;padding:16px;text-align:center">Noch keine Teilnehmer</p>';
      }
      
      html += '</div>';
      
      // AKTIONEN
      html += `
        <div style="margin-top:16px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn primary" onclick="closeSchulungDetailsModal();openSchulungModal('${courseId}')">
            <i class="fa-solid fa-edit"></i> Bearbeiten
          </button>
          <button class="btn danger" onclick="deleteSchulung('${courseId}')">
            <i class="fa-solid fa-trash"></i> L√∂schen
          </button>
        </div>
      `;
      
      document.getElementById('schulungDetailsBody').innerHTML = html;
      document.getElementById('schulungDetailsModal').classList.add('show');
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.closeSchulungDetailsModal = () => {
    document.getElementById('schulungDetailsModal').classList.remove('show');
  };

  // ========================================
  // SCHULUNG ERSTELLEN/BEARBEITEN
  // ========================================
  window.openSchulungModal = (courseId = null) => {
    currentEditCourse = courseId;
    const form = document.getElementById('schulungForm');
    form.reset();
    
    if (courseId) {
      const course = allCourses.find(c => c.id === courseId);
      if (course) {
        document.getElementById('schulungModalTitle').innerHTML = '<i class="fa-solid fa-edit"></i> Schulung bearbeiten';
        form.title.value = course.title;
        form.type.value = course.type;
        form.instructor.value = course.instructor || '';
        form.description.value = course.description || '';
        form.duration.value = course.duration || '';
        form.location.value = course.location || '';
        form.certificate_validity.value = course.certificate_validity || '';
      }
    } else {
      document.getElementById('schulungModalTitle').innerHTML = '<i class="fa-solid fa-book-medical"></i> Neue Schulung';
    }
    
    document.getElementById('schulungModal').classList.add('show');
  };

  window.closeSchulungModal = () => {
    document.getElementById('schulungModal').classList.remove('show');
    currentEditCourse = null;
  };

  document.getElementById('schulungForm').onsubmit = async (e) => {
    e.preventDefault();
    
    try {
      const formData = new FormData(e.target);
      const data = {
        title: formData.get('title').trim(),
        type: formData.get('type'),
        instructor: formData.get('instructor').trim(),
        description: formData.get('description').trim(),
        duration: parseInt(formData.get('duration')) || null,
        location: formData.get('location').trim(),
        certificate_validity: parseInt(formData.get('certificate_validity')) || null,
        organization_id: currentUser.organization_id
      };
      
      if (currentEditCourse) {
        await pb.collection('courses').update(currentEditCourse, data);
        showMsg('‚úÖ Schulung aktualisiert!');
      } else {
        const newCourse = await pb.collection('courses').create(data);
        showMsg('‚úÖ Schulung erstellt!');
        allCourses.push(newCourse);
      }
      
      closeSchulungModal();
      await renderCourses();
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.deleteSchulung = async (courseId) => {
    if (!confirm('Schulung wirklich l√∂schen? Alle Termine und Teilnehmer werden ebenfalls gel√∂scht!')) return;
    
    try {
      await pb.collection('courses').delete(courseId);
      showMsg('‚úÖ Schulung gel√∂scht!');
      closeSchulungDetailsModal();
      await loadCourses();
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  // ========================================
  // TERMINE
  // ========================================
  window.openTerminModal = (courseId) => {
    currentEditCourse = courseId;
    document.getElementById('terminForm').reset();
    document.getElementById('terminModal').classList.add('show');
  };

  window.closeTerminModal = () => {
    document.getElementById('terminModal').classList.remove('show');
  };

  document.getElementById('terminForm').onsubmit = async (e) => {
    e.preventDefault();
    
    try {
      const formData = new FormData(e.target);
      const data = {
        course_id: currentEditCourse,
        date: formData.get('date'),
        location: formData.get('location').trim(),
        organization_id: currentUser.organization_id
      };
      
      await pb.collection('course_sessions').create(data);
      showMsg('‚úÖ Termin erstellt!');
      closeTerminModal();
      await loadCourses();
      await viewSchulungDetails(currentEditCourse);
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.deleteSession = async (sessionId, courseId) => {
    if (!confirm('Termin wirklich l√∂schen?')) return;
    
    try {
      await pb.collection('course_sessions').delete(sessionId);
      showMsg('‚úÖ Termin gel√∂scht!');
      await loadCourses();
      await viewSchulungDetails(courseId);
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  // ========================================
  // TEILNEHMER ZU TERMIN ZUWEISEN
  // ========================================
  window.openAssignSession = async (sessionId, courseId) => {
    currentSessionId = sessionId;
    currentEditCourse = courseId;
    
    try {
      allMembers = await pb.collection('team_members').getFullList({
        filter: `organization_id = "${currentUser.organization_id}" && aktiv = true`,
        sort: 'name'
      });
      
      const enrollments = await pb.collection('course_enrollments').getFullList({
        filter: `session_id = "${sessionId}"`
      });
      
      selectedSessionMembers = enrollments.map(e => e.member_id);
      
      renderAssignSessionList();
      document.getElementById('assignSessionModal').classList.add('show');
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  function renderAssignSessionList() {
    const list = document.getElementById('assignMembersList');
    const searchTerm = document.getElementById('assignSearchInput').value.toLowerCase();
    
    const filtered = allMembers.filter(m => 
      m.vorname.toLowerCase().includes(searchTerm) || 
      m.name.toLowerCase().includes(searchTerm)
    );
    
    list.innerHTML = filtered.map(member => `
      <div style="padding:.75rem;border-bottom:1px solid var(--border)">
        <label style="display:flex;align-items:center;gap:.75rem;cursor:pointer">
          <input type="checkbox" ${selectedSessionMembers.includes(member.id) ? 'checked' : ''} 
            onchange="toggleSessionMember('${member.id}')">
          <div>
            <div style="font-weight:700">${member.vorname} ${member.name}</div>
            ${member.rolle ? `<div style="font-size:.85rem;color:var(--muted)">${member.rolle}</div>` : ''}
          </div>
        </label>
      </div>
    `).join('');
  }

  window.filterAssignList = () => {
    renderAssignSessionList();
  };

  window.toggleSessionMember = (memberId) => {
    const idx = selectedSessionMembers.indexOf(memberId);
    if (idx >= 0) {
      selectedSessionMembers.splice(idx, 1);
    } else {
      selectedSessionMembers.push(memberId);
    }
  };

  window.closeAssignSessionModal = () => {
    document.getElementById('assignSessionModal').classList.remove('show');
  };

  window.saveSessionAssignments = async () => {
    try {
      const oldEnrollments = await pb.collection('course_enrollments').getFullList({
        filter: `session_id = "${currentSessionId}"`
      });
      
      for (const e of oldEnrollments) {
        await pb.collection('course_enrollments').delete(e.id);
      }
      
      for (const memberId of selectedSessionMembers) {
        await pb.collection('course_enrollments').create({
          course_id: currentEditCourse,
          session_id: currentSessionId,
          member_id: memberId,
          status: 'enrolled',
          organization_id: currentUser.organization_id
        });
      }
      
      showMsg(`‚úÖ ${selectedSessionMembers.length} Teilnehmer zugewiesen!`);
      closeAssignSessionModal();
      await viewSchulungDetails(currentEditCourse);
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  // ========================================
  // TEAM
  // ========================================
  async function loadTeam() {
    try {
      allMembers = await pb.collection('team_members').getFullList({
        filter: `organization_id = "${currentUser.organization_id}"`,
        sort: 'name'
      });
      
      await renderTeam();
    } catch(e) {
      console.error('Error:', e);
    }
  }

  async function renderTeam() {
    const list = document.getElementById('team-list');
    
    if (allMembers.length === 0) {
      list.innerHTML = '<div class="empty" style="background:#fff;border-radius:.75rem"><i class="fas fa-users"></i><div>Noch keine Mitglieder</div></div>';
      return;
    }
    
    let html = '';
    
    for (const member of allMembers) {
      const enrollments = await pb.collection('course_enrollments').getFullList({
        filter: `member_id = "${member.id}"`,
        expand: 'course_id'
      });
      
      html += `
        <div class="course-card" onclick="viewMemberDetails('${member.id}')">
          <div class="card-title">
            <i class="fa-solid fa-user"></i> ${member.vorname} ${member.name}
          </div>
          ${member.rolle ? `<div style="color:var(--muted);font-size:.9rem;margin-top:4px">${member.rolle}</div>` : ''}
          <div class="card-meta" style="margin-top:12px">
            <span><i class="fa-solid fa-graduation-cap"></i> ${enrollments.length} Schulung(en)</span>
            <span>${member.aktiv ? '‚úÖ Aktiv' : '‚ùå Inaktiv'}</span>
          </div>
        </div>
      `;
    }
    
    list.innerHTML = html;
  }

  window.viewMemberDetails = async (memberId) => {
    try {
      const member = await pb.collection('team_members').getOne(memberId);
      const enrollments = await pb.collection('course_enrollments').getFullList({
        filter: `member_id = "${memberId}"`,
        expand: 'course_id,session_id'
      });
      
      document.getElementById('memberDetailsTitle').innerHTML = 
        `<i class="fa-solid fa-user"></i> ${member.vorname} ${member.name}`;
      
      let html = `
        <div class="details-section">
          <h4><i class="fa-solid fa-info-circle"></i> Pers√∂nliche Informationen</h4>
          <div style="display:grid;grid-template-columns:150px 1fr;gap:12px">
            ${member.rolle ? `
            <div style="font-weight:700;color:#6b7280">Rolle:</div>
            <div>${member.rolle}</div>
            ` : ''}
            ${member.email ? `
            <div style="font-weight:700;color:#6b7280">E-Mail:</div>
            <div>${member.email}</div>
            ` : ''}
            ${member.telefon ? `
            <div style="font-weight:700;color:#6b7280">Telefon:</div>
            <div>${member.telefon}</div>
            ` : ''}
            <div style="font-weight:700;color:#6b7280">Status:</div>
            <div>${member.aktiv ? '‚úÖ Aktiv' : '‚ùå Inaktiv'}</div>
          </div>
        </div>
        
        <div class="details-section">
          <h4><i class="fa-solid fa-graduation-cap"></i> Schulungen (${enrollments.length})</h4>
      `;
      
      if (enrollments.length > 0) {
        html += '<table class="table" style="margin-top:1rem"><thead><tr><th>Schulung</th><th>Termin</th><th>Status</th></tr></thead><tbody>';
        
        enrollments.forEach(enrollment => {
          const course = enrollment.expand?.course_id;
          const session = enrollment.expand?.session_id;
          
          html += `
            <tr>
              <td style="font-weight:700">${course?.title || '-'}</td>
              <td>${session ? formatDate(session.date) : '-'}</td>
              <td>
                <span class="status-icon ${enrollment.status}">
                  ${enrollment.status === 'completed' ? '‚úì' : enrollment.status === 'enrolled' ? 'üìã' : '‚ùå'}
                </span>
                ${enrollment.status === 'completed' ? 'Abgeschlossen' : enrollment.status === 'enrolled' ? 'Angemeldet' : 'Abgebrochen'}
              </td>
            </tr>
          `;
        });
        
        html += '</tbody></table>';
      } else {
        html += '<p style="color:#999;padding:16px;text-align:center">Noch keine Schulungen zugewiesen</p>';
      }
      
      html += `
        </div>
        <div style="margin-top:16px;display:flex;gap:8px">
          <button class="btn primary" onclick="closeMemberDetailsModal();openMemberModal('${memberId}')">
            <i class="fa-solid fa-edit"></i> Bearbeiten
          </button>
          <button class="btn danger" onclick="deleteMember('${memberId}')">
            <i class="fa-solid fa-trash"></i> L√∂schen
          </button>
        </div>
      `;
      
      document.getElementById('memberDetailsBody').innerHTML = html;
      document.getElementById('memberDetailsModal').classList.add('show');
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.closeMemberDetailsModal = () => {
    document.getElementById('memberDetailsModal').classList.remove('show');
  };

  window.openMemberModal = (memberId = null) => {
    currentEditMember = memberId;
    const form = document.getElementById('memberForm');
    form.reset();
    
    if (memberId) {
      const member = allMembers.find(m => m.id === memberId);
      if (member) {
        document.getElementById('memberModalTitle').innerHTML = '<i class="fa-solid fa-edit"></i> Mitglied bearbeiten';
        form.vorname.value = member.vorname;
        form.name.value = member.name;
        form.email.value = member.email || '';
        form.telefon.value = member.telefon || '';
        form.rolle.value = member.rolle || '';
        document.getElementById('member-aktiv').checked = member.aktiv;
      }
    } else {
      document.getElementById('memberModalTitle').innerHTML = '<i class="fa-solid fa-user-plus"></i> Neues Mitglied';
    }
    
    document.getElementById('memberModal').classList.add('show');
  };

  window.closeMemberModal = () => {
    document.getElementById('memberModal').classList.remove('show');
    currentEditMember = null;
  };

  document.getElementById('memberForm').onsubmit = async (e) => {
    e.preventDefault();
    
    try {
      const formData = new FormData(e.target);
      const data = {
        vorname: formData.get('vorname').trim(),
        name: formData.get('name').trim(),
        email: formData.get('email').trim(),
        telefon: formData.get('telefon').trim(),
        rolle: formData.get('rolle').trim(),
        aktiv: document.getElementById('member-aktiv').checked,
        organization_id: currentUser.organization_id
      };
      
      if (currentEditMember) {
        await pb.collection('team_members').update(currentEditMember, data);
        showMsg('‚úÖ Mitglied aktualisiert!');
      } else {
        await pb.collection('team_members').create(data);
        showMsg('‚úÖ Mitglied erstellt!');
      }
      
      closeMemberModal();
      await loadTeam();
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.deleteMember = async (memberId) => {
    if (!confirm('Mitglied wirklich l√∂schen?')) return;
    
    try {
      await pb.collection('team_members').delete(memberId);
      showMsg('‚úÖ Mitglied gel√∂scht!');
      closeMemberDetailsModal();
      await loadTeam();
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  // ========================================
  // ZUG√ÑNGE
  // ========================================
  async function loadZugaenge() {
    try {
      allMembers = await pb.collection('team_members').getFullList({
        filter: `organization_id = "${currentUser.organization_id}"`,
        sort: 'name'
      });
      
      await renderZugaenge();
    } catch(e) {
      console.error('Error:', e);
    }
  }

  async function renderZugaenge() {
    const list = document.getElementById('zugaenge-list');
    
    if (allMembers.length === 0) {
      list.innerHTML = '<div class="empty" style="background:#fff;border-radius:.75rem"><i class="fas fa-key"></i><div>Noch keine Zug√§nge</div></div>';
      return;
    }
    
    let html = '';
    
    allMembers.forEach(member => {
      const username = `${member.vorname.toLowerCase()}.${member.name.toLowerCase()}`;
      const password = Math.random().toString(36).slice(-8);
      
      html += `
        <div class="course-card">
          <div class="card-title">
            <i class="fa-solid fa-key"></i> ${member.vorname} ${member.name}
          </div>
          <div style="margin-top:12px;font-size:.9rem">
            <div style="margin-bottom:8px">
              <strong>Benutzername:</strong><br>
              <code style="background:var(--bg);padding:4px 8px;border-radius:4px;display:inline-block;margin-top:4px">${username}</code>
            </div>
            <div>
              <strong>Passwort:</strong><br>
              <code style="background:var(--bg);padding:4px 8px;border-radius:4px;display:inline-block;margin-top:4px">${password}</code>
            </div>
          </div>
          <div style="margin-top:12px">
            <button class="btn btn-sm primary" onclick="showAccessDetails('${member.id}', '${username}', '${password}')">
              <i class="fas fa-qrcode"></i> QR-Code anzeigen
            </button>
          </div>
        </div>
      `;
    });
    
    list.innerHTML = html;
  }

  window.showAccessDetails = (memberId, username, password) => {
    const member = allMembers.find(m => m.id === memberId);
    
    document.getElementById('accessModalTitle').innerHTML = 
      `<i class="fa-solid fa-key"></i> Zugang: ${member.vorname} ${member.name}`;
    
    const qrData = `Username: ${username}\nPassword: ${password}\nURL: ${window.location.origin}/mpg-login.html`;
    
    document.getElementById('accessModalBody').innerHTML = `
      <div class="qr-code-container">
        <div id="qrcode-display"></div>
        <div style="margin-top:1.5rem">
          <div style="margin-bottom:1rem">
            <strong>Benutzername:</strong><br>
            <code style="background:var(--bg);padding:8px 12px;border-radius:4px;display:inline-block;margin-top:4px;font-size:1.1rem">${username}</code>
          </div>
          <div>
            <strong>Passwort:</strong><br>
            <code style="background:var(--bg);padding:8px 12px;border-radius:4px;display:inline-block;margin-top:4px;font-size:1.1rem">${password}</code>
          </div>
        </div>
      </div>
    `;
    
    document.getElementById('accessModal').classList.add('show');
    
    setTimeout(() => {
      new QRCode(document.getElementById('qrcode-display'), {
        text: qrData,
        width: 256,
        height: 256
      });
    }, 100);
  };

  window.closeAccessModal = () => {
    document.getElementById('accessModal').classList.remove('show');
  };

  window.exportAllAccessPDF = async () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    let yPos = 20;
    
    doc.setFontSize(18);
    doc.text('Zugangsdaten - √úbersicht', 20, yPos);
    yPos += 15;
    
    for (const member of allMembers) {
      if (yPos > 250) {
        doc.addPage();
        yPos = 20;
      }
      
      const username = `${member.vorname.toLowerCase()}.${member.name.toLowerCase()}`;
      const password = Math.random().toString(36).slice(-8);
      
      doc.setFontSize(14);
      doc.text(`${member.vorname} ${member.name}`, 20, yPos);
      yPos += 8;
      
      doc.setFontSize(10);
      doc.text(`Benutzername: ${username}`, 30, yPos);
      yPos += 6;
      doc.text(`Passwort: ${password}`, 30, yPos);
      yPos += 12;
    }
    
    doc.save('zugangsdaten.pdf');
    showMsg('‚úÖ PDF erstellt!');
  };
  // ========================================
  // LERNBEREICH
  // ========================================
  async function loadLernbereich() {
    try {
      try {
        allModules = await pb.collection('learning_modules').getFullList({
          filter: `organization_id = "${currentUser.organization_id}"`,
          sort: '-created'
        });
      } catch(err) {
        console.warn('learning_modules collection fehlt:', err);
        allModules = [];
      }
      
      await renderLernbereich();
    } catch(e) {
      console.error('Error:', e);
      document.getElementById('lernbereich-list').innerHTML = `
        <div class="empty" style="background:#fff;border-radius:.75rem;padding:2rem">
          <i class="fas fa-exclamation-triangle" style="font-size:3rem;color:#f59e0b"></i>
          <div style="color:#f59e0b;margin-top:1rem;font-weight:700">Collection fehlt!</div>
          <p style="color:#6b7280;margin-top:.5rem">Die PocketBase Collection "learning_modules" wurde noch nicht erstellt.</p>
        </div>
      `;
    }
  }

  async function renderLernbereich() {
    const list = document.getElementById('lernbereich-list');
    
    if (allModules.length === 0) {
      list.innerHTML = '<div class="empty" style="background:#fff;border-radius:.75rem"><i class="fas fa-laptop"></i><div>Noch keine Lernmodule</div></div>';
      return;
    }
    
    let html = '';
    
    for (const module of allModules) {
      try {
        const slides = await pb.collection('learning_slides').getFullList({
          filter: `module_id = "${module.id}"`,
          sort: 'order'
        });
        
        const assignments = await pb.collection('module_assignments').getFullList({
          filter: `module_id = "${module.id}"`
        });
        
        const progress = await pb.collection('module_progress').getFullList({
          filter: `module_id = "${module.id}"`
        });
        
        const totalDuration = slides.reduce((sum, s) => sum + (s.duration || 0), 0);
        const completedCount = progress.filter(p => p.completed_at).length;
        
        html += `
          <div class="module-card" onclick="viewModuleDetails('${module.id}')">
            <div class="card-title"><i class="fa-solid fa-laptop"></i> ${module.title}</div>
            <div class="card-meta">
              <span><i class="fa-solid fa-layer-group"></i> ${slides.length} Folien</span>
              <span><i class="fa-solid fa-clock"></i> ${totalDuration} Min.</span>
              <span><i class="fa-solid fa-users"></i> ${assignments.length} zugewiesen</span>
            </div>
            ${assignments.length > 0 ? `
              <div style="margin-top:8px">
                <div class="progress-bar">
                  <div class="progress-bar-fill" style="width:${Math.round(completedCount / assignments.length * 100)}%"></div>
                </div>
                <div style="font-size:.85rem;color:var(--muted);margin-top:4px">
                  ${completedCount} von ${assignments.length} abgeschlossen
                </div>
              </div>
            ` : ''}
            <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-sm primary" onclick="event.stopPropagation(); openSlideEditor('${module.id}')">
                <i class="fas fa-edit"></i> Folien
              </button>
              <button class="btn btn-sm" onclick="event.stopPropagation(); openAssignMembers('${module.id}')">
                <i class="fas fa-users"></i> Zuweisen
              </button>
            </div>
          </div>
        `;
      } catch(e) {
        console.error('Error loading module details:', e);
      }
    }
    
    list.innerHTML = html;
  }

  window.openModuleModal = (moduleId = null) => {
    currentEditModule = moduleId;
    const form = document.getElementById('moduleForm');
    form.reset();
    
    if (moduleId) {
      const module = allModules.find(m => m.id === moduleId);
      if (module) {
        document.getElementById('moduleModalTitle').innerHTML = '<i class="fa-solid fa-edit"></i> Lernmodul bearbeiten';
        form.title.value = module.title;
        form.instructor.value = module.instructor || '';
        form.description.value = module.description || '';
        form.passing_score.value = module.passing_score || 80;
        form.max_attempts.value = module.max_attempts || 3;
        document.getElementById('require-quiz').checked = module.require_quiz || false;
      }
    } else {
      document.getElementById('moduleModalTitle').innerHTML = '<i class="fa-solid fa-laptop"></i> Neues Lernmodul';
    }
    
    document.getElementById('moduleModal').classList.add('show');
  };

  window.closeModuleModal = () => {
    document.getElementById('moduleModal').classList.remove('show');
    currentEditModule = null;
  };

  document.getElementById('moduleForm').onsubmit = async (e) => {
    e.preventDefault();
    
    try {
      const formData = new FormData(e.target);
      const data = {
        title: formData.get('title').trim(),
        instructor: formData.get('instructor').trim(),
        description: formData.get('description').trim(),
        passing_score: parseInt(formData.get('passing_score')) || 80,
        max_attempts: parseInt(formData.get('max_attempts')) || 3,
        require_quiz: document.getElementById('require-quiz').checked,
        organization_id: currentUser.organization_id
      };
      
      if (currentEditModule) {
        await pb.collection('learning_modules').update(currentEditModule, data);
        showMsg('‚úÖ Lernmodul aktualisiert!');
      } else {
        const newModule = await pb.collection('learning_modules').create(data);
        showMsg('‚úÖ Lernmodul erstellt!');
        allModules.push(newModule);
      }
      
      closeModuleModal();
      await renderLernbereich();
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.viewModuleDetails = async (moduleId) => {
    try {
      const module = await pb.collection('learning_modules').getOne(moduleId);
      const slides = await pb.collection('learning_slides').getFullList({
        filter: `module_id = "${moduleId}"`,
        sort: 'order'
      });
      
      const assignments = await pb.collection('module_assignments').getFullList({
        filter: `module_id = "${moduleId}"`,
        expand: 'member_id'
      });
      
      const progress = await pb.collection('module_progress').getFullList({
        filter: `module_id = "${moduleId}"`,
        expand: 'member_id'
      });
      
      document.getElementById('moduleDetailsTitle').innerHTML = 
        `<i class="fa-solid fa-laptop"></i> ${module.title}`;
      
      let html = `
        <div class="details-section">
          <h4><i class="fa-solid fa-info-circle"></i> Modul-Informationen</h4>
          <div style="display:grid;grid-template-columns:150px 1fr;gap:8px">
            ${module.instructor ? `
            <div style="font-weight:700;color:#6b7280">Dozent:</div>
            <div>${module.instructor}</div>
            ` : ''}
            
            ${module.description ? `
            <div style="font-weight:700;color:#6b7280">Beschreibung:</div>
            <div>${module.description}</div>
            ` : ''}
            
            <div style="font-weight:700;color:#6b7280">Folien:</div>
            <div>${slides.length} Folien</div>
            
            <div style="font-weight:700;color:#6b7280">Bestehensgrenze:</div>
            <div>${module.passing_score}%</div>
            
            <div style="font-weight:700;color:#6b7280">Max. Versuche:</div>
            <div>${module.max_attempts === 0 ? 'Unbegrenzt' : module.max_attempts}</div>
            
            <div style="font-weight:700;color:#6b7280">Pr√ºfung:</div>
            <div>${module.require_quiz ? '‚úÖ Erforderlich' : '‚ùå Nicht erforderlich'}</div>
          </div>
        </div>
        
        <div class="details-section">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h4 style="margin:0"><i class="fa-solid fa-users"></i> Zugewiesene Personen (${assignments.length})</h4>
            <button class="btn btn-sm primary" onclick="openAssignMembers('${moduleId}')">
              <i class="fas fa-users"></i> Zuweisen
            </button>
          </div>
      `;
      
      if (assignments.length > 0) {
        html += `
          <table class="table" style="margin-top:1rem">
            <thead>
              <tr>
                <th>Name</th>
                <th>Status</th>
                <th>Fortschritt</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        assignments.forEach(assignment => {
          const member = assignment.expand?.member_id;
          if (!member) return;
          
          const memberProgress = progress.find(p => p.member_id === assignment.member_id);
          
          let statusIcon = 'pending';
          let statusText = 'Nicht gestartet';
          
          if (memberProgress) {
            if (memberProgress.completed_at) {
              statusIcon = 'completed';
              statusText = 'Abgeschlossen';
            } else {
              statusIcon = 'progress';
              statusText = 'In Bearbeitung';
            }
          }
          
          const progressPercent = memberProgress && slides.length > 0
            ? Math.round((memberProgress.slides_viewed?.length || 0) / slides.length * 100)
            : 0;
          
          html += `
            <tr>
              <td style="font-weight:700">${member.vorname} ${member.name}</td>
              <td>
                <span class="status-icon ${statusIcon}">
                  ${statusIcon === 'completed' ? '‚úì' : statusIcon === 'progress' ? '‚è≥' : '‚óã'}
                </span>
                ${statusText}
              </td>
              <td>
                <div class="progress-bar">
                  <div class="progress-bar-fill" style="width:${progressPercent}%"></div>
                </div>
                <div style="font-size:.85rem;color:var(--muted);margin-top:4px">
                  ${progressPercent}%
                </div>
              </td>
            </tr>
          `;
        });
        
        html += '</tbody></table>';
      } else {
        html += '<p style="color:#999;padding:16px;text-align:center">Noch keine Personen zugewiesen</p>';
      }
      
      html += `
        </div>
        
        <div style="margin-top:16px;display:flex;gap:8px">
          <button class="btn primary" onclick="openSlideEditor('${moduleId}')">
            <i class="fa-solid fa-edit"></i> Folien bearbeiten
          </button>
          <button class="btn success" onclick="previewModule('${moduleId}')">
            <i class="fas fa-play"></i> Vorschau
          </button>
          <button class="btn" onclick="closeModuleDetailsModal();openModuleModal('${moduleId}')">
            <i class="fa-solid fa-cog"></i> Einstellungen
          </button>
          <button class="btn danger" onclick="deleteModule('${moduleId}')">
            <i class="fa-solid fa-trash"></i> L√∂schen
          </button>
        </div>
      `;
      
      document.getElementById('moduleDetailsBody').innerHTML = html;
      document.getElementById('moduleDetailsModal').classList.add('show');
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.closeModuleDetailsModal = () => {
    document.getElementById('moduleDetailsModal').classList.remove('show');
  };

  window.deleteModule = async (moduleId) => {
    if (!confirm('Lernmodul wirklich l√∂schen?')) return;
    
    try {
      const slides = await pb.collection('learning_slides').getFullList({
        filter: `module_id = "${moduleId}"`
      });
      for (const slide of slides) {
        await pb.collection('learning_slides').delete(slide.id);
      }
      
      const assignments = await pb.collection('module_assignments').getFullList({
        filter: `module_id = "${moduleId}"`
      });
      for (const a of assignments) {
        await pb.collection('module_assignments').delete(a.id);
      }
      
      await pb.collection('learning_modules').delete(moduleId);
      
      showMsg('‚úÖ Lernmodul gel√∂scht!');
      closeModuleDetailsModal();
      await loadLernbereich();
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  // ========================================
  // PERSONEN ZUWEISEN
  // ========================================
  window.openAssignMembers = async (moduleId) => {
    currentLearningModule = moduleId;
    try {
      allMembers = await pb.collection('team_members').getFullList({
        filter: `organization_id = "${currentUser.organization_id}" && aktiv = true`,
        sort: 'name'
      });
      const assignments = await pb.collection('module_assignments').getFullList({
        filter: `module_id = "${moduleId}"`
      });
      selectedAssignments = assignments.map(a => a.member_id);
      const list = document.getElementById('assignMembersList');
      list.innerHTML = allMembers.map(member => `
        <div style="padding:.75rem;border-bottom:1px solid var(--border)">
          <label style="display:flex;align-items:center;gap:.75rem;cursor:pointer">
            <input type="checkbox" ${selectedAssignments.includes(member.id) ? 'checked' : ''} onchange="toggleAssignment('${member.id}')">
            <div><div style="font-weight:700">${member.vorname} ${member.name}</div></div>
          </label>
        </div>
      `).join('');
      document.getElementById('assignMembersModal').classList.add('show');
    } catch(e) { showMsg('Fehler: ' + e.message, 'error'); }
  };

  window.closeAssignMembersModal = () => { 
    document.getElementById('assignMembersModal').classList.remove('show'); 
  };
  
  window.toggleAssignment = (memberId) => {
    const idx = selectedAssignments.indexOf(memberId);
    idx >= 0 ? selectedAssignments.splice(idx, 1) : selectedAssignments.push(memberId);
  };

  window.saveAssignments = async () => {
    try {
      const old = await pb.collection('module_assignments').getFullList({ 
        filter: `module_id = "${currentLearningModule}"` 
      });
      for (const a of old) await pb.collection('module_assignments').delete(a.id);
      for (const memberId of selectedAssignments) {
        await pb.collection('module_assignments').create({ 
          module_id: currentLearningModule, 
          member_id: memberId, 
          organization_id: currentUser.organization_id 
        });
      }
      showMsg(`‚úÖ ${selectedAssignments.length} Personen zugewiesen!`);
      closeAssignMembersModal();
      await loadLernbereich();
      if (document.getElementById('moduleDetailsModal').classList.contains('show')) {
        await viewModuleDetails(currentLearningModule);
      }
    } catch(e) { showMsg('Fehler: ' + e.message, 'error'); }
  };

  // ========================================
  // FOLIEN-EDITOR
  // ========================================
  window.openSlideEditor = async (moduleId) => {
    currentLearningModule = moduleId;
    
    try {
      const module = await pb.collection('learning_modules').getOne(moduleId);
      currentSlides = await pb.collection('learning_slides').getFullList({
        filter: `module_id = "${moduleId}"`,
        sort: 'order'
      });
      
      document.getElementById('slideEditorTitle').textContent = `Folien bearbeiten: ${module.title}`;
      renderSlidesList();
      document.getElementById('slideEditorModal').classList.add('show');
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.closeSlideEditor = () => {
    document.getElementById('slideEditorModal').classList.remove('show');
    currentSlides = [];
  };

  function renderSlidesList() {
    const list = document.getElementById('slides-list');
    
    if (currentSlides.length === 0) {
      list.innerHTML = '<p style="color:#999;text-align:center;padding:2rem">Noch keine Folien vorhanden</p>';
      return;
    }
    
    list.innerHTML = currentSlides.map((slide, idx) => {
      const icons = {
        text: { icon: 'üìù', bg: '#dbeafe', color: '#1e40af' },
        image: { icon: 'üñºÔ∏è', bg: '#dcfce7', color: '#166534' },
        video: { icon: 'üé•', bg: '#fef3c7', color: '#92400e' },
        quiz: { icon: '‚ùì', bg: '#fee2e2', color: '#991b1b' }
      };
      const type = icons[slide.type] || icons.text;
      
      return `
        <div class="slide-item">
          <div style="display:flex;align-items:center;flex:1;gap:1rem">
            <div class="slide-type-icon ${slide.type}" style="background:${type.bg};color:${type.color}">
              ${type.icon}
            </div>
            <div style="flex:1">
              <div style="font-weight:700">${idx + 1}. ${slide.title}</div>
              <div style="font-size:.85rem;color:var(--muted)">
                ${slide.type === 'text' ? 'Text-Folie' : 
                  slide.type === 'image' ? 'Bild-Folie' : 
                  slide.type === 'video' ? 'Video-Folie' : 'Quiz-Folie'}
                ‚Ä¢ ${slide.duration || 5} Min.
              </div>
            </div>
          </div>
          <div style="display:flex;gap:4px">
            <button class="btn btn-sm" onclick="editSlide('${slide.id}')">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm danger" onclick="deleteSlide('${slide.id}')">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      `;
    }).join('');
  }

  window.openNewSlideModal = () => {
    currentEditSlide = null;
    document.getElementById('newSlideForm').reset();
    document.getElementById('slide-type').value = 'text';
    quizAnswers = [];
    updateSlideTypeFields();
    
    if (slideContentEditor) {
      slideContentEditor.root.innerHTML = '';
    } else {
      slideContentEditor = new Quill('#slide-content-editor', {
        theme: 'snow',
        modules: {
          toolbar: [
            ['bold', 'italic', 'underline'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            ['link'],
            ['clean']
          ]
        }
      });
    }
    
    document.getElementById('newSlideModal').classList.add('show');
  };

  window.closeNewSlideModal = () => {
    document.getElementById('newSlideModal').classList.remove('show');
  };

  window.updateSlideTypeFields = () => {
    const type = document.getElementById('slide-type').value;
    
    document.getElementById('text-slide-fields').style.display = type === 'text' ? 'block' : 'none';
    document.getElementById('image-slide-fields').style.display = type === 'image' ? 'block' : 'none';
    document.getElementById('video-slide-fields').style.display = type === 'video' ? 'block' : 'none';
    document.getElementById('quiz-slide-fields').style.display = type === 'quiz' ? 'block' : 'none';
    
    if (type === 'quiz' && quizAnswers.length === 0) {
      addQuizAnswer();
      addQuizAnswer();
    }
  };

  window.addQuizAnswer = () => {
    quizAnswers.push({ text: '', correct: false });
    renderQuizAnswers();
  };

  function renderQuizAnswers() {
    const list = document.getElementById('quiz-answers-list');
    list.innerHTML = quizAnswers.map((answer, idx) => `
      <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
        <input type="checkbox" ${answer.correct ? 'checked' : ''} 
          onchange="toggleQuizAnswerCorrect(${idx})"
          style="width:20px;height:20px;cursor:pointer">
        <input type="text" value="${answer.text}" 
          oninput="updateQuizAnswerText(${idx}, this.value)"
          placeholder="Antwort ${idx + 1}"
          style="flex:1;padding:8px;border:1px solid var(--border);border-radius:6px">
        <button type="button" class="btn btn-sm danger" onclick="removeQuizAnswer(${idx})">
          <i class="fas fa-times"></i>
        </button>
      </div>
    `).join('');
  }

  window.toggleQuizAnswerCorrect = (idx) => {
    quizAnswers[idx].correct = !quizAnswers[idx].correct;
  };

  window.updateQuizAnswerText = (idx, text) => {
    quizAnswers[idx].text = text;
  };

  window.removeQuizAnswer = (idx) => {
    quizAnswers.splice(idx, 1);
    renderQuizAnswers();
  };

  window.saveSlide = async () => {
    try {
      const type = document.getElementById('slide-type').value;
      const title = document.getElementById('slide-title').value.trim();
      const duration = parseInt(document.getElementById('slide-duration').value) || 5;
      
      if (!title) {
        showMsg('Bitte Titel eingeben', 'error');
        return;
      }
      
      let content = {};
      
      if (type === 'text') {
        content = { html: slideContentEditor.root.innerHTML };
      } else if (type === 'image') {
        content = {
          url: document.getElementById('slide-image-url').value.trim(),
          description: document.getElementById('slide-image-description').value.trim()
        };
      } else if (type === 'video') {
        content = {
          url: document.getElementById('slide-video-url').value.trim(),
          description: document.getElementById('slide-video-description').value.trim()
        };
      } else if (type === 'quiz') {
        const question = document.getElementById('slide-quiz-question').value.trim();
        const explanation = document.getElementById('slide-quiz-explanation').value.trim();
        
        if (!question) {
          showMsg('Bitte Frage eingeben', 'error');
          return;
        }
        
        const validAnswers = quizAnswers.filter(a => a.text.trim());
        if (validAnswers.length < 2) {
          showMsg('Bitte mindestens 2 Antworten eingeben', 'error');
          return;
        }
        
        if (!validAnswers.some(a => a.correct)) {
          showMsg('Bitte mindestens eine richtige Antwort markieren', 'error');
          return;
        }
        
        content = {
          question,
          answers: validAnswers,
          explanation
        };
      }
      
      const data = {
        module_id: currentLearningModule,
        type,
        title,
        content,
        duration,
        order: currentSlides.length,
        organization_id: currentUser.organization_id
      };
      
      if (currentEditSlide) {
        await pb.collection('learning_slides').update(currentEditSlide, data);
        showMsg('‚úÖ Folie aktualisiert!');
      } else {
        await pb.collection('learning_slides').create(data);
        showMsg('‚úÖ Folie erstellt!');
      }
      
      closeNewSlideModal();
      await openSlideEditor(currentLearningModule);
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.editSlide = async (slideId) => {
    try {
      const slide = await pb.collection('learning_slides').getOne(slideId);
      currentEditSlide = slideId;
      
      document.getElementById('slide-type').value = slide.type;
      document.getElementById('slide-title').value = slide.title;
      document.getElementById('slide-duration').value = slide.duration || 5;
      
      updateSlideTypeFields();
      
      if (slide.type === 'text') {
        if (!slideContentEditor) {
          slideContentEditor = new Quill('#slide-content-editor', {
            theme: 'snow',
            modules: {
              toolbar: [
                ['bold', 'italic', 'underline'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['link'],
                ['clean']
              ]
            }
          });
        }
        slideContentEditor.root.innerHTML = slide.content.html || '';
      } else if (slide.type === 'image') {
        document.getElementById('slide-image-url').value = slide.content.url || '';
        document.getElementById('slide-image-description').value = slide.content.description || '';
      } else if (slide.type === 'video') {
        document.getElementById('slide-video-url').value = slide.content.url || '';
        document.getElementById('slide-video-description').value = slide.content.description || '';
      } else if (slide.type === 'quiz') {
        document.getElementById('slide-quiz-question').value = slide.content.question || '';
        document.getElementById('slide-quiz-explanation').value = slide.content.explanation || '';
        quizAnswers = slide.content.answers || [];
        renderQuizAnswers();
      }
      
      document.getElementById('newSlideModal').classList.add('show');
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.deleteSlide = async (slideId) => {
    if (!confirm('Folie wirklich l√∂schen?')) return;
    
    try {
      await pb.collection('learning_slides').delete(slideId);
      showMsg('‚úÖ Folie gel√∂scht!');
      await openSlideEditor(currentLearningModule);
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  // ========================================
  // MODUL-VORSCHAU
  // ========================================
  window.previewModule = async (moduleId) => {
    try {
      const module = await pb.collection('learning_modules').getOne(moduleId);
      previewSlides = await pb.collection('learning_slides').getFullList({
        filter: `module_id = "${moduleId}"`,
        sort: 'order'
      });
      
      if (previewSlides.length === 0) {
        showMsg('Keine Folien zum Anzeigen', 'info');
        return;
      }
      
      currentPreviewIndex = 0;
      document.getElementById('previewModuleTitle').textContent = `Vorschau: ${module.title}`;
      renderPreviewSlide();
      document.getElementById('modulePreviewModal').classList.add('show');
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  function renderPreviewSlide() {
    const slide = previewSlides[currentPreviewIndex];
    const content = document.getElementById('previewContent');
    
    document.getElementById('slideCounter').textContent = 
      `${currentPreviewIndex + 1} / ${previewSlides.length}`;
    
    document.getElementById('prevSlideBtn').disabled = currentPreviewIndex === 0;
    document.getElementById('nextSlideBtn').disabled = currentPreviewIndex === previewSlides.length - 1;
    
    let html = `
      <div style="background:white;padding:2rem;border-radius:0.75rem;min-height:400px">
        <h2 style="color:var(--primary);margin-bottom:1.5rem;font-size:1.75rem">
          ${slide.title}
        </h2>
    `;
    
    if (slide.type === 'text') {
      html += `
        <div style="line-height:1.8;font-size:1.1rem">
          ${slide.content.html || ''}
        </div>
      `;
    } else if (slide.type === 'image') {
      html += `
        <div style="text-align:center">
          <img src="${slide.content.url}" alt="${slide.content.description}" 
            style="max-width:100%;max-height:500px;border-radius:0.75rem;box-shadow:0 4px 12px rgba(0,0,0,0.1)">
          ${slide.content.description ? `
            <p style="margin-top:1rem;color:var(--muted);font-style:italic">
              ${slide.content.description}
            </p>
          ` : ''}
        </div>
      `;
    } else if (slide.type === 'video') {
      const videoId = extractVideoId(slide.content.url);
      html += `
        <div style="text-align:center">
          <div style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:0.75rem">
            <iframe 
              src="https://www.youtube.com/embed/${videoId}" 
              style="position:absolute;top:0;left:0;width:100%;height:100%;border:0"
              allowfullscreen>
            </iframe>
          </div>
          ${slide.content.description ? `
            <p style="margin-top:1rem;color:var(--muted)">
              ${slide.content.description}
            </p>
          ` : ''}
        </div>
      `;
    } else if (slide.type === 'quiz') {
      html += `
        <div style="background:#f9fafb;padding:1.5rem;border-radius:0.75rem;margin-bottom:1.5rem">
          <h3 style="color:var(--text);margin-bottom:1rem;font-size:1.25rem">
            ${slide.content.question}
          </h3>
          <div style="display:flex;flex-direction:column;gap:0.75rem">
      `;
      
      slide.content.answers.forEach((answer, idx) => {
        html += `
          <div style="padding:1rem;background:white;border:2px solid ${answer.correct ? '#16a34a' : '#e5e7eb'};border-radius:0.5rem;cursor:pointer;transition:all 0.2s">
            <div style="display:flex;align-items:center;gap:0.75rem">
              <div style="width:1.5rem;height:1.5rem;border-radius:50%;background:${answer.correct ? '#16a34a' : '#e5e7eb'};color:white;display:flex;align-items:center;justify-content:center;font-weight:700">
                ${answer.correct ? '‚úì' : String.fromCharCode(65 + idx)}
              </div>
              <div style="flex:1;font-weight:${answer.correct ? '700' : '400'}">${answer.text}</div>
            </div>
          </div>
        `;
      });
      
      html += `
          </div>
          ${slide.content.explanation ? `
            <div style="margin-top:1rem;padding:1rem;background:#dcfce7;border-left:4px solid #16a34a;border-radius:0.5rem">
              <div style="font-weight:700;color:#166534;margin-bottom:0.5rem">
                <i class="fas fa-lightbulb"></i> Erkl√§rung:
              </div>
              <div style="color:#166534">${slide.content.explanation}</div>
            </div>
          ` : ''}
        </div>
      `;
    }
    
    html += '</div>';
    content.innerHTML = html;
  }

  function extractVideoId(url) {
    const match = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\s]+)/);
    return match ? match[1] : '';
  }

  window.prevPreviewSlide = () => {
    if (currentPreviewIndex > 0) {
      currentPreviewIndex--;
      renderPreviewSlide();
    }
  };

  window.nextPreviewSlide = () => {
    if (currentPreviewIndex < previewSlides.length - 1) {
      currentPreviewIndex++;
      renderPreviewSlide();
    }
  };

  window.closePreviewModal = () => {
    document.getElementById('modulePreviewModal').classList.remove('show');
    previewSlides = [];
    currentPreviewIndex = 0;
  };

  // ========================================
  // MODAL CLOSE ON OUTSIDE CLICK
  // ========================================
  document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.classList.remove('show');
    });
  });

  // ========================================
  // PREVIEW CODE GENERATION (DUMMY)
  // ========================================
  function generatePreviewCode() {
    // Placeholder f√ºr zuk√ºnftige Funktionalit√§t
  }

</script>
</body>
</html>
