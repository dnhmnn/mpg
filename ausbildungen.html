<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ausbildungsverwaltung ‚Äì Responda</title>
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/pocketbase@0.21.3/dist/pocketbase.umd.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs@0.0.2/qrcode.min.js"></script>
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <style>
    :root{
      --primary:#c8102e;
      --primary-light:#fee2e2;
      --success:#16a34a;
      --warning:#f59e0b;
      --info:#3b82f6;
      --danger:#dc2626;
      --bg:#f8fafc;
      --card:#fff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --gradient-start:#667eea;
      --gradient-end:#764ba2;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      background:linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
      min-height:100vh;
      color:var(--text);
      font-family:'Atkinson Hyperlegible',-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      line-height:1.6;
      opacity:0;
      transition:opacity 0.3s ease;
    }
    body.loaded{opacity:1}
    
    .container{
      max-width:1400px;
      margin:0 auto;
      padding:20px;
    }
    
    .header{
      background:rgba(255,255,255,0.95);
      backdrop-filter:blur(10px);
      border-radius:16px;
      padding:1.5rem 2rem;
      margin-bottom:2rem;
      box-shadow:0 4px 16px rgba(0,0,0,0.1);
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:1rem;
    }
    .header h1{
      font-size:1.8rem;
      font-weight:800;
      color:var(--primary);
      display:flex;
      align-items:center;
      gap:0.75rem;
    }
    .header-actions{
      display:flex;
      gap:0.75rem;
      align-items:center;
    }
    
    .tabs{
      background:rgba(255,255,255,0.95);
      backdrop-filter:blur(10px);
      border-radius:16px;
      padding:1rem;
      margin-bottom:2rem;
      box-shadow:0 4px 16px rgba(0,0,0,0.1);
      display:flex;
      gap:0.5rem;
      overflow-x:auto;
    }
    .tab{
      padding:0.75rem 1.5rem;
      border:none;
      background:transparent;
      color:var(--muted);
      font-weight:700;
      font-size:1rem;
      cursor:pointer;
      border-radius:8px;
      transition:all 0.2s;
      white-space:nowrap;
      font-family:inherit;
    }
    .tab:hover{
      background:var(--bg);
      color:var(--text);
    }
    .tab.active{
      background:var(--primary);
      color:#fff;
    }
    
    .tab-content{
      display:none;
    }
    .tab-content.active{
      display:block;
    }
    
    .section-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:1.5rem;
      flex-wrap:wrap;
      gap:1rem;
    }
    .section-header h2{
      font-size:1.5rem;
      font-weight:800;
      color:var(--text);
    }
    
    .btn{
      padding:0.75rem 1.5rem;
      border:none;
      border-radius:8px;
      font-weight:700;
      cursor:pointer;
      transition:all 0.2s;
      font-family:inherit;
      font-size:1rem;
      display:inline-flex;
      align-items:center;
      gap:0.5rem;
    }
    .btn:hover{
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
    }
    .btn.primary{
      background:var(--primary);
      color:#fff;
      border:2px solid var(--primary);
    }
    .btn.primary:hover{
      background:#a50d25;
    }
    .btn.success{
      background:var(--success);
      color:#fff;
      border:2px solid var(--success);
    }
    .btn.info{
      background:var(--info);
      color:#fff;
      border:2px solid var(--info);
    }
    .btn.danger{
      background:var(--danger);
      color:#fff;
      border:2px solid var(--danger);
    }
    .btn.btn-sm{
      padding:0.5rem 1rem;
      font-size:0.875rem;
    }
    
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(350px,1fr));
      gap:1.5rem;
    }
    
    .course-card,.member-card,.module-card{
      background:#fff;
      border-radius:12px;
      padding:1.5rem;
      box-shadow:0 2px 8px rgba(0,0,0,0.08);
      transition:all 0.2s;
      cursor:pointer;
      border:2px solid transparent;
    }
    .course-card:hover,.member-card:hover,.module-card:hover{
      transform:translateY(-4px);
      box-shadow:0 8px 24px rgba(0,0,0,0.15);
      border-color:var(--primary);
    }
    
    .card-title{
      font-size:1.2rem;
      font-weight:800;
      color:var(--text);
      margin-bottom:0.75rem;
      display:flex;
      align-items:center;
      gap:0.5rem;
    }
    .card-title i{
      color:var(--primary);
    }
    
    .card-meta{
      display:flex;
      gap:1rem;
      flex-wrap:wrap;
      font-size:0.9rem;
      color:var(--muted);
      margin-top:0.75rem;
    }
    .card-meta span{
      display:flex;
      align-items:center;
      gap:0.25rem;
    }
    
    .badge{
      display:inline-block;
      padding:0.25rem 0.75rem;
      border-radius:12px;
      font-size:0.85rem;
      font-weight:700;
    }
    .badge.info{
      background:#dbeafe;
      color:#1e40af;
    }
    .badge.success{
      background:#dcfce7;
      color:#166534;
    }
    .badge.warning{
      background:#fef3c7;
      color:#92400e;
    }
    .badge.danger{
      background:#fee2e2;
      color:#991b1b;
    }
    .badge.geplant{
      background:#dbeafe;
      color:#1e40af;
    }
    .badge.eingeladen{
      background:#fef3c7;
      color:#92400e;
    }
    .badge.zugesagt{
      background:#dcfce7;
      color:#166534;
    }
    .badge.abgesagt{
      background:#fee2e2;
      color:#991b1b;
    }
    .badge.anwesend{
      background:#dcfce7;
      color:#166534;
    }
    .badge.abwesend{
      background:#fee2e2;
      color:#991b1b;
    }
    .badge.online{
      background:#dcfce7;
      color:#166534;
    }
    
    .tag{
      display:inline-block;
      padding:0.25rem 0.75rem;
      background:#f3f4f6;
      border-radius:12px;
      font-size:0.85rem;
      color:#4b5563;
      margin-right:0.5rem;
      margin-bottom:0.5rem;
    }
    
    .empty{
      text-align:center;
      padding:4rem 2rem;
      color:var(--muted);
    }
    .empty i{
      font-size:4rem;
      opacity:0.3;
      margin-bottom:1rem;
    }
    
    .modal{
      display:none;
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.6);
      backdrop-filter:blur(4px);
      z-index:1000;
      padding:20px;
      overflow-y:auto;
    }
    .modal.show{
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .modal-box{
      background:#fff;
      border-radius:16px;
      max-width:800px;
      width:100%;
      max-height:90vh;
      overflow-y:auto;
      box-shadow:0 20px 60px rgba(0,0,0,0.3);
    }
    .modal-header{
      padding:1.5rem 2rem;
      border-bottom:2px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .modal-header h3{
      font-size:1.5rem;
      font-weight:800;
      color:var(--text);
      display:flex;
      align-items:center;
      gap:0.5rem;
    }
    .modal-body{
      padding:2rem;
    }
    .modal-footer{
      padding:1.5rem 2rem;
      border-top:2px solid var(--border);
      display:flex;
      justify-content:flex-end;
      gap:0.75rem;
    }
    
    .form-group{
      margin-bottom:1.5rem;
    }
    .form-group label{
      display:block;
      font-weight:700;
      margin-bottom:0.5rem;
      color:#374151;
    }
    .form-group input,.form-group select,.form-group textarea{
      width:100%;
      padding:0.75rem;
      border:2px solid var(--border);
      border-radius:8px;
      font-family:inherit;
      font-size:1rem;
    }
    .form-group input:focus,.form-group select:focus,.form-group textarea:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(200,16,46,0.1);
    }
    .form-group textarea{
      resize:vertical;
      min-height:100px;
    }
    
    .form-row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:1rem;
    }
    
    .tag-input-wrapper{
      display:flex;
      flex-wrap:wrap;
      gap:0.5rem;
      padding:0.5rem;
      border:2px solid var(--border);
      border-radius:8px;
      min-height:50px;
      cursor:text;
    }
    .tag-input-wrapper:focus-within{
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(200,16,46,0.1);
    }
    .tag-input-wrapper input{
      flex:1;
      border:none;
      outline:none;
      padding:0.25rem;
      min-width:150px;
      font-family:inherit;
    }
    .tag-item{
      display:inline-flex;
      align-items:center;
      gap:0.5rem;
      padding:0.25rem 0.75rem;
      background:var(--primary);
      color:#fff;
      border-radius:12px;
      font-size:0.85rem;
    }
    .tag-item button{
      background:none;
      border:none;
      color:#fff;
      cursor:pointer;
      padding:0;
      font-size:1rem;
    }
    
    .copy-box{
      display:flex;
      align-items:center;
      gap:0.5rem;
      padding:0.75rem;
      background:#f9fafb;
      border:2px solid var(--border);
      border-radius:8px;
    }
    
    .table{
      width:100%;
      border-collapse:collapse;
      margin-top:1rem;
    }
    .table th{
      background:#f9fafb;
      padding:0.75rem;
      text-align:left;
      font-weight:700;
      border-bottom:2px solid var(--border);
    }
    .table td{
      padding:0.75rem;
      border-bottom:1px solid var(--border);
    }
    .table tr:hover{
      background:#f9fafb;
    }
    
    .details-section{
      margin-bottom:2rem;
      padding:1.5rem;
      background:#f9fafb;
      border-radius:8px;
    }
    .details-section h4{
      font-size:1.1rem;
      font-weight:800;
      margin-bottom:1rem;
      color:var(--text);
      display:flex;
      align-items:center;
      gap:0.5rem;
    }
    
    .slide-item{
      padding:1rem;
      background:#fff;
      border-left:4px solid var(--primary);
      border-radius:8px;
      margin-bottom:0.75rem;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:1rem;
    }
    
    .slide-type-icon{
      width:40px;
      height:40px;
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1.2rem;
    }
    .slide-type-icon.text{background:#dbeafe}
    .slide-type-icon.image{background:#fce7f3}
    .slide-type-icon.video{background:#fef3c7}
    .slide-type-icon.quiz{background:#dcfce7}
    
    .progress-bar{
      width:100%;
      height:8px;
      background:#e5e7eb;
      border-radius:4px;
      overflow:hidden;
    }
    .progress-bar-fill{
      height:100%;
      background:var(--primary);
      transition:width 0.3s;
    }
    
    .message{
      position:fixed;
      top:20px;
      right:-400px;
      background:#fff;
      padding:1rem 1.5rem;
      border-radius:8px;
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
      z-index:2000;
      transition:right 0.3s ease;
      max-width:400px;
      border-left:4px solid var(--primary);
    }
    .message.show{
      right:20px;
    }
    .message.error{
      border-left-color:var(--danger);
    }
    
    @media (max-width:768px){
      .header{
        padding:1rem;
      }
      .header h1{
        font-size:1.3rem;
      }
      .grid{
        grid-template-columns:1fr;
      }
      .form-row{
        grid-template-columns:1fr;
      }
      .tabs{
        padding:0.5rem;
      }
      .tab{
        padding:0.5rem 1rem;
        font-size:0.9rem;
      }
    }
  </style>
</head>

<body>

<div class="container">
  <div class="header">
    <h1><i class="fa-solid fa-graduation-cap"></i> Ausbildungsverwaltung</h1>
    <div class="header-actions">
      <button class="btn" onclick="location.href='mpg-dashboard.html'">
        <i class="fas fa-arrow-left"></i> Dashboard
      </button>
      <button class="btn primary" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Abmelden
      </button>
    </div>
  </div>
  
  <div class="tabs">
    <button class="tab active" onclick="switchTab('ausbildungen')">
      <i class="fa-solid fa-book-medical"></i> Ausbildungen
    </button>
    <button class="tab" onclick="switchTab('team')">
      <i class="fa-solid fa-users"></i> Team
    </button>
    <button class="tab" onclick="switchTab('lernbereich')">
      <i class="fa-solid fa-laptop"></i> Lernbereich
    </button>
    <button class="tab" onclick="switchTab('einstellungen')">
      <i class="fa-solid fa-cog"></i> Einstellungen
    </button>
  </div>
  
  <!-- AUSBILDUNGEN TAB -->
  <div id="ausbildungen-tab" class="tab-content active">
    <div class="section-header">
      <h2>Schulungen & Termine</h2>
      <button class="btn primary" onclick="openSchulungModal()">
        <i class="fas fa-plus"></i> Neue Schulung
      </button>
    </div>
    <div id="schulungen-list" class="grid">
      <div class="empty">
        <i class="fas fa-spinner fa-spin"></i>
        <div>L√§dt...</div>
      </div>
    </div>
  </div>
  
  <!-- TEAM TAB -->
  <div id="team-tab" class="tab-content">
    <div class="section-header">
      <h2>Team-Mitglieder</h2>
      <div style="display:flex;gap:0.5rem">
        <button class="btn success" onclick="exportAllMembersStats()">
          <i class="fas fa-file-export"></i> Gesamtauswertung
        </button>
        <button class="btn primary" onclick="openMemberModal()">
          <i class="fas fa-user-plus"></i> Mitglied hinzuf√ºgen
        </button>
      </div>
    </div>
    <div id="team-list" class="grid"></div>
  </div>
  
  <!-- LERNBEREICH TAB -->
  <div id="lernbereich-tab" class="tab-content">
    <div class="section-header">
      <h2>Lernmodule</h2>
      <button class="btn primary" onclick="openModuleModal()">
        <i class="fas fa-plus"></i> Neues Modul
      </button>
    </div>
    <div id="lernbereich-list" class="grid"></div>
  </div>
  
  <!-- EINSTELLUNGEN TAB -->
  <div id="einstellungen-tab" class="tab-content">
    <div class="section-header">
      <h2>Externe Zug√§nge</h2>
      <div style="display:flex;gap:0.5rem">
        <button class="btn success" onclick="exportAccessCodes()">
          <i class="fas fa-file-csv"></i> CSV Export
        </button>
        <button class="btn info" onclick="openBulkAccessModal()">
          <i class="fas fa-users"></i> Mehrere erstellen
        </button>
        <button class="btn primary" onclick="openSingleAccessModal()">
          <i class="fas fa-key"></i> Einzelnen erstellen
        </button>
      </div>
    </div>
    
    <div style="background:#fff;border-radius:12px;padding:1.5rem;margin-bottom:2rem;box-shadow:0 2px 8px rgba(0,0,0,0.08)">
      <h3 style="margin-bottom:1rem">
        <i class="fa-solid fa-graduation-cap"></i> Pflicht-Schulungen pro Jahr
      </h3>
      <div class="form-group">
        <label>Anzahl der erforderlichen Schulungen</label>
        <input type="number" id="pflicht-schulungen-input" min="0" value="12">
      </div>
      <button class="btn primary" onclick="savePflichtSchulungen()">
        <i class="fas fa-save"></i> Speichern
      </button>
    </div>
    
    <div id="access-list"></div>
  </div>
</div>
<!-- SCHULUNG MODAL -->
<div class="modal" id="schulungModal">
  <div class="modal-box">
    <div class="modal-header">
      <h3 id="schulungModalTitle"><i class="fa-solid fa-book-medical"></i> Neue Schulung erstellen</h3>
      <button class="btn btn-sm" onclick="closeSchulungModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <form id="schulungForm">
      <div class="modal-body">
        <div class="form-group">
          <label>Titel *</label>
          <input type="text" name="title" required placeholder="z.B. Hygieneschulung 2024">
        </div>
        
        <div class="form-group">
          <label>Beschreibung</label>
          <textarea name="description" placeholder="Kurze Beschreibung der Schulung"></textarea>
        </div>
        
        <h4 style="margin:2rem 0 1rem;padding-top:1.5rem;border-top:2px solid var(--border)">
          <i class="fa-solid fa-calendar"></i> Erster Termin
        </h4>
        
        <div class="form-row">
          <div class="form-group">
            <label>Datum *</label>
            <input type="date" name="date" required>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Startzeit</label>
            <input type="time" name="start_time">
          </div>
          <div class="form-group">
            <label>Endzeit</label>
            <input type="time" name="end_time">
          </div>
        </div>
        
        <div class="form-group">
          <label>Ort</label>
          <input type="text" name="location" placeholder="z.B. Schulungsraum 1">
        </div>
        
        <div class="form-group">
          <label>Dozent</label>
          <input type="text" name="instructor" placeholder="Name des Dozenten">
        </div>
        
        <div class="form-group">
          <label>Teilnehmer ausw√§hlen (<span id="selected-count">0</span> ausgew√§hlt)</label>
          <button type="button" class="btn info" onclick="openParticipantSelector()">
            <i class="fas fa-users"></i> Teilnehmer ausw√§hlen
          </button>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn" onclick="closeSchulungModal()">Abbrechen</button>
        <button type="submit" class="btn primary">
          <i class="fas fa-save"></i> Erstellen
        </button>
      </div>
    </form>
  </div>
</div>

<!-- SCHULUNG DETAILS MODAL -->
<div class="modal" id="schulungDetailsModal">
  <div class="modal-box">
    <div class="modal-header">
      <h3 id="schulungDetailsTitle">Schulung</h3>
      <button class="btn btn-sm" onclick="closeSchulungDetailsModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body" id="schulungDetailsBody"></div>
  </div>
</div>

<!-- TERMIN HINZUF√úGEN MODAL -->
<div class="modal" id="addSessionModal">
  <div class="modal-box">
    <div class="modal-header">
      <h3><i class="fa-solid fa-calendar-plus"></i> Weiteren Termin hinzuf√ºgen</h3>
      <button class="btn btn-sm" onclick="closeAddSessionModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <form id="addSessionForm">
      <input type="hidden" id="add-session-course-id">
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group">
            <label>Datum *</label>
            <input type="date" name="date" required>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Startzeit</label>
            <input type="time" name="start_time">
          </div>
          <div class="form-group">
            <label>Endzeit</label>
            <input type="time" name="end_time">
          </div>
        </div>
        
        <div class="form-group">
          <label>Ort</label>
          <input type="text" name="location" placeholder="z.B. Schulungsraum 1">
        </div>
        
        <div class="form-group">
          <label>Dozent</label>
          <input type="text" name="dozent" placeholder="Name des Dozenten">
        </div>
        
        <div class="form-group">
          <label>Beschreibung</label>
          <textarea name="beschreibung" placeholder="Zus√§tzliche Informationen zum Termin"></textarea>
        </div>
        
        <div class="form-group">
          <label>Teilnehmer ausw√§hlen (<span id="add-selected-count">0</span> ausgew√§hlt)</label>
          <button type="button" class="btn info" onclick="openParticipantSelectorForAdd()">
            <i class="fas fa-users"></i> Teilnehmer ausw√§hlen
          </button>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn" onclick="closeAddSessionModal()">Abbrechen</button>
        <button type="submit" class="btn primary">
          <i class="fas fa-save"></i> Termin hinzuf√ºgen
        </button>
      </div>
    </form>
  </div>
</div>

<!-- TERMIN BEARBEITEN MODAL -->
<div class="modal" id="editSessionModal">
  <div class="modal-box">
    <div class="modal-header">
      <h3><i class="fa-solid fa-calendar-edit"></i> Termin bearbeiten</h3>
      <button class="btn btn-sm" onclick="closeEditSessionModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <form id="editSessionForm">
      <input type="hidden" id="edit-session-id">
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group">
            <label>Datum *</label>
            <input type="date" id="edit-session-date" required>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Startzeit</label>
            <input type="time" id="edit-session-start">
          </div>
          <div class="form-group">
            <label>Endzeit</label>
            <input type="time" id="edit-session-end">
          </div>
        </div>
        
        <div class="form-group">
          <label>Ort</label>
          <input type="text" id="edit-session-location" placeholder="z.B. Schulungsraum 1">
        </div>
        
        <div class="form-group">
          <label>Dozent</label>
          <input type="text" id="edit-session-dozent" placeholder="Name des Dozenten">
        </div>
        
        <div class="form-group">
          <label>Beschreibung</label>
          <textarea id="edit-session-beschreibung" placeholder="Zus√§tzliche Informationen"></textarea>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn" onclick="closeEditSessionModal()">Abbrechen</button>
        <button type="submit" class="btn primary">
          <i class="fas fa-save"></i> Speichern
        </button>
      </div>
    </form>
  </div>
</div>

<!-- TEILNEHMER AUSWAHL MODAL -->
<div class="modal" id="participantModal">
  <div class="modal-box">
    <div class="modal-header">
      <h3><i class="fa-solid fa-users"></i> Teilnehmer ausw√§hlen</h3>
      <button class="btn btn-sm" onclick="closeParticipantModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div id="participantList"></div>
    </div>
    <div class="modal-footer">
      <button class="btn primary" onclick="closeParticipantModal()">
        <i class="fas fa-check"></i> Fertig
      </button>
    </div>
  </div>
</div>

<!-- SESSION DETAILS MODAL -->
<div class="modal" id="sessionDetailsModal">
  <div class="modal-box">
    <div class="modal-header">
      <h3 id="sessionDetailsTitle">Termin-Details</h3>
      <button class="btn btn-sm" onclick="closeSessionDetailsModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body" id="sessionDetailsBody"></div>
    <div class="modal-footer">
      <button class="btn success" onclick="saveAttendance()">
        <i class="fas fa-save"></i> Anwesenheit speichern
      </button>
      <button class="btn" onclick="closeSessionDetailsModal()">
        <i class="fas fa-times"></i> Schlie√üen
      </button>
    </div>
  </div>
</div>

<!-- TEAM MEMBER MODAL -->
<div class="modal" id="memberModal">
  <div class="modal-box">
    <div class="modal-header">
      <h3 id="memberModalTitle"><i class="fa-solid fa-user-plus"></i> Neues Team-Mitglied</h3>
      <button class="btn btn-sm" onclick="closeMemberModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <form id="memberForm">
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group">
            <label>Vorname *</label>
            <input type="text" name="vorname" required>
          </div>
          <div class="form-group">
            <label>Nachname *</label>
            <input type="text" name="name" required>
          </div>
        </div>
        
        <div class="form-group">
          <label>Qualifikationen</label>
          <div class="tag-input-wrapper" id="tag-input-wrapper">
            <input type="text" id="tag-input" placeholder="Qualifikation eingeben und Enter dr√ºcken">
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn" onclick="closeMemberModal()">Abbrechen</button>
        <button type="submit" class="btn primary">
          <i class="fas fa-save"></i> Speichern
        </button>
      </div>
    </form>
  </div>
</div>

<!-- MEMBER DETAILS MODAL -->
<div class="modal" id="memberDetailsModal">
  <div class="modal-box">
    <div class="modal-header">
      <h3 id="memberDetailsTitle">Mitglied-Details</h3>
      <button class="btn btn-sm" onclick="closeMemberDetailsModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body" id="memberDetailsBody"></div>
  </div>
</div>

<!-- ZUGANG F√úR MEMBER ERSTELLEN -->
<div class="modal" id="createAccessForMemberModal">
  <div class="modal-box">
    <div class="modal-header">
      <h3><i class="fa-solid fa-key"></i> Zugang erstellen</h3>
      <button class="btn btn-sm" onclick="closeCreateAccessForMemberModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <p style="margin-bottom:1.5rem">
        Zugang erstellen f√ºr: <strong id="access-member-name"></strong>
      </p>
      
      <div style="background:#f0fdf4;padding:1.5rem;border-radius:8px;border:2px solid #86efac;text-align:center">
        <div style="font-size:0.9rem;color:#166534;margin-bottom:0.5rem">Generierter Zugangscode:</div>
        <div style="font-size:2rem;font-weight:800;color:var(--primary);font-family:monospace" id="member-access-code"></div>
      </div>
      
      <p style="margin-top:1rem;font-size:0.9rem;color:var(--muted)">
        <i class="fas fa-info-circle"></i> Dieser Code kann f√ºr den Login verwendet werden.
      </p>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeCreateAccessForMemberModal()">Abbrechen</button>
      <button class="btn primary" onclick="saveAccessForMember()">
        <i class="fas fa-save"></i> Zugang erstellen
      </button>
    </div>
  </div>
</div>

<!-- EINZELNER ZUGANG -->
<div class="modal" id="singleAccessModal">
  <div class="modal-box">
    <div class="modal-header">
      <h3><i class="fa-solid fa-key"></i> Einzelnen Zugang erstellen</h3>
      <button class="btn btn-sm" onclick="closeSingleAccessModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <form id="singleAccessForm">
      <div class="modal-body">
        <div class="form-group">
          <label>Name *</label>
          <input type="text" name="name" required placeholder="Vor- und Nachname">
        </div>
        
        <div style="background:#f0fdf4;padding:1.5rem;border-radius:8px;border:2px solid #86efac;text-align:center;margin-top:1rem">
          <div style="font-size:0.9rem;color:#166534;margin-bottom:0.5rem">Generierter Zugangscode:</div>
          <div style="font-size:2rem;font-weight:800;color:var(--primary);font-family:monospace" id="preview-access-code"></div>
          <button type="button" class="btn btn-sm" onclick="generatePreviewCode()" style="margin-top:0.75rem">
            <i class="fas fa-refresh"></i> Neuen Code generieren
          </button>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn" onclick="closeSingleAccessModal()">Abbrechen</button>
        <button type="submit" class="btn primary">
          <i class="fas fa-save"></i> Erstellen
        </button>
      </div>
    </form>
  </div>
</div>

<!-- MEHRERE ZUG√ÑNGE -->
<div class="modal" id="bulkAccessModal">
  <div class="modal-box">
    <div class="modal-header">
      <h3><i class="fa-solid fa-users"></i> Mehrere Zug√§nge erstellen</h3>
      <button class="btn btn-sm" onclick="closeBulkAccessModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <form id="bulkAccessForm">
      <div class="modal-body">
        <div id="bulkAccessList"></div>
        <button type="button" class="btn info" onclick="addBulkAccessRow()" style="margin-top:1rem">
          <i class="fas fa-plus"></i> Weitere Person hinzuf√ºgen
        </button>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn" onclick="closeBulkAccessModal()">Abbrechen</button>
        <button type="submit" class="btn primary">
          <i class="fas fa-save"></i> Alle erstellen
        </button>
      </div>
    </form>
  </div>
</div>

<!-- LERNBEREICH MODALS -->
<div class="modal" id="moduleModal">
  <div class="modal-box">
    <div class="modal-header">
      <h3 id="moduleModalTitle"><i class="fa-solid fa-laptop"></i> Neues Lernmodul</h3>
      <button class="btn btn-sm" onclick="closeModuleModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <form id="moduleForm">
      <div class="modal-body">
        <div class="form-group">
          <label>Titel *</label>
          <input type="text" name="title" required>
        </div>
        
        <div class="form-group">
          <label>Dozent</label>
          <input type="text" name="instructor">
        </div>
        
        <div class="form-group">
          <label>Beschreibung</label>
          <textarea name="description"></textarea>
        </div>
        
        <div class="form-group">
          <label>
            <input type="checkbox" name="require_quiz" style="width:auto;margin-right:0.5rem">
            Abschlusspr√ºfung erforderlich
          </label>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Bestehensgrenze (%)</label>
            <input type="number" name="passing_score" value="80" min="0" max="100">
          </div>
          <div class="form-group">
            <label>Max. Versuche (0 = unbegrenzt)</label>
            <input type="number" name="max_attempts" value="3" min="0">
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn" onclick="closeModuleModal()">Abbrechen</button>
        <button type="submit" class="btn primary">
          <i class="fas fa-save"></i> Speichern
        </button>
      </div>
    </form>
  </div>
</div>

<div class="modal" id="moduleDetailsModal">
  <div class="modal-box">
    <div class="modal-header">
      <h3 id="moduleDetailsTitle">Modul-Details</h3>
      <button class="btn btn-sm" onclick="closeModuleDetailsModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body" id="moduleDetailsBody"></div>
  </div>
</div>

<div class="modal" id="slideEditorModal">
  <div class="modal-box" style="max-width:1200px">
    <div class="modal-header">
      <h3 id="slideEditorTitle">Folien-Editor</h3>
      <button class="btn btn-sm" onclick="closeSlideEditor()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div style="margin-bottom:1.5rem">
        <button class="btn primary" onclick="openNewSlideModal()">
          <i class="fas fa-plus"></i> Neue Folie
        </button>
      </div>
      <div id="slides-list"></div>
    </div>
  </div>
</div>

<div class="modal" id="newSlideModal">
  <div class="modal-box">
    <div class="modal-header">
      <h3><i class="fa-solid fa-layer-group"></i> Neue Folie</h3>
      <button class="btn btn-sm" onclick="closeNewSlideModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <form id="newSlideForm">
      <div class="modal-body">
        <div class="form-group">
          <label>Folien-Typ *</label>
          <select id="slide-type" onchange="updateSlideTypeFields()" required>
            <option value="text">üìù Text</option>
            <option value="image">üñºÔ∏è Bild</option>
            <option value="video">üé• Video</option>
            <option value="quiz">‚ùì Quiz</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Titel *</label>
          <input type="text" id="slide-title" required>
        </div>
        
        <div class="form-group">
          <label>Dauer (Minuten)</label>
          <input type="number" id="slide-duration" value="5" min="1">
        </div>
        
        <div id="text-slide-fields">
          <div class="form-group">
            <label>Inhalt</label>
            <div id="slide-content-editor" style="height:200px"></div>
          </div>
        </div>
        
        <div id="image-slide-fields" style="display:none">
          <div class="form-group">
            <label>Bild-URL</label>
            <input type="url" id="slide-image-url">
          </div>
          <div class="form-group">
            <label>Beschreibung</label>
            <textarea id="slide-image-description"></textarea>
          </div>
        </div>
        
        <div id="video-slide-fields" style="display:none">
          <div class="form-group">
            <label>Video-URL</label>
            <input type="url" id="slide-video-url">
          </div>
          <div class="form-group">
            <label>Beschreibung</label>
            <textarea id="slide-video-description"></textarea>
          </div>
        </div>
        
        <div id="quiz-slide-fields" style="display:none">
          <div class="form-group">
            <label>Frage</label>
            <textarea id="slide-quiz-question"></textarea>
          </div>
          <div class="form-group">
            <label>Antworten</label>
            <div id="quiz-answers-list"></div>
            <button type="button" class="btn btn-sm info" onclick="addQuizAnswer()">
              <i class="fas fa-plus"></i> Antwort hinzuf√ºgen
            </button>
          </div>
          <div class="form-group">
            <label>Erkl√§rung</label>
            <textarea id="slide-quiz-explanation"></textarea>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn" onclick="closeNewSlideModal()">Abbrechen</button>
        <button type="button" class="btn primary" onclick="saveSlide()">
          <i class="fas fa-save"></i> Speichern
        </button>
      </div>
    </form>
  </div>
</div>

<div class="modal" id="modulePreviewModal">
  <div class="modal-box" style="max-width:1000px">
    <div class="modal-header">
      <h3 id="previewModuleTitle">Modul-Vorschau</h3>
      <button class="btn btn-sm" onclick="closePreviewModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div id="previewContent"></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:2rem;padding-top:1rem;border-top:2px solid var(--border)">
        <button class="btn" id="prevSlideBtn" onclick="prevPreviewSlide()">
          <i class="fas fa-arrow-left"></i> Zur√ºck
        </button>
        <span id="slideCounter"></span>
        <button class="btn primary" id="nextSlideBtn" onclick="nextPreviewSlide()">
          Weiter <i class="fas fa-arrow-right"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="assignMembersModal">
  <div class="modal-box">
    <div class="modal-header">
      <h3><i class="fa-solid fa-users"></i> Personen zuweisen</h3>
      <button class="btn btn-sm" onclick="closeAssignMembersModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div id="assignMembersList"></div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeAssignMembersModal()">Abbrechen</button>
      <button class="btn primary" onclick="saveAssignments()">
        <i class="fas fa-save"></i> Speichern
      </button>
    </div>
  </div>
</div>

<div class="message" id="message"></div>
<script type="module">
  const pb = new PocketBase('https://api.responda.systems');
  
  let currentUser = null;
  let allCourses = [];
  let allSessions = [];
  let allMembers = [];
  let allModules = [];
  let allAccess = [];
  
  let currentEditCourse = null;
  let currentEditMember = null;
  let currentEditModule = null;
  let currentSessionId = null;
  let currentViewCourseId = null;
  let currentLearningModule = null;
  let currentAccessMember = null;
  
  let selectedParticipants = [];
  let selectedParticipantStatus = {};
  let selectedAssignments = [];
  let currentTags = [];
  let currentSlides = [];
  let previewSlides = [];
  let currentPreviewIndex = 0;
  let quizAnswers = [];
  let slideContentEditor = null;
  let memberAccessCode = '';
  let previewAccessCode = '';
  let bulkAccessCount = 3;
  let pflichtSchulungen = 12;
  
  // ========================================
  // INIT & AUTH
  // ========================================
  async function checkAuth() {
    if (!pb.authStore.isValid) {
      location.href = 'mpg-login.html';
      return;
    }
    
    try {
      currentUser = await pb.collection('mpg_users').getOne(pb.authStore.model.id);
      
      const org = await pb.collection('organizations').getOne(currentUser.organization_id);
      pflichtSchulungen = org.pflicht_schulungen_jahr || 12;
      document.getElementById('pflicht-schulungen-input').value = pflichtSchulungen;
      
    } catch(e) {
      console.error('Auth error:', e);
      location.href = 'mpg-login.html';
    }
  }
  
  window.logout = async () => {
    pb.authStore.clear();
    location.href = 'mpg-login.html';
  };
  
  // ========================================
  // HELPER FUNCTIONS
  // ========================================
  function showMsg(msg, type = 'success') {
    const msgEl = document.getElementById('message');
    msgEl.textContent = msg;
    msgEl.className = 'message show';
    if (type === 'error') msgEl.classList.add('error');
    
    setTimeout(() => {
      msgEl.classList.remove('show');
    }, 3000);
  }
  
  function formatDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    return date.toLocaleDateString('de-DE', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
    });
  }
  
  function formatTime(timeStr) {
    if (!timeStr) return '';
    return timeStr.slice(0, 5);
  }
  
  function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
      showMsg('‚úÖ In Zwischenablage kopiert!');
    }).catch(e => {
      showMsg('Fehler beim Kopieren', 'error');
    });
  }
  
  // ========================================
  // ACCESS CODE GENERATION
  // ========================================
  const words = [
    'apfel','birne','kirsche','traube','melone','orange','pflaume','erdbeere',
    'blume','baum','wald','wiese','berg','fluss','see','meer',
    'sonne','mond','stern','wolke','regen','schnee','wind','sturm',
    'hund','katze','vogel','fisch','pferd','kuh','schaf','ziege',
    'rot','blau','gruen','gelb','orange','lila','rosa','weiss',
    'haus','tuer','fenster','dach','wand','boden','treppe','garten',
    'tisch','stuhl','bett','sofa','lampe','bild','buch','stift',
    'auto','bus','zug','flug','schiff','rad','roller','motor'
  ];
  
  function generateAccessCode() {
    const w1 = words[Math.floor(Math.random() * words.length)];
    const w2 = words[Math.floor(Math.random() * words.length)];
    const w3 = words[Math.floor(Math.random() * words.length)];
    return `${w1}-${w2}-${w3}`;
  }
  
  function generatePassword() {
    return Math.random().toString(36).slice(-12);
  }
  
  window.generatePreviewCode = () => {
    previewAccessCode = generateAccessCode();
    document.getElementById('preview-access-code').textContent = previewAccessCode;
  };
  
  // ========================================
  // TAG INPUT SYSTEM
  // ========================================
  function initTagInput() {
    const wrapper = document.getElementById('tag-input-wrapper');
    const input = document.getElementById('tag-input');
    
    if (!wrapper || !input) return;
    
    wrapper.onclick = () => input.focus();
    
    input.onkeydown = (e) => {
      if (e.key === 'Enter' || e.key === ',') {
        e.preventDefault();
        const value = input.value.trim();
        if (value && !currentTags.includes(value)) {
          currentTags.push(value);
          renderTags();
          input.value = '';
        }
      }
    };
  }
  
  function renderTags() {
    const wrapper = document.getElementById('tag-input-wrapper');
    const input = document.getElementById('tag-input');
    
    if (!wrapper || !input) return;
    
    const existingTags = wrapper.querySelectorAll('.tag-item');
    existingTags.forEach(t => t.remove());
    
    currentTags.forEach((tag, idx) => {
      const tagEl = document.createElement('div');
      tagEl.className = 'tag-item';
      tagEl.innerHTML = `
        ${tag}
        <button type="button" onclick="removeTag(${idx})">&times;</button>
      `;
      wrapper.insertBefore(tagEl, input);
    });
  }
  
  window.removeTag = (idx) => {
    currentTags.splice(idx, 1);
    renderTags();
  };
  
  // ========================================
  // TAB SWITCHING
  // ========================================
  window.switchTab = (tabName) => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(tabName + '-tab').classList.add('active');
    
    if (tabName === 'ausbildungen') loadCourses();
    if (tabName === 'team') loadTeam();
    if (tabName === 'lernbereich') loadLernbereich();
    if (tabName === 'einstellungen') loadSettings();
  };
  
  // ========================================
  // SETTINGS
  // ========================================
  async function loadSettings() {
    try {
      allAccess = await pb.collection('training_students').getFullList({
        filter: `organization_id = "${currentUser.organization_id}"`,
        sort: 'name',
        expand: 'member_id'
      });
      
      renderSettings();
    } catch(e) {
      console.error('Error:', e);
    }
  }
  
  window.savePflichtSchulungen = async () => {
    try {
      const value = parseInt(document.getElementById('pflicht-schulungen-input').value) || 12;
      
      await pb.collection('organizations').update(currentUser.organization_id, {
        pflicht_schulungen_jahr: value
      });
      
      pflichtSchulungen = value;
      showMsg('‚úÖ Einstellung gespeichert!');
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };
  
  // ========================================
  // AUSBILDUNGEN (OHNE TYP!)
  // ========================================
  async function loadCourses() {
    try {
      allCourses = await pb.collection('training_courses').getFullList({
        filter: `organization_id = "${currentUser.organization_id}"`,
        sort: '-created'
      });
      
      allSessions = await pb.collection('training_sessions').getFullList({
        filter: `organization_id = "${currentUser.organization_id}"`,
        sort: '-date'
      });
      
      renderCourses();
    } catch(e) {
      console.error('Error:', e);
      document.getElementById('schulungen-list').innerHTML = `<div class="empty" style="background:#fff;border-radius:.75rem"><i class="fas fa-exclamation-triangle"></i><div style="color:#c00">Fehler: ${e.message}</div></div>`;
    }
  }

  function renderCourses() {
    const list = document.getElementById('schulungen-list');
    
    if (allCourses.length === 0) {
      list.innerHTML = '<div class="empty" style="background:#fff;border-radius:.75rem"><i class="fas fa-book"></i><div>Noch keine Schulungen</div></div>';
      return;
    }
    
    list.innerHTML = allCourses.map(course => {
      const courseSessions = allSessions.filter(s => s.course_id === course.id);
      const nextSession = courseSessions.find(s => new Date(s.date) >= new Date());
      
      return `
        <div class="course-card" onclick="viewSchulungDetails('${course.id}')">
          <div class="card-title"><i class="fa-solid fa-book-medical"></i> ${course.title}</div>
          
          ${course.description ? `
            <div style="margin:8px 0;color:var(--muted);font-size:.9rem;line-height:1.5">${course.description}</div>
          ` : ''}
          
          <div style="margin-top:8px;color:var(--muted);font-size:.85rem">
            <i class="fa-solid fa-calendar"></i> ${courseSessions.length} Termin(e)
            ${nextSession ? ` ‚Ä¢ N√§chster: ${formatDate(nextSession.date)}` : ''}
          </div>
          
          ${nextSession && nextSession.dozent ? `
            <div style="margin-top:6px;padding:6px 10px;background:#f0fdf4;border-radius:6px;font-size:0.85rem;color:#16a34a">
              üë§ ${nextSession.dozent}
            </div>
          ` : ''}
        </div>
      `;
    }).join('');
  }

  window.openSchulungModal = () => {
    currentEditCourse = null;
    const form = document.getElementById('schulungForm');
    form.reset();
    selectedParticipants = [];
    selectedParticipantStatus = {};
    document.getElementById('selected-count').textContent = '0';
    document.getElementById('schulungModalTitle').innerHTML = '<i class="fa-solid fa-book-medical"></i> Neue Schulung erstellen';
    document.getElementById('schulungModal').classList.add('show');
  };

  window.closeSchulungModal = () => {
    document.getElementById('schulungModal').classList.remove('show');
  };

  document.getElementById('schulungForm').onsubmit = async (e) => {
    e.preventDefault();
    
    try {
      const formData = new FormData(e.target);
      
      // 1. Schulung erstellen (OHNE type!)
      const course = await pb.collection('training_courses').create({
        title: formData.get('title').trim(),
        description: formData.get('description').trim(),
        organization_id: currentUser.organization_id
      });
      
      // 2. Ersten Termin erstellen
      const session = await pb.collection('training_sessions').create({
        course_id: course.id,
        date: formData.get('date'),
        start_time: formData.get('start_time'),
        end_time: formData.get('end_time'),
        location: formData.get('location').trim(),
        dozent: formData.get('instructor').trim(),
        beschreibung: '',
        status: 'geplant',
        invitations_sent: selectedParticipants.length > 0,
        organization_id: currentUser.organization_id
      });
      
      // 3. Teilnehmer hinzuf√ºgen - FIX: Setze Status explizit auf "eingeladen"
      for (const memberId of selectedParticipants) {
        const status = selectedParticipantStatus[memberId] || 'eingeladen';
        
        await pb.collection('schulung_teilnahme').create({
          session_id: session.id,
          member_id: memberId,
          status: status,
          anwesend: false,
          organization_id: currentUser.organization_id
        });
      }
      
      showMsg('‚úÖ Schulung mit Termin erstellt!');
      closeSchulungModal();
      await loadCourses();
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.openParticipantSelector = async () => {
    try {
      allMembers = await pb.collection('team_members').getFullList({
        filter: `organization_id = "${currentUser.organization_id}" && aktiv = true`,
        sort: 'name'
      });
      
      const list = document.getElementById('participantList');
      list.innerHTML = allMembers.map(member => {
        const isSelected = selectedParticipants.includes(member.id);
        const status = selectedParticipantStatus[member.id] || 'eingeladen';
        
        return `
          <div style="padding:.75rem;border-bottom:1px solid var(--border)">
            <label style="display:flex;align-items:center;gap:.75rem;cursor:pointer">
              <input type="checkbox" ${isSelected ? 'checked' : ''} 
                onchange="toggleParticipant('${member.id}')">
              <div style="flex:1">
                <div style="font-weight:700">${member.vorname} ${member.name}</div>
                <div style="font-size:.85rem;color:var(--muted)">${(member.qualifikationen || []).join(', ')}</div>
              </div>
              ${isSelected ? `
                <select onchange="setParticipantStatus('${member.id}', this.value)" 
                  style="padding:4px;border:1px solid var(--border);border-radius:4px;font-size:.85rem">
                  <option value="eingeladen" ${status === 'eingeladen' ? 'selected' : ''}>Eingeladen</option>
                  <option value="zugesagt" ${status === 'zugesagt' ? 'selected' : ''}>Zugesagt</option>
                  <option value="abgesagt" ${status === 'abgesagt' ? 'selected' : ''}>Abgesagt</option>
                </select>
              ` : ''}
            </label>
          </div>
        `;
      }).join('');
      
      document.getElementById('participantModal').classList.add('show');
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.closeParticipantModal = () => {
    document.getElementById('participantModal').classList.remove('show');
    document.getElementById('selected-count').textContent = selectedParticipants.length;
  };

  window.toggleParticipant = (memberId) => {
    const idx = selectedParticipants.indexOf(memberId);
    if (idx >= 0) {
      selectedParticipants.splice(idx, 1);
      delete selectedParticipantStatus[memberId];
    } else {
      selectedParticipants.push(memberId);
      selectedParticipantStatus[memberId] = 'eingeladen';
    }
    openParticipantSelector();
  };

  window.setParticipantStatus = (memberId, status) => {
    selectedParticipantStatus[memberId] = status;
  };
  // ========================================
  // SCHULUNGS-DETAILS (KOMPLETT MIT ALLEN INFOS + FUNKTIONIERENDEN BUTTONS)
  // ========================================
  window.viewSchulungDetails = async (courseId) => {
    try {
      currentViewCourseId = courseId;
      const course = allCourses.find(c => c.id === courseId);
      if (!course) return;
      
      const sessions = allSessions.filter(s => s.course_id === courseId);
      
      document.getElementById('schulungDetailsTitle').innerHTML = 
        `<i class="fa-solid fa-book-medical"></i> ${course.title}`;
      
      let html = `
        <div class="details-section">
          <h4><i class="fa-solid fa-info-circle"></i> Informationen</h4>
          <div style="display:grid;grid-template-columns:150px 1fr;gap:12px;align-items:start">
            <div style="font-weight:700;color:#6b7280">Titel:</div>
            <div style="font-weight:700;font-size:1.1rem">${course.title}</div>
            
            ${course.description ? `
            <div style="font-weight:700;color:#6b7280">Beschreibung:</div>
            <div style="line-height:1.6">${course.description}</div>
            ` : ''}
            
            <div style="font-weight:700;color:#6b7280">Erstellt:</div>
            <div>${formatDate(course.created)}</div>
            
            <div style="font-weight:700;color:#6b7280">Termine:</div>
            <div><span class="badge info">${sessions.length} Termin(e)</span></div>
          </div>
        </div>
        
        <div class="details-section">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
            <h4 style="margin:0"><i class="fa-solid fa-calendar"></i> Termine (${sessions.length})</h4>
            <button class="btn btn-sm primary" onclick="openAddSessionModal('${courseId}')">
              <i class="fas fa-plus"></i> Weiteren Termin hinzuf√ºgen
            </button>
          </div>
      `;
      
      if (sessions.length > 0) {
        sessions.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        sessions.forEach(s => {
          const isPast = new Date(s.date) < new Date();
          const isCancelled = s.status === 'abgesagt';
          
          html += `
            <div class="slide-item" style="border-left-color:${isCancelled ? '#dc2626' : isPast ? '#94a3b8' : 'var(--primary)'};${isCancelled ? 'opacity:0.6;' : ''}">
              <div style="display:flex;align-items:center;flex:1;gap:1rem">
                <div style="flex:1">
                  <div style="font-weight:700;display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                    ${formatDate(s.date)}
                    ${s.start_time ? `<span style="color:var(--muted);font-weight:400">‚Ä¢ ${formatTime(s.start_time)} - ${formatTime(s.end_time)}</span>` : ''}
                    ${isCancelled ? '<span class="badge danger">‚ùå Abgesagt</span>' : 
                      isPast ? '<span class="badge" style="background:#f3f4f6;color:#6b7280">Vergangen</span>' : 
                      '<span class="badge geplant">Geplant</span>'}
                  </div>
                  <div style="font-size:0.85rem;color:var(--muted);margin-top:4px">
                    ${s.location ? `üìç ${s.location}` : 'üìç Kein Ort'}
                    ${s.dozent ? ` ‚Ä¢ üë§ ${s.dozent}` : ''}
                  </div>
                  ${s.beschreibung ? `
                    <div style="font-size:0.85rem;color:var(--muted);margin-top:4px;font-style:italic">
                      "${s.beschreibung}"
                    </div>
                  ` : ''}
                </div>
              </div>
              <div style="display:flex;gap:4px;flex-wrap:wrap">
                ${!isCancelled ? `
                  <button class="btn btn-sm primary" onclick="event.stopPropagation(); viewSessionDetails('${s.id}')">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button class="btn btn-sm info" onclick="event.stopPropagation(); openEditSessionModal('${s.id}')">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-sm warning" onclick="event.stopPropagation(); cancelSession('${s.id}')">
                    <i class="fas fa-ban"></i>
                  </button>
                  <button class="btn btn-sm danger" onclick="event.stopPropagation(); deleteSession('${s.id}')">
                    <i class="fas fa-trash"></i>
                  </button>
                ` : `
                  <button class="btn btn-sm success" onclick="event.stopPropagation(); reactivateSession('${s.id}')">
                    <i class="fas fa-redo"></i> Reaktivieren
                  </button>
                  <button class="btn btn-sm danger" onclick="event.stopPropagation(); deleteSession('${s.id}')">
                    <i class="fas fa-trash"></i>
                  </button>
                `}
              </div>
            </div>
          `;
        });
      } else {
        html += `
          <div style="padding:32px;text-align:center;background:#f9fafb;border-radius:8px;color:var(--muted)">
            <i class="fas fa-calendar" style="font-size:3rem;opacity:0.3;margin-bottom:1rem"></i>
            <div style="font-weight:700">Noch keine Termine</div>
            <div style="font-size:0.85rem;margin-top:4px">F√ºge den ersten Termin √ºber den Button oben hinzu</div>
          </div>
        `;
      }
      
      html += `
        </div>
        
        <div style="margin-top:20px;padding-top:16px;border-top:2px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
          <button class="btn" style="background:#dc2626;color:#fff;border-color:#dc2626" onclick="confirmDeleteSchul()">
            <i class="fa-solid fa-trash"></i> Schulung l√∂schen
          </button>
          <button class="btn primary" onclick="closeSchulungDetailsModal()">
            <i class="fas fa-times"></i> Schlie√üen
          </button>
        </div>
      `;
      
      document.getElementById('schulungDetailsBody').innerHTML = html;
      document.getElementById('schulungDetailsModal').classList.add('show');
      
    } catch(e) {
      console.error('Details-Fehler:', e);
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.closeSchulungDetailsModal = () => {
    document.getElementById('schulungDetailsModal').classList.remove('show');
    currentViewCourseId = null;
  };

  window.confirmDeleteSchul = async () => {
    if (!currentViewCourseId) return;
    
    const course = allCourses.find(c => c.id === currentViewCourseId);
    if (!course) return;
    
    if (confirm(`Schulung "${course.title}" wirklich l√∂schen?\n\nAlle Termine und Teilnehmer werden ebenfalls gel√∂scht!`)) {
      try {
        const sessions = allSessions.filter(s => s.course_id === currentViewCourseId);
        
        for (const session of sessions) {
          const participants = await pb.collection('schulung_teilnahme').getFullList({
            filter: `session_id = "${session.id}"`
          });
          for (const p of participants) {
            await pb.collection('schulung_teilnahme').delete(p.id);
          }
          await pb.collection('training_sessions').delete(session.id);
        }
        
        await pb.collection('training_courses').delete(currentViewCourseId);
        
        showMsg('‚úÖ Schulung gel√∂scht!');
        closeSchulungDetailsModal();
        await loadCourses();
        
      } catch(e) {
        showMsg('Fehler: ' + e.message, 'error');
      }
    }
  };

  // ========================================
  // TERMIN BEARBEITEN
  // ========================================
  window.openEditSessionModal = async (sessionId) => {
    try {
      const session = await pb.collection('training_sessions').getOne(sessionId);
      
      document.getElementById('edit-session-id').value = sessionId;
      document.getElementById('edit-session-date').value = session.date;
      document.getElementById('edit-session-start').value = session.start_time || '';
      document.getElementById('edit-session-end').value = session.end_time || '';
      document.getElementById('edit-session-location').value = session.location || '';
      document.getElementById('edit-session-dozent').value = session.dozent || '';
      document.getElementById('edit-session-beschreibung').value = session.beschreibung || '';
      
      document.getElementById('editSessionModal').classList.add('show');
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.closeEditSessionModal = () => {
    document.getElementById('editSessionModal').classList.remove('show');
  };

  document.getElementById('editSessionForm').onsubmit = async (e) => {
    e.preventDefault();
    
    try {
      const sessionId = document.getElementById('edit-session-id').value;
      
      await pb.collection('training_sessions').update(sessionId, {
        date: document.getElementById('edit-session-date').value,
        start_time: document.getElementById('edit-session-start').value,
        end_time: document.getElementById('edit-session-end').value,
        location: document.getElementById('edit-session-location').value.trim(),
        dozent: document.getElementById('edit-session-dozent').value.trim(),
        beschreibung: document.getElementById('edit-session-beschreibung').value.trim()
      });
      
      showMsg('‚úÖ Termin aktualisiert!');
      closeEditSessionModal();
      await loadCourses();
      if (currentViewCourseId) {
        await viewSchulungDetails(currentViewCourseId);
      }
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  // ========================================
  // TERMIN ABSAGEN / REAKTIVIEREN
  // ========================================
  window.cancelSession = async (sessionId) => {
    if (!confirm('Termin wirklich absagen?\n\nAlle eingeladenen Teilnehmer werden benachrichtigt.')) {
      return;
    }
    
    try {
      await pb.collection('training_sessions').update(sessionId, {
        status: 'abgesagt'
      });
      
      showMsg('‚úÖ Termin abgesagt!');
      await loadCourses();
      if (currentViewCourseId) {
        await viewSchulungDetails(currentViewCourseId);
      }
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.reactivateSession = async (sessionId) => {
    try {
      await pb.collection('training_sessions').update(sessionId, {
        status: 'geplant'
      });
      
      showMsg('‚úÖ Termin reaktiviert!');
      await loadCourses();
      if (currentViewCourseId) {
        await viewSchulungDetails(currentViewCourseId);
      }
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  // ========================================
  // TERMIN L√ñSCHEN
  // ========================================
  window.deleteSession = async (sessionId) => {
    if (!confirm('Termin wirklich endg√ºltig l√∂schen?\n\nAlle Teilnehmer-Daten werden ebenfalls gel√∂scht!')) {
      return;
    }
    
    try {
      // L√∂sche alle Teilnehmer
      const participants = await pb.collection('schulung_teilnahme').getFullList({
        filter: `session_id = "${sessionId}"`
      });
      for (const p of participants) {
        await pb.collection('schulung_teilnahme').delete(p.id);
      }
      
      // L√∂sche Termin
      await pb.collection('training_sessions').delete(sessionId);
      
      showMsg('‚úÖ Termin gel√∂scht!');
      await loadCourses();
      if (currentViewCourseId) {
        await viewSchulungDetails(currentViewCourseId);
      }
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  // ========================================
  // WEITEREN TERMIN HINZUF√úGEN
  // ========================================
  window.openAddSessionModal = (courseId) => {
    document.getElementById('add-session-course-id').value = courseId;
    document.getElementById('addSessionForm').reset();
    selectedParticipants = [];
    selectedParticipantStatus = {};
    document.getElementById('add-selected-count').textContent = '0';
    document.getElementById('addSessionModal').classList.add('show');
  };

  window.closeAddSessionModal = () => {
    document.getElementById('addSessionModal').classList.remove('show');
  };

  window.openParticipantSelectorForAdd = () => {
    openParticipantSelector();
    const oldClose = window.closeParticipantModal;
    window.closeParticipantModal = () => {
      document.getElementById('participantModal').classList.remove('show');
      document.getElementById('add-selected-count').textContent = selectedParticipants.length;
      window.closeParticipantModal = oldClose;
    };
  };

  document.getElementById('addSessionForm').onsubmit = async (e) => {
    e.preventDefault();
    
    try {
      const formData = new FormData(e.target);
      const courseId = document.getElementById('add-session-course-id').value;
      
      const session = await pb.collection('training_sessions').create({
        course_id: courseId,
        date: formData.get('date'),
        start_time: formData.get('start_time'),
        end_time: formData.get('end_time'),
        location: formData.get('location').trim(),
        dozent: formData.get('dozent').trim(),
        beschreibung: formData.get('beschreibung').trim(),
        status: 'geplant',
        invitations_sent: selectedParticipants.length > 0,
        organization_id: currentUser.organization_id
      });
      
      // FIX: Setze Status explizit auf "eingeladen"
      for (const memberId of selectedParticipants) {
        const status = selectedParticipantStatus[memberId] || 'eingeladen';
        
        await pb.collection('schulung_teilnahme').create({
          session_id: session.id,
          member_id: memberId,
          status: status,
          anwesend: false,
          organization_id: currentUser.organization_id
        });
      }
      
      showMsg('‚úÖ Termin hinzugef√ºgt!');
      closeAddSessionModal();
      await loadCourses();
      await viewSchulungDetails(courseId);
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  // ========================================
  // TERMIN-DETAILS MIT STATISTIK
  // ========================================
  window.viewSessionDetails = async (sessionId) => {
    try {
      currentSessionId = sessionId;
      const session = await pb.collection('training_sessions').getOne(sessionId);
      const course = allCourses.find(c => c.id === session.course_id);
      const participants = await pb.collection('schulung_teilnahme').getFullList({
        filter: `session_id = "${sessionId}"`,
        expand: 'member_id'
      });
      
      document.getElementById('sessionDetailsTitle').textContent = 
        `${course ? course.title : 'Termin'} ‚Ä¢ ${formatDate(session.date)}`;
      
      const inviteLink = `${window.location.origin}/ausbildungen-invite.html?session=${sessionId}`;
      
      const eingeladen = participants.length;
      const zugesagt = participants.filter(p => p.status === 'zugesagt').length;
      const abgesagt = participants.filter(p => p.status === 'abgesagt').length;
      const offen = participants.filter(p => p.status === 'eingeladen').length;
      const anwesend = participants.filter(p => p.anwesend).length;
      const abwesend = participants.filter(p => !p.anwesend && p.status !== 'abgesagt').length;
      
      let html = `
        <div class="details-section">
          <h4><i class="fa-solid fa-info-circle"></i> Termin-Informationen</h4>
          <div style="display:grid;grid-template-columns:150px 1fr;gap:8px">
            <div style="font-weight:700;color:#6b7280">Datum:</div>
            <div>${formatDate(session.date)} ${session.start_time ? `‚Ä¢ ${formatTime(session.start_time)} - ${formatTime(session.end_time)}` : ''}</div>
            
            <div style="font-weight:700;color:#6b7280">Ort:</div>
            <div>${session.location || '-'}</div>
            
            ${session.dozent ? `
            <div style="font-weight:700;color:#6b7280">Dozent:</div>
            <div>${session.dozent}</div>
            ` : ''}
            
            ${session.beschreibung ? `
            <div style="font-weight:700;color:#6b7280">Beschreibung:</div>
            <div>${session.beschreibung}</div>
            ` : ''}
          </div>
        </div>
        
        <div class="details-section">
          <h4><i class="fa-solid fa-link"></i> Einladungslink</h4>
          <div style="margin-bottom:1rem">
            <div class="copy-box">
              <span style="flex:1;overflow:hidden;text-overflow:ellipsis;font-size:.85rem">${inviteLink}</span>
              <button class="btn btn-sm" onclick="copyToClipboard('${inviteLink}')">
                <i class="fas fa-copy"></i>
              </button>
            </div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn btn-sm success" onclick="shareWhatsApp('${inviteLink}')">
              <i class="fab fa-whatsapp"></i> WhatsApp
            </button>
            <button class="btn btn-sm info" onclick="shareEmail('${inviteLink}', '${course ? course.title : 'Schulung'}', '${formatDate(session.date)}')">
              <i class="fas fa-envelope"></i> E-Mail
            </button>
          </div>
        </div>
        
        <div class="details-section">
          <h4><i class="fa-solid fa-chart-pie"></i> Statistik</h4>
          
          <div style="margin-bottom:1rem">
            <div style="font-size:.85rem;font-weight:700;color:#6b7280;margin-bottom:.5rem">R√úCKMELDUNGEN</div>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px">
              <div style="text-align:center;padding:12px;background:#e0e7ff;border-radius:8px">
                <div style="font-size:1.5rem;font-weight:800;color:#4338ca">${eingeladen}</div>
                <div style="font-size:0.85rem;color:#4338ca">Eingeladen</div>
              </div>
              <div style="text-align:center;padding:12px;background:#dcfce7;border-radius:8px">
                <div style="font-size:1.5rem;font-weight:800;color:#065f46">${zugesagt}</div>
                <div style="font-size:0.85rem;color:#065f46">Zugesagt</div>
              </div>
              <div style="text-align:center;padding:12px;background:#fee2e2;border-radius:8px">
                <div style="font-size:1.5rem;font-weight:800;color:#991b1b">${abgesagt}</div>
                <div style="font-size:0.85rem;color:#991b1b">Abgesagt</div>
              </div>
              <div style="text-align:center;padding:12px;background:#fef3c7;border-radius:8px">
                <div style="font-size:1.5rem;font-weight:800;color:#92400e">${offen}</div>
                <div style="font-size:0.85rem;color:#92400e">Offen</div>
              </div>
            </div>
          </div>
          
          <div>
            <div style="font-size:.85rem;font-weight:700;color:#6b7280;margin-bottom:.5rem">ANWESENHEIT</div>
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px">
              <div style="text-align:center;padding:12px;background:#f0fdf4;border-radius:8px">
                <div style="font-size:1.5rem;font-weight:800;color:#16a34a">${anwesend}</div>
                <div style="font-size:0.85rem;color:#16a34a">Anwesend</div>
              </div>
              <div style="text-align:center;padding:12px;background:#fef3c7;border-radius:8px">
                <div style="font-size:1.5rem;font-weight:800;color:#92400e">${abwesend}</div>
                <div style="font-size:0.85rem;color:#92400e">Nicht anwesend</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="details-section">
          <h4><i class="fa-solid fa-users"></i> Teilnehmer-Liste (${participants.length})</h4>
      `;
      
      if (participants.length > 0) {
        html += `
          <table class="table" style="margin-top:1rem">
            <thead>
              <tr>
                <th>#</th>
                <th>Name</th>
                <th>R√ºckmeldung</th>
                <th style="text-align:center">Anwesend</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        participants.forEach((p, idx) => {
          const member = p.expand?.member_id;
          let statusBadge = '';
          
          if (p.status === 'zugesagt') {
            statusBadge = '<span class="badge zugesagt">‚úÖ Zugesagt</span>';
          } else if (p.status === 'abgesagt') {
            statusBadge = '<span class="badge abgesagt">‚ùå Abgesagt</span>';
          } else {
            statusBadge = '<span class="badge eingeladen">‚è≥ Offen</span>';
          }
          
          html += `
            <tr>
              <td>${idx + 1}</td>
              <td style="font-weight:700">${member ? `${member.vorname} ${member.name}` : 'Unbekannt'}</td>
              <td>${statusBadge}</td>
              <td style="text-align:center">
                ${p.status === 'abgesagt' ? 
                  '<span style="color:var(--muted)">-</span>' :
                  `<input 
                    type="checkbox" 
                    data-participant-id="${p.id}"
                    ${p.anwesend ? 'checked' : ''}
                    style="width:20px;height:20px;cursor:pointer"
                  >`
                }
              </td>
            </tr>
          `;
        });
        
        html += '</tbody></table>';
      } else {
        html += '<p style="color:#999;padding:16px;text-align:center">Keine Teilnehmer</p>';
      }
      
      html += '</div>';
      
      document.getElementById('sessionDetailsBody').innerHTML = html;
      document.getElementById('sessionDetailsModal').classList.add('show');
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.closeSessionDetailsModal = () => {
    document.getElementById('sessionDetailsModal').classList.remove('show');
    currentSessionId = null;
  };

  window.saveAttendance = async () => {
    try {
      if (!currentSessionId) return;
      
      const checkboxes = document.querySelectorAll('[data-participant-id]');
      
      for (const checkbox of checkboxes) {
        const participantId = checkbox.dataset.participantId;
        const anwesend = checkbox.checked;
        
        await pb.collection('schulung_teilnahme').update(participantId, {
          anwesend
        });
      }
      
      showMsg('‚úÖ Anwesenheit gespeichert!');
      await viewSessionDetails(currentSessionId);
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.shareWhatsApp = (link) => {
    const text = encodeURIComponent(`Hallo! Hier ist der Einladungslink zur Schulung: ${link}`);
    window.open(`https://wa.me/?text=${text}`, '_blank');
  };

  window.shareEmail = (link, title, date) => {
    const subject = encodeURIComponent(`Einladung: ${title} am ${date}`);
    const body = encodeURIComponent(`Hallo,\n\nhiermit lade ich dich zur Schulung ein:\n\n${title}\nDatum: ${date}\n\nBitte best√§tige deine Teilnahme √ºber diesen Link:\n${link}\n\nViele Gr√º√üe`);
    window.location.href = `mailto:?subject=${subject}&body=${body}`;
  };
  // ========================================
  // TEAM-MANAGEMENT MIT PFLICHT-SCHULUNGEN
  // ========================================
  async function loadTeam() {
    try {
      allMembers = await pb.collection('team_members').getFullList({
        filter: `organization_id = "${currentUser.organization_id}" && aktiv = true`,
        sort: 'name'
      });
      
      allAccess = await pb.collection('training_students').getFullList({
        filter: `organization_id = "${currentUser.organization_id}"`,
        sort: 'name',
        expand: 'member_id'
      });
      
      renderTeam();
    } catch(e) {
      console.error('Error:', e);
      document.getElementById('team-list').innerHTML = `<div class="empty" style="background:#fff;border-radius:.75rem"><i class="fas fa-exclamation-triangle"></i><div style="color:#c00">Fehler: ${e.message}</div></div>`;
    }
  }

  function renderTeam() {
    const list = document.getElementById('team-list');
    
    if (allMembers.length === 0) {
      list.innerHTML = '<div class="empty" style="background:#fff;border-radius:.75rem"><i class="fas fa-users"></i><div>Noch keine Team-Mitglieder</div></div>';
      return;
    }
    
    list.innerHTML = allMembers.map(member => {
      const tags = member.qualifikationen || [];
      const tagsHTML = tags.map(t => `<span class="tag">${t}</span>`).join('');
      const access = allAccess.find(a => a.member_id === member.id);
      
      return `
        <div class="member-card" onclick="viewMemberDetails('${member.id}')">
          <div class="card-title"><i class="fa-solid fa-user"></i> ${member.vorname} ${member.name}</div>
          <div style="margin-bottom:8px">
            ${tagsHTML || '<span class="tag" style="background:#eee;color:#999">Keine Qualifikationen</span>'}
          </div>
          ${access ? `
            <div style="margin-top:8px;padding:6px;background:#f0fdf4;border-radius:6px;font-size:0.85rem">
              <i class="fa-solid fa-check-circle" style="color:#16a34a"></i> Zugang: <strong>${access.access_code}</strong>
            </div>
          ` : `
            <div style="margin-top:8px;padding:6px;background:#fef3c7;border-radius:6px;font-size:0.85rem">
              <i class="fa-solid fa-lock"></i> Kein Zugang
            </div>
          `}
        </div>
      `;
    }).join('');
  }

  window.openMemberModal = (memberId = null) => {
    currentEditMember = memberId;
    const form = document.getElementById('memberForm');
    form.reset();
    currentTags = [];
    
    if (memberId) {
      const member = allMembers.find(m => m.id === memberId);
      if (member) {
        document.getElementById('memberModalTitle').innerHTML = '<i class="fa-solid fa-user-edit"></i> Mitglied bearbeiten';
        form.name.value = member.name || '';
        form.vorname.value = member.vorname || '';
        currentTags = [...(member.qualifikationen || [])];
      }
    } else {
      document.getElementById('memberModalTitle').innerHTML = '<i class="fa-solid fa-user-plus"></i> Neues Team-Mitglied';
    }
    
    document.getElementById('memberModal').classList.add('show');
    setTimeout(() => {
      initTagInput();
      renderTags();
    }, 100);
  };

  window.closeMemberModal = () => {
    document.getElementById('memberModal').classList.remove('show');
    currentEditMember = null;
    currentTags = [];
  };

  document.getElementById('memberForm').onsubmit = async (e) => {
    e.preventDefault();
    
    try {
      const formData = new FormData(e.target);
      const data = {
        name: formData.get('name').trim(),
        vorname: formData.get('vorname').trim(),
        qualifikationen: currentTags,
        aktiv: true,
        organization_id: currentUser.organization_id
      };
      
      if (currentEditMember) {
        await pb.collection('team_members').update(currentEditMember, data);
        showMsg('‚úÖ Mitglied aktualisiert!');
      } else {
        await pb.collection('team_members').create(data);
        showMsg('‚úÖ Mitglied erstellt!');
      }
      
      closeMemberModal();
      await loadTeam();
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.viewMemberDetails = async (memberId) => {
    try {
      const member = await pb.collection('team_members').getOne(memberId);
      const participations = await pb.collection('schulung_teilnahme').getFullList({
        filter: `member_id = "${memberId}"`,
        expand: 'session_id',
        sort: '-created'
      });
      
      const access = allAccess.find(a => a.member_id === memberId);
      const tags = member.qualifikationen || [];
      const tagsHTML = tags.map(t => `<span class="tag">${t}</span>`).join('') || 
        '<span class="tag" style="background:#eee;color:#999">Keine Qualifikationen</span>';
      
      document.getElementById('memberDetailsTitle').innerHTML = 
        `<i class="fa-solid fa-user"></i> ${member.vorname} ${member.name}`;
      
      const currentYear = new Date().getFullYear();
      const thisYearParticipations = participations.filter(p => {
        const session = p.expand?.session_id;
        return session && new Date(session.date).getFullYear() === currentYear && p.anwesend;
      });
      const completedThisYear = thisYearParticipations.length;
      const percentComplete = Math.round((completedThisYear / pflichtSchulungen) * 100);
      
      let html = `
        <div class="details-section">
          <h4><i class="fa-solid fa-id-badge"></i> Informationen</h4>
          <div style="display:grid;grid-template-columns:150px 1fr;gap:8px">
            <div style="font-weight:700;color:#6b7280">Qualifikationen:</div>
            <div>${tagsHTML}</div>
          </div>
        </div>
        
        <div class="details-section" style="background:${percentComplete >= 100 ? '#f0fdf4' : '#fef3c7'}">
          <h4><i class="fa-solid fa-graduation-cap"></i> Pflicht-Schulungen ${currentYear}</h4>
          <div style="display:flex;align-items:center;gap:1rem;margin-bottom:.5rem">
            <div style="font-size:2rem;font-weight:800;color:${percentComplete >= 100 ? '#16a34a' : '#f59e0b'}">
              ${completedThisYear} / ${pflichtSchulungen}
            </div>
            <div style="flex:1">
              <div class="progress-bar" style="height:12px">
                <div class="progress-bar-fill" style="width:${Math.min(percentComplete, 100)}%;background:${percentComplete >= 100 ? '#16a34a' : '#f59e0b'}"></div>
              </div>
              <div style="font-size:.85rem;color:var(--muted);margin-top:4px">
                ${percentComplete}% abgeschlossen
                ${completedThisYear < pflichtSchulungen ? ` ‚Ä¢ Noch ${pflichtSchulungen - completedThisYear} ben√∂tigt` : ' ‚Ä¢ ‚úì Ziel erreicht!'}
              </div>
            </div>
          </div>
        </div>
        
        <div class="details-section">
          <h4><i class="fa-solid fa-key"></i> Externer Zugang</h4>
      `;
      
      if (access) {
        html += `
          <div style="background:#f0fdf4;padding:1rem;border-radius:.5rem;border:1px solid #86efac">
            <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem">
              <i class="fa-solid fa-check-circle" style="color:#16a34a;font-size:1.2rem"></i>
              <strong style="color:#16a34a">Zugang aktiv</strong>
            </div>
            <div class="copy-box" style="margin-top:.5rem">
              <span style="font-weight:700;color:var(--primary);font-size:1.1rem">${access.access_code}</span>
              <button class="btn btn-sm" onclick="copyToClipboard('${access.access_code}')">
                <i class="fas fa-copy"></i>
              </button>
            </div>
            <div style="margin-top:.5rem;font-size:.85rem;color:var(--muted)">
              Login: ausbildungen-public.html mit diesem Code
            </div>
          </div>
          <div style="margin-top:.5rem;display:flex;gap:.5rem">
            <button class="btn btn-sm success" onclick="exportAccessPDF('${access.id}')">
              <i class="fas fa-file-pdf"></i> PDF erstellen
            </button>
            <button class="btn btn-sm" onclick="deleteAccessForMember('${access.id}')">
              <i class="fas fa-trash"></i> Zugang entfernen
            </button>
          </div>
        `;
      } else {
        html += `
          <div style="background:#fef3c7;padding:1rem;border-radius:.5rem;border:1px solid #fde047">
            <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem">
              <i class="fa-solid fa-lock" style="color:#f59e0b;font-size:1.2rem"></i>
              <strong style="color:#f59e0b">Kein Zugang vorhanden</strong>
            </div>
            <p style="margin:.5rem 0;font-size:.85rem;color:var(--muted)">
              Erstelle einen 3-Wort-Code, damit sich diese Person extern anmelden kann.
            </p>
          </div>
          <div style="margin-top:.5rem">
            <button class="btn btn-sm primary" onclick="openCreateAccessForMember('${memberId}')">
              <i class="fas fa-key"></i> Zugang erstellen
            </button>
          </div>
        `;
      }
      
      html += `</div>
        <div class="details-section">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
            <h4 style="margin:0"><i class="fa-solid fa-clock-rotate-left"></i> Teilnahmehistorie (${participations.length})</h4>
            <button class="btn btn-sm success" onclick="exportMemberPDF('${memberId}')">
              <i class="fas fa-file-pdf"></i> PDF Export
            </button>
          </div>
      `;
      
      if (participations.length > 0) {
        const zugesagt = participations.filter(p => p.status === 'zugesagt').length;
        const abgesagt = participations.filter(p => p.status === 'abgesagt').length;
        const anwesend = participations.filter(p => p.anwesend).length;
        const abwesend = participations.filter(p => !p.anwesend && p.status !== 'abgesagt').length;
        
        html += `
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:1rem">
            <div style="text-align:center;padding:12px;background:#dcfce7;border-radius:8px">
              <div style="font-size:1.5rem;font-weight:800;color:#065f46">${zugesagt}</div>
              <div style="font-size:0.85rem;color:#065f46">Zugesagt</div>
            </div>
            <div style="text-align:center;padding:12px;background:#fee2e2;border-radius:8px">
              <div style="font-size:1.5rem;font-weight:800;color:#991b1b">${abgesagt}</div>
              <div style="font-size:0.85rem;color:#991b1b">Abgesagt</div>
            </div>
            <div style="text-align:center;padding:12px;background:#f0fdf4;border-radius:8px">
              <div style="font-size:1.5rem;font-weight:800;color:#16a34a">${anwesend}</div>
              <div style="font-size:0.85rem;color:#16a34a">Anwesend</div>
            </div>
            <div style="text-align:center;padding:12px;background:#fef3c7;border-radius:8px">
              <div style="font-size:1.5rem;font-weight:800;color:#92400e">${abwesend}</div>
              <div style="font-size:0.85rem;color:#92400e">Offen</div>
            </div>
          </div>
          
          <table class="table">
            <thead>
              <tr>
                <th>Datum</th>
                <th>Kurs</th>
                <th>R√ºckmeldung</th>
                <th>Anwesenheit</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        participations.forEach(p => {
          const session = p.expand?.session_id;
          const course = session ? allCourses.find(c => c.id === session.course_id) : null;
          
          html += `
            <tr>
              <td>${session ? formatDate(session.date) : '-'}</td>
              <td style="font-weight:700">${course ? course.title : 'Unbekannt'}</td>
              <td>
                <span class="badge ${p.status}">${
                  p.status === 'zugesagt' ? '‚úÖ Zugesagt' : 
                  p.status === 'abgesagt' ? '‚ùå Abgesagt' : '‚è≥ Eingeladen'
                }</span>
              </td>
              <td>
                <span class="badge ${p.anwesend ? 'anwesend' : 'abwesend'}">
                  ${p.anwesend ? '‚úÖ Anwesend' : (p.status === 'abgesagt' ? '‚ùå Abgesagt' : '‚ùå Abwesend')}
                </span>
              </td>
            </tr>
          `;
        });
        
        html += '</tbody></table>';
      } else {
        html += '<p style="color:#999;padding:16px;text-align:center">Noch keine Teilnahmen</p>';
      }
      
      html += `
        </div>
        
        <div style="margin-top:16px;display:flex;gap:8px">
          <button class="btn primary" onclick="closeMemberDetailsModal();openMemberModal('${memberId}')">
            <i class="fa-solid fa-edit"></i> Bearbeiten
          </button>
          <button class="btn" onclick="deleteMember('${memberId}')">
            <i class="fa-solid fa-trash"></i> L√∂schen
          </button>
        </div>
      `;
      
      document.getElementById('memberDetailsBody').innerHTML = html;
      document.getElementById('memberDetailsModal').classList.add('show');
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.closeMemberDetailsModal = () => {
    document.getElementById('memberDetailsModal').classList.remove('show');
  };

  window.deleteMember = async (memberId) => {
    if (!confirm('Team-Mitglied wirklich l√∂schen?')) return;
    
    try {
      await pb.collection('team_members').update(memberId, { aktiv: false });
      showMsg('‚úÖ Mitglied entfernt!');
      closeMemberDetailsModal();
      await loadTeam();
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  // ========================================
  // PDF-EXPORT F√úR MEMBER
  // ========================================
  window.exportMemberPDF = async (memberId) => {
    try {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      const member = await pb.collection('team_members').getOne(memberId);
      const participations = await pb.collection('schulung_teilnahme').getFullList({
        filter: `member_id = "${memberId}"`,
        expand: 'session_id',
        sort: '-created'
      });
      
      doc.setFontSize(18);
      doc.text(`Teilnahmehistorie: ${member.vorname} ${member.name}`, 20, 20);
      
      const zugesagt = participations.filter(p => p.status === 'zugesagt').length;
      const abgesagt = participations.filter(p => p.status === 'abgesagt').length;
      const anwesend = participations.filter(p => p.anwesend).length;
      const abwesend = participations.filter(p => !p.anwesend && p.status !== 'abgesagt').length;
      
      doc.setFontSize(12);
      doc.text(`Zugesagt: ${zugesagt}  |  Abgesagt: ${abgesagt}  |  Anwesend: ${anwesend}  |  Offen: ${abwesend}`, 20, 35);
      
      let yPos = 50;
      doc.setFontSize(10);
      doc.text('Datum', 20, yPos);
      doc.text('Kurs', 60, yPos);
      doc.text('Rueckmeldung', 130, yPos);
      doc.text('Anwesenheit', 170, yPos);
      
      yPos += 7;
      participations.forEach(p => {
        const session = p.expand?.session_id;
        const course = session ? allCourses.find(c => c.id === session.course_id) : null;
        
        if (yPos > 270) {
          doc.addPage();
          yPos = 20;
        }
        
        doc.text(session ? formatDate(session.date) : '-', 20, yPos);
        doc.text(course ? course.title.substring(0, 25) : 'Unbekannt', 60, yPos);
        doc.text(p.status === 'zugesagt' ? 'Zugesagt' : p.status === 'abgesagt' ? 'Abgesagt' : 'Eingeladen', 130, yPos);
        doc.text(p.anwesend ? 'Anwesend' : 'Abwesend', 170, yPos);
        
        yPos += 7;
      });
      
      doc.save(`${member.vorname}_${member.name}_Historie.pdf`);
      showMsg('‚úÖ PDF exportiert!');
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.exportAllMembersStats = async () => {
    try {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      doc.setFontSize(18);
      doc.text('Gesamtauswertung Team', 20, 20);
      
      let yPos = 35;
      doc.setFontSize(10);
      
      for (const member of allMembers) {
        const participations = await pb.collection('schulung_teilnahme').getFullList({
          filter: `member_id = "${member.id}"`
        });
        
        const zugesagt = participations.filter(p => p.status === 'zugesagt').length;
        const abgesagt = participations.filter(p => p.status === 'abgesagt').length;
        const anwesend = participations.filter(p => p.anwesend).length;
        
        if (yPos > 270) {
          doc.addPage();
          yPos = 20;
        }
        
        doc.setFontSize(12);
        doc.text(`${member.vorname} ${member.name}`, 20, yPos);
        yPos += 6;
        
        doc.setFontSize(10);
        doc.text(`Zugesagt: ${zugesagt}  |  Abgesagt: ${abgesagt}  |  Anwesend: ${anwesend}  |  Gesamt: ${participations.length}`, 20, yPos);
        yPos += 10;
      }
      
      doc.save(`Team_Gesamtauswertung_${new Date().toISOString().split('T')[0]}.pdf`);
      showMsg('‚úÖ Gesamtauswertung exportiert!');
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  // ========================================
  // ZUGANG F√úR MITGLIED
  // ========================================
  window.openCreateAccessForMember = (memberId) => {
    currentAccessMember = memberId;
    const member = allMembers.find(m => m.id === memberId);
    
    if (member) {
      document.getElementById('access-member-name').textContent = `${member.vorname} ${member.name}`;
      memberAccessCode = generateAccessCode();
      document.getElementById('member-access-code').textContent = memberAccessCode;
      document.getElementById('createAccessForMemberModal').classList.add('show');
    }
  };

  window.closeCreateAccessForMemberModal = () => {
    document.getElementById('createAccessForMemberModal').classList.remove('show');
    currentAccessMember = null;
  };

  window.saveAccessForMember = async () => {
    if (!currentAccessMember) return;
    
    try {
      const member = allMembers.find(m => m.id === currentAccessMember);
      const password = generatePassword();
      
      await pb.collection('training_students').create({
        username: memberAccessCode,
        email: '',
        password,
        passwordConfirm: password,
        name: `${member.vorname} ${member.name}`,
        access_code: memberAccessCode,
        member_id: currentAccessMember,
        organization_id: currentUser.organization_id
      });
      
      showMsg(`‚úÖ Zugang erstellt! Code: ${memberAccessCode}`);
      closeCreateAccessForMemberModal();
      await loadTeam();
      
      if (document.getElementById('memberDetailsModal').classList.contains('show')) {
        await viewMemberDetails(currentAccessMember);
      }
      
    } catch(e) {
      console.error('Fehler Details:', e);
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.deleteAccessForMember = async (accessId) => {
    if (!confirm('Zugang wirklich entfernen?')) return;
    
    try {
      await pb.collection('training_students').delete(accessId);
      showMsg('‚úÖ Zugang entfernt!');
      await loadTeam();
      closeMemberDetailsModal();
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  // ========================================
  // ZUG√ÑNGE - SETTINGS
  // ========================================
  function renderSettings() {
    const list = document.getElementById('access-list');
    
    if (allAccess.length === 0) {
      list.innerHTML = '<div class="empty" style="background:#fff;border-radius:.75rem"><i class="fas fa-key"></i><div>Noch keine Zug√§nge</div></div>';
      return;
    }
    
    list.innerHTML = `
      <div style="background:#fff;border-radius:.75rem;padding:1.5rem;box-shadow:0 2px 8px rgba(0,0,0,.05)">
        <table class="table">
          <thead>
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Zugangscode</th>
              <th>Verkn√ºpft mit</th>
              <th>Aktionen</th>
            </tr>
          </thead>
          <tbody>
    `;
    
    allAccess.forEach((access, idx) => {
      const member = access.expand?.member_id;
      
      list.innerHTML += `
        <tr>
          <td style="font-weight:700">${idx + 1}</td>
          <td style="font-weight:700">${access.name}</td>
          <td>
            <div class="copy-box" style="display:inline-flex;width:auto">
              <span style="font-weight:700;color:var(--primary);font-family:monospace">${access.access_code}</span>
              <button class="btn btn-sm" onclick="copyToClipboard('${access.access_code}')">
                <i class="fas fa-copy"></i>
              </button>
            </div>
          </td>
          <td>
            ${member ? `
              <span class="badge online">
                <i class="fas fa-link"></i> ${member.vorname} ${member.name}
              </span>
            ` : `
              <span style="color:var(--muted);font-size:.85rem">Extern</span>
            `}
          </td>
          <td>
            <div style="display:flex;gap:4px">
              <button class="btn btn-sm success" onclick="exportAccessPDF('${access.id}')">
                <i class="fas fa-file-pdf"></i> PDF
              </button>
              <button class="btn btn-sm" onclick="deleteAccess('${access.id}')">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `;
    });
    
    list.innerHTML += `
          </tbody>
        </table>
      </div>
    `;
  }

  window.openSingleAccessModal = () => {
    document.getElementById('singleAccessForm').reset();
    generatePreviewCode();
    document.getElementById('singleAccessModal').classList.add('show');
  };

  window.closeSingleAccessModal = () => {
    document.getElementById('singleAccessModal').classList.remove('show');
  };

  document.getElementById('singleAccessForm').onsubmit = async (e) => {
    e.preventDefault();
    
    try {
      const formData = new FormData(e.target);
      const password = generatePassword();
      
      await pb.collection('training_students').create({
        username: previewAccessCode,
        email: '',
        password,
        passwordConfirm: password,
        name: formData.get('name').trim(),
        access_code: previewAccessCode,
        organization_id: currentUser.organization_id
      });
      
      showMsg(`‚úÖ Zugang erstellt! Code: ${previewAccessCode}`);
      closeSingleAccessModal();
      await loadSettings();
      
    } catch(e) {
      console.error('Fehler Details:', e);
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.openBulkAccessModal = () => {
    bulkAccessCount = 3;
    renderBulkAccessRows();
    document.getElementById('bulkAccessModal').classList.add('show');
  };

  window.closeBulkAccessModal = () => {
    document.getElementById('bulkAccessModal').classList.remove('show');
  };

  window.addBulkAccessRow = () => {
    bulkAccessCount++;
    renderBulkAccessRows();
  };

  function renderBulkAccessRows() {
    const list = document.getElementById('bulkAccessList');
    let html = '';
    
    for (let i = 0; i < bulkAccessCount; i++) {
      html += `
        <div style="display:grid;grid-template-columns:1fr auto;gap:8px;margin-bottom:8px;padding:12px;background:#f9fafb;border-radius:8px">
          <input type="text" placeholder="Name" data-bulk-name="${i}" style="padding:8px;border:1px solid #d1d5db;border-radius:6px">
          <button type="button" class="btn btn-sm" onclick="removeBulkAccessRow(${i})">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
    }
    
    list.innerHTML = html;
  }

  window.removeBulkAccessRow = (index) => {
    if (bulkAccessCount > 1) {
      bulkAccessCount--;
      renderBulkAccessRows();
    }
  };

  document.getElementById('bulkAccessForm').onsubmit = async (e) => {
    e.preventDefault();
    
    try {
      const names = Array.from(document.querySelectorAll('[data-bulk-name]'));
      
      let created = 0;
      
      for (let i = 0; i < names.length; i++) {
        const name = names[i].value.trim();
        
        if (name) {
          const password = generatePassword();
          const code = generateAccessCode();
          
          await pb.collection('training_students').create({
            username: code,
            email: '',
            password,
            passwordConfirm: password,
            name,
            access_code: code,
            organization_id: currentUser.organization_id
          });
          
          created++;
        }
      }
      
      showMsg(`‚úÖ ${created} Zug√§nge erstellt!`);
      closeBulkAccessModal();
      await loadSettings();
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.deleteAccess = async (accessId) => {
    if (!confirm('Zugang wirklich l√∂schen?')) return;
    
    try {
      await pb.collection('training_students').delete(accessId);
      showMsg('‚úÖ Zugang gel√∂scht!');
      await loadSettings();
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.exportAccessCodes = () => {
    if (allAccess.length === 0) {
      showMsg('Keine Zug√§nge zum Exportieren', 'error');
      return;
    }
    
    let csv = 'Name,Zugangscode,Verkn√ºpft mit\n';
    allAccess.forEach(access => {
      const member = access.expand?.member_id;
      const linkedTo = member ? `${member.vorname} ${member.name}` : 'Extern';
      csv += `"${access.name}","${access.access_code}","${linkedTo}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `zugaenge_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    
    showMsg('‚úÖ CSV exportiert!');
  };

  // ========================================
  // PDF-EXPORT F√úR ZUG√ÑNGE (MIT QR-CODE!)
  // ========================================
  window.exportAccessPDF = async (accessId) => {
    try {
      const { jsPDF } = window.jspdf;
      const access = allAccess.find(a => a.id === accessId);
      
      if (!access) {
        showMsg('Zugang nicht gefunden', 'error');
        return;
      }
      
      const doc = new jsPDF();
      const loginLink = `${window.location.origin}/ausbildungen-public.html`;
      
      doc.setFontSize(20);
      doc.setTextColor(200, 16, 46);
      doc.text('Responda Ausbildungen', 105, 20, { align: 'center' });
      
      doc.setFontSize(14);
      doc.setTextColor(0, 0, 0);
      doc.text('Pers√∂nlicher Zugang', 105, 30, { align: 'center' });
      
      doc.setDrawColor(200, 16, 46);
      doc.setLineWidth(0.5);
      doc.line(20, 35, 190, 35);
      
      doc.setFontSize(12);
      doc.setFont(undefined, 'bold');
      doc.text('Name:', 20, 50);
      doc.setFont(undefined, 'normal');
      doc.text(access.name, 60, 50);
      
      doc.setFontSize(16);
      doc.setFont(undefined, 'bold');
      doc.text('Ihr Zugangscode:', 20, 65);
      
      doc.setFontSize(24);
      doc.setTextColor(200, 16, 46);
      doc.setFont(undefined, 'bold');
      doc.text(access.access_code, 105, 80, { align: 'center' });
      
      doc.setDrawColor(200, 16, 46);
      doc.setLineWidth(1);
      doc.rect(40, 70, 130, 15);
      
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      doc.setFont(undefined, 'bold');
      doc.text('Login-Link:', 20, 100);
      doc.setFont(undefined, 'normal');
      doc.setFontSize(10);
      doc.setTextColor(0, 0, 255);
      doc.textWithLink(loginLink, 20, 108, { url: loginLink });
      
      doc.setTextColor(0, 0, 0);
      doc.setFontSize(12);
      doc.setFont(undefined, 'bold');
      doc.text('QR-Code:', 20, 125);
      
      const qrContainer = document.createElement('div');
      qrContainer.style.position = 'absolute';
      qrContainer.style.left = '-9999px';
      document.body.appendChild(qrContainer);
      
      try {
        const qr = new QRCode(qrContainer, {
          text: loginLink,
          width: 256,
          height: 256,
          correctLevel: QRCode.CorrectLevel.H
        });
        
        await new Promise(resolve => setTimeout(resolve, 100));
        
        const qrImg = qrContainer.querySelector('img');
        if (qrImg && qrImg.src) {
          doc.addImage(qrImg.src, 'PNG', 70, 130, 70, 70);
        } else {
          doc.setDrawColor(200);
          doc.rect(70, 130, 70, 70);
          doc.setFontSize(8);
          doc.text('QR-Code Scan:', 105, 165, { align: 'center' });
          doc.text(loginLink, 105, 170, { align: 'center', maxWidth: 60 });
        }
      } catch(qrError) {
        console.error('QR-Code Fehler:', qrError);
        doc.setDrawColor(200);
        doc.rect(70, 130, 70, 70);
        doc.setFontSize(8);
        doc.text('QR-Code Scan:', 105, 165, { align: 'center' });
        doc.text(loginLink, 105, 170, { align: 'center', maxWidth: 60 });
      } finally {
        document.body.removeChild(qrContainer);
      }
      
      doc.setFontSize(12);
      doc.setFont(undefined, 'bold');
      doc.text('So melden Sie sich an:', 20, 215);
      
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      const instructions = [
        '1. √ñffnen Sie den Login-Link im Browser',
        '2. Geben Sie Ihren Zugangscode ein (siehe oben)',
        '3. Sie werden automatisch eingeloggt',
        '4. Zugewiesene Lernmodule werden angezeigt'
      ];
      
      let yPos = 225;
      instructions.forEach(line => {
        doc.text(line, 25, yPos);
        yPos += 7;
      });
      
      doc.setFontSize(8);
      doc.setTextColor(100);
      doc.text('Responda - Ausbildungsverwaltung', 105, 280, { align: 'center' });
      doc.text(new Date().toLocaleDateString('de-DE'), 105, 285, { align: 'center' });
      
      const filename = `Zugang_${access.name.replace(/ /g, '_')}.pdf`;
      doc.save(filename);
      
      showMsg('‚úÖ PDF erstellt!');
      
    } catch(e) {
      console.error('PDF Fehler:', e);
      showMsg('Fehler beim PDF-Export: ' + e.message, 'error');
    }
  };

  // ========================================
  // LERNBEREICH (VEREINFACHT)
  // ========================================
  async function loadLernbereich() {
    try {
      allModules = await pb.collection('learning_modules').getFullList({
        filter: `organization_id = "${currentUser.organization_id}"`,
        sort: '-created'
      });
      
      renderLernbereich();
    } catch(e) {
      console.error('Error:', e);
      document.getElementById('lernbereich-list').innerHTML = `<div class="empty" style="background:#fff;border-radius:.75rem"><i class="fas fa-exclamation-triangle"></i><div style="color:#c00">Fehler: ${e.message}</div></div>`;
    }
  }

  function renderLernbereich() {
    const list = document.getElementById('lernbereich-list');
    
    if (allModules.length === 0) {
      list.innerHTML = '<div class="empty" style="background:#fff;border-radius:.75rem"><i class="fas fa-laptop"></i><div>Noch keine Lernmodule</div></div>';
      return;
    }
    
    list.innerHTML = allModules.map(module => {
      const slides = module.slides || [];
      
      return `
        <div class="module-card" onclick="viewModuleDetails('${module.id}')">
          <div class="card-title"><i class="fa-solid fa-laptop"></i> ${module.title}</div>
          <div class="card-meta">
            <span><i class="fa-solid fa-layer-group"></i> ${slides.length} Folien</span>
            ${module.instructor ? `<span><i class="fa-solid fa-user"></i> ${module.instructor}</span>` : ''}
          </div>
          ${module.description ? `
            <div style="margin-top:8px;color:var(--muted);font-size:.85rem">${module.description}</div>
          ` : ''}
          ${module.require_quiz ? `
            <div style="margin-top:8px;padding:6px;background:#fee2e2;border-radius:6px;font-size:0.85rem">
              <i class="fa-solid fa-clipboard-question"></i> Abschlusspr√ºfung erforderlich (${module.passing_score}%)
            </div>
          ` : ''}
        </div>
      `;
    }).join('');
  }

  window.openModuleModal = (moduleId = null) => {
    currentEditModule = moduleId;
    const form = document.getElementById('moduleForm');
    form.reset();
    
    if (moduleId) {
      const module = allModules.find(m => m.id === moduleId);
      if (module) {
        document.getElementById('moduleModalTitle').innerHTML = '<i class="fa-solid fa-laptop-edit"></i> Lernmodul bearbeiten';
        form.title.value = module.title || '';
        form.instructor.value = module.instructor || '';
        form.description.value = module.description || '';
        form.passing_score.value = module.passing_score || 80;
        form.max_attempts.value = module.max_attempts || 3;
        form.require_quiz.checked = module.require_quiz || false;
      }
    } else {
      document.getElementById('moduleModalTitle').innerHTML = '<i class="fa-solid fa-laptop"></i> Neues Lernmodul';
    }
    
    document.getElementById('moduleModal').classList.add('show');
  };

  window.closeModuleModal = () => {
    document.getElementById('moduleModal').classList.remove('show');
    currentEditModule = null;
  };

  document.getElementById('moduleForm').onsubmit = async (e) => {
    e.preventDefault();
    
    try {
      const formData = new FormData(e.target);
      const data = {
        title: formData.get('title').trim(),
        instructor: formData.get('instructor').trim(),
        description: formData.get('description').trim(),
        passing_score: parseInt(formData.get('passing_score')) || 80,
        max_attempts: parseInt(formData.get('max_attempts')) || 3,
        require_quiz: formData.get('require_quiz') === 'on',
        slides: [],
        organization_id: currentUser.organization_id
      };
      
      if (currentEditModule) {
        const existing = allModules.find(m => m.id === currentEditModule);
        data.slides = existing.slides || [];
        await pb.collection('learning_modules').update(currentEditModule, data);
        showMsg('‚úÖ Lernmodul aktualisiert!');
      } else {
        await pb.collection('learning_modules').create(data);
        showMsg('‚úÖ Lernmodul erstellt!');
      }
      
      closeModuleModal();
      await loadLernbereich();
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.viewModuleDetails = async (moduleId) => {
    try {
      const module = await pb.collection('learning_modules').getOne(moduleId);
      const slides = module.slides || [];
      
      document.getElementById('moduleDetailsTitle').innerHTML = 
        `<i class="fa-solid fa-laptop"></i> ${module.title}`;
      
      let html = `
        <div class="details-section">
          <h4><i class="fa-solid fa-info-circle"></i> Informationen</h4>
          <div style="display:grid;grid-template-columns:150px 1fr;gap:8px">
            <div style="font-weight:700;color:#6b7280">Titel:</div>
            <div style="font-weight:700;font-size:1.1rem">${module.title}</div>
            
            ${module.instructor ? `
            <div style="font-weight:700;color:#6b7280">Dozent:</div>
            <div>${module.instructor}</div>
            ` : ''}
            
            ${module.description ? `
            <div style="font-weight:700;color:#6b7280">Beschreibung:</div>
            <div>${module.description}</div>
            ` : ''}
            
            <div style="font-weight:700;color:#6b7280">Folien:</div>
            <div><span class="badge info">${slides.length} Folien</span></div>
            
            ${module.require_quiz ? `
            <div style="font-weight:700;color:#6b7280">Abschlusspr√ºfung:</div>
            <div>
              <span class="badge warning">Erforderlich (${module.passing_score}%)</span>
              ‚Ä¢ Max. ${module.max_attempts === 0 ? '‚àû' : module.max_attempts} Versuche
            </div>
            ` : ''}
          </div>
        </div>
        
        <div style="margin-top:1rem;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn primary" onclick="openSlideEditor('${moduleId}')">
            <i class="fas fa-edit"></i> Folien bearbeiten
          </button>
          <button class="btn success" onclick="previewModule('${moduleId}')">
            <i class="fas fa-play"></i> Vorschau
          </button>
          <button class="btn info" onclick="openAssignMembersModal('${moduleId}')">
            <i class="fas fa-users"></i> Personen zuweisen
          </button>
          <button class="btn" onclick="closeModuleDetailsModal();openModuleModal('${moduleId}')">
            <i class="fas fa-cog"></i> Einstellungen
          </button>
          <button class="btn" onclick="deleteModule('${moduleId}')">
            <i class="fas fa-trash"></i> L√∂schen
          </button>
        </div>
      `;
      
      document.getElementById('moduleDetailsBody').innerHTML = html;
      document.getElementById('moduleDetailsModal').classList.add('show');
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.closeModuleDetailsModal = () => {
    document.getElementById('moduleDetailsModal').classList.remove('show');
  };

  window.deleteModule = async (moduleId) => {
    if (!confirm('Lernmodul wirklich l√∂schen?')) return;
    
    try {
      await pb.collection('learning_modules').delete(moduleId);
      showMsg('‚úÖ Lernmodul gel√∂scht!');
      closeModuleDetailsModal();
      await loadLernbereich();
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  // Weitere Lernbereich-Funktionen (Slide Editor, Preview, etc.) sind vereinfacht
  // und k√∂nnen bei Bedarf ausgebaut werden
  
  window.openSlideEditor = () => {
    showMsg('Folien-Editor in Entwicklung', 'info');
  };
  
  window.previewModule = () => {
    showMsg('Modul-Vorschau in Entwicklung', 'info');
  };
  
  window.openAssignMembersModal = () => {
    showMsg('Personen-Zuweisung in Entwicklung', 'info');
  };
  
  // ========================================
  // INIT
  // ========================================
  checkAuth().then(() => {
    loadCourses();
    setTimeout(() => {
      document.body.classList.add('loaded');
    }, 100);
  });

</script>

</body>
</html>
