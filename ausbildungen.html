<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ausbildungen ‚Äì Responda</title>
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  
  <!-- Quill Rich Text Editor -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  
  <!-- QR Code Generator -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/pocketbase@0.21.3/dist/pocketbase.umd.js"></script>

  <style>
    :root{
      --primary:#c8102e;
      --primary-light:#fee2e2;
      --success:#16a34a;
      --warning:#f59e0b;
      --info:#3b82f6;
      --bg:#f8fafc;
      --card:#fff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --gradient-start:#667eea;
      --gradient-end:#764ba2;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
      min-height:100vh;
      color:var(--text);
      font-family:'Atkinson Hyperlegible',-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      line-height:1.45;
      opacity:0;
      transition:opacity 0.3s;
      padding-bottom:80px;
    }
    body.loaded{opacity:1}
    
    header{position:sticky;top:0;background:var(--gradient-start);color:#fff;z-index:10;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    .bar{
      max-width:1400px;
      margin:0 auto;
      padding:.75rem 1rem;
      display:flex;
      gap:.5rem;
      align-items:center;
      flex-wrap:wrap;
    }
    h1{font-size:1.05rem;margin:0;font-weight:800}
    .toolbar{margin-left:auto;display:flex;gap:.5rem;flex-wrap:wrap}
    .topbtn{
      background:rgba(255,255,255,0.1);
      color:#fff;
      padding:.45rem .7rem;
      border-radius:.5rem;
      cursor:pointer;
      font-weight:700;
      font-size:.9rem;
      transition:all 0.2s;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:6px;
      border:none;
      font-family:inherit;
    }
    .topbtn:hover{background:rgba(255,255,255,0.2)}
    
    .wrap{max-width:1400px;margin:1.5rem auto;padding:0 1rem}
    
    .tabs{
      display:flex;
      gap:.5rem;
      margin-bottom:1.5rem;
      background:#fff;
      padding:.5rem;
      border-radius:.75rem;
      box-shadow:0 2px 8px rgba(0,0,0,.05);
      overflow-x:auto;
    }
    .tab{
      padding:.6rem 1.25rem;
      border-radius:.5rem;
      cursor:pointer;
      font-weight:700;
      transition:all 0.2s;
      white-space:nowrap;
      border:none;
      background:transparent;
      color:var(--muted);
      font-family:inherit;
      font-size:.9rem;
    }
    .tab:hover{background:#f9fafb;color:var(--text)}
    .tab.active{background:var(--primary);color:#fff}
    
    .actions{
      display:flex;
      gap:.5rem;
      margin-bottom:1rem;
      flex-wrap:wrap;
    }
    .btn{
      background:#fff;
      color:var(--text);
      padding:.6rem 1rem;
      border-radius:.5rem;
      cursor:pointer;
      font-weight:700;
      transition:all 0.2s;
      font-family:inherit;
      border:1px solid var(--border);
      display:inline-flex;
      align-items:center;
      gap:.5rem;
      font-size:.9rem;
    }
    .btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn.primary:hover{background:#a80d25}
    .btn.success{background:var(--success);color:#fff;border-color:var(--success)}
    .btn.info{background:var(--info);color:#fff;border-color:var(--info)}
    .btn.warning{background:var(--warning);color:#fff;border-color:var(--warning)}
    .btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
    .btn-sm{padding:.4rem .7rem;font-size:.85rem}
    
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
      gap:16px;
    }
    
    .course-card, .member-card, .module-card{
      background:#fff;
      border-radius:.75rem;
      padding:1.5rem;
      box-shadow:0 2px 8px rgba(0,0,0,.05);
      transition:all 0.2s;
      border:2px solid transparent;
      cursor:pointer;
    }
    .course-card:hover, .member-card:hover, .module-card:hover{
      transform:translateY(-4px);
      box-shadow:0 8px 20px rgba(0,0,0,.12);
      border-color:var(--primary-light);
    }
    
    .card-title{
      font-weight:800;
      font-size:1.2rem;
      margin-bottom:.5rem;
      color:var(--text);
    }
    .card-meta{
      font-size:.85rem;
      color:var(--muted);
      margin-bottom:.5rem;
      display:flex;
      gap:.5rem;
      flex-wrap:wrap;
      align-items:center;
    }
    
    .badge{
      padding:.25rem .6rem;
      border-radius:999px;
      font-size:.75rem;
      font-weight:700;
      white-space:nowrap;
    }
    .badge.online{background:#dbeafe;color:#1e40af}
    .badge.pr√§senz{background:#fef3c7;color:#92400e}
    .badge.hybrid{background:#e0e7ff;color:#4338ca}
    .badge.geplant{background:#e0e7ff;color:#4338ca}
    .badge.l√§uft{background:#dcfce7;color:#166534}
    .badge.abgeschlossen{background:#f3f4f6;color:#4b5563}
    .badge.abgesagt{background:#fee2e2;color:#991b1b}
    .badge.anwesend{background:#dcfce7;color:#166534}
    .badge.abwesend{background:#fee2e2;color:#991b1b}
    .badge.zugesagt{background:#dcfce7;color:#166534}
    .badge.eingeladen{background:#e0e7ff;color:#4338ca}
    .badge.info{background:#dbeafe;color:#1e40af}
    .badge.warning{background:#fef3c7;color:#92400e}
    
    .tag{background:#fee;color:var(--primary);padding:4px 10px;border-radius:999px;font-size:0.8rem;font-weight:700;display:inline-block;margin:2px}
    
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:1000;
      padding:20px;
      overflow-y:auto;
    }
    .modal.show{display:flex}
    .modal-box{
      background:#fff;
      border-radius:14px;
      max-width:1000px;
      width:100%;
      max-height:85vh;
      overflow-y:auto;
      padding:24px;
      box-shadow:0 8px 20px rgba(0,0,0,.3);
      margin:auto;
    }
    .modal-box h3{margin:0 0 1rem 0;color:var(--primary);font-weight:800}
    
    .form-grid{display:grid;gap:1rem;grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}
    .form-group{display:flex;flex-direction:column;gap:6px}
    .form-group label{font-weight:700;font-size:.9rem;color:#374151}
    .form-group input,
    .form-group textarea,
    .form-group select{
      padding:.6rem;
      border:1px solid var(--border);
      border-radius:.5rem;
      background:#fff;
      font-size:16px;
      font-family:inherit;
      width:100%;
    }
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(200,16,46,0.1);
    }
    
    .tag-input-wrapper{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      padding:8px;
      border:1px solid #d1d5db;
      border-radius:8px;
      min-height:44px;
      align-items:center;
      background:#fff;
    }
    .tag-input-wrapper:focus-within{
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(200,16,46,0.1);
    }
    .tag-input-wrapper .tag{display:flex;align-items:center;gap:4px}
    .tag-input-wrapper .tag .remove-tag{cursor:pointer;font-weight:bold;margin-left:4px}
    .tag-input-wrapper input{border:none;outline:none;flex:1;min-width:100px;font-size:16px;padding:4px}
    
    .table{
      width:100%;
      border-collapse:collapse;
      background:#fff;
      border-radius:.75rem;
      overflow:hidden;
      box-shadow:0 2px 8px rgba(0,0,0,.05);
    }
    .table th,
    .table td{
      padding:.75rem 1rem;
      text-align:left;
      border-bottom:1px solid var(--border);
    }
    .table th{
      background:#f9fafb;
      font-weight:700;
      font-size:.9rem;
    }
    .table tr:hover{background:#f9fafb}
    .table tr:last-child td{border-bottom:none}
    
    .ql-container{
      font-family:'Atkinson Hyperlegible',-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      font-size:1rem;
      min-height:200px;
      max-height:300px;
    }
    .ql-editor{
      min-height:200px;
      max-height:300px;
      overflow-y:auto;
    }
    
    .access-code-box{
      background:#f9fafb;
      padding:1.5rem;
      border-radius:.75rem;
      border:2px dashed var(--primary);
      text-align:center;
    }
    .access-code{
      font-size:2rem;
      font-weight:800;
      font-family:monospace;
      color:var(--primary);
      margin:1rem 0;
    }
    
    .copy-box{
      background:#f9fafb;
      padding:.75rem;
      border-radius:.5rem;
      border:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:.5rem;
      font-family:monospace;
      font-size:.85rem;
    }
    
    .slide-item{
      background:#f9fafb;
      padding:1rem;
      border-radius:.5rem;
      border-left:4px solid var(--primary);
      display:flex;
      justify-content:space-between;
      align-items:center;
      cursor:move;
      transition:all 0.2s;
      margin-bottom:.75rem;
    }
    .slide-item:hover{
      background:#f3f4f6;
      transform:translateX(4px);
    }
    
    .slide-type-icon{
      width:40px;
      height:40px;
      border-radius:.5rem;
      display:flex;
      align-items:center;
      justify-content:center;
      margin-right:1rem;
      font-size:1.2rem;
    }
    .slide-type-icon.text{background:#dbeafe;color:#1e40af}
    .slide-type-icon.image{background:#dcfce7;color:#166534}
    .slide-type-icon.video{background:#fef3c7;color:#92400e}
    .slide-type-icon.quiz{background:#fee2e2;color:#991b1b}
    
    .progress-bar{
      width:100%;
      height:8px;
      background:#e5e7eb;
      border-radius:999px;
      overflow:hidden;
      margin:.5rem 0;
    }
    .progress-bar-fill{
      height:100%;
      background:var(--success);
      transition:width 0.3s;
    }
    
    .status-icon{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:24px;
      height:24px;
      border-radius:50%;
      font-size:.85rem;
    }
    .status-icon.completed{background:#dcfce7;color:#166534}
    .status-icon.progress{background:#fef3c7;color:#92400e}
    .status-icon.failed{background:#fee2e2;color:#991b1b}
    .status-icon.pending{background:#e5e7eb;color:#6b7280}
    
    .empty{
      text-align:center;
      padding:3rem 1rem;
      color:var(--muted);
    }
    .empty i{font-size:4rem;margin-bottom:1rem;opacity:0.3}
    
    .msg{
      position: fixed;
      top: 2rem;
      right: 2rem;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      z-index: 10000;
      animation: slideInFromRight 0.3s ease-out;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .msg.error{background:#fee;color:#c00;border:1px solid #fcc}
    .msg.success{background:#efe;color:#060;border:1px solid #cfc}
    .msg.info{background:#eff6ff;color:#1e40af;border:1px solid #bfdbfe}
    
    @keyframes slideInFromRight {
      from { 
        opacity: 0; 
        transform: translateX(100%); 
      }
      to { 
        opacity: 1; 
        transform: translateX(0); 
      }
    }
    
    .details-section{
      margin:20px 0;
      padding:16px;
      background:#f9fafb;
      border-radius:8px;
    }
    .details-section h4{
      margin:0 0 12px 0;
      color:var(--primary);
      font-size:1rem;
    }
    
    @media (max-width:768px){
      .bar{flex-direction:column;align-items:stretch}
      h1{font-size:1rem}
      .toolbar{margin-left:0;width:100%;justify-content:space-between}
      .topbtn{flex:1;justify-content:center}
      .tabs{padding:.25rem}
      .tab{padding:.5rem 1rem;font-size:.85rem}
      .grid{grid-template-columns:1fr}
      .actions{flex-direction:column}
      .btn{width:100%;justify-content:center}
      .table{font-size:.85rem}
      .table th,.table td{padding:.5rem}
      .form-grid{grid-template-columns:1fr}
    }
  </style>
</head>

<body>

<!-- HEADER -->
<header>
  <div class="bar">
    <h1><i class="fa-solid fa-graduation-cap"></i> Ausbildungen</h1>
    <div class="toolbar">
      <a class="topbtn" href="mpg-dashboard.html">
        <i class="fa-solid fa-dashboard"></i> Dashboard
      </a>
      <button class="topbtn" id="logout">
        <i class="fa-solid fa-right-from-bracket"></i> Logout
      </button>
    </div>
  </div>
</header>
<!-- MAIN CONTENT -->
<div class="wrap">
  
  <!-- TABS -->
  <div class="tabs">
    <button class="tab active" data-tab="schulungen">
      <i class="fa-solid fa-book-medical"></i> Schulungen
    </button>
    <button class="tab" data-tab="team">
      <i class="fa-solid fa-users"></i> Team
    </button>
    <button class="tab" data-tab="lernbereich">
      <i class="fa-solid fa-laptop"></i> Lernbereich
    </button>
    <button class="tab" data-tab="settings">
      <i class="fa-solid fa-cog"></i> Einstellungen
    </button>
  </div>

  <!-- TAB: SCHULUNGEN -->
  <div class="tab-content" id="tab-schulungen">
    <div class="actions">
      <button class="btn primary" onclick="openSchulungModal()">
        <i class="fas fa-plus"></i> Neue Schulung
      </button>
    </div>
    <div class="grid" id="schulungen-list"></div>
  </div>

  <!-- TAB: TEAM -->
  <div class="tab-content" id="tab-team" style="display:none">
    <div class="actions">
      <button class="btn primary" onclick="openMemberModal()">
        <i class="fas fa-user-plus"></i> Neues Mitglied
      </button>
      <button class="btn success" onclick="exportAllMembersStats()">
        <i class="fas fa-file-pdf"></i> Team-Statistik PDF
      </button>
    </div>
    <div class="grid" id="team-list"></div>
  </div>

  <!-- TAB: LERNBEREICH -->
  <div class="tab-content" id="tab-lernbereich" style="display:none">
    <div class="actions">
      <button class="btn primary" onclick="openModuleModal()">
        <i class="fas fa-plus"></i> Neues Lernmodul
      </button>
    </div>
    <div class="grid" id="lernbereich-list"></div>
  </div>

  <!-- TAB: EINSTELLUNGEN -->
  <div class="tab-content" id="tab-settings" style="display:none">
    
    <!-- Pflicht-Schulungen -->
    <div style="background:#fff;border-radius:.75rem;padding:1.5rem;margin-bottom:1.5rem;box-shadow:0 2px 8px rgba(0,0,0,.05)">
      <h3 style="margin:0 0 1rem 0;color:var(--primary)">
        <i class="fa-solid fa-graduation-cap"></i> Pflicht-Schulungen pro Jahr
      </h3>
      <form id="pflichtForm">
        <div style="display:flex;gap:1rem;align-items:end;flex-wrap:wrap">
          <div class="form-group" style="flex:1;min-width:200px">
            <label>Anzahl Pflicht-Schulungen</label>
            <input type="number" id="pflicht_schulungen" min="0" max="50" value="12">
          </div>
          <button type="submit" class="btn primary">
            <i class="fas fa-save"></i> Speichern
          </button>
        </div>
      </form>
    </div>

    <!-- Zug√§nge -->
    <div style="background:#fff;border-radius:.75rem;padding:1.5rem;box-shadow:0 2px 8px rgba(0,0,0,.05)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;flex-wrap:wrap;gap:1rem">
        <h3 style="margin:0;color:var(--primary)">
          <i class="fa-solid fa-key"></i> Externe Zug√§nge
        </h3>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn primary" onclick="openSingleAccessModal()">
            <i class="fas fa-plus"></i> Einzelner Zugang
          </button>
          <button class="btn primary" onclick="openBulkAccessModal()">
            <i class="fas fa-users"></i> Mehrere Zug√§nge
          </button>
          <button class="btn success" onclick="exportAccessCodes()">
            <i class="fas fa-file-csv"></i> CSV Export
          </button>
          <button class="btn success" onclick="exportAllAccessPDFs()">
            <i class="fas fa-file-pdf"></i> Alle PDFs
          </button>
        </div>
      </div>
      <div id="access-list"></div>
    </div>

  </div>

</div>

<!-- Modal: Neue Schulung -->
<div class="modal" id="schulungModal">
  <div class="modal-box">
    <h3 id="schulungModalTitle"><i class="fa-solid fa-book-medical"></i> Neue Schulung erstellen</h3>
    <form id="schulungForm">
      <div class="form-grid">
        <div class="form-group">
          <label>Titel *</label>
          <input type="text" name="title" required>
        </div>
        <div class="form-group">
          <label>Dozent/in</label>
          <input type="text" name="instructor">
        </div>
      </div>
      <div class="form-group">
        <label>Beschreibung</label>
        <textarea name="description" rows="3"></textarea>
      </div>
      
      <h4 style="margin:1.5rem 0 1rem 0;color:var(--primary)">
        <i class="fa-solid fa-calendar"></i> Erster Termin
      </h4>
      
      <div class="form-grid">
        <div class="form-group">
          <label>Datum *</label>
          <input type="date" name="date" required>
        </div>
        <div class="form-group">
          <label>Startzeit</label>
          <input type="time" name="start_time">
        </div>
        <div class="form-group">
          <label>Endzeit</label>
          <input type="time" name="end_time">
        </div>
        <div class="form-group">
          <label>Ort</label>
          <input type="text" name="location">
        </div>
      </div>
      
      <div class="form-group">
        <label>Teilnehmer einladen</label>
        <div style="display:flex;gap:8px;align-items:center">
          <button type="button" class="btn" onclick="openParticipantSelector()">
            <i class="fas fa-users"></i> Teilnehmer ausw√§hlen
          </button>
          <span id="selected-count" style="color:var(--muted);font-weight:700">0 ausgew√§hlt</span>
        </div>
      </div>
      
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
        <button type="button" class="btn" onclick="closeSchulungModal()">Abbrechen</button>
        <button type="submit" class="btn primary"><i class="fa-solid fa-save"></i> Schulung erstellen</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Teilnehmer ausw√§hlen -->
<div class="modal" id="participantModal">
  <div class="modal-box" style="max-width:600px">
    <h3><i class="fa-solid fa-users"></i> Teilnehmer ausw√§hlen</h3>
    <div id="participantList" style="max-height:400px;overflow-y:auto"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
      <button class="btn primary" onclick="closeParticipantModal()">
        <i class="fa-solid fa-check"></i> Fertig
      </button>
    </div>
  </div>
</div>

<!-- Modal: Schulungs-Details -->
<div class="modal" id="schulungDetailsModal">
  <div class="modal-box" style="max-width:1200px">
    <h3 id="schulungDetailsTitle">Schulung</h3>
    <div id="schulungDetailsBody"></div>
  </div>
</div>

<!-- Modal: Weiteren Termin hinzuf√ºgen -->
<div class="modal" id="addSessionModal">
  <div class="modal-box">
    <h3><i class="fa-solid fa-calendar-plus"></i> Weiteren Termin hinzuf√ºgen</h3>
    <form id="addSessionForm">
      <input type="hidden" id="add-session-course-id">
      
      <div class="form-grid">
        <div class="form-group">
          <label>Datum *</label>
          <input type="date" name="date" required>
        </div>
        <div class="form-group">
          <label>Startzeit</label>
          <input type="time" name="start_time">
        </div>
        <div class="form-group">
          <label>Endzeit</label>
          <input type="time" name="end_time">
        </div>
        <div class="form-group">
          <label>Ort</label>
          <input type="text" name="location">
        </div>
      </div>
      
      <div class="form-group">
        <label>Dozent/in</label>
        <input type="text" name="dozent">
      </div>
      
      <div class="form-group">
        <label>Beschreibung</label>
        <textarea name="beschreibung" rows="3"></textarea>
      </div>
      
      <div class="form-group">
        <label>Teilnehmer einladen</label>
        <div style="display:flex;gap:8px;align-items:center">
          <button type="button" class="btn" onclick="openParticipantSelectorForAdd()">
            <i class="fas fa-users"></i> Teilnehmer ausw√§hlen
          </button>
          <span id="add-selected-count" style="color:var(--muted);font-weight:700">0 ausgew√§hlt</span>
        </div>
      </div>
      
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
        <button type="button" class="btn" onclick="closeAddSessionModal()">Abbrechen</button>
        <button type="submit" class="btn primary"><i class="fa-solid fa-save"></i> Termin hinzuf√ºgen</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Termin bearbeiten -->
<div class="modal" id="editSessionModal">
  <div class="modal-box">
    <h3><i class="fa-solid fa-edit"></i> Termin bearbeiten</h3>
    <form id="editSessionForm">
      <input type="hidden" id="edit-session-id">
      
      <div class="form-grid">
        <div class="form-group">
          <label>Datum *</label>
          <input type="date" id="edit-session-date" name="date" required>
        </div>
        <div class="form-group">
          <label>Startzeit</label>
          <input type="time" id="edit-session-start" name="start_time">
        </div>
        <div class="form-group">
          <label>Endzeit</label>
          <input type="time" id="edit-session-end" name="end_time">
        </div>
        <div class="form-group">
          <label>Ort</label>
          <input type="text" id="edit-session-location" name="location">
        </div>
      </div>
      
      <div class="form-group">
        <label>Dozent/in</label>
        <input type="text" id="edit-session-dozent" name="dozent">
      </div>
      
      <div class="form-group">
        <label>Beschreibung</label>
        <textarea id="edit-session-beschreibung" name="beschreibung" rows="3"></textarea>
      </div>
      
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
        <button type="button" class="btn" onclick="closeEditSessionModal()">Abbrechen</button>
        <button type="submit" class="btn primary"><i class="fa-solid fa-save"></i> Speichern</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Termin-Details -->
<div class="modal" id="sessionDetailsModal">
  <div class="modal-box" style="max-width:1000px">
    <h3 id="sessionDetailsTitle">Termin-Details</h3>
    <div id="sessionDetailsBody"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
      <button class="btn" onclick="closeSessionDetailsModal()">Schlie√üen</button>
      <button class="btn success" onclick="saveAttendance()">
        <i class="fas fa-save"></i> Anwesenheit speichern
      </button>
    </div>
  </div>
</div>

<!-- Modal: Neues Team-Mitglied -->
<div class="modal" id="memberModal">
  <div class="modal-box">
    <h3 id="memberModalTitle"><i class="fa-solid fa-user-plus"></i> Neues Team-Mitglied</h3>
    <form id="memberForm">
      <div class="form-grid">
        <div class="form-group">
          <label>Vorname *</label>
          <input type="text" name="vorname" required>
        </div>
        <div class="form-group">
          <label>Nachname *</label>
          <input type="text" name="name" required>
        </div>
      </div>
      <div class="form-group">
        <label>Qualifikationen</label>
        <div class="tag-input-wrapper" id="tagInputWrapper">
          <input type="text" id="tagInput" placeholder="Enter dr√ºcken zum Hinzuf√ºgen">
        </div>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
        <button type="button" class="btn" onclick="closeMemberModal()">Abbrechen</button>
        <button type="submit" class="btn primary"><i class="fa-solid fa-save"></i> Speichern</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Member Details -->
<div class="modal" id="memberDetailsModal">
  <div class="modal-box" style="max-width:1000px">
    <h3 id="memberDetailsTitle">Team-Mitglied</h3>
    <div id="memberDetailsBody"></div>
  </div>
</div>

<!-- Modal: Zugang f√ºr Mitglied erstellen -->
<div class="modal" id="createAccessForMemberModal">
  <div class="modal-box" style="max-width:600px">
    <h3><i class="fa-solid fa-key"></i> Zugang erstellen</h3>
    <p style="margin-bottom:1rem">Erstelle einen Zugang f√ºr: <strong id="access-member-name"></strong></p>
    
    <div class="access-code-box">
      <div style="font-size:.9rem;color:var(--muted);margin-bottom:.5rem">Generierter Zugangscode:</div>
      <div class="access-code" id="member-access-code">wort.wort.wort</div>
      <button class="btn btn-sm" onclick="generateMemberAccessCode()">
        <i class="fas fa-sync"></i> Neuen Code generieren
      </button>
    </div>
    
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
      <button class="btn" onclick="closeCreateAccessForMemberModal()">Abbrechen</button>
      <button class="btn primary" onclick="saveAccessForMember()">
        <i class="fa-solid fa-save"></i> Zugang erstellen
      </button>
    </div>
  </div>
</div>

<!-- Modal: Einzelner Zugang -->
<div class="modal" id="singleAccessModal">
  <div class="modal-box" style="max-width:600px">
    <h3><i class="fa-solid fa-key"></i> Einzelnen Zugang erstellen</h3>
    
    <div class="access-code-box" style="margin-bottom:1rem">
      <div style="font-size:.9rem;color:var(--muted);margin-bottom:.5rem">Generierter Zugangscode:</div>
      <div class="access-code" id="preview-code">wort.wort.wort</div>
      <button class="btn btn-sm" onclick="generatePreviewCode()">
        <i class="fas fa-sync"></i> Neuen Code generieren
      </button>
    </div>
    
    <form id="singleAccessForm">
      <div class="form-group">
        <label>Name der Person *</label>
        <input type="text" name="name" required placeholder="z.B. Max Mustermann">
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
        <button type="button" class="btn" onclick="closeSingleAccessModal()">Abbrechen</button>
        <button type="submit" class="btn primary"><i class="fa-solid fa-save"></i> Zugang erstellen</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Mehrere Zug√§nge -->
<div class="modal" id="bulkAccessModal">
  <div class="modal-box" style="max-width:700px">
    <h3><i class="fa-solid fa-users"></i> Mehrere Zug√§nge erstellen</h3>
    <p style="color:var(--muted);margin-bottom:1rem">F√ºr jeden Namen wird automatisch ein 3-Wort-Code generiert.</p>
    
    <form id="bulkAccessForm">
      <div id="bulkAccessList"></div>
      
      <button type="button" class="btn btn-sm" onclick="addBulkAccessRow()" style="margin-top:8px">
        <i class="fas fa-plus"></i> Weitere Person
      </button>
      
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
        <button type="button" class="btn" onclick="closeBulkAccessModal()">Abbrechen</button>
        <button type="submit" class="btn primary"><i class="fa-solid fa-save"></i> Alle Zug√§nge erstellen</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Neues Lernmodul -->
<div class="modal" id="moduleModal">
  <div class="modal-box">
    <h3 id="moduleModalTitle"><i class="fa-solid fa-laptop"></i> Neues Lernmodul</h3>
    <form id="moduleForm">
      <div class="form-grid">
        <div class="form-group">
          <label>Titel *</label>
          <input type="text" name="title" required>
        </div>
        <div class="form-group">
          <label>Dozent</label>
          <input type="text" name="instructor">
        </div>
      </div>
      <div class="form-group">
        <label>Beschreibung</label>
        <textarea name="description" rows="3"></textarea>
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label>Bestehensgrenze (%)</label>
          <input type="number" name="passing_score" value="80" min="0" max="100">
        </div>
        <div class="form-group">
          <label>Max. Versuche</label>
          <input type="number" name="max_attempts" value="3" min="0">
          <small style="color:var(--muted);font-size:.85rem">0 = unbegrenzt</small>
        </div>
      </div>
      <div class="form-group">
        <label style="display:flex;align-items:center;gap:.5rem">
          <input type="checkbox" name="require_quiz" id="require-quiz">
          <span>Abschlusspr√ºfung erforderlich</span>
        </label>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
        <button type="button" class="btn" onclick="closeModuleModal()">Abbrechen</button>
        <button type="submit" class="btn primary"><i class="fa-solid fa-save"></i> Speichern</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Lernmodul Details -->
<div class="modal" id="moduleDetailsModal">
  <div class="modal-box">
    <h3 id="moduleDetailsTitle">Lernmodul</h3>
    <div id="moduleDetailsBody"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
      <button class="btn" onclick="closeModuleDetailsModal()">Schlie√üen</button>
    </div>
  </div>
</div>

<!-- Modal: Folien-Editor -->
<div class="modal" id="slideEditorModal">
  <div class="modal-box" style="max-height:90vh;display:flex;flex-direction:column">
    <h3 id="slideEditorTitle">Folien bearbeiten</h3>
    
    <div class="msg info" style="margin-bottom:1rem;position:relative;animation:none">
      <i class="fas fa-info-circle"></i> Erstelle interaktive Lernfolien f√ºr dein Modul
    </div>
    
    <div style="margin-bottom:1rem">
      <button class="btn primary" onclick="openNewSlideModal()">
        <i class="fas fa-plus"></i> Neue Folie
      </button>
    </div>
    
    <div id="slides-list" style="flex:1;overflow-y:auto;margin-bottom:1rem"></div>
    
    <div style="display:flex;gap:.5rem;justify-content:flex-end;padding-top:1rem;border-top:1px solid var(--border)">
      <button class="btn" onclick="closeSlideEditor()">Schlie√üen</button>
      <button class="btn success" onclick="previewModule(currentLearningModule)">
        <i class="fas fa-play"></i> Vorschau
      </button>
    </div>
  </div>
</div>

<!-- Modal: Neue Folie -->
<div class="modal" id="newSlideModal">
  <div class="modal-box" style="max-height:85vh;display:flex;flex-direction:column">
    <h3>Neue Folie</h3>
    
    <div style="flex:1;overflow-y:auto;padding-right:1rem">
      <form id="newSlideForm">
        <div class="form-group">
          <label>Folientyp *</label>
          <select id="slide-type" onchange="updateSlideTypeFields()">
            <option value="text">üìù Text-Folie</option>
            <option value="image">üñºÔ∏è Bild-Folie</option>
            <option value="video">üé• Video-Folie</option>
            <option value="quiz">‚ùì Quiz-Folie</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Titel *</label>
          <input type="text" id="slide-title" placeholder="z.B. Einf√ºhrung" required>
        </div>
        
        <div class="form-group">
          <label>Gesch√§tzte Dauer (Minuten)</label>
          <input type="number" id="slide-duration" value="5" min="1">
        </div>
        
        <!-- Text Slide -->
        <div id="text-slide-fields" class="form-group">
          <label>Inhalt</label>
          <div id="slide-content-editor" style="height:250px"></div>
        </div>
        
        <!-- Image Slide -->
        <div id="image-slide-fields" style="display:none">
          <div class="form-group">
            <label>Bild-URL</label>
            <input type="text" id="slide-image-url" placeholder="https://...">
          </div>
          <div class="form-group">
            <label>Bildbeschreibung</label>
            <textarea id="slide-image-description" rows="3"></textarea>
          </div>
        </div>
        
        <!-- Video Slide -->
        <div id="video-slide-fields" style="display:none">
          <div class="form-group">
            <label>Video-URL (YouTube/Vimeo)</label>
            <input type="text" id="slide-video-url" placeholder="https://www.youtube.com/watch?v=...">
          </div>
          <div class="form-group">
            <label>Video-Beschreibung</label>
            <textarea id="slide-video-description" rows="3"></textarea>
          </div>
        </div>
        
        <!-- Quiz Slide -->
        <div id="quiz-slide-fields" style="display:none">
          <div class="form-group">
            <label>Frage *</label>
            <input type="text" id="slide-quiz-question" placeholder="Frage eingeben">
          </div>
          <div class="form-group">
            <label>Antwortm√∂glichkeiten</label>
            <div id="quiz-answers-list"></div>
            <button type="button" class="btn btn-sm" onclick="addQuizAnswer()">
              <i class="fas fa-plus"></i> Antwort hinzuf√ºgen
            </button>
          </div>
          <div class="form-group">
            <label>Erkl√§rung</label>
            <textarea id="slide-quiz-explanation" rows="2"></textarea>
          </div>
        </div>
      </form>
    </div>
    
    <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:1rem;padding-top:1rem;border-top:1px solid var(--border)">
      <button class="btn" onclick="closeNewSlideModal()">Abbrechen</button>
      <button class="btn primary" onclick="saveSlide()">
        <i class="fas fa-save"></i> Speichern
      </button>
    </div>
  </div>
</div>

<!-- Modal: Modul Vorschau -->
<div class="modal" id="modulePreviewModal">
  <div class="modal-box" style="max-height:90vh;display:flex;flex-direction:column">
    <h3 id="previewModuleTitle">Vorschau</h3>
    
    <div id="previewContent" style="flex:1;overflow-y:auto;margin:1rem 0"></div>
    
    <div style="display:flex;gap:.5rem;justify-content:space-between;align-items:center;padding-top:1rem;border-top:1px solid var(--border)">
      <button class="btn" onclick="prevPreviewSlide()" id="prevSlideBtn">
        <i class="fas fa-arrow-left"></i> Zur√ºck
      </button>
      <div id="slideCounter" style="font-weight:700;color:var(--muted)">1 / 1</div>
      <button class="btn" onclick="nextPreviewSlide()" id="nextSlideBtn">
        Weiter <i class="fas fa-arrow-right"></i>
      </button>
    </div>
    
    <div style="display:flex;gap:.5rem;justify-content:center;margin-top:1rem">
      <button class="btn" onclick="closePreviewModal()">Schlie√üen</button>
    </div>
  </div>
</div>

<!-- Modal: Personen zuweisen -->
<div class="modal" id="assignMembersModal">
  <div class="modal-box" style="max-width:600px">
    <h3><i class="fa-solid fa-users"></i> Personen zuweisen</h3>
    <p style="color:var(--muted);margin-bottom:1rem">W√§hle die Team-Mitglieder aus, die dieses Lernmodul sehen sollen.</p>
    <div id="assignMembersList" style="max-height:400px;overflow-y:auto"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
      <button class="btn" onclick="closeAssignMembersModal()">Abbrechen</button>
      <button class="btn primary" onclick="saveAssignments()">
        <i class="fa-solid fa-save"></i> Speichern
      </button>
    </div>
  </div>
</div>
<!-- Modal: Neues Lernmodul -->
<div class="modal" id="moduleModal">
  <div class="modal-box">
    <h3 id="moduleModalTitle"><i class="fa-solid fa-laptop"></i> Neues Lernmodul</h3>
    <form id="moduleForm">
      <div class="form-grid">
        <div class="form-group">
          <label>Titel *</label>
          <input type="text" name="title" required>
        </div>
        <div class="form-group">
          <label>Dozent</label>
          <input type="text" name="instructor">
        </div>
      </div>
      <div class="form-group">
        <label>Beschreibung</label>
        <textarea name="description" rows="3"></textarea>
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label>Bestehensgrenze (%)</label>
          <input type="number" name="passing_score" value="80" min="0" max="100">
        </div>
        <div class="form-group">
          <label>Max. Versuche</label>
          <input type="number" name="max_attempts" value="3" min="0">
          <small style="color:var(--muted);font-size:.85rem">0 = unbegrenzt</small>
        </div>
      </div>
      <div class="form-group">
        <label style="display:flex;align-items:center;gap:.5rem">
          <input type="checkbox" name="require_quiz" id="require-quiz">
          <span>Abschlusspr√ºfung erforderlich</span>
        </label>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
        <button type="button" class="btn" onclick="closeModuleModal()">Abbrechen</button>
        <button type="submit" class="btn primary"><i class="fa-solid fa-save"></i> Speichern</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Lernmodul Details -->
<div class="modal" id="moduleDetailsModal">
  <div class="modal-box">
    <h3 id="moduleDetailsTitle">Lernmodul</h3>
    <div id="moduleDetailsBody"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
      <button class="btn" onclick="closeModuleDetailsModal()">Schlie√üen</button>
    </div>
  </div>
</div>

<!-- Modal: Folien-Editor -->
<div class="modal" id="slideEditorModal">
  <div class="modal-box" style="max-height:90vh;display:flex;flex-direction:column">
    <h3 id="slideEditorTitle">Folien bearbeiten</h3>
    
    <div class="msg info" style="margin-bottom:1rem;position:relative;animation:none">
      <i class="fas fa-info-circle"></i> Erstelle interaktive Lernfolien f√ºr dein Modul
    </div>
    
    <div style="margin-bottom:1rem">
      <button class="btn primary" onclick="openNewSlideModal()">
        <i class="fas fa-plus"></i> Neue Folie
      </button>
    </div>
    
    <div id="slides-list" style="flex:1;overflow-y:auto;margin-bottom:1rem"></div>
    
    <div style="display:flex;gap:.5rem;justify-content:flex-end;padding-top:1rem;border-top:1px solid var(--border)">
      <button class="btn" onclick="closeSlideEditor()">Schlie√üen</button>
      <button class="btn success" onclick="previewModule(currentLearningModule)">
        <i class="fas fa-play"></i> Vorschau
      </button>
    </div>
  </div>
</div>

<!-- Modal: Neue Folie -->
<div class="modal" id="newSlideModal">
  <div class="modal-box" style="max-height:85vh;display:flex;flex-direction:column">
    <h3>Neue Folie</h3>
    
    <div style="flex:1;overflow-y:auto;padding-right:1rem">
      <form id="newSlideForm">
        <div class="form-group">
          <label>Folientyp *</label>
          <select id="slide-type" onchange="updateSlideTypeFields()">
            <option value="text">üìù Text-Folie</option>
            <option value="image">üñºÔ∏è Bild-Folie</option>
            <option value="video">üé• Video-Folie</option>
            <option value="quiz">‚ùì Quiz-Folie</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Titel *</label>
          <input type="text" id="slide-title" placeholder="z.B. Einf√ºhrung" required>
        </div>
        
        <div class="form-group">
          <label>Gesch√§tzte Dauer (Minuten)</label>
          <input type="number" id="slide-duration" value="5" min="1">
        </div>
        
        <!-- Text Slide -->
        <div id="text-slide-fields" class="form-group">
          <label>Inhalt</label>
          <div id="slide-content-editor" style="height:250px"></div>
        </div>
        
        <!-- Image Slide -->
        <div id="image-slide-fields" style="display:none">
          <div class="form-group">
            <label>Bild-URL</label>
            <input type="text" id="slide-image-url" placeholder="https://...">
          </div>
          <div class="form-group">
            <label>Bildbeschreibung</label>
            <textarea id="slide-image-description" rows="3"></textarea>
          </div>
        </div>
        
        <!-- Video Slide -->
        <div id="video-slide-fields" style="display:none">
          <div class="form-group">
            <label>Video-URL (YouTube/Vimeo)</label>
            <input type="text" id="slide-video-url" placeholder="https://www.youtube.com/watch?v=...">
          </div>
          <div class="form-group">
            <label>Video-Beschreibung</label>
            <textarea id="slide-video-description" rows="3"></textarea>
          </div>
        </div>
        
        <!-- Quiz Slide -->
        <div id="quiz-slide-fields" style="display:none">
          <div class="form-group">
            <label>Frage *</label>
            <input type="text" id="slide-quiz-question" placeholder="Frage eingeben">
          </div>
          <div class="form-group">
            <label>Antwortm√∂glichkeiten</label>
            <div id="quiz-answers-list"></div>
            <button type="button" class="btn btn-sm" onclick="addQuizAnswer()">
              <i class="fas fa-plus"></i> Antwort hinzuf√ºgen
            </button>
          </div>
          <div class="form-group">
            <label>Erkl√§rung</label>
            <textarea id="slide-quiz-explanation" rows="2"></textarea>
          </div>
        </div>
      </form>
    </div>
    
    <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:1rem;padding-top:1rem;border-top:1px solid var(--border)">
      <button class="btn" onclick="closeNewSlideModal()">Abbrechen</button>
      <button class="btn primary" onclick="saveSlide()">
        <i class="fas fa-save"></i> Speichern
      </button>
    </div>
  </div>
</div>

<!-- Modal: Modul Vorschau -->
<div class="modal" id="modulePreviewModal">
  <div class="modal-box" style="max-height:90vh;display:flex;flex-direction:column">
    <h3 id="previewModuleTitle">Vorschau</h3>
    
    <div id="previewContent" style="flex:1;overflow-y:auto;margin:1rem 0"></div>
    
    <div style="display:flex;gap:.5rem;justify-content:space-between;align-items:center;padding-top:1rem;border-top:1px solid var(--border)">
      <button class="btn" onclick="prevPreviewSlide()" id="prevSlideBtn">
        <i class="fas fa-arrow-left"></i> Zur√ºck
      </button>
      <div id="slideCounter" style="font-weight:700;color:var(--muted)">1 / 1</div>
      <button class="btn" onclick="nextPreviewSlide()" id="nextSlideBtn">
        Weiter <i class="fas fa-arrow-right"></i>
      </button>
    </div>
    
    <div style="display:flex;gap:.5rem;justify-content:center;margin-top:1rem">
      <button class="btn" onclick="closePreviewModal()">Schlie√üen</button>
    </div>
  </div>
</div>

<!-- Modal: Personen zuweisen -->
<div class="modal" id="assignMembersModal">
  <div class="modal-box" style="max-width:600px">
    <h3><i class="fa-solid fa-users"></i> Personen zuweisen</h3>
    <p style="color:var(--muted);margin-bottom:1rem">W√§hle die Team-Mitglieder aus, die dieses Lernmodul sehen sollen.</p>
    <div id="assignMembersList" style="max-height:400px;overflow-y:auto"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
      <button class="btn" onclick="closeAssignMembersModal()">Abbrechen</button>
      <button class="btn primary" onclick="saveAssignments()">
        <i class="fa-solid fa-save"></i> Speichern
      </button>
    </div>
  </div>
</div>

<script type="module">
  // ========================================
  // POCKETBASE & AUTH
  // ========================================
  const pb = new PocketBase('https://api.responda.systems');
  
  let currentUser = null;

  // ========================================
  // jsPDF f√ºr PDF-Export
  // ========================================
  const script = document.createElement('script');
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
  document.head.appendChild(script);

  // ========================================
  // STATE
  // ========================================
  let allCourses = [];
  let allSessions = [];
  let allMembers = [];
  let allAccess = [];
  let allModules = [];
  let currentSlides = [];
  let previewSlides = [];
  let currentPreviewIndex = 0;
  let currentTags = [];
  let selectedParticipants = [];
  let selectedParticipantStatus = {};
  let selectedAssignments = [];
  let currentEditCourse = null;
  let currentSessionCourse = null;
  let currentSessionId = null;
  let currentEditMember = null;
  let currentAccessMember = null;
  let currentEditModule = null;
  let currentLearningModule = null;
  let currentEditSlide = null;
  let previewAccessCode = '';
  let memberAccessCode = '';
  let slideContentEditor = null;
  let quizAnswers = [];
  let bulkAccessCount = 3;
  let pflichtSchulungen = 12;
  let currentViewCourseId = null;
  
  const wordLists = {
    adjectives: ['schnell', 'blau', 'gro√ü', 'klein', 'rot', 'gr√ºn', 'gelb', 'hell', 'dunkel', 'stark', 'schwach', 'frisch', 'alt', 'neu', 'warm', 'kalt', 's√º√ü', 'sauer', 'laut', 'leise'],
    nouns: ['apfel', 'baum', 'haus', 'tisch', 'stuhl', 'buch', 'auto', 'berg', 'fluss', 'stern', 'mond', 'sonne', 'blume', 'vogel', 'fisch', 'hund', 'katze', 'pferd', 'wind', 'meer'],
    verbs: ['laufen', 'springen', 'singen', 'tanzen', 'malen', 'lesen', 'schreiben', 'kochen', 'backen', 'spielen', 'denken', 'tr√§umen', 'lachen', 'weinen', 'fliegen', 'schwimmen', 'klettern', 'h√∂ren', 'sehen', 'f√ºhlen']
  };

  // ========================================
  // AUTH CHECK
  // ========================================
  async function checkAuth() {
    try {
      if (!pb.authStore.isValid || !pb.authStore.model) {
        console.log('‚ùå Keine g√ºltige Session');
        location.href = 'mpg-login.html';
        return false;
      }
      
      console.log('‚úÖ Auth Model:', pb.authStore.model);
      currentUser = pb.authStore.model;
      
      if (!currentUser.organization_id) {
        console.log('‚ùå User hat keine organization_id');
        pb.authStore.clear();
        location.href = 'mpg-login.html';
        return false;
      }
      
      const org = await pb.collection('organizations').getOne(currentUser.organization_id);
      pflichtSchulungen = org.pflicht_schulungen_jahr || 12;
      
      console.log('‚úÖ Auth erfolgreich:', currentUser.email);
      return true;
      
    } catch(e) {
      console.error('‚ùå Auth Fehler:', e);
      pb.authStore.clear();
      location.href = 'mpg-login.html';
      return false;
    }
  }

  document.getElementById("logout").onclick = () => {
    pb.authStore.clear();
    localStorage.clear();
    location.href = "/mpg-login.html";
  };

  // ========================================
  // HELPERS
  // ========================================
  function showMsg(text, type = 'success') {
    const msg = document.createElement('div');
    msg.className = 'msg ' + type;
    
    const icon = type === 'success' ? 'fa-check-circle' : 
                 type === 'error' ? 'fa-exclamation-circle' : 
                 'fa-info-circle';
    
    msg.innerHTML = `<i class="fas ${icon}"></i> ${text}`;
    document.body.appendChild(msg);
    
    setTimeout(() => msg.remove(), 5000);
  }

  function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('de-DE');
  }

  function formatTime(timeStr) {
    if (!timeStr) return '';
    return timeStr.slice(0, 5);
  }

  function copyToClipboard(text) {
    navigator.clipboard.writeText(text);
    showMsg('‚úÖ Kopiert!');
  }

  function generateAccessCode() {
    const adj = wordLists.adjectives[Math.floor(Math.random() * wordLists.adjectives.length)];
    const noun = wordLists.nouns[Math.floor(Math.random() * wordLists.nouns.length)];
    const verb = wordLists.verbs[Math.floor(Math.random() * wordLists.verbs.length)];
    return `${adj}.${noun}.${verb}`;
  }

  function generatePassword() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789';
    let password = '';
    for (let i = 0; i < 12; i++) {
      password += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return password;
  }

  window.generatePreviewCode = () => {
    previewAccessCode = generateAccessCode();
    document.getElementById('preview-code').textContent = previewAccessCode;
  };

  window.generateMemberAccessCode = () => {
    memberAccessCode = generateAccessCode();
    document.getElementById('member-access-code').textContent = memberAccessCode;
  };

  // ========================================
  // TAG INPUT SYSTEM
  // ========================================
  function initTagInput() {
    const wrapper = document.getElementById('tagInputWrapper');
    const input = document.getElementById('tagInput');
    
    if (!wrapper || !input) return;
    
    const newInput = input.cloneNode(true);
    input.parentNode.replaceChild(newInput, input);
    
    newInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const tag = newInput.value.trim();
        if (tag && !currentTags.includes(tag)) {
          currentTags.push(tag);
          renderTags();
          newInput.value = '';
        }
      } else if (e.key === 'Backspace' && newInput.value === '' && currentTags.length > 0) {
        currentTags.pop();
        renderTags();
      }
    });
  }

  function renderTags() {
    const wrapper = document.getElementById('tagInputWrapper');
    const input = document.getElementById('tagInput');
    
    if (!wrapper || !input) return;
    
    Array.from(wrapper.children).forEach(child => {
      if (child !== input) child.remove();
    });
    
    currentTags.forEach(tag => {
      const tagEl = document.createElement('span');
      tagEl.className = 'tag';
      tagEl.innerHTML = `${tag} <span class="remove-tag" onclick="removeTag('${tag.replace(/'/g, "\\'")}')">√ó</span>`;
      wrapper.insertBefore(tagEl, input);
    });
  }

  window.removeTag = (tag) => {
    currentTags = currentTags.filter(t => t !== tag);
    renderTags();
  };

  // ========================================
  // TAB SWITCHING
  // ========================================
  document.querySelectorAll('.tab').forEach(tab => {
    tab.onclick = () => {
      const targetTab = tab.dataset.tab;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = 'none');
      document.getElementById('tab-' + targetTab).style.display = 'block';
      
      if (targetTab === 'schulungen') loadCourses();
      if (targetTab === 'team') loadTeam();
      if (targetTab === 'lernbereich') loadLernbereich();
      if (targetTab === 'settings') loadSettings();
    };
  });

  // ========================================
  // PFLICHT-SCHULUNGEN EINSTELLUNGEN
  // ========================================
  async function loadSettings() {
    try {
      const org = await pb.collection('organizations').getOne(currentUser.organization_id);
      pflichtSchulungen = org.pflicht_schulungen_jahr || 12;
      document.getElementById('pflicht_schulungen').value = pflichtSchulungen;
      
      allAccess = await pb.collection('training_students').getFullList({
        filter: `organization_id = "${currentUser.organization_id}"`,
        sort: 'name',
        expand: 'member_id'
      });
      
      renderSettings();
    } catch(e) {
      console.error('Error:', e);
      document.getElementById('access-list').innerHTML = `<div class="empty" style="background:#fff;border-radius:.75rem"><i class="fas fa-exclamation-triangle"></i><div style="color:#c00">Fehler: ${e.message}</div></div>`;
    }
  }

  document.getElementById('pflichtForm').onsubmit = async (e) => {
    e.preventDefault();
    
    try {
      const value = parseInt(document.getElementById('pflicht_schulungen').value) || 12;
      
      await pb.collection('organizations').update(currentUser.organization_id, {
        pflicht_schulungen_jahr: value
      });
      
      pflichtSchulungen = value;
      showMsg('‚úÖ Pflicht-Schulungen gespeichert!');
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };
  // ========================================
  // AUSBILDUNGEN (OHNE TYP!)
  // ========================================
  async function loadCourses() {
    try {
      allCourses = await pb.collection('training_courses').getFullList({
        filter: `organization_id = "${currentUser.organization_id}"`,
        sort: '-created'
      });
      
      allSessions = await pb.collection('training_sessions').getFullList({
        filter: `organization_id = "${currentUser.organization_id}"`,
        sort: '-date'
      });
      
      renderCourses();
    } catch(e) {
      console.error('Error:', e);
      document.getElementById('schulungen-list').innerHTML = `<div class="empty" style="background:#fff;border-radius:.75rem"><i class="fas fa-exclamation-triangle"></i><div style="color:#c00">Fehler: ${e.message}</div></div>`;
    }
  }

  function renderCourses() {
    const list = document.getElementById('schulungen-list');
    
    if (allCourses.length === 0) {
      list.innerHTML = '<div class="empty" style="background:#fff;border-radius:.75rem"><i class="fas fa-book"></i><div>Noch keine Schulungen</div></div>';
      return;
    }
    
    list.innerHTML = allCourses.map(course => {
      const courseSessions = allSessions.filter(s => s.course_id === course.id);
      const nextSession = courseSessions.find(s => new Date(s.date) >= new Date());
      
      return `
        <div class="course-card" onclick="viewSchulungDetails('${course.id}')">
          <div class="card-title"><i class="fa-solid fa-book-medical"></i> ${course.title}</div>
          
          ${course.description ? `
            <div style="margin:8px 0;color:var(--muted);font-size:.9rem;line-height:1.5">${course.description}</div>
          ` : ''}
          
          <div style="margin-top:8px;color:var(--muted);font-size:.85rem">
            <i class="fa-solid fa-calendar"></i> ${courseSessions.length} Termin(e)
            ${nextSession ? ` ‚Ä¢ N√§chster: ${formatDate(nextSession.date)}` : ''}
          </div>
          
          ${nextSession && nextSession.dozent ? `
            <div style="margin-top:6px;padding:6px 10px;background:#f0fdf4;border-radius:6px;font-size:0.85rem;color:#16a34a">
              üë§ ${nextSession.dozent}
            </div>
          ` : ''}
        </div>
      `;
    }).join('');
  }

  window.openSchulungModal = () => {
    currentEditCourse = null;
    const form = document.getElementById('schulungForm');
    form.reset();
    selectedParticipants = [];
    selectedParticipantStatus = {};
    document.getElementById('selected-count').textContent = '0';
    document.getElementById('schulungModalTitle').innerHTML = '<i class="fa-solid fa-book-medical"></i> Neue Schulung erstellen';
    document.getElementById('schulungModal').classList.add('show');
  };

  window.closeSchulungModal = () => {
    document.getElementById('schulungModal').classList.remove('show');
  };

  document.getElementById('schulungForm').onsubmit = async (e) => {
    e.preventDefault();
    
    try {
      const formData = new FormData(e.target);
      
      // 1. Schulung erstellen (OHNE type!)
      const course = await pb.collection('training_courses').create({
        title: formData.get('title').trim(),
        description: formData.get('description').trim(),
        organization_id: currentUser.organization_id
      });
      
      // 2. Ersten Termin erstellen
      const session = await pb.collection('training_sessions').create({
        course_id: course.id,
        date: formData.get('date'),
        start_time: formData.get('start_time'),
        end_time: formData.get('end_time'),
        location: formData.get('location').trim(),
        dozent: formData.get('instructor').trim(),
        beschreibung: '',
        status: 'geplant',
        invitations_sent: selectedParticipants.length > 0,
        organization_id: currentUser.organization_id
      });
      
      // 3. Teilnehmer hinzuf√ºgen mit Status "eingeladen"
      for (const memberId of selectedParticipants) {
        await pb.collection('schulung_teilnahme').create({
          session_id: session.id,
          member_id: memberId,
          status: 'eingeladen',
          anwesend: false,
          organization_id: currentUser.organization_id
        });
      }
      
      showMsg('‚úÖ Schulung mit Termin erstellt!');
      closeSchulungModal();
      await loadCourses();
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.openParticipantSelector = async () => {
    try {
      allMembers = await pb.collection('team_members').getFullList({
        filter: `organization_id = "${currentUser.organization_id}" && aktiv = true`,
        sort: 'name'
      });
      
      const list = document.getElementById('participantList');
      list.innerHTML = allMembers.map(member => {
        const isSelected = selectedParticipants.includes(member.id);
        
        return `
          <div style="padding:.75rem;border-bottom:1px solid var(--border)">
            <label style="display:flex;align-items:center;gap:.75rem;cursor:pointer">
              <input type="checkbox" ${isSelected ? 'checked' : ''} 
                onchange="toggleParticipant('${member.id}')">
              <div style="flex:1">
                <div style="font-weight:700">${member.vorname} ${member.name}</div>
                <div style="font-size:.85rem;color:var(--muted)">${(member.qualifikationen || []).join(', ')}</div>
              </div>
            </label>
          </div>
        `;
      }).join('');
      
      document.getElementById('participantModal').classList.add('show');
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.closeParticipantModal = () => {
    document.getElementById('participantModal').classList.remove('show');
    document.getElementById('selected-count').textContent = selectedParticipants.length;
  };

  window.toggleParticipant = (memberId) => {
    const idx = selectedParticipants.indexOf(memberId);
    if (idx >= 0) {
      selectedParticipants.splice(idx, 1);
    } else {
      selectedParticipants.push(memberId);
    }
    openParticipantSelector();
  };

  // ========================================
  // SCHULUNGS-DETAILS MIT ALLEN TERMINEN
  // ========================================
  window.viewSchulungDetails = async (courseId) => {
    try {
      currentViewCourseId = courseId;
      const course = allCourses.find(c => c.id === courseId);
      if (!course) return;
      
      const sessions = allSessions.filter(s => s.course_id === courseId);
      
      document.getElementById('schulungDetailsTitle').innerHTML = 
        `<i class="fa-solid fa-book-medical"></i> ${course.title}`;
      
      let html = `
        <div class="details-section">
          <h4><i class="fa-solid fa-info-circle"></i> Informationen</h4>
          <div style="display:grid;grid-template-columns:150px 1fr;gap:12px;align-items:start">
            <div style="font-weight:700;color:#6b7280">Titel:</div>
            <div style="font-weight:700;font-size:1.1rem">${course.title}</div>
            
            ${course.description ? `
            <div style="font-weight:700;color:#6b7280">Beschreibung:</div>
            <div style="line-height:1.6">${course.description}</div>
            ` : ''}
            
            <div style="font-weight:700;color:#6b7280">Erstellt:</div>
            <div>${formatDate(course.created)}</div>
            
            <div style="font-weight:700;color:#6b7280">Termine:</div>
            <div><span class="badge info">${sessions.length} Termin(e)</span></div>
          </div>
        </div>
        
        <div class="details-section">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
            <h4 style="margin:0"><i class="fa-solid fa-calendar"></i> Termine (${sessions.length})</h4>
            <button class="btn btn-sm primary" onclick="openAddSessionModal('${courseId}')">
              <i class="fas fa-plus"></i> Weiteren Termin hinzuf√ºgen
            </button>
          </div>
      `;
      
      if (sessions.length > 0) {
        sessions.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        sessions.forEach(s => {
          const isPast = new Date(s.date) < new Date();
          const isAbgesagt = s.status === 'abgesagt';
          
          html += `
            <div class="slide-item" style="cursor:pointer;border-left-color:${isAbgesagt ? '#991b1b' : isPast ? '#94a3b8' : 'var(--primary)'}">
              <div style="display:flex;align-items:center;flex:1;gap:1rem">
                <div style="flex:1">
                  <div style="font-weight:700;display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                    ${formatDate(s.date)}
                    ${s.start_time ? `<span style="color:var(--muted);font-weight:400">‚Ä¢ ${formatTime(s.start_time)} - ${formatTime(s.end_time)}</span>` : ''}
                    ${isAbgesagt ? '<span class="badge abgesagt">Abgesagt</span>' : 
                      isPast ? '<span class="badge" style="background:#f3f4f6;color:#6b7280">Vergangen</span>' : 
                      '<span class="badge geplant">Geplant</span>'}
                  </div>
                  <div style="font-size:0.85rem;color:var(--muted);margin-top:4px">
                    ${s.location ? `üìç ${s.location}` : 'üìç Kein Ort'}
                    ${s.dozent ? ` ‚Ä¢ üë§ ${s.dozent}` : ''}
                  </div>
                  ${s.beschreibung ? `
                    <div style="font-size:0.85rem;color:var(--muted);margin-top:4px;font-style:italic">
                      "${s.beschreibung}"
                    </div>
                  ` : ''}
                </div>
              </div>
              <div style="display:flex;gap:4px;flex-wrap:wrap">
                <button class="btn btn-sm primary" onclick="event.stopPropagation(); viewSessionDetails('${s.id}')">
                  <i class="fas fa-eye"></i> Details
                </button>
                <button class="btn btn-sm" onclick="event.stopPropagation(); openEditSessionModal('${s.id}')">
                  <i class="fas fa-edit"></i>
                </button>
                ${isAbgesagt ? `
                  <button class="btn btn-sm success" onclick="event.stopPropagation(); reactivateSession('${s.id}')">
                    <i class="fas fa-check"></i> Reaktivieren
                  </button>
                ` : `
                  <button class="btn btn-sm warning" onclick="event.stopPropagation(); cancelSession('${s.id}')">
                    <i class="fas fa-ban"></i> Absagen
                  </button>
                `}
                <button class="btn btn-sm" style="background:#dc2626;color:#fff" onclick="event.stopPropagation(); deleteSession('${s.id}')">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          `;
        });
      } else {
        html += `
          <div style="padding:32px;text-align:center;background:#f9fafb;border-radius:8px;color:var(--muted)">
            <i class="fas fa-calendar" style="font-size:3rem;opacity:0.3;margin-bottom:1rem"></i>
            <div style="font-weight:700">Noch keine Termine</div>
            <div style="font-size:0.85rem;margin-top:4px">F√ºge den ersten Termin √ºber den Button oben hinzu</div>
          </div>
        `;
      }
      
      html += `
        </div>
        
        <div style="margin-top:20px;padding-top:16px;border-top:2px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
          <button class="btn" style="background:#dc2626;color:#fff;border-color:#dc2626" onclick="confirmDeleteSchul()">
            <i class="fa-solid fa-trash"></i> Schulung l√∂schen
          </button>
          <button class="btn primary" onclick="closeSchulungDetailsModal()">
            <i class="fas fa-times"></i> Schlie√üen
          </button>
        </div>
      `;
      
      document.getElementById('schulungDetailsBody').innerHTML = html;
      document.getElementById('schulungDetailsModal').classList.add('show');
      
    } catch(e) {
      console.error('Details-Fehler:', e);
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.closeSchulungDetailsModal = () => {
    document.getElementById('schulungDetailsModal').classList.remove('show');
    currentViewCourseId = null;
  };

  window.confirmDeleteSchul = async () => {
    if (!currentViewCourseId) return;
    
    const course = allCourses.find(c => c.id === currentViewCourseId);
    if (!course) return;
    
    if (confirm(`Schulung "${course.title}" wirklich l√∂schen?\n\nAlle Termine und Teilnehmer werden ebenfalls gel√∂scht!`)) {
      try {
        const sessions = allSessions.filter(s => s.course_id === currentViewCourseId);
        
        for (const session of sessions) {
          const participants = await pb.collection('schulung_teilnahme').getFullList({
            filter: `session_id = "${session.id}"`
          });
          for (const p of participants) {
            await pb.collection('schulung_teilnahme').delete(p.id);
          }
          await pb.collection('training_sessions').delete(session.id);
        }
        
        await pb.collection('training_courses').delete(currentViewCourseId);
        
        showMsg('‚úÖ Schulung gel√∂scht!');
        closeSchulungDetailsModal();
        await loadCourses();
        
      } catch(e) {
        showMsg('Fehler: ' + e.message, 'error');
      }
    }
  };

  // ========================================
  // WEITEREN TERMIN HINZUF√úGEN
  // ========================================
  window.openAddSessionModal = (courseId) => {
    document.getElementById('add-session-course-id').value = courseId;
    document.getElementById('addSessionForm').reset();
    selectedParticipants = [];
    selectedParticipantStatus = {};
    document.getElementById('add-selected-count').textContent = '0';
    document.getElementById('addSessionModal').classList.add('show');
  };

  window.closeAddSessionModal = () => {
    document.getElementById('addSessionModal').classList.remove('show');
  };

  window.openParticipantSelectorForAdd = () => {
    openParticipantSelector();
    const oldClose = window.closeParticipantModal;
    window.closeParticipantModal = () => {
      document.getElementById('participantModal').classList.remove('show');
      document.getElementById('add-selected-count').textContent = selectedParticipants.length;
      window.closeParticipantModal = oldClose;
    };
  };

  document.getElementById('addSessionForm').onsubmit = async (e) => {
    e.preventDefault();
    
    try {
      const formData = new FormData(e.target);
      const courseId = document.getElementById('add-session-course-id').value;
      
      const session = await pb.collection('training_sessions').create({
        course_id: courseId,
        date: formData.get('date'),
        start_time: formData.get('start_time'),
        end_time: formData.get('end_time'),
        location: formData.get('location').trim(),
        dozent: formData.get('dozent').trim(),
        beschreibung: formData.get('beschreibung').trim(),
        status: 'geplant',
        invitations_sent: selectedParticipants.length > 0,
        organization_id: currentUser.organization_id
      });
      
      for (const memberId of selectedParticipants) {
        await pb.collection('schulung_teilnahme').create({
          session_id: session.id,
          member_id: memberId,
          status: 'eingeladen',
          anwesend: false,
          organization_id: currentUser.organization_id
        });
      }
      
      showMsg('‚úÖ Termin hinzugef√ºgt!');
      closeAddSessionModal();
      await loadCourses();
      await viewSchulungDetails(courseId);
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  // ========================================
  // TERMIN BEARBEITEN
  // ========================================
  window.openEditSessionModal = async (sessionId) => {
    try {
      const session = await pb.collection('training_sessions').getOne(sessionId);
      
      document.getElementById('edit-session-id').value = sessionId;
      document.getElementById('edit-session-date').value = session.date;
      document.getElementById('edit-session-start').value = session.start_time || '';
      document.getElementById('edit-session-end').value = session.end_time || '';
      document.getElementById('edit-session-location').value = session.location || '';
      document.getElementById('edit-session-dozent').value = session.dozent || '';
      document.getElementById('edit-session-beschreibung').value = session.beschreibung || '';
      
      document.getElementById('editSessionModal').classList.add('show');
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.closeEditSessionModal = () => {
    document.getElementById('editSessionModal').classList.remove('show');
  };

  document.getElementById('editSessionForm').onsubmit = async (e) => {
    e.preventDefault();
    
    try {
      const sessionId = document.getElementById('edit-session-id').value;
      const formData = new FormData(e.target);
      
      await pb.collection('training_sessions').update(sessionId, {
        date: formData.get('date'),
        start_time: formData.get('start_time'),
        end_time: formData.get('end_time'),
        location: formData.get('location').trim(),
        dozent: formData.get('dozent').trim(),
        beschreibung: formData.get('beschreibung').trim()
      });
      
      showMsg('‚úÖ Termin aktualisiert!');
      closeEditSessionModal();
      await loadCourses();
      
      if (currentViewCourseId) {
        await viewSchulungDetails(currentViewCourseId);
      }
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  // ========================================
  // TERMIN ABSAGEN / REAKTIVIEREN / L√ñSCHEN
  // ========================================
  window.cancelSession = async (sessionId) => {
    if (!confirm('Termin wirklich absagen?')) return;
    
    try {
      await pb.collection('training_sessions').update(sessionId, {
        status: 'abgesagt'
      });
      
      showMsg('‚úÖ Termin abgesagt!');
      await loadCourses();
      
      if (currentViewCourseId) {
        await viewSchulungDetails(currentViewCourseId);
      }
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.reactivateSession = async (sessionId) => {
    try {
      await pb.collection('training_sessions').update(sessionId, {
        status: 'geplant'
      });
      
      showMsg('‚úÖ Termin reaktiviert!');
      await loadCourses();
      
      if (currentViewCourseId) {
        await viewSchulungDetails(currentViewCourseId);
      }
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.deleteSession = async (sessionId) => {
    if (!confirm('Termin wirklich l√∂schen?\n\nAlle Teilnehmer werden ebenfalls gel√∂scht!')) return;
    
    try {
      const participants = await pb.collection('schulung_teilnahme').getFullList({
        filter: `session_id = "${sessionId}"`
      });
      
      for (const p of participants) {
        await pb.collection('schulung_teilnahme').delete(p.id);
      }
      
      await pb.collection('training_sessions').delete(sessionId);
      
      showMsg('‚úÖ Termin gel√∂scht!');
      await loadCourses();
      
      if (currentViewCourseId) {
        await viewSchulungDetails(currentViewCourseId);
      }
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  // ========================================
  // TERMIN-DETAILS MIT STATISTIK
  // ========================================
  window.viewSessionDetails = async (sessionId) => {
    try {
      currentSessionId = sessionId;
      const session = await pb.collection('training_sessions').getOne(sessionId);
      const course = allCourses.find(c => c.id === session.course_id);
      const participants = await pb.collection('schulung_teilnahme').getFullList({
        filter: `session_id = "${sessionId}"`,
        expand: 'member_id'
      });
      
      document.getElementById('sessionDetailsTitle').textContent = 
        `${course ? course.title : 'Termin'} ‚Ä¢ ${formatDate(session.date)}`;
      
      const inviteLink = `${window.location.origin}/ausbildungen-invite.html?session=${sessionId}`;
      
      const eingeladen = participants.length;
      const zugesagt = participants.filter(p => p.status === 'zugesagt').length;
      const abgesagt = participants.filter(p => p.status === 'abgesagt').length;
      const offen = participants.filter(p => p.status === 'eingeladen').length;
      const anwesend = participants.filter(p => p.anwesend).length;
      const abwesend = participants.filter(p => !p.anwesend && p.status !== 'abgesagt').length;
      
      let html = `
        <div class="details-section">
          <h4><i class="fa-solid fa-info-circle"></i> Termin-Informationen</h4>
          <div style="display:grid;grid-template-columns:150px 1fr;gap:8px">
            <div style="font-weight:700;color:#6b7280">Datum:</div>
            <div>${formatDate(session.date)} ${session.start_time ? `‚Ä¢ ${formatTime(session.start_time)} - ${formatTime(session.end_time)}` : ''}</div>
            
            <div style="font-weight:700;color:#6b7280">Ort:</div>
            <div>${session.location || '-'}</div>
            
            ${session.dozent ? `
            <div style="font-weight:700;color:#6b7280">Dozent:</div>
            <div>${session.dozent}</div>
            ` : ''}
            
            ${session.beschreibung ? `
            <div style="font-weight:700;color:#6b7280">Beschreibung:</div>
            <div>${session.beschreibung}</div>
            ` : ''}
          </div>
        </div>
        
        <div class="details-section">
          <h4><i class="fa-solid fa-link"></i> Einladungslink</h4>
          <div style="margin-bottom:1rem">
            <div class="copy-box">
              <span style="flex:1;overflow:hidden;text-overflow:ellipsis;font-size:.85rem">${inviteLink}</span>
              <button class="btn btn-sm" onclick="copyToClipboard('${inviteLink}')">
                <i class="fas fa-copy"></i>
              </button>
            </div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn btn-sm success" onclick="shareWhatsApp('${inviteLink}')">
              <i class="fab fa-whatsapp"></i> WhatsApp
            </button>
            <button class="btn btn-sm info" onclick="shareEmail('${inviteLink}', '${course ? course.title : 'Schulung'}', '${formatDate(session.date)}')">
              <i class="fas fa-envelope"></i> E-Mail
            </button>
          </div>
        </div>
        
        <div class="details-section">
          <h4><i class="fa-solid fa-chart-pie"></i> Statistik</h4>
          
          <div style="margin-bottom:1rem">
            <div style="font-size:.85rem;font-weight:700;color:#6b7280;margin-bottom:.5rem">R√úCKMELDUNGEN</div>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px">
              <div style="text-align:center;padding:12px;background:#e0e7ff;border-radius:8px">
                <div style="font-size:1.5rem;font-weight:800;color:#4338ca">${eingeladen}</div>
                <div style="font-size:0.85rem;color:#4338ca">Eingeladen</div>
              </div>
              <div style="text-align:center;padding:12px;background:#dcfce7;border-radius:8px">
                <div style="font-size:1.5rem;font-weight:800;color:#065f46">${zugesagt}</div>
                <div style="font-size:0.85rem;color:#065f46">Zugesagt</div>
              </div>
              <div style="text-align:center;padding:12px;background:#fee2e2;border-radius:8px">
                <div style="font-size:1.5rem;font-weight:800;color:#991b1b">${abgesagt}</div>
                <div style="font-size:0.85rem;color:#991b1b">Abgesagt</div>
              </div>
              <div style="text-align:center;padding:12px;background:#fef3c7;border-radius:8px">
                <div style="font-size:1.5rem;font-weight:800;color:#92400e">${offen}</div>
                <div style="font-size:0.85rem;color:#92400e">Offen</div>
              </div>
            </div>
          </div>
          
          <div>
            <div style="font-size:.85rem;font-weight:700;color:#6b7280;margin-bottom:.5rem">ANWESENHEIT</div>
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px">
              <div style="text-align:center;padding:12px;background:#f0fdf4;border-radius:8px">
                <div style="font-size:1.5rem;font-weight:800;color:#16a34a">${anwesend}</div>
                <div style="font-size:0.85rem;color:#16a34a">Anwesend</div>
              </div>
              <div style="text-align:center;padding:12px;background:#fef3c7;border-radius:8px">
                <div style="font-size:1.5rem;font-weight:800;color:#92400e">${abwesend}</div>
                <div style="font-size:0.85rem;color:#92400e">Nicht anwesend</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="details-section">
          <h4><i class="fa-solid fa-users"></i> Teilnehmer-Liste (${participants.length})</h4>
      `;
      
      if (participants.length > 0) {
        html += `
          <table class="table" style="margin-top:1rem">
            <thead>
              <tr>
                <th>#</th>
                <th>Name</th>
                <th>R√ºckmeldung</th>
                <th style="text-align:center">Anwesend</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        participants.forEach((p, idx) => {
          const member = p.expand?.member_id;
          let statusBadge = '';
          
          if (p.status === 'zugesagt') {
            statusBadge = '<span class="badge zugesagt">‚úÖ Zugesagt</span>';
          } else if (p.status === 'abgesagt') {
            statusBadge = '<span class="badge abgesagt">‚ùå Abgesagt</span>';
          } else {
            statusBadge = '<span class="badge eingeladen">‚è≥ Offen</span>';
          }
          
          html += `
            <tr>
              <td>${idx + 1}</td>
              <td style="font-weight:700">${member ? `${member.vorname} ${member.name}` : 'Unbekannt'}</td>
              <td>${statusBadge}</td>
              <td style="text-align:center">
                ${p.status === 'abgesagt' ? 
                  '<span style="color:var(--muted)">-</span>' :
                  `<input 
                    type="checkbox" 
                    data-participant-id="${p.id}"
                    ${p.anwesend ? 'checked' : ''}
                    style="width:20px;height:20px;cursor:pointer"
                  >`
                }
              </td>
            </tr>
          `;
        });
        
        html += '</tbody></table>';
      } else {
        html += '<p style="color:#999;padding:16px;text-align:center">Keine Teilnehmer</p>';
      }
      
      html += '</div>';
      
      document.getElementById('sessionDetailsBody').innerHTML = html;
      document.getElementById('sessionDetailsModal').classList.add('show');
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.closeSessionDetailsModal = () => {
    document.getElementById('sessionDetailsModal').classList.remove('show');
    currentSessionId = null;
  };

  window.saveAttendance = async () => {
    try {
      if (!currentSessionId) return;
      
      const checkboxes = document.querySelectorAll('[data-participant-id]');
      
      for (const checkbox of checkboxes) {
        const participantId = checkbox.dataset.participantId;
        const anwesend = checkbox.checked;
        
        await pb.collection('schulung_teilnahme').update(participantId, {
          anwesend
        });
      }
      
      showMsg('‚úÖ Anwesenheit gespeichert!');
      await viewSessionDetails(currentSessionId);
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.shareWhatsApp = (link) => {
    const text = encodeURIComponent(`Hallo! Hier ist der Einladungslink zur Schulung: ${link}`);
    window.open(`https://wa.me/?text=${text}`, '_blank');
  };

  window.shareEmail = (link, title, date) => {
    const subject = encodeURIComponent(`Einladung: ${title} am ${date}`);
    const body = encodeURIComponent(`Hallo,\n\nhiermit lade ich dich zur Schulung ein:\n\n${title}\nDatum: ${date}\n\nBitte best√§tige deine Teilnahme √ºber diesen Link:\n${link}\n\nViele Gr√º√üe`);
    window.location.href = `mailto:?subject=${subject}&body=${body}`;
  };
  // ========================================
  // TEAM-MANAGEMENT MIT PFLICHT-SCHULUNGEN
  // ========================================
  async function loadTeam() {
    try {
      allMembers = await pb.collection('team_members').getFullList({
        filter: `organization_id = "${currentUser.organization_id}" && aktiv = true`,
        sort: 'name'
      });
      
      allAccess = await pb.collection('training_students').getFullList({
        filter: `organization_id = "${currentUser.organization_id}"`,
        sort: 'name',
        expand: 'member_id'
      });
      
      renderTeam();
    } catch(e) {
      console.error('Error:', e);
      document.getElementById('team-list').innerHTML = `<div class="empty" style="background:#fff;border-radius:.75rem"><i class="fas fa-exclamation-triangle"></i><div style="color:#c00">Fehler: ${e.message}</div></div>`;
    }
  }

  function renderTeam() {
    const list = document.getElementById('team-list');
    
    if (allMembers.length === 0) {
      list.innerHTML = '<div class="empty" style="background:#fff;border-radius:.75rem"><i class="fas fa-users"></i><div>Noch keine Team-Mitglieder</div></div>';
      return;
    }
    
    list.innerHTML = allMembers.map(member => {
      const tags = member.qualifikationen || [];
      const tagsHTML = tags.map(t => `<span class="tag">${t}</span>`).join('');
      const access = allAccess.find(a => a.member_id === member.id);
      
      return `
        <div class="member-card" onclick="viewMemberDetails('${member.id}')">
          <div class="card-title"><i class="fa-solid fa-user"></i> ${member.vorname} ${member.name}</div>
          <div style="margin-bottom:8px">
            ${tagsHTML || '<span class="tag" style="background:#eee;color:#999">Keine Qualifikationen</span>'}
          </div>
          ${access ? `
            <div style="margin-top:8px;padding:6px;background:#f0fdf4;border-radius:6px;font-size:0.85rem">
              <i class="fa-solid fa-check-circle" style="color:#16a34a"></i> Zugang: <strong>${access.access_code}</strong>
            </div>
          ` : `
            <div style="margin-top:8px;padding:6px;background:#fef3c7;border-radius:6px;font-size:0.85rem">
              <i class="fa-solid fa-lock"></i> Kein Zugang
            </div>
          `}
        </div>
      `;
    }).join('');
  }

  window.openMemberModal = (memberId = null) => {
    currentEditMember = memberId;
    const form = document.getElementById('memberForm');
    form.reset();
    currentTags = [];
    
    if (memberId) {
      const member = allMembers.find(m => m.id === memberId);
      if (member) {
        document.getElementById('memberModalTitle').innerHTML = '<i class="fa-solid fa-user-edit"></i> Mitglied bearbeiten';
        form.name.value = member.name || '';
        form.vorname.value = member.vorname || '';
        currentTags = [...(member.qualifikationen || [])];
      }
    } else {
      document.getElementById('memberModalTitle').innerHTML = '<i class="fa-solid fa-user-plus"></i> Neues Team-Mitglied';
    }
    
    document.getElementById('memberModal').classList.add('show');
    setTimeout(() => {
      initTagInput();
      renderTags();
    }, 100);
  };

  window.closeMemberModal = () => {
    document.getElementById('memberModal').classList.remove('show');
    currentEditMember = null;
    currentTags = [];
  };

  document.getElementById('memberForm').onsubmit = async (e) => {
    e.preventDefault();
    
    try {
      const formData = new FormData(e.target);
      const data = {
        name: formData.get('name').trim(),
        vorname: formData.get('vorname').trim(),
        qualifikationen: currentTags,
        aktiv: true,
        organization_id: currentUser.organization_id
      };
      
      if (currentEditMember) {
        await pb.collection('team_members').update(currentEditMember, data);
        showMsg('‚úÖ Mitglied aktualisiert!');
      } else {
        await pb.collection('team_members').create(data);
        showMsg('‚úÖ Mitglied erstellt!');
      }
      
      closeMemberModal();
      await loadTeam();
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.viewMemberDetails = async (memberId) => {
    try {
      const member = await pb.collection('team_members').getOne(memberId);
      const participations = await pb.collection('schulung_teilnahme').getFullList({
        filter: `member_id = "${memberId}"`,
        expand: 'session_id',
        sort: '-created'
      });
      
      const access = allAccess.find(a => a.member_id === memberId);
      const tags = member.qualifikationen || [];
      const tagsHTML = tags.map(t => `<span class="tag">${t}</span>`).join('') || 
        '<span class="tag" style="background:#eee;color:#999">Keine Qualifikationen</span>';
      
      document.getElementById('memberDetailsTitle').innerHTML = 
        `<i class="fa-solid fa-user"></i> ${member.vorname} ${member.name}`;
      
      const currentYear = new Date().getFullYear();
      const thisYearParticipations = participations.filter(p => {
        const session = p.expand?.session_id;
        return session && new Date(session.date).getFullYear() === currentYear && p.anwesend;
      });
      const completedThisYear = thisYearParticipations.length;
      const percentComplete = Math.round((completedThisYear / pflichtSchulungen) * 100);
      
      let html = `
        <div class="details-section">
          <h4><i class="fa-solid fa-id-badge"></i> Informationen</h4>
          <div style="display:grid;grid-template-columns:150px 1fr;gap:8px">
            <div style="font-weight:700;color:#6b7280">Qualifikationen:</div>
            <div>${tagsHTML}</div>
          </div>
        </div>
        
        <div class="details-section" style="background:${percentComplete >= 100 ? '#f0fdf4' : '#fef3c7'}">
          <h4><i class="fa-solid fa-graduation-cap"></i> Pflicht-Schulungen ${currentYear}</h4>
          <div style="display:flex;align-items:center;gap:1rem;margin-bottom:.5rem">
            <div style="font-size:2rem;font-weight:800;color:${percentComplete >= 100 ? '#16a34a' : '#f59e0b'}">
              ${completedThisYear} / ${pflichtSchulungen}
            </div>
            <div style="flex:1">
              <div class="progress-bar" style="height:12px">
                <div class="progress-bar-fill" style="width:${Math.min(percentComplete, 100)}%;background:${percentComplete >= 100 ? '#16a34a' : '#f59e0b'}"></div>
              </div>
              <div style="font-size:.85rem;color:var(--muted);margin-top:4px">
                ${percentComplete}% abgeschlossen
                ${completedThisYear < pflichtSchulungen ? ` ‚Ä¢ Noch ${pflichtSchulungen - completedThisYear} ben√∂tigt` : ' ‚Ä¢ ‚úì Ziel erreicht!'}
              </div>
            </div>
          </div>
        </div>
        
        <div class="details-section">
          <h4><i class="fa-solid fa-key"></i> Externer Zugang</h4>
      `;
      
      if (access) {
        html += `
          <div style="background:#f0fdf4;padding:1rem;border-radius:.5rem;border:1px solid #86efac">
            <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem">
              <i class="fa-solid fa-check-circle" style="color:#16a34a;font-size:1.2rem"></i>
              <strong style="color:#16a34a">Zugang aktiv</strong>
            </div>
            <div class="copy-box" style="margin-top:.5rem">
              <span style="font-weight:700;color:var(--primary);font-size:1.1rem">${access.access_code}</span>
              <button class="btn btn-sm" onclick="copyToClipboard('${access.access_code}')">
                <i class="fas fa-copy"></i>
              </button>
            </div>
            <div style="margin-top:.5rem;font-size:.85rem;color:var(--muted)">
              Login: ausbildungen-public.html mit diesem Code
            </div>
          </div>
          <div style="margin-top:.5rem;display:flex;gap:.5rem">
            <button class="btn btn-sm success" onclick="exportAccessPDF('${access.id}')">
              <i class="fas fa-file-pdf"></i> PDF erstellen
            </button>
            <button class="btn btn-sm" onclick="deleteAccessForMember('${access.id}')">
              <i class="fas fa-trash"></i> Zugang entfernen
            </button>
          </div>
        `;
      } else {
        html += `
          <div style="background:#fef3c7;padding:1rem;border-radius:.5rem;border:1px solid #fde047">
            <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem">
              <i class="fa-solid fa-lock" style="color:#f59e0b;font-size:1.2rem"></i>
              <strong style="color:#f59e0b">Kein Zugang vorhanden</strong>
            </div>
            <p style="margin:.5rem 0;font-size:.85rem;color:var(--muted)">
              Erstelle einen 3-Wort-Code, damit sich diese Person extern anmelden kann.
            </p>
          </div>
          <div style="margin-top:.5rem">
            <button class="btn btn-sm primary" onclick="openCreateAccessForMember('${memberId}')">
              <i class="fas fa-key"></i> Zugang erstellen
            </button>
          </div>
        `;
      }
      
      html += `</div>
        <div class="details-section">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
            <h4 style="margin:0"><i class="fa-solid fa-clock-rotate-left"></i> Teilnahmehistorie (${participations.length})</h4>
            <button class="btn btn-sm success" onclick="exportMemberPDF('${memberId}')">
              <i class="fas fa-file-pdf"></i> PDF Export
            </button>
          </div>
      `;
      
      if (participations.length > 0) {
        const zugesagt = participations.filter(p => p.status === 'zugesagt').length;
        const abgesagt = participations.filter(p => p.status === 'abgesagt').length;
        const anwesend = participations.filter(p => p.anwesend).length;
        const abwesend = participations.filter(p => !p.anwesend && p.status !== 'abgesagt').length;
        
        html += `
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:1rem">
            <div style="text-align:center;padding:12px;background:#dcfce7;border-radius:8px">
              <div style="font-size:1.5rem;font-weight:800;color:#065f46">${zugesagt}</div>
              <div style="font-size:0.85rem;color:#065f46">Zugesagt</div>
            </div>
            <div style="text-align:center;padding:12px;background:#fee2e2;border-radius:8px">
              <div style="font-size:1.5rem;font-weight:800;color:#991b1b">${abgesagt}</div>
              <div style="font-size:0.85rem;color:#991b1b">Abgesagt</div>
            </div>
            <div style="text-align:center;padding:12px;background:#f0fdf4;border-radius:8px">
              <div style="font-size:1.5rem;font-weight:800;color:#16a34a">${anwesend}</div>
              <div style="font-size:0.85rem;color:#16a34a">Anwesend</div>
            </div>
            <div style="text-align:center;padding:12px;background:#fef3c7;border-radius:8px">
              <div style="font-size:1.5rem;font-weight:800;color:#92400e">${abwesend}</div>
              <div style="font-size:0.85rem;color:#92400e">Offen</div>
            </div>
          </div>
          
          <table class="table">
            <thead>
              <tr>
                <th>Datum</th>
                <th>Kurs</th>
                <th>R√ºckmeldung</th>
                <th>Anwesenheit</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        participations.forEach(p => {
          const session = p.expand?.session_id;
          const course = session ? allCourses.find(c => c.id === session.course_id) : null;
          
          html += `
            <tr>
              <td>${session ? formatDate(session.date) : '-'}</td>
              <td style="font-weight:700">${course ? course.title : 'Unbekannt'}</td>
              <td>
                <span class="badge ${p.status}">${
                  p.status === 'zugesagt' ? '‚úÖ Zugesagt' : 
                  p.status === 'abgesagt' ? '‚ùå Abgesagt' : '‚è≥ Eingeladen'
                }</span>
              </td>
              <td>
                <span class="badge ${p.anwesend ? 'anwesend' : 'abwesend'}">
                  ${p.anwesend ? '‚úÖ Anwesend' : (p.status === 'abgesagt' ? '‚ùå Abgesagt' : '‚ùå Abwesend')}
                </span>
              </td>
            </tr>
          `;
        });
        
        html += '</tbody></table>';
      } else {
        html += '<p style="color:#999;padding:16px;text-align:center">Noch keine Teilnahmen</p>';
      }
      
      html += `
        </div>
        
        <div style="margin-top:16px;display:flex;gap:8px">
          <button class="btn primary" onclick="closeMemberDetailsModal();openMemberModal('${memberId}')">
            <i class="fa-solid fa-edit"></i> Bearbeiten
          </button>
          <button class="btn" onclick="deleteMember('${memberId}')">
            <i class="fa-solid fa-trash"></i> L√∂schen
          </button>
        </div>
      `;
      
      document.getElementById('memberDetailsBody').innerHTML = html;
      document.getElementById('memberDetailsModal').classList.add('show');
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.closeMemberDetailsModal = () => {
    document.getElementById('memberDetailsModal').classList.remove('show');
  };

  window.deleteMember = async (memberId) => {
    if (!confirm('Team-Mitglied wirklich l√∂schen?')) return;
    
    try {
      await pb.collection('team_members').update(memberId, { aktiv: false });
      showMsg('‚úÖ Mitglied entfernt!');
      closeMemberDetailsModal();
      await loadTeam();
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  // ========================================
  // PDF-EXPORT F√úR MEMBER
  // ========================================
  window.exportMemberPDF = async (memberId) => {
    try {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      const member = await pb.collection('team_members').getOne(memberId);
      const participations = await pb.collection('schulung_teilnahme').getFullList({
        filter: `member_id = "${memberId}"`,
        expand: 'session_id',
        sort: '-created'
      });
      
      doc.setFontSize(18);
      doc.text(`Teilnahmehistorie: ${member.vorname} ${member.name}`, 20, 20);
      
      const zugesagt = participations.filter(p => p.status === 'zugesagt').length;
      const abgesagt = participations.filter(p => p.status === 'abgesagt').length;
      const anwesend = participations.filter(p => p.anwesend).length;
      const abwesend = participations.filter(p => !p.anwesend && p.status !== 'abgesagt').length;
      
      doc.setFontSize(12);
      doc.text(`Zugesagt: ${zugesagt}  |  Abgesagt: ${abgesagt}  |  Anwesend: ${anwesend}  |  Offen: ${abwesend}`, 20, 35);
      
      let yPos = 50;
      doc.setFontSize(10);
      doc.text('Datum', 20, yPos);
      doc.text('Kurs', 60, yPos);
      doc.text('Rueckmeldung', 130, yPos);
      doc.text('Anwesenheit', 170, yPos);
      
      yPos += 7;
      participations.forEach(p => {
        const session = p.expand?.session_id;
        const course = session ? allCourses.find(c => c.id === session.course_id) : null;
        
        if (yPos > 270) {
          doc.addPage();
          yPos = 20;
        }
        
        doc.text(session ? formatDate(session.date) : '-', 20, yPos);
        doc.text(course ? course.title.substring(0, 25) : 'Unbekannt', 60, yPos);
        doc.text(p.status === 'zugesagt' ? 'Zugesagt' : p.status === 'abgesagt' ? 'Abgesagt' : 'Eingeladen', 130, yPos);
        doc.text(p.anwesend ? 'Anwesend' : 'Abwesend', 170, yPos);
        
        yPos += 7;
      });
      
      doc.save(`${member.vorname}_${member.name}_Historie.pdf`);
      showMsg('‚úÖ PDF exportiert!');
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.exportAllMembersStats = async () => {
    try {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      doc.setFontSize(18);
      doc.text('Gesamtauswertung Team', 20, 20);
      
      let yPos = 35;
      doc.setFontSize(10);
      
      for (const member of allMembers) {
        const participations = await pb.collection('schulung_teilnahme').getFullList({
          filter: `member_id = "${member.id}"`
        });
        
        const zugesagt = participations.filter(p => p.status === 'zugesagt').length;
        const abgesagt = participations.filter(p => p.status === 'abgesagt').length;
        const anwesend = participations.filter(p => p.anwesend).length;
        
        if (yPos > 270) {
          doc.addPage();
          yPos = 20;
        }
        
        doc.setFontSize(12);
        doc.text(`${member.vorname} ${member.name}`, 20, yPos);
        yPos += 6;
        
        doc.setFontSize(10);
        doc.text(`Zugesagt: ${zugesagt}  |  Abgesagt: ${abgesagt}  |  Anwesend: ${anwesend}  |  Gesamt: ${participations.length}`, 20, yPos);
        yPos += 10;
      }
      
      doc.save(`Team_Gesamtauswertung_${new Date().toISOString().split('T')[0]}.pdf`);
      showMsg('‚úÖ Gesamtauswertung exportiert!');
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  // ========================================
  // ZUGANG F√úR MITGLIED
  // ========================================
  window.openCreateAccessForMember = (memberId) => {
    currentAccessMember = memberId;
    const member = allMembers.find(m => m.id === memberId);
    
    if (member) {
      document.getElementById('access-member-name').textContent = `${member.vorname} ${member.name}`;
      memberAccessCode = generateAccessCode();
      document.getElementById('member-access-code').textContent = memberAccessCode;
      document.getElementById('createAccessForMemberModal').classList.add('show');
    }
  };

  window.closeCreateAccessForMemberModal = () => {
    document.getElementById('createAccessForMemberModal').classList.remove('show');
    currentAccessMember = null;
  };

  window.saveAccessForMember = async () => {
    if (!currentAccessMember) return;
    
    try {
      const member = allMembers.find(m => m.id === currentAccessMember);
      const password = generatePassword();
      
      await pb.collection('training_students').create({
        username: memberAccessCode,
        email: '',
        password,
        passwordConfirm: password,
        name: `${member.vorname} ${member.name}`,
        access_code: memberAccessCode,
        member_id: currentAccessMember,
        organization_id: currentUser.organization_id
      });
      
      showMsg(`‚úÖ Zugang erstellt! Code: ${memberAccessCode}`);
      closeCreateAccessForMemberModal();
      await loadTeam();
      
      if (document.getElementById('memberDetailsModal').classList.contains('show')) {
        await viewMemberDetails(currentAccessMember);
      }
      
    } catch(e) {
      console.error('Fehler Details:', e);
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.deleteAccessForMember = async (accessId) => {
    if (!confirm('Zugang wirklich entfernen?')) return;
    
    try {
      await pb.collection('training_students').delete(accessId);
      showMsg('‚úÖ Zugang entfernt!');
      await loadTeam();
      closeMemberDetailsModal();
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  // ========================================
  // ZUG√ÑNGE - SETTINGS
  // ========================================
  function renderSettings() {
    const list = document.getElementById('access-list');
    
    if (allAccess.length === 0) {
      list.innerHTML = '<div class="empty" style="background:#fff;border-radius:.75rem"><i class="fas fa-key"></i><div>Noch keine Zug√§nge</div></div>';
      return;
    }
    
    list.innerHTML = `
      <div style="background:#fff;border-radius:.75rem;padding:1.5rem;box-shadow:0 2px 8px rgba(0,0,0,.05)">
        <table class="table">
          <thead>
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Zugangscode</th>
              <th>Verkn√ºpft mit</th>
              <th>Aktionen</th>
            </tr>
          </thead>
          <tbody>
    `;
    
    allAccess.forEach((access, idx) => {
      const member = access.expand?.member_id;
      
      list.innerHTML += `
        <tr>
          <td style="font-weight:700">${idx + 1}</td>
          <td style="font-weight:700">${access.name}</td>
          <td>
            <div class="copy-box" style="display:inline-flex;width:auto">
              <span style="font-weight:700;color:var(--primary);font-family:monospace">${access.access_code}</span>
              <button class="btn btn-sm" onclick="copyToClipboard('${access.access_code}')">
                <i class="fas fa-copy"></i>
              </button>
            </div>
          </td>
          <td>
            ${member ? `
              <span class="badge online">
                <i class="fas fa-link"></i> ${member.vorname} ${member.name}
              </span>
            ` : `
              <span style="color:var(--muted);font-size:.85rem">Extern</span>
            `}
          </td>
          <td>
            <div style="display:flex;gap:4px">
              <button class="btn btn-sm success" onclick="exportAccessPDF('${access.id}')">
                <i class="fas fa-file-pdf"></i> PDF
              </button>
              <button class="btn btn-sm" onclick="deleteAccess('${access.id}')">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `;
    });
    
    list.innerHTML += `
          </tbody>
        </table>
      </div>
    `;
  }

  window.openSingleAccessModal = () => {
    document.getElementById('singleAccessForm').reset();
    generatePreviewCode();
    document.getElementById('singleAccessModal').classList.add('show');
  };

  window.closeSingleAccessModal = () => {
    document.getElementById('singleAccessModal').classList.remove('show');
  };

  document.getElementById('singleAccessForm').onsubmit = async (e) => {
    e.preventDefault();
    
    try {
      const formData = new FormData(e.target);
      const password = generatePassword();
      
      await pb.collection('training_students').create({
        username: previewAccessCode,
        email: '',
        password,
        passwordConfirm: password,
        name: formData.get('name').trim(),
        access_code: previewAccessCode,
        organization_id: currentUser.organization_id
      });
      
      showMsg(`‚úÖ Zugang erstellt! Code: ${previewAccessCode}`);
      closeSingleAccessModal();
      await loadSettings();
      
    } catch(e) {
      console.error('Fehler Details:', e);
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.openBulkAccessModal = () => {
    bulkAccessCount = 3;
    renderBulkAccessRows();
    document.getElementById('bulkAccessModal').classList.add('show');
  };

  window.closeBulkAccessModal = () => {
    document.getElementById('bulkAccessModal').classList.remove('show');
  };

  window.addBulkAccessRow = () => {
    bulkAccessCount++;
    renderBulkAccessRows();
  };

  function renderBulkAccessRows() {
    const list = document.getElementById('bulkAccessList');
    let html = '';
    
    for (let i = 0; i < bulkAccessCount; i++) {
      html += `
        <div style="display:grid;grid-template-columns:1fr auto;gap:8px;margin-bottom:8px;padding:12px;background:#f9fafb;border-radius:8px">
          <input type="text" placeholder="Name" data-bulk-name="${i}" style="padding:8px;border:1px solid #d1d5db;border-radius:6px">
          <button type="button" class="btn btn-sm" onclick="removeBulkAccessRow(${i})">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
    }
    
    list.innerHTML = html;
  }

  window.removeBulkAccessRow = (index) => {
    if (bulkAccessCount > 1) {
      bulkAccessCount--;
      renderBulkAccessRows();
    }
  };

  document.getElementById('bulkAccessForm').onsubmit = async (e) => {
    e.preventDefault();
    
    try {
      const names = Array.from(document.querySelectorAll('[data-bulk-name]'));
      
      let created = 0;
      
      for (let i = 0; i < names.length; i++) {
        const name = names[i].value.trim();
        
        if (name) {
          const password = generatePassword();
          const code = generateAccessCode();
          
          await pb.collection('training_students').create({
            username: code,
            email: '',
            password,
            passwordConfirm: password,
            name,
            access_code: code,
            organization_id: currentUser.organization_id
          });
          
          created++;
        }
      }
      
      showMsg(`‚úÖ ${created} Zug√§nge erstellt!`);
      closeBulkAccessModal();
      await loadSettings();
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.deleteAccess = async (accessId) => {
    if (!confirm('Zugang wirklich l√∂schen?')) return;
    
    try {
      await pb.collection('training_students').delete(accessId);
      showMsg('‚úÖ Zugang gel√∂scht!');
      await loadSettings();
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.exportAccessCodes = () => {
    if (allAccess.length === 0) {
      showMsg('Keine Zug√§nge zum Exportieren', 'error');
      return;
    }
    
    let csv = 'Name,Zugangscode,Verkn√ºpft mit\n';
    allAccess.forEach(access => {
      const member = access.expand?.member_id;
      const linkedTo = member ? `${member.vorname} ${member.name}` : 'Extern';
      csv += `"${access.name}","${access.access_code}","${linkedTo}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `zugaenge_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    
    showMsg('‚úÖ CSV exportiert!');
  };

  // ========================================
  // PDF-EXPORT F√úR ZUG√ÑNGE (MIT QR-CODE!)
  // ========================================
  window.exportAccessPDF = async (accessId) => {
    try {
      const { jsPDF } = window.jspdf;
      const access = allAccess.find(a => a.id === accessId);
      
      if (!access) {
        showMsg('Zugang nicht gefunden', 'error');
        return;
      }
      
      const doc = new jsPDF();
      const loginLink = `${window.location.origin}/ausbildungen-public.html`;
      
      doc.setFontSize(20);
      doc.setTextColor(200, 16, 46);
      doc.text('Responda Ausbildungen', 105, 20, { align: 'center' });
      
      doc.setFontSize(14);
      doc.setTextColor(0, 0, 0);
      doc.text('Pers√∂nlicher Zugang', 105, 30, { align: 'center' });
      
      doc.setDrawColor(200, 16, 46);
      doc.setLineWidth(0.5);
      doc.line(20, 35, 190, 35);
      
      doc.setFontSize(12);
      doc.setFont(undefined, 'bold');
      doc.text('Name:', 20, 50);
      doc.setFont(undefined, 'normal');
      doc.text(access.name, 60, 50);
      
      doc.setFontSize(16);
      doc.setFont(undefined, 'bold');
      doc.text('Ihr Zugangscode:', 20, 65);
      
      doc.setFontSize(24);
      doc.setTextColor(200, 16, 46);
      doc.setFont(undefined, 'bold');
      doc.text(access.access_code, 105, 80, { align: 'center' });
      
      doc.setDrawColor(200, 16, 46);
      doc.setLineWidth(1);
      doc.rect(40, 70, 130, 15);
      
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      doc.setFont(undefined, 'bold');
      doc.text('Login-Link:', 20, 100);
      doc.setFont(undefined, 'normal');
      doc.setFontSize(10);
      doc.setTextColor(0, 0, 255);
      doc.textWithLink(loginLink, 20, 108, { url: loginLink });
      
      doc.setTextColor(0, 0, 0);
      doc.setFontSize(12);
      doc.setFont(undefined, 'bold');
      doc.text('QR-Code:', 20, 125);
      
      const qrContainer = document.createElement('div');
      qrContainer.style.position = 'absolute';
      qrContainer.style.left = '-9999px';
      document.body.appendChild(qrContainer);
      
      try {
        const qr = new QRCode(qrContainer, {
          text: loginLink,
          width: 256,
          height: 256,
          correctLevel: QRCode.CorrectLevel.H
        });
        
        await new Promise(resolve => setTimeout(resolve, 100));
        
        const qrImg = qrContainer.querySelector('img');
        if (qrImg && qrImg.src) {
          doc.addImage(qrImg.src, 'PNG', 70, 130, 70, 70);
        } else {
          doc.setDrawColor(200);
          doc.rect(70, 130, 70, 70);
          doc.setFontSize(8);
          doc.text('QR-Code Scan:', 105, 165, { align: 'center' });
          doc.text(loginLink, 105, 170, { align: 'center', maxWidth: 60 });
        }
      } catch(qrError) {
        console.error('QR-Code Fehler:', qrError);
        doc.setDrawColor(200);
        doc.rect(70, 130, 70, 70);
        doc.setFontSize(8);
        doc.text('QR-Code Scan:', 105, 165, { align: 'center' });
        doc.text(loginLink, 105, 170, { align: 'center', maxWidth: 60 });
      } finally {
        document.body.removeChild(qrContainer);
      }
      
      doc.setFontSize(12);
      doc.setFont(undefined, 'bold');
      doc.text('So melden Sie sich an:', 20, 215);
      
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      const instructions = [
        '1. √ñffnen Sie den Login-Link im Browser',
        '2. Geben Sie Ihren Zugangscode ein (siehe oben)',
        '3. Sie werden automatisch eingeloggt',
        '4. Zugewiesene Lernmodule werden angezeigt'
      ];
      
      let yPos = 225;
      instructions.forEach(line => {
        doc.text(line, 25, yPos);
        yPos += 7;
      });
      
      doc.setFontSize(8);
      doc.setTextColor(100);
      doc.text('Responda - Ausbildungsverwaltung', 105, 280, { align: 'center' });
      doc.text(new Date().toLocaleDateString('de-DE'), 105, 285, { align: 'center' });
      
      const filename = `Zugang_${access.name.replace(/ /g, '_')}.pdf`;
      doc.save(filename);
      
      showMsg('‚úÖ PDF erstellt!');
      
    } catch(e) {
      console.error('PDF Fehler:', e);
      showMsg('Fehler beim PDF-Export: ' + e.message, 'error');
    }
  };

  window.exportAllAccessPDFs = async () => {
    if (allAccess.length === 0) {
      showMsg('Keine Zug√§nge vorhanden', 'error');
      return;
    }
    
    if (!confirm(`${allAccess.length} PDFs erstellen? Das kann einen Moment dauern.`)) {
      return;
    }
    
    try {
      showMsg(`üìÑ Erstelle ${allAccess.length} PDFs...`, 'info');
      
      for (let i = 0; i < allAccess.length; i++) {
        await exportAccessPDF(allAccess[i].id);
        await new Promise(resolve => setTimeout(resolve, 800));
      }
      
      showMsg(`‚úÖ Alle ${allAccess.length} PDFs erstellt!`);
      
    } catch(e) {
      showMsg('Fehler beim Massen-Export: ' + e.message, 'error');
    }
  };
  // ========================================
  // LERNBEREICH
  // ========================================
  async function loadLernbereich() {
    try {
      allModules = await pb.collection('learning_modules').getFullList({
        filter: `organization_id = "${currentUser.organization_id}"`,
        sort: '-created'
      });
      
      renderLernbereich();
    } catch(e) {
      console.error('Error:', e);
      document.getElementById('lernbereich-list').innerHTML = `<div class="empty" style="background:#fff;border-radius:.75rem"><i class="fas fa-exclamation-triangle"></i><div style="color:#c00">Fehler: ${e.message}</div></div>`;
    }
  }

  function renderLernbereich() {
    const list = document.getElementById('lernbereich-list');
    
    if (allModules.length === 0) {
      list.innerHTML = '<div class="empty" style="background:#fff;border-radius:.75rem"><i class="fas fa-laptop"></i><div>Noch keine Lernmodule</div></div>';
      return;
    }
    
    list.innerHTML = allModules.map(module => {
      const slides = module.slides || [];
      
      return `
        <div class="module-card" onclick="viewModuleDetails('${module.id}')">
          <div class="card-title"><i class="fa-solid fa-laptop"></i> ${module.title}</div>
          <div class="card-meta">
            <span><i class="fa-solid fa-layer-group"></i> ${slides.length} Folien</span>
            ${module.instructor ? `<span><i class="fa-solid fa-user"></i> ${module.instructor}</span>` : ''}
          </div>
          ${module.description ? `
            <div style="margin-top:8px;color:var(--muted);font-size:.85rem">${module.description}</div>
          ` : ''}
          ${module.require_quiz ? `
            <div style="margin-top:8px;padding:6px;background:#fee2e2;border-radius:6px;font-size:0.85rem">
              <i class="fa-solid fa-clipboard-question"></i> Abschlusspr√ºfung erforderlich (${module.passing_score}%)
            </div>
          ` : ''}
        </div>
      `;
    }).join('');
  }

  window.openModuleModal = (moduleId = null) => {
    currentEditModule = moduleId;
    const form = document.getElementById('moduleForm');
    form.reset();
    
    if (moduleId) {
      const module = allModules.find(m => m.id === moduleId);
      if (module) {
        document.getElementById('moduleModalTitle').innerHTML = '<i class="fa-solid fa-laptop-edit"></i> Lernmodul bearbeiten';
        form.title.value = module.title || '';
        form.instructor.value = module.instructor || '';
        form.description.value = module.description || '';
        form.passing_score.value = module.passing_score || 80;
        form.max_attempts.value = module.max_attempts || 3;
        form.require_quiz.checked = module.require_quiz || false;
      }
    } else {
      document.getElementById('moduleModalTitle').innerHTML = '<i class="fa-solid fa-laptop"></i> Neues Lernmodul';
    }
    
    document.getElementById('moduleModal').classList.add('show');
  };

  window.closeModuleModal = () => {
    document.getElementById('moduleModal').classList.remove('show');
    currentEditModule = null;
  };

  document.getElementById('moduleForm').onsubmit = async (e) => {
    e.preventDefault();
    
    try {
      const formData = new FormData(e.target);
      const data = {
        title: formData.get('title').trim(),
        instructor: formData.get('instructor').trim(),
        description: formData.get('description').trim(),
        passing_score: parseInt(formData.get('passing_score')) || 80,
        max_attempts: parseInt(formData.get('max_attempts')) || 3,
        require_quiz: formData.get('require_quiz') === 'on',
        slides: [],
        organization_id: currentUser.organization_id
      };
      
      if (currentEditModule) {
        const existing = allModules.find(m => m.id === currentEditModule);
        data.slides = existing.slides || [];
        await pb.collection('learning_modules').update(currentEditModule, data);
        showMsg('‚úÖ Lernmodul aktualisiert!');
      } else {
        await pb.collection('learning_modules').create(data);
        showMsg('‚úÖ Lernmodul erstellt!');
      }
      
      closeModuleModal();
      await loadLernbereich();
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.viewModuleDetails = async (moduleId) => {
    try {
      const module = await pb.collection('learning_modules').getOne(moduleId);
      const slides = module.slides || [];
      
      document.getElementById('moduleDetailsTitle').innerHTML = 
        `<i class="fa-solid fa-laptop"></i> ${module.title}`;
      
      let html = `
        <div class="details-section">
          <h4><i class="fa-solid fa-info-circle"></i> Informationen</h4>
          <div style="display:grid;grid-template-columns:150px 1fr;gap:8px">
            <div style="font-weight:700;color:#6b7280">Titel:</div>
            <div style="font-weight:700;font-size:1.1rem">${module.title}</div>
            
            ${module.instructor ? `
            <div style="font-weight:700;color:#6b7280">Dozent:</div>
            <div>${module.instructor}</div>
            ` : ''}
            
            ${module.description ? `
            <div style="font-weight:700;color:#6b7280">Beschreibung:</div>
            <div>${module.description}</div>
            ` : ''}
            
            <div style="font-weight:700;color:#6b7280">Folien:</div>
            <div><span class="badge info">${slides.length} Folien</span></div>
            
            ${module.require_quiz ? `
            <div style="font-weight:700;color:#6b7280">Abschlusspr√ºfung:</div>
            <div>
              <span class="badge warning">Erforderlich (${module.passing_score}%)</span>
              ‚Ä¢ Max. ${module.max_attempts === 0 ? '‚àû' : module.max_attempts} Versuche
            </div>
            ` : ''}
          </div>
        </div>
        
        <div style="margin-top:1rem;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn primary" onclick="openSlideEditor('${moduleId}')">
            <i class="fas fa-edit"></i> Folien bearbeiten
          </button>
          <button class="btn success" onclick="previewModule('${moduleId}')">
            <i class="fas fa-play"></i> Vorschau
          </button>
          <button class="btn info" onclick="openAssignMembersModal('${moduleId}')">
            <i class="fas fa-users"></i> Personen zuweisen
          </button>
          <button class="btn" onclick="closeModuleDetailsModal();openModuleModal('${moduleId}')">
            <i class="fas fa-cog"></i> Einstellungen
          </button>
          <button class="btn" onclick="deleteModule('${moduleId}')">
            <i class="fas fa-trash"></i> L√∂schen
          </button>
        </div>
      `;
      
      document.getElementById('moduleDetailsBody').innerHTML = html;
      document.getElementById('moduleDetailsModal').classList.add('show');
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.closeModuleDetailsModal = () => {
    document.getElementById('moduleDetailsModal').classList.remove('show');
  };

  window.deleteModule = async (moduleId) => {
    if (!confirm('Lernmodul wirklich l√∂schen?')) return;
    
    try {
      await pb.collection('learning_modules').delete(moduleId);
      showMsg('‚úÖ Lernmodul gel√∂scht!');
      closeModuleDetailsModal();
      await loadLernbereich();
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  // ========================================
  // FOLIEN-EDITOR (VEREINFACHT)
  // ========================================
  window.openSlideEditor = async (moduleId) => {
    currentLearningModule = moduleId;
    const module = await pb.collection('learning_modules').getOne(moduleId);
    currentSlides = module.slides || [];
    
    document.getElementById('slideEditorTitle').innerHTML = 
      `<i class="fa-solid fa-layer-group"></i> Folien bearbeiten: ${module.title}`;
    
    renderSlidesList();
    document.getElementById('slideEditorModal').classList.add('show');
  };

  window.closeSlideEditor = () => {
    document.getElementById('slideEditorModal').classList.remove('show');
    currentLearningModule = null;
    currentSlides = [];
  };

  function renderSlidesList() {
    const list = document.getElementById('slides-list');
    
    if (currentSlides.length === 0) {
      list.innerHTML = '<div class="empty"><i class="fas fa-layer-group"></i><div>Noch keine Folien</div></div>';
      return;
    }
    
    list.innerHTML = currentSlides.map((slide, idx) => {
      const icons = {
        text: 'üìù',
        image: 'üñºÔ∏è',
        video: 'üé•',
        quiz: '‚ùì'
      };
      
      return `
        <div class="slide-item">
          <div style="display:flex;align-items:center;flex:1">
            <div class="slide-type-icon ${slide.type}">${icons[slide.type] || 'üìÑ'}</div>
            <div style="flex:1">
              <div style="font-weight:700">${slide.title}</div>
              <div style="font-size:0.85rem;color:var(--muted)">${slide.type} ‚Ä¢ ${slide.duration || 5} Min.</div>
            </div>
          </div>
          <div style="display:flex;gap:4px">
            <button class="btn btn-sm" onclick="deleteSlide(${idx})">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      `;
    }).join('');
  }

  window.openNewSlideModal = () => {
    document.getElementById('newSlideForm').reset();
    document.getElementById('slide-type').value = 'text';
    updateSlideTypeFields();
    
    if (slideContentEditor) {
      slideContentEditor.root.innerHTML = '';
    } else {
      setTimeout(() => {
        slideContentEditor = new Quill('#slide-content-editor', {
          theme: 'snow',
          modules: {
            toolbar: [
              ['bold', 'italic', 'underline'],
              [{ 'list': 'ordered'}, { 'list': 'bullet' }],
              ['link']
            ]
          }
        });
      }, 100);
    }
    
    quizAnswers = [];
    renderQuizAnswers();
    
    document.getElementById('newSlideModal').classList.add('show');
  };

  window.closeNewSlideModal = () => {
    document.getElementById('newSlideModal').classList.remove('show');
    currentEditSlide = null;
  };

  window.updateSlideTypeFields = () => {
    const type = document.getElementById('slide-type').value;
    
    document.getElementById('text-slide-fields').style.display = type === 'text' ? 'block' : 'none';
    document.getElementById('image-slide-fields').style.display = type === 'image' ? 'block' : 'none';
    document.getElementById('video-slide-fields').style.display = type === 'video' ? 'block' : 'none';
    document.getElementById('quiz-slide-fields').style.display = type === 'quiz' ? 'block' : 'none';
  };

  window.addQuizAnswer = () => {
    quizAnswers.push({ text: '', correct: false });
    renderQuizAnswers();
  };

  function renderQuizAnswers() {
    const list = document.getElementById('quiz-answers-list');
    
    list.innerHTML = quizAnswers.map((answer, idx) => `
      <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
        <input type="text" placeholder="Antwort ${idx + 1}" value="${answer.text}" 
          onchange="quizAnswers[${idx}].text = this.value"
          style="flex:1;padding:8px;border:1px solid var(--border);border-radius:6px">
        <label style="display:flex;align-items:center;gap:4px;white-space:nowrap">
          <input type="checkbox" ${answer.correct ? 'checked' : ''} 
            onchange="quizAnswers[${idx}].correct = this.checked">
          <span>Richtig</span>
        </label>
        <button type="button" class="btn btn-sm" onclick="removeQuizAnswer(${idx})">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    `).join('');
  }

  window.removeQuizAnswer = (idx) => {
    quizAnswers.splice(idx, 1);
    renderQuizAnswers();
  };

  window.saveSlide = async () => {
    try {
      const type = document.getElementById('slide-type').value;
      const title = document.getElementById('slide-title').value.trim();
      const duration = parseInt(document.getElementById('slide-duration').value) || 5;
      
      if (!title) {
        showMsg('Bitte Titel eingeben', 'error');
        return;
      }
      
      const slide = { type, title, duration };
      
      if (type === 'text') {
        slide.content = slideContentEditor.root.innerHTML;
      } else if (type === 'image') {
        slide.image_url = document.getElementById('slide-image-url').value.trim();
        slide.description = document.getElementById('slide-image-description').value.trim();
      } else if (type === 'video') {
        slide.video_url = document.getElementById('slide-video-url').value.trim();
        slide.description = document.getElementById('slide-video-description').value.trim();
      } else if (type === 'quiz') {
        slide.question = document.getElementById('slide-quiz-question').value.trim();
        slide.answers = quizAnswers;
        slide.explanation = document.getElementById('slide-quiz-explanation').value.trim();
        
        if (!slide.question || quizAnswers.length === 0) {
          showMsg('Bitte Frage und Antworten eingeben', 'error');
          return;
        }
      }
      
      currentSlides.push(slide);
      
      await pb.collection('learning_modules').update(currentLearningModule, {
        slides: currentSlides
      });
      
      showMsg('‚úÖ Folie gespeichert!');
      closeNewSlideModal();
      renderSlidesList();
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.deleteSlide = async (idx) => {
    if (!confirm('Folie wirklich l√∂schen?')) return;
    
    try {
      currentSlides.splice(idx, 1);
      
      await pb.collection('learning_modules').update(currentLearningModule, {
        slides: currentSlides
      });
      
      showMsg('‚úÖ Folie gel√∂scht!');
      renderSlidesList();
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  // ========================================
  // MODUL VORSCHAU (VEREINFACHT)
  // ========================================
  window.previewModule = async (moduleId) => {
    try {
      const module = await pb.collection('learning_modules').getOne(moduleId);
      previewSlides = module.slides || [];
      currentPreviewIndex = 0;
      
      document.getElementById('previewModuleTitle').innerHTML = 
        `<i class="fa-solid fa-play"></i> Vorschau: ${module.title}`;
      
      renderPreviewSlide();
      document.getElementById('modulePreviewModal').classList.add('show');
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.closePreviewModal = () => {
    document.getElementById('modulePreviewModal').classList.remove('show');
    previewSlides = [];
    currentPreviewIndex = 0;
  };

  function renderPreviewSlide() {
    if (previewSlides.length === 0) {
      document.getElementById('previewContent').innerHTML = '<div class="empty"><i class="fas fa-layer-group"></i><div>Keine Folien</div></div>';
      return;
    }
    
    const slide = previewSlides[currentPreviewIndex];
    const content = document.getElementById('previewContent');
    
    let html = `<h3 style="color:var(--primary);margin-bottom:1rem">${slide.title}</h3>`;
    
    if (slide.type === 'text') {
      html += `<div style="line-height:1.8">${slide.content}</div>`;
    } else if (slide.type === 'image') {
      html += `
        <img src="${slide.image_url}" style="max-width:100%;border-radius:8px;margin-bottom:1rem" />
        <p>${slide.description}</p>
      `;
    } else if (slide.type === 'video') {
      html += `
        <div style="margin-bottom:1rem">
          <a href="${slide.video_url}" target="_blank" class="btn primary">
            <i class="fas fa-play"></i> Video √∂ffnen
          </a>
        </div>
        <p>${slide.description}</p>
      `;
    } else if (slide.type === 'quiz') {
      html += `
        <p style="font-weight:700;font-size:1.1rem;margin-bottom:1rem">${slide.question}</p>
        <div>
      `;
      
      slide.answers.forEach((answer, idx) => {
        html += `
          <div style="padding:12px;margin-bottom:8px;border-radius:8px;border:2px solid var(--border);background:#f9fafb">
            ${answer.text} ${answer.correct ? '<strong style="color:var(--success)">‚úì</strong>' : ''}
          </div>
        `;
      });
      
      html += `</div>`;
      
      if (slide.explanation) {
        html += `<p style="margin-top:1rem;padding:12px;background:#eff6ff;border-radius:8px">${slide.explanation}</p>`;
      }
    }
    
    content.innerHTML = html;
    
    document.getElementById('slideCounter').textContent = `${currentPreviewIndex + 1} / ${previewSlides.length}`;
    document.getElementById('prevSlideBtn').disabled = currentPreviewIndex === 0;
    document.getElementById('nextSlideBtn').disabled = currentPreviewIndex === previewSlides.length - 1;
  }

  window.prevPreviewSlide = () => {
    if (currentPreviewIndex > 0) {
      currentPreviewIndex--;
      renderPreviewSlide();
    }
  };

  window.nextPreviewSlide = () => {
    if (currentPreviewIndex < previewSlides.length - 1) {
      currentPreviewIndex++;
      renderPreviewSlide();
    }
  };

  // ========================================
  // PERSONEN ZUWEISEN
  // ========================================
  window.openAssignMembersModal = async (moduleId) => {
    try {
      currentLearningModule = moduleId;
      
      const assignments = await pb.collection('module_assignments').getFullList({
        filter: `module_id = "${moduleId}"`
      });
      
      selectedAssignments = assignments.map(a => a.member_id);
      
      const list = document.getElementById('assignMembersList');
      list.innerHTML = allMembers.map(member => {
        const isAssigned = selectedAssignments.includes(member.id);
        
        return `
          <div style="padding:.75rem;border-bottom:1px solid var(--border)">
            <label style="display:flex;align-items:center;gap:.75rem;cursor:pointer">
              <input type="checkbox" ${isAssigned ? 'checked' : ''} 
                onchange="toggleAssignment('${member.id}')">
              <div style="flex:1">
                <div style="font-weight:700">${member.vorname} ${member.name}</div>
                <div style="font-size:.85rem;color:var(--muted)">${(member.qualifikationen || []).join(', ')}</div>
              </div>
            </label>
          </div>
        `;
      }).join('');
      
      document.getElementById('assignMembersModal').classList.add('show');
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.closeAssignMembersModal = () => {
    document.getElementById('assignMembersModal').classList.remove('show');
    selectedAssignments = [];
  };

  window.toggleAssignment = (memberId) => {
    const idx = selectedAssignments.indexOf(memberId);
    if (idx >= 0) {
      selectedAssignments.splice(idx, 1);
    } else {
      selectedAssignments.push(memberId);
    }
  };

  window.saveAssignments = async () => {
    try {
      const existing = await pb.collection('module_assignments').getFullList({
        filter: `module_id = "${currentLearningModule}"`
      });
      
      for (const assignment of existing) {
        await pb.collection('module_assignments').delete(assignment.id);
      }
      
      for (const memberId of selectedAssignments) {
        await pb.collection('module_assignments').create({
          module_id: currentLearningModule,
          member_id: memberId,
          organization_id: currentUser.organization_id
        });
      }
      
      showMsg('‚úÖ Zuweisungen gespeichert!');
      closeAssignMembersModal();
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  // ========================================
  // INIT
  // ========================================
  (async () => {
    const authOk = await checkAuth();
    if (authOk) {
      await loadCourses();
      setTimeout(() => {
        document.body.classList.add('loaded');
      }, 100);
    }
  })();

</script>

</body>
</html>
