<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ausbildungen ‚Äì Responda</title>
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  
  <!-- Quill Rich Text Editor -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/pocketbase@0.21.3/dist/pocketbase.umd.js"></script>

  <style>
    :root{--primary:#c8102e;--bg:#f8fafc;--card:#fff;--text:#0f172a;--muted:#64748b;--border:#e2e8f0}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:'Atkinson Hyperlegible',-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;line-height:1.45;padding-bottom:100px}
    
    header{background:linear-gradient(90deg,var(--primary),#981b1b);color:#fff;padding:12px 16px;display:flex;align-items:center;gap:12px}
    header h1{margin:0;font-size:1rem;font-weight:800}
    .spacer{flex:1}
    .topbtn{background:#ffffff1a;color:#fff;padding:8px 12px;border-radius:10px;text-decoration:none;font-weight:800;font-size:0.9rem;border:1px solid #ffffff55}
    .topbtn:hover{background:#ffffff2b}
    
    .wrap{max-width:1400px;margin:18px auto;padding:0 14px}
    .card{background:var(--card);border-radius:14px;box-shadow:0 3px 12px rgba(0,0,0,.06);padding:20px;margin-bottom:20px}
    .card h2{margin-top:0;color:var(--primary)}
    
    .tabs{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap}
    .tab{border:1px solid #eee;background:#fafafa;padding:10px 16px;border-radius:999px;font-weight:800;cursor:pointer;font-size:0.95rem;transition:all 0.2s}
    .tab:hover{background:#f0f0f0}
    .tab.active{color:#fff;background:var(--primary);border-color:var(--primary)}
    
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;margin-top:16px}
    
    .schulung-card, .member-card{
      background:#fff;
      border:2px solid var(--border);
      border-radius:12px;
      padding:16px;
      cursor:pointer;
      transition:all 0.2s;
    }
    .schulung-card:hover, .member-card:hover{
      border-color:var(--primary);
      box-shadow:0 4px 12px rgba(200,16,46,.1);
      transform:translateY(-2px);
    }
    .schulung-card h3, .member-card h3{margin:0 0 8px 0;color:var(--text);font-size:1.1rem}
    .schulung-card .meta, .member-card .tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    
    .meta-item{font-size:0.85rem;color:var(--muted)}
    .tag{background:#fee;color:var(--primary);padding:4px 10px;border-radius:999px;font-size:0.8rem;font-weight:700}
    
    .btn{background:var(--primary);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer;font-size:0.9rem;transition:all 0.2s;display:inline-flex;align-items:center;gap:6px;font-family:inherit}
    .btn:hover{background:#a00d26}
    .btn-secondary{background:#6b7280;color:#fff}
    .btn-secondary:hover{background:#4b5563}
    .btn-success{background:#16a34a;color:#fff}
    .btn-success:hover{background:#15803d}
    .btn-sm{padding:6px 10px;font-size:0.85rem}
    
    .add-btn{position:fixed;bottom:30px;right:30px;width:60px;height:60px;border-radius:50%;background:var(--primary);color:#fff;border:0;cursor:pointer;font-size:1.5rem;box-shadow:0 4px 12px rgba(0,0,0,.2);z-index:100;transition:transform 0.2s}
    .add-btn:hover{transform:scale(1.1)}
    
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:flex-start;justify-content:center;z-index:1000;padding:20px;overflow-y:auto}
    .modal.show{display:flex}
    .modal-box{
      background:#fff;
      border-radius:14px;
      max-width:800px;
      width:100%;
      max-height:85vh;
      overflow-y:auto;
      padding:24px;
      box-shadow:0 8px 20px rgba(0,0,0,.3);
      margin:auto;
    }
    .modal-box h3{margin-top:0;color:var(--primary);font-weight:800}
    
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;margin:16px 0}
    .form-group{display:flex;flex-direction:column;gap:6px}
    .form-group label{font-weight:700;font-size:0.9rem;color:#374151}
    .form-group input,.form-group textarea,.form-group select{
      padding:10px 12px;
      border:1px solid #d1d5db;
      border-radius:8px;
      font-size:16px;
      font-family:inherit;
      width:100%;
    }
    .form-group input:focus,.form-group textarea:focus,.form-group select:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(200,16,46,0.1);
    }
    
    .tag-input-wrapper{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      padding:8px;
      border:1px solid #d1d5db;
      border-radius:8px;
      min-height:44px;
      align-items:center;
      background:#fff;
    }
    .tag-input-wrapper:focus-within{
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(200,16,46,0.1);
    }
    .tag-input-wrapper .tag{
      display:flex;
      align-items:center;
      gap:4px;
    }
    .tag-input-wrapper .tag .remove-tag{cursor:pointer;font-weight:bold;margin-left:4px}
    .tag-input-wrapper input{border:none;outline:none;flex:1;min-width:100px;font-size:16px;padding:4px}
    
    .msg{margin-top:12px;padding:12px;border-radius:8px;font-weight:600}
    .msg.error{background:#fee;color:#c00;border:1px solid #fcc}
    .msg.success{background:#efe;color:#060;border:1px solid #cfc}
    .msg.info{background:#eff6ff;color:#1e40af;border:1px solid #bfdbfe}
    
    .details-section{margin:20px 0;padding:16px;background:#f9fafb;border-radius:8px}
    .details-section h4{margin:0 0 12px 0;color:var(--primary);font-size:1rem}
    
    .attendance-table{width:100%;border-collapse:collapse;margin-top:12px}
    .attendance-table th,.attendance-table td{padding:10px;border:1px solid var(--border);text-align:left}
    .attendance-table th{background:#f8fafc;font-weight:700}
    .attendance-table tr:hover{background:#f9fafb}
    
    .status-badge{padding:4px 10px;border-radius:999px;font-size:0.8rem;font-weight:700;display:inline-block}
    .status-badge.anwesend{background:#d1fae5;color:#065f46}
    .status-badge.abwesend{background:#fee2e2;color:#991b1b}
    
    /* Quill Editor */
    .ql-container{
      font-family:'Atkinson Hyperlegible',-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      font-size:1rem;
      min-height:200px;
      max-height:300px;
    }
    .ql-editor{
      min-height:200px;
      max-height:300px;
      overflow-y:auto;
    }
    
    /* Access Codes */
    .access-code-box{
      background:#f9fafb;
      padding:1rem;
      border-radius:.5rem;
      border:2px dashed var(--primary);
      text-align:center;
      margin:1rem 0;
    }
    .access-code{
      font-size:1.5rem;
      font-weight:800;
      font-family:monospace;
      color:var(--primary);
      margin:.5rem 0;
    }
    
    .copy-box{
      background:#f9fafb;
      padding:.75rem;
      border-radius:.5rem;
      border:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:.5rem;
      font-family:monospace;
      font-size:.85rem;
    }
    
    .slide-item{
      background:#f9fafb;
      padding:1rem;
      border-radius:.5rem;
      border-left:4px solid var(--primary);
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:.75rem;
      transition:all 0.2s;
    }
    .slide-item:hover{background:#f3f4f6;transform:translateX(4px)}
    
    .slide-type-icon{
      width:40px;
      height:40px;
      border-radius:.5rem;
      display:flex;
      align-items:center;
      justify-content:center;
      margin-right:1rem;
      font-size:1.2rem;
    }
    .slide-type-icon.text{background:#dbeafe;color:#1e40af}
    .slide-type-icon.image{background:#dcfce7;color:#166534}
    .slide-type-icon.video{background:#fef3c7;color:#92400e}
    .slide-type-icon.quiz{background:#fee2e2;color:#991b1b}
    
    @media (max-width:768px){
      .grid{grid-template-columns:1fr}
      .form-grid{grid-template-columns:1fr}
      .modal-box{padding:16px}
      .add-btn{bottom:20px;right:20px}
    }
  </style>
</head>
<body>
  <header>
    <h1><i class="fa-solid fa-graduation-cap"></i> Ausbildungen</h1>
    <div class="spacer"></div>
    <a class="topbtn" href="mpg-dashboard.html"><i class="fa-solid fa-dashboard"></i> Dashboard</a>
    <a class="topbtn" href="#" id="logout"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
  </header>

  <div class="wrap">
    <section class="card">
      <h2>√úbersicht</h2>
      
      <div class="tabs">
        <button class="tab active" data-tab="schulungen"><i class="fa-solid fa-book"></i> Ausbildungen (<span id="schulungen-count">0</span>)</button>
        <button class="tab" data-tab="team"><i class="fa-solid fa-users"></i> Team (<span id="team-count">0</span>)</button>
        <button class="tab" data-tab="lernbereich"><i class="fa-solid fa-laptop"></i> Lernbereich</button>
        <button class="tab" data-tab="settings"><i class="fa-solid fa-cog"></i> Einstellungen</button>
      </div>

      <!-- TAB: AUSBILDUNGEN -->
      <div id="tab-schulungen" class="tab-content">
        <div class="grid" id="schulungenGrid">
          <p style="padding:20px;color:#999">Lade Ausbildungen...</p>
        </div>
      </div>

      <!-- TAB: TEAM -->
      <div id="tab-team" class="tab-content" style="display:none">
        <div class="grid" id="teamGrid">
          <p style="padding:20px;color:#999">Lade Team...</p>
        </div>
      </div>

      <!-- TAB: LERNBEREICH -->
      <div id="tab-lernbereich" class="tab-content" style="display:none">
        <div class="msg info" style="margin-bottom:1rem">
          <i class="fa-solid fa-lightbulb"></i> <strong>Tipp:</strong> Erstelle zuerst einen Kurs mit Typ "Online" oder "Hybrid" bei Ausbildungen, dann kannst du hier Lernmodule erstellen.
        </div>
        <div id="lernbereichGrid">
          <p style="padding:20px;color:#999">Lade Lernbereiche...</p>
        </div>
      </div>

      <!-- TAB: EINSTELLUNGEN -->
      <div id="tab-settings" class="tab-content" style="display:none">
        <h3 style="margin:0 0 1rem 0">Externe Zug√§nge verwalten</h3>
        <p style="color:var(--muted);margin-bottom:1rem">
          Externe Teilnehmer k√∂nnen sich mit ihrem 3-Wort-Code bei <strong>ausbildungen-public.html</strong> anmelden.
        </p>
        
        <div style="display:flex;gap:.5rem;margin-bottom:1.5rem;flex-wrap:wrap">
          <button class="btn" onclick="openSingleAccessModal()">
            <i class="fas fa-user-plus"></i> Einzelnen Zugang erstellen
          </button>
          <button class="btn btn-secondary" onclick="openBulkAccessModal()">
            <i class="fas fa-users"></i> Mehrere Zug√§nge erstellen
          </button>
          <button class="btn btn-secondary" onclick="exportAccessCodes()">
            <i class="fas fa-download"></i> Als CSV exportieren
          </button>
        </div>
        
        <div id="access-list">
          <p style="padding:20px;color:#999">Lade Zug√§nge...</p>
        </div>
      </div>

      <div id="msg"></div>
    </section>
  </div>

  <button class="add-btn" id="addBtn" title="Neu anlegen">
    <i class="fa-solid fa-plus"></i>
  </button>

<!-- Modal: Neue Schulung -->
<div class="modal" id="schulungModal">
  <div class="modal-box">
    <h3 id="schulungModalTitle"><i class="fa-solid fa-book-medical"></i> Neue Ausbildung</h3>
    <form id="schulungForm">
      <div class="form-grid">
        <div class="form-group">
          <label>Titel *</label>
          <input type="text" name="title" required>
        </div>
        <div class="form-group">
          <label>Typ *</label>
          <select name="type" required>
            <option value="pr√§senz">Pr√§senz</option>
            <option value="online">Online</option>
            <option value="hybrid">Hybrid</option>
          </select>
        </div>
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label>Dozent</label>
          <input type="text" name="instructor">
        </div>
        <div class="form-group">
          <label>Max. Teilnehmer</label>
          <input type="number" name="max_participants" min="1">
        </div>
      </div>
      <div class="form-group">
        <label>Beschreibung</label>
        <textarea name="description" rows="4"></textarea>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
        <button type="button" class="btn btn-secondary" onclick="closeSchulungModal()">Abbrechen</button>
        <button type="submit" class="btn"><i class="fa-solid fa-save"></i> Speichern</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Schulungs-Details -->
<div class="modal" id="schulungDetailsModal">
  <div class="modal-box">
    <h3 id="schulungDetailsTitle">Ausbildung</h3>
    <div id="schulungDetailsBody"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
      <button class="btn btn-secondary" onclick="closeSchulungDetailsModal()">Schlie√üen</button>
    </div>
  </div>
</div>

<!-- Modal: Neuer Termin -->
<div class="modal" id="sessionModal">
  <div class="modal-box">
    <h3><i class="fa-solid fa-calendar-plus"></i> Neuer Termin</h3>
    <form id="sessionForm">
      <input type="hidden" name="course_id" id="session-course-id">
      <div class="form-grid">
        <div class="form-group">
          <label>Datum *</label>
          <input type="date" name="date" required>
        </div>
        <div class="form-group">
          <label>Von</label>
          <input type="time" name="start_time" value="09:00">
        </div>
        <div class="form-group">
          <label>Bis</label>
          <input type="time" name="end_time" value="17:00">
        </div>
      </div>
      <div class="form-group">
        <label>Ort</label>
        <input type="text" name="location" placeholder="z.B. Schulungsraum A">
      </div>
      <div class="form-group">
        <label>Teilnehmer ausw√§hlen</label>
        <button type="button" class="btn btn-secondary" onclick="openParticipantSelector()">
          <i class="fas fa-users"></i> Ausw√§hlen (<span id="selected-count">0</span>)
        </button>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
        <button type="button" class="btn btn-secondary" onclick="closeSessionModal()">Abbrechen</button>
        <button type="submit" class="btn"><i class="fa-solid fa-save"></i> Speichern</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Teilnehmer ausw√§hlen -->
<div class="modal" id="participantModal">
  <div class="modal-box" style="max-width:500px">
    <h3><i class="fa-solid fa-users"></i> Teilnehmer ausw√§hlen</h3>
    <div id="participantList" style="max-height:400px;overflow-y:auto"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
      <button class="btn" onclick="closeParticipantModal()">
        <i class="fa-solid fa-check"></i> Fertig
      </button>
    </div>
  </div>
</div>

<!-- Modal: Termin-Details -->
<div class="modal" id="sessionDetailsModal">
  <div class="modal-box">
    <h3 id="sessionDetailsTitle">Termin-Details</h3>
    <div id="sessionDetailsBody"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
      <button class="btn btn-secondary" onclick="closeSessionDetailsModal()">Schlie√üen</button>
      <button class="btn" onclick="saveAttendance()">
        <i class="fa-solid fa-save"></i> Anwesenheit speichern
      </button>
    </div>
  </div>
</div>

<!-- Modal: Neue Person -->
<div class="modal" id="memberModal">
  <div class="modal-box">
    <h3 id="memberModalTitle"><i class="fa-solid fa-user-plus"></i> Neue Person</h3>
    <form id="memberForm">
      <div class="form-grid">
        <div class="form-group">
          <label>Name *</label>
          <input type="text" name="name" required>
        </div>
        <div class="form-group">
          <label>E-Mail *</label>
          <input type="email" name="email" required>
        </div>
      </div>
      <div class="form-group">
        <label>Passwort *</label>
        <input type="password" name="password" minlength="8" required>
      </div>
      <div class="form-group">
        <label>Qualifikationen / Tags</label>
        <div class="tag-input-wrapper" id="tagInputWrapper">
          <input 
            type="text" 
            id="tagInput" 
            placeholder="Tag eingeben und Enter dr√ºcken"
          >
        </div>
        <small style="color:#6b7280;font-size:0.85rem">Beispiele: Rettungssanit√§ter, Sanit√§ter A, Defi-Schleife</small>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
        <button type="button" class="btn btn-secondary" onclick="closeMemberModal()">Abbrechen</button>
        <button type="submit" class="btn"><i class="fa-solid fa-save"></i> Speichern</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Personen-Details -->
<div class="modal" id="memberDetailsModal">
  <div class="modal-box">
    <h3 id="memberDetailsTitle">Person</h3>
    <div id="memberDetailsBody"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
      <button class="btn btn-secondary" onclick="closeMemberDetailsModal()">Schlie√üen</button>
    </div>
  </div>
</div>

<!-- Modal: Einzelner Zugang -->
<div class="modal" id="singleAccessModal">
  <div class="modal-box" style="max-width:500px">
    <h3><i class="fa-solid fa-key"></i> Einzelnen Zugang erstellen</h3>
    <form id="singleAccessForm">
      <div class="form-group">
        <label>Name *</label>
        <input type="text" name="name" required>
      </div>
      <div class="form-group">
        <label>E-Mail *</label>
        <input type="email" name="email" required>
      </div>
      <div class="form-group">
        <label>Passwort *</label>
        <input type="password" name="password" minlength="8" required>
      </div>
      <div class="form-group">
        <label>Zugangscode (wird automatisch generiert)</label>
        <div class="access-code-box">
          <div style="color:var(--muted);font-size:.9rem">3-Wort-Code:</div>
          <div class="access-code" id="preview-code">schnell.apfel.laufen</div>
          <button type="button" class="btn btn-sm" onclick="generatePreviewCode()">
            <i class="fas fa-sync"></i> Neu generieren
          </button>
        </div>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
        <button type="button" class="btn btn-secondary" onclick="closeSingleAccessModal()">Abbrechen</button>
        <button type="submit" class="btn"><i class="fa-solid fa-save"></i> Speichern</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Mehrere Zug√§nge -->
<div class="modal" id="bulkAccessModal">
  <div class="modal-box">
    <h3><i class="fa-solid fa-users"></i> Mehrere Zug√§nge erstellen</h3>
    <div class="msg info">
      <i class="fa-solid fa-info-circle"></i> Gib f√ºr jede Person Name und E-Mail ein. Passw√∂rter und Zugangscodes werden automatisch generiert.
    </div>
    <form id="bulkAccessForm">
      <div id="bulkAccessList" style="margin:1rem 0"></div>
      <button type="button" class="btn btn-secondary btn-sm" onclick="addBulkAccessRow()">
        <i class="fas fa-plus"></i> Person hinzuf√ºgen
      </button>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
        <button type="button" class="btn btn-secondary" onclick="closeBulkAccessModal()">Abbrechen</button>
        <button type="submit" class="btn"><i class="fa-solid fa-save"></i> Alle erstellen</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Folien-Editor -->
<div class="modal" id="slideEditorModal">
  <div class="modal-box" style="max-height:90vh;display:flex;flex-direction:column">
    <h3 id="slideEditorTitle">Folien bearbeiten</h3>
    
    <div class="msg info" style="margin-bottom:1rem">
      <i class="fas fa-info-circle"></i> Erstelle interaktive Lernfolien f√ºr dein Modul
    </div>
    
    <div style="margin-bottom:1rem">
      <button class="btn" onclick="openNewSlideModal()">
        <i class="fas fa-plus"></i> Neue Folie
      </button>
    </div>
    
    <div id="slides-list" style="flex:1;overflow-y:auto;margin-bottom:1rem"></div>
    
    <div style="display:flex;gap:.5rem;justify-content:flex-end;padding-top:1rem;border-top:1px solid var(--border)">
      <button class="btn btn-secondary" onclick="closeSlideEditor()">Schlie√üen</button>
      <button class="btn btn-success" onclick="previewCourse()">
        <i class="fas fa-play"></i> Vorschau
      </button>
    </div>
  </div>
</div>

<!-- Modal: Neue Folie -->
<div class="modal" id="newSlideModal">
  <div class="modal-box" style="max-height:85vh;display:flex;flex-direction:column">
    <h3 id="newSlideTitle">Neue Folie</h3>
    
    <div style="flex:1;overflow-y:auto;padding-right:1rem">
      <form id="newSlideForm">
        <div class="form-group">
          <label>Folientyp *</label>
          <select id="slide-type" onchange="updateSlideTypeFields()">
            <option value="text">üìù Text-Folie</option>
            <option value="image">üñºÔ∏è Bild-Folie</option>
            <option value="video">üé• Video-Folie</option>
            <option value="quiz">‚ùì Quiz-Folie</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Titel *</label>
          <input type="text" id="slide-title" placeholder="z.B. Einf√ºhrung" required>
        </div>
        
        <div class="form-group">
          <label>Gesch√§tzte Dauer (Minuten)</label>
          <input type="number" id="slide-duration" value="5" min="1">
        </div>
        
        <!-- Text Slide -->
        <div id="text-slide-fields" class="form-group">
          <label>Inhalt</label>
          <div id="slide-content-editor" style="height:250px"></div>
        </div>
        
        <!-- Image Slide -->
        <div id="image-slide-fields" style="display:none">
          <div class="form-group">
            <label>Bild-URL</label>
            <input type="text" id="slide-image-url" placeholder="https://...">
          </div>
          <div class="form-group">
            <label>Bildbeschreibung</label>
            <textarea id="slide-image-description" rows="3"></textarea>
          </div>
        </div>
        
        <!-- Video Slide -->
        <div id="video-slide-fields" style="display:none">
          <div class="form-group">
            <label>Video-URL (YouTube/Vimeo)</label>
            <input type="text" id="slide-video-url" placeholder="https://www.youtube.com/watch?v=...">
          </div>
          <div class="form-group">
            <label>Video-Beschreibung</label>
            <textarea id="slide-video-description" rows="3"></textarea>
          </div>
        </div>
        
        <!-- Quiz Slide -->
        <div id="quiz-slide-fields" style="display:none">
          <div class="form-group">
            <label>Frage *</label>
            <input type="text" id="slide-quiz-question" placeholder="Frage eingeben">
          </div>
          <div class="form-group">
            <label>Antwortm√∂glichkeiten</label>
            <div id="quiz-answers-list"></div>
            <button type="button" class="btn btn-sm" onclick="addQuizAnswer()">
              <i class="fas fa-plus"></i> Antwort hinzuf√ºgen
            </button>
          </div>
          <div class="form-group">
            <label>Erkl√§rung</label>
            <textarea id="slide-quiz-explanation" rows="2"></textarea>
          </div>
        </div>
      </form>
    </div>
    
    <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:1rem;padding-top:1rem;border-top:1px solid var(--border)">
      <button class="btn btn-secondary" onclick="closeNewSlideModal()">Abbrechen</button>
      <button class="btn" onclick="saveSlide()">
        <i class="fas fa-save"></i> Speichern
      </button>
    </div>
  </div>
</div>

<script type="module">
  // ========================================
  // POCKETBASE & AUTH
  // ========================================
  const pb = new PocketBase('https://api.responda.systems');
  
  if (!pb.authStore.isValid) {
    location.href = "/mpg-login.html";
  }

  const currentUser = pb.authStore.model;
  if (!currentUser || !currentUser.organization_id) {
    location.href = "/mpg-login.html";
  }

  document.getElementById("logout").onclick = () => {
    pb.authStore.clear();
    localStorage.clear();
    location.href = "/mpg-login.html";
  };

  // ========================================
  // STATE
  // ========================================
  let allCourses = [];
  let allSessions = [];
  let allMembers = [];
  let allAccess = [];
  let currentTags = [];
  let selectedParticipants = [];
  let currentEditCourse = null;
  let currentSessionCourse = null;
  let currentSessionId = null;
  let currentLearningCourse = null;
  let previewAccessCode = '';
  let slideContentEditor = null;
  let quizAnswers = [];
  let bulkAccessCount = 3;
  
  const wordLists = {
    adjectives: ['schnell', 'blau', 'gro√ü', 'klein', 'rot', 'gr√ºn', 'gelb', 'hell', 'dunkel', 'stark', 'schwach', 'frisch', 'alt', 'neu', 'warm', 'kalt', 's√º√ü', 'sauer', 'laut', 'leise'],
    nouns: ['apfel', 'baum', 'haus', 'tisch', 'stuhl', 'buch', 'auto', 'berg', 'fluss', 'stern', 'mond', 'sonne', 'blume', 'vogel', 'fisch', 'hund', 'katze', 'pferd', 'wind', 'meer'],
    verbs: ['laufen', 'springen', 'singen', 'tanzen', 'malen', 'lesen', 'schreiben', 'kochen', 'backen', 'spielen', 'denken', 'tr√§umen', 'lachen', 'weinen', 'fliegen', 'schwimmen', 'klettern', 'h√∂ren', 'sehen', 'f√ºhlen']
  };

  // ========================================
  // HELPERS
  // ========================================
  function showMsg(text, type = 'success') {
    const msgDiv = document.getElementById('msg');
    msgDiv.textContent = text;
    msgDiv.className = 'msg ' + type;
    setTimeout(() => { 
      msgDiv.textContent = ''; 
      msgDiv.className = 'msg'; 
    }, 5000);
  }

  function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('de-DE');
  }

  function formatTime(timeStr) {
    if (!timeStr) return '';
    return timeStr.slice(0, 5);
  }

  function copyToClipboard(text) {
    navigator.clipboard.writeText(text);
    showMsg('‚úÖ Kopiert!');
  }

  function generateAccessCode() {
    const adj = wordLists.adjectives[Math.floor(Math.random() * wordLists.adjectives.length)];
    const noun = wordLists.nouns[Math.floor(Math.random() * wordLists.nouns.length)];
    const verb = wordLists.verbs[Math.floor(Math.random() * wordLists.verbs.length)];
    return `${adj}.${noun}.${verb}`;
  }

  function generatePassword() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789';
    let password = '';
    for (let i = 0; i < 12; i++) {
      password += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return password;
  }

  window.generatePreviewCode = () => {
    previewAccessCode = generateAccessCode();
    document.getElementById('preview-code').textContent = previewAccessCode;
  };

  // ========================================
  // TAG INPUT SYSTEM
  // ========================================
  function initTagInput() {
    const wrapper = document.getElementById('tagInputWrapper');
    const input = document.getElementById('tagInput');
    
    if (!input) return;
    
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const tag = input.value.trim();
        if (tag && !currentTags.includes(tag)) {
          currentTags.push(tag);
          renderTags();
          input.value = '';
        }
      } else if (e.key === 'Backspace' && input.value === '' && currentTags.length > 0) {
        currentTags.pop();
        renderTags();
      }
    });
  }

  function renderTags() {
    const wrapper = document.getElementById('tagInputWrapper');
    const input = document.getElementById('tagInput');
    
    if (!wrapper || !input) return;
    
    Array.from(wrapper.children).forEach(child => {
      if (child !== input) child.remove();
    });
    
    currentTags.forEach(tag => {
      const tagEl = document.createElement('span');
      tagEl.className = 'tag';
      tagEl.innerHTML = `${tag} <span class="remove-tag" onclick="removeTag('${tag}')">√ó</span>`;
      wrapper.insertBefore(tagEl, input);
    });
  }

  window.removeTag = (tag) => {
    currentTags = currentTags.filter(t => t !== tag);
    renderTags();
  };

  // ========================================
  // TAB SWITCHING
  // ========================================
  document.querySelectorAll('.tab').forEach(tab => {
    tab.onclick = () => {
      const targetTab = tab.dataset.tab;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = 'none');
      document.getElementById('tab-' + targetTab).style.display = 'block';
      document.getElementById('msg').textContent = '';
      
      // Load data
      if (targetTab === 'schulungen') loadCourses();
      if (targetTab === 'team') loadTeam();
      if (targetTab === 'lernbereich') loadLernbereich();
      if (targetTab === 'settings') loadSettings();
    };
  });

  // Add Button
  document.getElementById('addBtn').onclick = () => {
    const activeTab = document.querySelector('.tab.active').dataset.tab;
    if (activeTab === 'schulungen') {
      openSchulungModal();
    } else if (activeTab === 'team') {
      openMemberModal();
    } else if (activeTab === 'settings') {
      openSingleAccessModal();
    }
  };

  // ========================================
  // LOAD AUSBILDUNGEN
  // ========================================
  async function loadCourses() {
    try {
      allCourses = await pb.collection('training_courses').getFullList({
        filter: `organization_id = "${currentUser.organization_id}"`,
        sort: '-created'
      });
      
      allSessions = await pb.collection('training_sessions').getFullList({
        filter: `organization_id = "${currentUser.organization_id}"`,
        sort: '-date'
      });
      
      renderCourses();
    } catch(e) {
      console.error('Error:', e);
      document.getElementById('schulungenGrid').innerHTML = `<p style="color:#c00;padding:20px">Fehler: ${e.message}</p>`;
    }
  }

  function renderCourses() {
    const grid = document.getElementById('schulungenGrid');
    document.getElementById('schulungen-count').textContent = allCourses.length;
    
    if (allCourses.length === 0) {
      grid.innerHTML = '<p style="padding:20px;color:#999">Noch keine Ausbildungen angelegt</p>';
      return;
    }
    
    grid.innerHTML = allCourses.map(course => {
      const courseSessions = allSessions.filter(s => s.course_id === course.id);
      const nextSession = courseSessions.find(s => new Date(s.date) >= new Date());
      
      return `
        <div class="schulung-card" onclick="viewSchulungDetails('${course.id}')">
          <h3><i class="fa-solid fa-book-medical"></i> ${course.title}</h3>
          <div class="meta">
            <span class="tag">${course.type}</span>
            ${course.instructor ? `<span class="meta-item"><i class="fa-solid fa-chalkboard-user"></i> ${course.instructor}</span>` : ''}
            <span class="meta-item"><i class="fa-solid fa-calendar"></i> ${courseSessions.length} Termin(e)</span>
          </div>
          ${nextSession ? `
            <div style="margin-top:8px;padding:8px;background:#f0fdf4;border-radius:6px;font-size:0.85rem">
              <i class="fa-solid fa-clock"></i> N√§chster Termin: ${formatDate(nextSession.date)}
            </div>
          ` : ''}
        </div>
      `;
    }).join('');
  }

  // ========================================
  // NEUE SCHULUNG
  // ========================================
  window.openSchulungModal = (courseId = null) => {
    currentEditCourse = courseId;
    const form = document.getElementById('schulungForm');
    form.reset();
    
    if (courseId) {
      const course = allCourses.find(c => c.id === courseId);
      if (course) {
        document.getElementById('schulungModalTitle').innerHTML = '<i class="fa-solid fa-edit"></i> Ausbildung bearbeiten';
        form.title.value = course.title;
        form.type.value = course.type;
        form.instructor.value = course.instructor || '';
        form.max_participants.value = course.max_participants || '';
        form.description.value = course.description || '';
      }
    } else {
      document.getElementById('schulungModalTitle').innerHTML = '<i class="fa-solid fa-book-medical"></i> Neue Ausbildung';
    }
    
    document.getElementById('schulungModal').classList.add('show');
  };

  window.closeSchulungModal = () => {
    document.getElementById('schulungModal').classList.remove('show');
    currentEditCourse = null;
  };

  document.getElementById('schulungForm').onsubmit = async (e) => {
    e.preventDefault();
    
    try {
      const formData = new FormData(e.target);
      const data = {
        title: formData.get('title').trim(),
        type: formData.get('type'),
        instructor: formData.get('instructor').trim(),
        max_participants: parseInt(formData.get('max_participants')) || null,
        description: formData.get('description').trim(),
        organization_id: currentUser.organization_id
      };
      
      if (currentEditCourse) {
        await pb.collection('training_courses').update(currentEditCourse, data);
        showMsg('‚úÖ Ausbildung aktualisiert!');
      } else {
        await pb.collection('training_courses').create(data);
        showMsg('‚úÖ Ausbildung erstellt!');
      }
      
      closeSchulungModal();
      await loadCourses();
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  // ========================================
  // SCHULUNGS-DETAILS
  // ========================================
  window.viewSchulungDetails = async (courseId) => {
    try {
      const course = allCourses.find(c => c.id === courseId);
      if (!course) return;
      
      const sessions = allSessions.filter(s => s.course_id === courseId);
      
      document.getElementById('schulungDetailsTitle').innerHTML = 
        `<i class="fa-solid fa-book-medical"></i> ${course.title}`;
      
      let html = `
        <div class="details-section">
          <h4><i class="fa-solid fa-info-circle"></i> Informationen</h4>
          <div style="display:grid;grid-template-columns:150px 1fr;gap:8px">
            <div style="font-weight:700;color:#6b7280">Typ:</div>
            <div><span class="tag">${course.type}</span></div>
            
            ${course.instructor ? `
            <div style="font-weight:700;color:#6b7280">Dozent:</div>
            <div>${course.instructor}</div>
            ` : ''}
            
            ${course.max_participants ? `
            <div style="font-weight:700;color:#6b7280">Max. Teilnehmer:</div>
            <div>${course.max_participants}</div>
            ` : ''}
            
            ${course.description ? `
            <div style="font-weight:700;color:#6b7280">Beschreibung:</div>
            <div>${course.description}</div>
            ` : ''}
          </div>
        </div>
        
        <div class="details-section">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h4 style="margin:0"><i class="fa-solid fa-calendar"></i> Termine (${sessions.length})</h4>
            <button class="btn btn-sm" onclick="openSessionModal('${courseId}')">
              <i class="fas fa-plus"></i> Termin hinzuf√ºgen
            </button>
          </div>
      `;
      
      if (sessions.length > 0) {
        html += '<div style="margin-top:1rem">';
        sessions.forEach(s => {
          html += `
            <div class="slide-item" onclick="viewSessionDetails('${s.id}')" style="cursor:pointer">
              <div style="display:flex;align-items:center;flex:1">
                <div style="flex:1">
                  <div style="font-weight:700">${formatDate(s.date)} ${s.start_time ? `‚Ä¢ ${formatTime(s.start_time)}` : ''}</div>
                  <div style="font-size:0.85rem;color:var(--muted)">${s.location || 'Kein Ort'}</div>
                </div>
              </div>
              <button class="btn btn-sm" onclick="event.stopPropagation(); viewSessionDetails('${s.id}')">
                <i class="fas fa-eye"></i>
              </button>
            </div>
          `;
        });
        html += '</div>';
      } else {
        html += '<p style="color:#999;padding:16px;text-align:center">Noch keine Termine</p>';
      }
      
      html += `
        </div>
        
        <div style="margin-top:16px;display:flex;gap:8px">
          <button class="btn" onclick="openSchulungModal('${courseId}')">
            <i class="fa-solid fa-edit"></i> Bearbeiten
          </button>
          <button class="btn btn-secondary" onclick="deleteSchul('${courseId}')">
            <i class="fa-solid fa-trash"></i> L√∂schen
          </button>
        </div>
      `;
      
      document.getElementById('schulungDetailsBody').innerHTML = html;
      document.getElementById('schulungDetailsModal').classList.add('show');
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.closeSchulungDetailsModal = () => {
    document.getElementById('schulungDetailsModal').classList.remove('show');
  };

  window.deleteSchul = async (courseId) => {
    if (!confirm('Ausbildung wirklich l√∂schen? Alle Termine werden ebenfalls gel√∂scht!')) return;
    
    try {
      // Sessions l√∂schen
      const sessions = allSessions.filter(s => s.course_id === courseId);
      for (const session of sessions) {
        // Participants l√∂schen
        const participants = await pb.collection('training_participants').getFullList({
          filter: `session_id = "${session.id}"`
        });
        for (const p of participants) {
          await pb.collection('training_participants').delete(p.id);
        }
        await pb.collection('training_sessions').delete(session.id);
      }
      
      // Course l√∂schen
      await pb.collection('training_courses').delete(courseId);
      
      showMsg('‚úÖ Ausbildung gel√∂scht!');
      closeSchulungDetailsModal();
      await loadCourses();
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

    // ========================================
  // TERMIN-MANAGEMENT
  // ========================================
  window.openSessionModal = (courseId) => {
    currentSessionCourse = courseId;
    const form = document.getElementById('sessionForm');
    form.reset();
    document.getElementById('session-course-id').value = courseId;
    selectedParticipants = [];
    document.getElementById('selected-count').textContent = '0';
    document.getElementById('sessionModal').classList.add('show');
  };

  window.closeSessionModal = () => {
    document.getElementById('sessionModal').classList.remove('show');
    currentSessionCourse = null;
  };

  document.getElementById('sessionForm').onsubmit = async (e) => {
    e.preventDefault();
    
    try {
      const formData = new FormData(e.target);
      const courseId = formData.get('course_id');
      
      const session = await pb.collection('training_sessions').create({
        course_id: courseId,
        date: formData.get('date'),
        start_time: formData.get('start_time'),
        end_time: formData.get('end_time'),
        location: formData.get('location').trim(),
        status: 'geplant',
        invitations_sent: selectedParticipants.length > 0,
        organization_id: currentUser.organization_id
      });
      
      for (const userId of selectedParticipants) {
        await pb.collection('training_participants').create({
          session_id: session.id,
          user_id: userId,
          status: 'eingeladen',
          attended: false,
          invitation_sent_at: new Date().toISOString(),
          organization_id: currentUser.organization_id
        });
      }
      
      showMsg('‚úÖ Termin erstellt!');
      closeSessionModal();
      await loadCourses();
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.openParticipantSelector = async () => {
    try {
      allMembers = await pb.collection('users').getFullList({
        filter: `organization_id = "${currentUser.organization_id}"`,
        sort: 'name'
      });
      
      const list = document.getElementById('participantList');
      list.innerHTML = allMembers.map(user => `
        <div style="padding:.75rem;border-bottom:1px solid var(--border)">
          <label style="display:flex;align-items:center;gap:.75rem;cursor:pointer">
            <input type="checkbox" ${selectedParticipants.includes(user.id) ? 'checked' : ''} 
              onchange="toggleParticipant('${user.id}')">
            <div>
              <div style="font-weight:700">${user.name || user.email}</div>
              <div style="font-size:.85rem;color:var(--muted)">${user.email}</div>
            </div>
          </label>
        </div>
      `).join('');
      
      document.getElementById('participantModal').classList.add('show');
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.closeParticipantModal = () => {
    document.getElementById('participantModal').classList.remove('show');
    document.getElementById('selected-count').textContent = selectedParticipants.length;
  };

  window.toggleParticipant = (userId) => {
    const idx = selectedParticipants.indexOf(userId);
    if (idx >= 0) {
      selectedParticipants.splice(idx, 1);
    } else {
      selectedParticipants.push(userId);
    }
  };

  window.viewSessionDetails = async (sessionId) => {
    try {
      currentSessionId = sessionId;
      const session = await pb.collection('training_sessions').getOne(sessionId);
      const course = allCourses.find(c => c.id === session.course_id);
      const participants = await pb.collection('training_participants').getFullList({
        filter: `session_id = "${sessionId}"`,
        expand: 'user_id'
      });
      
      document.getElementById('sessionDetailsTitle').textContent = 
        `${course ? course.title : 'Termin'} ‚Ä¢ ${formatDate(session.date)}`;
      
      let html = `
        <div class="details-section">
          <h4><i class="fa-solid fa-info-circle"></i> Termin-Informationen</h4>
          <div style="display:grid;grid-template-columns:150px 1fr;gap:8px">
            <div style="font-weight:700;color:#6b7280">Datum:</div>
            <div>${formatDate(session.date)} ${session.start_time ? `‚Ä¢ ${formatTime(session.start_time)} - ${formatTime(session.end_time)}` : ''}</div>
            
            <div style="font-weight:700;color:#6b7280">Ort:</div>
            <div>${session.location || '-'}</div>
          </div>
        </div>
        
        <div class="details-section">
          <h4><i class="fa-solid fa-users"></i> Anwesenheitsliste (${participants.length})</h4>
      `;
      
      if (participants.length > 0) {
        const anwesendCount = participants.filter(p => p.attended).length;
        
        html += `
          <div style="display:flex;gap:20px;margin:1rem 0;padding:12px;background:#f0fdf4;border-radius:8px">
            <div style="text-align:center;flex:1">
              <div style="font-size:1.5rem;font-weight:800;color:#065f46">${anwesendCount}</div>
              <div style="font-size:0.85rem;color:#065f46">Anwesend</div>
            </div>
            <div style="text-align:center;flex:1">
              <div style="font-size:1.5rem;font-weight:800;color:#991b1b">${participants.length - anwesendCount}</div>
              <div style="font-size:0.85rem;color:#991b1b">Abwesend</div>
            </div>
          </div>
          
          <table class="attendance-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Name</th>
                <th>Status</th>
                <th style="text-align:center">Anwesend</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        participants.forEach((p, idx) => {
          const user = p.expand?.user_id;
          html += `
            <tr>
              <td>${idx + 1}</td>
              <td style="font-weight:700">${user ? (user.name || user.email) : 'Unbekannt'}</td>
              <td><span class="status-badge ${p.attended ? 'anwesend' : 'abwesend'}">${p.attended ? 'Anwesend' : 'Abwesend'}</span></td>
              <td style="text-align:center">
                <input 
                  type="checkbox" 
                  id="att_${p.id}" 
                  data-participant-id="${p.id}"
                  ${p.attended ? 'checked' : ''}
                  style="width:20px;height:20px;cursor:pointer"
                >
              </td>
            </tr>
          `;
        });
        
        html += '</tbody></table>';
      } else {
        html += '<p style="color:#999;padding:16px;text-align:center">Keine Teilnehmer</p>';
      }
      
      html += '</div>';
      
      document.getElementById('sessionDetailsBody').innerHTML = html;
      document.getElementById('sessionDetailsModal').classList.add('show');
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.closeSessionDetailsModal = () => {
    document.getElementById('sessionDetailsModal').classList.remove('show');
    currentSessionId = null;
  };

  window.saveAttendance = async () => {
    try {
      if (!currentSessionId) return;
      
      const checkboxes = document.querySelectorAll('[data-participant-id]');
      
      for (const checkbox of checkboxes) {
        const participantId = checkbox.dataset.participantId;
        const attended = checkbox.checked;
        
        await pb.collection('training_participants').update(participantId, {
          attended,
          status: attended ? 'teilgenommen' : 'nicht_erschienen'
        });
      }
      
      showMsg('‚úÖ Anwesenheit gespeichert!');
      await viewSessionDetails(currentSessionId);
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  // ========================================
  // TEAM-MANAGEMENT
  // ========================================
  async function loadTeam() {
    try {
      allMembers = await pb.collection('users').getFullList({
        filter: `organization_id = "${currentUser.organization_id}"`,
        sort: 'name'
      });
      
      renderTeam();
    } catch(e) {
      console.error('Error:', e);
      document.getElementById('teamGrid').innerHTML = `<p style="color:#c00;padding:20px">Fehler: ${e.message}</p>`;
    }
  }

  function renderTeam() {
    const grid = document.getElementById('teamGrid');
    document.getElementById('team-count').textContent = allMembers.length;
    
    if (allMembers.length === 0) {
      grid.innerHTML = '<p style="padding:20px;color:#999">Noch keine Team-Mitglieder</p>';
      return;
    }
    
    grid.innerHTML = allMembers.map(member => {
      const tags = member.tags || [];
      const tagsHTML = tags.map(t => `<span class="tag">${t}</span>`).join('');
      
      return `
        <div class="member-card" onclick="viewMemberDetails('${member.id}')">
          <h3><i class="fa-solid fa-user"></i> ${member.name || member.email}</h3>
          <div style="font-size:0.85rem;color:var(--muted);margin-bottom:8px">${member.email}</div>
          <div class="tags">
            ${tagsHTML || '<span class="tag" style="background:#eee;color:#999">Keine Qualifikationen</span>'}
          </div>
        </div>
      `;
    }).join('');
  }

  window.openMemberModal = (memberId = null) => {
    const form = document.getElementById('memberForm');
    form.reset();
    currentTags = [];
    
    if (memberId) {
      const member = allMembers.find(m => m.id === memberId);
      if (member) {
        document.getElementById('memberModalTitle').innerHTML = '<i class="fa-solid fa-user-edit"></i> Person bearbeiten';
        form.name.value = member.name || '';
        form.email.value = member.email;
        form.password.removeAttribute('required');
        currentTags = member.tags || [];
        renderTags();
      }
    } else {
      document.getElementById('memberModalTitle').innerHTML = '<i class="fa-solid fa-user-plus"></i> Neue Person';
      form.password.setAttribute('required', 'required');
    }
    
    document.getElementById('memberModal').classList.add('show');
    setTimeout(() => initTagInput(), 100);
  };

  window.closeMemberModal = () => {
    document.getElementById('memberModal').classList.remove('show');
    currentTags = [];
  };

  document.getElementById('memberForm').onsubmit = async (e) => {
    e.preventDefault();
    
    try {
      const formData = new FormData(e.target);
      const data = {
        name: formData.get('name').trim(),
        email: formData.get('email').trim(),
        tags: currentTags,
        organization_id: currentUser.organization_id
      };
      
      const password = formData.get('password');
      if (password) {
        data.password = password;
        data.passwordConfirm = password;
      }
      
      await pb.collection('users').create(data);
      
      showMsg('‚úÖ Person erstellt!');
      closeMemberModal();
      await loadTeam();
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.viewMemberDetails = async (memberId) => {
    try {
      const member = await pb.collection('users').getOne(memberId);
      const participations = await pb.collection('training_participants').getFullList({
        filter: `user_id = "${memberId}"`,
        expand: 'session_id',
        sort: '-created'
      });
      
      const tags = member.tags || [];
      const tagsHTML = tags.map(t => `<span class="tag">${t}</span>`).join('') || 
        '<span class="tag" style="background:#eee;color:#999">Keine Qualifikationen</span>';
      
      document.getElementById('memberDetailsTitle').innerHTML = 
        `<i class="fa-solid fa-user"></i> ${member.name || member.email}`;
      
      let html = `
        <div class="details-section">
          <h4><i class="fa-solid fa-id-badge"></i> Informationen</h4>
          <div style="display:grid;grid-template-columns:150px 1fr;gap:8px">
            <div style="font-weight:700;color:#6b7280">E-Mail:</div>
            <div>${member.email}</div>
            
            <div style="font-weight:700;color:#6b7280">Qualifikationen:</div>
            <div class="tags">${tagsHTML}</div>
          </div>
        </div>
        
        <div class="details-section">
          <h4><i class="fa-solid fa-clock-rotate-left"></i> Teilnahmehistorie (${participations.length})</h4>
      `;
      
      if (participations.length > 0) {
        const attended = participations.filter(p => p.attended).length;
        const percentage = Math.round(attended / participations.length * 100);
        
        html += `
          <div style="display:flex;gap:20px;margin:1rem 0">
            <div style="text-align:center;flex:1;padding:12px;background:#f0fdf4;border-radius:8px">
              <div style="font-size:1.5rem;font-weight:800;color:#065f46">${attended}</div>
              <div style="font-size:0.85rem;color:#065f46">Anwesend</div>
            </div>
            <div style="text-align:center;flex:1;padding:12px;background:#fee2e2;border-radius:8px">
              <div style="font-size:1.5rem;font-weight:800;color:#991b1b">${participations.length - attended}</div>
              <div style="font-size:0.85rem;color:#991b1b">Abwesend</div>
            </div>
            <div style="text-align:center;flex:1;padding:12px;background:#f3f4f6;border-radius:8px">
              <div style="font-size:1.5rem;font-weight:800;color:#374151">${percentage}%</div>
              <div style="font-size:0.85rem;color:#374151">Quote</div>
            </div>
          </div>
          
          <table class="attendance-table">
            <thead>
              <tr>
                <th>Datum</th>
                <th>Kurs</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        participations.forEach(p => {
          const session = p.expand?.session_id;
          const course = session ? allCourses.find(c => c.id === session.course_id) : null;
          
          html += `
            <tr>
              <td>${session ? formatDate(session.date) : '-'}</td>
              <td style="font-weight:700">${course ? course.title : 'Unbekannt'}</td>
              <td><span class="status-badge ${p.attended ? 'anwesend' : 'abwesend'}">${p.attended ? 'Anwesend' : 'Abwesend'}</span></td>
            </tr>
          `;
        });
        
        html += '</tbody></table>';
      } else {
        html += '<p style="color:#999;padding:16px;text-align:center">Noch keine Teilnahmen</p>';
      }
      
      html += `
        </div>
        
        <div style="margin-top:16px;display:flex;gap:8px">
          <button class="btn btn-secondary" onclick="deleteMember('${memberId}')">
            <i class="fa-solid fa-trash"></i> L√∂schen
          </button>
        </div>
      `;
      
      document.getElementById('memberDetailsBody').innerHTML = html;
      document.getElementById('memberDetailsModal').classList.add('show');
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.closeMemberDetailsModal = () => {
    document.getElementById('memberDetailsModal').classList.remove('show');
  };

  window.deleteMember = async (memberId) => {
    if (!confirm('Person wirklich l√∂schen?')) return;
    
    try {
      // Participants l√∂schen
      const participants = await pb.collection('training_participants').getFullList({
        filter: `user_id = "${memberId}"`
      });
      for (const p of participants) {
        await pb.collection('training_participants').delete(p.id);
      }
      
      await pb.collection('users').delete(memberId);
      
      showMsg('‚úÖ Person gel√∂scht!');
      closeMemberDetailsModal();
      await loadTeam();
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  // ========================================
  // ZUG√ÑNGE - EINZELN
  // ========================================
  window.openSingleAccessModal = () => {
    document.getElementById('singleAccessForm').reset();
    generatePreviewCode();
    document.getElementById('singleAccessModal').classList.add('show');
  };

  window.closeSingleAccessModal = () => {
    document.getElementById('singleAccessModal').classList.remove('show');
  };

  document.getElementById('singleAccessForm').onsubmit = async (e) => {
    e.preventDefault();
    
    try {
      const formData = new FormData(e.target);
      const password = formData.get('password');
      
      await pb.collection('training_students').create({
        name: formData.get('name').trim(),
        email: formData.get('email').trim(),
        password,
        passwordConfirm: password,
        access_code: previewAccessCode,
        organization_id: currentUser.organization_id
      });
      
      showMsg(`‚úÖ Zugang erstellt! Code: ${previewAccessCode}`);
      closeSingleAccessModal();
      await loadSettings();
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  // ========================================
  // ZUG√ÑNGE - BULK
  // ========================================
  window.openBulkAccessModal = () => {
    bulkAccessCount = 3;
    renderBulkAccessRows();
    document.getElementById('bulkAccessModal').classList.add('show');
  };

  window.closeBulkAccessModal = () => {
    document.getElementById('bulkAccessModal').classList.remove('show');
  };

  window.addBulkAccessRow = () => {
    bulkAccessCount++;
    renderBulkAccessRows();
  };

  function renderBulkAccessRows() {
    const list = document.getElementById('bulkAccessList');
    let html = '';
    
    for (let i = 0; i < bulkAccessCount; i++) {
      html += `
        <div style="display:grid;grid-template-columns:1fr 1fr auto;gap:8px;margin-bottom:8px;padding:12px;background:#f9fafb;border-radius:8px">
          <input type="text" placeholder="Name" data-bulk-name="${i}" style="padding:8px;border:1px solid #d1d5db;border-radius:6px">
          <input type="email" placeholder="E-Mail" data-bulk-email="${i}" style="padding:8px;border:1px solid #d1d5db;border-radius:6px">
          <button type="button" class="btn btn-secondary btn-sm" onclick="removeBulkAccessRow(${i})" style="padding:8px 12px">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
    }
    
    list.innerHTML = html;
  }

  window.removeBulkAccessRow = (index) => {
    bulkAccessCount--;
    renderBulkAccessRows();
  };

  document.getElementById('bulkAccessForm').onsubmit = async (e) => {
    e.preventDefault();
    
    try {
      const names = Array.from(document.querySelectorAll('[data-bulk-name]'));
      const emails = Array.from(document.querySelectorAll('[data-bulk-email]'));
      
      let created = 0;
      const createdCodes = [];
      
      for (let i = 0; i < names.length; i++) {
        const name = names[i].value.trim();
        const email = emails[i].value.trim();
        
        if (name && email) {
          const password = generatePassword();
          const code = generateAccessCode();
          
          await pb.collection('training_students').create({
            name,
            email,
            password,
            passwordConfirm: password,
            access_code: code,
            organization_id: currentUser.organization_id
          });
          
          createdCodes.push({ name, email, code, password });
          created++;
        }
      }
      
      showMsg(`‚úÖ ${created} Zug√§nge erstellt!`);
      closeBulkAccessModal();
      await loadSettings();
      
      // Codes anzeigen zum Kopieren
      if (createdCodes.length > 0) {
        let msg = 'Erstellte Zug√§nge:\n\n';
        createdCodes.forEach(c => {
          msg += `${c.name} (${c.email})\nCode: ${c.code}\nPasswort: ${c.password}\n\n`;
        });
        alert(msg);
      }
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  // ========================================
  // ZUG√ÑNGE - LADEN & EXPORT
  // ========================================
  async function loadSettings() {
    try {
      allAccess = await pb.collection('training_students').getFullList({
        filter: `organization_id = "${currentUser.organization_id}"`,
        sort: 'name'
      });
      
      renderSettings();
    } catch(e) {
      console.error('Error:', e);
      document.getElementById('access-list').innerHTML = `<p style="color:#c00;padding:20px">Fehler: ${e.message}</p>`;
    }
  }

  function renderSettings() {
    const list = document.getElementById('access-list');
    
    if (allAccess.length === 0) {
      list.innerHTML = '<p style="padding:20px;color:#999">Noch keine Zug√§nge erstellt</p>';
      return;
    }
    
    list.innerHTML = `
      <table class="attendance-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>E-Mail</th>
            <th>Zugangscode</th>
            <th>Aktionen</th>
          </tr>
        </thead>
        <tbody>
    `;
    
    allAccess.forEach(access => {
      list.innerHTML += `
        <tr>
          <td style="font-weight:700">${access.name}</td>
          <td>${access.email}</td>
          <td>
            <div class="copy-box" style="display:inline-flex;width:auto">
              <span style="font-weight:700;color:var(--primary)">${access.access_code}</span>
              <button class="btn btn-sm" onclick="copyToClipboard('${access.access_code}')">
                <i class="fas fa-copy"></i>
              </button>
            </div>
          </td>
          <td>
            <button class="btn btn-secondary btn-sm" onclick="deleteAccess('${access.id}')">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
      `;
    });
    
    list.innerHTML += '</tbody></table>';
  }

  window.deleteAccess = async (accessId) => {
    if (!confirm('Zugang wirklich l√∂schen?')) return;
    
    try {
      await pb.collection('training_students').delete(accessId);
      showMsg('‚úÖ Zugang gel√∂scht!');
      await loadSettings();
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.exportAccessCodes = () => {
    if (allAccess.length === 0) {
      showMsg('Keine Zug√§nge zum Exportieren', 'error');
      return;
    }
    
    let csv = 'Name,E-Mail,Zugangscode\n';
    allAccess.forEach(access => {
      csv += `"${access.name}","${access.email}","${access.access_code}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `zugaenge_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    
    showMsg('‚úÖ CSV exportiert!');
  };

  // ========================================
  // LERNBEREICH
  // ========================================
  async function loadLernbereich() {
    const grid = document.getElementById('lernbereichGrid');
    
    const onlineCourses = allCourses.filter(c => c.type === 'online' || c.type === 'hybrid');
    
    if (onlineCourses.length === 0) {
      grid.innerHTML = '<p style="padding:20px;color:#999">Erstelle einen Online- oder Hybrid-Kurs bei Ausbildungen</p>';
      return;
    }
    
    try {
      let html = '';
      
      for (const course of onlineCourses) {
        const slides = await pb.collection('learning_slides').getFullList({
          filter: `course_id = "${course.id}"`,
          sort: 'order'
        }).catch(() => []);
        
        const totalDuration = slides.reduce((sum, s) => sum + (s.duration || 0), 0);
        
        html += `
          <div class="schulung-card" onclick="openSlideEditor('${course.id}')">
            <h3><i class="fa-solid fa-laptop"></i> ${course.title}</h3>
            <div class="meta">
              <span class="tag">${course.type}</span>
              <span class="meta-item"><i class="fa-solid fa-layer-group"></i> ${slides.length} Folien</span>
              <span class="meta-item"><i class="fa-solid fa-clock"></i> ${totalDuration} Min.</span>
            </div>
            <div style="margin-top:12px;display:flex;gap:8px">
              <button class="btn btn-sm" onclick="event.stopPropagation(); openSlideEditor('${course.id}')">
                <i class="fas fa-edit"></i> Folien bearbeiten
              </button>
              <button class="btn btn-success btn-sm" onclick="event.stopPropagation(); previewCourse('${course.id}')">
                <i class="fas fa-play"></i> Vorschau
              </button>
            </div>
          </div>
        `;
      }
      
      grid.innerHTML = html;
    } catch(e) {
      console.error('Error:', e);
      grid.innerHTML = `<p style="color:#c00;padding:20px">Fehler: ${e.message}</p>`;
    }
  }

  // ========================================
  // FOLIEN-EDITOR
  // ========================================
  window.openSlideEditor = async (courseId) => {
    currentLearningCourse = courseId;
    const course = allCourses.find(c => c.id === courseId);
    
    document.getElementById('slideEditorTitle').textContent = 
      `Folien bearbeiten: ${course ? course.title : ''}`;
    
    try {
      const slides = await pb.collection('learning_slides').getFullList({
        filter: `course_id = "${courseId}"`,
        sort: 'order'
      });
      
      renderSlidesList(slides);
      document.getElementById('slideEditorModal').classList.add('show');
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.closeSlideEditor = () => {
    document.getElementById('slideEditorModal').classList.remove('show');
    loadLernbereich();
  };

  function renderSlidesList(slides) {
    const list = document.getElementById('slides-list');
    
    if (slides.length === 0) {
      list.innerHTML = '<p style="padding:20px;color:#999;text-align:center">Noch keine Folien. Erstelle deine erste Folie!</p>';
      return;
    }
    
    const typeIcons = {
      text: 'fa-file-lines',
      image: 'fa-image',
      video: 'fa-video',
      quiz: 'fa-question-circle'
    };
    
    list.innerHTML = slides.map((slide, idx) => `
      <div class="slide-item">
        <div style="display:flex;align-items:center;flex:1">
          <div class="slide-type-icon ${slide.type}">
            <i class="fas ${typeIcons[slide.type] || 'fa-file'}"></i>
          </div>
          <div style="flex:1">
            <div style="font-weight:700">${idx + 1}. ${slide.title}</div>
            <div style="font-size:0.85rem;color:var(--muted)">${slide.type} ‚Ä¢ ${slide.duration || 5} Min.</div>
          </div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-secondary btn-sm" onclick="deleteSlide('${slide.id}')">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
    `).join('');
  }

  window.openNewSlideModal = () => {
    document.getElementById('newSlideForm').reset();
    document.getElementById('slide-type').value = 'text';
    quizAnswers = [];
    
    if (!slideContentEditor) {
      slideContentEditor = new Quill('#slide-content-editor', {
        theme: 'snow',
        modules: {
          toolbar: [
            [{ 'header': [2, 3, false] }],
            ['bold', 'italic', 'underline'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            ['link', 'image'],
            ['clean']
          ]
        }
      });
    }
    
    slideContentEditor.root.innerHTML = '<h2>√úberschrift</h2><p>Dein Inhalt hier...</p>';
    updateSlideTypeFields();
    
    document.getElementById('newSlideModal').classList.add('show');
  };

  window.closeNewSlideModal = () => {
    document.getElementById('newSlideModal').classList.remove('show');
  };

  window.updateSlideTypeFields = () => {
    const type = document.getElementById('slide-type').value;
    
    document.getElementById('text-slide-fields').style.display = 'none';
    document.getElementById('image-slide-fields').style.display = 'none';
    document.getElementById('video-slide-fields').style.display = 'none';
    document.getElementById('quiz-slide-fields').style.display = 'none';
    
    if (type === 'text') {
      document.getElementById('text-slide-fields').style.display = 'block';
    } else if (type === 'image') {
      document.getElementById('image-slide-fields').style.display = 'block';
    } else if (type === 'video') {
      document.getElementById('video-slide-fields').style.display = 'block';
    } else if (type === 'quiz') {
      document.getElementById('quiz-slide-fields').style.display = 'block';
      renderQuizAnswers();
    }
  };

  function renderQuizAnswers() {
    const list = document.getElementById('quiz-answers-list');
    
    if (quizAnswers.length === 0) {
      list.innerHTML = '<p style="color:#999;font-size:0.85rem;padding:0.5rem">Keine Antworten. F√ºge mindestens 2 hinzu.</p>';
      return;
    }
    
    list.innerHTML = quizAnswers.map((answer, idx) => `
      <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
        <input type="checkbox" ${answer.correct ? 'checked' : ''} 
          onchange="toggleQuizAnswerCorrect(${idx})">
        <input type="text" value="${answer.text}" 
          onchange="updateQuizAnswerText(${idx}, this.value)"
          placeholder="Antwort ${idx + 1}"
          style="flex:1;padding:8px;border:1px solid #d1d5db;border-radius:6px">
        <button type="button" class="btn btn-secondary btn-sm" onclick="removeQuizAnswer(${idx})">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    `).join('');
  }

  window.addQuizAnswer = () => {
    quizAnswers.push({ text: '', correct: false });
    renderQuizAnswers();
  };

  window.removeQuizAnswer = (idx) => {
    quizAnswers.splice(idx, 1);
    renderQuizAnswers();
  };

  window.toggleQuizAnswerCorrect = (idx) => {
    quizAnswers[idx].correct = !quizAnswers[idx].correct;
  };

  window.updateQuizAnswerText = (idx, text) => {
    quizAnswers[idx].text = text;
  };

  window.saveSlide = async () => {
    const title = document.getElementById('slide-title').value.trim();
    const type = document.getElementById('slide-type').value;
    
    if (!title) {
      showMsg('Bitte Titel eingeben', 'error');
      return;
    }
    
    let content = {};
    
    if (type === 'text') {
      content.html = slideContentEditor.root.innerHTML;
    } else if (type === 'image') {
      content.url = document.getElementById('slide-image-url').value.trim();
      content.description = document.getElementById('slide-image-description').value.trim();
    } else if (type === 'video') {
      content.url = document.getElementById('slide-video-url').value.trim();
      content.description = document.getElementById('slide-video-description').value.trim();
    } else if (type === 'quiz') {
      const question = document.getElementById('slide-quiz-question').value.trim();
      if (!question || quizAnswers.length < 2) {
        showMsg('Bitte Frage und mindestens 2 Antworten eingeben', 'error');
        return;
      }
      content.question = question;
      content.answers = quizAnswers;
      content.explanation = document.getElementById('slide-quiz-explanation').value.trim();
    }
    
    try {
      const slides = await pb.collection('learning_slides').getFullList({
        filter: `course_id = "${currentLearningCourse}"`,
        sort: '-order'
      });
      
      const maxOrder = slides.length > 0 ? slides[0].order : 0;
      
      await pb.collection('learning_slides').create({
        course_id: currentLearningCourse,
        type,
        title,
        content,
        duration: parseInt(document.getElementById('slide-duration').value) || 5,
        order: maxOrder + 1,
        organization_id: currentUser.organization_id
      });
      
      showMsg('‚úÖ Folie erstellt!');
      closeNewSlideModal();
      
      const updatedSlides = await pb.collection('learning_slides').getFullList({
        filter: `course_id = "${currentLearningCourse}"`,
        sort: 'order'
      });
      renderSlidesList(updatedSlides);
      
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.deleteSlide = async (slideId) => {
    if (!confirm('Folie wirklich l√∂schen?')) return;
    
    try {
      await pb.collection('learning_slides').delete(slideId);
      showMsg('‚úÖ Folie gel√∂scht!');
      
      const slides = await pb.collection('learning_slides').getFullList({
        filter: `course_id = "${currentLearningCourse}"`,
        sort: 'order'
      });
      renderSlidesList(slides);
    } catch(e) {
      showMsg('Fehler: ' + e.message, 'error');
    }
  };

  window.previewCourse = (courseId) => {
    window.open(`/ausbildungen-player.html?course=${courseId || currentLearningCourse}`, '_blank');
  };

  // ========================================
  // MODAL CLOSE ON OUTSIDE CLICK
  // ========================================
  document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.remove('show');
      }
    });
  });

  // ========================================
  // INITIAL LOAD
  // ========================================
  await loadCourses();
  generatePreviewCode();

</script>
</body>
</html>
