<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Produktausgabe ‚Äì Responda</title>
  
  <!-- Theme Color -->
  <meta name="theme-color" content="#667eea">
  
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root { --rot: #c8102e; --gradient-start: #667eea; --gradient-end: #764ba2; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body { 
      font-family: 'Atkinson Hyperlegible', Arial, sans-serif;
      background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
      min-height: 100vh;
      margin: 0;
    }
    
    /* Header ganz oben */
    header { 
      background: var(--gradient-start);
      color: #fff;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 { margin: 0; font-size: 1.2rem; font-weight: 700; }
    .spacer { flex: 1; }
    .back-btn { 
      color: #fff;
      text-decoration: none;
      background: rgba(255,255,255,0.2);
      padding: 7px 12px;
      border-radius: 8px;
      font-weight: 700;
      transition: all 0.2s;
    }
    .back-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .wrap { 
      max-width: 820px;
      margin: 16px auto;
      padding: 0 12px;
    }
    
    .card { 
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 3px 12px rgba(0,0,0,.06);
      padding: 14px;
      margin-bottom: 14px;
    }
    
    h2 { color: var(--rot); margin: 6px 0 12px; }
    
    label { 
      color: var(--rot);
      font-weight: 700;
      margin-top: 8px;
      display: block;
    }
    
    input { 
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 10px;
      background: #fafafa;
      font-size: 1rem;
      font-family: inherit;
    }
    
    .row { display: flex; gap: 10px; flex-wrap: wrap; }
    
    .btn { 
      background: var(--rot);
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 10px 16px;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
    }
    .btn:hover {
      background: #a00d26;
      transform: translateY(-2px);
    }
    .btn:disabled {
      background: #cbd5e1;
      cursor: not-allowed;
      transform: none;
    }
    .btn.ghost { 
      background: #eee;
      color: #c8102e;
      border: 1px solid #c8102e;
    }
    
    .pos-row { 
      display: flex;
      gap: 10px;
      align-items: center;
      margin: 8px 0;
    }
    .pos-qty { width: 120px; }
    .pos-name { flex: 1; }
    .pos-del { 
      width: 52px;
      height: 42px;
      border-radius: 10px;
      border: 1px solid #f1c7cf;
      background: #fff5f7;
      color: #c8102e;
      font-weight: 700;
      cursor: pointer;
    }
    
    .hint { color: #6b7280; font-size: .95rem; }
    
    .msg { 
      border-radius: 12px;
      padding: 12px;
      background: #fff5f5;
      border: 1px solid #f2c9d1;
      color: #b00020;
      min-height: 1.2em;
    }
    .ok { 
      background: #eef9f0;
      border-color: #cfead6;
      color: #256029;
    }
    
    .error-box {
      background: #fee2e2;
      color: #991b1b;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      font-weight: 600;
      border: 2px solid #fca5a5;
    }
    
    @media (max-width: 600px) {
      .pos-row { flex-wrap: wrap; }
      .pos-qty, .pos-name { width: 100%; }
    }
  </style>
</head>
<body>

<header>
  <h1 id="pageTitle">üì¶ Produktausgabe</h1>
  <div class="spacer"></div>
  <a href="#" class="back-btn" id="backBtn">‚Üê Zur√ºck</a>
</header>

<div class="wrap">
  <!-- Fehler bei ung√ºltiger Organisation -->
  <div id="errorBox" class="card error-box" style="display:none">
    ‚ùå Ung√ºltige Organisation
  </div>

  <div id="formContainer" style="display:none">
    <!-- Kopf -->
    <section class="card">
      <h2>Kopfdaten</h2>
      <div class="row">
        <div style="flex:1;min-width:220px">
          <label for="einsatz">Einsatznummer</label>
          <input id="einsatz" placeholder="z. B. 2025-001" />
        </div>
        <div style="flex:1;min-width:220px">
          <label for="datum">Datum</label>
          <input id="datum" type="date" />
        </div>
      </div>
    </section>

    <!-- Positionen -->
    <section class="card">
      <h2>Positionen</h2>
      <div id="posList"></div>
      <button id="addPos" class="btn" type="button">+ Position</button>
      <p class="hint">Tipp: Mit ‚Äû+ Position" beliebig viele Zeilen erg√§nzen.</p>
    </section>

    <!-- Ausgetragen von -->
    <section class="card">
      <h2>Ausgetragen von</h2>
      <div class="row">
        <div style="flex:1;min-width:220px">
          <label for="vor">Vorname</label>
          <input id="vor" />
        </div>
        <div style="flex:1;min-width:220px">
          <label for="nach">Nachname</label>
          <input id="nach" />
        </div>
      </div>
    </section>

    <!-- Absenden -->
    <section class="card">
      <button id="saveBtn" class="btn" type="button">Ausgabe speichern</button>
      <div id="msg" class="msg" style="margin-top:10px"></div>
    </section>
  </div>
</div>

<script type="module">
  import { NhostClient } from "https://esm.sh/@nhost/nhost-js@2.2.9";

  // ===== ORGANISATIONS-MAPPING =====
  const ORG_MAPPING = {
    'ffwrothenburg': {
      name: 'FFW Rothenburg',
      subdomain: 'hpjfrhktprpuuxvvlpsb',
      region: 'eu-central-1'
    },
    'beispielorg': {
      name: 'Beispiel Organisation',
      subdomain: 'example-subdomain',
      region: 'eu-central-1'
    }
    // Weitere Organisationen hier hinzuf√ºgen...
  };

  // Organisation aus URL lesen
  const urlParams = new URLSearchParams(window.location.search);
  const orgCode = urlParams.get('org');
  
  const errorBoxEl = document.getElementById('errorBox');
  const formContainerEl = document.getElementById('formContainer');
  const pageTitleEl = document.getElementById('pageTitle');
  const backBtn = document.getElementById('backBtn');

  // Organisation validieren
  if (!orgCode || !ORG_MAPPING[orgCode]) {
    errorBoxEl.style.display = 'block';
    throw new Error('Ung√ºltige Organisation');
  }

  const org = ORG_MAPPING[orgCode];
  pageTitleEl.textContent = `üì¶ Produktausgabe ‚Äì ${org.name}`;
  backBtn.href = `formulare.html?org=${orgCode}`;
  formContainerEl.style.display = 'block';

  // Nhost initialisieren
  const nhost = new NhostClient({
    subdomain: org.subdomain,
    region: org.region
  });

  /* -------------------- UI Helfer ------------------------ */
  const byId = id => document.getElementById(id);
  const msgEl = byId('msg');
  
  function showMsg(text, ok=false){
    msgEl.textContent = text;
    msgEl.className = 'msg ' + (ok ? 'ok' : '');
  }

  /* -------------------- Positionen UI -------------------- */
  const posList = byId('posList');
  byId('addPos').addEventListener('click', () => addPosRow());

  function addPosRow(qty=1, name=''){
    const row = document.createElement('div');
    row.className = 'pos-row';
    row.innerHTML = `
      <input class="pos-qty" type="number" min="1" value="${qty}">
      <input class="pos-name" placeholder="Artikel / Beschreibung" value="${name}">
      <button class="pos-del" type="button">√ó</button>
    `;
    row.querySelector('.pos-del').addEventListener('click', ()=> row.remove());
    posList.appendChild(row);
  }

  function readPositions(){
    const rows = [...posList.querySelectorAll('.pos-row')];
    const list = [];
    for(const r of rows){
      const q = parseInt(r.querySelector('.pos-qty').value || '0', 10);
      const n = (r.querySelector('.pos-name').value || '').trim();
      if (q>0 && n) list.push({ qty:q, name:n });
    }
    return list;
  }

  /* -------------------- Datum vorbelegen ----------------- */
  (function init(){
    const d = new Date();
    const pad = n => String(n).padStart(2,'0');
    byId('datum').value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    addPosRow();
  })();

  /* -------------------- Speichern ------------------------ */
  byId('saveBtn').addEventListener('click', saveAusgabe);

  async function saveAusgabe(){
    try{
      showMsg('Speichere ‚Ä¶', true);
      byId('saveBtn').disabled = true;

      const einsatz = (byId('einsatz').value || '').trim();
      const isoDate = byId('datum').value; // YYYY-MM-DD
      const pos = readPositions();
      const vor = (byId('vor').value || '').trim();
      const nach = (byId('nach').value || '').trim();

      if (!einsatz || !isoDate || !pos.length || !vor || !nach){
        showMsg('Bitte Einsatznummer, Datum, mindestens eine Position sowie Vor- und Nachname angeben.');
        byId('saveBtn').disabled = false;
        return;
      }

      // Titel & Payload
      const deDate = isoDate.split('-').reverse().join('.'); // DD.MM.YYYY
      const title = `Produktausgabe ${einsatz} (${deDate})`;
      const payload = {
        einsatznummer: einsatz,
        datum: isoDate,
        positionen: pos,
        ausgetragen_vorname: vor,
        ausgetragen_nachname: nach
      };

      // GraphQL Mutation
      const { data, error } = await nhost.graphql.request(`
        mutation InsertDocuments($obj: documents_insert_input!) {
          insert_documents_one(object: $obj) { id created_at }
        }
      `, {
        obj: { type: 'produktausgabe', title, status: 'offen', payload }
      });

      if (error) {
        throw new Error(error.message || 'GraphQL-Fehler');
      }

      showMsg('‚úÖ Ausgabe gespeichert!', true);

      // Formular zur√ºcksetzen
      setTimeout(() => {
        byId('einsatz').value = '';
        byId('vor').value = '';
        byId('nach').value = '';
        posList.innerHTML = '';
        addPosRow();
        showMsg('');
        byId('saveBtn').disabled = false;
      }, 2000);

    }catch(err){
      showMsg('Fehler: ' + (err.message || String(err)));
      byId('saveBtn').disabled = false;
    }
  }
</script>

</body>
</html>
