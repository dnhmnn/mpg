<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dateien ‚Äì Responda</title>
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/pocketbase@0.21.3/dist/pocketbase.umd.js"></script>

  <style>
    :root{
      --primary:#c8102e;
      --primary-light:#fee2e2;
      --success:#16a34a;
      --bg:#f8fafc;
      --card:#fff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --gradient-start:#667eea;
      --gradient-end:#764ba2;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
      min-height:100vh;
      color:var(--text);
      font-family:'Atkinson Hyperlegible',-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      line-height:1.45;
      opacity:0;
      transition:opacity 0.3s;
    }
    body.loaded{opacity:1}
    
    header{position:sticky;top:0;background:var(--gradient-start);color:#fff;z-index:10;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    .bar{
      max-width:1400px;
      margin:0 auto;
      padding:.75rem 1rem;
      display:flex;
      gap:.5rem;
      align-items:center;
      flex-wrap:wrap;
    }
    h1{font-size:1.05rem;margin:0;font-weight:800}
    .toolbar{margin-left:auto;display:flex;gap:.5rem;flex-wrap:wrap}
    .topbtn{
      background:rgba(255,255,255,0.1);
      color:#fff;
      padding:.45rem .7rem;
      border-radius:.5rem;
      cursor:pointer;
      font-weight:700;
      font-size:.9rem;
      transition:all 0.2s;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:6px;
      border:none;
      font-family:inherit;
    }
    .topbtn:hover{background:rgba(255,255,255,0.2)}
    
    .wrap{max-width:1400px;margin:1.5rem auto;padding:0 1rem}
    
    .breadcrumbs{
      display:flex;
      align-items:center;
      gap:.5rem;
      flex-wrap:wrap;
      margin-bottom:1rem;
      background:#fff;
      padding:.75rem 1rem;
      border-radius:.75rem;
      box-shadow:0 2px 8px rgba(0,0,0,.05);
    }
    .breadcrumb{
      color:var(--muted);
      cursor:pointer;
      transition:color 0.2s;
      font-weight:600;
      font-size:.9rem;
    }
    .breadcrumb:hover{color:var(--primary)}
    .breadcrumb.active{color:var(--text);cursor:default}
    
    .actions{
      display:flex;
      gap:.5rem;
      margin-bottom:1rem;
      flex-wrap:wrap;
    }
    .btn{
      background:#fff;
      color:var(--text);
      padding:.6rem 1rem;
      border-radius:.5rem;
      cursor:pointer;
      font-weight:700;
      transition:all 0.2s;
      font-family:inherit;
      border:1px solid var(--border);
      display:inline-flex;
      align-items:center;
      gap:.5rem;
      font-size:.9rem;
    }
    .btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn.primary:hover{background:#a80d25}
    
    .search{
      flex:1;
      min-width:200px;
      position:relative;
    }
    .search input{
      width:100%;
      padding:.6rem 1rem .6rem 2.5rem;
      border:1px solid var(--border);
      border-radius:.5rem;
      background:#fff;
      font-size:.9rem;
      font-family:inherit;
    }
    .search input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(200,16,46,0.1)}
    .search i{position:absolute;left:1rem;top:50%;transform:translateY(-50%);color:var(--muted)}
    
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
      gap:1rem;
    }
    
    .item{
      background:#fff;
      border-radius:.75rem;
      padding:1.25rem;
      cursor:pointer;
      transition:all 0.2s;
      border:2px solid transparent;
      box-shadow:0 2px 8px rgba(0,0,0,.05);
      position:relative;
    }
    .item:hover{
      transform:translateY(-4px);
      box-shadow:0 8px 20px rgba(0,0,0,.12);
      border-color:var(--primary-light);
    }
    .item-icon{
      font-size:3rem;
      margin-bottom:.75rem;
      text-align:center;
    }
    .item-name{
      font-weight:700;
      font-size:.95rem;
      margin-bottom:.5rem;
      word-break:break-word;
    }
    .item-meta{
      font-size:.8rem;
      color:var(--muted);
    }
    
    .folder{color:#3b82f6}
    .pdf{color:#ef4444}
    .image{color:#10b981}
    .word{color:#2563eb}
    .excel{color:#16a34a}
    .file{color:var(--muted)}
    
    .menu{
      position:absolute;
      top:.5rem;
      right:.5rem;
      background:rgba(255,255,255,0.9);
      backdrop-filter:blur(10px);
      border-radius:.5rem;
      padding:.25rem;
      border:1px solid var(--border);
      display:none;
    }
    .item:hover .menu{display:block}
    .menu-btn{
      background:none;
      border:none;
      color:var(--muted);
      cursor:pointer;
      padding:.35rem .5rem;
      font-size:.85rem;
      transition:all 0.2s;
      border-radius:.25rem;
    }
    .menu-btn:hover{background:#f3f4f6;color:var(--text)}
    
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:1000;
      padding:20px;
    }
    .modal.show{display:flex}
    .modal-box{
      background:#fff;
      border-radius:14px;
      max-width:600px;
      width:100%;
      max-height:90vh;
      overflow-y:auto;
      padding:24px;
      box-shadow:0 8px 20px rgba(0,0,0,.3);
    }
    .modal-box h3{margin:0 0 1rem 0;color:var(--primary);font-weight:800}
    
    .form-group{margin-bottom:1rem}
    .form-group label{font-weight:700;font-size:.9rem;color:#374151;display:block;margin-bottom:.5rem}
    .form-group input{
      padding:.6rem;
      border:1px solid var(--border);
      border-radius:.5rem;
      background:#fff;
      font-size:16px;
      font-family:inherit;
      width:100%;
    }
    .form-group input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(200,16,46,0.1)}
    
    .upload-area{
      border:2px dashed var(--border);
      border-radius:.75rem;
      padding:2rem;
      text-align:center;
      cursor:pointer;
      transition:all 0.2s;
      background:#fafafa;
    }
    .upload-area:hover{border-color:var(--primary);background:#fff}
    .upload-area.drag-over{border-color:var(--primary);background:var(--primary-light)}
    
    .empty{
      text-align:center;
      padding:3rem 1rem;
      color:var(--muted);
    }
    .empty i{font-size:4rem;margin-bottom:1rem;opacity:0.3}
    
    .center-muted{color:var(--muted);text-align:center;padding:2rem}
    .error{background:#fff5f5;border:1px solid #f2c9d1;color:#8b0e22;border-radius:10px;padding:10px;margin-bottom:1rem}
    .success{background:#f0fdf4;border:1px solid #bbf7d0;color:#166534;border-radius:10px;padding:10px;margin-bottom:1rem}
    
    @media (max-width:768px){
      .bar{flex-direction:column;align-items:stretch}
      h1{font-size:1rem}
      .toolbar{margin-left:0;width:100%;justify-content:space-between}
      .topbtn{flex:1;justify-content:center}
      .actions{flex-direction:column}
      .btn{width:100%;justify-content:center}
      .search{width:100%}
      .grid{grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:.75rem}
      .item{padding:1rem}
      .item-icon{font-size:2.5rem}
    }
  </style>
</head>

<body>

<!-- HEADER -->
<header>
  <div class="bar">
    <h1><i class="fa-solid fa-folder-open"></i> Dateien</h1>
    <div class="toolbar">
      <a class="topbtn" href="mpg-dashboard.html">
        <i class="fa-solid fa-dashboard"></i> Dashboard
      </a>
      <button class="topbtn" id="logout">
        <i class="fa-solid fa-right-from-bracket"></i> Logout
      </button>
    </div>
  </div>
</header>

<!-- MAIN -->
<div class="wrap">
  <!-- Breadcrumbs -->
  <div class="breadcrumbs" id="breadcrumbs"></div>
  
  <!-- Actions -->
  <div class="actions">
    <div class="search">
      <i class="fas fa-search"></i>
      <input type="text" id="search" placeholder="Dateien durchsuchen...">
    </div>
    <button class="btn primary" onclick="openNewFolderModal()">
      <i class="fas fa-folder-plus"></i> Neuer Ordner
    </button>
    <button class="btn primary" onclick="openUploadModal()">
      <i class="fas fa-upload"></i> Hochladen
    </button>
  </div>
  
  <!-- Grid -->
  <div id="grid" class="grid">
    <div class="center-muted">Lade Dateien...</div>
  </div>
</div>

<!-- MODALS -->

<!-- New Folder Modal -->
<div class="modal" id="newFolderModal">
  <div class="modal-box" style="max-width:400px">
    <h3>Neuer Ordner</h3>
    <div class="form-group">
      <label>Ordnername</label>
      <input type="text" id="folder-name" placeholder="z.B. Protokolle">
    </div>
    <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:1.5rem">
      <button class="btn" onclick="closeNewFolderModal()">Abbrechen</button>
      <button class="btn primary" onclick="createFolder()">
        <i class="fas fa-check"></i> Erstellen
      </button>
    </div>
  </div>
</div>

<!-- Upload Modal -->
<div class="modal" id="uploadModal">
  <div class="modal-box">
    <h3>Dateien hochladen</h3>
    <div class="upload-area" id="upload-area">
      <i class="fas fa-cloud-upload-alt" style="font-size:3rem;color:var(--muted);margin-bottom:1rem"></i>
      <div style="font-weight:700;margin-bottom:.5rem">Dateien hierher ziehen</div>
      <div style="color:var(--muted);font-size:.9rem">oder klicken zum Ausw√§hlen</div>
      <input type="file" id="file-input" multiple style="display:none">
    </div>
    <div id="upload-list" style="margin-top:1rem"></div>
    <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:1.5rem">
      <button class="btn" onclick="closeUploadModal()">Schlie√üen</button>
    </div>
  </div>
</div>

<!-- Rename Modal -->
<div class="modal" id="renameModal">
  <div class="modal-box" style="max-width:400px">
    <h3>Umbenennen</h3>
    <div class="form-group">
      <label>Neuer Name</label>
      <input type="text" id="rename-input">
    </div>
    <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:1.5rem">
      <button class="btn" onclick="closeRenameModal()">Abbrechen</button>
      <button class="btn primary" onclick="saveRename()">
        <i class="fas fa-check"></i> Speichern
      </button>
    </div>
  </div>
</div>

<script type="module">
  // ========================================
  // POCKETBASE & AUTH
  // ========================================
  const pb = new PocketBase('https://api.responda.systems');
  
  if (!pb.authStore.isValid) {
    location.href = "/mpg-login.html";
  }

  const currentUser = pb.authStore.model;
  if (!currentUser || !currentUser.organization_id) {
    location.href = "/mpg-login.html";
  }

  document.getElementById("logout").onclick = () => {
    pb.authStore.clear();
    localStorage.clear();
    location.href = "/mpg-login.html";
  };

  // ========================================
  // STATE
  // ========================================
  let currentFolderId = null;
  let folderPath = [];
  let allFiles = [];
  let searchQuery = "";

  // ========================================
  // HELPERS
  // ========================================
  function showMsg(text, type = 'success') {
    const div = document.createElement('div');
    div.className = type;
    div.textContent = text;
    document.querySelector('.wrap').insertBefore(div, document.querySelector('.wrap').firstChild);
    setTimeout(() => div.remove(), 4000);
  }

  function getFileIcon(item) {
    if (item.is_folder) return '<i class="fas fa-folder folder"></i>';
    
    const ext = item.name.split('.').pop().toLowerCase();
    const type = item.file_type || '';
    
    if (type.startsWith('image/')) return '<i class="fas fa-file-image image"></i>';
    if (ext === 'pdf' || type === 'application/pdf') return '<i class="fas fa-file-pdf pdf"></i>';
    if (['doc', 'docx'].includes(ext)) return '<i class="fas fa-file-word word"></i>';
    if (['xls', 'xlsx'].includes(ext)) return '<i class="fas fa-file-excel excel"></i>';
    if (['zip', 'rar', '7z'].includes(ext)) return '<i class="fas fa-file-archive file"></i>';
    
    return '<i class="fas fa-file file"></i>';
  }

  function formatFileSize(bytes) {
    if (!bytes || bytes === 0) return '-';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  }

  function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('de-DE');
  }

  // ========================================
  // LOAD FILES
  // ========================================
  async function loadFiles() {
    try {
      const filter = `organization_id = "${currentUser.organization_id}" && parent_folder_id ${currentFolderId ? `= "${currentFolderId}"` : '= ""'}`;
      
      allFiles = await pb.collection('files').getFullList({
        filter,
        sort: '-is_folder,name'
      });
      
      renderBreadcrumbs();
      renderFiles();
      
    } catch(e) {
      console.error('Error loading files:', e);
      document.getElementById('grid').innerHTML = `<div class="error">Fehler beim Laden: ${e.message}</div>`;
    }
  }

  function renderBreadcrumbs() {
    const breadcrumbsEl = document.getElementById('breadcrumbs');
    
    let html = '<span class="breadcrumb" onclick="navigateToFolder(null)"><i class="fas fa-home"></i> Home</span>';
    
    folderPath.forEach((folder, idx) => {
      html += ' <i class="fas fa-chevron-right" style="color:var(--muted);font-size:.7rem"></i> ';
      html += `<span class="breadcrumb ${idx === folderPath.length - 1 ? 'active' : ''}" onclick="navigateToFolder('${folder.id}')">${folder.name}</span>`;
    });
    
    breadcrumbsEl.innerHTML = html;
  }

  function renderFiles() {
    const gridEl = document.getElementById('grid');
    
    let filtered = allFiles;
    
    if (searchQuery) {
      const query = searchQuery.toLowerCase();
      filtered = filtered.filter(f => f.name.toLowerCase().includes(query));
    }
    
    if (!filtered.length) {
      gridEl.innerHTML = `
        <div class="empty" style="grid-column:1/-1">
          <i class="fas fa-folder-open"></i>
          <div style="font-weight:700;margin-bottom:.5rem">Keine Dateien</div>
          <div>Erstelle einen Ordner oder lade Dateien hoch</div>
        </div>
      `;
      return;
    }
    
    gridEl.innerHTML = filtered.map(item => `
      <div class="item" onclick="${item.is_folder ? `navigateToFolder('${item.id}', '${item.name}')` : `downloadFile('${item.id}')`}">
        <div class="menu">
          <button class="menu-btn" onclick="event.stopPropagation();renameItem('${item.id}', '${item.name}')" title="Umbenennen">
            <i class="fas fa-edit"></i>
          </button>
          <button class="menu-btn" onclick="event.stopPropagation();deleteItem('${item.id}', '${item.name}', ${item.is_folder})" title="L√∂schen">
            <i class="fas fa-trash"></i>
          </button>
        </div>
        <div class="item-icon">${getFileIcon(item)}</div>
        <div class="item-name">${item.name}</div>
        <div class="item-meta">
          ${item.is_folder ? 'Ordner' : formatFileSize(item.file_size)} ‚Ä¢ ${formatDate(item.created)}
        </div>
      </div>
    `).join('');
  }

  // ========================================
  // NAVIGATION
  // ========================================
  window.navigateToFolder = async (folderId, folderName) => {
    if (folderId === null) {
      // Navigate to root
      currentFolderId = null;
      folderPath = [];
    } else {
      // Check if clicking on breadcrumb
      const idx = folderPath.findIndex(f => f.id === folderId);
      if (idx >= 0) {
        currentFolderId = folderId;
        folderPath = folderPath.slice(0, idx + 1);
      } else {
        // Navigate into folder
        currentFolderId = folderId;
        folderPath.push({ id: folderId, name: folderName });
      }
    }
    
    await loadFiles();
  };

  // ========================================
  // SEARCH
  // ========================================
  document.getElementById('search').oninput = (e) => {
    searchQuery = e.target.value.trim();
    renderFiles();
  };

  // ========================================
  // CREATE FOLDER
  // ========================================
  window.openNewFolderModal = () => {
    document.getElementById('folder-name').value = '';
    document.getElementById('newFolderModal').classList.add('show');
    setTimeout(() => document.getElementById('folder-name').focus(), 100);
  };

  window.closeNewFolderModal = () => {
    document.getElementById('newFolderModal').classList.remove('show');
  };

  window.createFolder = async () => {
    const name = document.getElementById('folder-name').value.trim();
    
    if (!name) {
      alert('Bitte Ordnername eingeben');
      return;
    }
    
    try {
      await pb.collection('files').create({
        name,
        is_folder: true,
        parent_folder_id: currentFolderId || '',
        organization_id: currentUser.organization_id
      });
      
      closeNewFolderModal();
      await loadFiles();
      showMsg('‚úÖ Ordner erstellt!');
      
    } catch(e) {
      alert('Fehler: ' + e.message);
    }
  };

  // ========================================
  // UPLOAD FILES
  // ========================================
  window.openUploadModal = () => {
    document.getElementById('uploadModal').classList.add('show');
    document.getElementById('upload-list').innerHTML = '';
  };

  window.closeUploadModal = () => {
    document.getElementById('uploadModal').classList.remove('show');
  };

  const uploadArea = document.getElementById('upload-area');
  const fileInput = document.getElementById('file-input');

  uploadArea.onclick = () => fileInput.click();

  uploadArea.ondragover = (e) => {
    e.preventDefault();
    uploadArea.classList.add('drag-over');
  };

  uploadArea.ondragleave = () => {
    uploadArea.classList.remove('drag-over');
  };

  uploadArea.ondrop = (e) => {
    e.preventDefault();
    uploadArea.classList.remove('drag-over');
    handleFiles(e.dataTransfer.files);
  };

  fileInput.onchange = (e) => {
    handleFiles(e.target.files);
  };

  async function handleFiles(files) {
    const listEl = document.getElementById('upload-list');
    
    for (const file of files) {
      const itemEl = document.createElement('div');
      itemEl.style.cssText = 'padding:.75rem;background:#f9fafb;border-radius:.5rem;margin-top:.5rem;display:flex;justify-content:space-between;align-items:center';
      itemEl.innerHTML = `
        <div>
          <div style="font-weight:700">${file.name}</div>
          <div style="font-size:.85rem;color:var(--muted)">${formatFileSize(file.size)}</div>
        </div>
        <div style="color:var(--muted)">
          <i class="fas fa-spinner fa-spin"></i>
        </div>
      `;
      listEl.appendChild(itemEl);
      
      try {
        const formData = new FormData();
        formData.append('name', file.name);
        formData.append('is_folder', false);
        formData.append('parent_folder_id', currentFolderId || '');
        formData.append('file', file);
        formData.append('file_size', file.size);
        formData.append('file_type', file.type);
        formData.append('organization_id', currentUser.organization_id);
        
        await pb.collection('files').create(formData);
        
        itemEl.querySelector('div:last-child').innerHTML = '<i class="fas fa-check" style="color:var(--success)"></i>';
        
      } catch(e) {
        itemEl.querySelector('div:last-child').innerHTML = '<i class="fas fa-times" style="color:var(--primary)"></i>';
        console.error('Upload error:', e);
      }
    }
    
    await loadFiles();
    showMsg('‚úÖ Dateien hochgeladen!');
  }

  // ========================================
  // DOWNLOAD FILE - FIXED VERSION üîí
  // ========================================
  window.downloadFile = async (fileId) => {
    try {
      const file = await pb.collection('files').getOne(fileId);
      
      if (!file.file) {
        alert('Keine Datei vorhanden');
        return;
      }
      
      // ‚úÖ KORREKTE URL-GENERIERUNG MIT TOKEN
      const baseUrl = pb.baseUrl;
      const token = pb.authStore.token;
      
      // URL Format: /api/files/COLLECTION_ID/RECORD_ID/FILENAME?token=xxx
      const url = `${baseUrl}/api/files/${file.collectionId}/${file.id}/${file.file}?token=${token}`;
      
      console.log('Download URL:', url);
      
      // Download mit fetch
      const response = await fetch(url, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const blob = await response.blob();
      const downloadUrl = window.URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = downloadUrl;
      a.download = file.name;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      
      // Cleanup
      setTimeout(() => window.URL.revokeObjectURL(downloadUrl), 100);
      
    } catch(e) {
      console.error('Download error:', e);
      alert('Fehler beim Download: ' + e.message);
    }
  };

  // ========================================
  // RENAME
  // ========================================
  let currentRenameId = null;

  window.renameItem = (itemId, currentName) => {
    currentRenameId = itemId;
    document.getElementById('rename-input').value = currentName;
    document.getElementById('renameModal').classList.add('show');
    setTimeout(() => document.getElementById('rename-input').focus(), 100);
  };

  window.closeRenameModal = () => {
    document.getElementById('renameModal').classList.remove('show');
    currentRenameId = null;
  };

  window.saveRename = async () => {
    const newName = document.getElementById('rename-input').value.trim();
    
    if (!newName) {
      alert('Bitte Name eingeben');
      return;
    }
    
    try {
      await pb.collection('files').update(currentRenameId, { name: newName });
      
      closeRenameModal();
      await loadFiles();
      showMsg('‚úÖ Umbenannt!');
      
    } catch(e) {
      alert('Fehler: ' + e.message);
    }
  };

  // ========================================
  // DELETE
  // ========================================
  window.deleteItem = async (itemId, itemName, isFolder) => {
    const type = isFolder ? 'Ordner' : 'Datei';
    
    if (!confirm(`${type} "${itemName}" wirklich l√∂schen?${isFolder ? '\n\nAlle Dateien im Ordner gehen verloren!' : ''}`)) {
      return;
    }
    
    try {
      if (isFolder) {
        // Delete all files in folder first
        const children = await pb.collection('files').getFullList({
          filter: `parent_folder_id = "${itemId}"`
        });
        
        for (const child of children) {
          await pb.collection('files').delete(child.id);
        }
      }
      
      await pb.collection('files').delete(itemId);
      
      await loadFiles();
      showMsg('‚úÖ Gel√∂scht!');
      
    } catch(e) {
      alert('Fehler: ' + e.message);
    }
  };

  // ========================================
  // START
  // ========================================
  await loadFiles();
  
  setTimeout(() => {
    document.body.classList.add('loaded');
  }, 100);

</script>
</body>
</html>
