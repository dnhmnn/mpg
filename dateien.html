<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FFW – Dateien</title>
<link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{ --rot:#c8102e; --bg:#f7f7f7; --card:#fff; --bd:#e7e7e7; --mut:#6b7280; }
  *{ box-sizing:border-box }
  body{ margin:0; background:var(--bg); font-family:'Atkinson Hyperlegible', Arial, sans-serif; color:#1f2937 }
  header{ background:var(--rot); color:#fff; display:flex; align-items:center; gap:12px; padding:12px 14px; }
  header h1{ margin:0; font-size:1.15rem; font-weight:700; letter-spacing:.2px }
  .spacer{ flex:1 }
  .topbtn{ color:#fff; text-decoration:none; background:#00000022; padding:8px 12px; border-radius:10px; font-weight:700 }
  .wrap{ max-width:1000px; margin:16px auto; padding:0 14px; display:flex; flex-direction:column; gap:14px }
  .card{ background:var(--card); border-radius:14px; box-shadow:0 3px 12px rgba(0,0,0,.06); padding:14px }
  h2{ margin:.2rem 0 1rem; color:var(--rot) }
  .row{ display:flex; gap:10px; flex-wrap:wrap }
  input,button{ font-family:inherit; font-size:1rem }
  input{ width:100%; padding:10px 12px; border:1px solid var(--bd); border-radius:10px; background:#fafafa }
  .btn{ background:var(--rot); color:#fff; border:0; border-radius:10px; padding:10px 14px; font-weight:700; cursor:pointer }
  .btn.ghost{ background:#fff; color:var(--rot); border:1px solid var(--rot) }
  .pill{ display:inline-block; padding:6px 10px; border-radius:999px; background:#eef2ff; color:#1e3a8a; font-weight:700; font-size:.9rem }
  .hint{ color:var(--mut); font-size:.95rem }
  .error{ background:#fff5f5; border:1px solid #f2c9d1; color:#8b0e22; border-radius:10px; padding:10px; }
  /* Dropzone */
  .drop{ border:2px dashed #cbd5e1; border-radius:12px; padding:18px; text-align:center; color:#475569 }
  .drop.drag{ background:#f8fafc; border-color:#94a3b8 }
  /* Liste */
  .folder-list, .file-list{ display:grid; grid-template-columns:repeat(auto-fill, minmax(250px,1fr)); gap:10px }
  .folder, .file{ border:1px solid var(--bd); border-radius:12px; padding:12px; background:#fff; display:flex; gap:10px; align-items:center; }
  .folder i, .file i{ font-style:normal; width:28px; height:28px; border-radius:8px; display:flex; align-items:center; justify-content:center; background:#fee2e2; color:#991b1b; font-weight:900 }
  .meta{ font-size:.9rem; color:#6b7280 }
  .row-actions{ display:flex; gap:6px; flex-wrap:wrap }
  @media (max-width:720px){
    .row > *{ flex:1 1 100% }
  }
</style>
</head>
<body>
<header>
  <h1>FFW – Dateien</h1>
  <div class="spacer"></div>
  <a class="topbtn" href="admin-dashboard.html">Dashboard</a>
  <a class="topbtn" href="#" id="logout">Logout</a>
</header>

<div class="wrap">

  <section class="card">
    <h2>Dateien hochladen &amp; verwalten</h2>

    <div class="row">
      <label>
        <input type="file" id="picker" multiple hidden>
        <button class="btn" id="pickBtn">Dateien auswählen</button>
      </label>
      <button class="btn ghost" id="refresh">Aktualisieren</button>

      <button class="btn ghost" id="mkfolder">Ordner erstellen</button>
      <span class="pill">Bucket: <span id="bucketName">default</span></span>
    </div>

    <div class="row" style="margin-top:8px">
      <input id="path" placeholder="Ordner (z. B. einsatz/2025-001/)" />
      <input id="tags" placeholder="Tags, Komma-getrennt (z. B. einsatz,bericht)" />
    </div>

    <div id="drop" class="drop" style="margin-top:8px">
      <b>Dateien hierher ziehen &amp; ablegen</b><br>
      Ordnerpfad + Tags werden beim Upload gespeichert. Bucket: <b>default</b>.
    </div>

    <div class="row" style="margin-top:10px">
      <input id="search" placeholder="🔎 Suche (Dateiname oder Ordner) …">
    </div>

    <div id="who" class="hint" style="margin-top:8px">Angemeldet als: —</div>
    <div id="note" class="hint" style="margin-top:4px"></div>
    <div id="msg" class="error" style="display:none;margin-top:8px"></div>
  </section>

  <section class="card">
    <h2>Übersicht</h2>
    <div id="empty" class="hint">Keine Dateien vorhanden.</div>

    <div id="foldersWrap" style="display:none;margin-top:6px">
      <div class="meta" style="margin-bottom:6px">Ordner</div>
      <div class="folder-list" id="folders"></div>
    </div>

    <div id="filesWrap" style="display:none;margin-top:12px">
      <div class="meta" style="margin-bottom:6px">Dateien</div>
      <div class="file-list" id="files"></div>
    </div>
  </section>

</div>

<script type="module">
  import { NhostClient } from "https://esm.sh/@nhost/nhost-js@2.2.9";

  /* ---------- Nhost Setup ---------- */
  const nhost = new NhostClient({
    subdomain: "hpjfrhktprpuuxvvlpsb",
    region: "eu-central-1"
  });
  const BUCKET = 'default';
  document.getElementById('bucketName').textContent = BUCKET;

  /* ---------- Auth Guard ---------- */
  async function guard(){
    const ok = await nhost.auth.isAuthenticatedAsync();
    if (!ok) {
      const back = encodeURIComponent(location.pathname + location.search);
      location.href = "admin-login.html?redirect=" + back;
      return false;
    }
    const u = nhost.auth.getUser();
    document.getElementById('who').textContent = "Angemeldet als: " + (u?.email || "—");
    return true;
  }
  if (!await guard()) throw new Error('redirect');

  /* ---------- DOM ---------- */
  const pickBtn = document.getElementById('pickBtn');
  const picker  = document.getElementById('picker');
  const refresh = document.getElementById('refresh');
  const mkfolder= document.getElementById('mkfolder');
  const drop    = document.getElementById('drop');
  const inpPath = document.getElementById('path');
  const inpTags = document.getElementById('tags');
  const inpSearch = document.getElementById('search');
  const msg    = document.getElementById('msg');
  const note   = document.getElementById('note');
  const foldersWrap = document.getElementById('foldersWrap');
  const filesWrap   = document.getElementById('filesWrap');
  const foldersEl   = document.getElementById('folders');
  const filesEl     = document.getElementById('files');
  const emptyEl     = document.getElementById('empty');

  /* ---------- Helpers ---------- */
  function showErr(text){
    msg.style.display='block';
    msg.textContent = text;
  }
  function clearErr(){
    msg.style.display='none';
    msg.textContent='';
  }
  function normPath(p){
    p = (p||'').trim().replace(/^\/+/,'').replace(/\s+/g,'-');
    if (!p) return '';
    return p.endsWith('/') ? p : p + '/';
  }
  function parseTags(text){
    const arr = (text||'').split(',').map(s=>s.trim()).filter(Boolean);
    return arr.length? arr : null;
  }
  function fmtSize(b){
    if (!Number.isFinite(b)) return '';
    const u=['B','KB','MB','GB','TB']; let i=0; while(b>=1024&&i<u.length-1){ b/=1024; i++; }
    return (Math.round(b*10)/10)+' '+u[i];
  }

  /* ---------- Uploads ---------- */
  pickBtn.onclick = ()=> picker.click();
  picker.onchange = async (e)=>{ if (e.target.files?.length) await doUpload(e.target.files); picker.value=''; };
  drop.ondragover = (e)=>{ e.preventDefault(); drop.classList.add('drag'); };
  drop.ondragleave= ()=> drop.classList.remove('drag');
  drop.ondrop = async (e)=>{
    e.preventDefault(); drop.classList.remove('drag');
    const files = e.dataTransfer?.files; if (files?.length) await doUpload(files);
  };

  async function doUpload(fileList){
    clearErr();
    const folder = normPath(inpPath.value);
    const tags   = parseTags(inpTags.value);
    try{
      for (const file of fileList){
        const { fileMetadata, error } = await nhost.storage.upload({
          file, bucketId: BUCKET
        });
        if (error) throw error;

        const { error: gErr } = await nhost.graphql.request(
          `mutation ($obj: file_meta_insert_input!){
            insert_file_meta_one(object:$obj){ file_id }
          }`,
          { obj:{
              file_id: fileMetadata.id,
              name: file.name,
              path: folder,
              tags,
              uploader_id: nhost.auth.getUser()?.id || null
            }
          }
        );
        if (gErr) throw gErr;
      }
      note.textContent = folder ? `Ordner „${folder}“ wird beim Upload verwendet.` : '';
      await load();
    }catch(e){
      showErr('Upload fehlgeschlagen: ' + (e?.message || e));
    }
  }

  /* ---------- „Ordner erstellen“ (.keep) ---------- */
  mkfolder.onclick = async ()=>{
    clearErr();
    let folder = normPath(inpPath.value);
    if (!folder){ alert('Bitte einen Ordnernamen eingeben (z. B. „Rechte/“).'); return; }
    try{
      const blob = new Blob([''], { type: 'text/plain' });
      const phantom = new File([blob], '.keep', { type:'text/plain' });

      const { fileMetadata, error } = await nhost.storage.upload({
        file: phantom,
        bucketId: BUCKET
      });
      if (error) throw error;

      const { error: gErr } = await nhost.graphql.request(
        `mutation ($obj: file_meta_insert_input!){
          insert_file_meta_one(object:$obj){ file_id }
        }`,
        { obj:{
            file_id: fileMetadata.id,
            name: '.keep',
            path: folder,
            tags: ['__folder'],
            uploader_id: nhost.auth.getUser()?.id || null
          }
        }
      );
      if (gErr) throw gErr;

      note.textContent = `Ordner „${folder}“ ist virtuell und wird beim Upload verwendet.`;
      await load();
      alert(`Ordner „${folder}“ wurde angelegt.`);
    }catch(e){
      showErr('Ordner anlegen fehlgeschlagen: ' + (e?.message || e));
    }
  };

  /* ---------- Laden & Rendern ---------- */
  let ALL = []; // rohe Datensätze aus file_meta (inkl. .keep)
  refresh.onclick = ()=> load();
  inpSearch.oninput = ()=> render();

  async function load(){
    clearErr();
    try{
      const like = '%' + (inpSearch.value?.trim() || '') + '%';
      const { data, error } = await nhost.graphql.request(
        `query ($bucket:String!, $like:String!){
          file_meta(
            where:{
              file:{ bucket_id:{_eq:$bucket} }
              _or:[ {name:{_ilike:$like}}, {path:{_ilike:$like}} ]
            },
            order_by:{ updated_at: desc }
          ){
            file_id name path tags created_at updated_at uploader_id
            file { id name size mime_type created_at updated_at bucket_id }
          }
        }`,
        { bucket: BUCKET, like }
      );
      if (error) throw error;
      ALL = data.file_meta || [];
      render();
    }catch(e){
      showErr('Konnte Dateien nicht laden: ' + (e?.message || e));
      ALL = [];
      render();
    }
  }

  function render(){
    const q = (inpSearch.value||'').toLowerCase();
    const rows = ALL.filter(r=>{
      const hay = (r.name + ' ' + (r.path||'')).toLowerCase();
      return !q || hay.includes(q);
    });

    // Ordnerliste: Distinct path (auch wenn nur .keep existiert)
    const paths = [...new Set(rows.map(r=> (r.path||'').trim() ))].filter(p=>p!=='');
    foldersEl.innerHTML = '';
    if (paths.length){
      foldersWrap.style.display='block';
      paths.sort((a,b)=>a.localeCompare(b,'de'));
      for (const p of paths){
        const cnt = rows.filter(r=> (r.path||'')===p && r.name!=='.keep').length;
        const el = document.createElement('div');
        el.className='folder';
        el.innerHTML = `
          <i>📁</i>
          <div style="flex:1">
            <div><b>${p}</b></div>
            <div class="meta">${cnt} Datei(en)</div>
          </div>
          <div class="row-actions">
            <button class="btn ghost" onclick="(function(){ document.getElementById('path').value='${p}'; document.getElementById('search').value='${p}'; render(); })()">Öffnen</button>
          </div>`;
        foldersEl.appendChild(el);
      }
    }else{
      foldersWrap.style.display='none';
    }

    // Dateien (ohne .keep)
    const files = rows.filter(r=> r.name !== '.keep');
    filesEl.innerHTML='';
    if (files.length){
      filesWrap.style.display='block';
      emptyEl.style.display='none';
      for (const r of files){
        const f = r.file || {};
        const el = document.createElement('div');
        el.className='file';
        el.innerHTML = `
          <i>📄</i>
          <div style="flex:1; min-width:0">
            <div style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis"><b>${r.name}</b></div>
            <div class="meta">${r.path||'/' } · ${fmtSize(f.size)} · ${new Date(f.updated_at||f.created_at).toLocaleString('de-DE')}</div>
            ${r.tags?.length ? `<div class="meta">Tags: ${r.tags.join(', ')}</div>`:''}
          </div>
          <div class="row-actions">
            <button class="btn ghost" onclick="downloadFile('${r.file_id}')">Öffnen</button>
            <button class="btn ghost" onclick="removeFile('${r.file_id}','${r.name.replace(/'/g,"\\'")}')">Löschen</button>
          </div>`;
        filesEl.appendChild(el);
      }
    }else{
      filesWrap.style.display='none';
      emptyEl.style.display='block';
    }
  }

  // Download (Presigned URL, funktioniert auch bei privaten Buckets)
  window.downloadFile = async function(fileId){
    try{
      const { presignedUrl, error } = await nhost.storage.getPresignedUrl({ fileId, expiresIn: 300 });
      if (error) throw error;
      window.open(presignedUrl.url, '_blank');
    }catch(e){
      showErr('Download fehlgeschlagen: ' + (e?.message || e));
    }
  };

  // Löschen (Storage + Meta)
  window.removeFile = async function(fileId, name){
    if (!confirm(`„${name}“ wirklich löschen?`)) return;
    try{
      const { error } = await nhost.storage.delete({ fileId });
      if (error) throw error;
      const { error: gErr } = await nhost.graphql.request(
        `mutation ($id:uuid!){ delete_file_meta_by_pk(file_id:$id){ file_id } }`,
        { id: fileId }
      );
      if (gErr) throw gErr;
      await load();
    }catch(e){
      showErr('Löschen fehlgeschlagen: ' + (e?.message || e));
    }
  };

  /* ---------- Logout ---------- */
  document.getElementById('logout').onclick = async (e)=>{
    e.preventDefault();
    await nhost.auth.signOut();
    localStorage.clear();
    location.href = 'admin-login.html';
  };

  /* ---------- Start ---------- */
  await load();
</script>
</body>
</html>
