<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FFW â€“ Dateien</title>
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{ --rot:#c8102e; --bg:#f7f7f7; --card:#fff; --border:#e6e6e6; --muted:#6b7280 }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); font-family:'Atkinson Hyperlegible', system-ui, Arial, sans-serif; color:#111 }
    header{ background:var(--rot); color:#fff; display:flex; align-items:center; gap:12px; padding:10px 14px }
    header h1{ margin:0; font-size:1.15rem; font-weight:700 }
    .spacer{ flex:1 }
    .topbtn{ color:#fff; text-decoration:none; background:#00000022; padding:7px 10px; border-radius:8px; font-weight:700 }
    main{ max-width:980px; margin:16px auto; padding:0 14px }
    .card{ background:var(--card); border-radius:12px; box-shadow:0 3px 12px rgba(0,0,0,.06); padding:14px }
    h2{ margin:0 0 10px; color:var(--rot) }
    .row{ display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 }
    input,button{ font:inherit }
    input{ width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#fafafa }
    .btn{ background:var(--rot); color:#fff; border:0; border-radius:10px; padding:10px 14px; font-weight:700; cursor:pointer }
    .btn.ghost{ background:#fff; color:var(--rot); border:1px solid var(--rot) }
    .btn.gray{ background:#eee; color:#333; border:1px solid var(--border) }
    .muted{ color:var(--muted) }
    .msg{ margin-top:6px; min-height:1.2em }
    .msg.err{ color:#c8102e } .msg.ok{ color:#11823b }
    .drop{ border:2px dashed #d1d5db; border-radius:12px; padding:16px; text-align:center; color:var(--muted) }
    .drop.drag{ background:#fffaf3; border-color:#f59e0b; color:#92400e }
    .tools{ display:flex; gap:8px; flex-wrap:wrap }
    .tools .btn{ white-space:nowrap }
    .list-head{ display:grid; grid-template-columns:1fr auto; align-items:center; gap:10px; margin-top:10px }
    .search{ position:relative }
    .search input{ padding-left:36px }
    .search i{ position:absolute; top:50%; transform:translateY(-50%); left:12px; color:#9ca3af }
    .file{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 0; border-bottom:1px solid #f1f1f1 }
    .file:last-child{ border-bottom:none }
    .name{ font-weight:700 }
    .path{ color:var(--muted); font-size:.95rem }
    .chips{ display:flex; gap:6px; flex-wrap:wrap; margin-top:4px }
    .chip{ background:#fff5f5; border:1px solid #f2c9d1; color:#8b0e22; padding:2px 8px; border-radius:999px; font-size:.82rem }
    .row-ctl{ display:flex; gap:6px; flex-wrap:wrap }
    .pill{ display:inline-block; background:#eef2ff; color:#3730a3; border:1px solid #e0e7ff; border-radius:999px; padding:2px 8px; font-size:.82rem }
    @media (max-width:640px){
      .file{ align-items:flex-start; flex-direction:column }
      .row-ctl{ width:100% }
      .list-head{ grid-template-columns:1fr }
    }
  </style>
</head>
<body>
<header>
  <h1>FFW â€“ Dateien</h1>
  <div class="spacer"></div>
  <a class="topbtn" href="admin-dashboard.html">Dashboard</a>
  <a class="topbtn" href="#" id="logoutBtn">Logout</a>
</header>

<main>
  <section class="card">
    <h2>Dateien hochladen &amp; verwalten</h2>

    <div class="tools">
      <button class="btn" id="pickBtn">Dateien auswÃ¤hlen</button>
      <button class="btn gray" id="reloadBtn">Aktualisieren</button>
      <button class="btn ghost" id="mkFolderBtn">Ordner erstellen</button>
      <span class="pill">Bucket: <strong id="bucketName">default</strong></span>
    </div>

    <div class="row">
      <input id="inpPath" placeholder="Ordner (z. B. einsatz/2025-001/)" />
    </div>
    <div class="row">
      <input id="inpTags" placeholder="Tags, Komma-getrennt (z. B. einsatz,bericht)" />
    </div>

    <div id="drop" class="drop">Dateien hierher ziehen &amp; ablegen<br>
      <span class="muted">Ordnerpfad + Tags werden beim Upload gespeichert.</span>
    </div>

    <div class="list-head">
      <div class="search">
        <i>ðŸ”Ž</i>
        <input id="q" placeholder="Suche (Dateiname oder Ordner) â€¦" />
      </div>
      <div class="muted">Angemeldet als: <span id="who">â€”</span></div>
    </div>

    <div class="msg" id="msg"></div>
  </section>

  <section class="card" style="margin-top:12px">
    <div id="list"></div>
    <div id="empty" class="muted" style="text-align:center; padding:14px; display:none">Keine Dateien gefunden.</div>
  </section>
</main>

<input id="fileInput" type="file" multiple style="display:none" />

<script type="module">
  import { NhostClient } from 'https://esm.sh/@nhost/nhost-js@2.2.9';

  // ---------- Nhost Setup ----------
  const nhost = new NhostClient({
    subdomain: 'hpjfrhktprpuuxvvlpsb',
    region: 'eu-central-1'
  });

  // ---------- Konfiguration (Option A) ----------
  const BUCKET_ID = 'default';                  // <â€” Option A: default-Bucket nutzen
  document.getElementById('bucketName').textContent = BUCKET_ID;

  // ---------- Elemente ----------
  const msg = document.getElementById('msg');
  const listEl = document.getElementById('list');
  const emptyEl = document.getElementById('empty');
  const whoEl = document.getElementById('who');
  const inpPath = document.getElementById('inpPath');
  const inpTags = document.getElementById('inpTags');
  const qEl = document.getElementById('q');
  const drop = document.getElementById('drop');

  // ---------- Helpers ----------
  const delay = (ms)=> new Promise(r=>setTimeout(r,ms));
  const showOk  = (t)=>{ msg.className = 'msg ok';  msg.textContent = t||''; };
  const showErr = (e)=>{ msg.className = 'msg err'; msg.textContent = typeof e==='string' ? e : (e?.message || JSON.stringify(e)); };
  const clearMsg= ()=>{ msg.className='msg'; msg.textContent=''; };

  function normPath(p){
    p = (p||'').trim().replace(/^\/+/,''); // fÃ¼hrende / weg
    if (p && !p.endsWith('/')) p += '/';
    return p;
  }
  function parseTags(txt){
    const arr = (txt||'').split(',').map(s=>s.trim()).filter(Boolean);
    // Doppelte entfernen:
    return [...new Set(arr)];
  }
  function esc(s){
    return String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  }

  async function guard(){
    const ok = await nhost.auth.isAuthenticatedAsync();
    if (!ok){
      const back = encodeURIComponent(location.pathname + location.search);
      location.href = 'admin-login.html?redirect=' + back;
      return false;
    }
    const u = nhost.auth.getUser();
    whoEl.textContent = u?.email || 'â€”';
    return true;
  }
  if (!await guard()) throw new Error('redirect');

  document.getElementById('logoutBtn').onclick = async (e)=>{
    e.preventDefault();
    await nhost.auth.signOut();
    localStorage.clear();
    location.href = 'admin-login.html';
  };

  // ---------- GraphQL ----------
  async function gql(q, v){
    const { data, error } = await nhost.graphql.request(q, v);
    if (error) throw new Error(error.message || JSON.stringify(error));
    return data;
  }

  // Liste laden (aus Hasura -> public.file_meta)
  async function loadList(){
    try{
      clearMsg();
      listEl.innerHTML = '';
      emptyEl.style.display = 'none';

      const like = '%' + (qEl.value||'').trim() + '%';
      const data = await gql(`
        query($like:String!){
          file_meta(where:{ _or:[ {name:{_ilike:$like}}, {path:{_ilike:$like}} ] },
                    order_by:{created_at:desc}, limit:400){
            file_id name path tags created_at
          }
        }
      `,{ like });

      const rows = data.file_meta || [];
      if (!rows.length){ emptyEl.style.display='block'; return; }

      for (const r of rows){
        const when = new Date(r.created_at).toLocaleString('de-DE');
        const tags = Array.isArray(r.tags) ? r.tags : [];
        const html = `
          <div class="file" data-id="${esc(r.file_id)}">
            <div style="flex:1">
              <div class="name">${esc(r.name)}</div>
              <div class="path">${esc(r.path)} <span class="muted">â€¢ ${when}</span></div>
              ${tags.length ? `<div class="chips">${tags.map(t=>`<span class="chip">#${esc(t)}</span>`).join('')}</div>` : ''}
            </div>
            <div class="row-ctl">
              <button class="btn gray" data-open>Ã–ffnen</button>
              <button class="btn gray" data-copy>Link kopieren</button>
              <button class="btn ghost" data-del>LÃ¶schen</button>
            </div>
          </div>`;
        listEl.insertAdjacentHTML('beforeend', html);
      }
    }catch(e){ showErr(e); }
  }

  // URL ermitteln (Public ODER presigned Fallback)
  async function getFileUrl(fileId){
    try{
      const x = nhost.storage.getPublicUrl({ fileId });
      if (typeof x === 'string') return x;
      if (x?.publicUrl) return x.publicUrl;
    }catch(_){}
    try{
      const { presignedUrl, error } = await nhost.storage.getPresignedUrl({ fileId, expiresIn: 600 });
      if (error) throw error;
      return presignedUrl;
    }catch(_){}
    return null;
  }

  // ---------- Upload ----------
  document.getElementById('pickBtn').onclick = ()=> document.getElementById('fileInput').click();
  document.getElementById('fileInput').onchange = async (e)=>{
    await handleFiles(e.target.files);
    e.target.value = '';
  };

  // Drag & Drop
  ;['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.add('drag'); }));
  ;['dragleave','drop'].forEach(ev=>drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.remove('drag'); }));
  drop.addEventListener('drop', async (e)=>{
    const files = [...(e.dataTransfer?.files || [])];
    if (files.length) await handleFiles(files);
  });

  async function handleFiles(files){
    if (!files || !files.length) return;
    clearMsg();
    const path = normPath(inpPath.value);
    const tags = parseTags(inpTags.value);
    const userId = nhost.auth.getUser()?.id || null;

    for (const file of files){
      try{
        // 1) Upload in Storage (Bucket: default)
        const nameInBucket = path + file.name; // "ordner/datei.pdf"
        const { fileMetadata, error } = await nhost.storage.upload({
          file,
          name: nameInBucket,
          bucketId: BUCKET_ID
        });
        if (error) throw error;

        // 2) Metadaten in Hasura
        await gql(`
          mutation($obj:file_meta_insert_input!){
            insert_file_meta_one(object:$obj){ file_id }
          }
        `,{
          obj: {
            file_id: fileMetadata.id,
            name: file.name,
            path,
            tags,
            uploader_id: userId
          }
        });

        showOk(`Hochgeladen: ${file.name}`);
        await delay(50);
      }catch(e){
        showErr('Upload fehlgeschlagen: ' + (e?.message || JSON.stringify(e)));
        // Weiter mit den restlichen Dateien
      }
    }
    await loadList();
  }

  // â€žOrdner erstellenâ€œ (virtuell â€“ nur Hinweis)
  document.getElementById('mkFolderBtn').onclick = ()=>{
    const p = normPath(inpPath.value);
    if (!p){ showErr('Bitte zuerst einen Ordnerpfad eintragen, z. B. â€žeinsatz/2025-001/â€œ.'); return; }
    showOk(`Ordner â€ž${p}â€œ ist virtuell und wird beim Upload verwendet.`);
  };

  // Suche / Refresh
  qEl.addEventListener('input', ()=>{ clearTimeout(window._t); window._t = setTimeout(loadList, 250); });
  document.getElementById('reloadBtn').onclick = loadList;

  // Klicks in der Liste (Ã–ffnen / Link kopieren / LÃ¶schen)
  listEl.addEventListener('click', async (e)=>{
    const row = e.target.closest('.file'); if (!row) return;
    const id = row.dataset.id;

    if (e.target.matches('[data-open]')){
      try{
        const url = await getFileUrl(id);
        if (!url) throw new Error('Konnte URL nicht erzeugen.');
        window.open(url, '_blank');
      }catch(err){ showErr(err); }
    }

    if (e.target.matches('[data-copy]')){
      try{
        const url = await getFileUrl(id);
        if (!url) throw new Error('Konnte URL nicht erzeugen.');
        await navigator.clipboard.writeText(url);
        showOk('Link kopiert.');
      }catch(err){ showErr(err); }
    }

    if (e.target.matches('[data-del]')){
      if (!confirm('Datei wirklich lÃ¶schen?')) return;
      try{
        // 1) aus Storage lÃ¶schen
        const { error: delErr } = await nhost.storage.delete({ fileId: id });
        if (delErr) throw delErr;
        // 2) Metadata lÃ¶schen
        await gql(`mutation($id:uuid!){ delete_file_meta_by_pk(file_id:$id){ file_id } }`, { id });
        // 3) UI aktualisieren
        row.remove();
        if (!listEl.children.length) emptyEl.style.display = 'block';
        showOk('GelÃ¶scht.');
      }catch(err){ showErr(err); }
    }
  });

  // Start
  await loadList();
</script>
</body>
</html>
