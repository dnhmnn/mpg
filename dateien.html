<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FFW – Dateien</title>
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root { --rot:#c8102e; --bg:#f7f7f7; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:'Atkinson Hyperlegible',system-ui,Arial,sans-serif}
    header{background:var(--rot);color:#fff;display:flex;align-items:center;gap:12px;padding:10px 14px}
    header h1{margin:0;font-size:1.1rem}
    .spacer{flex:1}
    .topbtn{color:#fff;text-decoration:none;background:#00000022;padding:7px 10px;border-radius:8px;font-weight:700}
    .wrap{max-width:1000px;margin:16px auto;padding:0 14px}
    .card{background:#fff;border-radius:12px;box-shadow:0 3px 12px rgba(0,0,0,.06);padding:14px}
    h2{margin:4px 0 12px;color:var(--rot)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    input,button{font:inherit}
    input{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;background:#fafafa}
    .btn{background:var(--rot);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.sec{background:#eee;color:var(--rot);border:1px solid var(--rot)}
    .pill{display:inline-block;background:#fff5f5;color:#8b0e22;border:1px solid #f2c9d1;border-radius:999px;padding:2px 8px;font-size:.82rem}
    .drop{border:2px dashed #bbb;border-radius:12px;padding:18px;text-align:center;color:#666;background:#fafafa}
    .drop.drag{border-color:var(--rot);background:#fff}
    .msg{min-height:1.2em}
    .ok{color:#2e7d32}.err{color:#c8102e}
    /* Datei-Karten mobil-first */
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    .file{border:1px solid #eee;border-radius:12px;padding:10px;display:grid;grid-template-columns:1fr auto;gap:8px}
    .meta{color:#666;font-size:.9rem}
    .act{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}
    .tag{display:inline-block;background:#eef2ff;border:1px solid #cbd5ff;color:#384cff;border-radius:999px;padding:2px 8px;font-size:.78rem;margin-right:6px}
    @media (min-width:700px){
      .file{grid-template-columns:1fr 180px}
    }
  </style>
</head>
<body>
<header>
  <h1>FFW – Dateien</h1>
  <div class="spacer"></div>
  <a class="topbtn" href="admin-dashboard.html">Dashboard</a>
  <a class="topbtn" href="#" id="logout">Logout</a>
</header>

<div class="wrap">
  <section class="card">
    <h2>Dateien hochladen & verwalten</h2>

    <div class="row" style="margin-bottom:8px">
      <button class="btn" id="pick">Dateien auswählen</button>
      <button class="btn sec" id="refresh">Aktualisieren</button>
      <button class="btn sec" id="mkFolder">Ordner erstellen</button>
    </div>

    <div class="row">
      <input id="folder" placeholder="Ordner (z. B. einsatz/2025-001/)" />
      <input id="tags"   placeholder="Tags, Komma-getrennt (z. B. einsatz,bericht)" />
    </div>

    <div id="drop" class="drop" style="margin:10px 0">
      Dateien hierher ziehen & ablegen<br>
      <span class="meta">Ordnerpfad + Tags werden beim Upload gespeichert. Bucket: <b>files</b>.</span>
    </div>

    <input id="fileInput" type="file" multiple hidden />

    <div class="row" style="margin:10px 0">
      <input id="search" placeholder="Suche (Dateiname …)" />
    </div>

    <div id="msg" class="msg"></div>

    <div id="list" class="grid" aria-live="polite"></div>
  </section>
</div>

<script type="module">
  import { NhostClient } from "https://esm.sh/@nhost/nhost-js@2.2.9";

  // === Nhost Setup ===
  const nhost = new NhostClient({ subdomain: "hpjfrhktprpuuxvvlpsb", region: "eu-central-1" });
  const BUCKET = "files";

  // === Elemente ===
  const logoutBtn = document.getElementById('logout');
  const pickBtn   = document.getElementById('pick');
  const refreshBtn= document.getElementById('refresh');
  const mkFolder  = document.getElementById('mkFolder');
  const fileInput = document.getElementById('fileInput');
  const folderInp = document.getElementById('folder');
  const tagsInp   = document.getElementById('tags');
  const drop      = document.getElementById('drop');
  const searchInp = document.getElementById('search');
  const msgEl     = document.getElementById('msg');
  const listEl    = document.getElementById('list');

  // === Login-Guard (einfach wie im Dashboard) ===
  async function guard() {
    const ok = await nhost.auth.isAuthenticatedAsync();
    if (!ok) { location.href = "admin-login.html"; return false; }
    return true;
  }
  if (!await guard()) { /* stop */ }

  // Logout
  logoutBtn.onclick = async (e)=> {
    e.preventDefault();
    await nhost.auth.signOut();
    localStorage.clear();
    location.href = "admin-login.html";
  };

  function setMsg(text, ok=false){
    msgEl.textContent = text || "";
    msgEl.className = "msg " + (ok ? "ok" : text ? "err" : "");
  }

  // === Liste laden (GraphQL über storage_files) ===
  async function load(){
    setMsg(""); listEl.innerHTML = "";
    try{
      const search = "%" + (searchInp.value || "").trim() + "%";
      // folder-Filter (metadata.folder), leeres Objekt matcht alles
      const folder = (folderInp.value || "").trim();
      const variables = {
        bucket: BUCKET,
        search,
        folder: folder ? { folder } : {}
      };
      const query = `
      query ListFiles($bucket:String!, $search:String!, $folder: jsonb!) {
        storage_files(
          where:{
            bucket_id:{_eq:$bucket},
            name:{_ilike:$search},
            metadata:{_contains:$folder}
          }
          order_by:{created_at:desc}
          limit:200
        ){
          id name size mime_type created_at metadata
        }
      }`;
      const { data, error } = await nhost.graphql.request(query, variables);
      if (error) throw error;

      const files = data?.storage_files || [];
      if (!files.length){
        listEl.innerHTML = `<div class="meta">Keine Dateien gefunden.</div>`;
        return;
      }

      // Karten rendern
      files.forEach(f=>{
        const d = document.createElement('div');
        d.className = "file";
        const size = human(f.size);
        const created = new Date(f.created_at).toLocaleString('de-DE', { hour:'2-digit', minute:'2-digit', day:'2-digit', month:'2-digit', year:'numeric' });
        const tags = (f.metadata?.tags || []).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join(' ');
        const folderTxt = f.metadata?.folder ? `<span class="meta">Ordner: ${escapeHtml(f.metadata.folder)}</span>` : '';
        d.innerHTML = `
          <div>
            <div style="font-weight:700">${escapeHtml(f.name)}</div>
            <div class="meta">${size} · ${escapeHtml(f.mime_type||'')}</div>
            <div class="meta">Erstellt: ${created}</div>
            ${folderTxt}
            <div style="margin-top:6px">${tags}</div>
          </div>
          <div class="act">
            <button class="btn sec" data-open="${f.id}">Öffnen</button>
            <button class="btn sec" data-del="${f.id}">Löschen</button>
          </div>`;
        listEl.appendChild(d);
      });

      // Buttons verdrahten
      listEl.querySelectorAll('[data-open]').forEach(btn=>{
        btn.addEventListener('click', ()=> openFile(btn.dataset.open));
      });
      listEl.querySelectorAll('[data-del]').forEach(btn=>{
        btn.addEventListener('click', ()=> delFile(btn.dataset.del));
      });

    }catch(e){
      setMsg("Konnte Dateien nicht laden: " + (e?.message || e));
    }
  }

  // Datei via signiertem Request öffnen (Header-Token → Blob → neues Tab)
  async function openFile(id){
    try{
      const url = nhost.storage.url(`/files/${id}`);
      const token = await nhost.auth.getAccessToken();
      const res = await fetch(url, { headers: { Authorization: `Bearer ${token}` }});
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const blob = await res.blob();
      const obj = URL.createObjectURL(blob);
      window.open(obj, "_blank");
      setTimeout(()=> URL.revokeObjectURL(obj), 15000);
    }catch(e){
      setMsg("Öffnen fehlgeschlagen: " + (e?.message || e));
    }
  }

  async function delFile(id){
    if (!confirm("Datei wirklich löschen?")) return;
    try{
      const { error } = await nhost.storage.delete({ id });
      if (error) throw error;
      setMsg("Gelöscht.", true);
      await load();
    }catch(e){
      setMsg("Löschen fehlgeschlagen: " + (e?.message || e));
    }
  }

  // === Upload ===
  pickBtn.onclick = ()=> fileInput.click();
  fileInput.onchange = async (e)=> {
    if (!e.target.files?.length) return;
    await doUpload(e.target.files);
    fileInput.value = "";
  };

  // Drag & Drop
  ;['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev, e=>{
    e.preventDefault(); e.stopPropagation(); drop.classList.add('drag');
  }));
  ;['dragleave','drop'].forEach(ev=> drop.addEventListener(ev, e=>{
    e.preventDefault(); e.stopPropagation(); drop.classList.remove('drag');
  }));
  drop.addEventListener('drop', async (e)=>{
    const files = [...(e.dataTransfer?.files || [])];
    if (files.length) await doUpload(files);
  });

  async function doUpload(files){
    const folder = (folderInp.value || "").trim().replace(/^\/+|\/+$/g,''); // ohne führende/abschließende /
    const tags = (tagsInp.value || "").split(',').map(s=>s.trim()).filter(Boolean);

    try{
      for (const file of files){
        const name = folder ? `${folder}/${file.name}` : file.name;
        const { error } = await nhost.storage.upload({
          file,
          name,
          bucketId: BUCKET,
          metadata: { folder, tags }
        });
        if (error) throw error;
      }
      setMsg("Upload abgeschlossen.", true);
      await load();
    }catch(e){
      setMsg("Upload fehlgeschlagen: " + (e?.message || e));
    }
  }

  // „Ordner“ erstellen → leere Platzhalterdatei anlegen
  mkFolder.onclick = async ()=>{
    const folder = (folderInp.value || "").trim().replace(/^\/+|\/+$/g,'');
    if (!folder){ setMsg("Bitte zuerst einen Ordnernamen eingeben."); return; }
    try{
      const blob = new Blob([""], { type:"text/plain" });
      const name = `${folder}/.keep`;
      const { error } = await nhost.storage.upload({
        file: blob,
        name,
        bucketId: BUCKET,
        metadata: { folder, tags:[] }
      });
      if (error) throw error;
      setMsg(`Ordner „${folder}“ erstellt.`, true);
      await load();
    }catch(e){
      setMsg("Ordner konnte nicht erstellt werden: " + (e?.message || e));
    }
  };

  // Suche/Refresh
  searchInp.addEventListener('input', ()=> load());
  refreshBtn.addEventListener('click', ()=> load());

  // Utils
  function human(bytes){
    if (bytes == null) return '-';
    const u = ['B','KB','MB','GB','TB'];
    let i = 0, n = bytes;
    while (n >= 1024 && i < u.length-1){ n/=1024; i++; }
    return `${n.toFixed(n<10 && i>0 ? 1:0)} ${u[i]}`;
  }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  // Start
  load();
</script>
</body>
</html>
