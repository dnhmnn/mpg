<!DOCTYPE html>

<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Login – Responda</title>
  <meta name="theme-color" content="#667eea">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Inter', -apple-system, sans-serif; background: linear-gradient(135deg, #667eea 0%, #f97316 50%, #764ba2 100%); background-attachment: fixed; min-height: 100vh; -webkit-font-smoothing: antialiased; display: flex; align-items: center; justify-content: center; padding: max(20px, env(safe-area-inset-top)) max(20px, env(safe-area-inset-right)) max(20px, env(safe-area-inset-bottom)) max(20px, env(safe-area-inset-left)); }

```
.login-container { background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px); border-radius: 28px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); max-width: 440px; width: 100%; animation: slideIn 0.4s ease-out; border: 0.5px solid rgba(255, 255, 255, 0.4); }
@keyframes slideIn { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }

.login-header { padding: 48px 32px 32px; text-align: center; }
.logo-container { margin-bottom: 24px; display: flex; justify-content: center; }
.login-header h1 { font-size: 28px; font-weight: 700; margin-bottom: 8px; color: #fff; text-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.login-header p { font-size: 15px; color: rgba(255, 255, 255, 0.95); }

.login-body { padding: 0 32px 40px; }
.form-group { margin-bottom: 20px; }
.form-group label { display: block; font-weight: 600; color: #fff; margin-bottom: 8px; font-size: 14px; }
.form-group input { width: 100%; padding: 14px 16px; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 12px; font-size: 16px; font-family: inherit; transition: all 0.2s; background: rgba(255, 255, 255, 0.95); color: #1a1a1a; }
.form-group input:focus { outline: none; border-color: #fff; box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.2); background: #fff; }
.form-group input::placeholder { color: #9ca3af; }
.form-group small { display: block; color: rgba(255, 255, 255, 0.9); font-size: 13px; margin-top: 6px; }

.org-info { background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 20px; display: none; }
.org-info.show { display: block; }
.org-info strong { color: #fff; display: block; margin-bottom: 8px; font-size: 15px; font-weight: 700; }
.org-detail { color: #fff; font-size: 14px; font-weight: 600; }
.org-change-btn { background: none; border: none; color: #fff; text-decoration: underline; cursor: pointer; font-size: 13px; margin-top: 12px; font-weight: 600; opacity: 0.9; font-family: inherit; }
.org-change-btn:hover { opacity: 1; }

.btn { width: 100%; padding: 14px; background: rgba(255, 255, 255, 0.95); color: #667eea; border: none; border-radius: 12px; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.2s; font-family: inherit; margin-bottom: 12px; }
.btn:active { transform: scale(0.98); background: #fff; }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }

.btn.secondary { background: rgba(255, 255, 255, 0.25); color: #fff; border: 1px solid rgba(255, 255, 255, 0.3); }
.btn.secondary:active { background: rgba(255, 255, 255, 0.35); }

.forgot-password { text-align: center; margin-top: 16px; }
.forgot-password button { background: none; border: none; color: #fff; text-decoration: underline; cursor: pointer; font-size: 14px; font-weight: 600; opacity: 0.9; font-family: inherit; }
.forgot-password button:hover { opacity: 1; }

.msg { padding: 14px 16px; border-radius: 12px; margin-bottom: 20px; font-weight: 600; font-size: 14px; display: none; }
.msg.show { display: block; }
.msg.error { background: rgba(254, 226, 226, 0.95); color: #991b1b; border: 1px solid #fca5a5; }
.msg.success { background: rgba(209, 250, 229, 0.95); color: #065f46; border: 1px solid #6ee7b7; }
.msg.info { background: rgba(219, 234, 254, 0.95); color: #1e40af; border: 1px solid #93c5fd; }

.already-logged-in { display: none; text-align: center; padding: 20px; }
.already-logged-in.show { display: block; }
.already-logged-in h2 { color: #fff; margin-bottom: 12px; font-size: 24px; }
.already-logged-in p { color: rgba(255, 255, 255, 0.9); margin-bottom: 20px; }

.screen { display: none; }
.screen.active { display: block; }

@media (max-width: 480px) {
  body { padding: 16px; }
  .login-header { padding: 36px 24px 24px; }
  .login-body { padding: 0 24px 32px; }
  .login-header h1 { font-size: 24px; }
  .logo-container svg { width: 200px; height: 50px; }
}
```

  </style>
</head>
<body>

<div class="login-container">
  <div class="login-header">
    <div class="logo-container">
      <svg width="280" height="70" viewBox="0 0 2800 700">
        <defs>
          <linearGradient id="logoGrad" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#fff;stop-opacity:1" />
            <stop offset="50%" style="stop-color:#fff;stop-opacity:0.95" />
            <stop offset="100%" style="stop-color:#fff;stop-opacity:0.9" />
          </linearGradient>
        </defs>
        <rect x="50" y="50" width="600" height="600" rx="150" fill="rgba(255,255,255,0.2)"/>
        <path d="M 175 175 L 175 525 L 287.5 525 L 287.5 400 L 362.5 400 L 437.5 525 L 575 525 L 475 390.625 Q 512.5 371.875 512.5 306.25 Q 512.5 175 431.25 175 Z M 287.5 237.5 L 393.75 237.5 Q 437.5 237.5 437.5 293.75 Q 437.5 350 393.75 350 L 287.5 350 Z" fill="white"/>
        <text x="750" y="450" font-family="Archivo, sans-serif" font-size="280" font-weight="600" fill="url(#logoGrad)" letter-spacing="-5">Responda</text>
      </svg>
    </div>
    <h1 id="screenTitle">Willkommen</h1>
    <p id="screenSubtitle">Melde dich an, um fortzufahren</p>
  </div>

  <div class="login-body">
    <div id="msg" class="msg"></div>

```
<div id="alreadyLoggedInScreen" class="screen">
  <div class="already-logged-in show">
    <h2>Bereits angemeldet</h2>
    <p>Du bist bereits eingeloggt.</p>
    <button type="button" class="btn" onclick="goToHub()">Zum Hub</button>
    <button type="button" class="btn secondary" onclick="logoutAndContinue()">Abmelden & neu anmelden</button>
  </div>
</div>

<div id="loginScreen" class="screen active">
  <div id="orgInfo" class="org-info">
    <strong>Organisation</strong>
    <div class="org-detail" id="orgName"></div>
    <button type="button" class="org-change-btn" onclick="changeOrg()">Organisation ändern</button>
  </div>
  
  <form id="loginForm">
    <div id="orgInputGroup" class="form-group">
      <label for="orgCode">Organisations-Code</label>
      <input type="text" id="orgCode" placeholder="z.B. ffwrot" autocomplete="off"/>
      <small>Gib deinen Organisations-Code ein</small>
    </div>
    
    <div class="form-group">
      <label for="email">E-Mail</label>
      <input type="email" id="email" placeholder="deine@email.de" autocomplete="email" required/>
    </div>
    
    <div class="form-group">
      <label for="password">Passwort</label>
      <input type="password" id="password" placeholder="••••••••" autocomplete="current-password" required/>
    </div>
    
    <button type="submit" class="btn" id="submitBtn">Anmelden</button>
    
    <div class="forgot-password">
      <button type="button" onclick="showPasswordReset()">Passwort vergessen?</button>
    </div>
  </form>
</div>

<div id="passwordResetScreen" class="screen">
  <form id="passwordResetForm">
    <div class="form-group">
      <label for="resetEmail">E-Mail</label>
      <input type="email" id="resetEmail" placeholder="deine@email.de" autocomplete="email" required/>
      <small>Du erhältst eine E-Mail mit einem Link zum Zurücksetzen</small>
    </div>
    
    <button type="submit" class="btn" id="resetBtn">Zurücksetzen</button>
    <button type="button" class="btn secondary" onclick="showLogin()">Zurück zum Login</button>
  </form>
</div>
```

  </div>
</div>

<script type="module">
  import PocketBase from 'https://cdn.jsdelivr.net/npm/pocketbase@0.21.3/dist/pocketbase.es.mjs';

  const pb = new PocketBase('https://api.responda.systems');
  
  const msgEl = document.getElementById('msg');
  const orgInfoEl = document.getElementById('orgInfo');
  const orgNameEl = document.getElementById('orgName');
  const orgInputGroupEl = document.getElementById('orgInputGroup');
  const orgCodeInputEl = document.getElementById('orgCode');
  const submitBtn = document.getElementById('submitBtn');
  const resetBtn = document.getElementById('resetBtn');
  const screenTitle = document.getElementById('screenTitle');
  const screenSubtitle = document.getElementById('screenSubtitle');

  const ORG_STORAGE_KEY = 'responda_org';
  const savedOrg = localStorage.getItem(ORG_STORAGE_KEY);
  let currentOrg = null;

  if (savedOrg) {
    try {
      currentOrg = JSON.parse(savedOrg);
      showSavedOrg();
      checkIfAlreadyLoggedIn();
    } catch(e) {
      localStorage.removeItem(ORG_STORAGE_KEY);
      showOrgInput();
    }
  }

  async function checkIfAlreadyLoggedIn() {
    if (!pb.authStore.isValid) return;
    try {
      await pb.collection('users').authRefresh();
      if (pb.authStore.model) showScreen('alreadyLoggedInScreen');
    } catch(e) {
      pb.authStore.clear();
    }
  }

  window.goToHub = () => location.href = 'hub.html';

  window.logoutAndContinue = async () => {
    pb.authStore.clear();
    showScreen('loginScreen');
    showMsg('Abgemeldet. Bitte melde dich neu an.', 'info');
    document.getElementById('email').focus();
  };

  function showSavedOrg() {
    orgInfoEl.classList.add('show');
    orgInputGroupEl.style.display = 'none';
    orgNameEl.textContent = currentOrg.name;
  }

  function showOrgInput() {
    orgInfoEl.classList.remove('show');
    orgInputGroupEl.style.display = 'block';
  }

  window.changeOrg = () => {
    if (confirm('Organisation wirklich ändern? Du wirst abgemeldet.')) {
      pb.authStore.clear();
      localStorage.removeItem(ORG_STORAGE_KEY);
      currentOrg = null;
      showOrgInput();
      showMsg('Bitte gib deinen Organisations-Code neu ein.', 'info');
      orgCodeInputEl.focus();
    }
  };

  function showMsg(text, type = 'error') {
    msgEl.textContent = text;
    msgEl.className = 'msg ' + type + ' show';
    setTimeout(() => msgEl.classList.remove('show'), 8000);
  }

  function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(screenId).classList.add('active');
    
    if (screenId === 'loginScreen') {
      screenTitle.textContent = 'Willkommen';
      screenSubtitle.textContent = 'Melde dich an, um fortzufahren';
    } else if (screenId === 'passwordResetScreen') {
      screenTitle.textContent = 'Passwort zurücksetzen';
      screenSubtitle.textContent = 'Du erhältst eine E-Mail mit einem Link';
    } else if (screenId === 'alreadyLoggedInScreen') {
      screenTitle.textContent = 'Willkommen zurück';
      screenSubtitle.textContent = 'Du bist bereits angemeldet';
    }
  }

  window.showPasswordReset = () => {
    showScreen('passwordResetScreen');
    document.getElementById('resetEmail').focus();
  };

  window.showLogin = () => {
    showScreen('loginScreen');
    (currentOrg ? document.getElementById('email') : orgCodeInputEl).focus();
  };

  document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    submitBtn.disabled = true;
    submitBtn.textContent = 'Anmeldung läuft...';
    
    try {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      
      let orgConfig;
      
      if (currentOrg) {
        orgConfig = currentOrg;
      } else {
        const orgCode = orgCodeInputEl.value.trim().toLowerCase();
        
        if (!orgCode) {
          showMsg('Bitte gib deinen Organisations-Code ein.', 'error');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Anmelden';
          return;
        }
        
        const allOrgs = await pb.collection('organizations').getFullList();
        const org = allOrgs.find(o => o.org_code === orgCode);
        
        if (!org) {
          showMsg('Organisation nicht gefunden!', 'error');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Anmelden';
          return;
        }
        
        orgConfig = { code: orgCode, name: org.org_name, id: org.id };
      }
      
      const authData = await pb.collection('users').authWithPassword(email, password);
      
      if (!authData?.record) {
        showMsg('Login fehlgeschlagen.', 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Anmelden';
        return;
      }
      
      if (authData.record.organization_id !== orgConfig.id) {
        showMsg('Dieser Benutzer gehört nicht zu dieser Organisation!', 'error');
        pb.authStore.clear();
        submitBtn.disabled = false;
        submitBtn.textContent = 'Anmelden';
        return;
      }
      
      if (!currentOrg) {
        localStorage.setItem(ORG_STORAGE_KEY, JSON.stringify(orgConfig));
      }
      
      showMsg('Erfolgreich angemeldet!', 'success');
      setTimeout(() => location.href = 'hub.html', 800);
      
    } catch(e) {
      let errorMsg = e.status === 400 ? 'Ungültige E-Mail oder Passwort.' : ('Login fehlgeschlagen: ' + (e.message || 'Fehler'));
      showMsg(errorMsg, 'error');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Anmelden';
    }
  });

  document.getElementById('passwordResetForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    resetBtn.disabled = true;
    resetBtn.textContent = 'Sende E-Mail...';
    
    try {
      const email = document.getElementById('resetEmail').value.trim();
      await pb.collection('users').requestPasswordReset(email);
      showMsg('E-Mail zum Zurücksetzen wurde gesendet!', 'success');
      setTimeout(() => showLogin(), 3000);
    } catch(e) {
      showMsg('Fehler beim Senden: ' + e.message, 'error');
      resetBtn.disabled = false;
      resetBtn.textContent = 'Zurücksetzen';
    }
  });

  (currentOrg ? document.getElementById('email') : orgCodeInputEl).focus();
</script>

</body>
</html>
