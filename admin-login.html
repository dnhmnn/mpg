<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Login</title>
<link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{--rot:#c8102e}
  *{box-sizing:border-box}
  body{font-family:'Atkinson Hyperlegible',Arial,sans-serif;background:#f7f7f7;margin:0;min-height:100vh;display:flex;flex-direction:column}
  header{background:var(--rot);color:#fff;display:flex;gap:12px;align-items:center;padding:10px 16px}
  header img{height:42px;width:auto}
  header strong{font-size:1.05rem}
  .debug{background:#fff5f5;border-left:4px solid var(--rot);padding:8px 10px;margin:12px auto;max-width:460px;border-radius:8px;font-size:.95rem}
  main{max-width:460px;margin:10px auto 24px;background:#fff;border-radius:12px;box-shadow:0 3px 12px #0001;padding:18px;width:calc(100% - 24px)}
  h1{margin:0 0 10px;color:var(--rot);font-size:1.35rem}
  label{font-weight:700;color:var(--rot);display:block;margin-top:10px}
  input{width:100%;padding:11px;border:1px solid #ccc;border-radius:8px;background:#fafafa;font-size:1rem}
  button{margin-top:14px;background:var(--rot);color:#fff;border:0;border-radius:8px;padding:11px 14px;font-weight:700;cursor:pointer;width:100%;font-size:1rem}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .row button{flex:1}
  .msg{min-height:1.2em;margin-top:8px}
  .ok{color:#2e7d32}
  .err{color:#c8102e}
  .hint{color:#666;font-size:.92rem;margin-top:8px}
  .hidden{display:none}
  .link{display:inline-block;margin-top:10px;color:#c8102e;text-decoration:underline;cursor:pointer}
</style>
</head>
<body>
<header>
  <img src="logo.png" onerror="this.src='assets/logo.png'" alt="Logo">
  <strong>FFW – Admin-Login</strong>
</header>

<div id="dbg" class="debug">Nhost Status: wird geprüft …</div>

<main>
  <h1>Admin Login</h1>

  <!-- Login-Form -->
  <form id="loginForm">
    <label for="email">E-Mail</label>
    <input id="email" type="email" placeholder="daniel@heilmann.bayern" autocomplete="username" required />

    <label for="pw">Passwort</label>
    <input id="pw" type="password" placeholder="••••••••" autocomplete="current-password" required />

    <button type="submit">Anmelden</button>

    <!-- NEU: Passwort vergessen -->
    <a href="#" id="forgot" class="link">Passwort vergessen?</a>
  </form>

  <!-- Wenn schon eingeloggt -->
  <div id="already" class="hidden">
    <div class="ok" style="margin-top:8px">Bereits angemeldet als <b id="who">—</b>.</div>
    <div class="row">
      <button id="goDash">Weiter zum Dashboard</button>
      <button id="doLogout" style="background:#ddd;color:#c8102e">Abmelden & neu anmelden</button>
    </div>
  </div>

  <div id="msg" class="msg"></div>
  <div class="hint">Hinweis: Für Tests kann „Email verification required“ in Nhost vorübergehend deaktiviert werden.</div>
</main>

<!-- ES-Module: stabiler Import -->
<script type="module">
  import { NhostClient } from "https://esm.sh/@nhost/nhost-js@2.2.9";

  const dbg = document.getElementById('dbg');
  const msg = document.getElementById('msg');
  const show = (t, ok=false)=>{ msg.textContent=t; msg.className='msg ' + (ok?'ok':'err'); };

  const nhost = new NhostClient({
    subdomain: "hpjfrhktprpuuxvvlpsb",
    region: "eu-central-1"
  });

  // Healthcheck
  try{
    const res = await fetch("https://backend-hpjfrhktprpuuxvvlpsb.eu-central-1.nhost.run/v1/healthz", {mode:"cors"});
    dbg.textContent = "Nhost Status: " + (res.ok ? "OK" : res.status+" "+res.statusText);
  }catch(e){
    dbg.textContent = "Nhost Status: NICHT ERREICHBAR ("+ e.message +")";
  }

  const form = document.getElementById('loginForm');
  const alreadyBox = document.getElementById('already');
  const whoEl = document.getElementById('who');
  const goDash = document.getElementById('goDash');
  const doLogout = document.getElementById('doLogout');
  const forgot = document.getElementById('forgot');

  // Session prüfen
  const session = await nhost.auth.getSession();
  if (session?.user) {
    // Schon eingeloggt
    whoEl.textContent = session.user.email || '—';
    form.classList.add('hidden');
    alreadyBox.classList.remove('hidden');
  }

  // Weiter zum Dashboard
  goDash.addEventListener('click', (e)=>{
    e.preventDefault();
    location.href = "admin-dashboard.html";
  });

  // Abmelden & neu anmelden
  doLogout.addEventListener('click', async (e)=>{
    e.preventDefault();
    try{ await nhost.auth.signOut(); }catch(_){}
    try{ localStorage.removeItem('isAdmin'); localStorage.removeItem('adminEmail'); }catch(_){}
    // Formular wieder zeigen
    alreadyBox.classList.add('hidden');
    form.classList.remove('hidden');
    show('Abgemeldet. Bitte erneut anmelden.', true);
  });

  // Normales Login
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    show('Anmeldung läuft …', true);
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('pw').value;

    // Falls doch noch eine Session bestehen sollte, vorher abmelden
    try{ await nhost.auth.signOut(); }catch(_){}

    const { error } = await nhost.auth.signIn({ email, password });
    if (error){ show('Login fehlgeschlagen: ' + (error.message || 'Unbekannter Fehler')); return; }

    try{ localStorage.setItem('isAdmin','1'); localStorage.setItem('adminEmail', email); }catch(_){}
    show('Login erfolgreich. Weiterleiten …', true);
    setTimeout(()=>location.href='admin-dashboard.html', 600);
  });

  // NEU: Passwort vergessen
  forgot.addEventListener('click', async (e)=>{
    e.preventDefault();
    // E-Mail aus dem Feld nehmen – oder abfragen
    let email = (document.getElementById('email').value || '').trim();
    if (!email) {
      email = prompt("Bitte E-Mail für den Reset-Link eingeben:")?.trim() || '';
    }
    if (!email) { show('E-Mail wird benötigt.'); return; }

    try {
      // Nach Klick in der E-Mail wird der Nutzer automatisch eingeloggt
      // und auf change-password.html geleitet.
      await nhost.auth.resetPassword({
        email,
        redirectTo: location.origin + "/change-password.html"
      });
      show('Reset-Link gesendet. Bitte Postfach prüfen.', true);
    } catch (err) {
      show('Reset fehlgeschlagen: ' + (err?.message || err));
    }
  });
</script>

<script nomodule>
  document.getElementById('dbg').textContent = "Ihr Browser unterstützt keine ES-Module. Bitte aktualisieren.";
</script>
</body>
</html>