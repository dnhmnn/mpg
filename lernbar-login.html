<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Login ‚Äì Lernbar</title>
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/pocketbase@0.21.3/dist/pocketbase.umd.js"></script>

  <style>
    :root{
      --primary:#c8102e;
      --success:#16a34a;
      --error:#dc2626;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
    }
    
    *{box-sizing:border-box}
    
    html, body{
      margin:0;
      padding:0;
      height:100%;
      width:100%;
    }
    
    body{
      background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-attachment:fixed;
      font-family:'Atkinson Hyperlegible',-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      min-height:100vh;
    }
    
    .login-card{
      background:#fff;
      border-radius:16px;
      padding:3rem;
      max-width:500px;
      width:100%;
      box-shadow:0 20px 60px rgba(0,0,0,.3);
      animation:slideUp 0.5s ease-out;
    }
    
    @keyframes slideUp{
      from{opacity:0;transform:translateY(30px)}
      to{opacity:1;transform:translateY(0)}
    }
    
    .logo{
      text-align:center;
      margin-bottom:2.5rem;
    }
    .logo i{
      font-size:5rem;
      color:var(--primary);
      margin-bottom:1rem;
    }
    .logo h1{
      margin:0;
      font-size:2.5rem;
      color:var(--primary);
      font-weight:800;
    }
    .logo p{
      margin:.75rem 0 0 0;
      color:var(--muted);
      font-size:1.1rem;
    }
    
    .form-group{
      margin-bottom:1.5rem;
    }
    .form-group label{
      display:block;
      font-weight:700;
      margin-bottom:.5rem;
      color:var(--text);
      font-size:1rem;
    }
    .form-group input{
      width:100%;
      padding:1rem;
      border:2px solid var(--border);
      border-radius:8px;
      font-size:1.1rem;
      font-family:inherit;
      transition:all 0.2s;
    }
    .form-group input:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 4px rgba(200,16,46,0.1);
    }
    .form-group input::placeholder{
      color:#9ca3af;
    }
    
    .btn{
      width:100%;
      padding:1.1rem;
      background:var(--primary);
      color:#fff;
      border:none;
      border-radius:8px;
      font-weight:700;
      font-size:1.1rem;
      cursor:pointer;
      transition:all 0.2s;
      font-family:inherit;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:.75rem;
      margin-top:2rem;
    }
    .btn:hover:not(:disabled){
      background:#a00d25;
      transform:translateY(-2px);
      box-shadow:0 8px 24px rgba(200,16,46,.3);
    }
    .btn:disabled{
      opacity:0.6;
      cursor:not-allowed;
    }
    
    .error-msg{
      background:#fee2e2;
      color:#dc2626;
      padding:1rem;
      border-radius:8px;
      margin-bottom:1.5rem;
      font-weight:700;
      display:none;
      align-items:center;
      gap:.5rem;
      border-left:4px solid #dc2626;
      animation:shake 0.5s;
    }
    .error-msg.show{
      display:flex;
    }
    
    @keyframes shake{
      0%, 100%{transform:translateX(0)}
      25%{transform:translateX(-10px)}
      75%{transform:translateX(10px)}
    }
    
    .info-box{
      background:#eff6ff;
      padding:1.25rem;
      border-radius:8px;
      margin-top:2rem;
      border-left:4px solid #3b82f6;
      color:#1e40af;
      font-size:.95rem;
      line-height:1.6;
    }
    .info-box strong{
      display:block;
      margin-bottom:.5rem;
      font-size:1rem;
    }
    
    .access-code-input{
      text-align:center;
      font-size:1.3rem;
      font-weight:700;
      letter-spacing:2px;
      text-transform:lowercase;
      font-family:monospace;
    }
    
    @media (max-width:600px){
      .login-card{
        padding:2rem;
      }
      .logo h1{
        font-size:2rem;
      }
      .logo i{
        font-size:4rem;
      }
    }
  </style>
</head>

<body>

<div class="login-card">
  <div class="logo">
    <i class="fa-solid fa-graduation-cap"></i>
    <h1>Lernbar</h1>
    <p>Responda Ausbildungsverwaltung</p>
  </div>

  <div class="error-msg" id="errorMsg">
    <i class="fas fa-exclamation-circle"></i>
    <span id="errorText"></span>
  </div>

  <!-- ZUGANGSCODE LOGIN -->
  <form id="accessCodeForm">
    <div class="form-group">
      <label for="accessCode">
        <i class="fa-solid fa-key"></i> Dein Zugangscode
      </label>
      <input 
        type="text" 
        id="accessCode" 
        class="access-code-input"
        placeholder="wort.wort.wort" 
        required
        autocomplete="off"
        pattern="[a-z]+\.[a-z]+\.[a-z]+"
      >
      <small style="color:var(--muted);font-size:.9rem;display:block;margin-top:.5rem">
        Format: wort.wort.wort (z.B. schnell.apfel.laufen)
      </small>
    </div>

    <button type="submit" class="btn" id="loginBtn">
      <i class="fa-solid fa-sign-in-alt"></i>
      Anmelden
    </button>
  </form>

  <div class="info-box">
    <strong><i class="fas fa-info-circle"></i> Hinweis:</strong>
    Du hast deinen Zugangscode von deinem Ausbilder erhalten. Er besteht aus drei deutschen W√∂rtern, getrennt durch Punkte.
  </div>
</div>

<script type="module">
  const pb = new PocketBase('https://api.responda.systems');

  // ========================================
  // CHECK IF ALREADY LOGGED IN
  // ========================================
  if (pb.authStore.isValid && pb.authStore.model) {
    const user = pb.authStore.model;
    // Pr√ºfe ob es ein Student ist (hat access_code)
    if (user.access_code) {
      console.log('‚úÖ Bereits als Student angemeldet');
      location.href = '/lernbar.html';
    } else {
      console.log('‚ö†Ô∏è Angemeldet aber kein Student - logout');
      pb.authStore.clear();
    }
  }

  // ========================================
  // ACCESS CODE LOGIN
  // ========================================
  document.getElementById('accessCodeForm').onsubmit = async (e) => {
    e.preventDefault();
    
    const accessCode = document.getElementById('accessCode').value.trim().toLowerCase();
    const loginBtn = document.getElementById('loginBtn');
    
    // Validierung
    if (!accessCode || !accessCode.match(/^[a-z]+\.[a-z]+\.[a-z]+$/)) {
      showError('‚ùå Bitte gib einen g√ºltigen Zugangscode ein (z.B. schnell.apfel.laufen)');
      return;
    }
    
    // Button deaktivieren
    loginBtn.disabled = true;
    loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Anmelden...';
    
    try {
      console.log('üîç Suche Student mit Access-Code:', accessCode);
      
      // Suche User mit diesem Zugangscode
      const students = await pb.collection('training_students').getFullList({
        filter: `access_code = "${accessCode}"`
      });
      
      console.log('üìä Gefundene Studenten:', students.length);
      
      if (students.length === 0) {
        showError('‚ùå Ung√ºltiger Zugangscode. Bitte √ºberpr√ºfe deine Eingabe.');
        loginBtn.disabled = false;
        loginBtn.innerHTML = '<i class="fa-solid fa-sign-in-alt"></i> Anmelden';
        return;
      }
      
      const student = students[0];
      console.log('üë§ Student gefunden:', student.name);
      console.log('üîë plain_password vorhanden:', !!student.plain_password);
      
      // Pr√ºfe ob plain_password vorhanden ist
      if (!student.plain_password) {
        console.error('‚ùå Kein plain_password vorhanden');
        showError('‚ùå Login-Daten nicht vollst√§ndig. Bitte kontaktiere deinen Ausbilder.');
        loginBtn.disabled = false;
        loginBtn.innerHTML = '<i class="fa-solid fa-sign-in-alt"></i> Anmelden';
        return;
      }
      
      console.log('üîê Versuche Login mit Email:', student.email);
      
      // Login mit Email und gespeichertem Passwort
      await pb.collection('training_students').authWithPassword(
        student.email,
        student.plain_password
      );
      
      console.log('‚úÖ Login erfolgreich!');
      
      // Weiterleitung
      loginBtn.innerHTML = '<i class="fas fa-check"></i> Erfolgreich!';
      
      setTimeout(() => {
        location.href = '/lernbar.html';
      }, 500);
      
    } catch(e) {
      console.error('‚ùå Login Fehler:', e);
      showError('‚ùå Anmeldung fehlgeschlagen: ' + e.message);
      loginBtn.disabled = false;
      loginBtn.innerHTML = '<i class="fa-solid fa-sign-in-alt"></i> Anmelden';
    }
  };

  // ========================================
  // ERROR HANDLING
  // ========================================
  function showError(message) {
    const errorMsg = document.getElementById('errorMsg');
    const errorText = document.getElementById('errorText');
    
    errorText.textContent = message;
    errorMsg.classList.add('show');
    
    setTimeout(() => {
      errorMsg.classList.remove('show');
    }, 8000);
  }

  // Auto-lowercase und Format-Validierung
  document.getElementById('accessCode').addEventListener('input', (e) => {
    e.target.value = e.target.value.toLowerCase();
  });

</script>

</body>
</html>
