<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Lernbar Login ‚Äì Responda</title>
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/pocketbase@0.21.3/dist/pocketbase.umd.js"></script>

  <style>
    :root{
      --primary:#c8102e;
      --success:#16a34a;
      --error:#dc2626;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
    }
    
    *{box-sizing:border-box}
    
    html, body{
      margin:0;
      padding:0;
      height:100%;
      width:100%;
    }
    
    body{
      background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-attachment:fixed;
      font-family:'Atkinson Hyperlegible',-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      min-height:100vh;
    }
    
    .login-card{
      background:#fff;
      border-radius:16px;
      padding:3rem;
      max-width:500px;
      width:100%;
      box-shadow:0 20px 60px rgba(0,0,0,.3);
      animation:slideUp 0.5s ease-out;
    }
    
    @keyframes slideUp{
      from{opacity:0;transform:translateY(30px)}
      to{opacity:1;transform:translateY(0)}
    }
    
    .logo{
      text-align:center;
      margin-bottom:2.5rem;
    }
    .logo i{
      font-size:5rem;
      color:var(--primary);
      margin-bottom:1rem;
    }
    .logo h1{
      margin:0;
      font-size:2.5rem;
      color:var(--primary);
      font-weight:800;
    }
    .logo p{
      margin:.75rem 0 0 0;
      color:var(--muted);
      font-size:1.1rem;
    }
    
    .form-group{
      margin-bottom:1.5rem;
    }
    .form-group label{
      display:block;
      font-weight:700;
      margin-bottom:.5rem;
      color:var(--text);
      font-size:1rem;
    }
    .form-group input{
      width:100%;
      padding:1rem;
      border:2px solid var(--border);
      border-radius:8px;
      font-size:1.1rem;
      font-family:inherit;
      transition:all 0.2s;
    }
    .form-group input:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 4px rgba(200,16,46,0.1);
    }
    .form-group input::placeholder{
      color:#9ca3af;
    }
    
    .btn{
      width:100%;
      padding:1.1rem;
      background:var(--primary);
      color:#fff;
      border:none;
      border-radius:8px;
      font-weight:700;
      font-size:1.1rem;
      cursor:pointer;
      transition:all 0.2s;
      font-family:inherit;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:.75rem;
      margin-top:2rem;
    }
    .btn:hover:not(:disabled){
      background:#a00d25;
      transform:translateY(-2px);
      box-shadow:0 8px 24px rgba(200,16,46,.3);
    }
    .btn:disabled{
      opacity:0.6;
      cursor:not-allowed;
    }
    
    .error-msg{
      background:#fee2e2;
      color:#dc2626;
      padding:1rem;
      border-radius:8px;
      margin-bottom:1.5rem;
      font-weight:700;
      display:none;
      align-items:center;
      gap:.5rem;
      border-left:4px solid #dc2626;
      animation:shake 0.5s;
    }
    .error-msg.show{
      display:flex;
    }
    
    @keyframes shake{
      0%, 100%{transform:translateX(0)}
      25%{transform:translateX(-10px)}
      75%{transform:translateX(10px)}
    }
    
    .info-box{
      background:#eff6ff;
      padding:1.25rem;
      border-radius:8px;
      margin-top:2rem;
      border-left:4px solid #3b82f6;
      color:#1e40af;
      font-size:.95rem;
      line-height:1.6;
    }
    .info-box strong{
      display:block;
      margin-bottom:.5rem;
      font-size:1rem;
    }
    
    @media (max-width:600px){
      .login-card{
        padding:2rem;
      }
      .logo h1{
        font-size:2rem;
      }
      .logo i{
        font-size:4rem;
      }
    }
  </style>
</head>

<body>

<div class="login-card">
  <div class="logo">
    <i class="fa-solid fa-graduation-cap"></i>
    <h1>Lernbar</h1>
    <p>Responda Ausbildungsverwaltung</p>
  </div>

  <div class="error-msg" id="errorMsg">
    <i class="fas fa-exclamation-circle"></i>
    <span id="errorText"></span>
  </div>

  <!-- LOGIN FORM -->
  <form id="loginForm">
    <div class="form-group">
      <label for="email">
        <i class="fa-solid fa-envelope"></i> E-Mail
      </label>
      <input 
        type="email" 
        id="email" 
        placeholder="deine@email.de" 
        required
        autocomplete="email"
      >
    </div>
    
    <div class="form-group">
      <label for="password">
        <i class="fa-solid fa-lock"></i> Passwort
      </label>
      <input 
        type="password" 
        id="password" 
        placeholder="Dein Passwort" 
        required
        autocomplete="current-password"
      >
    </div>

    <button type="submit" class="btn" id="loginBtn">
      <i class="fa-solid fa-sign-in-alt"></i>
      Anmelden
    </button>
  </form>

  <div class="info-box">
    <strong><i class="fas fa-info-circle"></i> Hinweis:</strong>
    Nutze deine normale Responda E-Mail und dein Passwort.
  </div>
</div>

<script type="module">
  const pb = new PocketBase('https://api.responda.systems');

  // Check if already logged in
  if (pb.authStore.isValid && pb.authStore.model) {
    const user = pb.authStore.model;
    // Pr√ºfe ob Lernbar-Zugriff
    if (user.lernbar_access || (user.permissions && user.permissions.lernbar)) {
      console.log('‚úÖ Bereits angemeldet mit Lernbar-Zugriff');
      location.href = '/lernbar.html';
    } else {
      console.log('‚ö†Ô∏è Angemeldet aber kein Lernbar-Zugriff');
      pb.authStore.clear();
    }
  }

  // ========================================
  // LOGIN
  // ========================================
  document.getElementById('loginForm').onsubmit = async (e) => {
    e.preventDefault();
    
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const loginBtn = document.getElementById('loginBtn');
    
    loginBtn.disabled = true;
    loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Anmelden...';
    
    try {
      console.log('üîê Login Versuch:', email);
      
      // Login
      await pb.collection('users').authWithPassword(email, password);
      
      const user = pb.authStore.model;
      
      console.log('‚úÖ Login erfolgreich!');
      console.log('User:', {
        id: user.id,
        email: user.email,
        name: user.name,
        lernbar_access: user.lernbar_access,
        permissions: user.permissions
      });
      
      // Pr√ºfe Lernbar-Zugriff
      const hasLernbarAccess = user.lernbar_access === true || 
                               (user.permissions && user.permissions.lernbar === true);
      
      if (!hasLernbarAccess) {
        console.log('‚ùå Kein Lernbar-Zugriff');
        pb.authStore.clear();
        showError('‚ùå Du hast keine Berechtigung f√ºr die Lernbar. Bitte kontaktiere deinen Administrator.');
        loginBtn.disabled = false;
        loginBtn.innerHTML = '<i class="fa-solid fa-sign-in-alt"></i> Anmelden';
        return;
      }
      
      loginBtn.innerHTML = '<i class="fas fa-check"></i> Erfolgreich!';
      
      setTimeout(() => {
        location.href = '/lernbar.html';
      }, 500);
      
    } catch(e) {
      console.error('‚ùå Login Fehler:', e);
      
      let errorMsg = 'Anmeldung fehlgeschlagen.';
      
      if (e.status === 400) {
        errorMsg = '‚ùå Falsche E-Mail oder Passwort.';
      } else if (e.status === 404) {
        errorMsg = '‚ùå Benutzer nicht gefunden.';
      } else {
        errorMsg = '‚ùå ' + e.message;
      }
      
      showError(errorMsg);
      loginBtn.disabled = false;
      loginBtn.innerHTML = '<i class="fa-solid fa-sign-in-alt"></i> Anmelden';
    }
  };

  // ========================================
  // ERROR HANDLING
  // ========================================
  function showError(message) {
    const errorMsg = document.getElementById('errorMsg');
    const errorText = document.getElementById('errorText');
    
    errorText.textContent = message;
    errorMsg.classList.add('show');
    
    setTimeout(() => {
      errorMsg.classList.remove('show');
    }, 8000);
  }

</script>

</body>
</html>
