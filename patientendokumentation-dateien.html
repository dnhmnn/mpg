<!DOCTYPE html>

<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dokumentenverwaltung – Responda</title>
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/pocketbase@0.21.3/dist/pocketbase.umd.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.6.0/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root{--primary:#c8102e;--bg:#f8fafc;--card:#fff;--text:#0f172a;--muted:#64748b;--border:#e2e8f0;--gradient-start:#667eea;--gradient-end:#764ba2}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);min-height:100vh;color:var(--text);font-family:'Atkinson Hyperlegible',-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;line-height:1.45;opacity:0;transition:opacity 0.3s}
    body.loaded{opacity:1}
    header{position:sticky;top:0;background:var(--gradient-start);color:#fff;z-index:10}
    .bar{max-width:1200px;margin:0 auto;padding:.75rem 1rem;display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    h1{font-size:1.05rem;margin:0;font-weight:800}
    .toolbar{margin-left:auto;display:flex;gap:.5rem;flex-wrap:wrap}
    .topbtn{border:1px solid rgba(255,255,255,0.3);background:rgba(255,255,255,0.1);color:#fff;padding:.45rem .7rem;border-radius:.5rem;cursor:pointer;font-weight:700;font-size:.9rem;transition:all 0.2s;text-decoration:none;display:inline-flex;align-items:center;gap:6px}
    .topbtn:hover{background:rgba(255,255,255,0.2)}
    .wrap{max-width:1200px;margin:1rem auto;padding:0 1rem 100px}
    .card{background:var(--card);border-radius:14px;box-shadow:0 3px 12px rgba(0,0,0,.06);padding:20px;margin-bottom:20px}
    .card h2{margin-top:0;color:var(--primary);font-weight:800}
    .tabs{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap}
    .tab{border:1px solid var(--border);background:#fafafa;padding:10px 16px;border-radius:999px;font-weight:800;cursor:pointer;font-size:0.95rem;transition:all 0.2s;display:inline-flex;align-items:center;gap:6px}
    .tab:hover{background:#f0f0f0}
    .tab.active{color:#fff;background:var(--primary);border-color:var(--primary)}
    .table-head,.row{display:grid;grid-template-columns:120px 1fr 280px;gap:12px;padding:14px 10px;align-items:center;border-bottom:1px solid var(--border)}
    .table-head{font-weight:800;color:#666;background:#fafafa;border-radius:8px 8px 0 0}
    .row:last-child{border-bottom:none}
    .row:hover{background:#f9f9f9}
    .pill{display:inline-block;font-weight:800;border-radius:999px;padding:5px 12px;font-size:0.85rem}
    .pill.offen{background:#fef3c7;color:#92400e}
    .pill.archiviert{background:#dcfce7;color:#166534}
    .btn{background:var(--primary);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer;font-size:0.9rem;transition:all 0.2s;display:inline-flex;align-items:center;gap:6px;font-family:inherit}
    .btn:hover{background:#a00d26;transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
    .btn-secondary{background:#6b7280;color:#fff}
    .btn-secondary:hover{background:#4b5563}
    .btn-icon{background:transparent;color:var(--primary);border:1px solid var(--primary);padding:8px 12px;font-size:0.85rem}
    .btn-icon:hover{background:#fff5f5;transform:translateY(-1px)}
    .add-btn{position:fixed;bottom:30px;right:30px;width:60px;height:60px;border-radius:50%;background:var(--primary);color:#fff;border:0;cursor:pointer;font-size:1.5rem;box-shadow:0 4px 12px rgba(0,0,0,.2);z-index:100;transition:transform 0.2s}
    .add-btn:hover{transform:scale(1.1)}
    .add-btn:active{transform:scale(0.95)}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:flex-start;justify-content:center;z-index:1000;padding:20px;overflow-y:auto}
    .modal.show{display:flex}
    .modal-box{background:#fff;border-radius:14px;max-width:1200px;width:100%;max-height:90vh;overflow-y:auto;padding:24px;box-shadow:0 8px 20px rgba(0,0,0,.3);margin:auto}
    .modal-box h3{margin-top:0;color:var(--primary);font-weight:800}
    details{background:var(--card);border:1px solid var(--border);border-radius:.75rem;margin:0 0 .8rem 0;overflow:hidden}
    summary{list-style:none;padding:.9rem 1rem;cursor:pointer;font-weight:800;display:flex;align-items:center;gap:.6rem;font-size:1rem;background:#fafafa;transition:background 0.2s}
    summary::-webkit-details-marker{display:none}
    summary:hover{background:#f0f0f0}
    details[open] summary{border-bottom:1px solid var(--border);background:#fff7f7}
    .sec-body{padding:1rem}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:.75rem}
    label{font-size:.92rem;color:#111827;font-weight:600}
    input[type="text"],input[type="number"],input[type="datetime-local"],input[type="date"],input[type="time"],textarea,select{width:100%;padding:.55rem .6rem;border:1px solid var(--border);border-radius:.5rem;background:#fff;font-size:16px;font-family:inherit;transition:border-color 0.2s}
    input:focus,textarea:focus,select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(200,16,46,0.1)}
    textarea{min-height:88px;resize:vertical}
    table{width:100%;border-collapse:collapse;margin-top:.5rem}
    th,td{border:1px solid var(--border);padding:.5rem;text-align:left;font-size:.9rem}
    th{background:#f8fafc;font-weight:700}
    .subbtn{border:1px solid var(--border);background:#fff;padding:.35rem .55rem;border-radius:.45rem;cursor:pointer;font-size:.9rem;font-weight:600;font-family:inherit;transition:all 0.2s}
    .subbtn:hover{background:#f8fafc;border-color:var(--primary)}
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;margin:16px 0}
    .form-group{display:flex;flex-direction:column;gap:6px}
    .form-group label{font-weight:700;font-size:0.9rem;color:#374151}
    .form-group input,.form-group textarea,.form-group select{padding:10px 12px;border:1px solid #d1d5db;border-radius:8px;font-size:16px;font-family:inherit}
    .radio-group{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    .radio-group label{display:flex;align-items:center;gap:6px;font-weight:600;cursor:pointer}
    .sig-wrap{border:2px dashed #d1d5db;border-radius:8px;padding:12px;background:#f9fafb;margin:16px 0}
    canvas.sig-canvas{width:100%;height:200px;border:1px solid #d1d5db;border-radius:6px;background:#fff;cursor:crosshair;touch-action:none;display:block}
    .sig-actions{margin-top:8px;display:flex;gap:8px}
    .msg{margin-top:12px;padding:12px;border-radius:8px}
    .msg.error{background:#fee;color:#c00;border:1px solid #fcc}
    .msg.success{background:#efe;color:#060;border:1px solid #cfc}
    .details-grid{display:grid;grid-template-columns:200px 1fr;gap:12px 20px;margin:16px 0}
    .details-label{font-weight:700;color:#6b7280}
    .details-value{color:#111827;word-break:break-word}
    .signature-img{max-width:400px;max-height:200px;border:1px solid #d1d5db;border-radius:6px;margin-top:8px}
    @media (max-width:768px){.table-head,.row{grid-template-columns:1fr !important;gap:8px}.modal-box{padding:16px}.form-grid{grid-template-columns:1fr}.details-grid{grid-template-columns:1fr;gap:4px}.add-btn{bottom:20px;right:20px;width:56px;height:56px;font-size:1.3rem}.grid{grid-template-columns:1fr}h1{font-size:.95rem}.topbtn{font-size:.85rem;padding:.4rem .6rem}}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <h1><i class="fa-solid fa-file-medical"></i> Patientendokumentation</h1>
      <div class="toolbar">
        <a class="topbtn" href="mpg-dashboard.html"><i class="fa-solid fa-dashboard"></i> Dashboard</a>
        <button class="topbtn" id="logout"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
      </div>
    </div>
  </header>
  <div class="wrap">
    <section class="card">
      <h2>Dokumentenverwaltung</h2>
      <div class="tabs">
        <button class="tab active" data-tab="pat"><i class="fa-solid fa-file-medical"></i> Patientendokus (Offen)</button>
        <button class="tab" data-tab="nach"><i class="fa-solid fa-clipboard-list"></i> Nacherfassungen (Offen)</button>
        <button class="tab" data-tab="archiv"><i class="fa-solid fa-box-archive"></i> Archiv</button>
      </div>
      <div id="tab-pat" class="tab-content">
        <div class="table-head"><div>Status</div><div>Dokument</div><div>Aktionen</div></div>
        <div id="pat-rows"></div>
      </div>
      <div id="tab-nach" class="tab-content" style="display:none">
        <div class="table-head"><div>Status</div><div>Nacherfassung</div><div>Aktionen</div></div>
        <div id="nach-rows"></div>
      </div>
      <div id="tab-archiv" class="tab-content" style="display:none">
        <div class="table-head"><div>Typ</div><div>Dokument</div><div>Aktionen</div></div>
        <div id="archiv-rows"></div>
      </div>
      <div id="msg"></div>
    </section>
  </div>
  <button class="add-btn" id="addBtn" title="Neue Nacherfassung"><i class="fa-solid fa-plus"></i></button>

  <div class="modal" id="editModal">
    <div class="modal-box">
      <h3><i class="fa-solid fa-edit"></i> Patientendokumentation bearbeiten</h3>
      <div id="editFormContainer"></div>
      <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end;position:sticky;bottom:0;background:#fff;padding-top:16px;border-top:2px solid var(--border)">
        <button class="btn btn-secondary" onclick="closeEditModal()"><i class="fa-solid fa-times"></i> Abbrechen</button>
        <button class="btn" onclick="saveAndSignPatDoc()"><i class="fa-solid fa-save"></i> Speichern & Gegenzeichnen</button>
      </div>
    </div>
  </div>

  <div class="modal" id="signModal">
    <div class="modal-box" style="max-width:600px">
      <h3><i class="fa-solid fa-signature"></i> Verantwortlicher / MPG-Beauftragter</h3>
      <p>Dokument wurde geprüft und ist korrekt. Mit Unterschrift wird es ins Archiv verschoben.</p>
      <div class="form-group">
        <label>Name (Verantwortlicher / MPG-Beauftragter):</label>
        <input type="text" id="adminName" placeholder="Ihr Name">
      </div>
      <div class="sig-wrap">
        <label style="font-weight:700;margin-bottom:8px;display:block">Unterschrift:</label>
        <canvas id="adminSigCanvas" class="sig-canvas"></canvas>
        <div class="sig-actions">
          <button class="btn btn-secondary" onclick="clearAdminSig()"><i class="fa-solid fa-eraser"></i> Löschen</button>
        </div>
      </div>
      <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end">
        <button class="btn btn-secondary" onclick="closeSignModal()">Abbrechen</button>
        <button class="btn" onclick="archiveWithSignature()"><i class="fa-solid fa-check"></i> Unterschreiben & Archivieren</button>
      </div>
    </div>
  </div>

  <div class="modal" id="detailsModal">
    <div class="modal-box">
      <h3 id="detailsTitle">Details</h3>
      <div id="detailsBody"></div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
        <button class="btn btn-secondary" onclick="closeDetailsModal()"><i class="fa-solid fa-times"></i> Schließen</button>
        <button class="btn" onclick="generatePDFFromModal()"><i class="fa-solid fa-file-pdf"></i> PDF erstellen</button>
      </div>
    </div>
  </div>

  <script type="module">
    const pb = new PocketBase('https://api.responda.systems');
    if (!pb.authStore.isValid) location.href = "/mpg-login.html";
    const currentUser = pb.authStore.model;
    if (!currentUser || !currentUser.organization_id) location.href = "/mpg-login.html";
    
    let currentOrganization = null;
    async function loadOrganization() {
      try {
        currentOrganization = await pb.collection('organizations').getOne(currentUser.organization_id);
        console.log('✅ Organization loaded:', currentOrganization);
      } catch(e) {
        console.error('❌ Error loading organization:', e);
      }
    }
    loadOrganization();
    
    document.getElementById("logout").onclick = async (e) => {
      e.preventDefault();
      pb.authStore.clear();
      localStorage.clear();
      location.href = "/mpg-login.html";
    };
    
    document.querySelectorAll('.tab').forEach(tab => {
      tab.onclick = () => {
        const targetTab = tab.dataset.tab;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = 'none');
        document.getElementById('tab-' + targetTab).style.display = 'block';
        document.getElementById('msg').textContent = '';
      };
    });
    
    async function loadData() {
      try {
        const patData = await pb.collection('patients').getFullList({
          filter: `status = "offen" && organization_id = "${currentUser.organization_id}"`,
          sort: '-created',
        });
        
        const patRows = document.getElementById('pat-rows');
        patRows.innerHTML = patData.map(doc => {
          const payload = doc.payload || {};
          const patName = `${payload.vorname || ''} ${payload.name || ''}`.trim() || 'Unbekannt';
          return `<div class="row"><div><span class="pill offen">${doc.status}</span></div><div><strong>${doc.title || patName}</strong><br><small style="color:#6b7280">${payload.einsatz_nr ? 'Einsatz-Nr: ' + payload.einsatz_nr + ' · ' : ''}${new Date(doc.created).toLocaleString('de-DE')}</small></div><div style="display:flex;gap:8px;flex-wrap:wrap"><button class="btn btn-icon" onclick="editPatDoc('${doc.id}')"><i class="fa-solid fa-edit"></i> Bearbeiten</button></div></div>`;
        }).join('') || '<p style="padding:20px;color:#999">Keine offenen Patientendokus</p>';
        
        const archivPat = await pb.collection('patients').getFullList({
          filter: `status = "archiviert" && organization_id = "${currentUser.organization_id}"`,
          sort: '-updated',
        });
        
        const archivRows = document.getElementById('archiv-rows');
        let archivHTML = '';
        archivPat.forEach(doc => {
          const payload = doc.payload || {};
          const patName = `${payload.vorname || ''} ${payload.name || ''}`.trim() || doc.title || 'Ohne Titel';
          archivHTML += `<div class="row"><div><span class="pill archiviert">Patientendoku</span></div><div><strong>${patName}</strong><br><small style="color:#6b7280">${payload.einsatz_nr ? 'Einsatz-Nr: ' + payload.einsatz_nr + ' · ' : ''}MPG-Verantwortlicher: ${doc.admin_name || '?'} · ${doc.admin_datum ? new Date(doc.admin_datum).toLocaleString('de-DE') : ''}</small></div><div style="display:flex;gap:8px;flex-wrap:wrap"><button class="btn btn-icon" onclick="viewPatArchiv('${doc.id}')"><i class="fa-solid fa-eye"></i> Ansehen</button></div></div>`;
        });
        archivRows.innerHTML = archivHTML || '<p style="padding:20px;color:#999">Kein Archiv vorhanden</p>';
      } catch(e) {
        showMsg('Fehler beim Laden: ' + e.message, 'error');
      }
    }
    
    function showMsg(text, type = 'success') {
      const msgDiv = document.getElementById('msg');
      msgDiv.textContent = text;
      msgDiv.className = 'msg ' + type;
      setTimeout(() => { msgDiv.textContent = ''; msgDiv.className = 'msg'; }, 5000);
    }
    
    let currentEditDoc = null;
    let currentEditPayload = null;
    let medRowCounter = 0;
    
    window.editPatDoc = async (id) => {
      try {
        currentEditDoc = await pb.collection('patients').getOne(id);
        currentEditPayload = currentEditDoc.payload || {};
        const formHTML = buildEditForm(currentEditPayload);
        document.getElementById('editFormContainer').innerHTML = formHTML;
        const meds = currentEditPayload.medications || [];
        medRowCounter = meds.length;
        document.getElementById('editModal').classList.add('show');
      } catch(e) {
        showMsg('Fehler: ' + e.message, 'error');
      }
    };
    
    function buildEditForm(payload) {
      const v = (key, fallback = '') => payload[key] !== undefined && payload[key] !== null ? payload[key] : fallback;
      const medications = payload.medications || [];
      let medRowsHTML = '';
      medications.forEach((med, idx) => {
        const i = idx + 1;
        medRowsHTML += `<tr><td>${i}</td><td><input type="text" name="med_name_${i}" value="${med.name || ''}" style="width:100%;padding:.3rem;font-size:14px"></td><td><input type="number" name="med_dose_${i}" value="${med.dose || ''}" step="0.1" style="width:80px;padding:.3rem;font-size:14px"></td><td><input type="text" name="med_unit_${i}" value="${med.unit || ''}" placeholder="mg" style="width:60px;padding:.3rem;font-size:14px"></td><td><select name="med_route_${i}" style="padding:.3rem;font-size:14px"><option value="">-</option><option value="i.v." ${med.route === 'i.v.' ? 'selected' : ''}>i.v.</option><option value="i.m." ${med.route === 'i.m.' ? 'selected' : ''}>i.m.</option><option value="s.c." ${med.route === 's.c.' ? 'selected' : ''}>s.c.</option><option value="p.o." ${med.route === 'p.o.' ? 'selected' : ''}>p.o.</option><option value="inhal." ${med.route === 'inhal.' ? 'selected' : ''}>inhal.</option></select></td><td><input type="time" name="med_time_${i}" value="${med.time || ''}" style="width:90px;padding:.3rem;font-size:14px"></td><td><input type="text" name="med_note_${i}" value="${med.note || ''}" style="width:100%;padding:.3rem;font-size:14px"></td><td><button class="subbtn" type="button" onclick="this.closest('tr').remove()">×</button></td></tr>`;
      });
      
      return `<details open><summary><i class="fa-solid fa-truck-medical"></i> Einsatzdaten</summary><div class="sec-body"><div class="grid"><label>Einsatz-Nr.<input name="einsatz_nr" type="text" value="${v('einsatz_nr')}"></label><label>Fahrzeug<input name="fahrzeug" type="text" value="${v('fahrzeug')}"></label><label>Datum/Uhrzeit<input name="zeit_einsatz" type="datetime-local" value="${v('zeit_einsatz')}"></label></div></div></details><details open><summary><i class="fa-solid fa-id-card-clip"></i> Pat-Stammdaten</summary><div class="sec-body"><div class="grid"><label>Name<input name="name" type="text" value="${v('name')}"></label><label>Vorname<input name="vorname" type="text" value="${v('vorname')}"></label><label>Geb.-Datum<input name="gebdatum" type="date" value="${v('gebdatum')}"></label><label>Alter<input name="alter" type="number" value="${v('alter')}"></label><label>Straße<input name="strasse" type="text" value="${v('strasse')}"></label><label>PLZ, Ort<input name="plz_ort" type="text" value="${v('plz_ort')}"></label></div></div></details><details open><summary><i class="fa-solid fa-notes-medical"></i> Notfallgeschehen</summary><div class="sec-body"><textarea name="notfallgeschehen">${v('notfallgeschehen')}</textarea></div></details><details open><summary><i class="fa-solid fa-stethoscope"></i> Messwerte</summary><div class="sec-body"><div class="grid"><label>RR syst. (mmHg)<input name="rr_sys" type="number" value="${v('rr_sys')}"></label><label>RR diast. (mmHg)<input name="rr_dia" type="number" value="${v('rr_dia')}"></label><label>HF (/min)<input name="hf" type="number" value="${v('hf')}"></label><label>AF (/min)<input name="af" type="number" value="${v('af')}"></label><label>SpO₂ (%)<input name="spo2" type="number" value="${v('spo2')}"></label><label>Temp (°C)<input name="temp" type="number" step="0.1" value="${v('temp')}"></label><label>BZ (mg/dl)<input name="bz_mg" type="number" value="${v('bz_mg')}"></label><label>Schmerz (0–10)<input name="schmerz" type="number" min="0" max="10" value="${v('schmerz')}"></label></div></div></details><details open><summary><i class="fa-solid fa-syringe"></i> Maßnahmen – Zugang & Medikation</summary><div class="sec-body"><fieldset><legend>Zugang</legend><div class="grid"><label>Art<select name="zugang_art"><option value="">-</option><option value="iv" ${v('zugang_art')==='iv'?'selected':''}>i.v.</option><option value="io" ${v('zugang_art')==='io'?'selected':''}>i.o.</option></select></label><label>Seite/Region<input name="zugang_region" type="text" value="${v('zugang_region')}"></label><label>Größe (G)<input name="zugang_gauge" type="number" min="14" max="24" value="${v('zugang_gauge')}"></label></div></fieldset><fieldset><legend>Medikamente</legend><button type="button" class="subbtn" onclick="addMedRowEdit()" style="margin-bottom:.5rem"><i class="fa-solid fa-plus"></i> Zeile hinzufügen</button><div style="overflow:auto"><table id="medTableEdit"><thead><tr><th>#</th><th>Medikament</th><th>Dosis</th><th>Einheit</th><th>Route</th><th>Uhrzeit</th><th>Bemerkung</th><th>×</th></tr></thead><tbody>${medRowsHTML}</tbody></table></div></fieldset></div></details><details open><summary><i class="fa-solid fa-people-carry-box"></i> Übergabe / Transport</summary><div class="sec-body"><div class="grid"><label>Übergabe an<input name="ue_name" type="text" value="${v('ue_name')}"></label><label>Zeitpunkt<input name="ue_zeit" type="datetime-local" value="${v('ue_zeit')}"></label><label>Ziel<input name="ziel_bez" type="text" value="${v('ziel_bez')}"></label><label>Einsatzende<input name="einsatzende" type="datetime-local" value="${v('einsatzende')}"></label></div></div></details><details open><summary><i class="fa-solid fa-signature"></i> Ausfüller</summary><div class="sec-body"><div class="grid"><label>Name<input name="ausfueller_name" type="text" value="${v('ausfueller_name')}"></label><label>Zeitpunkt<input name="ausfueller_zeit" type="datetime-local" value="${v('ausfueller_zeit')}"></label></div></div></details>`;

```
}

window.addMedRowEdit = function() {
  medRowCounter++;
  const tbody = document.querySelector('#medTableEdit tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `<td>${medRowCounter}</td><td><input type="text" name="med_name_${medRowCounter}" style="width:100%;padding:.3rem;font-size:14px"></td><td><input type="number" name="med_dose_${medRowCounter}" step="0.1" style="width:80px;padding:.3rem;font-size:14px"></td><td><input type="text" name="med_unit_${medRowCounter}" placeholder="mg" style="width:60px;padding:.3rem;font-size:14px"></td><td><select name="med_route_${medRowCounter}" style="padding:.3rem;font-size:14px"><option value="">-</option><option value="i.v.">i.v.</option><option value="i.m.">i.m.</option><option value="s.c.">s.c.</option><option value="p.o.">p.o.</option><option value="inhal.">inhal.</option></select></td><td><input type="time" name="med_time_${medRowCounter}" style="width:90px;padding:.3rem;font-size:14px"></td><td><input type="text" name="med_note_${medRowCounter}" style="width:100%;padding:.3rem;font-size:14px"></td><td><button class="subbtn" type="button" onclick="this.closest('tr').remove()">×</button></td>`;
  tbody.appendChild(tr);
};

window.closeEditModal = () => {
  document.getElementById('editModal').classList.remove('show');
  if (!document.getElementById('signModal').classList.contains('show')) {
    currentEditDoc = null;
    currentEditPayload = null;
  }
};

window.saveAndSignPatDoc = async () => {
  try {
    showMsg('Daten werden gespeichert...', 'success');
    const form = document.getElementById('editFormContainer');
    const formData = new FormData();
    const inputs = form.querySelectorAll('input, textarea, select');
    inputs.forEach(input => {
      if (input.type === 'checkbox') formData.append(input.name, input.checked);
      else if (input.type === 'radio') { if (input.checked) formData.append(input.name, input.value); }
      else formData.append(input.name, input.value);
    });
    
    const payload = {};
    for (let [key, value] of formData.entries()) {
      if (payload[key] !== undefined) continue;
      payload[key] = value === 'true' ? true : value === 'false' ? false : value;
    }
    
    const medications = [];
    for (let i = 1; i <= medRowCounter; i++) {
      const name = form.querySelector(`[name="med_name_${i}"]`)?.value;
      if (name) {
        medications.push({
          name,
          dose: form.querySelector(`[name="med_dose_${i}"]`)?.value || '',
          unit: form.querySelector(`[name="med_unit_${i}"]`)?.value || '',
          route: form.querySelector(`[name="med_route_${i}"]`)?.value || '',
          time: form.querySelector(`[name="med_time_${i}"]`)?.value || '',
          note: form.querySelector(`[name="med_note_${i}"]`)?.value || ''
        });
      }
    }
    payload.medications = medications;
    
    if (currentEditPayload.photos) payload.photos = currentEditPayload.photos;
    if (currentEditPayload.signature) payload.signature = currentEditPayload.signature;
    
    await pb.collection('patients').update(currentEditDoc.id, { payload: payload });
    document.getElementById('editModal').classList.remove('show');
    document.getElementById('signModal').classList.add('show');
    initAdminSigCanvas();
  } catch(e) {
    showMsg('Fehler beim Speichern: ' + e.message, 'error');
  }
};

let adminSigCanvas, adminSigCtx, adminIsDrawing = false;
function initAdminSigCanvas() {
  adminSigCanvas = document.getElementById('adminSigCanvas');
  adminSigCtx = adminSigCanvas.getContext('2d');
  const rect = adminSigCanvas.getBoundingClientRect();
  adminSigCanvas.width = rect.width;
  adminSigCanvas.height = rect.height;
  adminSigCtx.lineWidth = 2;
  adminSigCtx.strokeStyle = '#000';
  adminSigCtx.lineCap = 'round';
  adminSigCanvas.addEventListener('mousedown', startAdminDraw);
  adminSigCanvas.addEventListener('mousemove', adminDraw);
  adminSigCanvas.addEventListener('mouseup', stopAdminDraw);
  adminSigCanvas.addEventListener('mouseleave', stopAdminDraw);
  adminSigCanvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    const touch = e.touches[0];
    adminSigCanvas.dispatchEvent(new MouseEvent('mousedown', { clientX: touch.clientX, clientY: touch.clientY }));
  });
  adminSigCanvas.addEventListener('touchmove', (e) => {
    e.preventDefault();
    const touch = e.touches[0];
    adminSigCanvas.dispatchEvent(new MouseEvent('mousemove', { clientX: touch.clientX, clientY: touch.clientY }));
  });
  adminSigCanvas.addEventListener('touchend', (e) => {
    e.preventDefault();
    adminSigCanvas.dispatchEvent(new MouseEvent('mouseup', {}));
  });
}
function startAdminDraw(e) {
  adminIsDrawing = true;
  const rect = adminSigCanvas.getBoundingClientRect();
  adminSigCtx.beginPath();
  adminSigCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
}
function adminDraw(e) {
  if (!adminIsDrawing) return;
  const rect = adminSigCanvas.getBoundingClientRect();
  adminSigCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
  adminSigCtx.stroke();
}
function stopAdminDraw() { adminIsDrawing = false; }
window.clearAdminSig = () => { adminSigCtx.clearRect(0, 0, adminSigCanvas.width, adminSigCanvas.height); };
window.closeSignModal = () => { document.getElementById('signModal').classList.remove('show'); };

window.archiveWithSignature = async () => {
  try {
    const adminName = document.getElementById('adminName').value.trim();
    if (!adminName) { showMsg('Bitte Namen eingeben', 'error'); return; }
    const signatureData = adminSigCanvas.toDataURL('image/png');
    await pb.collection('patients').update(currentEditDoc.id, {
      status: 'archiviert',
      admin_name: adminName,
      admin_datum: new Date().toISOString(),
      admin_unterschrift: signatureData
    });
    closeSignModal();
    showMsg('✅ Dokument archiviert!', 'success');
    await loadData();
    currentEditDoc = null;
    currentEditPayload = null;
  } catch(e) {
    showMsg('Fehler beim Archivieren: ' + e.message, 'error');
  }
};

window.viewPatArchiv = async (id) => {
  try {
    const doc = await pb.collection('patients').getOne(id);
    const p = doc.payload || {};
    window.currentViewedPayload = p;
    window.currentViewedAdmin = { name: doc.admin_name, datum: doc.admin_datum, unterschrift: doc.admin_unterschrift };
    window.currentViewedOrgName = currentOrganization?.name || 'Feuerwehr';
    window.currentViewedDocType = 'patient';
    const patName = `${p.vorname || ''} ${p.name || ''}`.trim() || 'Unbekannt';
    document.getElementById('detailsTitle').textContent = 'Patientendokumentation: ' + patName;
    let html = '<div class="details-grid">';
    html += `<div class="details-label"><strong>Einsatz-Nr:</strong></div><div class="details-value">${p.einsatz_nr || '-'}</div>`;
    html += `<div class="details-label">Datum/Zeit:</div><div class="details-value">${p.zeit_einsatz ? new Date(p.zeit_einsatz).toLocaleString('de-DE') : '-'}</div>`;
    html += `<div class="details-label">Fahrzeug:</div><div class="details-value">${p.fahrzeug || '-'}</div>`;
    html += `<div class="details-label" style="margin-top:12px"><strong>Patient:</strong></div><div class="details-value" style="margin-top:12px">${patName}</div>`;
    html += `<div class="details-label">Alter:</div><div class="details-value">${p.alter || '-'}</div>`;
    html += `<div class="details-label">Adresse:</div><div class="details-value">${p.strasse || ''}, ${p.plz_ort || ''}</div>`;
    html += `<div class="details-label" style="margin-top:12px"><strong>Anamnese:</strong></div><div class="details-value" style="margin-top:12px">${p.notfallgeschehen || '-'}</div>`;
    html += `<div class="details-label" style="margin-top:12px"><strong>Vitalparameter:</strong></div><div class="details-value" style="margin-top:12px">RR: ${p.rr_sys || '-'}/${p.rr_dia || '-'} mmHg, HF: ${p.hf || '-'}/min, AF: ${p.af || '-'}/min, SpO₂: ${p.spo2 || '-'}%, BZ: ${p.bz_mg || '-'} mg/dl, Temp: ${p.temp || '-'}°C, Schmerz: ${p.schmerz || '-'}/10</div>`;
    html += `<div class="details-label" style="margin-top:12px"><strong>Übergabe:</strong></div><div class="details-value" style="margin-top:12px">${p.ue_name || '-'} (${p.ue_zeit ? new Date(p.ue_zeit).toLocaleString('de-DE') : '-'})</div>`;
    html += `<div class="details-label">Ziel:</div><div class="details-value">${p.ziel_bez || '-'}</div>`;
    html += `<div class="details-label" style="margin-top:12px"><strong>MPG-Beauftragter:</strong></div><div class="details-value" style="margin-top:12px">${doc.admin_name || '-'} (${doc.admin_datum ? new Date(doc.admin_datum).toLocaleString('de-DE') : '-'})</div>`;
    if (doc.admin_unterschrift) html += `<div class="details-label">Unterschrift:</div><div class="details-value"><img src="${doc.admin_unterschrift}" class="signature-img"></div>`;
    html += '</div>';
    document.getElementById('detailsBody').innerHTML = html;
    document.getElementById('detailsModal').classList.add('show');
  } catch(e) {
    showMsg('Fehler: ' + e.message, 'error');
  }
};

window.closeDetailsModal = () => { document.getElementById('detailsModal').classList.remove('show'); };
window.generatePDFFromModal = () => { showMsg('PDF-Export wird implementiert...', 'success'); };

loadData();
setTimeout(() => { document.body.classList.add('loaded'); }, 100);
```

  </script>
</body>
</html>
