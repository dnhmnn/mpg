<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Patientendokumentation – Dateien (Admin)</title>
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Atkinson Hyperlegible', sans-serif; margin: 0; padding: 0; background: #f8f8f8; color: #222; }
    header { background: #c8102e; color: white; padding: 1em; font-weight: bold; }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { padding: 0.5em; border-bottom: 1px solid #ccc; text-align: left; }
    th { background: #eee; }
    .wrapper { max-width: 1000px; margin: auto; padding: 1em; }
    .error { color: red; margin-top: 1em; }
    .btn { background: #c8102e; color: white; padding: 0.4em 0.8em; border: none; border-radius: 4px; cursor: pointer; }
    .btn:hover { background: #a50c22; }
    input { padding: 0.4em; width: 100%; margin-bottom: 1em; }
  </style>
</head>
<body>
<header>Patientendokumentation – Dateien (Admin)</header>
<div class="wrapper">
  <input type="text" id="search" placeholder="Suchen (Name, Vorname, Einsatz-Nr., ID…)" />
  <table>
    <thead>
      <tr>
        <th>Status</th>
        <th>Erstellt</th>
        <th>Patient</th>
        <th>Ausfüller</th>
        <th>Gegenzeichner</th>
        <th>Ablauf (10 J.)</th>
        <th>Aktionen</th>
      </tr>
    </thead>
    <tbody id="doc-table-body"></tbody>
  </table>
  <div id="error" class="error"></div>
</div>

<script type="module">
import { NhostClient } from "https://esm.sh/@nhost/nhost-js@2.2.9"
const nhost = new NhostClient({
  subdomain: "hpjfrhktprpuuxvvlpsb",
  region: "eu-central-1"
})

// Login-Guard
try {
  const session = await nhost.auth.getSession()
  if (!session) location.href = "/admin-login.html"
} catch (e) {
  location.href = "/admin-login.html"
}

const accessToken = (await nhost.auth.getAccessToken()) || ""
const endpoint = "https://hpjfrhktprpuuxvvlpsb.graphql.eu-central-1.nhost.run/v1"

// GraphQL Query (beide Tabellen abrufen)
const query = `
query {
  patient_docs(order_by: {created_at: desc}) {
    id status created_at submitter_name team_lead_signature expires_at payload
  }
  patient_docs_nacherfassung(order_by: {created_at: desc}) {
    id created_at expires_at payload
  }
}
`

async function fetchDocs() {
  const res = await fetch(endpoint, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + accessToken
    },
    body: JSON.stringify({ query })
  })

  if (!res.ok) {
    document.getElementById("error").textContent = "Fehler: HTTP " + res.status
    return
  }

  const json = await res.json()
  const docs = [...json.data.patient_docs, ...json.data.patient_docs_nacherfassung]

  const tbody = document.getElementById("doc-table-body")
  tbody.innerHTML = ""

  docs.forEach(d => {
    const row = document.createElement("tr")
    const p = typeof d.payload === "string" ? JSON.parse(d.payload || "{}") : (d.payload || {})

    row.innerHTML = `
      <td>${d.status || "–"}</td>
      <td>${new Date(d.created_at).toLocaleString("de-DE")}</td>
      <td>${p.patient_name || p.vorname || "–"}</td>
      <td>${d.submitter_name || p.ausfüller || "–"}</td>
      <td>${d.team_lead_signature || p.gegenzeichner || "–"}</td>
      <td>${d.expires_at ? new Date(d.expires_at).toLocaleDateString("de-DE") : "–"}</td>
      <td><button class="btn" onclick="alert('Details folgen')">Details</button></td>
    `
    tbody.appendChild(row)
  })
}

fetchDocs().catch(e => {
  document.getElementById("error").textContent = "Fehler: " + e.message
})
</script>
</body>
</html>
