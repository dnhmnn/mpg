<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dokumentenverwaltung – Responda</title>
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/pocketbase@0.21.3/dist/pocketbase.umd.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.6.0/jspdf.plugin.autotable.min.js"></script>

<!-- ==================== CSS STYLES START ==================== -->
  <style>
    :root{
      --primary:#c8102e;
      --bg:#f8fafc;
      --card:#fff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --gradient-start:#667eea;
      --gradient-end:#764ba2;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
      min-height:100vh;
      color:var(--text);
      font-family:'Atkinson Hyperlegible',-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      line-height:1.45;
      opacity:0;
      transition:opacity 0.3s;
    }
    body.loaded{opacity:1}
    
    header{position:sticky;top:0;background:var(--gradient-start);color:#fff;z-index:10}
    .bar{max-width:1200px;margin:0 auto;padding:.75rem 1rem;display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    h1{font-size:1.05rem;margin:0;font-weight:800}
    .toolbar{margin-left:auto;display:flex;gap:.5rem;flex-wrap:wrap}
    .topbtn{border:1px solid rgba(255,255,255,0.3);background:rgba(255,255,255,0.1);color:#fff;padding:.45rem .7rem;border-radius:.5rem;cursor:pointer;font-weight:700;font-size:.9rem;transition:all 0.2s;text-decoration:none;display:inline-flex;align-items:center;gap:6px}
    .topbtn:hover{background:rgba(255,255,255,0.2)}
    
    .wrap{max-width:1200px;margin:1rem auto;padding:0 1rem 100px}
    .card{background:var(--card);border-radius:14px;box-shadow:0 3px 12px rgba(0,0,0,.06);padding:20px;margin-bottom:20px}
    .card h2{margin-top:0;color:var(--primary);font-weight:800}
    
    .tabs{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap}
    .tab{border:1px solid var(--border);background:#fafafa;padding:10px 16px;border-radius:999px;font-weight:800;cursor:pointer;font-size:0.95rem;transition:all 0.2s;display:inline-flex;align-items:center;gap:6px}
    .tab:hover{background:#f0f0f0}
    .tab.active{color:#fff;background:var(--primary);border-color:var(--primary)}
    
    .table-head,.row{display:grid;grid-template-columns:120px 1fr 280px;gap:12px;padding:14px 10px;align-items:center;border-bottom:1px solid var(--border)}
    .table-head{font-weight:800;color:#666;background:#fafafa;border-radius:8px 8px 0 0}
    .row:last-child{border-bottom:none}
    .row:hover{background:#f9f9f9}
    
    .pill{display:inline-block;font-weight:800;border-radius:999px;padding:5px 12px;font-size:0.85rem}
    .pill.offen{background:#fef3c7;color:#92400e}
    .pill.archiviert{background:#dcfce7;color:#166534}
    
    .btn{background:var(--primary);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer;font-size:0.9rem;transition:all 0.2s;display:inline-flex;align-items:center;gap:6px;font-family:inherit}
    .btn:hover{background:#a00d26;transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
    
    .btn-secondary{background:#6b7280;color:#fff}
    .btn-secondary:hover{background:#4b5563}
    
    .btn-icon{background:transparent;color:var(--primary);border:1px solid var(--primary);padding:8px 12px;font-size:0.85rem}
    .btn-icon:hover{background:#fff5f5;transform:translateY(-1px)}
    
    .add-btn{position:fixed;bottom:30px;right:30px;width:60px;height:60px;border-radius:50%;background:var(--primary);color:#fff;border:0;cursor:pointer;font-size:1.5rem;box-shadow:0 4px 12px rgba(0,0,0,.2);z-index:100;transition:transform 0.2s}
    .add-btn:hover{transform:scale(1.1)}
    .add-btn:active{transform:scale(0.95)}
    
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:flex-start;justify-content:center;z-index:1000;padding:20px;overflow-y:auto}
    .modal.show{display:flex}
    .modal-box{background:#fff;border-radius:14px;max-width:1200px;width:100%;max-height:90vh;overflow-y:auto;padding:24px;box-shadow:0 8px 20px rgba(0,0,0,.3);margin:auto}
    .modal-box h3{margin-top:0;color:var(--primary);font-weight:800}
    
    details{background:var(--card);border:1px solid var(--border);border-radius:.75rem;margin:0 0 .8rem 0;overflow:hidden}
    summary{list-style:none;padding:.9rem 1rem;cursor:pointer;font-weight:800;display:flex;align-items:center;gap:.6rem;font-size:1rem;background:#fafafa;transition:background 0.2s}
    summary::-webkit-details-marker{display:none}
    summary:hover{background:#f0f0f0}
    details[open] summary{border-bottom:1px solid var(--border);background:#fff7f7}
    
    .sec-body{padding:1rem}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:.75rem}
    
    label{font-size:.92rem;color:#111827;font-weight:600}
    input[type="text"],input[type="number"],input[type="datetime-local"],input[type="date"],input[type="time"],textarea,select{width:100%;padding:.55rem .6rem;border:1px solid var(--border);border-radius:.5rem;background:#fff;font-size:16px;font-family:inherit;transition:border-color 0.2s}
    input:focus,textarea:focus,select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(200,16,46,0.1)}
    textarea{min-height:88px;resize:vertical}
    
    fieldset{border:1px solid var(--border);border-radius:.6rem;padding:.75rem;margin-bottom:.75rem}
    fieldset legend{padding:0 .35rem;color:#111827;font-weight:700}
    
    .choice{display:flex;gap:.6rem;flex-wrap:wrap}
    .pill-input{display:inline-flex;align-items:center;gap:.4rem;border:1px solid var(--border);border-radius:999px;padding:.25rem .55rem;background:#fff;font-size:.9rem;cursor:pointer;transition:all 0.2s}
    .pill-input:hover{background:#f8fafc;border-color:var(--primary)}
    
    .badge{display:inline-block;padding:.2rem .5rem;border-radius:999px;background:#f1f5f9;color:#0f172a;border:1px solid var(--border);font-size:.8rem;font-weight:600}
    
    table{width:100%;border-collapse:collapse;margin-top:.5rem}
    th,td{border:1px solid var(--border);padding:.5rem;text-align:left;font-size:.9rem}
    th{background:#f8fafc;font-weight:700}
    
    .subbtn{border:1px solid var(--border);background:#fff;padding:.35rem .55rem;border-radius:.45rem;cursor:pointer;font-size:.9rem;font-weight:600;font-family:inherit;transition:all 0.2s}
    .subbtn:hover{background:#f8fafc;border-color:var(--primary)}
    
    .thumbs{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem}
    .thumb{position:relative}
    .thumb img{width:120px;height:120px;object-fit:cover;border:1px solid var(--border);border-radius:.5rem}
    .thumb .rm{position:absolute;top:6px;right:6px;border:1px solid #0002;background:#0006;color:#fff;border-radius:.35rem;padding:.15rem .35rem;cursor:pointer;font-weight:700}
    
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;margin:16px 0}
    .form-group{display:flex;flex-direction:column;gap:6px}
    .form-group label{font-weight:700;font-size:0.9rem;color:#374151}
    .form-group input,.form-group textarea,.form-group select{padding:10px 12px;border:1px solid #d1d5db;border-radius:8px;font-size:16px;font-family:inherit}
    .form-group input:focus,.form-group textarea:focus,.form-group select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(200,16,46,0.1)}
    .form-group textarea{min-height:80px;resize:vertical}
    
    .radio-group{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    .radio-group label{display:flex;align-items:center;gap:6px;font-weight:600;cursor:pointer}
    
    .sig-wrap{border:2px dashed #d1d5db;border-radius:8px;padding:12px;background:#f9fafb;margin:16px 0}
    canvas.sig-canvas{width:100%;height:200px;border:1px solid #d1d5db;border-radius:6px;background:#fff;cursor:crosshair;touch-action:none;display:block}
    .sig-actions{margin-top:8px;display:flex;gap:8px}
    
    .msg{margin-top:12px;padding:12px;border-radius:8px}
    .msg.error{background:#fee;color:#c00;border:1px solid #fcc}
    .msg.success{background:#efe;color:#060;border:1px solid #cfc}
    
    .signature-img{max-width:400px;max-height:200px;border:1px solid #d1d5db;border-radius:6px;margin-top:8px}
    
    .photo-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;margin-top:10px}
    .photo-grid img{width:100%;height:150px;object-fit:cover;border:1px solid #ddd;border-radius:6px}
    
    @media (max-width:768px){
      .table-head,.row{grid-template-columns:1fr !important;gap:8px}
      .modal-box{padding:16px}
      .form-grid{grid-template-columns:1fr}
      .add-btn{bottom:20px;right:20px;width:56px;height:56px;font-size:1.3rem}
      .grid{grid-template-columns:1fr}
      h1{font-size:.95rem}
      .topbtn{font-size:.85rem;padding:.4rem .6rem}
    }
    
    @media print{
      header,.tabs,.btn,.add-btn,.modal{display:none !important}
      body{background:#fff}
      .card{box-shadow:none;border:1px solid #ddd}
      details{border:none}
      summary{display:none}
    }
  </style>
<!-- ==================== CSS STYLES END ==================== -->

</head>
<body>

<!-- ==================== HEADER START ==================== -->
  <header>
    <div class="bar">
      <h1><i class="fa-solid fa-file-medical"></i> Patientendokumentation</h1>
      <div class="toolbar">
        <a class="topbtn" href="mpg-dashboard.html"><i class="fa-solid fa-dashboard"></i> Dashboard</a>
        <button class="topbtn" id="logout"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
      </div>
    </div>
  </header>
<!-- ==================== HEADER END ==================== -->

<!-- ==================== MAIN CONTENT START ==================== -->
  <div class="wrap">
    <section class="card">
      <h2>Dokumentenverwaltung</h2>
      
      <!-- TABS -->
      <div class="tabs">
        <button class="tab active" data-tab="pat">
          <i class="fa-solid fa-file-medical"></i> Patientendokus (Offen)
        </button>
        <button class="tab" data-tab="nach">
          <i class="fa-solid fa-clipboard-list"></i> Nacherfassungen (Offen)
        </button>
        <button class="tab" data-tab="archiv">
          <i class="fa-solid fa-box-archive"></i> Archiv
        </button>
      </div>

      <!-- TAB: PATIENTENDOKUS (OFFEN) -->
      <div id="tab-pat" class="tab-content">
        <div class="table-head">
          <div>Status</div>
          <div>Dokument</div>
          <div>Aktionen</div>
        </div>
        <div id="pat-rows"></div>
      </div>

      <!-- TAB: NACHERFASSUNGEN (OFFEN) -->
      <div id="tab-nach" class="tab-content" style="display:none">
        <div class="table-head">
          <div>Status</div>
          <div>Nacherfassung</div>
          <div>Aktionen</div>
        </div>
        <div id="nach-rows"></div>
      </div>

      <!-- TAB: ARCHIV -->
      <div id="tab-archiv" class="tab-content" style="display:none">
        <div class="table-head">
          <div>Typ</div>
          <div>Dokument</div>
          <div>Aktionen</div>
        </div>
        <div id="archiv-rows"></div>
      </div>

      <div id="msg"></div>
    </section>
  </div>
<!-- ==================== MAIN CONTENT END ==================== -->

<!-- ==================== ADD BUTTON START ==================== -->
  <button class="add-btn" id="addBtn" title="Neue Nacherfassung">
    <i class="fa-solid fa-plus"></i>
  </button>
<!-- ==================== ADD BUTTON END ==================== -->

<!-- ==================== EDIT MODAL START ==================== -->
  <div class="modal" id="editModal">
    <div class="modal-box">
      <h3><i class="fa-solid fa-edit"></i> Patientendokumentation bearbeiten</h3>
      <div id="editFormContainer"></div>
      <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end;position:sticky;bottom:0;background:#fff;padding-top:16px;border-top:2px solid var(--border)">
        <button class="btn btn-secondary" onclick="closeEditModal()">
          <i class="fa-solid fa-times"></i> Abbrechen
        </button>
        <button class="btn" onclick="saveAndSignPatDoc()">
          <i class="fa-solid fa-save"></i> Speichern & Gegenzeichnen
        </button>
      </div>
    </div>
  </div>
<!-- ==================== EDIT MODAL END ==================== -->

<!-- ==================== SIGN MODAL START ==================== -->
  <div class="modal" id="signModal">
    <div class="modal-box" style="max-width:600px">
      <h3><i class="fa-solid fa-signature"></i> Verantwortlicher / MPG-Beauftragter</h3>
      <p>Dokument wurde geprüft und ist korrekt. Mit Unterschrift wird es ins Archiv verschoben.</p>
      <div class="form-group">
        <label>Name (Verantwortlicher / MPG-Beauftragter):</label>
        <input type="text" id="adminName" placeholder="Ihr Name">
      </div>
      <div class="sig-wrap">
        <label style="font-weight:700;margin-bottom:8px;display:block">Unterschrift:</label>
        <canvas id="adminSigCanvas" class="sig-canvas"></canvas>
        <div class="sig-actions">
          <button class="btn btn-secondary" onclick="clearAdminSig()">
            <i class="fa-solid fa-eraser"></i> Löschen
          </button>
        </div>
      </div>
      <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end">
        <button class="btn btn-secondary" onclick="closeSignModal()">Abbrechen</button>
        <button class="btn" onclick="archiveWithSignature()">
          <i class="fa-solid fa-check"></i> Unterschreiben & Archivieren
        </button>
      </div>
    </div>
  </div>
<!-- ==================== SIGN MODAL END ==================== -->

<!-- ==================== NACHERFASSUNG MODAL START ==================== -->
  <div class="modal" id="nachModal">
    <div class="modal-box">
      <h3><i class="fa-solid fa-clipboard-list"></i> Einsatznacherfassung</h3>
      <form id="nachForm">
        <div class="form-grid">
          <div class="form-group">
            <label>Datum/Alarmzeit:</label>
            <input type="datetime-local" name="datum_alarmzeit">
          </div>
          <div class="form-group">
            <label>Datum/Einsatzende:</label>
            <input type="datetime-local" name="datum_einsatzende">
          </div>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label>Stichwort:</label>
            <input type="text" name="stichwort">
          </div>
          <div class="form-group">
            <label>Kategorie:</label>
            <input type="text" name="kategorie">
          </div>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label>Einsatznummer der ILS:</label>
            <input type="text" name="einsatznummer_ils">
          </div>
          <div class="form-group">
            <label>Meldebild:</label>
            <input type="text" name="meldebild">
          </div>
        </div>
        <div class="form-group">
          <label>Adresse:</label>
          <textarea name="adresse"></textarea>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label>Disponierte EM (FW):</label>
            <input type="text" name="disponierte_em_fw">
          </div>
          <div class="form-group">
            <label>Disponierte EM (RD):</label>
            <input type="text" name="disponierte_em_rd">
          </div>
        </div>
        <h4 style="margin-top:20px;color:var(--primary)">Patienten-Daten</h4>
        <div class="form-group">
          <label>Erhoben:</label>
          <div class="radio-group">
            <label><input type="radio" name="patienten_daten_erhoben" value="ja"> Ja</label>
            <label><input type="radio" name="patienten_daten_erhoben" value="nein"> Nein</label>
          </div>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label>Name:</label>
            <input type="text" name="patient_name">
          </div>
          <div class="form-group">
            <label>Alter/Geburtsdatum:</label>
            <input type="text" name="patient_alter_geburtsdatum">
          </div>
          <div class="form-group">
            <label>Pat.-Nummer der ILS:</label>
            <input type="text" name="patient_nummer_ils">
          </div>
        </div>
        <div class="form-group">
          <label>Sachverhalt vor Ort:</label>
          <textarea name="sachverhalt" rows="4"></textarea>
        </div>
        <h4 style="margin-top:20px;color:var(--primary)">Protokollpflicht</h4>
        <div class="form-group">
          <label>War dieser Einsatz gemäß §630f BGB protokollpflichtig?</label>
          <div class="radio-group">
            <label><input type="radio" name="protokollpflichtig" value="ja"> Ja</label>
            <label><input type="radio" name="protokollpflichtig" value="nein"> Nein</label>
          </div>
        </div>
        <div class="form-group">
          <label>Begründung:</label>
          <textarea name="protokollpflichtig_begruendung"></textarea>
        </div>
        <div class="form-group">
          <label>War die verantwortliche Person mit der Thematik der Einsatz-/Patientendokumentation (gem. §630f BGB) unterwiesen?</label>
          <div class="radio-group">
            <label><input type="radio" name="verantwortlicher_unterwiesen" value="ja"> Ja</label>
            <label><input type="radio" name="verantwortlicher_unterwiesen" value="nein"> Nein</label>
          </div>
        </div>
        <h4 style="margin-top:20px;color:var(--primary)">Verantwortlicher</h4>
        <div class="form-grid">
          <div class="form-group">
            <label>Name:</label>
            <input type="text" name="verantwortlicher_name">
          </div>
          <div class="form-group">
            <label>Qualifikation:</label>
            <input type="text" name="verantwortlicher_qualifikation">
          </div>
        </div>
        <h4 style="margin-top:20px;color:var(--primary)">Nacherfassung</h4>
        <div class="form-grid">
          <div class="form-group">
            <label>Nacherfasst von (Name):</label>
            <input type="text" name="nacherfasst_von_name" required>
          </div>
          <div class="form-group">
            <label>Qualifikation:</label>
            <input type="text" name="nacherfasst_von_qualifikation">
          </div>
        </div>
        <div class="sig-wrap">
          <label style="font-weight:700;margin-bottom:8px;display:block">Unterschrift:</label>
          <canvas id="nachSigCanvas" class="sig-canvas"></canvas>
          <div class="sig-actions">
            <button type="button" class="btn btn-secondary" onclick="clearNachSig()">
              <i class="fa-solid fa-eraser"></i> Löschen
            </button>
          </div>
        </div>
      </form>
      <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end">
        <button class="btn btn-secondary" onclick="closeNachModal()">Abbrechen</button>
        <button class="btn" onclick="saveNacherfassung()">
          <i class="fa-solid fa-save"></i> Speichern
        </button>
      </div>
    </div>
  </div>
<!-- ==================== NACHERFASSUNG MODAL END ==================== -->

<!-- ==================== DETAILS MODAL START ==================== -->
  <div class="modal" id="detailsModal">
    <div class="modal-box">
      <h3 id="detailsTitle">Details</h3>
      <div id="detailsBody"></div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
        <button class="btn btn-secondary" onclick="closeDetailsModal()">
          <i class="fa-solid fa-times"></i> Schließen
        </button>
        <button class="btn" onclick="generatePDFFromModal()">
          <i class="fa-solid fa-file-pdf"></i> PDF erstellen
        </button>
      </div>
    </div>
  </div>
<!-- ==================== DETAILS MODAL END ==================== -->
<!-- ==================== JAVASCRIPT START ==================== -->
  <script type="module">
    
    // ========================================
    // SECTION: POCKETBASE INITIALIZATION & AUTH
    // ========================================
    const pb = new PocketBase('https://api.responda.systems');
    
    // Check if user is logged in
    if (!pb.authStore.isValid) {
      location.href = "/mpg-login.html";
    }

    const currentUser = pb.authStore.model;
    if (!currentUser || !currentUser.organization_id) {
      location.href = "/mpg-login.html";
    }

    // Load organization data
    let currentOrganization = null;
    async function loadOrganization() {
      try {
        currentOrganization = await pb.collection('organizations').getOne(currentUser.organization_id);
        console.log('✅ Organization loaded:', currentOrganization);
      } catch(e) {
        console.error('❌ Error loading organization:', e);
      }
    }
    loadOrganization();

    // ========================================
    // SECTION: LOGOUT HANDLER
    // ========================================
    document.getElementById("logout").onclick = async (e) => {
      e.preventDefault();
      pb.authStore.clear();
      localStorage.clear();
      location.href = "/mpg-login.html";
    };

    // ========================================
    // SECTION: TAB SWITCHING
    // ========================================
    document.querySelectorAll('.tab').forEach(tab => {
      tab.onclick = () => {
        const targetTab = tab.dataset.tab;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = 'none');
        document.getElementById('tab-' + targetTab).style.display = 'block';
        document.getElementById('msg').textContent = '';
      };
    });

    // ========================================
    // SECTION: UTILITY FUNCTIONS
    // ========================================
    function showMsg(text, type = 'success') {
      const msgDiv = document.getElementById('msg');
      msgDiv.textContent = text;
      msgDiv.className = 'msg ' + type;
      setTimeout(() => { 
        msgDiv.textContent = ''; 
        msgDiv.className = 'msg'; 
      }, 5000);
    }

    function calculateGCS(p) {
      const e = parseInt(p.gcs_e || 0);
      const v = parseInt(p.gcs_v || 0);
      const m = parseInt(p.gcs_m || 0);
      const sum = e + v + m;
      return sum > 0 ? sum : '—';
    }

    function calculateQSOFA(p) {
      const gcs = parseInt(p.gcs_e || 0) + parseInt(p.gcs_v || 0) + parseInt(p.gcs_m || 0);
      const af = parseInt(p.af || 0);
      const rrSys = parseInt(p.rr_sys || 0);
      let score = 0;
      if (gcs > 0 && gcs < 15) score++;
      if (af >= 22) score++;
      if (rrSys > 0 && rrSys <= 100) score++;
      return (gcs > 0 || af > 0 || rrSys > 0) ? score : '—';
    }

    // ========================================
    // SECTION: LOAD DATA FROM DATABASE
    // ========================================
    async function loadData() {
      try {
        // Load open patient documents
        const patData = await pb.collection('patients').getFullList({
          filter: `status = "offen" && organization_id = "${currentUser.organization_id}"`,
          sort: '-created',
        });
        
        const patRows = document.getElementById('pat-rows');
        patRows.innerHTML = patData.map(doc => {
          const payload = doc.payload || {};
          const patName = `${payload.vorname || ''} ${payload.name || ''}`.trim() || 'Unbekannt';
          return `
          <div class="row">
            <div><span class="pill offen">${doc.status}</span></div>
            <div>
              <strong>${doc.title || patName}</strong><br>
              <small style="color:#6b7280">
                ${payload.einsatz_nr ? 'Einsatz-Nr: ' + payload.einsatz_nr + ' · ' : ''}
                ${new Date(doc.created).toLocaleString('de-DE')}
              </small>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-icon" onclick="editPatDoc('${doc.id}')">
                <i class="fa-solid fa-edit"></i> Bearbeiten
              </button>
            </div>
          </div>
        `;
        }).join('') || '<p style="padding:20px;color:#999">Keine offenen Patientendokus</p>';

        // Load open Nacherfassungen
        const nachData = await pb.collection('patient_docs_nacherfassung').getFullList({
          filter: `status = "offen" && organization_id = "${currentUser.organization_id}"`,
          sort: '-created',
        });
        
        const nachRows = document.getElementById('nach-rows');
        nachRows.innerHTML = nachData.map(doc => `
          <div class="row">
            <div><span class="pill offen">${doc.status}</span></div>
            <div>
              <strong>${doc.stichwort || 'Ohne Stichwort'}</strong><br>
              <small style="color:#6b7280">
                von ${doc.nacherfasst_von_name || '?'} · 
                ${new Date(doc.created).toLocaleString('de-DE')}
              </small>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-icon" onclick="viewNach('${doc.id}')">
                <i class="fa-solid fa-eye"></i> Details
              </button>
              <button class="btn btn-icon" onclick="archiveNach('${doc.id}')">
                <i class="fa-solid fa-box-archive"></i> Archivieren
              </button>
            </div>
          </div>
        `).join('') || '<p style="padding:20px;color:#999">Keine offenen Nacherfassungen</p>';

        // Load archived patient documents
        const archivPat = await pb.collection('patients').getFullList({
          filter: `status = "archiviert" && organization_id = "${currentUser.organization_id}"`,
          sort: '-updated',
        });
        
        // Load archived Nacherfassungen
        const archivNach = await pb.collection('patient_docs_nacherfassung').getFullList({
          filter: `status = "archiviert" && organization_id = "${currentUser.organization_id}"`,
          sort: '-updated',
        });
        
        const archivRows = document.getElementById('archiv-rows');
        let archivHTML = '';
        
        archivPat.forEach(doc => {
          const payload = doc.payload || {};
          const patName = `${payload.vorname || ''} ${payload.name || ''}`.trim() || doc.title || 'Ohne Titel';
          archivHTML += `
            <div class="row">
              <div><span class="pill archiviert">Patientendoku</span></div>
              <div>
                <strong>${patName}</strong><br>
                <small style="color:#6b7280">
                  ${payload.einsatz_nr ? 'Einsatz-Nr: ' + payload.einsatz_nr + ' · ' : ''}
                  MPG-Verantwortlicher: ${doc.admin_name || '?'} · 
                  ${doc.admin_datum ? new Date(doc.admin_datum).toLocaleString('de-DE') : ''}
                </small>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn btn-icon" onclick="viewPatArchiv('${doc.id}')">
                  <i class="fa-solid fa-eye"></i> Ansehen
                </button>
              </div>
            </div>
          `;
        });
        
        archivNach.forEach(doc => {
          archivHTML += `
            <div class="row">
              <div><span class="pill archiviert">Nacherfassung</span></div>
              <div>
                <strong>${doc.stichwort || 'Ohne Titel'}</strong><br>
                <small style="color:#6b7280">von ${doc.nacherfasst_von_name || '?'}</small>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn btn-icon" onclick="viewNachArchiv('${doc.id}')">
                  <i class="fa-solid fa-eye"></i> Ansehen
                </button>
              </div>
            </div>
          `;
        });
        
        archivRows.innerHTML = archivHTML || '<p style="padding:20px;color:#999">Kein Archiv vorhanden</p>';

      } catch(e) {
        showMsg('Fehler beim Laden: ' + e.message, 'error');
      }
    }
    // ========================================
    // SECTION: EDIT PATIENT DOCUMENT
    // ========================================
    let currentEditDoc = null;
    let currentEditPayload = null;
    let medRowCounter = 0;
    
    window.editPatDoc = async (id) => {
      try {
        currentEditDoc = await pb.collection('patients').getOne(id);
        currentEditPayload = currentEditDoc.payload || {};
        
        const formHTML = buildEditForm(currentEditPayload);
        document.getElementById('editFormContainer').innerHTML = formHTML;
        document.querySelectorAll('#editFormContainer details').forEach(d => d.open = true);
        
        const meds = currentEditPayload.medications || [];
        medRowCounter = meds.length;
        
        document.getElementById('editModal').classList.add('show');
      } catch(e) {
        showMsg('Fehler: ' + e.message, 'error');
      }
    };

    // ========================================
    // SECTION: BUILD EDIT FORM HTML
    // ========================================
    function buildEditForm(payload) {
      const v = (key, fallback = '') => 
        payload[key] !== undefined && payload[key] !== null ? payload[key] : fallback;
      
      const checked = (key) => payload[key] ? 'checked' : '';
      
      const radioChecked = (key, value) => payload[key] === value ? 'checked' : '';
      
      // Build medication rows
      const medications = payload.medications || [];
      let medRowsHTML = '';
      medications.forEach((med, idx) => {
        const i = idx + 1;
        medRowsHTML += `
          <tr>
            <td>${i}</td>
            <td><input type="text" name="med_name_${i}" value="${med.name || ''}" 
                style="width:100%;padding:.3rem;font-size:14px"></td>
            <td><input type="number" name="med_dose_${i}" value="${med.dose || ''}" step="0.1" 
                style="width:80px;padding:.3rem;font-size:14px"></td>
            <td><input type="text" name="med_unit_${i}" value="${med.unit || ''}" placeholder="mg" 
                style="width:60px;padding:.3rem;font-size:14px"></td>
            <td>
              <select name="med_route_${i}" style="padding:.3rem;font-size:14px">
                <option value="">-</option>
                <option value="i.v." ${med.route === 'i.v.' ? 'selected' : ''}>i.v.</option>
                <option value="i.m." ${med.route === 'i.m.' ? 'selected' : ''}>i.m.</option>
                <option value="s.c." ${med.route === 's.c.' ? 'selected' : ''}>s.c.</option>
                <option value="p.o." ${med.route === 'p.o.' ? 'selected' : ''}>p.o.</option>
                <option value="inhal." ${med.route === 'inhal.' ? 'selected' : ''}>inhal.</option>
              </select>
            </td>
            <td><input type="time" name="med_time_${i}" value="${med.time || ''}" 
                style="width:90px;padding:.3rem;font-size:14px"></td>
            <td><input type="text" name="med_note_${i}" value="${med.note || ''}" 
                style="width:100%;padding:.3rem;font-size:14px"></td>
            <td><button class="subbtn" type="button" onclick="this.closest('tr').remove()">×</button></td>
          </tr>
        `;
      });
      
      // Build photos display
      const photos = payload.photos || [];
      let photosHTML = '';
      if (photos.length > 0) {
        photosHTML = '<div class="thumbs">';
        photos.forEach((photo, idx) => {
          photosHTML += `
            <div class="thumb">
              <img src="${photo}" alt="Foto ${idx+1}">
            </div>
          `;
        });
        photosHTML += '</div>';
      }
      
      // Return complete form HTML
      return `
<details open>
  <summary><i class="fa-solid fa-truck-medical"></i> Einsatzdaten</summary>
  <div class="sec-body">
    <div class="grid">
      <label>Einsatz-Nr.<input name="einsatz_nr" type="text" value="${v('einsatz_nr')}"></label>
      <label>Pat./Auftrags-Nr.<input name="auftrags_nr" type="text" value="${v('auftrags_nr')}"></label>
      <label>Rufname<input name="rufname" type="text" value="${v('rufname')}"></label>
      <label>Fahrzeug<input name="fahrzeug" type="text" value="${v('fahrzeug')}"></label>
      <label>Datum/Uhrzeit<input name="zeit_einsatz" type="datetime-local" value="${v('zeit_einsatz')}"></label>
    </div>
    <label>Einsatz-Art<input name="einsatz_art" type="text" value="${v('einsatz_art')}"></label>
  </div>
</details>

<details open>
  <summary><i class="fa-solid fa-id-card-clip"></i> Pat-Stammdaten</summary>
  <div class="sec-body">
    <div class="grid">
      <label>Name<input name="name" type="text" value="${v('name')}"></label>
      <label>Vorname<input name="vorname" type="text" value="${v('vorname')}"></label>
      <label>Geb.-Datum<input name="gebdatum" type="date" value="${v('gebdatum')}"></label>
      <label>Alter<input name="alter" type="number" value="${v('alter')}"></label>
      <label>Telefon<input name="telefon" type="text" value="${v('telefon')}"></label>
      <label>Mobil<input name="mobil" type="text" value="${v('mobil')}"></label>
      <label>Straße<input name="strasse" type="text" value="${v('strasse')}"></label>
      <label>PLZ, Ort<input name="plz_ort" type="text" value="${v('plz_ort')}"></label>
      <label>Kasse / Nr.<input name="kasse" type="text" value="${v('kasse')}"></label>
      <label>Vers.-Nr.<input name="versnr" type="text" value="${v('versnr')}"></label>
      <label>Hausarzt / Tel.<input name="hausarzt" type="text" value="${v('hausarzt')}"></label>
      <label>Angehöriger / Tel.<input name="angehoeriger" type="text" value="${v('angehoeriger')}"></label>
    </div>
    <label>Informationen / Aspekte<textarea name="infos">${v('infos')}</textarea></label>
  </div>
</details>

<details open>
  <summary><i class="fa-solid fa-notes-medical"></i> Notfallgeschehen / Anamnese</summary>
  <div class="sec-body">
    <textarea name="notfallgeschehen">${v('notfallgeschehen')}</textarea>
    ${photosHTML ? '<div style="margin-top:.75rem"><strong>Fotos:</strong>' + photosHTML + '</div>' : ''}
  </div>
</details>

<details>
  <summary><i class="fa-solid fa-brain"></i> Neurologie</summary>
  <div class="sec-body">
    <div class="grid">
      <label>Zeitpunkt<input name="neu_zeit" type="datetime-local" value="${v('neu_zeit')}"></label>
      <label class="pill-input">
        <input type="checkbox" name="neu_unauff" ${checked('neu_unauff')}> ohne path. Befund
      </label>
    </div>
    <div class="grid">
      <fieldset>
        <legend>Pupillenweite – rechts</legend>
        <div class="choice">
          <label class="pill-input">
            <input type="radio" name="pw_r" value="eng" ${radioChecked('pw_r','eng')}> eng
          </label>
          <label class="pill-input">
            <input type="radio" name="pw_r" value="mittel" ${radioChecked('pw_r','mittel')}> mittel
          </label>
          <label class="pill-input">
            <input type="radio" name="pw_r" value="weit" ${radioChecked('pw_r','weit')}> weit
          </label>
          <label class="pill-input">
            <input type="checkbox" name="pw_r_entrundet" ${checked('pw_r_entrundet')}> entrundet
          </label>
        </div>
        <div class="choice" style="margin-top:.5rem">
          <span class="badge">Lichtreaktion</span>
          <label class="pill-input">
            <input type="radio" name="lr_r" value="prompt" ${radioChecked('lr_r','prompt')}> prompt
          </label>
          <label class="pill-input">
            <input type="radio" name="lr_r" value="träge" ${radioChecked('lr_r','träge')}> träge
          </label>
          <label class="pill-input">
            <input type="radio" name="lr_r" value="keine" ${radioChecked('lr_r','keine')}> keine
          </label>
        </div>
      </fieldset>
      <fieldset>
        <legend>Pupillenweite – links</legend>
        <div class="choice">
          <label class="pill-input">
            <input type="radio" name="pw_l" value="eng" ${radioChecked('pw_l','eng')}> eng
          </label>
          <label class="pill-input">
            <input type="radio" name="pw_l" value="mittel" ${radioChecked('pw_l','mittel')}> mittel
          </label>
          <label class="pill-input">
            <input type="radio" name="pw_l" value="weit" ${radioChecked('pw_l','weit')}> weit
          </label>
          <label class="pill-input">
            <input type="checkbox" name="pw_l_entrundet" ${checked('pw_l_entrundet')}> entrundet
          </label>
        </div>
        <div class="choice" style="margin-top:.5rem">
          <span class="badge">Lichtreaktion</span>
          <label class="pill-input">
            <input type="radio" name="lr_l" value="prompt" ${radioChecked('lr_l','prompt')}> prompt
          </label>
          <label class="pill-input">
            <input type="radio" name="lr_l" value="träge" ${radioChecked('lr_l','träge')}> träge
          </label>
          <label class="pill-input">
            <input type="radio" name="lr_l" value="keine" ${radioChecked('lr_l','keine')}> keine
          </label>
        </div>
      </fieldset>
    </div>
  </div>
</details>

<details>
  <summary><i class="fa-solid fa-eye"></i> Glasgow Coma Scale</summary>
  <div class="sec-body">
    <fieldset>
      <legend>Augenöffnung (E)</legend>
      <div class="choice">
        <label class="pill-input">
          <input type="radio" name="gcs_e" value="4" ${radioChecked('gcs_e','4')}> spontan (4)
        </label>
        <label class="pill-input">
          <input type="radio" name="gcs_e" value="3" ${radioChecked('gcs_e','3')}> auf Geräusch (3)
        </label>
        <label class="pill-input">
          <input type="radio" name="gcs_e" value="2" ${radioChecked('gcs_e','2')}> auf Druck (2)
        </label>
        <label class="pill-input">
          <input type="radio" name="gcs_e" value="1" ${radioChecked('gcs_e','1')}> keine (1)
        </label>
      </div>
    </fieldset>
    <fieldset>
      <legend>Verbale Antwort (V)</legend>
      <div class="choice">
        <label class="pill-input">
          <input type="radio" name="gcs_v" value="5" ${radioChecked('gcs_v','5')}> orientiert (5)
        </label>
        <label class="pill-input">
          <input type="radio" name="gcs_v" value="4" ${radioChecked('gcs_v','4')}> verwirrt (4)
        </label>
        <label class="pill-input">
          <input type="radio" name="gcs_v" value="3" ${radioChecked('gcs_v','3')}> Wörter (3)
        </label>
        <label class="pill-input">
          <input type="radio" name="gcs_v" value="2" ${radioChecked('gcs_v','2')}> Laute (2)
        </label>
        <label class="pill-input">
          <input type="radio" name="gcs_v" value="1" ${radioChecked('gcs_v','1')}> keine (1)
        </label>
      </div>
    </fieldset>
    <fieldset>
      <legend>Motorische Antwort (M)</legend>
      <div class="choice">
        <label class="pill-input">
          <input type="radio" name="gcs_m" value="6" ${radioChecked('gcs_m','6')}> folgt (6)
        </label>
        <label class="pill-input">
          <input type="radio" name="gcs_m" value="5" ${radioChecked('gcs_m','5')}> lokalisiert (5)
        </label>
        <label class="pill-input">
          <input type="radio" name="gcs_m" value="4" ${radioChecked('gcs_m','4')}> beugt normal (4)
        </label>
        <label class="pill-input">
          <input type="radio" name="gcs_m" value="3" ${radioChecked('gcs_m','3')}> beugt abnormal (3)
        </label>
        <label class="pill-input">
          <input type="radio" name="gcs_m" value="2" ${radioChecked('gcs_m','2')}> streckt (2)
        </label>
        <label class="pill-input">
          <input type="radio" name="gcs_m" value="1" ${radioChecked('gcs_m','1')}> keine (1)
        </label>
      </div>
    </fieldset>
    <div class="badge" style="margin-top:.5rem">GCS Summe: ${calculateGCS(payload)}</div>
  </div>
</details>

<details>
  <summary><i class="fa-regular fa-hand"></i> Haut</summary>
  <div class="sec-body">
    <div class="choice">
      <label class="pill-input">
        <input type="checkbox" name="haut_unauff" ${checked('haut_unauff')}> unauffällig
      </label>
      <label class="pill-input">
        <input type="checkbox" name="haut_falten" ${checked('haut_falten')}> stehende Hautfalten
      </label>
      <label class="pill-input">
        <input type="checkbox" name="haut_oedeme" ${checked('haut_oedeme')}> Ödeme
      </label>
      <label class="pill-input">
        <input type="checkbox" name="haut_dekubitus" ${checked('haut_dekubitus')}> Dekubitus
      </label>
      <label class="pill-input">
        <input type="checkbox" name="haut_kaltschweissig" ${checked('haut_kaltschweissig')}> kaltschweißig
      </label>
      <label class="pill-input">
        <input type="checkbox" name="haut_exanthem" ${checked('haut_exanthem')}> Exanthem
      </label>
    </div>
  </div>
</details>

<details>
  <summary><i class="fa-solid fa-user"></i> Psyche</summary>
  <div class="sec-body">
    <div class="choice">
      <label class="pill-input">
        <input type="checkbox" name="psy_erregt" ${checked('psy_erregt')}> erregt
      </label>
      <label class="pill-input">
        <input type="checkbox" name="psy_aggr" ${checked('psy_aggr')}> aggressiv
      </label>
      <label class="pill-input">
        <input type="checkbox" name="psy_verlangsamt" ${checked('psy_verlangsamt')}> verlangsamt
      </label>
      <label class="pill-input">
        <input type="checkbox" name="psy_depressiv" ${checked('psy_depressiv')}> depressiv
      </label>
      <label class="pill-input">
        <input type="checkbox" name="psy_aengstlich" ${checked('psy_aengstlich')}> ängstlich
      </label>
      <label class="pill-input">
        <input type="checkbox" name="psy_euphorisch" ${checked('psy_euphorisch')}> euphorisch
      </label>
      <label class="pill-input">
        <input type="checkbox" name="psy_wahnhaft" ${checked('psy_wahnhaft')}> wahnhaft
      </label>
      <label class="pill-input">
        <input type="checkbox" name="psy_verwirrt" ${checked('psy_verwirrt')}> verwirrt
      </label>
      <label class="pill-input">
        <input type="checkbox" name="psy_suizidal" ${checked('psy_suizidal')}> suizidal
      </label>
      <label class="pill-input">
        <input type="checkbox" name="psy_motor_unruhig" ${checked('psy_motor_unruhig')}> motorisch unruhig
      </label>
    </div>
  </div>
</details>

<details open>
  <summary><i class="fa-solid fa-stethoscope"></i> Messwerte / Atmung</summary>
  <div class="sec-body">
    <div class="grid">
      <label>RR syst. (mmHg)<input name="rr_sys" type="number" value="${v('rr_sys')}"></label>
      <label>RR diast. (mmHg)<input name="rr_dia" type="number" value="${v('rr_dia')}"></label>
      <label>HF (/min)<input name="hf" type="number" value="${v('hf')}"></label>
      <label>AF (/min)<input name="af" type="number" value="${v('af')}"></label>
      <label>SpO₂ (%)<input name="spo2" type="number" value="${v('spo2')}"></label>
      <label>etCO₂ (mmHg)<input name="etco2" type="number" value="${v('etco2')}"></label>
      <label>Temp (°C)<input name="temp" type="number" step="0.1" value="${v('temp')}"></label>
      <label>BZ (mg/dl)<input name="bz_mg" type="number" value="${v('bz_mg')}"></label>
      <label>BZ (mmol/l)<input name="bz_mmol" type="number" step="0.1" value="${v('bz_mmol')}"></label>
      <label>Schmerz (0–10)<input name="schmerz" type="number" min="0" max="10" value="${v('schmerz')}"></label>
    </div>
    <fieldset style="margin-top:.8rem">
      <legend>qSOFA (auto)</legend>
      <div class="badge">qSOFA-Score: ${calculateQSOFA(payload)}</div>
    </fieldset>
    <fieldset>
      <legend>Atmung – klinische Zeichen</legend>
      <div class="choice">
        <label class="pill-input">
          <input type="checkbox" name="atm_apnoe" ${checked('atm_apnoe')}> Apnoe
        </label>
        <label class="pill-input">
          <input type="checkbox" name="atm_stridor" ${checked('atm_stridor')}> Stridor
        </label>
        <label class="pill-input">
          <input type="checkbox" name="atm_hypervent" ${checked('atm_hypervent')}> Hyperventilation
        </label>
        <label class="pill-input">
          <input type="checkbox" name="atm_dyspnoe" ${checked('atm_dyspnoe')}> Dyspnoe
        </label>
        <label class="pill-input">
          <input type="checkbox" name="atm_beatmung" ${checked('atm_beatmung')}> Beatmung
        </label>
        <label class="pill-input">
          <input type="checkbox" name="atm_zyanose" ${checked('atm_zyanose')}> Zyanose
        </label>
        <label class="pill-input">
          <input type="checkbox" name="atm_verlegung" ${checked('atm_verlegung')}> Atemwegsverlegung
        </label>
      </div>
      <textarea name="atm_sonst">${v('atm_sonst')}</textarea>
    </fieldset>
    <fieldset>
      <legend>O₂-Gabe</legend>
      <div class="choice">
        <label class="pill-input">
          <input type="radio" name="o2" value="raumluft" ${radioChecked('o2','raumluft')}> Raumluft
        </label>
        <label class="pill-input">
          <input type="radio" name="o2" value="unter_o2" ${radioChecked('o2','unter_o2')}> unter O₂
        </label>
        <label class="pill-input">
          <input type="checkbox" name="o2_nasal" ${checked('o2_nasal')}> Nasensonde
        </label>
        <label class="pill-input">
          <input type="checkbox" name="o2_maske" ${checked('o2_maske')}> Maske
        </label>
        <label class="pill-input">
          <input type="checkbox" name="o2_reservoir" ${checked('o2_reservoir')}> Maske m. Reservoir
        </label>
      </div>
      <div class="grid" style="margin-top:.4rem">
        <label>Flow (l/min)<input name="o2_flow" type="number" step="0.5" value="${v('o2_flow')}"></label>
        <label>Kommentar<input name="o2_comment" type="text" value="${v('o2_comment')}"></label>
      </div>
    </fieldset>
  </div>
</details>

<details>
  <summary><i class="fa-solid fa-heart-pulse"></i> Rhythmus / EKG</summary>
  <div class="sec-body">
    <div class="choice">
      <label class="pill-input">
        <input type="checkbox" name="sr" ${checked('sr')}> Sinusrhythmus
      </label>
      <label class="pill-input">
        <input type="checkbox" name="stemi" ${checked('stemi')}> STEMI
      </label>
      <label class="pill-input">
        <input type="checkbox" name="arrh_abs" ${checked('arrh_abs')}> absolute Arrhythmie
      </label>
      <label class="pill-input">
        <input type="checkbox" name="vf" ${checked('vf')}> Kammerflimmern
      </label>
      <label class="pill-input">
        <input type="checkbox" name="av3" ${checked('av3')}> AV-Block III°
      </label>
      <label class="pill-input">
        <input type="checkbox" name="asystole" ${checked('asystole')}> Asystolie
      </label>
    </div>
    <div class="grid" style="margin-top:.5rem">
      <label>Standort<input name="ekg_standort" type="text" value="${v('ekg_standort')}"></label>
      <label>Pers-Nr.<input name="ekg_persnr" type="text" value="${v('ekg_persnr')}"></label>
    </div>
  </div>
</details>

<details>
  <summary><i class="fa-solid fa-kit-medical"></i> Verletzungen</summary>
  <div class="sec-body">
    <textarea name="verletz_text">${v('verletz_text')}</textarea>
  </div>
</details>

<details>
  <summary><i class="fa-solid fa-clipboard-list"></i> Erstdiagnosen</summary>
  <div class="sec-body">
    <div class="grid">
      <fieldset>
        <legend>Neuro</legend>
        <div class="choice">
          <label class="pill-input">
            <input type="checkbox" name="diag_krampf" ${checked('diag_krampf')}> Konvulsionen
          </label>
          <label class="pill-input">
            <input type="checkbox" name="diag_synkope" ${checked('diag_synkope')}> Synkope
          </label>
          <label class="pill-input">
            <input type="checkbox" name="diag_apoplex" ${checked('diag_apoplex')}> Apoplex
          </label>
          <label class="pill-input">
            <input type="checkbox" name="diag_sht" ${checked('diag_sht')}> SHT
          </label>
        </div>
      </fieldset>
      <fieldset>
        <legend>Herz-Kreislauf</legend>
        <div class="choice">
          <label class="pill-input">
            <input type="checkbox" name="diag_acs" ${checked('diag_acs')}> ACS
          </label>
          <label class="pill-input">
            <input type="checkbox" name="diag_insuff" ${checked('diag_insuff')}> Herzinsuffizienz
          </label>
          <label class="pill-input">
            <input type="checkbox" name="diag_lungenoedem" ${checked('diag_lungenoedem')}> Lungenödem
          </label>
          <label class="pill-input">
            <input type="checkbox" name="diag_luembol" ${checked('diag_luembol')}> Lungenembolie
          </label>
        </div>
      </fieldset>
      <fieldset>
        <legend>Atmung</legend>
        <div class="choice">
          <label class="pill-input">
            <input type="checkbox" name="diag_resp_insuff" ${checked('diag_resp_insuff')}> resp. Insuffizienz
          </label>
          <label class="pill-input">
            <input type="checkbox" name="diag_pneumothorax" ${checked('diag_pneumothorax')}> Pneumothorax
          </label>
          <label class="pill-input">
            <input type="checkbox" name="diag_asthma" ${checked('diag_asthma')}> Asthma/COPD
          </label>
        </div>
      </fieldset>
      <fieldset>
        <legend>Stoffwechsel / Schock</legend>
        <div class="choice">
          <label class="pill-input">
            <input type="checkbox" name="diag_hypo" ${checked('diag_hypo')}> Hypoglykämie
          </label>
          <label class="pill-input">
            <input type="checkbox" name="diag_sept" ${checked('diag_sept')}> septischer Schock
          </label>
          <label class="pill-input">
            <input type="checkbox" name="diag_hypovol" ${checked('diag_hypovol')}> hypovolämischer Schock
          </label>
        </div>
      </fieldset>
    </div>
  </div>
</details>

<details>
  <summary><i class="fa-solid fa-face-meh"></i> Bewusstseinslage, AZ, Versorgung</summary>
  <div class="sec-body">
    <div class="grid">
      <fieldset>
        <legend>Bewusstseinslage</legend>
        <div class="choice">
          <label class="pill-input">
            <input type="checkbox" name="bew_wach" ${checked('bew_wach')}> wach
          </label>
          <label class="pill-input">
            <input type="checkbox" name="bew_ansprache" ${checked('bew_ansprache')}> Reaktion auf Ansprache
          </label>
          <label class="pill-input">
            <input type="checkbox" name="bew_schmerz" ${checked('bew_schmerz')}> Reaktion auf Schmerzreiz
          </label>
          <label class="pill-input">
            <input type="checkbox" name="bew_bewusstlos" ${checked('bew_bewusstlos')}> bewusstlos
          </label>
        </div>
      </fieldset>
      <fieldset>
        <legend>Allgemeinzustand</legend>
        <div class="choice">
          <label class="pill-input">
            <input type="radio" name="az" value="gesund" ${radioChecked('az','gesund')}> gesund
          </label>
          <label class="pill-input">
            <input type="radio" name="az" value="leicht" ${radioChecked('az','leicht')}> leicht eingeschränkt
          </label>
          <label class="pill-input">
            <input type="radio" name="az" value="deutlich" ${radioChecked('az','deutlich')}> deutlich eingeschränkt
          </label>
        </div>
      </fieldset>
      <fieldset>
        <legend>Versorgungssituation</legend>
        <div class="choice">
          <label class="pill-input">
            <input type="radio" name="versorgung" value="unabhaengig" ${radioChecked('versorgung','unabhaengig')}> unabhängig
          </label>
          <label class="pill-input">
            <input type="radio" name="versorgung" value="pflege_zuhaus" ${radioChecked('versorgung','pflege_zuhaus')}> Pflege zuhause
          </label>
          <label class="pill-input">
            <input type="radio" name="versorgung" value="pflege_institution" ${radioChecked('versorgung','pflege_institution')}> Pflege in Institution
          </label>
        </div>
      </fieldset>
    </div>
  </div>
</details>

<details open>
  <summary><i class="fa-solid fa-syringe"></i> Maßnahmen – Zugang & Medikation</summary>
  <div class="sec-body">
    <fieldset>
      <legend>Zugang</legend>
      <div class="grid">
        <label>Art
          <select name="zugang_art">
            <option value="">-</option>
            <option value="iv" ${v('zugang_art')==='iv'?'selected':''}>i.v.</option>
            <option value="io" ${v('zugang_art')==='io'?'selected':''}>i.o.</option>
          </select>
        </label>
        <label>Seite/Region<input name="zugang_region" type="text" value="${v('zugang_region')}"></label>
        <label>Größe (G)<input name="zugang_gauge" type="number" min="14" max="24" value="${v('zugang_gauge')}"></label>
        <label>Versuche<input name="zugang_versuche" type="number" min="0" value="${v('zugang_versuche')}"></label>
        <label>Zeitpunkt<input name="zugang_zeit" type="datetime-local" value="${v('zugang_zeit')}"></label>
      </div>
    </fieldset>
    <fieldset>
      <legend>Infusion</legend>
      <div class="grid">
        <label>Art<input name="inf_art" type="text" value="${v('inf_art')}"></label>
        <label>Menge (ml)<input name="inf_menge" type="number" min="0" step="50" value="${v('inf_menge')}"></label>
        <label>Laufrate (ml/h)<input name="inf_rate" type="number" min="0" step="10" value="${v('inf_rate')}"></label>
        <label>Bemerkung<input name="inf_bem" type="text" value="${v('inf_bem')}"></label>
      </div>
    </fieldset>
    <fieldset>
      <legend>Medikamente</legend>
      <button type="button" class="subbtn" onclick="addMedRowEdit()" style="margin-bottom:.5rem">
        <i class="fa-solid fa-plus"></i> Zeile hinzufügen
      </button>
      <div style="overflow:auto">
        <table id="medTableEdit">
          <thead>
            <tr>
              <th>#</th>
              <th>Medikament</th>
              <th>Dosis</th>
              <th>Einheit</th>
              <th>Route</th>
              <th>Uhrzeit</th>
              <th>Bemerkung</th>
              <th>×</th>
            </tr>
          </thead>
          <tbody>${medRowsHTML}</tbody>
        </table>
      </div>
    </fieldset>
  </div>
</details>

<details>
  <summary><i class="fa-solid fa-wind"></i> Beatmung / Atemweg</summary>
  <div class="sec-body">
    <div class="choice">
      <label class="pill-input">
        <input type="checkbox" name="aw_guedel" ${checked('aw_guedel')}> Guedel
      </label>
      <label class="pill-input">
        <input type="checkbox" name="aw_larynxtubus" ${checked('aw_larynxtubus')}> Larynxtubus
      </label>
      <label class="pill-input">
        <input type="checkbox" name="aw_ett" ${checked('aw_ett')}> ETT
      </label>
      <label class="pill-input">
        <input type="checkbox" name="aw_bvm" ${checked('aw_bvm')}> BVM
      </label>
    </div>
    <div class="grid" style="margin-top:.5rem">
      <label>ETT-Größe<input name="aw_ett_size" type="number" step="0.5" value="${v('aw_ett_size')}"></label>
      <label>PEEP (cmH₂O)<input name="vent_peep" type="number" step="1" value="${v('vent_peep')}"></label>
      <label>FiO₂ (%)<input name="vent_fio2" type="number" min="21" max="100" value="${v('vent_fio2')}"></label>
    </div>
  </div>
</details>

<details>
  <summary><i class="fa-solid fa-heart-circle-bolt"></i> Reanimation</summary>
  <div class="sec-body">
    <div class="grid">
      <label>Rea-Beginn<input name="rea_beginn" type="datetime-local" value="${v('rea_beginn')}"></label>
      <label>Erst-Rhythmus
        <select name="rea_initial">
          <option value="">-</option>
          <option value="Asystolie" ${v('rea_initial')==='Asystolie'?'selected':''}>Asystolie</option>
          <option value="PEA" ${v('rea_initial')==='PEA'?'selected':''}>PEA</option>
          <option value="VF" ${v('rea_initial')==='VF'?'selected':''}>VF</option>
          <option value="pVT" ${v('rea_initial')==='pVT'?'selected':''}>pVT</option>
        </select>
      </label>
      <label>Schocks<input name="rea_shocks" type="number" min="0" value="${v('rea_shocks')}"></label>
      <label>ROSC
        <select name="rea_rosc">
          <option value="">-</option>
          <option value="ja" ${v('rea_rosc')==='ja'?'selected':''}>ja</option>
          <option value="nein" ${v('rea_rosc')==='nein'?'selected':''}>nein</option>
        </select>
      </label>
      <label>Rea-Ende<input name="rea_ende" type="time" value="${v('rea_ende')}"></label>
    </div>
  </div>
</details>

<details open>
  <summary><i class="fa-solid fa-people-carry-box"></i> Übergabe / Transport</summary>
  <div class="sec-body">
    <div class="grid">
      <label>Übergabe an<input name="ue_name" type="text" value="${v('ue_name')}"></label>
      <label>Zeitpunkt<input name="ue_zeit" type="datetime-local" value="${v('ue_zeit')}"></label>
      <label>Ziel<input name="ziel_bez" type="text" value="${v('ziel_bez')}"></label>
      <label>Adresse<input name="ziel_adr" type="text" value="${v('ziel_adr')}"></label>
      <label>Einsatzende<input name="einsatzende" type="datetime-local" value="${v('einsatzende')}"></label>
    </div>
  </div>
</details>

<details open>
  <summary><i class="fa-solid fa-signature"></i> Ausfüller & Unterschrift</summary>
  <div class="sec-body">
    <div class="grid">
      <label>Name<input name="ausfueller_name" type="text" value="${v('ausfueller_name')}"></label>
      <label>Zeitpunkt<input name="ausfueller_zeit" type="datetime-local" value="${v('ausfueller_zeit')}"></label>
    </div>
    ${payload.signature ? `<div style="margin-top:.75rem"><strong>Unterschrift:</strong><br><img src="${payload.signature}" class="signature-img"></div>` : ''}
  </div>
</details>`;
    }

    // ========================================
    // SECTION: ADD MEDICATION ROW TO TABLE
    // ========================================
    window.addMedRowEdit = function() {
      medRowCounter++;
      const tbody = document.querySelector('#medTableEdit tbody');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${medRowCounter}</td>
        <td><input type="text" name="med_name_${medRowCounter}" 
            style="width:100%;padding:.3rem;font-size:14px"></td>
        <td><input type="number" name="med_dose_${medRowCounter}" step="0.1" 
            style="width:80px;padding:.3rem;font-size:14px"></td>
        <td><input type="text" name="med_unit_${medRowCounter}" placeholder="mg" 
            style="width:60px;padding:.3rem;font-size:14px"></td>
        <td>
          <select name="med_route_${medRowCounter}" style="padding:.3rem;font-size:14px">
            <option value="">-</option>
            <option value="i.v.">i.v.</option>
            <option value="i.m.">i.m.</option>
            <option value="s.c.">s.c.</option>
            <option value="p.o.">p.o.</option>
            <option value="inhal.">inhal.</option>
          </select>
        </td>
        <td><input type="time" name="med_time_${medRowCounter}" 
            style="width:90px;padding:.3rem;font-size:14px"></td>
        <td><input type="text" name="med_note_${medRowCounter}" 
            style="width:100%;padding:.3rem;font-size:14px"></td>
        <td><button class="subbtn" type="button" onclick="this.closest('tr').remove()">×</button></td>
      `;
      tbody.appendChild(tr);
    };

    // ========================================
    // SECTION: CLOSE EDIT MODAL
    // ========================================
    window.closeEditModal = () => {
      document.getElementById('editModal').classList.remove('show');
      if (!document.getElementById('signModal').classList.contains('show')) {
        currentEditDoc = null;
        currentEditPayload = null;
      }
    };
    // ========================================
    // SECTION: SAVE AND SIGN PATIENT DOCUMENT
    // ========================================
    window.saveAndSignPatDoc = async () => {
      try {
        showMsg('Daten werden gespeichert...', 'success');
        const btn = document.querySelector('#editModal .btn:not(.btn-secondary)');
        btn.disabled = true;

        const form = document.getElementById('editFormContainer');
        const formData = new FormData();
        const inputs = form.querySelectorAll('input, textarea, select');
        
        inputs.forEach(input => {
          if (input.type === 'checkbox') {
            formData.append(input.name, input.checked);
          } else if (input.type === 'radio') {
            if (input.checked) formData.append(input.name, input.value);
          } else {
            formData.append(input.name, input.value);
          }
        });

        const payload = {};
        for (let [key, value] of formData.entries()) {
          if (payload[key] !== undefined) continue;
          payload[key] = value === 'true' ? true : value === 'false' ? false : value;
        }

        // Collect medications
        const medications = [];
        for (let i = 1; i <= medRowCounter; i++) {
          const name = form.querySelector(`[name="med_name_${i}"]`)?.value;
          if (name) {
            medications.push({
              name,
              dose: form.querySelector(`[name="med_dose_${i}"]`)?.value || '',
              unit: form.querySelector(`[name="med_unit_${i}"]`)?.value || '',
              route: form.querySelector(`[name="med_route_${i}"]`)?.value || '',
              time: form.querySelector(`[name="med_time_${i}"]`)?.value || '',
              note: form.querySelector(`[name="med_note_${i}"]`)?.value || ''
            });
          }
        }
        payload.medications = medications;

        // Preserve photos and signature
        if (currentEditPayload.photos) {
          payload.photos = currentEditPayload.photos;
        }
        if (currentEditPayload.signature) {
          payload.signature = currentEditPayload.signature;
        }

        await pb.collection('patients').update(currentEditDoc.id, {
          payload: payload
        });

        document.getElementById('editModal').classList.remove('show');
        document.getElementById('signModal').classList.add('show');
        initAdminSigCanvas();
        
      } catch(e) {
        showMsg('Fehler beim Speichern: ' + e.message, 'error');
        const btn = document.querySelector('#editModal .btn:not(.btn-secondary)');
        btn.disabled = false;
      }
    };

    // ========================================
    // SECTION: ADMIN SIGNATURE CANVAS
    // ========================================
    let adminSigCanvas, adminSigCtx, adminIsDrawing = false;

    function initAdminSigCanvas() {
      adminSigCanvas = document.getElementById('adminSigCanvas');
      adminSigCtx = adminSigCanvas.getContext('2d');
      const rect = adminSigCanvas.getBoundingClientRect();
      adminSigCanvas.width = rect.width;
      adminSigCanvas.height = rect.height;
      adminSigCtx.lineWidth = 2;
      adminSigCtx.strokeStyle = '#000';
      adminSigCtx.lineCap = 'round';

      // Mouse events
      adminSigCanvas.addEventListener('mousedown', startAdminDraw);
      adminSigCanvas.addEventListener('mousemove', adminDraw);
      adminSigCanvas.addEventListener('mouseup', stopAdminDraw);
      adminSigCanvas.addEventListener('mouseleave', stopAdminDraw);

      // Touch events
      adminSigCanvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousedown', {
          clientX: touch.clientX,
          clientY: touch.clientY
        });
        adminSigCanvas.dispatchEvent(mouseEvent);
      });

      adminSigCanvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousemove', {
          clientX: touch.clientX,
          clientY: touch.clientY
        });
        adminSigCanvas.dispatchEvent(mouseEvent);
      });

      adminSigCanvas.addEventListener('touchend', (e) => {
        e.preventDefault();
        const mouseEvent = new MouseEvent('mouseup', {});
        adminSigCanvas.dispatchEvent(mouseEvent);
      });
    }

    function startAdminDraw(e) {
      adminIsDrawing = true;
      const rect = adminSigCanvas.getBoundingClientRect();
      adminSigCtx.beginPath();
      adminSigCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    }

    function adminDraw(e) {
      if (!adminIsDrawing) return;
      const rect = adminSigCanvas.getBoundingClientRect();
      adminSigCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
      adminSigCtx.stroke();
    }

    function stopAdminDraw() {
      adminIsDrawing = false;
    }

    window.clearAdminSig = () => {
      adminSigCtx.clearRect(0, 0, adminSigCanvas.width, adminSigCanvas.height);
    };

    window.closeSignModal = () => {
      document.getElementById('signModal').classList.remove('show');
    };

    // ========================================
    // SECTION: ARCHIVE WITH SIGNATURE
    // ========================================
    window.archiveWithSignature = async () => {
      try {
        const adminName = document.getElementById('adminName').value.trim();
        if (!adminName) {
          showMsg('Bitte Namen eingeben', 'error');
          return;
        }

        const signatureData = adminSigCanvas.toDataURL('image/png');
        
        await pb.collection('patients').update(currentEditDoc.id, {
          status: 'archiviert',
          admin_name: adminName,
          admin_datum: new Date().toISOString(),
          admin_unterschrift: signatureData
        });

        closeSignModal();
        showMsg('✅ Dokument archiviert!', 'success');
        await loadData();
        
        currentEditDoc = null;
        currentEditPayload = null;
        
      } catch(e) {
        showMsg('Fehler beim Archivieren: ' + e.message, 'error');
      }
    };

    // ========================================
    // SECTION: NACHERFASSUNG MODAL & SIGNATURE
    // ========================================
    document.getElementById('addBtn').onclick = () => {
      document.getElementById('nachForm').reset();
      document.getElementById('nachModal').classList.add('show');
      initNachSigCanvas();
    };

    window.closeNachModal = () => {
      document.getElementById('nachModal').classList.remove('show');
    };

    let nachSigCanvas, nachSigCtx, nachIsDrawing = false;

    function initNachSigCanvas() {
      nachSigCanvas = document.getElementById('nachSigCanvas');
      nachSigCtx = nachSigCanvas.getContext('2d');
      const rect = nachSigCanvas.getBoundingClientRect();
      nachSigCanvas.width = rect.width;
      nachSigCanvas.height = rect.height;
      nachSigCtx.lineWidth = 2;
      nachSigCtx.strokeStyle = '#000';
      nachSigCtx.lineCap = 'round';

      // Mouse events
      nachSigCanvas.addEventListener('mousedown', startNachDraw);
      nachSigCanvas.addEventListener('mousemove', nachDraw);
      nachSigCanvas.addEventListener('mouseup', stopNachDraw);
      nachSigCanvas.addEventListener('mouseleave', stopNachDraw);

      // Touch events
      nachSigCanvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousedown', {
          clientX: touch.clientX,
          clientY: touch.clientY
        });
        nachSigCanvas.dispatchEvent(mouseEvent);
      });

      nachSigCanvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousemove', {
          clientX: touch.clientX,
          clientY: touch.clientY
        });
        nachSigCanvas.dispatchEvent(mouseEvent);
      });

      nachSigCanvas.addEventListener('touchend', (e) => {
        e.preventDefault();
        const mouseEvent = new MouseEvent('mouseup', {});
        nachSigCanvas.dispatchEvent(mouseEvent);
      });
    }

    function startNachDraw(e) {
      nachIsDrawing = true;
      const rect = nachSigCanvas.getBoundingClientRect();
      nachSigCtx.beginPath();
      nachSigCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    }

    function nachDraw(e) {
      if (!nachIsDrawing) return;
      const rect = nachSigCanvas.getBoundingClientRect();
      nachSigCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
      nachSigCtx.stroke();
    }

    function stopNachDraw() {
      nachIsDrawing = false;
    }

    window.clearNachSig = () => {
      nachSigCtx.clearRect(0, 0, nachSigCanvas.width, nachSigCanvas.height);
    };

    // ========================================
    // SECTION: SAVE NACHERFASSUNG
    // ========================================
    window.saveNacherfassung = async () => {
      try {
        const form = document.getElementById('nachForm');
        const formData = new FormData(form);
        
        const nacherfassungData = {
          datum_alarmzeit: formData.get('datum_alarmzeit') || null,
          datum_einsatzende: formData.get('datum_einsatzende') || null,
          stichwort: formData.get('stichwort') || '',
          kategorie: formData.get('kategorie') || '',
          einsatznummer_ils: formData.get('einsatznummer_ils') || '',
          meldebild: formData.get('meldebild') || '',
          adresse: formData.get('adresse') || '',
          disponierte_em_fw: formData.get('disponierte_em_fw') || '',
          disponierte_em_rd: formData.get('disponierte_em_rd') || '',
          patienten_daten_erhoben: formData.get('patienten_daten_erhoben') === 'ja',
          patient_name: formData.get('patient_name') || '',
          patient_alter_geburtsdatum: formData.get('patient_alter_geburtsdatum') || '',
          patient_nummer_ils: formData.get('patient_nummer_ils') || '',
          sachverhalt: formData.get('sachverhalt') || '',
          protokollpflichtig: formData.get('protokollpflichtig') === 'ja',
          protokollpflichtig_begruendung: formData.get('protokollpflichtig_begruendung') || '',
          verantwortlicher_unterwiesen: formData.get('verantwortlicher_unterwiesen') === 'ja',
          verantwortlicher_name: formData.get('verantwortlicher_name') || '',
          verantwortlicher_qualifikation: formData.get('verantwortlicher_qualifikation') || '',
          nacherfasst_von_name: formData.get('nacherfasst_von_name') || '',
          nacherfasst_von_qualifikation: formData.get('nacherfasst_von_qualifikation') || '',
          nacherfasst_datum: new Date().toISOString(),
          nacherfasst_unterschrift: nachSigCanvas.toDataURL('image/png'),
          status: 'offen',
          organization_id: currentUser.organization_id
        };

        await pb.collection('patient_docs_nacherfassung').create(nacherfassungData);

        closeNachModal();
        showMsg('✅ Nacherfassung gespeichert!', 'success');
        await loadData();
        
      } catch(e) {
        showMsg('Fehler: ' + e.message, 'error');
      }
    };

    // ========================================
    // SECTION: ARCHIVE NACHERFASSUNG
    // ========================================
    window.archiveNach = async (id) => {
      if (!confirm('Nacherfassung ins Archiv verschieben?')) return;
      try {
        await pb.collection('patient_docs_nacherfassung').update(id, {
          status: 'archiviert'
        });
        
        showMsg('✅ Nacherfassung archiviert!', 'success');
        await loadData();
      } catch(e) {
        showMsg('Fehler: ' + e.message, 'error');
      }
    };
    // ========================================
    // SECTION: VIEW NACHERFASSUNG DETAILS
    // ========================================
    window.viewNach = async (id) => {
      try {
        const doc = await pb.collection('patient_docs_nacherfassung').getOne(id);
        
        window.currentViewedNachData = doc;
        window.currentViewedDocType = 'nacherfassung';
        
        document.getElementById('detailsTitle').textContent = 'Nacherfassung: ' + (doc.stichwort || '?');
        
        let html = buildNachDetailsHTML(doc);
        
        document.getElementById('detailsBody').innerHTML = html;
        document.getElementById('detailsModal').classList.add('show');
        
      } catch(e) {
        showMsg('Fehler: ' + e.message, 'error');
      }
    };
    
    // ========================================
    // SECTION: BUILD NACHERFASSUNG DETAILS HTML
    // ========================================
    function buildNachDetailsHTML(doc) {
      let html = '<div class="details-grid">';
      html += `<div class="details-label">Alarmzeit:</div><div class="details-value">${doc.datum_alarmzeit ? new Date(doc.datum_alarmzeit).toLocaleString('de-DE') : '-'}</div>`;
      html += `<div class="details-label">Einsatzende:</div><div class="details-value">${doc.datum_einsatzende ? new Date(doc.datum_einsatzende).toLocaleString('de-DE') : '-'}</div>`;
      html += `<div class="details-label">Stichwort:</div><div class="details-value">${doc.stichwort || '-'}</div>`;
      html += `<div class="details-label">Kategorie:</div><div class="details-value">${doc.kategorie || '-'}</div>`;
      html += `<div class="details-label">Einsatznummer ILS:</div><div class="details-value">${doc.einsatznummer_ils || '-'}</div>`;
      html += `<div class="details-label">Meldebild:</div><div class="details-value">${doc.meldebild || '-'}</div>`;
      html += `<div class="details-label">Adresse:</div><div class="details-value">${doc.adresse || '-'}</div>`;
      html += `<div class="details-label">Disponierte EM (FW):</div><div class="details-value">${doc.disponierte_em_fw || '-'}</div>`;
      html += `<div class="details-label">Disponierte EM (RD):</div><div class="details-value">${doc.disponierte_em_rd || '-'}</div>`;
      html += `<div class="details-label">Patienten-Daten erhoben:</div><div class="details-value">${doc.patienten_daten_erhoben ? 'Ja' : 'Nein'}</div>`;
      
      if (doc.patienten_daten_erhoben) {
        html += `<div class="details-label">Patient Name:</div><div class="details-value">${doc.patient_name || '-'}</div>`;
        html += `<div class="details-label">Alter/Geburtsdatum:</div><div class="details-value">${doc.patient_alter_geburtsdatum || '-'}</div>`;
        html += `<div class="details-label">Pat.-Nummer ILS:</div><div class="details-value">${doc.patient_nummer_ils || '-'}</div>`;
      }
      
      html += `<div class="details-label">Sachverhalt:</div><div class="details-value">${doc.sachverhalt || '-'}</div>`;
      html += `<div class="details-label">Protokollpflichtig:</div><div class="details-value">${doc.protokollpflichtig ? 'Ja' : 'Nein'}</div>`;
      
      if (doc.protokollpflichtig) {
        html += `<div class="details-label">Begründung:</div><div class="details-value">${doc.protokollpflichtig_begruendung || '-'}</div>`;
      }
      
      html += `<div class="details-label">Verantwortlicher unterwiesen:</div><div class="details-value">${doc.verantwortlicher_unterwiesen ? 'Ja' : 'Nein'}</div>`;
      html += `<div class="details-label">Verantwortlicher Name:</div><div class="details-value">${doc.verantwortlicher_name || '-'}</div>`;
      html += `<div class="details-label">Verantwortlicher Qualifikation:</div><div class="details-value">${doc.verantwortlicher_qualifikation || '-'}</div>`;
      html += `<div class="details-label">Nacherfasst von:</div><div class="details-value">${doc.nacherfasst_von_name || '-'} (${doc.nacherfasst_von_qualifikation || '-'})</div>`;
      html += `<div class="details-label">Nacherfasst am:</div><div class="details-value">${doc.nacherfasst_datum ? new Date(doc.nacherfasst_datum).toLocaleString('de-DE') : '-'}</div>`;
      
      if (doc.nacherfasst_unterschrift) {
        html += `<div class="details-label">Unterschrift:</div><div class="details-value"><img src="${doc.nacherfasst_unterschrift}" class="signature-img"></div>`;
      }
      
      html += '</div>';
      return html;
    }
    
    // ========================================
    // SECTION: VIEW ARCHIVED PATIENT DOCUMENT (NEU - MIT FORMULAR-ANSICHT!)
    // ========================================
    window.viewPatArchiv = async (id) => {
      try {
        const doc = await pb.collection('patients').getOne(id);
        const p = doc.payload || {};
        
        window.currentViewedPayload = p;
        window.currentViewedAdmin = {
          name: doc.admin_name,
          datum: doc.admin_datum,
          unterschrift: doc.admin_unterschrift
        };
        window.currentViewedOrgName = currentOrganization?.name || 'Feuerwehr';
        window.currentViewedDocType = 'patient';
        
        const patName = `${p.vorname || ''} ${p.name || ''}`.trim() || 'Unbekannt';
        document.getElementById('detailsTitle').textContent = 'Patientendokumentation: ' + patName;
        
        // NEU: Verwende buildEditForm() aber als Read-Only Ansicht
        let html = buildPatArchiveHTML(p, doc);
        
        document.getElementById('detailsBody').innerHTML = html;
        
        // Öffne alle details-Elemente
        document.querySelectorAll('#detailsBody details').forEach(d => d.open = true);
        
        document.getElementById('detailsModal').classList.add('show');
        
      } catch(e) {
        showMsg('Fehler: ' + e.message, 'error');
      }
    };

    // ========================================
    // SECTION: BUILD PATIENT ARCHIVE HTML (NEU - IDENTISCH MIT EDIT-FORMULAR!)
    // ========================================
    function buildPatArchiveHTML(p, doc) {
      const v = (key, fallback = '') => 
        p[key] !== undefined && p[key] !== null ? p[key] : fallback;
      
      const checked = (key) => p[key] ? '✓' : '';
      
      const radioValue = (key) => p[key] || '-';
      
      // Build medication rows (read-only)
      const medications = p.medications || [];
      let medRowsHTML = '';
      if (medications.length > 0) {
        medications.forEach((med, idx) => {
          medRowsHTML += `
            <tr>
              <td>${idx + 1}</td>
              <td>${med.name || '-'}</td>
              <td>${med.dose || '-'}</td>
              <td>${med.unit || '-'}</td>
              <td>${med.route || '-'}</td>
              <td>${med.time || '-'}</td>
              <td>${med.note || '-'}</td>
            </tr>
          `;
        });
      } else {
        medRowsHTML = '<tr><td colspan="7" style="text-align:center;color:#999">Keine Medikamente dokumentiert</td></tr>';
      }
      
      // Build photos display
      const photos = p.photos || [];
      let photosHTML = '';
      if (photos.length > 0) {
        photosHTML = '<div class="photo-grid">';
        photos.forEach((photo, idx) => {
          photosHTML += `<img src="${photo}" alt="Foto ${idx+1}">`;
        });
        photosHTML += '</div>';
      }
      
      // Return complete READONLY form HTML (same structure as edit form!)
      return `
<details open>
  <summary><i class="fa-solid fa-truck-medical"></i> Einsatzdaten</summary>
  <div class="sec-body">
    <div class="grid">
      <div><strong>Einsatz-Nr:</strong><br>${v('einsatz_nr')}</div>
      <div><strong>Pat./Auftrags-Nr:</strong><br>${v('auftrags_nr')}</div>
      <div><strong>Rufname:</strong><br>${v('rufname')}</div>
      <div><strong>Fahrzeug:</strong><br>${v('fahrzeug')}</div>
      <div><strong>Datum/Uhrzeit:</strong><br>${v('zeit_einsatz') ? new Date(v('zeit_einsatz')).toLocaleString('de-DE') : '-'}</div>
    </div>
    <div style="margin-top:12px"><strong>Einsatz-Art:</strong><br>${v('einsatz_art')}</div>
  </div>
</details>

<details open>
  <summary><i class="fa-solid fa-id-card-clip"></i> Pat-Stammdaten</summary>
  <div class="sec-body">
    <div class="grid">
      <div><strong>Name:</strong><br>${v('name')}</div>
      <div><strong>Vorname:</strong><br>${v('vorname')}</div>
      <div><strong>Geb.-Datum:</strong><br>${v('gebdatum') ? new Date(v('gebdatum')).toLocaleDateString('de-DE') : '-'}</div>
      <div><strong>Alter:</strong><br>${v('alter')}</div>
      <div><strong>Telefon:</strong><br>${v('telefon')}</div>
      <div><strong>Mobil:</strong><br>${v('mobil')}</div>
      <div><strong>Straße:</strong><br>${v('strasse')}</div>
      <div><strong>PLZ, Ort:</strong><br>${v('plz_ort')}</div>
      <div><strong>Kasse:</strong><br>${v('kasse')}</div>
      <div><strong>Vers.-Nr:</strong><br>${v('versnr')}</div>
      <div><strong>Hausarzt:</strong><br>${v('hausarzt')}</div>
      <div><strong>Angehöriger:</strong><br>${v('angehoeriger')}</div>
    </div>
    <div style="margin-top:12px"><strong>Informationen / Aspekte:</strong><br>${v('infos') || '-'}</div>
  </div>
</details>

<details open>
  <summary><i class="fa-solid fa-notes-medical"></i> Notfallgeschehen / Anamnese</summary>
  <div class="sec-body">
    <div>${v('notfallgeschehen') || '-'}</div>
    ${photosHTML ? '<div style="margin-top:12px"><strong>Fotos:</strong>' + photosHTML + '</div>' : ''}
  </div>
</details>

<details>
  <summary><i class="fa-solid fa-brain"></i> Neurologie</summary>
  <div class="sec-body">
    <div class="grid">
      <div><strong>Zeitpunkt:</strong><br>${v('neu_zeit') ? new Date(v('neu_zeit')).toLocaleString('de-DE') : '-'}</div>
      <div><strong>Ohne path. Befund:</strong> ${checked('neu_unauff')}</div>
    </div>
    <div class="grid" style="margin-top:12px">
      <fieldset>
        <legend>Pupillenweite – rechts</legend>
        <div><strong>Weite:</strong> ${radioValue('pw_r')}</div>
        <div><strong>Entrundet:</strong> ${checked('pw_r_entrundet')}</div>
        <div><strong>Lichtreaktion:</strong> ${radioValue('lr_r')}</div>
      </fieldset>
      <fieldset>
        <legend>Pupillenweite – links</legend>
        <div><strong>Weite:</strong> ${radioValue('pw_l')}</div>
        <div><strong>Entrundet:</strong> ${checked('pw_l_entrundet')}</div>
        <div><strong>Lichtreaktion:</strong> ${radioValue('lr_l')}</div>
      </fieldset>
    </div>
  </div>
</details>

<details>
  <summary><i class="fa-solid fa-eye"></i> Glasgow Coma Scale</summary>
  <div class="sec-body">
    <fieldset>
      <legend>GCS Werte</legend>
      <div><strong>Augenöffnung (E):</strong> ${v('gcs_e') || '-'}</div>
      <div><strong>Verbale Antwort (V):</strong> ${v('gcs_v') || '-'}</div>
      <div><strong>Motorische Antwort (M):</strong> ${v('gcs_m') || '-'}</div>
      <div class="badge" style="margin-top:8px">GCS Summe: ${calculateGCS(p)}</div>
    </fieldset>
  </div>
</details>

<details>
  <summary><i class="fa-regular fa-hand"></i> Haut</summary>
  <div class="sec-body">
    <div>
      ${checked('haut_unauff') ? '✓ unauffällig ' : ''}
      ${checked('haut_falten') ? '✓ stehende Hautfalten ' : ''}
      ${checked('haut_oedeme') ? '✓ Ödeme ' : ''}
      ${checked('haut_dekubitus') ? '✓ Dekubitus ' : ''}
      ${checked('haut_kaltschweissig') ? '✓ kaltschweißig ' : ''}
      ${checked('haut_exanthem') ? '✓ Exanthem' : ''}
    </div>
  </div>
</details>

<details>
  <summary><i class="fa-solid fa-user"></i> Psyche</summary>
  <div class="sec-body">
    <div>
      ${checked('psy_erregt') ? '✓ erregt ' : ''}
      ${checked('psy_aggr') ? '✓ aggressiv ' : ''}
      ${checked('psy_verlangsamt') ? '✓ verlangsamt ' : ''}
      ${checked('psy_depressiv') ? '✓ depressiv ' : ''}
      ${checked('psy_aengstlich') ? '✓ ängstlich ' : ''}
      ${checked('psy_euphorisch') ? '✓ euphorisch ' : ''}
      ${checked('psy_wahnhaft') ? '✓ wahnhaft ' : ''}
      ${checked('psy_verwirrt') ? '✓ verwirrt ' : ''}
      ${checked('psy_suizidal') ? '✓ suizidal ' : ''}
      ${checked('psy_motor_unruhig') ? '✓ motorisch unruhig' : ''}
    </div>
  </div>
</details>

<details open>
  <summary><i class="fa-solid fa-stethoscope"></i> Messwerte / Atmung</summary>
  <div class="sec-body">
    <div class="grid">
      <div><strong>RR syst.:</strong><br>${v('rr_sys')} mmHg</div>
      <div><strong>RR diast.:</strong><br>${v('rr_dia')} mmHg</div>
      <div><strong>HF:</strong><br>${v('hf')} /min</div>
      <div><strong>AF:</strong><br>${v('af')} /min</div>
      <div><strong>SpO₂:</strong><br>${v('spo2')} %</div>
      <div><strong>etCO₂:</strong><br>${v('etco2')} mmHg</div>
      <div><strong>Temp:</strong><br>${v('temp')} °C</div>
      <div><strong>BZ (mg/dl):</strong><br>${v('bz_mg')}</div>
      <div><strong>BZ (mmol/l):</strong><br>${v('bz_mmol')}</div>
      <div><strong>Schmerz:</strong><br>${v('schmerz')} / 10</div>
    </div>
    <fieldset style="margin-top:12px">
      <legend>qSOFA Score</legend>
      <div class="badge">qSOFA: ${calculateQSOFA(p)}</div>
    </fieldset>
    <fieldset>
      <legend>Atmung – klinische Zeichen</legend>
      <div>
        ${checked('atm_apnoe') ? '✓ Apnoe ' : ''}
        ${checked('atm_stridor') ? '✓ Stridor ' : ''}
        ${checked('atm_hypervent') ? '✓ Hyperventilation ' : ''}
        ${checked('atm_dyspnoe') ? '✓ Dyspnoe ' : ''}
        ${checked('atm_beatmung') ? '✓ Beatmung ' : ''}
        ${checked('atm_zyanose') ? '✓ Zyanose ' : ''}
        ${checked('atm_verlegung') ? '✓ Atemwegsverlegung' : ''}
      </div>
      ${v('atm_sonst') ? '<div style="margin-top:8px"><strong>Sonstiges:</strong><br>' + v('atm_sonst') + '</div>' : ''}
    </fieldset>
    <fieldset>
      <legend>O₂-Gabe</legend>
      <div><strong>Art:</strong> ${radioValue('o2')}</div>
      <div>
        ${checked('o2_nasal') ? '✓ Nasensonde ' : ''}
        ${checked('o2_maske') ? '✓ Maske ' : ''}
        ${checked('o2_reservoir') ? '✓ Maske m. Reservoir' : ''}
      </div>
      <div><strong>Flow:</strong> ${v('o2_flow')} l/min</div>
      ${v('o2_comment') ? '<div><strong>Kommentar:</strong> ' + v('o2_comment') + '</div>' : ''}
    </fieldset>
  </div>
</details>

<details>
  <summary><i class="fa-solid fa-heart-pulse"></i> Rhythmus / EKG</summary>
  <div class="sec-body">
    <div>
      ${checked('sr') ? '✓ Sinusrhythmus ' : ''}
      ${checked('stemi') ? '✓ STEMI ' : ''}
      ${checked('arrh_abs') ? '✓ absolute Arrhythmie ' : ''}
      ${checked('vf') ? '✓ Kammerflimmern ' : ''}
      ${checked('av3') ? '✓ AV-Block III° ' : ''}
      ${checked('asystole') ? '✓ Asystolie' : ''}
    </div>
    <div class="grid" style="margin-top:12px">
      <div><strong>Standort:</strong><br>${v('ekg_standort')}</div>
      <div><strong>Pers-Nr.:</strong><br>${v('ekg_persnr')}</div>
    </div>
  </div>
</details>

<details>
  <summary><i class="fa-solid fa-kit-medical"></i> Verletzungen</summary>
  <div class="sec-body">
    <div>${v('verletz_text') || '-'}</div>
  </div>
</details>

<details>
  <summary><i class="fa-solid fa-clipboard-list"></i> Erstdiagnosen</summary>
  <div class="sec-body">
    <div class="grid">
      <fieldset>
        <legend>Neuro</legend>
        <div>
          ${checked('diag_krampf') ? '✓ Konvulsionen ' : ''}
          ${checked('diag_synkope') ? '✓ Synkope ' : ''}
          ${checked('diag_apoplex') ? '✓ Apoplex ' : ''}
          ${checked('diag_sht') ? '✓ SHT' : ''}
        </div>
      </fieldset>
      <fieldset>
        <legend>Herz-Kreislauf</legend>
        <div>
          ${checked('diag_acs') ? '✓ ACS ' : ''}
          ${checked('diag_insuff') ? '✓ Herzinsuffizienz ' : ''}
          ${checked('diag_lungenoedem') ? '✓ Lungenödem ' : ''}
          ${checked('diag_luembol') ? '✓ Lungenembolie' : ''}
        </div>
      </fieldset>
      <fieldset>
        <legend>Atmung</legend>
        <div>
          ${checked('diag_resp_insuff') ? '✓ resp. Insuffizienz ' : ''}
          ${checked('diag_pneumothorax') ? '✓ Pneumothorax ' : ''}
          ${checked('diag_asthma') ? '✓ Asthma/COPD' : ''}
        </div>
      </fieldset>
      <fieldset>
        <legend>Stoffwechsel / Schock</legend>
        <div>
          ${checked('diag_hypo') ? '✓ Hypoglykämie ' : ''}
          ${checked('diag_sept') ? '✓ septischer Schock ' : ''}
          ${checked('diag_hypovol') ? '✓ hypovolämischer Schock' : ''}
        </div>
      </fieldset>
    </div>
  </div>
</details>

<details>
  <summary><i class="fa-solid fa-face-meh"></i> Bewusstseinslage, AZ, Versorgung</summary>
  <div class="sec-body">
    <div class="grid">
      <fieldset>
        <legend>Bewusstseinslage</legend>
        <div>
          ${checked('bew_wach') ? '✓ wach ' : ''}
          ${checked('bew_ansprache') ? '✓ Reaktion auf Ansprache ' : ''}
          ${checked('bew_schmerz') ? '✓ Reaktion auf Schmerzreiz ' : ''}
          ${checked('bew_bewusstlos') ? '✓ bewusstlos' : ''}
        </div>
      </fieldset>
      <fieldset>
        <legend>Allgemeinzustand</legend>
        <div><strong>AZ:</strong> ${radioValue('az')}</div>
      </fieldset>
      <fieldset>
        <legend>Versorgungssituation</legend>
        <div><strong>Versorgung:</strong> ${radioValue('versorgung')}</div>
      </fieldset>
    </div>
  </div>
</details>

<details open>
  <summary><i class="fa-solid fa-syringe"></i> Maßnahmen – Zugang & Medikation</summary>
  <div class="sec-body">
    <fieldset>
      <legend>Zugang</legend>
      <div class="grid">
        <div><strong>Art:</strong><br>${v('zugang_art')}</div>
        <div><strong>Seite/Region:</strong><br>${v('zugang_region')}</div>
        <div><strong>Größe:</strong><br>${v('zugang_gauge')}G</div>
        <div><strong>Versuche:</strong><br>${v('zugang_versuche')}</div>
        <div><strong>Zeitpunkt:</strong><br>${v('zugang_zeit') ? new Date(v('zugang_zeit')).toLocaleString('de-DE') : '-'}</div>
      </div>
    </fieldset>
    <fieldset>
      <legend>Infusion</legend>
      <div class="grid">
        <div><strong>Art:</strong><br>${v('inf_art')}</div>
        <div><strong>Menge:</strong><br>${v('inf_menge')} ml</div>
        <div><strong>Laufrate:</strong><br>${v('inf_rate')} ml/h</div>
        <div><strong>Bemerkung:</strong><br>${v('inf_bem')}</div>
      </div>
    </fieldset>
    <fieldset>
      <legend>Medikamente</legend>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Medikament</th>
            <th>Dosis</th>
            <th>Einheit</th>
            <th>Route</th>
            <th>Uhrzeit</th>
            <th>Bemerkung</th>
          </tr>
        </thead>
        <tbody>${medRowsHTML}</tbody>
      </table>
    </fieldset>
  </div>
</details>

<details>
  <summary><i class="fa-solid fa-wind"></i> Beatmung / Atemweg</summary>
  <div class="sec-body">
    <div>
      ${checked('aw_guedel') ? '✓ Guedel ' : ''}
      ${checked('aw_larynxtubus') ? '✓ Larynxtubus ' : ''}
      ${checked('aw_ett') ? '✓ ETT ' : ''}
      ${checked('aw_bvm') ? '✓ BVM' : ''}
    </div>
    <div class="grid" style="margin-top:12px">
      <div><strong>ETT-Größe:</strong><br>${v('aw_ett_size')}</div>
      <div><strong>PEEP:</strong><br>${v('vent_peep')} cmH₂O</div>
      <div><strong>FiO₂:</strong><br>${v('vent_fio2')} %</div>
    </div>
  </div>
</details>

<details>
  <summary><i class="fa-solid fa-heart-circle-bolt"></i> Reanimation</summary>
  <div class="sec-body">
    <div class="grid">
      <div><strong>Rea-Beginn:</strong><br>${v('rea_beginn') ? new Date(v('rea_beginn')).toLocaleString('de-DE') : '-'}</div>
      <div><strong>Erst-Rhythmus:</strong><br>${v('rea_initial')}</div>
      <div><strong>Schocks:</strong><br>${v('rea_shocks')}</div>
      <div><strong>ROSC:</strong><br>${v('rea_rosc')}</div>
      <div><strong>Rea-Ende:</strong><br>${v('rea_ende')}</div>
    </div>
  </div>
</details>

<details open>
  <summary><i class="fa-solid fa-people-carry-box"></i> Übergabe / Transport</summary>
  <div class="sec-body">
    <div class="grid">
      <div><strong>Übergabe an:</strong><br>${v('ue_name')}</div>
      <div><strong>Zeitpunkt:</strong><br>${v('ue_zeit') ? new Date(v('ue_zeit')).toLocaleString('de-DE') : '-'}</div>
      <div><strong>Ziel:</strong><br>${v('ziel_bez')}</div>
      <div><strong>Adresse:</strong><br>${v('ziel_adr')}</div>
      <div><strong>Einsatzende:</strong><br>${v('einsatzende') ? new Date(v('einsatzende')).toLocaleString('de-DE') : '-'}</div>
    </div>
  </div>
</details>

<details open>
  <summary><i class="fa-solid fa-signature"></i> Ausfüller & Unterschrift</summary>
  <div class="sec-body">
    <div class="grid">
      <div><strong>Name:</strong><br>${v('ausfueller_name')}</div>
      <div><strong>Zeitpunkt:</strong><br>${v('ausfueller_zeit') ? new Date(v('ausfueller_zeit')).toLocaleString('de-DE') : '-'}</div>
    </div>
    ${p.signature ? '<div style="margin-top:12px"><strong>Unterschrift:</strong><br><img src="' + p.signature + '" class="signature-img"></div>' : ''}
  </div>
</details>

<details open>
  <summary><i class="fa-solid fa-user-shield"></i> MPG-Beauftragter</summary>
  <div class="sec-body">
    <div class="grid">
      <div><strong>Name:</strong><br>${doc.admin_name || '-'}</div>
      <div><strong>Zeitpunkt:</strong><br>${doc.admin_datum ? new Date(doc.admin_datum).toLocaleString('de-DE') : '-'}</div>
    </div>
    ${doc.admin_unterschrift ? '<div style="margin-top:12px"><strong>Unterschrift:</strong><br><img src="' + doc.admin_unterschrift + '" class="signature-img"></div>' : ''}
  </div>
</details>`;
    }

    // ========================================
    // SECTION: VIEW ARCHIVED NACHERFASSUNG
    // ========================================
    window.viewNachArchiv = async (id) => {
      await viewNach(id);
    };

    // ========================================
    // SECTION: CLOSE DETAILS MODAL
    // ========================================
    window.closeDetailsModal = () => {
      document.getElementById('detailsModal').classList.remove('show');
    };

    // ========================================
    // SECTION: GENERATE PDF FROM MODAL
    // ========================================
    window.generatePDFFromModal = async () => {
      const docType = window.currentViewedDocType;
      
      if (docType === 'nacherfassung') {
        await generateNacherfassungPDF(window.currentViewedNachData || {});
      } else {
        await generatePatientPDF();
      }
    };
    // ========================================
    // SECTION: GENERATE PATIENT PDF - KOMPLETT NEU
    // ========================================
    async function generatePatientPDF() {
      try {
        showMsg('📄 PDF wird erstellt...', 'success');
        
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        
        const p = window.currentViewedPayload || {};
        const adminData = window.currentViewedAdmin || {};
        const orgName = currentOrganization?.name || 'Feuerwehr';
        
        const pageWidth = 210;
        const pageHeight = 297;
        const margin = 15;
        const fullWidth = pageWidth - 2 * margin;
        
        let currentY = 0;
        let pageNum = 1;
        
        // ========================================
        // PDF HEADER FUNCTION
        // ========================================
        function addHeader(isFirstPage = false) {
          pdf.setFillColor(200, 16, 46);
          pdf.rect(0, 0, pageWidth, isFirstPage ? 35 : 25, 'F');
          
          pdf.setTextColor(255, 255, 255);
          pdf.setFontSize(isFirstPage ? 20 : 14);
          pdf.setFont(undefined, 'bold');
          
          if (isFirstPage) {
            pdf.text(orgName, margin, 12);
            pdf.setFontSize(16);
            pdf.text('NOTFALLPROTOKOLL', margin, 24);
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            pdf.text('Erstellt: ' + new Date().toLocaleString('de-DE', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit'
            }), pageWidth - margin - 65, 24);
          } else {
            pdf.text(`NOTFALLPROTOKOLL - Seite ${pageNum}`, margin, 16);
          }
          
          pdf.setTextColor(0, 0, 0);
        }
        
        // ========================================
        // HELPER: CHECK PAGE BREAK
        // ========================================
        function checkPageBreak(neededHeight) {
          if (currentY + neededHeight > pageHeight - 20) {
            pdf.addPage();
            pageNum++;
            addHeader(false);
            currentY = 30;
            return true;
          }
          return false;
        }
        
        // ========================================
        // HELPER: DRAW SECTION BOX
        // ========================================
        function drawSection(title, height) {
          pdf.setFillColor(255, 240, 245);
          pdf.rect(margin, currentY, fullWidth, height, 'F');
          
          pdf.setFillColor(255, 220, 235);
          pdf.rect(margin, currentY, fullWidth, 7, 'F');
          
          pdf.setTextColor(200, 16, 46);
          pdf.setFontSize(11);
          pdf.setFont(undefined, 'bold');
          pdf.text(title, margin + 2, currentY + 5);
          
          pdf.setTextColor(0, 0, 0);
          pdf.setFont(undefined, 'normal');
          
          return currentY + 9;
        }
        
        // ========================================
        // HELPER: ADD FIELD
        // ========================================
        function addField(x, y, label, value) {
          pdf.setFontSize(9);
          pdf.setFont(undefined, 'bold');
          pdf.text(label, x, y);
          
          pdf.setFont(undefined, 'normal');
          pdf.setFontSize(10);
          pdf.text(String(value || '-'), x, y + 4);
          
          return y + 9;
        }
        
        // ========================================
        // PAGE 1 START
        // ========================================
        addHeader(true);
        currentY = 40;
        
        // SECTION 1: EINSATZDATEN
        checkPageBreak(38);
        let boxY = drawSection('1. EINSATZDATEN', 38);
        
        const col3W = (fullWidth - 6) / 3;
        addField(margin + 2, boxY, 'Einsatz-Nr:', p.einsatz_nr);
        addField(margin + 2 + col3W + 3, boxY, 'Datum/Uhrzeit:', 
          p.zeit_einsatz ? new Date(p.zeit_einsatz).toLocaleString('de-DE') : '-');
        addField(margin + 2 + 2*col3W + 6, boxY, 'Pat./Auftrags-Nr:', p.auftrags_nr);
        
        addField(margin + 2, boxY + 12, 'Fahrzeug:', p.fahrzeug);
        addField(margin + 2 + col3W + 3, boxY + 12, 'Rufname:', p.rufname);
        addField(margin + 2 + 2*col3W + 6, boxY + 12, 'Einsatz-Art:', p.einsatz_art);
        
        currentY += 40;
        
        // SECTION 2: PATIENT
        checkPageBreak(38);
        boxY = drawSection('2. PATIENT', 38);
        
        const patName = `${p.vorname || ''} ${p.name || ''}`.trim();
        addField(margin + 2, boxY, 'Name:', patName);
        addField(margin + 2 + col3W + 3, boxY, 'Straße:', p.strasse);
        addField(margin + 2 + 2*col3W + 6, boxY, 'Kasse:', p.kasse);
        
        addField(margin + 2, boxY + 12, 'Geburtsdatum:', 
          p.gebdatum ? new Date(p.gebdatum).toLocaleDateString('de-DE') : '-');
        addField(margin + 2 + col3W + 3, boxY + 12, 'PLZ, Ort:', p.plz_ort);
        addField(margin + 2 + 2*col3W + 6, boxY + 12, 'Vers.-Nr.:', p.versnr);
        
        addField(margin + 2, boxY + 24, 'Alter:', p.alter);
        addField(margin + 2 + col3W + 3, boxY + 24, 'Telefon:', p.telefon || p.mobil);
        addField(margin + 2 + 2*col3W + 6, boxY + 24, 'Hausarzt:', p.hausarzt);
        
        currentY += 40;
        
        // SECTION 3: ANAMNESE
        checkPageBreak(50);
        boxY = drawSection('3. ANAMNESE / NOTFALLGESCHEHEN', 50);
        
        pdf.setFontSize(9.5);
        const anamLines = pdf.splitTextToSize(p.notfallgeschehen || '-', fullWidth - 4);
        pdf.text(anamLines.slice(0, 18), margin + 2, boxY);
        
        currentY += 52;
        
        // ========================================
        // PAGE 2 START
        // ========================================
        checkPageBreak(38);
        
        // SECTION 4 & 5: VORERKRANKUNGEN / VERLETZUNGEN
        const col2W = (fullWidth - 3) / 2;
        
        boxY = drawSection('4. VORERKRANKUNGEN / ALLERGIEN', 38);
        pdf.setFontSize(9);
        const infosLines = pdf.splitTextToSize(p.infos || '-', col2W - 4);
        pdf.text(infosLines.slice(0, 12), margin + 2, boxY);
        
        pdf.setFillColor(255, 240, 245);
        pdf.rect(margin + col2W + 3, currentY, col2W, 38, 'F');
        pdf.setFillColor(255, 220, 235);
        pdf.rect(margin + col2W + 3, currentY, col2W, 7, 'F');
        pdf.setTextColor(200, 16, 46);
        pdf.setFontSize(11);
        pdf.setFont(undefined, 'bold');
        pdf.text('5. VERLETZUNGEN', margin + col2W + 5, currentY + 5);
        pdf.setTextColor(0, 0, 0);
        pdf.setFont(undefined, 'normal');
        pdf.setFontSize(9);
        const verlLines = pdf.splitTextToSize(p.verletz_text || '-', col2W - 4);
        pdf.text(verlLines.slice(0, 12), margin + col2W + 5, currentY + 11);
        
        currentY += 40;
        
        // SECTION 6: VITALPARAMETER
        checkPageBreak(33);
        boxY = drawSection('6. VITALPARAMETER', 33);
        
        const col4W = (fullWidth - 9) / 4;
        addField(margin + 2, boxY, 'RR:', `${p.rr_sys || '-'} / ${p.rr_dia || '-'} mmHg`);
        addField(margin + 2 + col4W + 3, boxY, 'AF:', `${p.af || '-'} /min`);
        addField(margin + 2 + 2*col4W + 6, boxY, 'Temp:', `${p.temp || '-'} °C`);
        addField(margin + 2 + 3*col4W + 9, boxY, 'etCO₂:', `${p.etco2 || '-'} mmHg`);
        
        addField(margin + 2, boxY + 10, 'HF:', `${p.hf || '-'} /min`);
        addField(margin + 2 + col4W + 3, boxY + 10, 'SpO₂:', `${p.spo2 || '-'} %`);
        addField(margin + 2 + 2*col4W + 6, boxY + 10, 'BZ:', `${p.bz_mg || '-'} mg/dl`);
        addField(margin + 2 + 3*col4W + 9, boxY + 10, 'Schmerz:', `${p.schmerz || '-'} / 10`);
        
        currentY += 35;
        
        // SECTION 7 & 8: NEUROLOGIE / ATMUNG
        checkPageBreak(35);
        
        const gcsE = parseInt(p.gcs_e || 0);
        const gcsV = parseInt(p.gcs_v || 0);
        const gcsM = parseInt(p.gcs_m || 0);
        const gcsSum = gcsE + gcsV + gcsM;
        
        boxY = drawSection('7. NEUROLOGIE / GCS', 35);
        addField(margin + 2, boxY, 'GCS:', `E${gcsE} + V${gcsV} + M${gcsM} = ${gcsSum > 0 ? gcsSum : '—'}`);
        addField(margin + 2, boxY + 10, 'Pupillen R:', `${p.pw_r || '-'} / ${p.lr_r || '-'}`);
        addField(margin + 2, boxY + 20, 'Pupillen L:', `${p.pw_l || '-'} / ${p.lr_l || '-'}`);
        
        const bewLines = [
          p.bew_wach ? 'wach' : null,
          p.bew_ansprache ? 'Ansprache' : null,
          p.bew_schmerz ? 'Schmerz' : null,
          p.bew_bewusstlos ? 'bewusstlos' : null
        ].filter(x => x).join(', ');
        
        pdf.setFillColor(255, 240, 245);
        pdf.rect(margin + col2W + 3, currentY, col2W, 35, 'F');
        pdf.setFillColor(255, 220, 235);
        pdf.rect(margin + col2W + 3, currentY, col2W, 7, 'F');
        pdf.setTextColor(200, 16, 46);
        pdf.setFontSize(11);
        pdf.setFont(undefined, 'bold');
        pdf.text('8. ATMUNG', margin + col2W + 5, currentY + 5);
        pdf.setTextColor(0, 0, 0);
        pdf.setFont(undefined, 'normal');
        
        const atmLines = [
          p.atm_apnoe ? 'Apnoe' : null,
          p.atm_stridor ? 'Stridor' : null,
          p.atm_dyspnoe ? 'Dyspnoe' : null,
          p.atm_zyanose ? 'Zyanose' : null
        ].filter(x => x).join(', ');
        
        addField(margin + col2W + 5, currentY + 11, 'Zeichen:', atmLines || '-');
        addField(margin + col2W + 5, currentY + 20, 'O₂-Gabe:', p.o2 || '-');
        
        const o2Det = [
          p.o2_nasal ? 'Nasal' : null,
          p.o2_maske ? 'Maske' : null,
          p.o2_reservoir ? 'Reservoir' : null
        ].filter(x => x).join(', ');
        
        pdf.setFontSize(9);
        pdf.text(`${o2Det || '-'} (${p.o2_flow || '-'} l/min)`, margin + col2W + 5, currentY + 29);
        
        const awLines = [
          p.aw_guedel ? 'Guedel' : null,
          p.aw_ett ? 'ETT' : null,
          p.aw_larynxtubus ? 'LT' : null,
          p.aw_bvm ? 'BVM' : null
        ].filter(x => x).join(', ');
        
        currentY += 37;
        
        // SECTION 9 & 10: RHYTHMUS / ERSTDIAGNOSEN
        checkPageBreak(30);
        
        boxY = drawSection('9. RHYTHMUS / EKG', 30);
        
        const rhythmusLines = [
          p.sr ? 'SR' : null,
          p.stemi ? 'STEMI' : null,
          p.vf ? 'VF' : null,
          p.asystole ? 'Asystolie' : null
        ].filter(x => x).join(', ');
        
        addField(margin + 2, boxY, 'Befund:', rhythmusLines || '-');
        addField(margin + 2, boxY + 10, 'Standort:', p.ekg_standort);
        addField(margin + 2, boxY + 20, 'Pers-Nr.:', p.ekg_persnr);
        
        pdf.setFillColor(255, 240, 245);
        pdf.rect(margin + col2W + 3, currentY, col2W, 30, 'F');
        pdf.setFillColor(255, 220, 235);
        pdf.rect(margin + col2W + 3, currentY, col2W, 7, 'F');
        pdf.setTextColor(200, 16, 46);
        pdf.setFontSize(11);
        pdf.setFont(undefined, 'bold');
        pdf.text('10. ERSTDIAGNOSEN', margin + col2W + 5, currentY + 5);
        pdf.setTextColor(0, 0, 0);
        pdf.setFont(undefined, 'normal');
        
        const diagLines = [
          p.diag_krampf ? 'Krampf' : null,
          p.diag_synkope ? 'Synkope' : null,
          p.diag_apoplex ? 'Apoplex' : null,
          p.diag_sht ? 'SHT' : null,
          p.diag_acs ? 'ACS' : null,
          p.diag_insuff ? 'Herzinsuff.' : null,
          p.diag_hypo ? 'Hypoglyk.' : null,
          p.diag_resp_insuff ? 'Resp.Insuff.' : null
        ].filter(x => x).join(', ');
        
        pdf.setFontSize(9);
        const diagText = pdf.splitTextToSize(diagLines || '-', col2W - 4);
        pdf.text(diagText, margin + col2W + 5, currentY + 11);
        
        currentY += 32;
        
        // ========================================
        // PAGE 3 START
        // ========================================
        checkPageBreak(55);
        
        // SECTION 11: MEDIKAMENTE (KOMPAKT!)
        boxY = drawSection('11. MEDIKAMENTE', 55);
        
        const meds = p.medications || [];
        if (meds.length > 0) {
          pdf.setFontSize(8);
          pdf.setFont(undefined, 'bold');
          
          const medX = margin + 2;
          let medY = boxY;
          
          // Table header
          pdf.setFillColor(245, 245, 245);
          pdf.rect(medX, medY, fullWidth - 4, 5, 'F');
          
          pdf.text('#', medX + 1, medY + 3.5);
          pdf.text('Medikament', medX + 8, medY + 3.5);
          pdf.text('Dosis', medX + 60, medY + 3.5);
          pdf.text('Einh.', medX + 80, medY + 3.5);
          pdf.text('Route', medX + 100, medY + 3.5);
          pdf.text('Uhrzeit', medX + 120, medY + 3.5);
          pdf.text('Bemerkung', medX + 145, medY + 3.5);
          
          medY += 6;
          pdf.setFont(undefined, 'normal');
          
          // Table rows (max 5-6 rows to keep it compact!)
          meds.slice(0, 6).forEach((med, idx) => {
            pdf.text(`${idx + 1}`, medX + 1, medY);
            pdf.text(med.name || '-', medX + 8, medY);
            pdf.text(med.dose || '-', medX + 60, medY);
            pdf.text(med.unit || '-', medX + 80, medY);
            pdf.text(med.route || '-', medX + 100, medY);
            pdf.text(med.time || '-', medX + 120, medY);
            const noteLines = pdf.splitTextToSize(med.note || '-', 30);
            pdf.text(noteLines[0] || '-', medX + 145, medY);
            medY += 5;
          });
        } else {
          pdf.setFontSize(9);
          pdf.text('Keine Medikamentengabe dokumentiert', margin + 2, boxY + 5);
        }
        
        currentY += 57;
        
        // SECTION 12 & 13: ZUGANG / INFUSION
        checkPageBreak(30);
        
        boxY = drawSection('12. ZUGANG', 30);
        addField(margin + 2, boxY, 'Art:', p.zugang_art || '-');
        addField(margin + 2, boxY + 10, 'Größe:', p.zugang_gauge ? `${p.zugang_gauge}G` : '-');
        addField(margin + 2, boxY + 20, 'Region:', p.zugang_region);
        
        pdf.setFillColor(255, 240, 245);
        pdf.rect(margin + col2W + 3, currentY, col2W, 30, 'F');
        pdf.setFillColor(255, 220, 235);
        pdf.rect(margin + col2W + 3, currentY, col2W, 7, 'F');
        pdf.setTextColor(200, 16, 46);
        pdf.setFontSize(11);
        pdf.setFont(undefined, 'bold');
        pdf.text('13. INFUSION', margin + col2W + 5, currentY + 5);
        pdf.setTextColor(0, 0, 0);
        pdf.setFont(undefined, 'normal');
        
        addField(margin + col2W + 5, currentY + 11, 'Art:', p.inf_art);
        addField(margin + col2W + 5, currentY + 20, 'Menge:', p.inf_menge ? `${p.inf_menge} ml` : '-');
        
        const verfLines = [
          p.zugang_versuche ? `Versuche: ${p.zugang_versuche}` : null
        ].filter(x => x).join('');
        
        currentY += 32;
        
        // SECTION 14: REANIMATION (falls vorhanden)
        if (p.rea_beginn) {
          checkPageBreak(35);
          boxY = drawSection('14. REANIMATION', 35);
          
          addField(margin + 2, boxY, 'Beginn:', 
            p.rea_beginn ? new Date(p.rea_beginn).toLocaleString('de-DE') : '-');
          addField(margin + 2 + col3W + 3, boxY, 'Initial-Rhythmus:', p.rea_initial);
          addField(margin + 2 + 2*col3W + 6, boxY, 'Schocks:', p.rea_shocks);
          
          addField(margin + 2, boxY + 12, 'ROSC:', p.rea_rosc);
          addField(margin + 2 + col3W + 3, boxY + 12, 'Ende:', p.rea_ende);
          addField(margin + 2 + 2*col3W + 6, boxY + 12, 'Beatmung:', '-');
          
          addField(margin + 2, boxY + 24, 'FiO₂:', p.vent_fio2 ? `${p.vent_fio2} %` : '-');
          addField(margin + 2 + col3W + 3, boxY + 24, 'PEEP:', p.vent_peep ? `${p.vent_peep} cmH₂O` : '-');
          addField(margin + 2 + 2*col3W + 6, boxY + 24, 'ETT-Größe:', p.aw_ett_size);
          
          currentY += 37;
        }
        
        // SECTION 15: ÜBERGABE / TRANSPORT
        checkPageBreak(30);
        boxY = drawSection('15. ÜBERGABE / TRANSPORT', 30);
        
        addField(margin + 2, boxY, 'Übergabe an:', p.ue_name);
        addField(margin + 2 + col2W + 3, boxY, 'Zielklinik:', p.ziel_bez);
        
        addField(margin + 2, boxY + 10, 'Zeitpunkt:', 
          p.ue_zeit ? new Date(p.ue_zeit).toLocaleString('de-DE') : '-');
        addField(margin + 2 + col2W + 3, boxY + 10, 'Adresse:', p.ziel_adr);
        
        addField(margin + 2, boxY + 20, 'Einsatzende:', 
          p.einsatzende ? new Date(p.einsatzende).toLocaleString('de-DE') : '-');
        
        currentY += 32;
        
        // SECTION 16: FOTOS
        checkPageBreak(20);
        boxY = drawSection('16. FOTOS', 20);
        
        if (p.photos && p.photos.length > 0) {
          pdf.setFontSize(9);
          pdf.text(`${p.photos.length} Foto(s) vorhanden`, margin + 2, boxY + 5);
        } else {
          pdf.setFontSize(9);
          pdf.text('Keine Fotos vorhanden', margin + 2, boxY + 5);
        }
        
        currentY += 22;
        
        // ========================================
        // PAGE 4 START
        // ========================================
        checkPageBreak(35);
        
        // SECTION 17: WEITERE BEFUNDE
        boxY = drawSection('17. WEITERE BEFUNDE', 35);
        
        const hautLines = [
          p.haut_oedeme ? 'Ödeme' : null,
          p.haut_falten ? 'Hautfalten' : null,
          p.haut_kaltschweissig ? 'kaltschweißig' : null
        ].filter(x => x).join(', ');
        
        addField(margin + 2, boxY, 'Haut:', hautLines || 'o.B.');
        
        const psycheLines = [
          p.psy_erregt ? 'erregt' : null,
          p.psy_aggr ? 'aggressiv' : null,
          p.psy_verwirrt ? 'verwirrt' : null
        ].filter(x => x).join(', ');
        
        addField(margin + 2, boxY + 12, 'Psyche:', psycheLines || 'o.B.');
        
        currentY += 37;
        
        // SECTION 18: UNTERSCHRIFTEN
        checkPageBreak(40);
        boxY = drawSection('18. UNTERSCHRIFTEN', 40);
        
        addField(margin + 2, boxY, 'Ausfüller:', p.ausfueller_name);
        pdf.setFontSize(9);
        pdf.text(p.ausfueller_zeit ? new Date(p.ausfueller_zeit).toLocaleString('de-DE') : '', 
          margin + 2, boxY + 8);
        
        if (p.signature) {
          try {
            pdf.addImage(p.signature, 'PNG', margin + 2, boxY + 12, 50, 20);
          } catch(e) {
            pdf.setFontSize(8);
            pdf.text('(Unterschrift vorhanden)', margin + 2, boxY + 20);
          }
        }
        
        addField(margin + col2W + 5, boxY, 'MPG-Beauftragter:', adminData.name);
        pdf.setFontSize(9);
        pdf.text(adminData.datum ? new Date(adminData.datum).toLocaleString('de-DE') : '', 
          margin + col2W + 5, boxY + 8);
        
        if (adminData.unterschrift) {
          try {
            pdf.addImage(adminData.unterschrift, 'PNG', margin + col2W + 5, boxY + 12, 50, 20);
          } catch(e) {
            pdf.setFontSize(8);
            pdf.text('(Unterschrift vorhanden)', margin + col2W + 5, boxY + 20);
          }
        }
        
        currentY += 42;
        
        // ========================================
        // FOOTER ON ALL PAGES
        // ========================================
        const totalPages = pdf.internal.pages.length - 1;
        for (let i = 1; i <= totalPages; i++) {
          pdf.setPage(i);
          pdf.setFontSize(8);
          pdf.setTextColor(100, 100, 100);
          
          const einsatzNr = p.einsatz_nr || '?';
          const footerText = `Einsatz-Nr: ${einsatzNr} | ${orgName} | Seite ${i} von ${totalPages}`;
          
          pdf.text(footerText, pageWidth / 2, pageHeight - 5, { align: 'center' });
        }
        
        // ========================================
        // SAVE PDF
        // ========================================
        const patName = `${p.vorname || ''}_${p.name || ''}`.trim() || 'Patient';
        const einsatzNr = p.einsatz_nr || 'ohne_nr';
        const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
        
        pdf.save(`Notfallprotokoll_${einsatzNr}_${timestamp}.pdf`);
        
        showMsg('✅ PDF erfolgreich erstellt!', 'success');
        
      } catch(e) {
        console.error('PDF Error:', e);
        showMsg('❌ Fehler beim PDF-Export: ' + e.message, 'error');
      }
    }
    // ========================================
    // SECTION: GENERATE NACHERFASSUNG PDF
    // ========================================
    async function generateNacherfassungPDF(doc) {
      try {
        showMsg('📄 PDF wird erstellt...', 'success');
        
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        
        const orgName = currentOrganization?.name || 'Feuerwehr';
        const pageWidth = 210;
        const pageHeight = 297;
        const margin = 10;
        const fullWidth = pageWidth - 2 * margin;
        
        let currentY = 0;
        
        // PDF Header
        pdf.setFillColor(200, 16, 46);
        pdf.rect(0, 0, pageWidth, 30, 'F');
        
        pdf.setTextColor(255, 255, 255);
        pdf.setFontSize(22);
        pdf.setFont(undefined, 'bold');
        pdf.text(orgName, margin, 12);
        
        pdf.setFontSize(18);
        pdf.text('EINSATZNACHERFASSUNG', margin, 22);
        
        pdf.setFontSize(10);
        pdf.setFont(undefined, 'normal');
        pdf.text(`Erstellt: ${new Date().toLocaleString('de-DE')}`, pageWidth - margin - 60, 22);
        
        currentY = 35;
        
        // Helper function: Draw box
        function drawBox(x, y, width, height, title) {
          pdf.setFillColor(255, 240, 245);
          pdf.rect(x, y, width, height, 'F');
          
          pdf.setFillColor(255, 220, 230);
          pdf.rect(x, y, width, 8, 'F');
          
          pdf.setTextColor(200, 16, 46);
          pdf.setFontSize(11);
          pdf.setFont(undefined, 'bold');
          pdf.text(title, x + 3, y + 5.5);
          
          pdf.setTextColor(0, 0, 0);
          pdf.setFont(undefined, 'normal');
          
          return y + 11;
        }
        
        // Helper function: Add field
        function addField(x, y, label, value, width) {
          pdf.setFontSize(10);
          pdf.setFont(undefined, 'bold');
          pdf.setTextColor(100, 0, 20);
          pdf.text(label, x, y);
          
          pdf.setFont(undefined, 'normal');
          pdf.setTextColor(0, 0, 0);
          pdf.setFontSize(10);
          
          const lines = pdf.splitTextToSize(value || '-', width - 6);
          pdf.text(lines, x, y + 5);
          
          return y + 5 + (lines.length * 5) + 2;
        }
        
        // SECTION 1: EINSATZDATEN
        let boxY = drawBox(margin, currentY, fullWidth, 55, '1. EINSATZDATEN');
        
        const col2Width = (fullWidth - 3) / 2;
        let tempY = boxY;
        
        tempY = addField(margin + 3, tempY, 'Datum/Alarmzeit:', 
          doc.datum_alarmzeit ? new Date(doc.datum_alarmzeit).toLocaleString('de-DE') : '-', col2Width);
        tempY = addField(margin + 3, tempY, 'Stichwort:', doc.stichwort, col2Width);
        tempY = addField(margin + 3, tempY, 'Einsatznummer ILS:', doc.einsatznummer_ils, col2Width);
        
        tempY = boxY;
        tempY = addField(margin + 3 + col2Width + 3, tempY, 'Datum/Einsatzende:', 
          doc.datum_einsatzende ? new Date(doc.datum_einsatzende).toLocaleString('de-DE') : '-', col2Width);
        tempY = addField(margin + 3 + col2Width + 3, tempY, 'Kategorie:', doc.kategorie, col2Width);
        tempY = addField(margin + 3 + col2Width + 3, tempY, 'Meldebild:', doc.meldebild, col2Width);
        
        currentY += 57;
        
        // SECTION 2: EINSATZORT
        boxY = drawBox(margin, currentY, fullWidth, 35, '2. EINSATZORT');
        pdf.setFontSize(10);
        const adresseLines = pdf.splitTextToSize(doc.adresse || '-', fullWidth - 6);
        pdf.text(adresseLines, margin + 3, boxY);
        currentY += 37;
        
        // SECTION 3: EINSATZMITTEL
        boxY = drawBox(margin, currentY, fullWidth, 35, '3. EINSATZMITTEL');
        tempY = boxY;
        tempY = addField(margin + 3, tempY, 'Disponierte EM (FW):', doc.disponierte_em_fw, col2Width);
        tempY = boxY;
        tempY = addField(margin + 3 + col2Width + 3, tempY, 'Disponierte EM (RD):', doc.disponierte_em_rd, col2Width);
        currentY += 37;
        
        // SECTION 4: PATIENTEN-DATEN
        boxY = drawBox(margin, currentY, fullWidth, 55, '4. PATIENTEN-DATEN');
        tempY = boxY;
        tempY = addField(margin + 3, tempY, 'Erhoben:', doc.patienten_daten_erhoben ? 'Ja' : 'Nein', fullWidth);
        
        if (doc.patienten_daten_erhoben) {
          tempY = addField(margin + 3, tempY, 'Name:', doc.patient_name, col2Width);
          tempY = addField(margin + 3, tempY, 'Alter/Geburtsdatum:', doc.patient_alter_geburtsdatum, col2Width);
          
          tempY = boxY + 20;
          tempY = addField(margin + 3 + col2Width + 3, tempY, 'Pat.-Nummer ILS:', doc.patient_nummer_ils, col2Width);
        }
        
        currentY += 57;
        
        // SECTION 5: SACHVERHALT
        boxY = drawBox(margin, currentY, fullWidth, 60, '5. SACHVERHALT VOR ORT');
        pdf.setFontSize(10);
        const sachverhaltLines = pdf.splitTextToSize(doc.sachverhalt || '-', fullWidth - 6);
        pdf.text(sachverhaltLines, margin + 3, boxY);
        currentY += 62;
        
        // SECTION 6: PROTOKOLLPFLICHT
        boxY = drawBox(margin, currentY, fullWidth, 50, '6. PROTOKOLLPFLICHT (§630f BGB)');
        tempY = boxY;
        tempY = addField(margin + 3, tempY, 'War dieser Einsatz protokollpflichtig?', 
          doc.protokollpflichtig ? 'Ja' : 'Nein', fullWidth);
        
        if (doc.protokollpflichtig_begruendung) {
          pdf.setFontSize(9.5);
          pdf.setFont(undefined, 'bold');
          pdf.text('Begründung:', margin + 3, tempY);
          pdf.setFont(undefined, 'normal');
          const begruendungLines = pdf.splitTextToSize(doc.protokollpflichtig_begruendung, fullWidth - 6);
          pdf.text(begruendungLines, margin + 3, tempY + 5);
        }
        
        currentY += 52;
        
        // SECTION 7: VERANTWORTLICHER
        boxY = drawBox(margin, currentY, fullWidth, 45, '7. VERANTWORTLICHER');
        tempY = boxY;
        tempY = addField(margin + 3, tempY, 'Name:', doc.verantwortlicher_name, col2Width);
        tempY = addField(margin + 3, tempY, 'Qualifikation:', doc.verantwortlicher_qualifikation, col2Width);
        
        tempY = boxY;
        tempY = addField(margin + 3 + col2Width + 3, tempY, 'War die verantwortliche Person mit der', '', col2Width);
        pdf.setFontSize(9);
        pdf.text('Thematik der Einsatz-/Patientendokumentation', margin + 3 + col2Width + 3, tempY);
        tempY += 5;
        pdf.text('(gem. §630f BGB) unterwiesen?', margin + 3 + col2Width + 3, tempY);
        tempY += 5;
        pdf.setFontSize(10);
        pdf.setFont(undefined, 'bold');
        pdf.text(doc.verantwortlicher_unterwiesen ? 'Ja' : 'Nein', margin + 3 + col2Width + 3, tempY);
        pdf.setFont(undefined, 'normal');
        
        currentY += 47;
        
        // SECTION 8: NACHERFASSUNG
        boxY = drawBox(margin, currentY, fullWidth, 45, '8. NACHERFASSUNG');
        tempY = boxY;
        tempY = addField(margin + 3, tempY, 'Nacherfasst von:', doc.nacherfasst_von_name, col2Width);
        tempY = addField(margin + 3, tempY, 'Qualifikation:', doc.nacherfasst_von_qualifikation, col2Width);
        
        tempY = boxY;
        tempY = addField(margin + 3 + col2Width + 3, tempY, 'Datum:', 
          doc.nacherfasst_datum ? new Date(doc.nacherfasst_datum).toLocaleString('de-DE') : '-', col2Width);
        
        currentY += 47;
        
        // SECTION 9: UNTERSCHRIFT
        boxY = drawBox(margin, currentY, fullWidth, 40, '9. UNTERSCHRIFT');
        
        if (doc.nacherfasst_unterschrift) {
          try {
            pdf.addImage(doc.nacherfasst_unterschrift, 'PNG', margin + 3, boxY, 60, 25);
          } catch(e) {
            pdf.text('(Unterschrift vorhanden)', margin + 3, boxY + 5);
          }
        } else {
          pdf.text('Keine Unterschrift vorhanden', margin + 3, boxY + 5);
        }
        
        currentY += 42;
        
        // SECTION 10: HINWEISE
        boxY = drawBox(margin, currentY, fullWidth, 30, '10. RECHTLICHE HINWEISE');
        pdf.setFontSize(8);
        pdf.setTextColor(80, 80, 80);
        pdf.text('Dieses Dokument wurde gemäß §630f BGB (Dokumentationspflicht) erstellt.', margin + 3, boxY);
        pdf.text('Die Angaben wurden nach bestem Wissen und Gewissen erfasst.', margin + 3, boxY + 5);
        pdf.text('Fehlerhafte oder unvollständige Angaben können zu rechtlichen Konsequenzen führen.', 
          margin + 3, boxY + 10);
        
        currentY += 32;
        
        // FOOTER
        pdf.setFontSize(8);
        pdf.setTextColor(100, 100, 100);
        pdf.text(`${orgName} - Einsatznacherfassung`, margin, pageHeight - 5);
        pdf.text(`Seite 1 von 1`, pageWidth - margin - 25, pageHeight - 5);
        pdf.text(`Erstellt: ${new Date().toLocaleString('de-DE')}`, pageWidth / 2 - 30, pageHeight - 5);
        
        // Save PDF
        const stichwort = doc.stichwort ? doc.stichwort.replace(/[^a-zA-Z0-9]/g, '_') : 'Nacherfassung';
        const timestamp = new Date().toISOString().slice(0, 10);
        pdf.save(`Nacherfassung_${stichwort}_${timestamp}.pdf`);
        
        showMsg('✅ PDF erfolgreich erstellt!', 'success');
        
      } catch(e) {
        console.error('PDF Error:', e);
        showMsg('❌ Fehler beim PDF-Export: ' + e.message, 'error');
      }
    }
    // ========================================
    // SECTION: INITIAL DATA LOAD
    // ========================================
    loadData();
    
    // ========================================
    // SECTION: FADE IN ANIMATION
    // ========================================
    setTimeout(() => {
      document.body.classList.add('loaded');
    }, 100);

  </script>
<!-- ==================== JAVASCRIPT END ==================== -->

</body>
</html>
