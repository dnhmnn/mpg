<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>FFW – Patientendokumentation</title>
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <style>
    :root { 
      --rot:#c8102e; 
      --bg:#f7f7f7; 
      --card:#fff; 
      --border:#e2e8f0;
      --muted:#64748b;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background: var(--bg);
      font-family: 'Atkinson Hyperlegible', system-ui, Arial, sans-serif;
      color: #222; line-height: 1.5;
    }
    header {
      background: var(--rot); color: #fff;
      padding: 12px 16px; display: flex;
      align-items: center; gap: 12px;
    }
    header h1 { margin: 0; font-size: 1rem; font-weight: 800; }
    .spacer { flex: 1; }
    .topbtn {
      background: #0001; color: #fff;
      padding: 8px 12px; border-radius: 10px;
      text-decoration: none; font-weight: 800;
      font-size: 0.9rem;
    }
    .topbtn:hover { background: #0002; }
    .wrap { max-width: 1200px; margin: 18px auto; padding: 0 14px 100px; }
    .card {
      background: var(--card); border-radius: 14px;
      box-shadow: 0 3px 12px rgba(0,0,0,.06); padding: 20px;
      margin-bottom: 20px;
    }
    .card h2 { margin-top: 0; }
    
    /* Tabs */
    .tabs { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
    .tab {
      border: 1px solid #eee; background: #fafafa;
      padding: 10px 16px; border-radius: 999px;
      font-weight: 800; cursor: pointer; font-size: 0.95rem;
      transition: all 0.2s;
    }
    .tab:hover { background: #f0f0f0; }
    .tab.active {
      color: #fff; background: var(--rot);
      border-color: var(--rot);
    }
    
    /* Table */
    .table-head, .row {
      display: grid; grid-template-columns: 120px 1fr 280px;
      gap: 12px; padding: 14px 10px; align-items: center;
      border-bottom: 1px solid #eee;
    }
    .table-head { font-weight: 800; color: #666; background: #fafafa; }
    .row:last-child { border-bottom: none; }
    .row:hover { background: #f9f9f9; }
    
    .pill {
      display: inline-block;
      font-weight: 800; border-radius: 999px;
      padding: 5px 12px; font-size: 0.85rem;
    }
    .pill.offen { background: #fef3c7; color: #92400e; }
    .pill.archiviert { background: #dcfce7; color: #166534; }
    
    .btn {
      background: var(--rot); color: #fff;
      border: 0; border-radius: 10px;
      padding: 10px 14px; font-weight: 800; cursor: pointer;
      font-size: 0.9rem; transition: all 0.2s;
      display: inline-flex; align-items: center; gap: 6px;
    }
    .btn:hover { background: #a00d26; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .btn-secondary {
      background: #6b7280; color: #fff;
    }
    .btn-secondary:hover { background: #4b5563; }
    
    .btn-icon {
      background: transparent; color: var(--rot);
      border: 1px solid var(--rot); padding: 8px 12px;
      font-size: 0.85rem;
    }
    .btn-icon:hover { background: #fff5f5; }
    
    .add-btn {
      position: fixed; bottom: 30px; right: 30px;
      width: 60px; height: 60px; border-radius: 50%;
      background: var(--rot); color: #fff;
      border: 0; cursor: pointer; font-size: 1.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,.2);
      z-index: 100;
      transition: transform 0.2s;
    }
    .add-btn:hover { transform: scale(1.1); }
    
    /* Modal */
    .modal {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.6);
      display: none; align-items: flex-start; justify-content: center;
      z-index: 1000; padding: 20px; overflow-y: auto;
    }
    .modal.show { display: flex; }
    .modal-box {
      background: #fff; border-radius: 14px;
      max-width: 1000px; width: 100%;
      max-height: 90vh; overflow-y: auto;
      padding: 24px; box-shadow: 0 8px 20px rgba(0,0,0,.3);
      margin: auto;
    }
    .modal-box h3 { margin-top: 0; color: var(--rot); }
    
    /* Patientendoku Edit Form Styles */
    details{
      background:var(--card);border:1px solid var(--border);
      border-radius:.75rem;margin:0 0 .8rem 0;overflow:hidden
    }
    summary{
      list-style:none;padding:.9rem 1rem;cursor:pointer;font-weight:800;
      display:flex;align-items:center;gap:.6rem;font-size:1rem;
      background: #fafafa;
    }
    summary::-webkit-details-marker{display:none}
    details[open] summary{border-bottom:1px solid var(--border);background:#fff7f7}
    .sec-body{padding:1rem}
    .grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:.75rem
    }
    .form-row{display:flex;gap:.75rem;flex-wrap:wrap;margin:.25rem 0}
    label{font-size:.92rem;color:#111827;font-weight:600}
    input[type="text"],input[type="number"],input[type="datetime-local"],
    input[type="date"],input[type="time"],textarea,select{
      width:100%;padding:.55rem .6rem;border:1px solid var(--border);
      border-radius:.5rem;background:#fff;font-size:16px;
    }
    textarea{min-height:88px;resize:vertical}
    fieldset{border:1px solid var(--border);border-radius:.6rem;padding:.75rem}
    fieldset legend{padding:0 .35rem;color:#111827;font-weight:700}
    .choice{display:flex;gap:.6rem;flex-wrap:wrap}
    .pill-input{
      display:inline-flex;align-items:center;gap:.4rem;
      border:1px solid var(--border);border-radius:999px;
      padding:.25rem .55rem;background:#fff;font-size:.9rem;
      cursor: pointer;
    }
    .badge{
      display:inline-block;padding:.2rem .5rem;border-radius:999px;
      background:#f1f5f9;color:#0f172a;border:1px solid var(--border);font-size:.8rem
    }
    .sum{font-weight:800}
    
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid var(--border);padding:.5rem;text-align:left;font-size:.9rem}
    th{background:#f8fafc;font-weight:700}
    
    .subbtn{
      border:1px solid var(--border);background:#fff;
      padding:.35rem .55rem;border-radius:.45rem;cursor:pointer;
      font-size:.9rem;font-weight:600
    }
    
    /* Formular */
    .form-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px; margin: 16px 0;
    }
    .form-group {
      display: flex; flex-direction: column; gap: 6px;
    }
    .form-group label {
      font-weight: 700; font-size: 0.9rem; color: #374151;
    }
    .form-group input,
    .form-group textarea,
    .form-group select {
      padding: 10px 12px; border: 1px solid #d1d5db;
      border-radius: 8px; font-size: 16px; font-family: inherit;
    }
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none; border-color: var(--rot);
      box-shadow: 0 0 0 3px rgba(200,16,46,0.1);
    }
    .form-group textarea {
      min-height: 80px; resize: vertical;
    }
    
    .radio-group {
      display: flex; gap: 16px; align-items: center;
    }
    .radio-group label {
      display: flex; align-items: center; gap: 6px;
      font-weight: 600; cursor: pointer;
    }
    
    /* Signature Canvas */
    .sig-wrap {
      border: 2px dashed #d1d5db; border-radius: 8px;
      padding: 12px; background: #f9fafb; margin: 16px 0;
    }
    canvas.sig-canvas {
      width: 100%; height: 150px; border: 1px solid #d1d5db;
      border-radius: 6px; background: #fff; cursor: crosshair;
      touch-action: none;
    }
    .sig-actions {
      margin-top: 8px; display: flex; gap: 8px;
    }
    
    .msg { margin-top: 12px; padding: 12px; border-radius: 8px; }
    .msg.error { background: #fee; color: #c00; border: 1px solid #fcc; }
    .msg.success { background: #efe; color: #060; border: 1px solid #cfc; }
    
    /* Details View */
    .details-grid {
      display: grid; grid-template-columns: 200px 1fr;
      gap: 12px 20px; margin: 16px 0;
    }
    .details-label { font-weight: 700; color: #6b7280; }
    .details-value { color: #111827; }
    
    .signature-img {
      max-width: 300px; border: 1px solid #d1d5db;
      border-radius: 6px; margin-top: 8px;
    }
    
    /* Mobile */
    @media (max-width: 768px) {
      .table-head, .row {
        grid-template-columns: 1fr !important;
        gap: 8px;
      }
      .modal-box { padding: 16px; }
      .form-grid { grid-template-columns: 1fr; }
      .details-grid { grid-template-columns: 1fr; gap: 4px; }
      .details-label { font-size: 0.85rem; }
      .add-btn { bottom: 20px; right: 20px; }
      .grid { grid-template-columns: 1fr; }
    }
    
    @media print {
      header, .tabs, .btn, .add-btn, .modal { display: none !important; }
      body { background: #fff; }
      .card { box-shadow: none; border: 1px solid #ddd; }
      details { border: none; }
      summary { display: none; }
    }
  </style>
</head>
<body>
  <header>
    <h1><i class="fa-solid fa-file-medical"></i> Patientendokumentation</h1>
    <div class="spacer"></div>
    <a class="topbtn" href="admin-dashboard.html"><i class="fa-solid fa-dashboard"></i> Dashboard</a>
    <a class="topbtn" href="#" id="logout"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
  </header>

  <div class="wrap">
    <section class="card">
      <h2>Dokumentenverwaltung</h2>
      
      <div class="tabs">
        <button class="tab active" data-tab="pat"><i class="fa-solid fa-file-medical"></i> Patientendokus (Offen)</button>
        <button class="tab" data-tab="nach"><i class="fa-solid fa-clipboard-list"></i> Nacherfassungen (Offen)</button>
        <button class="tab" data-tab="archiv"><i class="fa-solid fa-box-archive"></i> Archiv</button>
      </div>

      <!-- Patientendokus Offen -->
      <div id="tab-pat" class="tab-content">
        <div class="table-head">
          <div>Status</div><div>Dokument</div><div>Aktionen</div>
        </div>
        <div id="pat-rows"></div>
      </div>

      <!-- Nacherfassungen Offen -->
      <div id="tab-nach" class="tab-content" style="display:none">
        <div class="table-head">
          <div>Status</div><div>Nacherfassung</div><div>Aktionen</div>
        </div>
        <div id="nach-rows"></div>
      </div>

      <!-- Archiv -->
      <div id="tab-archiv" class="tab-content" style="display:none">
        <div class="table-head">
          <div>Typ</div><div>Dokument</div><div>Aktionen</div>
        </div>
        <div id="archiv-rows"></div>
      </div>

      <div id="msg"></div>
    </section>
  </div>

  <!-- Add Button -->
  <button class="add-btn" id="addBtn" title="Neue Nacherfassung">
    <i class="fa-solid fa-plus"></i>
  </button>

  <!-- Bearbeitungs-Modal für Patientendoku -->
  <div class="modal" id="editModal">
    <div class="modal-box">
      <h3><i class="fa-solid fa-edit"></i> Patientendokumentation bearbeiten</h3>
      
      <div id="editFormContainer">
        <!-- Wird dynamisch gefüllt mit komplettem Formular -->
      </div>
      
      <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end;position:sticky;bottom:0;background:#fff;padding-top:16px;border-top:2px solid var(--border)">
        <button class="btn btn-secondary" onclick="closeEditModal()"><i class="fa-solid fa-times"></i> Abbrechen</button>
        <button class="btn" onclick="saveAndSignPatDoc()"><i class="fa-solid fa-save"></i> Speichern & Unterschrift</button>
      </div>
    </div>
  </div>

  <!-- Admin-Unterschrift Modal -->
  <div class="modal" id="signModal">
    <div class="modal-box">
      <h3><i class="fa-solid fa-signature"></i> Admin-Unterschrift</h3>
      <p>Dokument wurde geprüft und ist korrekt. Mit Unterschrift wird es ins Archiv verschoben.</p>
      
      <div class="form-group">
        <label>Admin-Name:</label>
        <input type="text" id="adminName" placeholder="Ihr Name">
      </div>
      
      <div class="sig-wrap">
        <label style="font-weight:700;margin-bottom:8px;display:block">Unterschrift:</label>
        <canvas id="adminSigCanvas" class="sig-canvas"></canvas>
        <div class="sig-actions">
          <button class="btn btn-secondary" onclick="clearAdminSig()"><i class="fa-solid fa-eraser"></i> Löschen</button>
        </div>
      </div>
      
      <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end">
        <button class="btn btn-secondary" onclick="closeSignModal()">Abbrechen</button>
        <button class="btn" onclick="archiveWithSignature()"><i class="fa-solid fa-check"></i> Unterschreiben & Archivieren</button>
      </div>
    </div>
  </div>

  <!-- Nacherfassungs-Formular Modal -->
  <div class="modal" id="nachModal">
    <div class="modal-box">
      <h3><i class="fa-solid fa-clipboard-list"></i> Einsatznacherfassung</h3>
      
      <form id="nachForm">
        <div class="form-grid">
          <div class="form-group">
            <label>Datum/Alarmzeit:</label>
            <input type="datetime-local" name="datum_alarmzeit">
          </div>
          <div class="form-group">
            <label>Datum/Einsatzende:</label>
            <input type="datetime-local" name="datum_einsatzende">
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label>Stichwort:</label>
            <input type="text" name="stichwort">
          </div>
          <div class="form-group">
            <label>Kategorie:</label>
            <input type="text" name="kategorie">
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label>Einsatznummer der ILS:</label>
            <input type="text" name="einsatznummer_ils">
          </div>
          <div class="form-group">
            <label>Meldebild:</label>
            <input type="text" name="meldebild">
          </div>
        </div>

        <div class="form-group">
          <label>Adresse:</label>
          <textarea name="adresse"></textarea>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label>Disponierte EM (FW):</label>
            <input type="text" name="disponierte_em_fw">
          </div>
          <div class="form-group">
            <label>Disponierte EM (RD):</label>
            <input type="text" name="disponierte_em_rd">
          </div>
        </div>

        <h4 style="margin-top:20px;color:var(--rot)">Patienten-Daten</h4>

        <div class="form-group">
          <label>Erhoben:</label>
          <div class="radio-group">
            <label><input type="radio" name="patienten_daten_erhoben" value="ja"> Ja</label>
            <label><input type="radio" name="patienten_daten_erhoben" value="nein"> Nein</label>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label>Name:</label>
            <input type="text" name="patient_name">
          </div>
          <div class="form-group">
            <label>Alter/Geburtsdatum:</label>
            <input type="text" name="patient_alter_geburtsdatum">
          </div>
          <div class="form-group">
            <label>Pat.-Nummer der ILS:</label>
            <input type="text" name="patient_nummer_ils">
          </div>
        </div>

        <div class="form-group">
          <label>Sachverhalt vor Ort:</label>
          <textarea name="sachverhalt" rows="4"></textarea>
        </div>

        <h4 style="margin-top:20px;color:var(--rot)">Protokollpflicht</h4>

        <div class="form-group">
          <label>War dieser Einsatz gemäß §630f BGB protokollpflichtig?</label>
          <div class="radio-group">
            <label><input type="radio" name="protokollpflichtig" value="ja"> Ja</label>
            <label><input type="radio" name="protokollpflichtig" value="nein"> Nein</label>
          </div>
        </div>

        <div class="form-group">
          <label>Begründung:</label>
          <textarea name="protokollpflichtig_begruendung"></textarea>
        </div>

        <div class="form-group">
          <label>War die verantwortliche Person mit der Thematik der Einsatz-/Patientendokumentation (gem. §630f BGB) unterwiesen?</label>
          <div class="radio-group">
            <label><input type="radio" name="verantwortlicher_unterwiesen" value="ja"> Ja</label>
            <label><input type="radio" name="verantwortlicher_unterwiesen" value="nein"> Nein</label>
          </div>
        </div>

        <h4 style="margin-top:20px;color:var(--rot)">Verantwortlicher</h4>

        <div class="form-grid">
          <div class="form-group">
            <label>Name:</label>
            <input type="text" name="verantwortlicher_name">
          </div>
          <div class="form-group">
            <label>Qualifikation:</label>
            <input type="text" name="verantwortlicher_qualifikation">
          </div>
        </div>

        <h4 style="margin-top:20px;color:var(--rot)">Nacherfassung</h4>

        <div class="form-grid">
          <div class="form-group">
            <label>Nacherfasst von (Name):</label>
            <input type="text" name="nacherfasst_von_name" required>
          </div>
          <div class="form-group">
            <label>Qualifikation:</label>
            <input type="text" name="nacherfasst_von_qualifikation">
          </div>
        </div>

        <div class="sig-wrap">
          <label style="font-weight:700;margin-bottom:8px;display:block">Unterschrift:</label>
          <canvas id="nachSigCanvas" class="sig-canvas"></canvas>
          <div class="sig-actions">
            <button type="button" class="btn btn-secondary" onclick="clearNachSig()"><i class="fa-solid fa-eraser"></i> Löschen</button>
          </div>
        </div>
      </form>

      <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end">
        <button class="btn btn-secondary" onclick="closeNachModal()">Abbrechen</button>
        <button class="btn" onclick="saveNacherfassung()"><i class="fa-solid fa-save"></i> Speichern</button>
      </div>
    </div>
  </div>

  <!-- Details-Ansicht Modal -->
  <div class="modal" id="detailsModal">
    <div class="modal-box">
      <h3 id="detailsTitle">Details</h3>
      <div id="detailsBody"></div>
      <div style="text-align:right;margin-top:20px">
        <button class="btn" onclick="closeDetailsModal()">Schließen</button>
        <button class="btn" onclick="window.print()"><i class="fa-solid fa-print"></i> Drucken</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { NhostClient } from "https://esm.sh/@nhost/nhost-js@2.2.9";
    const nhost = new NhostClient({ subdomain: "hpjfrhktprpuuxvvlpsb", region: "eu-central-1" });
    
    // Auth Check
    if (!(await nhost.auth.isAuthenticatedAsync())) {
      location.href = "/admin-login.html";
    }

    const token = await nhost.auth.getAccessToken();
    const headers = { "Content-Type": "application/json", "Authorization": "Bearer " + token };
    const endpoint = "https://hpjfrhktprpuuxvvlpsb.graphql.eu-central-1.nhost.run/v1";

    // Logout
    document.getElementById("logout").onclick = async (e) => {
      e.preventDefault();
      await nhost.auth.signOut();
      localStorage.clear();
      location.href = "/admin-login.html";
    };

    // Tab Switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.onclick = () => {
        const targetTab = tab.dataset.tab;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = 'none');
        document.getElementById('tab-' + targetTab).style.display = 'block';
        document.getElementById('msg').textContent = '';
      };
    });

    // GraphQL Helper
    async function gql(query, variables = {}) {
      const res = await fetch(endpoint, {
        method: "POST",
        headers,
        body: JSON.stringify({ query, variables })
      });
      const json = await res.json();
      if (json.errors) throw new Error(json.errors[0].message);
      return json.data;
    }

    // Load Data
    async function loadData() {
      try {
        // Patientendokus (offen)
        const patData = await gql(`query {
          patient_docs(where: {status: {_eq: "offen"}}, order_by: {created_at: desc}) {
            id title status created_at payload
          }
        }`);
        
        const patRows = document.getElementById('pat-rows');
        patRows.innerHTML = patData.patient_docs.map(doc => `
          <div class="row">
            <div><span class="pill offen">${doc.status}</span></div>
            <div>
              <strong>${doc.title || 'Ohne Titel'}</strong><br>
              <small style="color:#6b7280">${new Date(doc.created_at).toLocaleString('de-DE')}</small>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-icon" onclick="editPatDoc('${doc.id}')">
                <i class="fa-solid fa-edit"></i> Bearbeiten
              </button>
            </div>
          </div>
        `).join('') || '<p style="padding:20px;color:#999">Keine offenen Patientendokus</p>';

        // Nacherfassungen (offen)
        const nachData = await gql(`query {
          patient_docs_nacherfassung(where: {status: {_eq: "offen"}}, order_by: {created_at: desc}) {
            id stichwort status created_at nacherfasst_von_name
          }
        }`);
        
        const nachRows = document.getElementById('nach-rows');
        nachRows.innerHTML = nachData.patient_docs_nacherfassung.map(doc => `
          <div class="row">
            <div><span class="pill offen">${doc.status}</span></div>
            <div>
              <strong>${doc.stichwort || 'Ohne Stichwort'}</strong><br>
              <small style="color:#6b7280">von ${doc.nacherfasst_von_name || '?'} · ${new Date(doc.created_at).toLocaleString('de-DE')}</small>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-icon" onclick="viewNach('${doc.id}')">
                <i class="fa-solid fa-eye"></i> Details
              </button>
              <button class="btn btn-icon" onclick="archiveNach('${doc.id}')">
                <i class="fa-solid fa-box-archive"></i> Archivieren
              </button>
            </div>
          </div>
        `).join('') || '<p style="padding:20px;color:#999">Keine offenen Nacherfassungen</p>';

        // Archiv (beide Typen)
        const archivPat = await gql(`query {
          patient_docs(where: {status: {_eq: "archiviert"}}, order_by: {updated_at: desc}) {
            id title admin_name admin_datum
          }
        }`);
        
        const archivNach = await gql(`query {
          patient_docs_nacherfassung(where: {status: {_eq: "archiviert"}}, order_by: {updated_at: desc}) {
            id stichwort nacherfasst_von_name nacherfasst_datum
          }
        }`);
        
        const archivRows = document.getElementById('archiv-rows');
        let archivHTML = '';
        
        archivPat.patient_docs.forEach(doc => {
          archivHTML += `
            <div class="row">
              <div><span class="pill archiviert">Patientendoku</span></div>
              <div>
                <strong>${doc.title}</strong><br>
                <small style="color:#6b7280">Admin: ${doc.admin_name || '?'} · ${doc.admin_datum ? new Date(doc.admin_datum).toLocaleString('de-DE') : ''}</small>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn btn-icon" onclick="viewPatArchiv('${doc.id}')">
                  <i class="fa-solid fa-eye"></i> Ansehen
                </button>
                <button class="btn btn-icon" onclick="printPatDoc('${doc.id}')">
                  <i class="fa-solid fa-print"></i> Drucken
                </button>
              </div>
            </div>
          `;
        });
        
        archivNach.patient_docs_nacherfassung.forEach(doc => {
          archivHTML += `
            <div class="row">
              <div><span class="pill archiviert">Nacherfassung</span></div>
              <div>
                <strong>${doc.stichwort || 'Ohne Titel'}</strong><br>
                <small style="color:#6b7280">von ${doc.nacherfasst_von_name || '?'}</small>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn btn-icon" onclick="viewNachArchiv('${doc.id}')">
                  <i class="fa-solid fa-eye"></i> Ansehen
                </button>
                <button class="btn btn-icon" onclick="printNachDoc('${doc.id}')">
                  <i class="fa-solid fa-print"></i> Drucken
                </button>
              </div>
            </div>
          `;
        });
        
        archivRows.innerHTML = archivHTML || '<p style="padding:20px;color:#999">Kein Archiv vorhanden</p>';

      } catch(e) {
        showMsg('Fehler beim Laden: ' + e.message, 'error');
      }
    }

    // Edit Patient Doc - VOLLSTÄNDIGES FORMULAR
    let currentEditId = null;
    let currentEditPayload = null;
    
    window.editPatDoc = async (id) => {
      currentEditId = id;
      try {
        const data = await gql(`query {
          patient_docs_by_pk(id: "${id}") {
            id title payload
          }
        }`);
        
        currentEditPayload = data.patient_docs_by_pk.payload || {};
        
        // KOMPLETTES FORMULAR rendern
        const formHTML = buildEditForm(currentEditPayload);
        document.getElementById('editFormContainer').innerHTML = formHTML;
        
        // Details öffnen
        document.querySelectorAll('#editFormContainer details').forEach(d => d.open = true);
        
        document.getElementById('editModal').classList.add('show');
      } catch(e) {
        showMsg('Fehler: ' + e.message, 'error');
      }
    };

    // FORMULAR BUILDER
    function buildEditForm(payload) {
      const v = (key, fallback = '') => payload[key] || fallback;
      const checked = (key) => payload[key] ? 'checked' : '';
      const radioChecked = (key, value) => payload[key] === value ? 'checked' : '';
      
      return `
        <!-- Einsatzdaten -->
        <details open>
          <summary><i class="fa-solid fa-truck-medical"></i> Einsatzdaten</summary>
          <div class="sec-body">
            <div class="grid">
              <label>Einsatz-Nr.<input name="einsatz_nr" type="text" value="${v('einsatz_nr')}"></label>
              <label>Pat./Auftrags-Nr.<input name="auftrags_nr" type="text" value="${v('auftrags_nr')}"></label>
              <label>Rufname<input name="rufname" type="text" value="${v('rufname')}"></label>
              <label>Fahrzeug<input name="fahrzeug" type="text" value="${v('fahrzeug')}"></label>
              <label>Datum/Uhrzeit<input name="zeit_einsatz" type="datetime-local" value="${v('zeit_einsatz')}"></label>
            </div>
            <label>Einsatz-Art<input name="einsatz_art" type="text" value="${v('einsatz_art')}"></label>
          </div>
        </details>

        <!-- Pat-Stammdaten -->
        <details open>
          <summary><i class="fa-solid fa-id-card-clip"></i> Pat-Stammdaten</summary>
          <div class="sec-body">
            <div class="grid">
              <label>Name<input name="name" type="text" value="${v('name')}"></label>
              <label>Vorname<input name="vorname" type="text" value="${v('vorname')}"></label>
              <label>Geb.-Datum<input name="gebdatum" type="date" value="${v('gebdatum')}"></label>
              <label>Alter<input name="alter" type="number" value="${v('alter')}"></label>
              <label>Telefon<input name="telefon" type="text" value="${v('telefon')}"></label>
              <label>Mobil<input name="mobil" type="text" value="${v('mobil')}"></label>
              <label>Straße<input name="strasse" type="text" value="${v('strasse')}"></label>
              <label>PLZ, Ort<input name="plz_ort" type="text" value="${v('plz_ort')}"></label>
            </div>
            <label>Informationen<textarea name="infos">${v('infos')}</textarea></label>
          </div>
        </details>

        <!-- Notfallgeschehen -->
        <details open>
          <summary><i class="fa-solid fa-notes-medical"></i> Notfallgeschehen / Anamnese</summary>
          <div class="sec-body">
            <textarea name="notfallgeschehen">${v('notfallgeschehen')}</textarea>
          </div>
        </details>

        <!-- Messwerte -->
        <details open>
          <summary><i class="fa-solid fa-stethoscope"></i> Messwerte</summary>
          <div class="sec-body">
            <div class="grid">
              <label>RR syst. (mmHg)<input name="rr_sys" type="number" value="${v('rr_sys')}"></label>
              <label>RR diast. (mmHg)<input name="rr_dia" type="number" value="${v('rr_dia')}"></label>
              <label>HF (/min)<input name="hf" type="number" value="${v('hf')}"></label>
              <label>AF (/min)<input name="af" type="number" value="${v('af')}"></label>
              <label>SpO₂ (%)<input name="spo2" type="number" value="${v('spo2')}"></label>
              <label>Temp (°C)<input name="temp" type="number" step="0.1" value="${v('temp')}"></label>
              <label>BZ (mg/dl)<input name="bz_mg" type="number" value="${v('bz_mg')}"></label>
              <label>Schmerz (0–10)<input name="schmerz" type="number" value="${v('schmerz')}"></label>
            </div>
          </div>
        </details>

        <!-- GCS -->
        <details open>
          <summary><i class="fa-solid fa-eye"></i> Glasgow Coma Scale</summary>
          <div class="sec-body">
            <fieldset>
              <legend>Augenöffnung (E)</legend>
              <div class="choice">
                <label class="pill-input"><input type="radio" name="gcs_e" value="4" ${radioChecked('gcs_e','4')}> spontan (4)</label>
                <label class="pill-input"><input type="radio" name="gcs_e" value="3" ${radioChecked('gcs_e','3')}> auf Geräusch (3)</label>
                <label class="pill-input"><input type="radio" name="gcs_e" value="2" ${radioChecked('gcs_e','2')}> auf Druck (2)</label>
                <label class="pill-input"><input type="radio" name="gcs_e" value="1" ${radioChecked('gcs_e','1')}> keine (1)</label>
              </div>
            </fieldset>
            <fieldset style="margin-top:.5rem">
              <legend>Verbale Antwort (V)</legend>
              <div class="choice">
                <label class="pill-input"><input type="radio" name="gcs_v" value="5" ${radioChecked('gcs_v','5')}> orientiert (5)</label>
                <label class="pill-input"><input type="radio" name="gcs_v" value="4" ${radioChecked('gcs_v','4')}> verwirrt (4)</label>
                <label class="pill-input"><input type="radio" name="gcs_v" value="3" ${radioChecked('gcs_v','3')}> Wörter (3)</label>
                <label class="pill-input"><input type="radio" name="gcs_v" value="2" ${radioChecked('gcs_v','2')}> Laute (2)</label>
                <label class="pill-input"><input type="radio" name="gcs_v" value="1" ${radioChecked('gcs_v','1')}> keine (1)</label>
              </div>
            </fieldset>
            <fieldset style="margin-top:.5rem">
              <legend>Motorische Antwort (M)</legend>
              <div class="choice">
                <label class="pill-input"><input type="radio" name="gcs_m" value="6" ${radioChecked('gcs_m','6')}> folgt (6)</label>
                <label class="pill-input"><input type="radio" name="gcs_m" value="5" ${radioChecked('gcs_m','5')}> lokalisiert (5)</label>
                <label class="pill-input"><input type="radio" name="gcs_m" value="4" ${radioChecked('gcs_m','4')}> beugt normal (4)</label>
                <label class="pill-input"><input type="radio" name="gcs_m" value="3" ${radioChecked('gcs_m','3')}> beugt abnormal (3)</label>
                <label class="pill-input"><input type="radio" name="gcs_m" value="2" ${radioChecked('gcs_m','2')}> streckt (2)</label>
                <label class="pill-input"><input type="radio" name="gcs_m" value="1" ${radioChecked('gcs_m','1')}> keine (1)</label>
              </div>
            </fieldset>
          </div>
        </details>

        <!-- Verletzungen -->
        <details open>
          <summary><i class="fa-solid fa-kit-medical"></i> Verletzungen</summary>
          <div class="sec-body">
            <textarea name="verletz_text">${v('verletz_text')}</textarea>
          </div>
        </details>

        <!-- Übergabe -->
        <details open>
          <summary><i class="fa-solid fa-people-carry-box"></i> Übergabe / Transport</summary>
          <div class="sec-body">
            <div class="grid">
              <label>Übergabe an<input name="ue_name" type="text" value="${v('ue_name')}"></label>
              <label>Zeitpunkt<input name="ue_zeit" type="datetime-local" value="${v('ue_zeit')}"></label>
              <label>Ziel<input name="ziel_bez" type="text" value="${v('ziel_bez')}"></label>
              <label>Einsatzende<input name="einsatzende" type="datetime-local" value="${v('einsatzende')}"></label>
            </div>
          </div>
        </details>

        <!-- Ausfüller -->
        <details open>
          <summary><i class="fa-solid fa-user"></i> Ausfüller</summary>
          <div class="sec-body">
            <div class="grid">
              <label>Name<input name="ausfueller_name" type="text" value="${v('ausfueller_name')}"></label>
              <label>Zeitpunkt<input name="ausfueller_zeit" type="datetime-local" value="${v('ausfueller_zeit')}"></label>
            </div>
            ${payload.signature ? `<div><strong>Unterschrift:</strong><br><img src="${payload.signature}" style="max-width:300px;border:1px solid #ddd;border-radius:6px;margin-top:8px"></div>` : ''}
          </div>
        </details>
      `;
    }

    window.closeEditModal = () => {
      document.getElementById('editModal').classList.remove('show');
      currentEditId = null;
      currentEditPayload = null;
    };

    // Speichern & zur Admin-Unterschrift
    window.saveAndSignPatDoc = async () => {
      try {
        // Formular-Daten sammeln
        const updatedPayload = {};
        document.querySelectorAll('#editFormContainer input, #editFormContainer textarea, #editFormContainer select').forEach(el => {
          if (!el.name) return;
          if (el.type === 'checkbox') {
            updatedPayload[el.name] = el.checked;
          } else if (el.type === 'radio') {
            if (el.checked) updatedPayload[el.name] = el.value;
          } else {
            updatedPayload[el.name] = el.value;
          }
        });

        // Original Signature & Photos behalten
        updatedPayload.signature = currentEditPayload.signature;
        updatedPayload.photos = currentEditPayload.photos || [];
        updatedPayload.medications = currentEditPayload.medications || [];

        // Update in DB
        await gql(`mutation($payload: jsonb!) {
          update_patient_docs_by_pk(
            pk_columns: {id: "${currentEditId}"},
            _set: {payload: $payload}
          ) {
            id
          }
        }`, { payload: updatedPayload });

        showMsg('✅ Änderungen gespeichert!', 'success');
        
        // Zu Admin-Unterschrift wechseln
        document.getElementById('editModal').classList.remove('show');
        document.getElementById('signModal').classList.add('show');
        initAdminSigCanvas();
        
      } catch(e) {
        showMsg('Fehler beim Speichern: ' + e.message, 'error');
      }
    };

    // Admin Signature Canvas
    let adminSigCanvas, adminSigCtx, adminIsDrawing = false, adminLastX = 0, adminLastY = 0;
    
    function initAdminSigCanvas() {
      adminSigCanvas = document.getElementById('adminSigCanvas');
      adminSigCtx = adminSigCanvas.getContext('2d');
      const rect = adminSigCanvas.getBoundingClientRect();
      adminSigCanvas.width = rect.width * 2;
      adminSigCanvas.height = rect.height * 2;
      adminSigCtx.scale(2, 2);
      adminSigCtx.strokeStyle = '#000';
      adminSigCtx.lineWidth = 2;
      adminSigCtx.lineCap = 'round';
      
      adminSigCanvas.addEventListener('mousedown', startAdminDraw);
      adminSigCanvas.addEventListener('mousemove', drawAdmin);
      adminSigCanvas.addEventListener('mouseup', stopAdminDraw);
      adminSigCanvas.addEventListener('touchstart', handleAdminTouchStart, {passive: false});
      adminSigCanvas.addEventListener('touchmove', handleAdminTouchMove, {passive: false});
      adminSigCanvas.addEventListener('touchend', stopAdminDraw);
    }

    function startAdminDraw(e) {
      adminIsDrawing = true;
      const pos = getAdminMousePos(e);
      adminLastX = pos.x;
      adminLastY = pos.y;
    }

    function drawAdmin(e) {
      if (!adminIsDrawing) return;
      e.preventDefault();
      const pos = getAdminMousePos(e);
      adminSigCtx.beginPath();
      adminSigCtx.moveTo(adminLastX, adminLastY);
      adminSigCtx.lineTo(pos.x, pos.y);
      adminSigCtx.stroke();
      adminLastX = pos.x;
      adminLastY = pos.y;
    }

    function stopAdminDraw() {
      adminIsDrawing = false;
    }

    function handleAdminTouchStart(e) {
      e.preventDefault();
      const touch = e.touches[0];
      startAdminDraw({clientX: touch.clientX, clientY: touch.clientY});
    }

    function handleAdminTouchMove(e) {
      e.preventDefault();
      const touch = e.touches[0];
      drawAdmin({clientX: touch.clientX, clientY: touch.clientY, preventDefault: () => {}});
    }

    function getAdminMousePos(e) {
      const rect = adminSigCanvas.getBoundingClientRect();
      return {
        x: (e.clientX - rect.left) * 2,
        y: (e.clientY - rect.top) * 2
      };
    }

    window.clearAdminSig = () => {
      if (adminSigCtx) {
        adminSigCtx.clearRect(0, 0, adminSigCanvas.width, adminSigCanvas.height);
      }
    };

    window.closeSignModal = () => {
      document.getElementById('signModal').classList.remove('show');
    };

    window.archiveWithSignature = async () => {
      const adminName = document.getElementById('adminName').value.trim();
      if (!adminName) {
        alert('Bitte Admin-Name eingeben!');
        return;
      }
      
      const sigData = adminSigCanvas.toDataURL('image/png');
      
      try {
        await gql(`mutation {
          update_patient_docs_by_pk(
            pk_columns: {id: "${currentEditId}"},
            _set: {
              status: "archiviert",
              admin_name: "${adminName}",
              admin_unterschrift: "${sigData}",
              admin_datum: "now()"
            }
          ) {
            id
          }
        }`);
        
        showMsg('✅ Dokument archiviert!', 'success');
        document.getElementById('signModal').classList.remove('show');
        currentEditId = null;
        loadData();
      } catch(e) {
        showMsg('Fehler: ' + e.message, 'error');
      }
    };

    // Nacherfassung
    document.getElementById('addBtn').onclick = () => {
      document.getElementById('nachModal').classList.add('show');
      initNachSigCanvas();
    };

    window.closeNachModal = () => {
      document.getElementById('nachModal').classList.remove('show');
      document.getElementById('nachForm').reset();
      if (nachSigCtx) {
        nachSigCtx.clearRect(0, 0, nachSigCanvas.width, nachSigCanvas.height);
      }
    };

    // Nacherfassung Signature Canvas
    let nachSigCanvas, nachSigCtx, nachIsDrawing = false, nachLastX = 0, nachLastY = 0;
    
    function initNachSigCanvas() {
      nachSigCanvas = document.getElementById('nachSigCanvas');
      nachSigCtx = nachSigCanvas.getContext('2d');
      const rect = nachSigCanvas.getBoundingClientRect();
      nachSigCanvas.width = rect.width * 2;
      nachSigCanvas.height = rect.height * 2;
      nachSigCtx.scale(2, 2);
      nachSigCtx.strokeStyle = '#000';
      nachSigCtx.lineWidth = 2;
      nachSigCtx.lineCap = 'round';
      
      nachSigCanvas.addEventListener('mousedown', startNachDraw);
      nachSigCanvas.addEventListener('mousemove', drawNach);
      nachSigCanvas.addEventListener('mouseup', stopNachDraw);
      nachSigCanvas.addEventListener('touchstart', handleNachTouchStart, {passive: false});
      nachSigCanvas.addEventListener('touchmove', handleNachTouchMove, {passive: false});
      nachSigCanvas.addEventListener('touchend', stopNachDraw);
    }

    function startNachDraw(e) {
      nachIsDrawing = true;
      const pos = getNachMousePos(e);
      nachLastX = pos.x;
      nachLastY = pos.y;
    }

    function drawNach(e) {
      if (!nachIsDrawing) return;
      e.preventDefault();
      const pos = getNachMousePos(e);
      nachSigCtx.beginPath();
      nachSigCtx.moveTo(nachLastX, nachLastY);
      nachSigCtx.lineTo(pos.x, pos.y);
      nachSigCtx.stroke();
      nachLastX = pos.x;
      nachLastY = pos.y;
    }

    function stopNachDraw() {
      nachIsDrawing = false;
    }

    function handleNachTouchStart(e) {
      e.preventDefault();
      const touch = e.touches[0];
      startNachDraw({clientX: touch.clientX, clientY: touch.clientY});
    }

    function handleNachTouchMove(e) {
      e.preventDefault();
      const touch = e.touches[0];
      drawNach({clientX: touch.clientX, clientY: touch.clientY, preventDefault: () => {}});
    }

    function getNachMousePos(e) {
      const rect = nachSigCanvas.getBoundingClientRect();
      return {
        x: (e.clientX - rect.left) * 2,
        y: (e.clientY - rect.top) * 2
      };
    }

    window.clearNachSig = () => {
      if (nachSigCtx) {
        nachSigCtx.clearRect(0, 0, nachSigCanvas.width, nachSigCanvas.height);
      }
    };

    window.saveNacherfassung = async () => {
      const form = document.getElementById('nachForm');
      const formData = new FormData(form);
      const data = {};
      
      for (let [key, value] of formData.entries()) {
        if (key === 'patienten_daten_erhoben' || key === 'protokollpflichtig' || key === 'verantwortlicher_unterwiesen') {
          data[key] = value === 'ja';
        } else {
          data[key] = value;
        }
      }
      
      const sigData = nachSigCanvas.toDataURL('image/png');
      data.nacherfasst_unterschrift = sigData;
      data.nacherfasst_datum = new Date().toISOString();
      
      if (!data.nacherfasst_von_name) {
        alert('Bitte mindestens "Nacherfasst von (Name)" angeben!');
        return;
      }
      
      try {
        await gql(`mutation($data: patient_docs_nacherfassung_insert_input!) {
          insert_patient_docs_nacherfassung_one(object: $data) {
            id
          }
        }`, { data });
        
        showMsg('✅ Nacherfassung gespeichert!', 'success');
        closeNachModal();
        loadData();
      } catch(e) {
        showMsg('Fehler: ' + e.message, 'error');
      }
    };

    // Nacherfassung archivieren
    window.archiveNach = async (id) => {
      if (!confirm('Nacherfassung ins Archiv verschieben?')) return;
      
      try {
        await gql(`mutation {
          update_patient_docs_nacherfassung_by_pk(
            pk_columns: {id: "${id}"},
            _set: {status: "archiviert"}
          ) {
            id
          }
        }`);
        
        showMsg('✅ Nacherfassung archiviert!', 'success');
        loadData();
      } catch(e) {
        showMsg('Fehler: ' + e.message, 'error');
      }
    };

    // View Details
    window.viewNach = async (id) => {
      try {
        const data = await gql(`query {
          patient_docs_nacherfassung_by_pk(id: "${id}") {
            stichwort kategorie einsatznummer_ils meldebild adresse
            disponierte_em_fw disponierte_em_rd
            patient_name patient_alter_geburtsdatum patient_nummer_ils
            sachverhalt protokollpflichtig protokollpflichtig_begruendung
            verantwortlicher_name verantwortlicher_qualifikation
            nacherfasst_von_name nacherfasst_von_qualifikation
            nacherfasst_unterschrift datum_alarmzeit datum_einsatzende
            verantwortlicher_unterwiesen patienten_daten_erhoben
          }
        }`);
        
        const doc = data.patient_docs_nacherfassung_by_pk;
        
        document.getElementById('detailsTitle').textContent = 'Nacherfassung: ' + (doc.stichwort || '?');
        document.getElementById('detailsBody').innerHTML = `
          <div class="details-grid">
            <div class="details-label">Alarmzeit:</div><div class="details-value">${doc.datum_alarmzeit ? new Date(doc.datum_alarmzeit).toLocaleString('de-DE') : '-'}</div>
            <div class="details-label">Einsatzende:</div><div class="details-value">${doc.datum_einsatzende ? new Date(doc.datum_einsatzende).toLocaleString('de-DE') : '-'}</div>
            <div class="details-label">Stichwort:</div><div class="details-value">${doc.stichwort || '-'}</div>
            <div class="details-label">Kategorie:</div><div class="details-value">${doc.kategorie || '-'}</div>
            <div class="details-label">Einsatznummer ILS:</div><div class="details-value">${doc.einsatznummer_ils || '-'}</div>
            <div class="details-label">Meldebild:</div><div class="details-value">${doc.meldebild || '-'}</div>
            <div class="details-label">Adresse:</div><div class="details-value">${doc.adresse || '-'}</div>
            <div class="details-label">Disponierte EM (FW):</div><div class="details-value">${doc.disponierte_em_fw || '-'}</div>
            <div class="details-label">Disponierte EM (RD):</div><div class="details-value">${doc.disponierte_em_rd || '-'}</div>
            <div class="details-label">Patientendaten erhoben:</div><div class="details-value">${doc.patienten_daten_erhoben ? 'Ja' : 'Nein'}</div>
            <div class="details-label">Patient:</div><div class="details-value">${doc.patient_name || '-'}</div>
            <div class="details-label">Alter/Geburtsdatum:</div><div class="details-value">${doc.patient_alter_geburtsdatum || '-'}</div>
            <div class="details-label">Pat.-Nr. ILS:</div><div class="details-value">${doc.patient_nummer_ils || '-'}</div>
            <div class="details-label">Sachverhalt:</div><div class="details-value">${doc.sachverhalt || '-'}</div>
            <div class="details-label">Protokollpflichtig:</div><div class="details-value">${doc.protokollpflichtig ? 'Ja' : 'Nein'}</div>
            <div class="details-label">Begründung:</div><div class="details-value">${doc.protokollpflichtig_begruendung || '-'}</div>
            <div class="details-label">Verantwortlicher unterwiesen:</div><div class="details-value">${doc.verantwortlicher_unterwiesen ? 'Ja' : 'Nein'}</div>
            <div class="details-label">Verantwortlicher:</div><div class="details-value">${doc.verantwortlicher_name || '-'} (${doc.verantwortlicher_qualifikation || '-'})</div>
            <div class="details-label">Nacherfasst von:</div><div class="details-value">${doc.nacherfasst_von_name || '-'} (${doc.nacherfasst_von_qualifikation || '-'})</div>
            ${doc.nacherfasst_unterschrift ? `<div class="details-label">Unterschrift:</div><div class="details-value"><img src="${doc.nacherfasst_unterschrift}" class="signature-img"></div>` : ''}
          </div>
        `;
        
        document.getElementById('detailsModal').classList.add('show');
      } catch(e) {
        showMsg('Fehler: ' + e.message, 'error');
      }
    };

    window.viewPatArchiv = async (id) => {
      try {
        const data = await gql(`query {
          patient_docs_by_pk(id: "${id}") {
            id title payload admin_name admin_unterschrift admin_datum
          }
        }`);
        
        const doc = data.patient_docs_by_pk;
        const p = doc.payload || {};
        
        document.getElementById('detailsTitle').textContent = doc.title || 'Patientendokumentation';
        document.getElementById('detailsBody').innerHTML = `
          <div class="details-grid">
            <div class="details-label">Patient:</div><div class="details-value">${p.vorname || ''} ${p.name || ''}</div>
            <div class="details-label">Geburtsdatum:</div><div class="details-value">${p.gebdatum || '-'}</div>
            <div class="details-label">Einsatznummer:</div><div class="details-value">${p.einsatz_nr || '-'}</div>
            <div class="details-label">Fahrzeug:</div><div class="details-value">${p.fahrzeug || '-'}</div>
            <div class="details-label">RR:</div><div class="details-value">${p.rr_sys || '-'}/${p.rr_dia || '-'} mmHg</div>
            <div class="details-label">HF:</div><div class="details-value">${p.hf || '-'} /min</div>
            <div class="details-label">SpO₂:</div><div class="details-value">${p.spo2 || '-'} %</div>
            <div class="details-label">Notfallgeschehen:</div><div class="details-value">${p.notfallgeschehen || '-'}</div>
            <div class="details-label">Übergabe an:</div><div class="details-value">${p.ue_name || '-'}</div>
            <div class="details-label">Ziel:</div><div class="details-value">${p.ziel_bez || '-'}</div>
            <div class="details-label">Ausfüller:</div><div class="details-value">${p.ausfueller_name || '-'}</div>
            ${p.signature ? `<div class="details-label">Ausfüller-Unterschrift:</div><div class="details-value"><img src="${p.signature}" class="signature-img"></div>` : ''}
            <div class="details-label">Admin:</div><div class="details-value">${doc.admin_name || '-'}</div>
            <div class="details-label">Admin-Datum:</div><div class="details-value">${doc.admin_datum ? new Date(doc.admin_datum).toLocaleString('de-DE') : '-'}</div>
            ${doc.admin_unterschrift ? `<div class="details-label">Admin-Unterschrift:</div><div class="details-value"><img src="${doc.admin_unterschrift}" class="signature-img"></div>` : ''}
          </div>
        `;
        
        document.getElementById('detailsModal').classList.add('show');
      } catch(e) {
        showMsg('Fehler: ' + e.message, 'error');
      }
    };

    window.viewNachArchiv = (id) => {
      viewNach(id);
    };

    window.closeDetailsModal = () => {
      document.getElementById('detailsModal').classList.remove('show');
    };

    // Print Functions
    window.printPatDoc = (id) => {
      viewPatArchiv(id).then(() => {
        setTimeout(() => window.print(), 500);
      });
    };

    window.printNachDoc = (id) => {
      viewNach(id).then(() => {
        setTimeout(() => window.print(), 500);
      });
    };

    // Message Helper
    function showMsg(text, type = 'error') {
      const msg = document.getElementById('msg');
      msg.textContent = text;
      msg.className = 'msg ' + type;
      setTimeout(() => msg.textContent = '', 5000);
    }

    // Initial Load
    loadData();
  </script>
</body>
</html>
