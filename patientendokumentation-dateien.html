<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dokumentenverwaltung – Responda</title>
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/pocketbase@0.21.3/dist/pocketbase.umd.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.6.0/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root{
      --primary:#c8102e;
      --bg:#f8fafc;
      --card:#fff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --gradient-start:#667eea;
      --gradient-end:#764ba2;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
      min-height:100vh;
      color:var(--text);
      font-family:'Atkinson Hyperlegible',-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      line-height:1.45;
      opacity:0;
      transition:opacity 0.3s;
    }
    body.loaded{opacity:1}
    
    header{
      position:sticky;
      top:0;
      background:var(--gradient-start);
      color:#fff;
      z-index:10;
    }
    .bar{
      max-width:1200px;
      margin:0 auto;
      padding:.75rem 1rem;
      display:flex;
      gap:.5rem;
      align-items:center;
      flex-wrap:wrap;
    }
    h1{font-size:1.05rem;margin:0;font-weight:800}
    .toolbar{margin-left:auto;display:flex;gap:.5rem;flex-wrap:wrap}
    .topbtn{
      border:1px solid rgba(255,255,255,0.3);
      background:rgba(255,255,255,0.1);
      color:#fff;
      padding:.45rem .7rem;
      border-radius:.5rem;
      cursor:pointer;
      font-weight:700;
      font-size:.9rem;
      transition:all 0.2s;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .topbtn:hover{background:rgba(255,255,255,0.2)}
    
    .wrap{max-width:1200px;margin:1rem auto;padding:0 1rem 100px}
    
    .card{
      background:var(--card);
      border-radius:14px;
      box-shadow:0 3px 12px rgba(0,0,0,.06);
      padding:20px;
      margin-bottom:20px;
    }
    .card h2{margin-top:0;color:var(--primary);font-weight:800}
    
    .tabs{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap}
    .tab{
      border:1px solid var(--border);
      background:#fafafa;
      padding:10px 16px;
      border-radius:999px;
      font-weight:800;
      cursor:pointer;
      font-size:0.95rem;
      transition:all 0.2s;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .tab:hover{background:#f0f0f0}
    .tab.active{color:#fff;background:var(--primary);border-color:var(--primary)}
    
    .table-head,.row{
      display:grid;
      grid-template-columns:120px 1fr 280px;
      gap:12px;
      padding:14px 10px;
      align-items:center;
      border-bottom:1px solid var(--border);
    }
    .table-head{font-weight:800;color:#666;background:#fafafa;border-radius:8px 8px 0 0}
    .row:last-child{border-bottom:none}
    .row:hover{background:#f9f9f9}
    
    .pill{
      display:inline-block;
      font-weight:800;
      border-radius:999px;
      padding:5px 12px;
      font-size:0.85rem;
    }
    .pill.offen{background:#fef3c7;color:#92400e}
    .pill.archiviert{background:#dcfce7;color:#166534}
    
    .btn{
      background:var(--primary);
      color:#fff;
      border:0;
      border-radius:10px;
      padding:10px 14px;
      font-weight:800;
      cursor:pointer;
      font-size:0.9rem;
      transition:all 0.2s;
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-family:inherit;
    }
    .btn:hover{background:#a00d26;transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
    
    .btn-secondary{background:#6b7280;color:#fff}
    .btn-secondary:hover{background:#4b5563}
    
    .btn-icon{
      background:transparent;
      color:var(--primary);
      border:1px solid var(--primary);
      padding:8px 12px;
      font-size:0.85rem;
    }
    .btn-icon:hover{background:#fff5f5;transform:translateY(-1px)}
    
    .add-btn{
      position:fixed;
      bottom:30px;
      right:30px;
      width:60px;
      height:60px;
      border-radius:50%;
      background:var(--primary);
      color:#fff;
      border:0;
      cursor:pointer;
      font-size:1.5rem;
      box-shadow:0 4px 12px rgba(0,0,0,.2);
      z-index:100;
      transition:transform 0.2s;
    }
    .add-btn:hover{transform:scale(1.1)}
    .add-btn:active{transform:scale(0.95)}
    
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:flex-start;
      justify-content:center;
      z-index:1000;
      padding:20px;
      overflow-y:auto;
    }
    .modal.show{display:flex}
    
    .modal-box{
      background:#fff;
      border-radius:14px;
      max-width:1200px;
      width:100%;
      max-height:90vh;
      overflow-y:auto;
      padding:24px;
      box-shadow:0 8px 20px rgba(0,0,0,.3);
      margin:auto;
    }
    .modal-box h3{margin-top:0;color:var(--primary);font-weight:800}
    
    details{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:.75rem;
      margin:0 0 .8rem 0;
      overflow:hidden;
    }
    summary{
      list-style:none;
      padding:.9rem 1rem;
      cursor:pointer;
      font-weight:800;
      display:flex;
      align-items:center;
      gap:.6rem;
      font-size:1rem;
      background:#fafafa;
      transition:background 0.2s;
    }
    summary::-webkit-details-marker{display:none}
    summary:hover{background:#f0f0f0}
    details[open] summary{border-bottom:1px solid var(--border);background:#fff7f7}
    
    .sec-body{padding:1rem}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:.75rem}
    .form-row{display:flex;gap:.75rem;flex-wrap:wrap;margin:.25rem 0}
    
    label{font-size:.92rem;color:#111827;font-weight:600}
    input[type="text"],input[type="number"],input[type="datetime-local"],input[type="date"],input[type="time"],textarea,select{
      width:100%;
      padding:.55rem .6rem;
      border:1px solid var(--border);
      border-radius:.5rem;
      background:#fff;
      font-size:16px;
      font-family:inherit;
      transition:border-color 0.2s;
    }
    input:focus,textarea:focus,select:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(200,16,46,0.1);
    }
    textarea{min-height:88px;resize:vertical}
    
    fieldset{
      border:1px solid var(--border);
      border-radius:.6rem;
      padding:.75rem;
      margin-bottom:.75rem;
    }
    fieldset legend{padding:0 .35rem;color:#111827;font-weight:700}
    
    .choice{display:flex;gap:.6rem;flex-wrap:wrap}
    .pill-input{
      display:inline-flex;
      align-items:center;
      gap:.4rem;
      border:1px solid var(--border);
      border-radius:999px;
      padding:.25rem .55rem;
      background:#fff;
      font-size:.9rem;
      cursor:pointer;
      transition:all 0.2s;
    }
    .pill-input:hover{background:#f8fafc;border-color:var(--primary)}
    
    .badge{
      display:inline-block;
      padding:.2rem .5rem;
      border-radius:999px;
      background:#f1f5f9;
      color:#0f172a;
      border:1px solid var(--border);
      font-size:.8rem;
      font-weight:600;
    }
    
    table{width:100%;border-collapse:collapse;margin-top:.5rem}
    th,td{border:1px solid var(--border);padding:.5rem;text-align:left;font-size:.9rem}
    th{background:#f8fafc;font-weight:700}
    
    .subbtn{
      border:1px solid var(--border);
      background:#fff;
      padding:.35rem .55rem;
      border-radius:.45rem;
      cursor:pointer;
      font-size:.9rem;
      font-weight:600;
      font-family:inherit;
      transition:all 0.2s;
    }
    .subbtn:hover{background:#f8fafc;border-color:var(--primary)}
    
    .thumbs{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem}
    .thumb{position:relative}
    .thumb img{
      width:120px;
      height:120px;
      object-fit:cover;
      border:1px solid var(--border);
      border-radius:.5rem;
    }
    .thumb .rm{
      position:absolute;
      top:6px;
      right:6px;
      border:1px solid #0002;
      background:#0006;
      color:#fff;
      border-radius:.35rem;
      padding:.15rem .35rem;
      cursor:pointer;
      font-weight:700;
    }
    
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;margin:16px 0}
    .form-group{display:flex;flex-direction:column;gap:6px}
    .form-group label{font-weight:700;font-size:0.9rem;color:#374151}
    .form-group input,.form-group textarea,.form-group select{
      padding:10px 12px;
      border:1px solid #d1d5db;
      border-radius:8px;
      font-size:16px;
      font-family:inherit;
    }
    .form-group input:focus,.form-group textarea:focus,.form-group select:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(200,16,46,0.1);
    }
    .form-group textarea{min-height:80px;resize:vertical}
    
    .radio-group{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    .radio-group label{display:flex;align-items:center;gap:6px;font-weight:600;cursor:pointer}
    
    .sig-wrap{
      border:2px dashed #d1d5db;
      border-radius:8px;
      padding:12px;
      background:#f9fafb;
      margin:16px 0;
    }
    canvas.sig-canvas{
      width:100%;
      height:200px;
      border:1px solid #d1d5db;
      border-radius:6px;
      background:#fff;
      cursor:crosshair;
      touch-action:none;
      display:block;
    }
    .sig-actions{margin-top:8px;display:flex;gap:8px}
    
    .msg{margin-top:12px;padding:12px;border-radius:8px}
    .msg.error{background:#fee;color:#c00;border:1px solid #fcc}
    .msg.success{background:#efe;color:#060;border:1px solid #cfc}
    
    .details-grid{display:grid;grid-template-columns:200px 1fr;gap:12px 20px;margin:16px 0}
    .details-label{font-weight:700;color:#6b7280}
    .details-value{color:#111827;word-break:break-word}
    
    .signature-img{
      max-width:400px;
      max-height:200px;
      border:1px solid #d1d5db;
      border-radius:6px;
      margin-top:8px;
    }
    
    .photo-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(150px,1fr));
      gap:10px;
      margin-top:10px;
    }
    .photo-grid img{
      width:100%;
      height:150px;
      object-fit:cover;
      border:1px solid #ddd;
      border-radius:6px;
    }
    
    @media (max-width:768px){
      .table-head,.row{grid-template-columns:1fr !important;gap:8px}
      .modal-box{padding:16px}
      .form-grid{grid-template-columns:1fr}
      .details-grid{grid-template-columns:1fr;gap:4px}
      .details-label{font-size:0.85rem}
      .add-btn{bottom:20px;right:20px;width:56px;height:56px;font-size:1.3rem}
      .grid{grid-template-columns:1fr}
      h1{font-size:.95rem}
      .topbtn{font-size:.85rem;padding:.4rem .6rem}
    }
    
    @media print{
      header,.tabs,.btn,.add-btn,.modal{display:none !important}
      body{background:#fff}
      .card{box-shadow:none;border:1px solid #ddd}
      details{border:none}
      summary{display:none}
    }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <h1><i class="fa-solid fa-file-medical"></i> Patientendokumentation</h1>
      <div class="toolbar">
        <a class="topbtn" href="mpg-dashboard.html"><i class="fa-solid fa-dashboard"></i> Dashboard</a>
        <button class="topbtn" id="logout"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <section class="card">
      <h2>Dokumentenverwaltung</h2>
      
      <div class="tabs">
        <button class="tab active" data-tab="pat"><i class="fa-solid fa-file-medical"></i> Patientendokus (Offen)</button>
        <button class="tab" data-tab="nach"><i class="fa-solid fa-clipboard-list"></i> Nacherfassungen (Offen)</button>
        <button class="tab" data-tab="archiv"><i class="fa-solid fa-box-archive"></i> Archiv</button>
      </div>

      <div id="tab-pat" class="tab-content">
        <div class="table-head">
          <div>Status</div><div>Dokument</div><div>Aktionen</div>
        </div>
        <div id="pat-rows"></div>
      </div>

      <div id="tab-nach" class="tab-content" style="display:none">
        <div class="table-head">
          <div>Status</div><div>Nacherfassung</div><div>Aktionen</div>
        </div>
        <div id="nach-rows"></div>
      </div>

      <div id="tab-archiv" class="tab-content" style="display:none">
        <div class="table-head">
          <div>Typ</div><div>Dokument</div><div>Aktionen</div>
        </div>
        <div id="archiv-rows"></div>
      </div>

      <div id="msg"></div>
    </section>
  </div>

  <button class="add-btn" id="addBtn" title="Neue Nacherfassung">
    <i class="fa-solid fa-plus"></i>
  </button>

  <div class="modal" id="editModal">
    <div class="modal-box">
      <h3><i class="fa-solid fa-edit"></i> Patientendokumentation bearbeiten</h3>
      <div id="editFormContainer"></div>
      <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end;position:sticky;bottom:0;background:#fff;padding-top:16px;border-top:2px solid var(--border)">
        <button class="btn btn-secondary" onclick="closeEditModal()"><i class="fa-solid fa-times"></i> Abbrechen</button>
        <button class="btn" onclick="saveAndSignPatDoc()"><i class="fa-solid fa-save"></i> Speichern & Gegenzeichnen</button>
      </div>
    </div>
  </div>

  <div class="modal" id="signModal">
    <div class="modal-box" style="max-width:600px">
      <h3><i class="fa-solid fa-signature"></i> Verantwortlicher / MPG-Beauftragter</h3>
      <p>Dokument wurde geprüft und ist korrekt. Mit Unterschrift wird es ins Archiv verschoben.</p>
      <div class="form-group">
        <label>Name (Verantwortlicher / MPG-Beauftragter):</label>
        <input type="text" id="adminName" placeholder="Ihr Name">
      </div>
      <div class="sig-wrap">
        <label style="font-weight:700;margin-bottom:8px;display:block">Unterschrift:</label>
        <canvas id="adminSigCanvas" class="sig-canvas"></canvas>
        <div class="sig-actions">
          <button class="btn btn-secondary" onclick="clearAdminSig()"><i class="fa-solid fa-eraser"></i> Löschen</button>
        </div>
      </div>
      <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end">
        <button class="btn btn-secondary" onclick="closeSignModal()">Abbrechen</button>
        <button class="btn" onclick="archiveWithSignature()"><i class="fa-solid fa-check"></i> Unterschreiben & Archivieren</button>
      </div>
    </div>
  </div>

  <div class="modal" id="nachModal">
    <div class="modal-box">
      <h3><i class="fa-solid fa-clipboard-list"></i> Einsatznacherfassung</h3>
      <form id="nachForm">
        <div class="form-grid">
          <div class="form-group">
            <label>Datum/Alarmzeit:</label>
            <input type="datetime-local" name="datum_alarmzeit">
          </div>
          <div class="form-group">
            <label>Datum/Einsatzende:</label>
            <input type="datetime-local" name="datum_einsatzende">
          </div>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label>Stichwort:</label>
            <input type="text" name="stichwort">
          </div>
          <div class="form-group">
            <label>Kategorie:</label>
            <input type="text" name="kategorie">
          </div>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label>Einsatznummer der ILS:</label>
            <input type="text" name="einsatznummer_ils">
          </div>
          <div class="form-group">
            <label>Meldebild:</label>
            <input type="text" name="meldebild">
          </div>
        </div>
        <div class="form-group">
          <label>Adresse:</label>
          <textarea name="adresse"></textarea>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label>Disponierte EM (FW):</label>
            <input type="text" name="disponierte_em_fw">
          </div>
          <div class="form-group">
            <label>Disponierte EM (RD):</label>
            <input type="text" name="disponierte_em_rd">
          </div>
        </div>
        <h4 style="margin-top:20px;color:var(--primary)">Patienten-Daten</h4>
        <div class="form-group">
          <label>Erhoben:</label>
          <div class="radio-group">
            <label><input type="radio" name="patienten_daten_erhoben" value="ja"> Ja</label>
            <label><input type="radio" name="patienten_daten_erhoben" value="nein"> Nein</label>
          </div>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label>Name:</label>
            <input type="text" name="patient_name">
          </div>
          <div class="form-group">
            <label>Alter/Geburtsdatum:</label>
            <input type="text" name="patient_alter_geburtsdatum">
          </div>
          <div class="form-group">
            <label>Pat.-Nummer der ILS:</label>
            <input type="text" name="patient_nummer_ils">
          </div>
        </div>
        <div class="form-group">
          <label>Sachverhalt vor Ort:</label>
          <textarea name="sachverhalt" rows="4"></textarea>
        </div>
        <h4 style="margin-top:20px;color:var(--primary)">Protokollpflicht</h4>
        <div class="form-group">
          <label>War dieser Einsatz gemäß §630f BGB protokollpflichtig?</label>
          <div class="radio-group">
            <label><input type="radio" name="protokollpflichtig" value="ja"> Ja</label>
            <label><input type="radio" name="protokollpflichtig" value="nein"> Nein</label>
          </div>
        </div>
        <div class="form-group">
          <label>Begründung:</label>
          <textarea name="protokollpflichtig_begruendung"></textarea>
        </div>
        <div class="form-group">
          <label>War die verantwortliche Person mit der Thematik der Einsatz-/Patientendokumentation (gem. §630f BGB) unterwiesen?</label>
          <div class="radio-group">
            <label><input type="radio" name="verantwortlicher_unterwiesen" value="ja"> Ja</label>
            <label><input type="radio" name="verantwortlicher_unterwiesen" value="nein"> Nein</label>
          </div>
        </div>
        <h4 style="margin-top:20px;color:var(--primary)">Verantwortlicher</h4>
        <div class="form-grid">
          <div class="form-group">
            <label>Name:</label>
            <input type="text" name="verantwortlicher_name">
          </div>
          <div class="form-group">
            <label>Qualifikation:</label>
            <input type="text" name="verantwortlicher_qualifikation">
          </div>
        </div>
        <h4 style="margin-top:20px;color:var(--primary)">Nacherfassung</h4>
        <div class="form-grid">
          <div class="form-group">
            <label>Nacherfasst von (Name):</label>
            <input type="text" name="nacherfasst_von_name" required>
          </div>
          <div class="form-group">
            <label>Qualifikation:</label>
            <input type="text" name="nacherfasst_von_qualifikation">
          </div>
        </div>
        <div class="sig-wrap">
          <label style="font-weight:700;margin-bottom:8px;display:block">Unterschrift:</label>
          <canvas id="nachSigCanvas" class="sig-canvas"></canvas>
          <div class="sig-actions">
            <button type="button" class="btn btn-secondary" onclick="clearNachSig()"><i class="fa-solid fa-eraser"></i> Löschen</button>
          </div>
        </div>
      </form>
      <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end">
        <button class="btn btn-secondary" onclick="closeNachModal()">Abbrechen</button>
        <button class="btn" onclick="saveNacherfassung()"><i class="fa-solid fa-save"></i> Speichern</button>
      </div>
    </div>
  </div>

  <div class="modal" id="detailsModal">
    <div class="modal-box">
      <h3 id="detailsTitle">Details</h3>
      <div id="detailsBody"></div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
        <button class="btn btn-secondary" onclick="closeDetailsModal()">
          <i class="fa-solid fa-times"></i> Schließen
        </button>
        <button class="btn" onclick="generatePDFFromModal()">
          <i class="fa-solid fa-file-pdf"></i> PDF erstellen
        </button>
      </div>
    </div>
  </div>
  <script type="module">
    const pb = new PocketBase('https://api.responda.systems');

    if (!pb.authStore.isValid) {
      location.href = "/mpg-login.html";
    }

    const currentUser = pb.authStore.model;
    if (!currentUser || !currentUser.organization_id) {
      location.href = "/mpg-login.html";
    }

    let currentOrganization = null;
    async function loadOrganization() {
      try {
        currentOrganization = await pb.collection('organizations').getOne(currentUser.organization_id);
        console.log('✅ Organization loaded:', currentOrganization);
      } catch(e) {
        console.error('❌ Error loading organization:', e);
      }
    }
    loadOrganization();

    document.getElementById("logout").onclick = async (e) => {
      e.preventDefault();
      pb.authStore.clear();
      localStorage.clear();
      location.href = "/mpg-login.html";
    };

    document.querySelectorAll('.tab').forEach(tab => {
      tab.onclick = () => {
        const targetTab = tab.dataset.tab;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = 'none');
        document.getElementById('tab-' + targetTab).style.display = 'block';
        document.getElementById('msg').textContent = '';
      };
    });

    async function loadData() {
      try {
        const patData = await pb.collection('patients').getFullList({
          filter: `status = "offen" && organization_id = "${currentUser.organization_id}"`,
          sort: '-created',
        });
        
        const patRows = document.getElementById('pat-rows');
        patRows.innerHTML = patData.map(doc => {
          const payload = doc.payload || {};
          const patName = `${payload.vorname || ''} ${payload.name || ''}`.trim() || 'Unbekannt';
          return `
          <div class="row">
            <div><span class="pill offen">${doc.status}</span></div>
            <div>
              <strong>${doc.title || patName}</strong><br>
              <small style="color:#6b7280">${payload.einsatz_nr ? 'Einsatz-Nr: ' + payload.einsatz_nr + ' · ' : ''}${new Date(doc.created).toLocaleString('de-DE')}</small>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-icon" onclick="editPatDoc('${doc.id}')">
                <i class="fa-solid fa-edit"></i> Bearbeiten
              </button>
            </div>
          </div>
        `;
        }).join('') || '<p style="padding:20px;color:#999">Keine offenen Patientendokus</p>';

        const nachData = await pb.collection('patient_docs_nacherfassung').getFullList({
          filter: `status = "offen" && organization_id = "${currentUser.organization_id}"`,
          sort: '-created',
        });
        
        const nachRows = document.getElementById('nach-rows');
        nachRows.innerHTML = nachData.map(doc => `
          <div class="row">
            <div><span class="pill offen">${doc.status}</span></div>
            <div>
              <strong>${doc.stichwort || 'Ohne Stichwort'}</strong><br>
              <small style="color:#6b7280">von ${doc.nacherfasst_von_name || '?'} · ${new Date(doc.created).toLocaleString('de-DE')}</small>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-icon" onclick="viewNach('${doc.id}')">
                <i class="fa-solid fa-eye"></i> Details
              </button>
              <button class="btn btn-icon" onclick="archiveNach('${doc.id}')">
                <i class="fa-solid fa-box-archive"></i> Archivieren
              </button>
            </div>
          </div>
        `).join('') || '<p style="padding:20px;color:#999">Keine offenen Nacherfassungen</p>';

        const archivPat = await pb.collection('patients').getFullList({
          filter: `status = "archiviert" && organization_id = "${currentUser.organization_id}"`,
          sort: '-updated',
        });
        
        const archivNach = await pb.collection('patient_docs_nacherfassung').getFullList({
          filter: `status = "archiviert" && organization_id = "${currentUser.organization_id}"`,
          sort: '-updated',
        });
        
        const archivRows = document.getElementById('archiv-rows');
        let archivHTML = '';
        
        archivPat.forEach(doc => {
          const payload = doc.payload || {};
          const patName = `${payload.vorname || ''} ${payload.name || ''}`.trim() || doc.title || 'Ohne Titel';
          archivHTML += `
            <div class="row">
              <div><span class="pill archiviert">Patientendoku</span></div>
              <div>
                <strong>${patName}</strong><br>
                <small style="color:#6b7280">${payload.einsatz_nr ? 'Einsatz-Nr: ' + payload.einsatz_nr + ' · ' : ''}MPG-Verantwortlicher: ${doc.admin_name || '?'} · ${doc.admin_datum ? new Date(doc.admin_datum).toLocaleString('de-DE') : ''}</small>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn btn-icon" onclick="viewPatArchiv('${doc.id}')">
                  <i class="fa-solid fa-eye"></i> Ansehen
                </button>
              </div>
            </div>
          `;
        });
        
        archivNach.forEach(doc => {
          archivHTML += `
            <div class="row">
              <div><span class="pill archiviert">Nacherfassung</span></div>
              <div>
                <strong>${doc.stichwort || 'Ohne Titel'}</strong><br>
                <small style="color:#6b7280">von ${doc.nacherfasst_von_name || '?'}</small>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn btn-icon" onclick="viewNachArchiv('${doc.id}')">
                  <i class="fa-solid fa-eye"></i> Ansehen
                </button>
              </div>
            </div>
          `;
        });
        
        archivRows.innerHTML = archivHTML || '<p style="padding:20px;color:#999">Kein Archiv vorhanden</p>';

      } catch(e) {
        showMsg('Fehler beim Laden: ' + e.message, 'error');
      }
    }

    let currentEditDoc = null;
    let currentEditPayload = null;
    let medRowCounter = 0;
    
    window.editPatDoc = async (id) => {
      try {
        currentEditDoc = await pb.collection('patients').getOne(id);
        currentEditPayload = currentEditDoc.payload || {};
        
        const formHTML = buildEditForm(currentEditPayload);
        document.getElementById('editFormContainer').innerHTML = formHTML;
        document.querySelectorAll('#editFormContainer details').forEach(d => d.open = true);
        
        const meds = currentEditPayload.medications || [];
        medRowCounter = meds.length;
        
        document.getElementById('editModal').classList.add('show');
      } catch(e) {
        showMsg('Fehler: ' + e.message, 'error');
      }
    };

    function buildEditForm(payload) {
      const v = (key, fallback = '') => payload[key] !== undefined && payload[key] !== null ? payload[key] : fallback;
      const checked = (key) => payload[key] ? 'checked' : '';
      const radioChecked = (key, value) => payload[key] === value ? 'checked' : '';
      
      const medications = payload.medications || [];
      let medRowsHTML = '';
      medications.forEach((med, idx) => {
        const i = idx + 1;
        medRowsHTML += `<tr><td>${i}</td><td><input type="text" name="med_name_${i}" value="${med.name || ''}" style="width:100%;padding:.3rem;font-size:14px"></td><td><input type="number" name="med_dose_${i}" value="${med.dose || ''}" step="0.1" style="width:80px;padding:.3rem;font-size:14px"></td><td><input type="text" name="med_unit_${i}" value="${med.unit || ''}" placeholder="mg" style="width:60px;padding:.3rem;font-size:14px"></td><td><select name="med_route_${i}" style="padding:.3rem;font-size:14px"><option value="">-</option><option value="i.v." ${med.route === 'i.v.' ? 'selected' : ''}>i.v.</option><option value="i.m." ${med.route === 'i.m.' ? 'selected' : ''}>i.m.</option><option value="s.c." ${med.route === 's.c.' ? 'selected' : ''}>s.c.</option><option value="p.o." ${med.route === 'p.o.' ? 'selected' : ''}>p.o.</option><option value="inhal." ${med.route === 'inhal.' ? 'selected' : ''}>inhal.</option></select></td><td><input type="time" name="med_time_${i}" value="${med.time || ''}" style="width:90px;padding:.3rem;font-size:14px"></td><td><input type="text" name="med_note_${i}" value="${med.note || ''}" style="width:100%;padding:.3rem;font-size:14px"></td><td><button class="subbtn" type="button" onclick="this.closest('tr').remove()">×</button></td></tr>`;
      });
      
      const photos = payload.photos || [];
      let photosHTML = '';
      if (photos.length > 0) {
        photosHTML = '<div class="thumbs">';
        photos.forEach((photo, idx) => {
          photosHTML += `<div class="thumb"><img src="${photo}" alt="Foto ${idx+1}"></div>`;
        });
        photosHTML += '</div>';
      }
      
      return `
<details open><summary><i class="fa-solid fa-truck-medical"></i> Einsatzdaten</summary><div class="sec-body"><div class="grid"><label>Einsatz-Nr.<input name="einsatz_nr" type="text" value="${v('einsatz_nr')}"></label><label>Pat./Auftrags-Nr.<input name="auftrags_nr" type="text" value="${v('auftrags_nr')}"></label><label>Rufname<input name="rufname" type="text" value="${v('rufname')}"></label><label>Fahrzeug<input name="fahrzeug" type="text" value="${v('fahrzeug')}"></label><label>Datum/Uhrzeit<input name="zeit_einsatz" type="datetime-local" value="${v('zeit_einsatz')}"></label></div><label>Einsatz-Art<input name="einsatz_art" type="text" value="${v('einsatz_art')}"></label></div></details>

<details open><summary><i class="fa-solid fa-id-card-clip"></i> Pat-Stammdaten</summary><div class="sec-body"><div class="grid"><label>Name<input name="name" type="text" value="${v('name')}"></label><label>Vorname<input name="vorname" type="text" value="${v('vorname')}"></label><label>Geb.-Datum<input name="gebdatum" type="date" value="${v('gebdatum')}"></label><label>Alter<input name="alter" type="number" value="${v('alter')}"></label><label>Telefon<input name="telefon" type="text" value="${v('telefon')}"></label><label>Mobil<input name="mobil" type="text" value="${v('mobil')}"></label><label>Straße<input name="strasse" type="text" value="${v('strasse')}"></label><label>PLZ, Ort<input name="plz_ort" type="text" value="${v('plz_ort')}"></label><label>Kasse / Nr.<input name="kasse" type="text" value="${v('kasse')}"></label><label>Vers.-Nr.<input name="versnr" type="text" value="${v('versnr')}"></label><label>Hausarzt / Tel.<input name="hausarzt" type="text" value="${v('hausarzt')}"></label><label>Angehöriger / Tel.<input name="angehoeriger" type="text" value="${v('angehoeriger')}"></label></div><label>Informationen / Aspekte<textarea name="infos">${v('infos')}</textarea></label></div></details>

<details open><summary><i class="fa-solid fa-notes-medical"></i> Notfallgeschehen / Anamnese</summary><div class="sec-body"><textarea name="notfallgeschehen">${v('notfallgeschehen')}</textarea>${photosHTML ? '<div style="margin-top:.75rem"><strong>Fotos:</strong>' + photosHTML + '</div>' : ''}</div></details>

<details><summary><i class="fa-solid fa-brain"></i> Neurologie</summary><div class="sec-body"><div class="grid"><label>Zeitpunkt<input name="neu_zeit" type="datetime-local" value="${v('neu_zeit')}"></label><label class="pill-input"><input type="checkbox" name="neu_unauff" ${checked('neu_unauff')}> ohne path. Befund</label></div><div class="grid"><fieldset><legend>Pupillenweite – rechts</legend><div class="choice"><label class="pill-input"><input type="radio" name="pw_r" value="eng" ${radioChecked('pw_r','eng')}> eng</label><label class="pill-input"><input type="radio" name="pw_r" value="mittel" ${radioChecked('pw_r','mittel')}> mittel</label><label class="pill-input"><input type="radio" name="pw_r" value="weit" ${radioChecked('pw_r','weit')}> weit</label><label class="pill-input"><input type="checkbox" name="pw_r_entrundet" ${checked('pw_r_entrundet')}> entrundet</label></div><div class="choice" style="margin-top:.5rem"><span class="badge">Lichtreaktion</span><label class="pill-input"><input type="radio" name="lr_r" value="prompt" ${radioChecked('lr_r','prompt')}> prompt</label><label class="pill-input"><input type="radio" name="lr_r" value="träge" ${radioChecked('lr_r','träge')}> träge</label><label class="pill-input"><input type="radio" name="lr_r" value="keine" ${radioChecked('lr_r','keine')}> keine</label></div></fieldset><fieldset><legend>Pupillenweite – links</legend><div class="choice"><label class="pill-input"><input type="radio" name="pw_l" value="eng" ${radioChecked('pw_l','eng')}> eng</label><label class="pill-input"><input type="radio" name="pw_l" value="mittel" ${radioChecked('pw_l','mittel')}> mittel</label><label class="pill-input"><input type="radio" name="pw_l" value="weit" ${radioChecked('pw_l','weit')}> weit</label><label class="pill-input"><input type="checkbox" name="pw_l_entrundet" ${checked('pw_l_entrundet')}> entrundet</label></div><div class="choice" style="margin-top:.5rem"><span class="badge">Lichtreaktion</span><label class="pill-input"><input type="radio" name="lr_l" value="prompt" ${radioChecked('lr_l','prompt')}> prompt</label><label class="pill-input"><input type="radio" name="lr_l" value="träge" ${radioChecked('lr_l','träge')}> träge</label><label class="pill-input"><input type="radio" name="lr_l" value="keine" ${radioChecked('lr_l','keine')}> keine</label></div></fieldset></div></div></details>

<details><summary><i class="fa-solid fa-eye"></i> Glasgow Coma Scale</summary><div class="sec-body"><fieldset><legend>Augenöffnung (E)</legend><div class="choice"><label class="pill-input"><input type="radio" name="gcs_e" value="4" ${radioChecked('gcs_e','4')}> spontan (4)</label><label class="pill-input"><input type="radio" name="gcs_e" value="3" ${radioChecked('gcs_e','3')}> auf Geräusch (3)</label><label class="pill-input"><input type="radio" name="gcs_e" value="2" ${radioChecked('gcs_e','2')}> auf Druck (2)</label><label class="pill-input"><input type="radio" name="gcs_e" value="1" ${radioChecked('gcs_e','1')}> keine (1)</label></div></fieldset><fieldset><legend>Verbale Antwort (V)</legend><div class="choice"><label class="pill-input"><input type="radio" name="gcs_v" value="5" ${radioChecked('gcs_v','5')}> orientiert (5)</label><label class="pill-input"><input type="radio" name="gcs_v" value="4" ${radioChecked('gcs_v','4')}> verwirrt (4)</label><label class="pill-input"><input type="radio" name="gcs_v" value="3" ${radioChecked('gcs_v','3')}> Wörter (3)</label><label class="pill-input"><input type="radio" name="gcs_v" value="2" ${radioChecked('gcs_v','2')}> Laute (2)</label><label class="pill-input"><input type="radio" name="gcs_v" value="1" ${radioChecked('gcs_v','1')}> keine (1)</label></div></fieldset><fieldset><legend>Motorische Antwort (M)</legend><div class="choice"><label class="pill-input"><input type="radio" name="gcs_m" value="6" ${radioChecked('gcs_m','6')}> folgt (6)</label><label class="pill-input"><input type="radio" name="gcs_m" value="5" ${radioChecked('gcs_m','5')}> lokalisiert (5)</label><label class="pill-input"><input type="radio" name="gcs_m" value="4" ${radioChecked('gcs_m','4')}> beugt normal (4)</label><label class="pill-input"><input type="radio" name="gcs_m" value="3" ${radioChecked('gcs_m','3')}> beugt abnormal (3)</label><label class="pill-input"><input type="radio" name="gcs_m" value="2" ${radioChecked('gcs_m','2')}> streckt (2)</label><label class="pill-input"><input type="radio" name="gcs_m" value="1" ${radioChecked('gcs_m','1')}> keine (1)</label></div></fieldset><div class="badge" style="margin-top:.5rem">GCS Summe: ${calculateGCS(payload)}</div></div></details>

<details><summary><i class="fa-regular fa-hand"></i> Haut</summary><div class="sec-body"><div class="choice"><label class="pill-input"><input type="checkbox" name="haut_unauff" ${checked('haut_unauff')}> unauffällig</label><label class="pill-input"><input type="checkbox" name="haut_falten" ${checked('haut_falten')}> stehende Hautfalten</label><label class="pill-input"><input type="checkbox" name="haut_oedeme" ${checked('haut_oedeme')}> Ödeme</label><label class="pill-input"><input type="checkbox" name="haut_dekubitus" ${checked('haut_dekubitus')}> Dekubitus</label><label class="pill-input"><input type="checkbox" name="haut_kaltschweissig" ${checked('haut_kaltschweissig')}> kaltschweißig</label><label class="pill-input"><input type="checkbox" name="haut_exanthem" ${checked('haut_exanthem')}> Exanthem</label></div></div></details>

<details><summary><i class="fa-solid fa-user"></i> Psyche</summary><div class="sec-body"><div class="choice"><label class="pill-input"><input type="checkbox" name="psy_erregt" ${checked('psy_erregt')}> erregt</label><label class="pill-input"><input type="checkbox" name="psy_aggr" ${checked('psy_aggr')}> aggressiv</label><label class="pill-input"><input type="checkbox" name="psy_verlangsamt" ${checked('psy_verlangsamt')}> verlangsamt</label><label class="pill-input"><input type="checkbox" name="psy_depressiv" ${checked('psy_depressiv')}> depressiv</label><label class="pill-input"><input type="checkbox" name="psy_aengstlich" ${checked('psy_aengstlich')}> ängstlich</label><label class="pill-input"><input type="checkbox" name="psy_euphorisch" ${checked('psy_euphorisch')}> euphorisch</label><label class="pill-input"><input type="checkbox" name="psy_wahnhaft" ${checked('psy_wahnhaft')}> wahnhaft</label><label class="pill-input"><input type="checkbox" name="psy_verwirrt" ${checked('psy_verwirrt')}> verwirrt</label><label class="pill-input"><input type="checkbox" name="psy_suizidal" ${checked('psy_suizidal')}> suizidal</label><label class="pill-input"><input type="checkbox" name="psy_motor_unruhig" ${checked('psy_motor_unruhig')}> motorisch unruhig</label></div></div></details>

<details open><summary><i class="fa-solid fa-stethoscope"></i> Messwerte / Atmung</summary><div class="sec-body"><div class="grid"><label>RR syst. (mmHg)<input name="rr_sys" type="number" value="${v('rr_sys')}"></label><label>RR diast. (mmHg)<input name="rr_dia" type="number" value="${v('rr_dia')}"></label><label>HF (/min)<input name="hf" type="number" value="${v('hf')}"></label><label>AF (/min)<input name="af" type="number" value="${v('af')}"></label><label>SpO₂ (%)<input name="spo2" type="number" value="${v('spo2')}"></label><label>etCO₂ (mmHg)<input name="etco2" type="number" value="${v('etco2')}"></label><label>Temp (°C)<input name="temp" type="number" step="0.1" value="${v('temp')}"></label><label>BZ (mg/dl)<input name="bz_mg" type="number" value="${v('bz_mg')}"></label><label>BZ (mmol/l)<input name="bz_mmol" type="number" step="0.1" value="${v('bz_mmol')}"></label><label>Schmerz (0–10)<input name="schmerz" type="number" min="0" max="10" value="${v('schmerz')}"></label></div><fieldset style="margin-top:.8rem"><legend>qSOFA (auto)</legend><div class="badge">qSOFA-Score: ${calculateQSOFA(payload)}</div></fieldset><fieldset><legend>Atmung – klinische Zeichen</legend><div class="choice"><label class="pill-input"><input type="checkbox" name="atm_apnoe" ${checked('atm_apnoe')}> Apnoe</label><label class="pill-input"><input type="checkbox" name="atm_stridor" ${checked('atm_stridor')}> Stridor</label><label class="pill-input"><input type="checkbox" name="atm_hypervent" ${checked('atm_hypervent')}> Hyperventilation</label><label class="pill-input"><input type="checkbox" name="atm_dyspnoe" ${checked('atm_dyspnoe')}> Dyspnoe</label><label class="pill-input"><input type="checkbox" name="atm_beatmung" ${checked('atm_beatmung')}> Beatmung</label><label class="pill-input"><input type="checkbox" name="atm_zyanose" ${checked('atm_zyanose')}> Zyanose</label><label class="pill-input"><input type="checkbox" name="atm_verlegung" ${checked('atm_verlegung')}> Atemwegsverlegung</label></div><textarea name="atm_sonst">${v('atm_sonst')}</textarea></fieldset><fieldset><legend>O₂-Gabe</legend><div class="choice"><label class="pill-input"><input type="radio" name="o2" value="raumluft" ${radioChecked('o2','raumluft')}> Raumluft</label><label class="pill-input"><input type="radio" name="o2" value="unter_o2" ${radioChecked('o2','unter_o2')}> unter O₂</label><label class="pill-input"><input type="checkbox" name="o2_nasal" ${checked('o2_nasal')}> Nasensonde</label><label class="pill-input"><input type="checkbox" name="o2_maske" ${checked('o2_maske')}> Maske</label><label class="pill-input"><input type="checkbox" name="o2_reservoir" ${checked('o2_reservoir')}> Maske m. Reservoir</label></div><div class="grid" style="margin-top:.4rem"><label>Flow (l/min)<input name="o2_flow" type="number" step="0.5" value="${v('o2_flow')}"></label><label>Kommentar<input name="o2_comment" type="text" value="${v('o2_comment')}"></label></div></fieldset></div></details>

<details><summary><i class="fa-solid fa-heart-pulse"></i> Rhythmus / EKG</summary><div class="sec-body"><div class="choice"><label class="pill-input"><input type="checkbox" name="sr" ${checked('sr')}> Sinusrhythmus</label><label class="pill-input"><input type="checkbox" name="stemi" ${checked('stemi')}> STEMI</label><label class="pill-input"><input type="checkbox" name="arrh_abs" ${checked('arrh_abs')}> absolute Arrhythmie</label><label class="pill-input"><input type="checkbox" name="vf" ${checked('vf')}> Kammerflimmern</label><label class="pill-input"><input type="checkbox" name="av3" ${checked('av3')}> AV-Block III°</label><label class="pill-input"><input type="checkbox" name="asystole" ${checked('asystole')}> Asystolie</label></div><div class="grid" style="margin-top:.5rem"><label>Standort<input name="ekg_standort" type="text" value="${v('ekg_standort')}"></label><label>Pers-Nr.<input name="ekg_persnr" type="text" value="${v('ekg_persnr')}"></label></div></div></details>

<details><summary><i class="fa-solid fa-kit-medical"></i> Verletzungen</summary><div class="sec-body"><textarea name="verletz_text">${v('verletz_text')}</textarea></div></details>

<details><summary><i class="fa-solid fa-clipboard-list"></i> Erstdiagnosen</summary><div class="sec-body"><div class="grid"><fieldset><legend>Neuro</legend><div class="choice"><label class="pill-input"><input type="checkbox" name="diag_krampf" ${checked('diag_krampf')}> Konvulsionen</label><label class="pill-input"><input type="checkbox" name="diag_synkope" ${checked('diag_synkope')}> Synkope</label><label class="pill-input"><input type="checkbox" name="diag_apoplex" ${checked('diag_apoplex')}> Apoplex</label><label class="pill-input"><input type="checkbox" name="diag_sht" ${checked('diag_sht')}> SHT</label></div></fieldset><fieldset><legend>Herz-Kreislauf</legend><div class="choice"><label class="pill-input"><input type="checkbox" name="diag_acs" ${checked('diag_acs')}> ACS</label><label class="pill-input"><input type="checkbox" name="diag_insuff" ${checked('diag_insuff')}> Herzinsuffizienz</label><label class="pill-input"><input type="checkbox" name="diag_lungenoedem" ${checked('diag_lungenoedem')}> Lungenödem</label><label class="pill-input"><input type="checkbox" name="diag_luembol" ${checked('diag_luembol')}> Lungenembolie</label></div></fieldset><fieldset><legend>Atmung</legend><div class="choice"><label class="pill-input"><input type="checkbox" name="diag_resp_insuff" ${checked('diag_resp_insuff')}> resp. Insuffizienz</label><label class="pill-input"><input type="checkbox" name="diag_pneumothorax" ${checked('diag_pneumothorax')}> Pneumothorax</label><label class="pill-input"><input type="checkbox" name="diag_asthma" ${checked('diag_asthma')}> Asthma/COPD</label></div></fieldset><fieldset><legend>Stoffwechsel / Schock</legend><div class="choice"><label class="pill-input"><input type="checkbox" name="diag_hypo" ${checked('diag_hypo')}> Hypoglykämie</label><label class="pill-input"><input type="checkbox" name="diag_sept" ${checked('diag_sept')}> septischer Schock</label><label class="pill-input"><input type="checkbox" name="diag_hypovol" ${checked('diag_hypovol')}> hypovolämischer Schock</label></div></fieldset></div></div></details>

<details><summary><i class="fa-solid fa-face-meh"></i> Bewusstseinslage, AZ, Versorgung</summary><div class="sec-body"><div class="grid"><fieldset><legend>Bewusstseinslage</legend><div class="choice"><label class="pill-input"><input type="checkbox" name="bew_wach" ${checked('bew_wach')}> wach</label><label class="pill-input"><input type="checkbox" name="bew_ansprache" ${checked('bew_ansprache')}> Reaktion auf Ansprache</label><label class="pill-input"><input type="checkbox" name="bew_schmerz" ${checked('bew_schmerz')}> Reaktion auf Schmerzreiz</label><label class="pill-input"><input type="checkbox" name="bew_bewusstlos" ${checked('bew_bewusstlos')}> bewusstlos</label></div></fieldset><fieldset><legend>Allgemeinzustand</legend><div class="choice"><label class="pill-input"><input type="radio" name="az" value="gesund" ${radioChecked('az','gesund')}> gesund</label><label class="pill-input"><input type="radio" name="az" value="leicht" ${radioChecked('az','leicht')}> leicht eingeschränkt</label><label class="pill-input"><input type="radio" name="az" value="deutlich" ${radioChecked('az','deutlich')}> deutlich eingeschränkt</label></div></fieldset><fieldset><legend>Versorgungssituation</legend><div class="choice"><label class="pill-input"><input type="radio" name="versorgung" value="unabhaengig" ${radioChecked('versorgung','unabhaengig')}> unabhängig</label><label class="pill-input"><input type="radio" name="versorgung" value="pflege_zuhaus" ${radioChecked('versorgung','pflege_zuhaus')}> Pflege zuhause</label><label class="pill-input"><input type="radio" name="versorgung" value="pflege_institution" ${radioChecked('versorgung','pflege_institution')}> Pflege in Institution</label></div></fieldset></div></div></details>

<details open><summary><i class="fa-solid fa-syringe"></i> Maßnahmen – Zugang & Medikation</summary><div class="sec-body"><fieldset><legend>Zugang</legend><div class="grid"><label>Art<select name="zugang_art"><option value="">-</option><option value="iv" ${v('zugang_art')==='iv'?'selected':''}>i.v.</option><option value="io" ${v('zugang_art')==='io'?'selected':''}>i.o.</option></select></label><label>Seite/Region<input name="zugang_region" type="text" value="${v('zugang_region')}"></label><label>Größe (G)<input name="zugang_gauge" type="number" min="14" max="24" value="${v('zugang_gauge')}"></label><label>Versuche<input name="zugang_versuche" type="number" min="0" value="${v('zugang_versuche')}"></label><label>Zeitpunkt<input name="zugang_zeit" type="datetime-local" value="${v('zugang_zeit')}"></label></div></fieldset><fieldset><legend>Infusion</legend><div class="grid"><label>Art<input name="inf_art" type="text" value="${v('inf_art')}"></label><label>Menge (ml)<input name="inf_menge" type="number" min="0" step="50" value="${v('inf_menge')}"></label><label>Laufrate (ml/h)<input name="inf_rate" type="number" min="0" step="10" value="${v('inf_rate')}"></label><label>Bemerkung<input name="inf_bem" type="text" value="${v('inf_bem')}"></label></div></fieldset><fieldset><legend>Medikamente</legend><button type="button" class="subbtn" onclick="addMedRowEdit()" style="margin-bottom:.5rem"><i class="fa-solid fa-plus"></i> Zeile hinzufügen</button><div style="overflow:auto"><table id="medTableEdit"><thead><tr><th>#</th><th>Medikament</th><th>Dosis</th><th>Einheit</th><th>Route</th><th>Uhrzeit</th><th>Bemerkung</th><th>×</th></tr></thead><tbody>${medRowsHTML}</tbody></table></div></fieldset></div></details>

<details><summary><i class="fa-solid fa-wind"></i> Beatmung / Atemweg</summary><div class="sec-body"><div class="choice"><label class="pill-input"><input type="checkbox" name="aw_guedel" ${checked('aw_guedel')}> Guedel</label><label class="pill-input"><input type="checkbox" name="aw_larynxtubus" ${checked('aw_larynxtubus')}> Larynxtubus</label><label class="pill-input"><input type="checkbox" name="aw_ett" ${checked('aw_ett')}> ETT</label><label class="pill-input"><input type="checkbox" name="aw_bvm" ${checked('aw_bvm')}> BVM</label></div><div class="grid" style="margin-top:.5rem"><label>ETT-Größe<input name="aw_ett_size" type="number" step="0.5" value="${v('aw_ett_size')}"></label><label>PEEP (cmH₂O)<input name="vent_peep" type="number" step="1" value="${v('vent_peep')}"></label><label>FiO₂ (%)<input name="vent_fio2" type="number" min="21" max="100" value="${v('vent_fio2')}"></label></div></div></details>

<details><summary><i class="fa-solid fa-heart-circle-bolt"></i> Reanimation</summary><div class="sec-body"><div class="grid"><label>Rea-Beginn<input name="rea_beginn" type="datetime-local" value="${v('rea_beginn')}"></label><label>Erst-Rhythmus<select name="rea_initial"><option value="">-</option><option value="Asystolie" ${v('rea_initial')==='Asystolie'?'selected':''}>Asystolie</option><option value="PEA" ${v('rea_initial')==='PEA'?'selected':''}>PEA</option><option value="VF" ${v('rea_initial')==='VF'?'selected':''}>VF</option><option value="pVT" ${v('rea_initial')==='pVT'?'selected':''}>pVT</option></select></label><label>Schocks<input name="rea_shocks" type="number" min="0" value="${v('rea_shocks')}"></label><label>ROSC<select name="rea_rosc"><option value="">-</option><option value="ja" ${v('rea_rosc')==='ja'?'selected':''}>ja</option><option value="nein" ${v('rea_rosc')==='nein'?'selected':''}>nein</option></select></label><label>Rea-Ende<input name="rea_ende" type="time" value="${v('rea_ende')}"></label></div></div></details>

<details open><summary><i class="fa-solid fa-people-carry-box"></i> Übergabe / Transport</summary><div class="sec-body"><div class="grid"><label>Übergabe an<input name="ue_name" type="text" value="${v('ue_name')}"></label><label>Zeitpunkt<input name="ue_zeit" type="datetime-local" value="${v('ue_zeit')}"></label><label>Ziel<input name="ziel_bez" type="text" value="${v('ziel_bez')}"></label><label>Adresse<input name="ziel_adr" type="text" value="${v('ziel_adr')}"></label><label>Einsatzende<input name="einsatzende" type="datetime-local" value="${v('einsatzende')}"></label></div></div></details>

<details open><summary><i class="fa-solid fa-signature"></i> Ausfüller & Unterschrift</summary><div class="sec-body"><div class="grid"><label>Name<input name="ausfueller_name" type="text" value="${v('ausfueller_name')}"></label><label>Zeitpunkt<input name="ausfueller_zeit" type="datetime-local" value="${v('ausfueller_zeit')}"></label></div>${payload.signature ? `<div style="margin-top:.75rem"><strong>Unterschrift:</strong><br><img src="${payload.signature}" class="signature-img"></div>` : ''}</div></details>`;
    }

    function calculateGCS(p) {
      const e = parseInt(p.gcs_e || 0);
      const v = parseInt(p.gcs_v || 0);
      const m = parseInt(p.gcs_m || 0);
      const sum = e + v + m;
      return sum > 0 ? sum : '—';
    }

    function calculateQSOFA(p) {
      const gcs = parseInt(p.gcs_e || 0) + parseInt(p.gcs_v || 0) + parseInt(p.gcs_m || 0);
      const af = parseInt(p.af || 0);
      const rrSys = parseInt(p.rr_sys || 0);
      let score = 0;
      if (gcs > 0 && gcs < 15) score++;
      if (af >= 22) score++;
      if (rrSys > 0 && rrSys <= 100) score++;
      return (gcs > 0 || af > 0 || rrSys > 0) ? score : '—';
    }

    window.addMedRowEdit = function() {
      medRowCounter++;
      const tbody = document.querySelector('#medTableEdit tbody');
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${medRowCounter}</td><td><input type="text" name="med_name_${medRowCounter}" style="width:100%;padding:.3rem;font-size:14px"></td><td><input type="number" name="med_dose_${medRowCounter}" step="0.1" style="width:80px;padding:.3rem;font-size:14px"></td><td><input type="text" name="med_unit_${medRowCounter}" placeholder="mg" style="width:60px;padding:.3rem;font-size:14px"></td><td><select name="med_route_${medRowCounter}" style="padding:.3rem;font-size:14px"><option value="">-</option><option value="i.v.">i.v.</option><option value="i.m.">i.m.</option><option value="s.c.">s.c.</option><option value="p.o.">p.o.</option><option value="inhal.">inhal.</option></select></td><td><input type="time" name="med_time_${medRowCounter}" style="width:90px;padding:.3rem;font-size:14px"></td><td><input type="text" name="med_note_${medRowCounter}" style="width:100%;padding:.3rem;font-size:14px"></td><td><button class="subbtn" type="button" onclick="this.closest('tr').remove()">×</button></td>`;
      tbody.appendChild(tr);
    };
    window.closeEditModal = () => {
      document.getElementById('editModal').classList.remove('show');
      // NUR beim echten Abbrechen null setzen, NICHT beim Weiterleiten zum Sign-Modal
      if (!document.getElementById('signModal').classList.contains('show')) {
        currentEditDoc = null;
        currentEditPayload = null;
      }
    };
    
    window.saveAndSignPatDoc = async () => {
      try {
        showMsg('Daten werden gespeichert...', 'success');
        const btn = document.querySelector('#editModal .btn:not(.btn-secondary)');
        btn.disabled = true;

        const form = document.getElementById('editFormContainer');
        const formData = new FormData();
        const inputs = form.querySelectorAll('input, textarea, select');
        inputs.forEach(input => {
          if (input.type === 'checkbox') {
            formData.append(input.name, input.checked);
          } else if (input.type === 'radio') {
            if (input.checked) formData.append(input.name, input.value);
          } else {
            formData.append(input.name, input.value);
          }
        });

        const payload = {};
        for (let [key, value] of formData.entries()) {
          if (payload[key] !== undefined) continue;
          payload[key] = value === 'true' ? true : value === 'false' ? false : value;
        }

        const medications = [];
        for (let i = 1; i <= medRowCounter; i++) {
          const name = form.querySelector(`[name="med_name_${i}"]`)?.value;
          if (name) {
            medications.push({
              name,
              dose: form.querySelector(`[name="med_dose_${i}"]`)?.value || '',
              unit: form.querySelector(`[name="med_unit_${i}"]`)?.value || '',
              route: form.querySelector(`[name="med_route_${i}"]`)?.value || '',
              time: form.querySelector(`[name="med_time_${i}"]`)?.value || '',
              note: form.querySelector(`[name="med_note_${i}"]`)?.value || ''
            });
          }
        }
        payload.medications = medications;

        if (currentEditPayload.photos) {
          payload.photos = currentEditPayload.photos;
        }
        if (currentEditPayload.signature) {
          payload.signature = currentEditPayload.signature;
        }

        await pb.collection('patients').update(currentEditDoc.id, {
          payload: payload
        });

        // Edit-Modal schließen OHNE currentEditDoc zu löschen
        document.getElementById('editModal').classList.remove('show');
        document.getElementById('signModal').classList.add('show');
        initAdminSigCanvas();
        
      } catch(e) {
        showMsg('Fehler beim Speichern: ' + e.message, 'error');
        const btn = document.querySelector('#editModal .btn:not(.btn-secondary)');
        btn.disabled = false;
      }
    };

    let adminSigCanvas, adminSigCtx, adminIsDrawing = false;

    function initAdminSigCanvas() {
      adminSigCanvas = document.getElementById('adminSigCanvas');
      adminSigCtx = adminSigCanvas.getContext('2d');
      const rect = adminSigCanvas.getBoundingClientRect();
      adminSigCanvas.width = rect.width;
      adminSigCanvas.height = rect.height;
      adminSigCtx.lineWidth = 2;
      adminSigCtx.strokeStyle = '#000';
      adminSigCtx.lineCap = 'round';

      adminSigCanvas.addEventListener('mousedown', startAdminDraw);
      adminSigCanvas.addEventListener('mousemove', adminDraw);
      adminSigCanvas.addEventListener('mouseup', stopAdminDraw);
      adminSigCanvas.addEventListener('mouseleave', stopAdminDraw);

      adminSigCanvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousedown', {
          clientX: touch.clientX,
          clientY: touch.clientY
        });
        adminSigCanvas.dispatchEvent(mouseEvent);
      });

      adminSigCanvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousemove', {
          clientX: touch.clientX,
          clientY: touch.clientY
        });
        adminSigCanvas.dispatchEvent(mouseEvent);
      });

      adminSigCanvas.addEventListener('touchend', (e) => {
        e.preventDefault();
        const mouseEvent = new MouseEvent('mouseup', {});
        adminSigCanvas.dispatchEvent(mouseEvent);
      });
    }

    function startAdminDraw(e) {
      adminIsDrawing = true;
      const rect = adminSigCanvas.getBoundingClientRect();
      adminSigCtx.beginPath();
      adminSigCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    }

    function adminDraw(e) {
      if (!adminIsDrawing) return;
      const rect = adminSigCanvas.getBoundingClientRect();
      adminSigCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
      adminSigCtx.stroke();
    }

    function stopAdminDraw() {
      adminIsDrawing = false;
    }

    window.clearAdminSig = () => {
      adminSigCtx.clearRect(0, 0, adminSigCanvas.width, adminSigCanvas.height);
    };

    window.closeSignModal = () => {
      document.getElementById('signModal').classList.remove('show');
    };

    window.archiveWithSignature = async () => {
      try {
        const adminName = document.getElementById('adminName').value.trim();
        if (!adminName) {
          showMsg('Bitte Namen eingeben', 'error');
          return;
        }

        const signatureData = adminSigCanvas.toDataURL('image/png');
        
        await pb.collection('patients').update(currentEditDoc.id, {
          status: 'archiviert',
          admin_name: adminName,
          admin_datum: new Date().toISOString(),
          admin_unterschrift: signatureData
        });

        closeSignModal();
        showMsg('✅ Dokument archiviert!', 'success');
        await loadData();
        
        // JETZT können wir cleanup machen
        currentEditDoc = null;
        currentEditPayload = null;
        
      } catch(e) {
        showMsg('Fehler beim Archivieren: ' + e.message, 'error');
      }
    };

    document.getElementById('addBtn').onclick = () => {
      document.getElementById('nachForm').reset();
      document.getElementById('nachModal').classList.add('show');
      initNachSigCanvas();
    };

    window.closeNachModal = () => {
      document.getElementById('nachModal').classList.remove('show');
    };

    let nachSigCanvas, nachSigCtx, nachIsDrawing = false;

    function initNachSigCanvas() {
      nachSigCanvas = document.getElementById('nachSigCanvas');
      nachSigCtx = nachSigCanvas.getContext('2d');
      const rect = nachSigCanvas.getBoundingClientRect();
      nachSigCanvas.width = rect.width;
      nachSigCanvas.height = rect.height;
      nachSigCtx.lineWidth = 2;
      nachSigCtx.strokeStyle = '#000';
      nachSigCtx.lineCap = 'round';

      nachSigCanvas.addEventListener('mousedown', startNachDraw);
      nachSigCanvas.addEventListener('mousemove', nachDraw);
      nachSigCanvas.addEventListener('mouseup', stopNachDraw);
      nachSigCanvas.addEventListener('mouseleave', stopNachDraw);

      nachSigCanvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousedown', {
          clientX: touch.clientX,
          clientY: touch.clientY
        });
        nachSigCanvas.dispatchEvent(mouseEvent);
      });

      nachSigCanvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousemove', {
          clientX: touch.clientX,
          clientY: touch.clientY
        });
        nachSigCanvas.dispatchEvent(mouseEvent);
      });

      nachSigCanvas.addEventListener('touchend', (e) => {
        e.preventDefault();
        const mouseEvent = new MouseEvent('mouseup', {});
        nachSigCanvas.dispatchEvent(mouseEvent);
      });
    }

    function startNachDraw(e) {
      nachIsDrawing = true;
      const rect = nachSigCanvas.getBoundingClientRect();
      nachSigCtx.beginPath();
      nachSigCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    }

    function nachDraw(e) {
      if (!nachIsDrawing) return;
      const rect = nachSigCanvas.getBoundingClientRect();
      nachSigCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
      nachSigCtx.stroke();
    }

    function stopNachDraw() {
      nachIsDrawing = false;
    }

    window.clearNachSig = () => {
      nachSigCtx.clearRect(0, 0, nachSigCanvas.width, nachSigCanvas.height);
    };

    window.saveNacherfassung = async () => {
      try {
        const form = document.getElementById('nachForm');
        const formData = new FormData(form);
        
        const nacherfassungData = {
          datum_alarmzeit: formData.get('datum_alarmzeit') || null,
          datum_einsatzende: formData.get('datum_einsatzende') || null,
          stichwort: formData.get('stichwort') || '',
          kategorie: formData.get('kategorie') || '',
          einsatznummer_ils: formData.get('einsatznummer_ils') || '',
          meldebild: formData.get('meldebild') || '',
          adresse: formData.get('adresse') || '',
          disponierte_em_fw: formData.get('disponierte_em_fw') || '',
          disponierte_em_rd: formData.get('disponierte_em_rd') || '',
          patienten_daten_erhoben: formData.get('patienten_daten_erhoben') === 'ja',
          patient_name: formData.get('patient_name') || '',
          patient_alter_geburtsdatum: formData.get('patient_alter_geburtsdatum') || '',
          patient_nummer_ils: formData.get('patient_nummer_ils') || '',
          sachverhalt: formData.get('sachverhalt') || '',
          protokollpflichtig: formData.get('protokollpflichtig') === 'ja',
          protokollpflichtig_begruendung: formData.get('protokollpflichtig_begruendung') || '',
          verantwortlicher_unterwiesen: formData.get('verantwortlicher_unterwiesen') === 'ja',
          verantwortlicher_name: formData.get('verantwortlicher_name') || '',
          verantwortlicher_qualifikation: formData.get('verantwortlicher_qualifikation') || '',
          nacherfasst_von_name: formData.get('nacherfasst_von_name') || '',
          nacherfasst_von_qualifikation: formData.get('nacherfasst_von_qualifikation') || '',
          nacherfasst_datum: new Date().toISOString(),
          nacherfasst_unterschrift: nachSigCanvas.toDataURL('image/png'),
          status: 'offen',
          organization_id: currentUser.organization_id
        };

        await pb.collection('patient_docs_nacherfassung').create(nacherfassungData);

        closeNachModal();
        showMsg('✅ Nacherfassung gespeichert!', 'success');
        await loadData();
        
      } catch(e) {
        showMsg('Fehler: ' + e.message, 'error');
      }
    };

    window.archiveNach = async (id) => {
      if (!confirm('Nacherfassung ins Archiv verschieben?')) return;
      try {
        await pb.collection('patient_docs_nacherfassung').update(id, {
          status: 'archiviert'
        });
        
        showMsg('✅ Nacherfassung archiviert!', 'success');
        await loadData();
      } catch(e) {
        showMsg('Fehler: ' + e.message, 'error');
      }
    };

    window.viewNach = async (id) => {
      try {
        const doc = await pb.collection('patient_docs_nacherfassung').getOne(id);
        
        window.currentViewedNachData = doc;
        window.currentViewedDocType = 'nacherfassung';
        
        document.getElementById('detailsTitle').textContent = 'Nacherfassung: ' + (doc.stichwort || '?');
        
        let html = '<div class="details-grid">';
        html += `<div class="details-label">Alarmzeit:</div><div class="details-value">${doc.datum_alarmzeit ? new Date(doc.datum_alarmzeit).toLocaleString('de-DE') : '-'}</div>`;
        html += `<div class="details-label">Einsatzende:</div><div class="details-value">${doc.datum_einsatzende ? new Date(doc.datum_einsatzende).toLocaleString('de-DE') : '-'}</div>`;
        html += `<div class="details-label">Stichwort:</div><div class="details-value">${doc.stichwort || '-'}</div>`;
        html += `<div class="details-label">Kategorie:</div><div class="details-value">${doc.kategorie || '-'}</div>`;
        html += `<div class="details-label">Einsatznummer ILS:</div><div class="details-value">${doc.einsatznummer_ils || '-'}</div>`;
        html += `<div class="details-label">Meldebild:</div><div class="details-value">${doc.meldebild || '-'}</div>`;
        html += `<div class="details-label">Adresse:</div><div class="details-value">${doc.adresse || '-'}</div>`;
        html += `<div class="details-label">Disponierte EM (FW):</div><div class="details-value">${doc.disponierte_em_fw || '-'}</div>`;
        html += `<div class="details-label">Disponierte EM (RD):</div><div class="details-value">${doc.disponierte_em_rd || '-'}</div>`;
        html += `<div class="details-label">Patienten-Daten erhoben:</div><div class="details-value">${doc.patienten_daten_erhoben ? 'Ja' : 'Nein'}</div>`;
        
        if (doc.patienten_daten_erhoben) {
          html += `<div class="details-label">Patient Name:</div><div class="details-value">${doc.patient_name || '-'}</div>`;
          html += `<div class="details-label">Alter/Geburtsdatum:</div><div class="details-value">${doc.patient_alter_geburtsdatum || '-'}</div>`;
          html += `<div class="details-label">Pat.-Nummer ILS:</div><div class="details-value">${doc.patient_nummer_ils || '-'}</div>`;
        }
        
        html += `<div class="details-label">Sachverhalt:</div><div class="details-value">${doc.sachverhalt || '-'}</div>`;
        html += `<div class="details-label">Protokollpflichtig:</div><div class="details-value">${doc.protokollpflichtig ? 'Ja' : 'Nein'}</div>`;
        
        if (doc.protokollpflichtig) {
          html += `<div class="details-label">Begründung:</div><div class="details-value">${doc.protokollpflichtig_begruendung || '-'}</div>`;
        }
        
        html += `<div class="details-label">Verantwortlicher unterwiesen:</div><div class="details-value">${doc.verantwortlicher_unterwiesen ? 'Ja' : 'Nein'}</div>`;
        html += `<div class="details-label">Verantwortlicher Name:</div><div class="details-value">${doc.verantwortlicher_name || '-'}</div>`;
        html += `<div class="details-label">Verantwortlicher Qualifikation:</div><div class="details-value">${doc.verantwortlicher_qualifikation || '-'}</div>`;
        html += `<div class="details-label">Nacherfasst von:</div><div class="details-value">${doc.nacherfasst_von_name || '-'} (${doc.nacherfasst_von_qualifikation || '-'})</div>`;
        html += `<div class="details-label">Nacherfasst am:</div><div class="details-value">${doc.nacherfasst_datum ? new Date(doc.nacherfasst_datum).toLocaleString('de-DE') : '-'}</div>`;
        
        if (doc.nacherfasst_unterschrift) {
          html += `<div class="details-label">Unterschrift:</div><div class="details-value"><img src="${doc.nacherfasst_unterschrift}" class="signature-img"></div>`;
        }
        
        html += '</div>';
        
        document.getElementById('detailsBody').innerHTML = html;
        document.getElementById('detailsModal').classList.add('show');
        
      } catch(e) {
        showMsg('Fehler: ' + e.message, 'error');
      }
    };
    window.viewPatArchiv = async (id) => {
      try {
        const doc = await pb.collection('patients').getOne(id);
        
        const p = doc.payload || {};
        
        window.currentViewedPayload = p;
        window.currentViewedAdmin = {
          name: doc.admin_name,
          datum: doc.admin_datum,
          unterschrift: doc.admin_unterschrift
        };
        window.currentViewedDocType = 'patient';
        
        const patName = `${p.vorname || ''} ${p.name || ''}`.trim() || 'Unbekannt';
        document.getElementById('detailsTitle').textContent = 'Patientendokumentation: ' + patName;
        
        let html = '<div class="details-grid">';
        
        // EINSATZDATEN
        html += `<div class="details-label" style="grid-column:1/-1;margin-top:10px;font-size:1.1rem;color:var(--primary);border-bottom:2px solid var(--primary);padding-bottom:4px"><strong>📋 Einsatzdaten</strong></div>`;
        html += `<div class="details-label">Einsatz-Nr:</div><div class="details-value"><strong>${p.einsatz_nr || '-'}</strong></div>`;
        html += `<div class="details-label">Pat./Auftrags-Nr:</div><div class="details-value">${p.auftrags_nr || '-'}</div>`;
        html += `<div class="details-label">Rufname:</div><div class="details-value">${p.rufname || '-'}</div>`;
        html += `<div class="details-label">Fahrzeug:</div><div class="details-value">${p.fahrzeug || '-'}</div>`;
        html += `<div class="details-label">Datum/Uhrzeit:</div><div class="details-value">${p.zeit_einsatz ? new Date(p.zeit_einsatz).toLocaleString('de-DE') : '-'}</div>`;
        html += `<div class="details-label">Einsatz-Art:</div><div class="details-value">${p.einsatz_art || '-'}</div>`;
        
        // PATIENTENDATEN
        html += `<div class="details-label" style="grid-column:1/-1;margin-top:20px;font-size:1.1rem;color:var(--primary);border-bottom:2px solid var(--primary);padding-bottom:4px"><strong>👤 Patientendaten</strong></div>`;
        html += `<div class="details-label">Name:</div><div class="details-value"><strong>${p.name || '-'}</strong></div>`;
        html += `<div class="details-label">Vorname:</div><div class="details-value"><strong>${p.vorname || '-'}</strong></div>`;
        html += `<div class="details-label">Geburtsdatum:</div><div class="details-value">${p.gebdatum ? new Date(p.gebdatum).toLocaleDateString('de-DE') : '-'}</div>`;
        html += `<div class="details-label">Alter:</div><div class="details-value">${p.alter || '-'}</div>`;
        html += `<div class="details-label">Telefon:</div><div class="details-value">${p.telefon || '-'}</div>`;
        html += `<div class="details-label">Mobil:</div><div class="details-value">${p.mobil || '-'}</div>`;
        html += `<div class="details-label">Straße:</div><div class="details-value">${p.strasse || '-'}</div>`;
        html += `<div class="details-label">PLZ, Ort:</div><div class="details-value">${p.plz_ort || '-'}</div>`;
        html += `<div class="details-label">Kasse/Nr:</div><div class="details-value">${p.kasse || '-'}</div>`;
        html += `<div class="details-label">Vers.-Nr:</div><div class="details-value">${p.versnr || '-'}</div>`;
        html += `<div class="details-label">Hausarzt/Tel:</div><div class="details-value">${p.hausarzt || '-'}</div>`;
        html += `<div class="details-label">Angehöriger/Tel:</div><div class="details-value">${p.angehoeriger || '-'}</div>`;
        html += `<div class="details-label">Informationen:</div><div class="details-value">${p.infos || '-'}</div>`;
        
        // NOTFALLGESCHEHEN
        html += `<div class="details-label" style="grid-column:1/-1;margin-top:20px;font-size:1.1rem;color:var(--primary);border-bottom:2px solid var(--primary);padding-bottom:4px"><strong>🚨 Notfallgeschehen / Anamnese</strong></div>`;
        html += `<div class="details-label">Anamnese:</div><div class="details-value">${p.notfallgeschehen || '-'}</div>`;
        
        // NEUROLOGIE
        if (p.neu_zeit || p.neu_unauff || p.pw_r || p.pw_l || p.lr_r || p.lr_l) {
          html += `<div class="details-label" style="grid-column:1/-1;margin-top:20px;font-size:1.1rem;color:var(--primary);border-bottom:2px solid var(--primary);padding-bottom:4px"><strong>🧠 Neurologie</strong></div>`;
          html += `<div class="details-label">Zeitpunkt:</div><div class="details-value">${p.neu_zeit ? new Date(p.neu_zeit).toLocaleString('de-DE') : '-'}</div>`;
          html += `<div class="details-label">Ohne path. Befund:</div><div class="details-value">${p.neu_unauff ? 'Ja' : 'Nein'}</div>`;
          html += `<div class="details-label">Pupillenweite rechts:</div><div class="details-value">${p.pw_r || '-'}${p.pw_r_entrundet ? ' (entrundet)' : ''}</div>`;
          html += `<div class="details-label">Lichtreaktion rechts:</div><div class="details-value">${p.lr_r || '-'}</div>`;
          html += `<div class="details-label">Pupillenweite links:</div><div class="details-value">${p.pw_l || '-'}${p.pw_l_entrundet ? ' (entrundet)' : ''}</div>`;
          html += `<div class="details-label">Lichtreaktion links:</div><div class="details-value">${p.lr_l || '-'}</div>`;
        }
        
        // GCS
        if (p.gcs_e || p.gcs_v || p.gcs_m) {
          const gcsSum = (parseInt(p.gcs_e || 0) + parseInt(p.gcs_v || 0) + parseInt(p.gcs_m || 0)) || '-';
          html += `<div class="details-label" style="grid-column:1/-1;margin-top:20px;font-size:1.1rem;color:var(--primary);border-bottom:2px solid var(--primary);padding-bottom:4px"><strong>👁️ Glasgow Coma Scale</strong></div>`;
          html += `<div class="details-label">GCS:</div><div class="details-value"><strong>E${p.gcs_e || '-'} V${p.gcs_v || '-'} M${p.gcs_m || '-'} = ${gcsSum}</strong></div>`;
        }
        
        // HAUT
        if (p.haut_unauff || p.haut_falten || p.haut_oedeme || p.haut_dekubitus || p.haut_kaltschweissig || p.haut_exanthem) {
          html += `<div class="details-label" style="grid-column:1/-1;margin-top:20px;font-size:1.1rem;color:var(--primary);border-bottom:2px solid var(--primary);padding-bottom:4px"><strong>✋ Haut</strong></div>`;
          let hautBefunde = [];
          if (p.haut_unauff) hautBefunde.push('unauffällig');
          if (p.haut_falten) hautBefunde.push('stehende Hautfalten');
          if (p.haut_oedeme) hautBefunde.push('Ödeme');
          if (p.haut_dekubitus) hautBefunde.push('Dekubitus');
          if (p.haut_kaltschweissig) hautBefunde.push('kaltschweißig');
          if (p.haut_exanthem) hautBefunde.push('Exanthem');
          html += `<div class="details-label">Befunde:</div><div class="details-value">${hautBefunde.join(', ') || '-'}</div>`;
        }
        
        // PSYCHE
        if (p.psy_erregt || p.psy_aggr || p.psy_verlangsamt || p.psy_depressiv || p.psy_aengstlich || p.psy_euphorisch || p.psy_wahnhaft || p.psy_verwirrt || p.psy_suizidal || p.psy_motor_unruhig) {
          html += `<div class="details-label" style="grid-column:1/-1;margin-top:20px;font-size:1.1rem;color:var(--primary);border-bottom:2px solid var(--primary);padding-bottom:4px"><strong>🧘 Psyche</strong></div>`;
          let psycheBefunde = [];
          if (p.psy_erregt) psycheBefunde.push('erregt');
          if (p.psy_aggr) psycheBefunde.push('aggressiv');
          if (p.psy_verlangsamt) psycheBefunde.push('verlangsamt');
          if (p.psy_depressiv) psycheBefunde.push('depressiv');
          if (p.psy_aengstlich) psycheBefunde.push('ängstlich');
          if (p.psy_euphorisch) psycheBefunde.push('euphorisch');
          if (p.psy_wahnhaft) psycheBefunde.push('wahnhaft');
          if (p.psy_verwirrt) psycheBefunde.push('verwirrt');
          if (p.psy_suizidal) psycheBefunde.push('suizidal');
          if (p.psy_motor_unruhig) psycheBefunde.push('motorisch unruhig');
          html += `<div class="details-label">Befunde:</div><div class="details-value">${psycheBefunde.join(', ') || '-'}</div>`;
        }
        
        // VITALPARAMETER
        html += `<div class="details-label" style="grid-column:1/-1;margin-top:20px;font-size:1.1rem;color:var(--primary);border-bottom:2px solid var(--primary);padding-bottom:4px"><strong>🩺 Vitalparameter</strong></div>`;
        html += `<div class="details-label">RR:</div><div class="details-value">${p.rr_sys || '-'}/${p.rr_dia || '-'} mmHg</div>`;
        html += `<div class="details-label">HF:</div><div class="details-value">${p.hf || '-'} /min</div>`;
        html += `<div class="details-label">AF:</div><div class="details-value">${p.af || '-'} /min</div>`;
        html += `<div class="details-label">SpO₂:</div><div class="details-value">${p.spo2 || '-'} %</div>`;
        html += `<div class="details-label">etCO₂:</div><div class="details-value">${p.etco2 || '-'} mmHg</div>`;
        html += `<div class="details-label">Temperatur:</div><div class="details-value">${p.temp || '-'} °C</div>`;
        html += `<div class="details-label">BZ:</div><div class="details-value">${p.bz_mg || '-'} mg/dl (${p.bz_mmol || '-'} mmol/l)</div>`;
        html += `<div class="details-label">Schmerz:</div><div class="details-value">${p.schmerz || '-'} /10</div>`;
        
        // qSOFA
        const qsofa = calculateQSOFA(p);
        if (qsofa !== '—') {
          html += `<div class="details-label">qSOFA-Score:</div><div class="details-value"><strong>${qsofa}</strong></div>`;
        }
        
        // ATMUNG
        if (p.atm_apnoe || p.atm_stridor || p.atm_hypervent || p.atm_dyspnoe || p.atm_beatmung || p.atm_zyanose || p.atm_verlegung || p.atm_sonst) {
          html += `<div class="details-label" style="grid-column:1/-1;margin-top:20px;font-size:1.1rem;color:var(--primary);border-bottom:2px solid var(--primary);padding-bottom:4px"><strong>🫁 Atmung</strong></div>`;
          let atmungBefunde = [];
          if (p.atm_apnoe) atmungBefunde.push('Apnoe');
          if (p.atm_stridor) atmungBefunde.push('Stridor');
          if (p.atm_hypervent) atmungBefunde.push('Hyperventilation');
          if (p.atm_dyspnoe) atmungBefunde.push('Dyspnoe');
          if (p.atm_beatmung) atmungBefunde.push('Beatmung');
          if (p.atm_zyanose) atmungBefunde.push('Zyanose');
          if (p.atm_verlegung) atmungBefunde.push('Atemwegsverlegung');
          html += `<div class="details-label">Klinische Zeichen:</div><div class="details-value">${atmungBefunde.join(', ') || '-'}</div>`;
          if (p.atm_sonst) {
            html += `<div class="details-label">Sonstiges:</div><div class="details-value">${p.atm_sonst}</div>`;
          }
        }
        
        // O2-GABE
        if (p.o2 || p.o2_flow) {
          html += `<div class="details-label">O₂-Gabe:</div><div class="details-value">${p.o2 || '-'}${p.o2_nasal ? ', Nasensonde' : ''}${p.o2_maske ? ', Maske' : ''}${p.o2_reservoir ? ', Maske m. Reservoir' : ''}${p.o2_flow ? `, ${p.o2_flow} l/min` : ''}${p.o2_comment ? ` (${p.o2_comment})` : ''}</div>`;
        }
        
        // EKG/RHYTHMUS
        if (p.sr || p.stemi || p.arrh_abs || p.vf || p.av3 || p.asystole || p.ekg_standort || p.ekg_persnr) {
          html += `<div class="details-label" style="grid-column:1/-1;margin-top:20px;font-size:1.1rem;color:var(--primary);border-bottom:2px solid var(--primary);padding-bottom:4px"><strong>❤️ EKG / Rhythmus</strong></div>`;
          let ekgBefunde = [];
          if (p.sr) ekgBefunde.push('Sinusrhythmus');
          if (p.stemi) ekgBefunde.push('STEMI');
          if (p.arrh_abs) ekgBefunde.push('absolute Arrhythmie');
          if (p.vf) ekgBefunde.push('Kammerflimmern');
          if (p.av3) ekgBefunde.push('AV-Block III°');
          if (p.asystole) ekgBefunde.push('Asystolie');
          html += `<div class="details-label">Befunde:</div><div class="details-value">${ekgBefunde.join(', ') || '-'}</div>`;
          if (p.ekg_standort) html += `<div class="details-label">EKG-Standort:</div><div class="details-value">${p.ekg_standort}</div>`;
          if (p.ekg_persnr) html += `<div class="details-label">Pers-Nr:</div><div class="details-value">${p.ekg_persnr}</div>`;
        }
        
        // VERLETZUNGEN
        if (p.verletz_text) {
          html += `<div class="details-label" style="grid-column:1/-1;margin-top:20px;font-size:1.1rem;color:var(--primary);border-bottom:2px solid var(--primary);padding-bottom:4px"><strong>🩹 Verletzungen</strong></div>`;
          html += `<div class="details-label">Beschreibung:</div><div class="details-value">${p.verletz_text}</div>`;
        }
        
        // DIAGNOSEN
        if (p.diag_krampf || p.diag_synkope || p.diag_apoplex || p.diag_sht || p.diag_acs || p.diag_insuff || p.diag_lungenoedem || p.diag_luembol || p.diag_resp_insuff || p.diag_pneumothorax || p.diag_asthma || p.diag_hypo || p.diag_sept || p.diag_hypovol) {
          html += `<div class="details-label" style="grid-column:1/-1;margin-top:20px;font-size:1.1rem;color:var(--primary);border-bottom:2px solid var(--primary);padding-bottom:4px"><strong>📋 Erstdiagnosen</strong></div>`;
          let diagnosen = [];
          if (p.diag_krampf) diagnosen.push('Konvulsionen');
          if (p.diag_synkope) diagnosen.push('Synkope');
          if (p.diag_apoplex) diagnosen.push('Apoplex');
          if (p.diag_sht) diagnosen.push('SHT');
          if (p.diag_acs) diagnosen.push('ACS');
          if (p.diag_insuff) diagnosen.push('Herzinsuffizienz');
          if (p.diag_lungenoedem) diagnosen.push('Lungenödem');
          if (p.diag_luembol) diagnosen.push('Lungenembolie');
          if (p.diag_resp_insuff) diagnosen.push('resp. Insuffizienz');
          if (p.diag_pneumothorax) diagnosen.push('Pneumothorax');
          if (p.diag_asthma) diagnosen.push('Asthma/COPD');
          if (p.diag_hypo) diagnosen.push('Hypoglykämie');
          if (p.diag_sept) diagnosen.push('septischer Schock');
          if (p.diag_hypovol) diagnosen.push('hypovolämischer Schock');
          html += `<div class="details-label">Diagnosen:</div><div class="details-value">${diagnosen.join(', ')}</div>`;
        }
        
        // BEWUSSTSEIN/AZ/VERSORGUNG
        if (p.bew_wach || p.bew_ansprache || p.bew_schmerz || p.bew_bewusstlos || p.az || p.versorgung) {
          html += `<div class="details-label" style="grid-column:1/-1;margin-top:20px;font-size:1.1rem;color:var(--primary);border-bottom:2px solid var(--primary);padding-bottom:4px"><strong>🧑‍⚕️ Bewusstsein / AZ / Versorgung</strong></div>`;
          let bewusstsein = [];
          if (p.bew_wach) bewusstsein.push('wach');
          if (p.bew_ansprache) bewusstsein.push('Reaktion auf Ansprache');
          if (p.bew_schmerz) bewusstsein.push('Reaktion auf Schmerzreiz');
          if (p.bew_bewusstlos) bewusstsein.push('bewusstlos');
          if (bewusstsein.length > 0) html += `<div class="details-label">Bewusstseinslage:</div><div class="details-value">${bewusstsein.join(', ')}</div>`;
          if (p.az) html += `<div class="details-label">Allgemeinzustand:</div><div class="details-value">${p.az}</div>`;
          if (p.versorgung) html += `<div class="details-label">Versorgungssituation:</div><div class="details-value">${p.versorgung}</div>`;
        }
        
        // ZUGANG/INFUSION
        if (p.zugang_art || p.inf_art) {
          html += `<div class="details-label" style="grid-column:1/-1;margin-top:20px;font-size:1.1rem;color:var(--primary);border-bottom:2px solid var(--primary);padding-bottom:4px"><strong>💉 Zugang & Infusion</strong></div>`;
          if (p.zugang_art) {
            html += `<div class="details-label">Zugang:</div><div class="details-value">${p.zugang_art}${p.zugang_region ? ', ' + p.zugang_region : ''}${p.zugang_gauge ? ', ' + p.zugang_gauge + 'G' : ''}${p.zugang_versuche ? ', ' + p.zugang_versuche + ' Versuche' : ''}${p.zugang_zeit ? ', ' + new Date(p.zugang_zeit).toLocaleString('de-DE') : ''}</div>`;
          }
          if (p.inf_art) {
            html += `<div class="details-label">Infusion:</div><div class="details-value">${p.inf_art}${p.inf_menge ? ', ' + p.inf_menge + ' ml' : ''}${p.inf_rate ? ', ' + p.inf_rate + ' ml/h' : ''}${p.inf_bem ? ' (' + p.inf_bem + ')' : ''}</div>`;
          }
        }
        
        // MEDIKATION
        if (p.medications && p.medications.length > 0) {
          html += `<div class="details-label" style="grid-column:1/-1;margin-top:20px;font-size:1.1rem;color:var(--primary);border-bottom:2px solid var(--primary);padding-bottom:4px"><strong>💊 Medikation</strong></div>`;
          html += `<div class="details-label">Medikamente:</div><div class="details-value">`;
          p.medications.forEach(med => {
            html += `<strong>${med.name}</strong> ${med.dose} ${med.unit} (${med.route}) um ${med.time}${med.note ? ' - ' + med.note : ''}<br>`;
          });
          html += `</div>`;
        }
        
        // BEATMUNG/ATEMWEG
        if (p.aw_guedel || p.aw_larynxtubus || p.aw_ett || p.aw_bvm || p.aw_ett_size || p.vent_peep || p.vent_fio2) {
          html += `<div class="details-label" style="grid-column:1/-1;margin-top:20px;font-size:1.1rem;color:var(--primary);border-bottom:2px solid var(--primary);padding-bottom:4px"><strong>🌬️ Beatmung / Atemweg</strong></div>`;
          let atemweg = [];
          if (p.aw_guedel) atemweg.push('Guedel');
          if (p.aw_larynxtubus) atemweg.push('Larynxtubus');
          if (p.aw_ett) atemweg.push('ETT');
          if (p.aw_bvm) atemweg.push('BVM');
          html += `<div class="details-label">Atemweg:</div><div class="details-value">${atemweg.join(', ') || '-'}</div>`;
          if (p.aw_ett_size) html += `<div class="details-label">ETT-Größe:</div><div class="details-value">${p.aw_ett_size}</div>`;
          if (p.vent_peep) html += `<div class="details-label">PEEP:</div><div class="details-value">${p.vent_peep} cmH₂O</div>`;
          if (p.vent_fio2) html += `<div class="details-label">FiO₂:</div><div class="details-value">${p.vent_fio2} %</div>`;
        }
        
        // REANIMATION
        if (p.rea_beginn || p.rea_initial || p.rea_shocks || p.rea_rosc || p.rea_ende) {
          html += `<div class="details-label" style="grid-column:1/-1;margin-top:20px;font-size:1.1rem;color:var(--primary);border-bottom:2px solid var(--primary);padding-bottom:4px"><strong>⚡ Reanimation</strong></div>`;
          if (p.rea_beginn) html += `<div class="details-label">Rea-Beginn:</div><div class="details-value">${new Date(p.rea_beginn).toLocaleString('de-DE')}</div>`;
          if (p.rea_initial) html += `<div class="details-label">Erst-Rhythmus:</div><div class="details-value">${p.rea_initial}</div>`;
          if (p.rea_shocks) html += `<div class="details-label">Schocks:</div><div class="details-value">${p.rea_shocks}</div>`;
          if (p.rea_rosc) html += `<div class="details-label">ROSC:</div><div class="details-value">${p.rea_rosc}</div>`;
          if (p.rea_ende) html += `<div class="details-label">Rea-Ende:</div><div class="details-value">${p.rea_ende}</div>`;
        }
        
        // ÜBERGABE/TRANSPORT
        html += `<div class="details-label" style="grid-column:1/-1;margin-top:20px;font-size:1.1rem;color:var(--primary);border-bottom:2px solid var(--primary);padding-bottom:4px"><strong>🚑 Übergabe / Transport</strong></div>`;
        html += `<div class="details-label">Übergabe an:</div><div class="details-value">${p.ue_name || '-'}</div>`;
        html += `<div class="details-label">Übergabe Zeit:</div><div class="details-value">${p.ue_zeit ? new Date(p.ue_zeit).toLocaleString('de-DE') : '-'}</div>`;
        html += `<div class="details-label">Ziel:</div><div class="details-value">${p.ziel_bez || '-'}</div>`;
        html += `<div class="details-label">Ziel-Adresse:</div><div class="details-value">${p.ziel_adr || '-'}</div>`;
        html += `<div class="details-label">Einsatzende:</div><div class="details-value">${p.einsatzende ? new Date(p.einsatzende).toLocaleString('de-DE') : '-'}</div>`;
        
        // AUSFÜLLER
        html += `<div class="details-label" style="grid-column:1/-1;margin-top:20px;font-size:1.1rem;color:var(--primary);border-bottom:2px solid var(--primary);padding-bottom:4px"><strong>✍️ Ausfüller</strong></div>`;
        html += `<div class="details-label">Ausfüller:</div><div class="details-value">${p.ausfueller_name || '-'}</div>`;
        html += `<div class="details-label">Zeitpunkt:</div><div class="details-value">${p.ausfueller_zeit ? new Date(p.ausfueller_zeit).toLocaleString('de-DE') : '-'}</div>`;
        
        if (p.signature) {
          html += `<div class="details-label">Unterschrift Ausfüller:</div><div class="details-value"><img src="${p.signature}" class="signature-img"></div>`;
        }
        
        // MPG-BEAUFTRAGTER
        html += `<div class="details-label" style="grid-column:1/-1;margin-top:20px;font-size:1.1rem;color:var(--primary);border-bottom:2px solid var(--primary);padding-bottom:4px"><strong>✅ MPG-Beauftragter / Verantwortlicher</strong></div>`;
        html += `<div class="details-label">Name:</div><div class="details-value"><strong>${doc.admin_name || '-'}</strong></div>`;
        html += `<div class="details-label">Gegengezeichnet am:</div><div class="details-value">${doc.admin_datum ? new Date(doc.admin_datum).toLocaleString('de-DE') : '-'}</div>`;
        
        if (doc.admin_unterschrift) {
          html += `<div class="details-label">Unterschrift:</div><div class="details-value"><img src="${doc.admin_unterschrift}" class="signature-img"></div>`;
        }
        
        html += '</div>';
        
        document.getElementById('detailsBody').innerHTML = html;
        document.getElementById('detailsModal').classList.add('show');
        
      } catch(e) {
        showMsg('Fehler: ' + e.message, 'error');
      }
    };

    window.viewNachArchiv = async (id) => {
      await viewNach(id);
    };

    window.closeDetailsModal = () => {
      document.getElementById('detailsModal').classList.remove('show');
    };
    window.generatePDFFromModal = async () => {
      try {
        showMsg('PDF wird erstellt...', 'success');
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        let yPos = 20;
        const lineHeight = 7;
        const pageHeight = doc.internal.pageSize.height;
        const margin = 20;
        
        // Hilfsfunktion für Seitenumbruch
        const checkPageBreak = () => {
          if (yPos > pageHeight - 30) {
            doc.addPage();
            yPos = 20;
          }
        };
        
        // Hilfsfunktion für Überschriften
        const addHeading = (text) => {
          checkPageBreak();
          doc.setFontSize(14);
          doc.setFont(undefined, 'bold');
          doc.setTextColor(200, 16, 46);
          doc.text(text, margin, yPos);
          yPos += lineHeight + 2;
          doc.setFont(undefined, 'normal');
          doc.setFontSize(10);
          doc.setTextColor(0, 0, 0);
        };
        
        // Hilfsfunktion für Datenzeilen
        const addDataRow = (label, value) => {
          checkPageBreak();
          doc.setFont(undefined, 'bold');
          doc.text(label + ':', margin, yPos);
          doc.setFont(undefined, 'normal');
          const labelWidth = doc.getTextWidth(label + ': ');
          const maxWidth = 170 - labelWidth;
          const lines = doc.splitTextToSize(value || '-', maxWidth);
          doc.text(lines, margin + labelWidth, yPos);
          yPos += lineHeight * lines.length;
        };
        
        // Header
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(200, 16, 46);
        
        if (window.currentViewedDocType === 'patient') {
          // PATIENTENDOKUMENTATION PDF
          const p = window.currentViewedPayload;
          const admin = window.currentViewedAdmin;
          
          const patName = `${p.vorname || ''} ${p.name || ''}`.trim() || 'Unbekannt';
          doc.text('Patientendokumentation', margin, yPos);
          yPos += 10;
          
          doc.setFontSize(12);
          doc.text(patName, margin, yPos);
          yPos += 10;
          
          doc.setFontSize(10);
          doc.setFont(undefined, 'normal');
          doc.setTextColor(0, 0, 0);
          
          // EINSATZDATEN
          addHeading('Einsatzdaten');
          addDataRow('Einsatz-Nr', p.einsatz_nr);
          addDataRow('Pat./Auftrags-Nr', p.auftrags_nr);
          addDataRow('Rufname', p.rufname);
          addDataRow('Fahrzeug', p.fahrzeug);
          addDataRow('Datum/Uhrzeit', p.zeit_einsatz ? new Date(p.zeit_einsatz).toLocaleString('de-DE') : '-');
          addDataRow('Einsatz-Art', p.einsatz_art);
          yPos += 3;
          
          // PATIENTENDATEN
          addHeading('Patientendaten');
          addDataRow('Name', p.name);
          addDataRow('Vorname', p.vorname);
          addDataRow('Geburtsdatum', p.gebdatum ? new Date(p.gebdatum).toLocaleDateString('de-DE') : '-');
          addDataRow('Alter', p.alter);
          addDataRow('Telefon', p.telefon);
          addDataRow('Mobil', p.mobil);
          addDataRow('Straße', p.strasse);
          addDataRow('PLZ, Ort', p.plz_ort);
          addDataRow('Kasse/Nr', p.kasse);
          addDataRow('Vers.-Nr', p.versnr);
          addDataRow('Hausarzt/Tel', p.hausarzt);
          addDataRow('Angehöriger/Tel', p.angehoeriger);
          addDataRow('Informationen', p.infos);
          yPos += 3;
          
          // NOTFALLGESCHEHEN
          addHeading('Notfallgeschehen / Anamnese');
          addDataRow('Anamnese', p.notfallgeschehen);
          yPos += 3;
          
          // NEUROLOGIE
          if (p.neu_zeit || p.neu_unauff || p.pw_r || p.pw_l) {
            addHeading('Neurologie');
            addDataRow('Zeitpunkt', p.neu_zeit ? new Date(p.neu_zeit).toLocaleString('de-DE') : '-');
            addDataRow('Ohne path. Befund', p.neu_unauff ? 'Ja' : 'Nein');
            addDataRow('Pupillenweite rechts', (p.pw_r || '-') + (p.pw_r_entrundet ? ' (entrundet)' : ''));
            addDataRow('Lichtreaktion rechts', p.lr_r);
            addDataRow('Pupillenweite links', (p.pw_l || '-') + (p.pw_l_entrundet ? ' (entrundet)' : ''));
            addDataRow('Lichtreaktion links', p.lr_l);
            yPos += 3;
          }
          
          // GCS
          if (p.gcs_e || p.gcs_v || p.gcs_m) {
            const gcsSum = (parseInt(p.gcs_e || 0) + parseInt(p.gcs_v || 0) + parseInt(p.gcs_m || 0)) || '-';
            addHeading('Glasgow Coma Scale');
            addDataRow('GCS', `E${p.gcs_e || '-'} V${p.gcs_v || '-'} M${p.gcs_m || '-'} = ${gcsSum}`);
            yPos += 3;
          }
          
          // HAUT
          if (p.haut_unauff || p.haut_falten || p.haut_oedeme || p.haut_dekubitus || p.haut_kaltschweissig || p.haut_exanthem) {
            let hautBefunde = [];
            if (p.haut_unauff) hautBefunde.push('unauffällig');
            if (p.haut_falten) hautBefunde.push('stehende Hautfalten');
            if (p.haut_oedeme) hautBefunde.push('Ödeme');
            if (p.haut_dekubitus) hautBefunde.push('Dekubitus');
            if (p.haut_kaltschweissig) hautBefunde.push('kaltschweißig');
            if (p.haut_exanthem) hautBefunde.push('Exanthem');
            addHeading('Haut');
            addDataRow('Befunde', hautBefunde.join(', '));
            yPos += 3;
          }
          
          // PSYCHE
          if (p.psy_erregt || p.psy_aggr || p.psy_verlangsamt || p.psy_depressiv || p.psy_aengstlich || p.psy_euphorisch || p.psy_wahnhaft || p.psy_verwirrt || p.psy_suizidal || p.psy_motor_unruhig) {
            let psycheBefunde = [];
            if (p.psy_erregt) psycheBefunde.push('erregt');
            if (p.psy_aggr) psycheBefunde.push('aggressiv');
            if (p.psy_verlangsamt) psycheBefunde.push('verlangsamt');
            if (p.psy_depressiv) psycheBefunde.push('depressiv');
            if (p.psy_aengstlich) psycheBefunde.push('ängstlich');
            if (p.psy_euphorisch) psycheBefunde.push('euphorisch');
            if (p.psy_wahnhaft) psycheBefunde.push('wahnhaft');
            if (p.psy_verwirrt) psycheBefunde.push('verwirrt');
            if (p.psy_suizidal) psycheBefunde.push('suizidal');
            if (p.psy_motor_unruhig) psycheBefunde.push('motorisch unruhig');
            addHeading('Psyche');
            addDataRow('Befunde', psycheBefunde.join(', '));
            yPos += 3;
          }
          
          // VITALPARAMETER
          addHeading('Vitalparameter');
          addDataRow('RR', `${p.rr_sys || '-'}/${p.rr_dia || '-'} mmHg`);
          addDataRow('HF', `${p.hf || '-'} /min`);
          addDataRow('AF', `${p.af || '-'} /min`);
          addDataRow('SpO₂', `${p.spo2 || '-'} %`);
          addDataRow('etCO₂', `${p.etco2 || '-'} mmHg`);
          addDataRow('Temperatur', `${p.temp || '-'} °C`);
          addDataRow('BZ', `${p.bz_mg || '-'} mg/dl (${p.bz_mmol || '-'} mmol/l)`);
          addDataRow('Schmerz', `${p.schmerz || '-'} /10`);
          const qsofa = calculateQSOFA(p);
          if (qsofa !== '—') {
            addDataRow('qSOFA-Score', qsofa.toString());
          }
          yPos += 3;
          
          // ATMUNG
          if (p.atm_apnoe || p.atm_stridor || p.atm_hypervent || p.atm_dyspnoe || p.atm_beatmung || p.atm_zyanose || p.atm_verlegung || p.atm_sonst) {
            let atmungBefunde = [];
            if (p.atm_apnoe) atmungBefunde.push('Apnoe');
            if (p.atm_stridor) atmungBefunde.push('Stridor');
            if (p.atm_hypervent) atmungBefunde.push('Hyperventilation');
            if (p.atm_dyspnoe) atmungBefunde.push('Dyspnoe');
            if (p.atm_beatmung) atmungBefunde.push('Beatmung');
            if (p.atm_zyanose) atmungBefunde.push('Zyanose');
            if (p.atm_verlegung) atmungBefunde.push('Atemwegsverlegung');
            addHeading('Atmung');
            addDataRow('Klinische Zeichen', atmungBefunde.join(', '));
            if (p.atm_sonst) addDataRow('Sonstiges', p.atm_sonst);
            yPos += 3;
          }
          
          // O2-GABE
          if (p.o2 || p.o2_flow) {
            let o2Text = p.o2 || '-';
            if (p.o2_nasal) o2Text += ', Nasensonde';
            if (p.o2_maske) o2Text += ', Maske';
            if (p.o2_reservoir) o2Text += ', Maske m. Reservoir';
            if (p.o2_flow) o2Text += `, ${p.o2_flow} l/min`;
            if (p.o2_comment) o2Text += ` (${p.o2_comment})`;
            addDataRow('O₂-Gabe', o2Text);
            yPos += 3;
          }
          
          // EKG/RHYTHMUS
          if (p.sr || p.stemi || p.arrh_abs || p.vf || p.av3 || p.asystole || p.ekg_standort || p.ekg_persnr) {
            let ekgBefunde = [];
            if (p.sr) ekgBefunde.push('Sinusrhythmus');
            if (p.stemi) ekgBefunde.push('STEMI');
            if (p.arrh_abs) ekgBefunde.push('absolute Arrhythmie');
            if (p.vf) ekgBefunde.push('Kammerflimmern');
            if (p.av3) ekgBefunde.push('AV-Block III°');
            if (p.asystole) ekgBefunde.push('Asystolie');
            addHeading('EKG / Rhythmus');
            addDataRow('Befunde', ekgBefunde.join(', '));
            if (p.ekg_standort) addDataRow('EKG-Standort', p.ekg_standort);
            if (p.ekg_persnr) addDataRow('Pers-Nr', p.ekg_persnr);
            yPos += 3;
          }
          
          // VERLETZUNGEN
          if (p.verletz_text) {
            addHeading('Verletzungen');
            addDataRow('Beschreibung', p.verletz_text);
            yPos += 3;
          }
          
          // DIAGNOSEN
          if (p.diag_krampf || p.diag_synkope || p.diag_apoplex || p.diag_sht || p.diag_acs || p.diag_insuff || p.diag_lungenoedem || p.diag_luembol || p.diag_resp_insuff || p.diag_pneumothorax || p.diag_asthma || p.diag_hypo || p.diag_sept || p.diag_hypovol) {
            let diagnosen = [];
            if (p.diag_krampf) diagnosen.push('Konvulsionen');
            if (p.diag_synkope) diagnosen.push('Synkope');
            if (p.diag_apoplex) diagnosen.push('Apoplex');
            if (p.diag_sht) diagnosen.push('SHT');
            if (p.diag_acs) diagnosen.push('ACS');
            if (p.diag_insuff) diagnosen.push('Herzinsuffizienz');
            if (p.diag_lungenoedem) diagnosen.push('Lungenödem');
            if (p.diag_luembol) diagnosen.push('Lungenembolie');
            if (p.diag_resp_insuff) diagnosen.push('resp. Insuffizienz');
            if (p.diag_pneumothorax) diagnosen.push('Pneumothorax');
            if (p.diag_asthma) diagnosen.push('Asthma/COPD');
            if (p.diag_hypo) diagnosen.push('Hypoglykämie');
            if (p.diag_sept) diagnosen.push('septischer Schock');
            if (p.diag_hypovol) diagnosen.push('hypovolämischer Schock');
            addHeading('Erstdiagnosen');
            addDataRow('Diagnosen', diagnosen.join(', '));
            yPos += 3;
          }
          
          // BEWUSSTSEIN/AZ/VERSORGUNG
          if (p.bew_wach || p.bew_ansprache || p.bew_schmerz || p.bew_bewusstlos || p.az || p.versorgung) {
            addHeading('Bewusstsein / AZ / Versorgung');
            let bewusstsein = [];
            if (p.bew_wach) bewusstsein.push('wach');
            if (p.bew_ansprache) bewusstsein.push('Reaktion auf Ansprache');
            if (p.bew_schmerz) bewusstsein.push('Reaktion auf Schmerzreiz');
            if (p.bew_bewusstlos) bewusstsein.push('bewusstlos');
            if (bewusstsein.length > 0) addDataRow('Bewusstseinslage', bewusstsein.join(', '));
            if (p.az) addDataRow('Allgemeinzustand', p.az);
            if (p.versorgung) addDataRow('Versorgungssituation', p.versorgung);
            yPos += 3;
          }
          
          // ZUGANG/INFUSION
          if (p.zugang_art || p.inf_art) {
            addHeading('Zugang & Infusion');
            if (p.zugang_art) {
              let zugangText = p.zugang_art;
              if (p.zugang_region) zugangText += ', ' + p.zugang_region;
              if (p.zugang_gauge) zugangText += ', ' + p.zugang_gauge + 'G';
              if (p.zugang_versuche) zugangText += ', ' + p.zugang_versuche + ' Versuche';
              if (p.zugang_zeit) zugangText += ', ' + new Date(p.zugang_zeit).toLocaleString('de-DE');
              addDataRow('Zugang', zugangText);
            }
            if (p.inf_art) {
              let infText = p.inf_art;
              if (p.inf_menge) infText += ', ' + p.inf_menge + ' ml';
              if (p.inf_rate) infText += ', ' + p.inf_rate + ' ml/h';
              if (p.inf_bem) infText += ' (' + p.inf_bem + ')';
              addDataRow('Infusion', infText);
            }
            yPos += 3;
          }
          
          // MEDIKATION
          if (p.medications && p.medications.length > 0) {
            addHeading('Medikation');
            p.medications.forEach((med, idx) => {
              const medText = `${med.name} ${med.dose} ${med.unit} (${med.route}) um ${med.time}${med.note ? ' - ' + med.note : ''}`;
              addDataRow(`Med ${idx + 1}`, medText);
            });
            yPos += 3;
          }
          
          // BEATMUNG/ATEMWEG
          if (p.aw_guedel || p.aw_larynxtubus || p.aw_ett || p.aw_bvm || p.aw_ett_size || p.vent_peep || p.vent_fio2) {
            let atemweg = [];
            if (p.aw_guedel) atemweg.push('Guedel');
            if (p.aw_larynxtubus) atemweg.push('Larynxtubus');
            if (p.aw_ett) atemweg.push('ETT');
            if (p.aw_bvm) atemweg.push('BVM');
            addHeading('Beatmung / Atemweg');
            addDataRow('Atemweg', atemweg.join(', '));
            if (p.aw_ett_size) addDataRow('ETT-Größe', p.aw_ett_size);
            if (p.vent_peep) addDataRow('PEEP', p.vent_peep + ' cmH₂O');
            if (p.vent_fio2) addDataRow('FiO₂', p.vent_fio2 + ' %');
            yPos += 3;
          }
          
          // REANIMATION
          if (p.rea_beginn || p.rea_initial || p.rea_shocks || p.rea_rosc || p.rea_ende) {
            addHeading('Reanimation');
            if (p.rea_beginn) addDataRow('Rea-Beginn', new Date(p.rea_beginn).toLocaleString('de-DE'));
            if (p.rea_initial) addDataRow('Erst-Rhythmus', p.rea_initial);
            if (p.rea_shocks) addDataRow('Schocks', p.rea_shocks);
            if (p.rea_rosc) addDataRow('ROSC', p.rea_rosc);
            if (p.rea_ende) addDataRow('Rea-Ende', p.rea_ende);
            yPos += 3;
          }
          
          // ÜBERGABE/TRANSPORT
          addHeading('Übergabe / Transport');
          addDataRow('Übergabe an', p.ue_name);
          addDataRow('Übergabe Zeit', p.ue_zeit ? new Date(p.ue_zeit).toLocaleString('de-DE') : '-');
          addDataRow('Ziel', p.ziel_bez);
          addDataRow('Ziel-Adresse', p.ziel_adr);
          addDataRow('Einsatzende', p.einsatzende ? new Date(p.einsatzende).toLocaleString('de-DE') : '-');
          yPos += 3;
          
          // AUSFÜLLER
          addHeading('Ausfüller');
          addDataRow('Ausfüller', p.ausfueller_name);
          addDataRow('Zeitpunkt', p.ausfueller_zeit ? new Date(p.ausfueller_zeit).toLocaleString('de-DE') : '-');
          yPos += 3;
          
          // MPG-BEAUFTRAGTER
          addHeading('MPG-Beauftragter / Verantwortlicher');
          addDataRow('Name', admin.name);
          addDataRow('Gegengezeichnet am', admin.datum ? new Date(admin.datum).toLocaleString('de-DE') : '-');
          
        } else if (window.currentViewedDocType === 'nacherfassung') {
          // NACHERFASSUNG PDF
          const n = window.currentViewedNachData;
          
          doc.text('Einsatznacherfassung', margin, yPos);
          yPos += 10;
          
          doc.setFontSize(12);
          doc.text(n.stichwort || 'Ohne Stichwort', margin, yPos);
          yPos += 10;
          
          doc.setFontSize(10);
          doc.setFont(undefined, 'normal');
          doc.setTextColor(0, 0, 0);
          
          addHeading('Einsatzdaten');
          addDataRow('Alarmzeit', n.datum_alarmzeit ? new Date(n.datum_alarmzeit).toLocaleString('de-DE') : '-');
          addDataRow('Einsatzende', n.datum_einsatzende ? new Date(n.datum_einsatzende).toLocaleString('de-DE') : '-');
          addDataRow('Stichwort', n.stichwort);
          addDataRow('Kategorie', n.kategorie);
          addDataRow('Einsatznummer ILS', n.einsatznummer_ils);
          addDataRow('Meldebild', n.meldebild);
          addDataRow('Adresse', n.adresse);
          addDataRow('Disponierte EM (FW)', n.disponierte_em_fw);
          addDataRow('Disponierte EM (RD)', n.disponierte_em_rd);
          yPos += 3;
          
          addHeading('Patienten-Daten');
          addDataRow('Daten erhoben', n.patienten_daten_erhoben ? 'Ja' : 'Nein');
          if (n.patienten_daten_erhoben) {
            addDataRow('Patient Name', n.patient_name);
            addDataRow('Alter/Geburtsdatum', n.patient_alter_geburtsdatum);
            addDataRow('Pat.-Nummer ILS', n.patient_nummer_ils);
          }
          addDataRow('Sachverhalt', n.sachverhalt);
          yPos += 3;
          
          addHeading('Protokollpflicht');
          addDataRow('Protokollpflichtig', n.protokollpflichtig ? 'Ja' : 'Nein');
          if (n.protokollpflichtig) {
            addDataRow('Begründung', n.protokollpflichtig_begruendung);
          }
          addDataRow('Verantwortlicher unterwiesen', n.verantwortlicher_unterwiesen ? 'Ja' : 'Nein');
          yPos += 3;
          
          addHeading('Verantwortlicher');
          addDataRow('Name', n.verantwortlicher_name);
          addDataRow('Qualifikation', n.verantwortlicher_qualifikation);
          yPos += 3;
          
          addHeading('Nacherfassung');
          addDataRow('Nacherfasst von', n.nacherfasst_von_name + ' (' + (n.nacherfasst_von_qualifikation || '-') + ')');
          addDataRow('Nacherfasst am', n.nacherfasst_datum ? new Date(n.nacherfasst_datum).toLocaleString('de-DE') : '-');
        }
        
        // PDF speichern
        const filename = window.currentViewedDocType === 'patient' 
          ? `Patientendoku_${window.currentViewedPayload.einsatz_nr || 'unbekannt'}_${new Date().toISOString().split('T')[0]}.pdf`
          : `Nacherfassung_${window.currentViewedNachData.stichwort || 'unbekannt'}_${new Date().toISOString().split('T')[0]}.pdf`;
        
        doc.save(filename);
        showMsg('✅ PDF erstellt!', 'success');
        
      } catch(e) {
        console.error('PDF Error:', e);
        showMsg('Fehler bei PDF-Erstellung: ' + e.message, 'error');
      }
    };

    function showMsg(text, type = 'success') {
      const msgDiv = document.getElementById('msg');
      msgDiv.textContent = text;
      msgDiv.className = 'msg ' + type;
      setTimeout(() => { msgDiv.textContent = ''; msgDiv.className = 'msg'; }, 5000);
    }

    loadData();
    
    setTimeout(() => {
      document.body.classList.add('loaded');
    }, 100);
  </script>
</body>
</html>
