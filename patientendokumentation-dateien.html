<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>FFW ‚Äì Ausbildungen & Schulungen</title>
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <style>
    :root{--primary:#c8102e;--bg:#f8fafc;--card:#fff;--text:#0f172a;--muted:#64748b;--border:#e2e8f0}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:'Atkinson Hyperlegible',-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;line-height:1.45}
    header{background:linear-gradient(90deg,var(--primary),#981b1b);color:#fff;padding:12px 16px;display:flex;align-items:center;gap:12px}
    header h1{margin:0;font-size:1rem;font-weight:800}
    .spacer{flex:1}
    .topbtn{background:#ffffff1a;color:#fff;padding:8px 12px;border-radius:10px;text-decoration:none;font-weight:800;font-size:0.9rem;border:1px solid #ffffff55}
    .topbtn:hover{background:#ffffff2b}
    .wrap{max-width:1400px;margin:18px auto;padding:0 14px 100px}
    .card{background:var(--card);border-radius:14px;box-shadow:0 3px 12px rgba(0,0,0,.06);padding:20px;margin-bottom:20px}
    .card h2{margin-top:0;color:var(--primary)}
    .tabs{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap}
    .tab{border:1px solid #eee;background:#fafafa;padding:10px 16px;border-radius:999px;font-weight:800;cursor:pointer;font-size:0.95rem;transition:all 0.2s}
    .tab:hover{background:#f0f0f0}
    .tab.active{color:#fff;background:var(--primary);border-color:var(--primary)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;margin-top:16px}
    .member-card,.schulung-card{background:#fff;border:2px solid var(--border);border-radius:12px;padding:16px;cursor:pointer;transition:all 0.2s}
    .member-card:hover,.schulung-card:hover{border-color:var(--primary);box-shadow:0 4px 12px rgba(200,16,46,.1);transform:translateY(-2px)}
    .member-card h3,.schulung-card h3{margin:0 0 8px 0;color:var(--text);font-size:1.1rem}
    .member-card .tags,.schulung-card .meta{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .tag{background:#fee;color:var(--primary);padding:4px 10px;border-radius:999px;font-size:0.8rem;font-weight:700}
    .meta-item{font-size:0.85rem;color:var(--muted)}
    .btn{background:var(--primary);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer;font-size:0.9rem;transition:all 0.2s;display:inline-flex;align-items:center;gap:6px}
    .btn:hover{background:#a00d26}
    .btn-secondary{background:#6b7280;color:#fff}
    .btn-secondary:hover{background:#4b5563}
    .add-btn{position:fixed;bottom:30px;right:30px;width:60px;height:60px;border-radius:50%;background:var(--primary);color:#fff;border:0;cursor:pointer;font-size:1.5rem;box-shadow:0 4px 12px rgba(0,0,0,.2);z-index:100;transition:transform 0.2s}
    .add-btn:hover{transform:scale(1.1)}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:flex-start;justify-content:center;z-index:1000;padding:20px;overflow-y:auto}
    .modal.show{display:flex}
    .modal-box{background:#fff;border-radius:14px;max-width:800px;width:100%;max-height:90vh;overflow-y:auto;padding:24px;box-shadow:0 8px 20px rgba(0,0,0,.3);margin:auto}
    .modal-box h3{margin-top:0;color:var(--primary)}
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;margin:16px 0}
    .form-group{display:flex;flex-direction:column;gap:6px}
    .form-group label{font-weight:700;font-size:0.9rem;color:#374151}
    .form-group input,.form-group textarea,.form-group select{padding:10px 12px;border:1px solid #d1d5db;border-radius:8px;font-size:16px;font-family:inherit}
    .form-group input:focus,.form-group textarea:focus,.form-group select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(200,16,46,0.1)}
    .tag-input-wrapper{display:flex;gap:8px;flex-wrap:wrap;padding:8px;border:1px solid #d1d5db;border-radius:8px;min-height:44px;align-items:center;background:#fff}
    .tag-input-wrapper:focus-within{border-color:var(--primary);box-shadow:0 0 0 3px rgba(200,16,46,0.1)}
    .tag-input-wrapper .tag{display:flex;align-items:center;gap:4px;background:#fee;color:var(--primary);padding:4px 8px;border-radius:999px;font-size:0.85rem}
    .tag-input-wrapper .tag .remove-tag{cursor:pointer;font-weight:bold;margin-left:4px}
    .tag-input-wrapper input{border:none;outline:none;flex:1;min-width:100px;font-size:16px;padding:4px}
    .msg{margin-top:12px;padding:12px;border-radius:8px;font-weight:600}
    .msg.error{background:#fee;color:#c00;border:1px solid #fcc}
    .msg.success{background:#efe;color:#060;border:1px solid #cfc}
    .details-section{margin:20px 0;padding:16px;background:#f9fafb;border-radius:8px}
    .details-section h4{margin:0 0 12px 0;color:var(--primary);font-size:1rem}
    .attendance-table{width:100%;border-collapse:collapse;margin-top:12px}
    .attendance-table th,.attendance-table td{padding:10px;border:1px solid var(--border);text-align:left}
    .attendance-table th{background:#f8fafc;font-weight:700}
    .attendance-table tr:hover{background:#f9fafb}
    .status-badge{padding:4px 10px;border-radius:999px;font-size:0.8rem;font-weight:700;display:inline-block}
    .status-badge.anwesend{background:#d1fae5;color:#065f46}
    .status-badge.abwesend{background:#fee2e2;color:#991b1b}
    .status-badge.ok{background:#d1fae5;color:#065f46}
    .status-badge.warning{background:#fef3c7;color:#92400e}
    .status-badge.critical{background:#fee2e2;color:#991b1b}
    @media (max-width:768px){.grid{grid-template-columns:1fr}.form-grid{grid-template-columns:1fr}.modal-box{padding:16px}.add-btn{bottom:20px;right:20px}}
  </style>
</head>
<body>
  <header>
    <h1><i class="fa-solid fa-graduation-cap"></i> Ausbildungen & Schulungen</h1>
    <div class="spacer"></div>
    <a class="topbtn" href="admin-dashboard.html"><i class="fa-solid fa-dashboard"></i> Dashboard</a>
    <a class="topbtn" href="#" id="logout"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
  </header>

  <div class="wrap">
    <section class="card">
      <h2>√úbersicht</h2>
      
      <div class="tabs">
        <button class="tab active" data-tab="team"><i class="fa-solid fa-users"></i> Team (0)</button>
        <button class="tab" data-tab="schulungen"><i class="fa-solid fa-book"></i> Schulungen (0)</button>
      </div>

      <div id="tab-team" class="tab-content">
        <div class="grid" id="teamGrid"></div>
      </div>

      <div id="tab-schulungen" class="tab-content" style="display:none">
        <div class="grid" id="schulungenGrid"></div>
      </div>

      <div id="msg"></div>
    </section>
  </div>

  <button class="add-btn" id="addBtn" title="Neu anlegen">
    <i class="fa-solid fa-plus"></i>
  </button>

  <!-- Modal: Neue Person -->
  <div class="modal" id="memberModal">
    <div class="modal-box">
      <h3 id="memberModalTitle"><i class="fa-solid fa-user-plus"></i> Neue Person anlegen</h3>
      <form id="memberForm">
        <div class="form-grid">
          <div class="form-group">
            <label>Nachname *</label>
            <input type="text" name="name" required>
          </div>
          <div class="form-group">
            <label>Vorname *</label>
            <input type="text" name="vorname" required>
          </div>
        </div>
        <div class="form-group">
          <label>Qualifikationen / Tags</label>
          <div class="tag-input-wrapper" id="tagInputWrapper">
            <input 
              type="text" 
              id="tagInput" 
              placeholder="Tag eingeben und Enter dr√ºcken"
            >
          </div>
          <small style="color:#6b7280;font-size:0.85rem">Beispiele: RS, San A, San B, Defi-Schleife, Erste Hilfe</small>
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
          <button type="button" class="btn btn-secondary" onclick="closeMemberModal()">Abbrechen</button>
          <button type="submit" class="btn"><i class="fa-solid fa-save"></i> Speichern</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Neue Schulung -->
  <div class="modal" id="schulungModal">
    <div class="modal-box">
      <h3 id="schulungModalTitle"><i class="fa-solid fa-book-medical"></i> Neue Schulung anlegen</h3>
      <form id="schulungForm">
        <div class="form-grid">
          <div class="form-group">
            <label>Titel *</label>
            <input type="text" name="titel" required>
          </div>
          <div class="form-group">
            <label>Datum *</label>
            <input type="date" name="datum" required>
          </div>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label>Thema</label>
            <input type="text" name="thema">
          </div>
          <div class="form-group">
            <label>Dozent</label>
            <input type="text" name="dozent">
          </div>
        </div>
        <div class="form-group">
          <label>Beschreibung</label>
          <textarea name="beschreibung" rows="4"></textarea>
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
          <button type="button" class="btn btn-secondary" onclick="closeSchulungModal()">Abbrechen</button>
          <button type="submit" class="btn"><i class="fa-solid fa-save"></i> Speichern</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Personen-Details -->
  <div class="modal" id="memberDetailsModal">
    <div class="modal-box">
      <h3 id="memberDetailsTitle">Person</h3>
      <div id="memberDetailsBody"></div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
        <button class="btn btn-secondary" onclick="closeMemberDetailsModal()">Schlie√üen</button>
      </div>
    </div>
  </div>

  <!-- Modal: Schulungs-Details mit Anwesenheit -->
  <div class="modal" id="schulungDetailsModal">
    <div class="modal-box">
      <h3 id="schulungDetailsTitle">Schulung</h3>
      <div id="schulungDetailsBody"></div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
        <button class="btn btn-secondary" onclick="closeSchulungDetailsModal()">Schlie√üen</button>
        <button class="btn" onclick="saveAnwesenheit()"><i class="fa-solid fa-save"></i> Anwesenheit speichern</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { NhostClient } from "https://esm.sh/@nhost/nhost-js@2.2.9";
    
    const nhost = new NhostClient({ 
      subdomain: "hpjfrhktprpuuxvvlpsb", 
      region: "eu-central-1" 
    });

    // ===== AUTH GUARD FIX (KEIN RELOAD MEHR!) =====
    try {
      // Warte auf Session-Refresh (nur einmal beim Laden)
      await nhost.auth.refreshSession();
      
      const session = nhost.auth.getSession();
      
      if (!session) {
        // Keine Session ‚Üí Redirect
        window.location.replace("/admin-login.html");
        throw new Error("Not authenticated");
      }
    } catch (error) {
      console.error("Auth error:", error);
      window.location.replace("/admin-login.html");
      throw error;
    }
    // ===== AUTH GUARD ENDE =====

    const token = await nhost.auth.getAccessToken();
    const headers = { 
      "Content-Type": "application/json", 
      "Authorization": "Bearer " + token 
    };
    const endpoint = "https://hpjfrhktprpuuxvvlpsb.graphql.eu-central-1.nhost.run/v1";

    document.getElementById("logout").onclick = async (e) => {
      e.preventDefault();
      await nhost.auth.signOut();
      sessionStorage.clear();
      localStorage.clear();
      window.location.replace("/admin-login.html");
    };

    // Tab-Switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.onclick = () => {
        const targetTab = tab.dataset.tab;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = 'none');
        document.getElementById('tab-' + targetTab).style.display = 'block';
        document.getElementById('msg').textContent = '';
      };
    });

    // Add Button
    document.getElementById('addBtn').onclick = () => {
      const activeTab = document.querySelector('.tab.active').dataset.tab;
      if (activeTab === 'team') {
        openMemberModal();
      } else {
        openSchulungModal();
      }
    };

    async function gql(query, variables = {}) {
      const res = await fetch(endpoint, {
        method: "POST",
        headers,
        body: JSON.stringify({ query, variables })
      });
      const json = await res.json();
      if (json.errors) throw new Error(json.errors[0].message);
      return json.data;
    }

    // ===== TAG INPUT SYSTEM =====
    let currentTags = [];

    function initTagInput() {
      const wrapper = document.getElementById('tagInputWrapper');
      const input = document.getElementById('tagInput');
      
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          const tag = input.value.trim();
          if (tag && !currentTags.includes(tag)) {
            currentTags.push(tag);
            renderTags();
            input.value = '';
          }
        } else if (e.key === 'Backspace' && input.value === '' && currentTags.length > 0) {
          currentTags.pop();
          renderTags();
        }
      });
    }

    function renderTags() {
      const wrapper = document.getElementById('tagInputWrapper');
      const input = document.getElementById('tagInput');
      
      // Alle Tags au√üer Input entfernen
      Array.from(wrapper.children).forEach(child => {
        if (child !== input) child.remove();
      });
      
      // Tags vor dem Input einf√ºgen
      currentTags.forEach(tag => {
        const tagEl = document.createElement('span');
        tagEl.className = 'tag';
        tagEl.innerHTML = `${tag} <span class="remove-tag" onclick="removeTag('${tag}')">√ó</span>`;
        wrapper.insertBefore(tagEl, input);
      });
    }

    window.removeTag = (tag) => {
      currentTags = currentTags.filter(t => t !== tag);
      renderTags();
    };

    initTagInput();
    let allMembers = [];
    let allSchulungen = [];
    let currentSchulungId = null;

    async function loadData() {
      try {
        // Team-Members laden
        const membersData = await gql(`query {
          team_members(where: {aktiv: {_eq: true}}, order_by: {name: asc}) {
            id
            name
            vorname
            qualifikationen
          }
        }`);
        
        allMembers = membersData.team_members;
        
        // Schulungen laden
        const schulungenData = await gql(`query {
          schulungen(order_by: {datum: desc}) {
            id
            titel
            datum
            thema
            dozent
            beschreibung
          }
        }`);
        
        allSchulungen = schulungenData.schulungen;
        
        renderTeam();
        renderSchulungen();
        
      } catch(e) {
        showMsg('Fehler beim Laden: ' + e.message, 'error');
      }
    }

    function renderTeam() {
      const grid = document.getElementById('teamGrid');
      
      if (allMembers.length === 0) {
        grid.innerHTML = '<p style="padding:20px;color:#999">Noch keine Team-Mitglieder angelegt</p>';
        document.querySelector('[data-tab="team"]').innerHTML = '<i class="fa-solid fa-users"></i> Team (0)';
        return;
      }
      
      document.querySelector('[data-tab="team"]').innerHTML = `<i class="fa-solid fa-users"></i> Team (${allMembers.length})`;
      
      grid.innerHTML = allMembers.map(member => {
        const quali = member.qualifikationen || [];
        const tagsHTML = quali.map(q => `<span class="tag">${q}</span>`).join('');
        
        return `
          <div class="member-card" onclick="viewMemberDetails('${member.id}')">
            <h3><i class="fa-solid fa-user"></i> ${member.vorname} ${member.name}</h3>
            <div class="tags">
              ${tagsHTML || '<span class="tag" style="background:#eee;color:#999">Keine Qualifikationen</span>'}
            </div>
          </div>
        `;
      }).join('');
    }

    function renderSchulungen() {
      const grid = document.getElementById('schulungenGrid');
      
      if (allSchulungen.length === 0) {
        grid.innerHTML = '<p style="padding:20px;color:#999">Noch keine Schulungen angelegt</p>';
        document.querySelector('[data-tab="schulungen"]').innerHTML = '<i class="fa-solid fa-book"></i> Schulungen (0)';
        return;
      }
      
      document.querySelector('[data-tab="schulungen"]').innerHTML = `<i class="fa-solid fa-book"></i> Schulungen (${allSchulungen.length})`;
      
      grid.innerHTML = allSchulungen.map(schulung => {
        const datum = new Date(schulung.datum).toLocaleDateString('de-DE', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });
        
        return `
          <div class="schulung-card" onclick="viewSchulungDetails('${schulung.id}')">
            <h3><i class="fa-solid fa-book-medical"></i> ${schulung.titel}</h3>
            <div class="meta">
              <span class="meta-item"><i class="fa-solid fa-calendar"></i> ${datum}</span>
              ${schulung.thema ? `<span class="meta-item"><i class="fa-solid fa-tag"></i> ${schulung.thema}</span>` : ''}
              ${schulung.dozent ? `<span class="meta-item"><i class="fa-solid fa-chalkboard-user"></i> ${schulung.dozent}</span>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    // ===== NEUE PERSON ANLEGEN =====
    
    let editMemberId = null;
    
    function openMemberModal(memberId = null) {
      editMemberId = memberId;
      const form = document.getElementById('memberForm');
      form.reset();
      currentTags = [];
      
      if (memberId) {
        const member = allMembers.find(m => m.id === memberId);
        if (member) {
          document.getElementById('memberModalTitle').innerHTML = '<i class="fa-solid fa-user-edit"></i> Person bearbeiten';
          form.name.value = member.name;
          form.vorname.value = member.vorname;
          
          currentTags = member.qualifikationen || [];
          renderTags();
        }
      } else {
        document.getElementById('memberModalTitle').innerHTML = '<i class="fa-solid fa-user-plus"></i> Neue Person anlegen';
      }
      
      document.getElementById('memberModal').classList.add('show');
    }

    window.closeMemberModal = () => {
      document.getElementById('memberModal').classList.remove('show');
      editMemberId = null;
      currentTags = [];
      renderTags();
    };

    document.getElementById('memberForm').onsubmit = async (e) => {
      e.preventDefault();
      
      try {
        const formData = new FormData(e.target);
        const name = formData.get('name').trim();
        const vorname = formData.get('vorname').trim();
        
        const qualifikationen = currentTags;
        
        if (editMemberId) {
          // Update
          await gql(`mutation($id: uuid!, $name: String!, $vorname: String!, $quali: jsonb!) {
            update_team_members_by_pk(
              pk_columns: {id: $id},
              _set: {name: $name, vorname: $vorname, qualifikationen: $quali}
            ) {
              id
            }
          }`, {
            id: editMemberId,
            name,
            vorname,
            quali: qualifikationen
          });
          
          showMsg('‚úÖ Person aktualisiert!', 'success');
        } else {
          // Insert
          await gql(`mutation($name: String!, $vorname: String!, $quali: jsonb!) {
            insert_team_members_one(object: {
              name: $name,
              vorname: $vorname,
              qualifikationen: $quali
            }) {
              id
            }
          }`, {
            name,
            vorname,
            quali: qualifikationen
          });
          
          showMsg('‚úÖ Person angelegt!', 'success');
        }
        
        closeMemberModal();
        await loadData();
        
      } catch(e) {
        showMsg('Fehler: ' + e.message, 'error');
      }
    };

    // ===== NEUE SCHULUNG ANLEGEN =====
    
    let editSchulungId = null;
    
    function openSchulungModal(schulungId = null) {
      editSchulungId = schulungId;
      const form = document.getElementById('schulungForm');
      form.reset();
      
      if (schulungId) {
        const schulung = allSchulungen.find(s => s.id === schulungId);
        if (schulung) {
          document.getElementById('schulungModalTitle').innerHTML = '<i class="fa-solid fa-edit"></i> Schulung bearbeiten';
          form.titel.value = schulung.titel;
          form.datum.value = schulung.datum;
          form.thema.value = schulung.thema || '';
          form.dozent.value = schulung.dozent || '';
          form.beschreibung.value = schulung.beschreibung || '';
        }
      } else {
        document.getElementById('schulungModalTitle').innerHTML = '<i class="fa-solid fa-book-medical"></i> Neue Schulung anlegen';
      }
      
      document.getElementById('schulungModal').classList.add('show');
    }

    window.closeSchulungModal = () => {
      document.getElementById('schulungModal').classList.remove('show');
      editSchulungId = null;
    };

    document.getElementById('schulungForm').onsubmit = async (e) => {
      e.preventDefault();
      
      try {
        const formData = new FormData(e.target);
        const titel = formData.get('titel').trim();
        const datum = formData.get('datum');
        const thema = formData.get('thema').trim();
        const dozent = formData.get('dozent').trim();
        const beschreibung = formData.get('beschreibung').trim();
        
        if (editSchulungId) {
          // Update
          await gql(`mutation($id: uuid!, $titel: String!, $datum: date!, $thema: String, $dozent: String, $beschreibung: String) {
            update_schulungen_by_pk(
              pk_columns: {id: $id},
              _set: {titel: $titel, datum: $datum, thema: $thema, dozent: $dozent, beschreibung: $beschreibung}
            ) {
              id
            }
          }`, {
            id: editSchulungId,
            titel,
            datum,
            thema,
            dozent,
            beschreibung
          });
          
          showMsg('‚úÖ Schulung aktualisiert!', 'success');
        } else {
          // Insert neue Schulung
          const result = await gql(`mutation($titel: String!, $datum: date!, $thema: String, $dozent: String, $beschreibung: String) {
            insert_schulungen_one(object: {
              titel: $titel,
              datum: $datum,
              thema: $thema,
              dozent: $dozent,
              beschreibung: $beschreibung
            }) {
              id
            }
          }`, {
            titel,
            datum,
            thema,
            dozent,
            beschreibung
          });
          
          const newSchulungId = result.insert_schulungen_one.id;
          
          // F√ºr jedes Team-Member eine Teilnahme-Zeile anlegen (initial auf false)
          for (const member of allMembers) {
            await gql(`mutation($schulung_id: uuid!, $member_id: uuid!) {
              insert_schulung_teilnahme_one(object: {
                schulung_id: $schulung_id,
                member_id: $member_id,
                anwesend: false
              }) {
                id
              }
            }`, {
              schulung_id: newSchulungId,
              member_id: member.id
            });
          }
          
          showMsg('‚úÖ Schulung angelegt!', 'success');
        }
        
        closeSchulungModal();
        await loadData();
        
      } catch(e) {
        showMsg('Fehler: ' + e.message, 'error');
      }
    };

    window.openMemberModal = openMemberModal;
    window.openSchulungModal = openSchulungModal;
    // ===== PERSONEN-DETAILS ANZEIGEN =====
    
    window.viewMemberDetails = async (memberId) => {
      try {
        const member = allMembers.find(m => m.id === memberId);
        if (!member) {
          showMsg('Person nicht gefunden', 'error');
          return;
        }
        
        // KORRIGIERT: Ohne order_by
        const teilnahmenData = await gql(`query($member_id: uuid!) {
          schulung_teilnahme(
            where: {member_id: {_eq: $member_id}}
          ) {
            id
            anwesend
            bemerkung
            schulung {
              id
              titel
              datum
              thema
              dozent
            }
          }
        }`, { member_id: memberId });
        
        // Manuell sortieren nach Datum (neueste zuerst)
        const teilnahmen = teilnahmenData.schulung_teilnahme.sort((a, b) => {
          return new Date(b.schulung.datum) - new Date(a.schulung.datum);
        });
        
        // Schulungspflicht berechnen (2x j√§hrlich)
        const currentYear = new Date().getFullYear();
        const lastYear = currentYear - 1;
        
        const teilnahmenThisYear = teilnahmen.filter(t => 
          t.anwesend && new Date(t.schulung.datum).getFullYear() === currentYear
        );
        
        const teilnahmenLastYear = teilnahmen.filter(t => 
          t.anwesend && new Date(t.schulung.datum).getFullYear() === lastYear
        );
        
        // Status berechnen
        let statusBadge = '';
        let statusText = '';
        
        if (teilnahmenThisYear.length >= 2) {
          statusBadge = '<span class="status-badge ok"><i class="fa-solid fa-check-circle"></i> Schulungspflicht erf√ºllt</span>';
          statusText = `${teilnahmenThisYear.length} Schulungen in ${currentYear}`;
        } else if (teilnahmenThisYear.length === 1) {
          statusBadge = '<span class="status-badge warning"><i class="fa-solid fa-exclamation-triangle"></i> 1 Schulung fehlt</span>';
          statusText = `${teilnahmenThisYear.length} von 2 Schulungen in ${currentYear}`;
        } else {
          statusBadge = '<span class="status-badge critical"><i class="fa-solid fa-times-circle"></i> Schulungspflicht nicht erf√ºllt</span>';
          statusText = `0 Schulungen in ${currentYear}`;
        }
        
        // Qualifikationen
        const quali = member.qualifikationen || [];
        const tagsHTML = quali.map(q => `<span class="tag">${q}</span>`).join('') || 
          '<span class="tag" style="background:#eee;color:#999">Keine Qualifikationen</span>';
        
        // Anwesenheitstabelle
        let tableHTML = '';
        if (teilnahmen.length > 0) {
          tableHTML = `
            <table class="attendance-table">
              <thead>
                <tr>
                  <th>Datum</th>
                  <th>Schulung</th>
                  <th>Thema</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          teilnahmen.forEach(t => {
            const datum = new Date(t.schulung.datum).toLocaleDateString('de-DE', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit'
            });
            
            const statusClass = t.anwesend ? 'anwesend' : 'abwesend';
            const statusIcon = t.anwesend ? '<i class="fa-solid fa-check"></i>' : '<i class="fa-solid fa-times"></i>';
            const statusLabel = t.anwesend ? 'Anwesend' : 'Abwesend';
            
            tableHTML += `
              <tr>
                <td>${datum}</td>
                <td><strong>${t.schulung.titel}</strong></td>
                <td>${t.schulung.thema || '-'}</td>
                <td><span class="status-badge ${statusClass}">${statusIcon} ${statusLabel}</span></td>
              </tr>
            `;
          });
          
          tableHTML += `
              </tbody>
            </table>
          `;
        } else {
          tableHTML = '<p style="color:#999;padding:16px;text-align:center">Noch keine Schulungen vorhanden</p>';
        }
        
        // Modal f√ºllen
        document.getElementById('memberDetailsTitle').innerHTML = 
          `<i class="fa-solid fa-user"></i> ${member.vorname} ${member.name}`;
        
        document.getElementById('memberDetailsBody').innerHTML = `
          <div class="details-section">
            <h4><i class="fa-solid fa-id-badge"></i> Qualifikationen</h4>
            <div class="tags">${tagsHTML}</div>
          </div>
          
          <div class="details-section">
            <h4><i class="fa-solid fa-calendar-check"></i> Schulungspflicht ${currentYear}</h4>
            <div style="margin-bottom:12px">${statusBadge}</div>
            <p style="margin:0;color:#6b7280">${statusText} (Pflicht: 2x j√§hrlich)</p>
          </div>
          
          <div class="details-section">
            <h4><i class="fa-solid fa-clock-rotate-left"></i> Anwesenheitshistorie (${teilnahmen.length})</h4>
            ${tableHTML}
          </div>
          
          <div class="details-section">
            <h4><i class="fa-solid fa-chart-line"></i> Statistik</h4>
            <p style="margin:4px 0"><strong>${currentYear}:</strong> ${teilnahmenThisYear.length} Schulung(en)</p>
            <p style="margin:4px 0"><strong>${lastYear}:</strong> ${teilnahmenLastYear.length} Schulung(en)</p>
            <p style="margin:4px 0"><strong>Gesamt:</strong> ${teilnahmen.filter(t => t.anwesend).length} von ${teilnahmen.length}</p>
          </div>
          
          <div style="margin-top:16px;display:flex;gap:8px">
            <button class="btn" onclick="openMemberModal('${memberId}')">
              <i class="fa-solid fa-edit"></i> Bearbeiten
            </button>
            <button class="btn btn-secondary" onclick="deleteMember('${memberId}')">
              <i class="fa-solid fa-trash"></i> L√∂schen
            </button>
          </div>
        `;
        
        document.getElementById('memberDetailsModal').classList.add('show');
        
      } catch(e) {
        showMsg('Fehler beim Laden: ' + e.message, 'error');
      }
    };

    window.closeMemberDetailsModal = () => {
      document.getElementById('memberDetailsModal').classList.remove('show');
    };

    window.deleteMember = async (memberId) => {
      if (!confirm('Person wirklich l√∂schen? Alle Anwesenheitsdaten gehen verloren!')) {
        return;
      }
      
      try {
        // Zuerst alle Teilnahmen l√∂schen
        await gql(`mutation($member_id: uuid!) {
          delete_schulung_teilnahme(where: {member_id: {_eq: $member_id}}) {
            affected_rows
          }
        }`, { member_id: memberId });
        
        // Dann Person l√∂schen
        await gql(`mutation($id: uuid!) {
          delete_team_members_by_pk(id: $id) {
            id
          }
        }`, { id: memberId });
        
        showMsg('‚úÖ Person gel√∂scht!', 'success');
        closeMemberDetailsModal();
        await loadData();
        
      } catch(e) {
        showMsg('Fehler beim L√∂schen: ' + e.message, 'error');
      }
    };
    // ===== SCHULUNGS-DETAILS MIT ANWESENHEITSLISTE =====
    
    window.viewSchulungDetails = async (schulungId) => {
      try {
        currentSchulungId = schulungId;
        
        const schulung = allSchulungen.find(s => s.id === schulungId);
        if (!schulung) {
          showMsg('Schulung nicht gefunden', 'error');
          return;
        }
        
        // KORRIGIERT: Ohne order_by
        const teilnahmenData = await gql(`query($schulung_id: uuid!) {
          schulung_teilnahme(
            where: {schulung_id: {_eq: $schulung_id}}
          ) {
            id
            anwesend
            bemerkung
            member {
              id
              name
              vorname
              qualifikationen
            }
          }
        }`, { schulung_id: schulungId });
        
        // Manuell sortieren nach Name
        const teilnahmen = teilnahmenData.schulung_teilnahme.sort((a, b) => {
          const nameA = a.member.name.toLowerCase();
          const nameB = b.member.name.toLowerCase();
          return nameA.localeCompare(nameB);
        });
        
        // Statistik berechnen
        const anwesendCount = teilnahmen.filter(t => t.anwesend).length;
        const abwesendCount = teilnahmen.length - anwesendCount;
        
        // Datum formatieren
        const datum = new Date(schulung.datum).toLocaleDateString('de-DE', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        
        // Anwesenheitstabelle erstellen
        let tableHTML = '';
        if (teilnahmen.length > 0) {
          tableHTML = `
            <table class="attendance-table">
              <thead>
                <tr>
                  <th style="width:40px">#</th>
                  <th>Name</th>
                  <th>Qualifikationen</th>
                  <th style="width:120px;text-align:center">Anwesend</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          teilnahmen.forEach((t, idx) => {
            const quali = t.member.qualifikationen || [];
            const tagsHTML = quali.map(q => 
              `<span class="tag" style="font-size:0.75rem;padding:2px 6px">${q}</span>`
            ).join('');
            
            tableHTML += `
              <tr>
                <td>${idx + 1}</td>
                <td><strong>${t.member.vorname} ${t.member.name}</strong></td>
                <td>${tagsHTML || '<span style="color:#999;font-size:0.85rem">-</span>'}</td>
                <td style="text-align:center">
                  <input 
                    type="checkbox" 
                    id="anw_${t.id}" 
                    data-teilnahme-id="${t.id}"
                    ${t.anwesend ? 'checked' : ''}
                    style="width:20px;height:20px;cursor:pointer"
                  >
                </td>
              </tr>
            `;
          });
          
          tableHTML += `
              </tbody>
            </table>
          `;
        } else {
          tableHTML = '<p style="color:#999;padding:16px;text-align:center">Noch keine Team-Mitglieder vorhanden</p>';
        }
        
        // Modal f√ºllen
        document.getElementById('schulungDetailsTitle').innerHTML = 
          `<i class="fa-solid fa-book-medical"></i> ${schulung.titel}`;
        
        document.getElementById('schulungDetailsBody').innerHTML = `
          <div class="details-section">
            <h4><i class="fa-solid fa-info-circle"></i> Schulungsinformationen</h4>
            <div style="display:grid;grid-template-columns:150px 1fr;gap:8px;margin-top:12px">
              <div style="font-weight:700;color:#6b7280">Datum:</div>
              <div>${datum}</div>
              
              <div style="font-weight:700;color:#6b7280">Thema:</div>
              <div>${schulung.thema || '-'}</div>
              
              <div style="font-weight:700;color:#6b7280">Dozent:</div>
              <div>${schulung.dozent || '-'}</div>
              
              ${schulung.beschreibung ? `
              <div style="font-weight:700;color:#6b7280">Beschreibung:</div>
              <div>${schulung.beschreibung}</div>
              ` : ''}
            </div>
          </div>
          
          <div class="details-section">
            <h4><i class="fa-solid fa-chart-pie"></i> Teilnahme-Statistik</h4>
            <div style="display:flex;gap:20px;margin-top:12px">
              <div style="text-align:center;flex:1;padding:12px;background:#d1fae5;border-radius:8px">
                <div style="font-size:2rem;font-weight:800;color:#065f46">${anwesendCount}</div>
                <div style="font-size:0.85rem;color:#065f46">Anwesend</div>
              </div>
              <div style="text-align:center;flex:1;padding:12px;background:#fee2e2;border-radius:8px">
                <div style="font-size:2rem;font-weight:800;color:#991b1b">${abwesendCount}</div>
                <div style="font-size:0.85rem;color:#991b1b">Abwesend</div>
              </div>
              <div style="text-align:center;flex:1;padding:12px;background:#f3f4f6;border-radius:8px">
                <div style="font-size:2rem;font-weight:800;color:#374151">${teilnahmen.length}</div>
                <div style="font-size:0.85rem;color:#374151">Gesamt</div>
              </div>
            </div>
          </div>
          
          <div class="details-section">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <h4 style="margin:0"><i class="fa-solid fa-users"></i> Anwesenheitsliste</h4>
              <div style="display:flex;gap:8px">
                <button class="btn" style="font-size:0.8rem;padding:6px 10px" onclick="markAllPresent()">
                  <i class="fa-solid fa-check-double"></i> Alle anwesend
                </button>
                <button class="btn btn-secondary" style="font-size:0.8rem;padding:6px 10px" onclick="markAllAbsent()">
                  <i class="fa-solid fa-times"></i> Alle abwesend
                </button>
              </div>
            </div>
            ${tableHTML}
          </div>
          
          <div style="margin-top:16px;display:flex;gap:8px">
            <button class="btn" onclick="openSchulungModal('${schulungId}')">
              <i class="fa-solid fa-edit"></i> Bearbeiten
            </button>
            <button class="btn btn-secondary" onclick="deleteSchulung('${schulungId}')">
              <i class="fa-solid fa-trash"></i> L√∂schen
            </button>
          </div>
        `;
        
        document.getElementById('schulungDetailsModal').classList.add('show');
        
      } catch(e) {
        showMsg('Fehler beim Laden: ' + e.message, 'error');
      }
    };

    window.closeSchulungDetailsModal = () => {
      document.getElementById('schulungDetailsModal').classList.remove('show');
      currentSchulungId = null;
    };

    window.saveAnwesenheit = async () => {
      try {
        if (!currentSchulungId) {
          showMsg('Keine Schulung ausgew√§hlt', 'error');
          return;
        }
        
        // Alle Checkboxen durchgehen
        const checkboxes = document.querySelectorAll('[data-teilnahme-id]');
        
        for (const checkbox of checkboxes) {
          const teilnahmeId = checkbox.dataset.teilnahmeId;
          const anwesend = checkbox.checked;
          
          await gql(`mutation($id: uuid!, $anwesend: Boolean!) {
            update_schulung_teilnahme_by_pk(
              pk_columns: {id: $id},
              _set: {anwesend: $anwesend}
            ) {
              id
            }
          }`, {
            id: teilnahmeId,
            anwesend
          });
        }
        
        showMsg('‚úÖ Anwesenheit gespeichert!', 'success');
        
        // Modal neu laden um Statistik zu aktualisieren
        await viewSchulungDetails(currentSchulungId);
        
      } catch(e) {
        showMsg('Fehler beim Speichern: ' + e.message, 'error');
      }
    };

    window.deleteSchulung = async (schulungId) => {
      if (!confirm('Schulung wirklich l√∂schen? Alle Anwesenheitsdaten gehen verloren!')) {
        return;
      }
      
      try {
        // Zuerst alle Teilnahmen l√∂schen
        await gql(`mutation($schulung_id: uuid!) {
          delete_schulung_teilnahme(where: {schulung_id: {_eq: $schulung_id}}) {
            affected_rows
          }
        }`, { schulung_id: schulungId });
        
        // Dann Schulung l√∂schen
        await gql(`mutation($id: uuid!) {
          delete_schulungen_by_pk(id: $id) {
            id
          }
        }`, { id: schulungId });
        
        showMsg('‚úÖ Schulung gel√∂scht!', 'success');
        closeSchulungDetailsModal();
        await loadData();
        
      } catch(e) {
        showMsg('Fehler beim L√∂schen: ' + e.message, 'error');
      }
    };

    // ===== QUICK ACTIONS =====
    
    window.markAllPresent = () => {
      document.querySelectorAll('[data-teilnahme-id]').forEach(cb => {
        cb.checked = true;
      });
    };

    window.markAllAbsent = () => {
      document.querySelectorAll('[data-teilnahme-id]').forEach(cb => {
        cb.checked = false;
      });
    };
    // ===== HELPER FUNCTIONS =====
    
    function showMsg(text, type = 'success') {
      const msgDiv = document.getElementById('msg');
      msgDiv.textContent = text;
      msgDiv.className = 'msg ' + type;
      setTimeout(() => { 
        msgDiv.textContent = ''; 
        msgDiv.className = 'msg'; 
      }, 5000);
    }

    // ===== SUCHE / FILTER (OPTIONAL) =====
    
    window.searchTeam = (query) => {
      const searchTerm = query.toLowerCase().trim();
      
      if (!searchTerm) {
        renderTeam();
        return;
      }
      
      const filtered = allMembers.filter(m => {
        const fullName = `${m.vorname} ${m.name}`.toLowerCase();
        const quali = (m.qualifikationen || []).join(' ').toLowerCase();
        return fullName.includes(searchTerm) || quali.includes(searchTerm);
      });
      
      const grid = document.getElementById('teamGrid');
      
      if (filtered.length === 0) {
        grid.innerHTML = '<p style="padding:20px;color:#999">Keine Ergebnisse gefunden</p>';
        return;
      }
      
      grid.innerHTML = filtered.map(member => {
        const quali = member.qualifikationen || [];
        const tagsHTML = quali.map(q => `<span class="tag">${q}</span>`).join('');
        
        return `
          <div class="member-card" onclick="viewMemberDetails('${member.id}')">
            <h3><i class="fa-solid fa-user"></i> ${member.vorname} ${member.name}</h3>
            <div class="tags">
              ${tagsHTML || '<span class="tag" style="background:#eee;color:#999">Keine Qualifikationen</span>'}
            </div>
          </div>
        `;
      }).join('');
    };

    window.searchSchulungen = (query) => {
      const searchTerm = query.toLowerCase().trim();
      
      if (!searchTerm) {
        renderSchulungen();
        return;
      }
      
      const filtered = allSchulungen.filter(s => {
        const titel = s.titel.toLowerCase();
        const thema = (s.thema || '').toLowerCase();
        const dozent = (s.dozent || '').toLowerCase();
        return titel.includes(searchTerm) || thema.includes(searchTerm) || dozent.includes(searchTerm);
      });
      
      const grid = document.getElementById('schulungenGrid');
      
      if (filtered.length === 0) {
        grid.innerHTML = '<p style="padding:20px;color:#999">Keine Ergebnisse gefunden</p>';
        return;
      }
      
      grid.innerHTML = filtered.map(schulung => {
        const datum = new Date(schulung.datum).toLocaleDateString('de-DE', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });
        
        return `
          <div class="schulung-card" onclick="viewSchulungDetails('${schulung.id}')">
            <h3><i class="fa-solid fa-book-medical"></i> ${schulung.titel}</h3>
            <div class="meta">
              <span class="meta-item"><i class="fa-solid fa-calendar"></i> ${datum}</span>
              ${schulung.thema ? `<span class="meta-item"><i class="fa-solid fa-tag"></i> ${schulung.thema}</span>` : ''}
              ${schulung.dozent ? `<span class="meta-item"><i class="fa-solid fa-chalkboard-user"></i> ${schulung.dozent}</span>` : ''}
            </div>
          </div>
        `;
      }).join('');
    };

    // ===== DASHBOARD STATISTIKEN (OPTIONAL) =====
    
    window.getDashboardStats = async () => {
      const currentYear = new Date().getFullYear();
      
      // Alle Teilnahmen dieses Jahr
      const teilnahmenData = await gql(`query {
        schulung_teilnahme(
          where: {
            anwesend: {_eq: true},
            schulung: {datum: {_gte: "${currentYear}-01-01"}}
          }
        ) {
          member_id
        }
      }`);
      
      // Anzahl Mitglieder mit >= 2 Schulungen
      const memberCounts = {};
      teilnahmenData.schulung_teilnahme.forEach(t => {
        memberCounts[t.member_id] = (memberCounts[t.member_id] || 0) + 1;
      });
      
      const compliantMembers = Object.values(memberCounts).filter(count => count >= 2).length;
      const totalMembers = allMembers.length;
      const complianceRate = totalMembers > 0 ? Math.round((compliantMembers / totalMembers) * 100) : 0;
      
      return {
        totalMembers,
        compliantMembers,
        complianceRate,
        totalSchulungen: allSchulungen.length,
        schulungenThisYear: allSchulungen.filter(s => 
          new Date(s.datum).getFullYear() === currentYear
        ).length
      };
    };

    // ===== BENACHRICHTIGUNGEN (OPTIONAL) =====
    
    window.checkSchulungspflicht = async () => {
      const currentYear = new Date().getFullYear();
      
      const warningMembers = [];
      
      for (const member of allMembers) {
        const teilnahmenData = await gql(`query($member_id: uuid!) {
          schulung_teilnahme(
            where: {
              member_id: {_eq: $member_id},
              anwesend: {_eq: true},
              schulung: {datum: {_gte: "${currentYear}-01-01"}}
            }
          ) {
            id
          }
        }`, { member_id: member.id });
        
        const count = teilnahmenData.schulung_teilnahme.length;
        
        if (count < 2) {
          warningMembers.push({
            name: `${member.vorname} ${member.name}`,
            count,
            missing: 2 - count
          });
        }
      }
      
      if (warningMembers.length > 0) {
        console.log('‚ö†Ô∏è Schulungspflicht nicht erf√ºllt:', warningMembers);
        return warningMembers;
      }
      
      return [];
    };

    // ===== EXPORT FUNKTIONEN (OPTIONAL - VORBEREITET) =====
    
    window.exportSchulungToPDF = async (schulungId) => {
      showMsg('üìÑ PDF-Export wird bald implementiert...', 'success');
      // TODO: PDF-Export mit jsPDF implementieren
    };

    window.exportMemberToPDF = async (memberId) => {
      showMsg('üìÑ PDF-Export wird bald implementiert...', 'success');
      // TODO: PDF-Export f√ºr Mitglieder-Historie
    };

    // ===== KEYBOARD SHORTCUTS (OPTIONAL) =====
    
    document.addEventListener('keydown', (e) => {
      // ESC = Modals schlie√üen
      if (e.key === 'Escape') {
        closeMemberModal();
        closeSchulungModal();
        closeMemberDetailsModal();
        closeSchulungDetailsModal();
      }
      
      // CTRL/CMD + N = Neues Element (je nach aktivem Tab)
      if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
        e.preventDefault();
        const activeTab = document.querySelector('.tab.active').dataset.tab;
        if (activeTab === 'team') {
          openMemberModal();
        } else {
          openSchulungModal();
        }
      }
    });

    // ===== MODAL CLICK OUTSIDE TO CLOSE =====
    
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.remove('show');
        }
      });
    });

    // ===== AUTO-REFRESH (OPTIONAL) =====
    
    // Automatisch alle 5 Minuten neu laden
    setInterval(() => {
      loadData();
      console.log('üîÑ Daten automatisch aktualisiert');
    }, 5 * 60 * 1000);

    // ===== SESSION MONITORING =====
    
    // Pr√ºfe alle 30 Sekunden ob Session noch g√ºltig
    setInterval(async () => {
      try {
        const session = nhost.auth.getSession();
        if (!session) {
          console.warn('‚ö†Ô∏è Session abgelaufen - Redirect zu Login');
          window.location.replace("/admin-login.html");
        }
      } catch (e) {
        console.error('Session check error:', e);
      }
    }, 30 * 1000);

    // ===== INITIAL LOAD =====
    
    console.log('üöí FFW Ausbildungs-Management gestartet');
    loadData();

  </script>
</body>
</html>
