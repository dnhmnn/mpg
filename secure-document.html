<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sicherer Dokumentenzugriff ‚Äì FFW</title>
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <style>
    :root{--primary:#c8102e;--success:#16a34a;--bg:#f8fafc;--card:#fff;--text:#0f172a;--muted:#64748b;--border:#e2e8f0}
    *{box-sizing:border-box}
    body{
      margin:0;
      background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color:var(--text);
      font-family:'Atkinson Hyperlegible',-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      line-height:1.5;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }
    
    header{
      background:#fff;
      box-shadow:0 2px 10px rgba(0,0,0,.1);
      padding:1rem;
      text-align:center;
    }
    
    .logo-area{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      margin-bottom:8px;
    }
    
    .logo{
      width:50px;
      height:50px;
      background:var(--primary);
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:1.5rem;
      font-weight:800;
    }
    
    h1{
      margin:0;
      font-size:1.3rem;
      color:var(--text);
      font-weight:800;
    }
    
    .subtitle{
      color:var(--muted);
      font-size:.9rem;
      margin-top:4px;
    }
    
    .container{
      flex:1;
      max-width:800px;
      width:100%;
      margin:0 auto;
      padding:2rem 1rem;
    }
    
    .card{
      background:var(--card);
      border-radius:16px;
      box-shadow:0 10px 40px rgba(0,0,0,.15);
      padding:2rem;
      margin-bottom:1.5rem;
    }
    
    .loading{
      text-align:center;
      padding:3rem 1rem;
    }
    
    .spinner{
      width:60px;
      height:60px;
      border:4px solid #f3f3f3;
      border-top:4px solid var(--primary);
      border-radius:50%;
      animation:spin 1s linear infinite;
      margin:0 auto 1.5rem;
    }
    
    @keyframes spin{
      0%{transform:rotate(0deg)}
      100%{transform:rotate(360deg)}
    }
    
    .status-box{
      padding:1.5rem;
      border-radius:12px;
      margin-bottom:1.5rem;
      border:2px solid;
    }
    
    .status-box.success{
      background:#dcfce7;
      border-color:#16a34a;
      color:#15803d;
    }
    
    .status-box.error{
      background:#fee2e2;
      border-color:#dc2626;
      color:#991b1b;
    }
    
    .status-box.warning{
      background:#fef3c7;
      border-color:#f59e0b;
      color:#92400e;
    }
    
    .status-box.info{
      background:#dbeafe;
      border-color:#3b82f6;
      color:#1e40af;
    }
    
    .status-icon{
      font-size:3rem;
      margin-bottom:1rem;
      display:block;
    }
    
    .status-title{
      font-size:1.3rem;
      font-weight:800;
      margin-bottom:0.5rem;
    }
    
    .debug-box{
      background:#1e293b;
      color:#e2e8f0;
      padding:1rem;
      border-radius:8px;
      font-family:'Courier New', monospace;
      font-size:0.85rem;
      margin-top:1rem;
      max-height:300px;
      overflow-y:auto;
    }
    
    .debug-box pre{
      margin:0;
      white-space:pre-wrap;
      word-wrap:break-word;
    }
    
    .debug-line{
      padding:4px 0;
      border-bottom:1px solid #334155;
    }
    
    .debug-line:last-child{
      border-bottom:none;
    }
    
    .doc-header{
      border-bottom:2px solid var(--border);
      padding-bottom:1rem;
      margin-bottom:1.5rem;
    }
    
    .doc-title{
      font-size:1.4rem;
      font-weight:800;
      color:var(--primary);
      margin:0 0 0.5rem 0;
    }
    
    .doc-meta{
      color:var(--muted);
      font-size:0.9rem;
    }
    
    .doc-meta strong{
      color:var(--text);
    }
    
    .section{
      margin:1.5rem 0;
    }
    
    .section-title{
      font-size:1.1rem;
      font-weight:800;
      color:var(--text);
      margin:0 0 1rem 0;
      display:flex;
      align-items:center;
      gap:8px;
    }
    
    .info-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));
      gap:1rem;
    }
    
    .info-item{
      background:#f8fafc;
      padding:1rem;
      border-radius:8px;
      border-left:4px solid var(--primary);
    }
    
    .info-label{
      font-size:0.85rem;
      color:var(--muted);
      font-weight:600;
      margin-bottom:4px;
      text-transform:uppercase;
    }
    
    .info-value{
      font-size:1rem;
      color:var(--text);
      font-weight:700;
    }
    
    .vital-signs{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));
      gap:1rem;
      margin:1rem 0;
    }
    
    .vital-card{
      background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color:#fff;
      padding:1.5rem;
      border-radius:12px;
      text-align:center;
    }
    
    .vital-label{
      font-size:0.8rem;
      opacity:0.9;
      margin-bottom:0.5rem;
    }
    
    .vital-value{
      font-size:2rem;
      font-weight:800;
    }
    
    .vital-unit{
      font-size:0.9rem;
      opacity:0.8;
    }
    
    .medications-table{
      width:100%;
      border-collapse:collapse;
      margin:1rem 0;
      overflow-x:auto;
      display:block;
    }
    
    .medications-table thead,
    .medications-table tbody{
      display:table;
      width:100%;
    }
    
    .medications-table th,
    .medications-table td{
      padding:0.75rem;
      text-align:left;
      border-bottom:1px solid var(--border);
    }
    
    .medications-table th{
      background:#f8fafc;
      font-weight:700;
      font-size:0.85rem;
      text-transform:uppercase;
      color:var(--muted);
    }
    
    .badge{
      display:inline-block;
      padding:0.25rem 0.75rem;
      border-radius:999px;
      font-size:0.85rem;
      font-weight:700;
    }
    
    .badge.success{
      background:#dcfce7;
      color:#16a34a;
    }
    
    .badge.warning{
      background:#fef3c7;
      color:#d97706;
    }
    
    .badge.info{
      background:#dbeafe;
      color:#1e40af;
    }
    
    .btn{
      display:inline-block;
      padding:0.75rem 1.5rem;
      border-radius:8px;
      font-weight:700;
      text-decoration:none;
      text-align:center;
      cursor:pointer;
      border:0;
      font-family:inherit;
      font-size:1rem;
      transition:all 0.2s;
    }
    
    .btn.primary{
      background:var(--primary);
      color:#fff;
    }
    
    .btn.primary:hover{
      background:#a00d26;
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(200,16,46,0.3);
    }
    
    .btn.secondary{
      background:#f1f5f9;
      color:var(--text);
      border:2px solid var(--border);
    }
    
    .actions{
      display:flex;
      gap:1rem;
      margin-top:2rem;
      flex-wrap:wrap;
    }
    
    .signature-box{
      border:2px dashed var(--border);
      border-radius:8px;
      padding:1rem;
      text-align:center;
    }
    
    .signature-img{
      max-width:100%;
      height:auto;
      border:1px solid var(--border);
      border-radius:4px;
      background:#fff;
    }
    
    .photo-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(150px, 1fr));
      gap:1rem;
      margin:1rem 0;
    }
    
    .photo-item img{
      width:100%;
      height:150px;
      object-fit:cover;
      border-radius:8px;
      border:2px solid var(--border);
      cursor:pointer;
      transition:all 0.2s;
    }
    
    .photo-item img:hover{
      transform:scale(1.05);
      box-shadow:0 4px 12px rgba(0,0,0,0.2);
    }
    
    .access-log{
      background:#fef3c7;
      border:2px solid #f59e0b;
      border-radius:8px;
      padding:1rem;
      margin-top:2rem;
      font-size:0.85rem;
    }
    
    .access-log strong{
      color:#92400e;
    }
    
    footer{
      background:#fff;
      padding:1.5rem;
      text-align:center;
      color:var(--muted);
      font-size:0.85rem;
      border-top:1px solid var(--border);
    }
    
    @media (max-width: 600px) {
      .container{
        padding:1rem;
      }
      
      .card{
        padding:1.5rem;
      }
      
      .info-grid{
        grid-template-columns:1fr;
      }
      
      .vital-signs{
        grid-template-columns:repeat(2, 1fr);
      }
      
      .actions{
        flex-direction:column;
      }
      
      .btn{
        width:100%;
      }
      
      .medications-table{
        font-size:0.85rem;
      }
      
      .medications-table th,
      .medications-table td{
        padding:0.5rem;
      }
    }
    
    @media print{
      body{
        background:#fff;
      }
      header, footer, .actions, .access-log, .debug-box{
        display:none;
      }
      .card{
        box-shadow:none;
        border:1px solid #ccc;
      }
    }
  </style>
</head>
<body>

<header>
  <div class="logo-area">
    <div class="logo">üöí</div>
    <div>
      <h1>Feuerwehr Dokumentenzugriff</h1>
      <div class="subtitle">Verschl√ºsselte Patientendokumentation</div>
    </div>
  </div>
</header>

<div class="container">
  <div id="content">
    <div class="card loading">
      <div class="spinner"></div>
      <h2>Lade Dokument...</h2>
      <p style="color:var(--muted)">Bitte warten...</p>
    </div>
  </div>
</div>

<footer>
  <strong>üîí Sicherer Zugriff</strong><br>
  Diese Seite verwendet Ende-zu-Ende-Verschl√ºsselung (TLS/SSL).<br>
  Der Zugriff wird protokolliert gem√§√ü DSGVO Art. 9.
</footer>

<script type="module">
import { NhostClient } from "https://esm.sh/@nhost/nhost-js@2.2.9";

const nhost = new NhostClient({
  subdomain: "hpjfrhktprpuuxvvlpsb",
  region: "eu-central-1"
});

const contentDiv = document.getElementById('content');
let debugLog = [];

function addDebug(message, data = null) {
  const timestamp = new Date().toLocaleTimeString();
  const logEntry = { timestamp, message, data };
  debugLog.push(logEntry);
  console.log(`[${timestamp}] ${message}`, data || '');
}

function extractQRKey() {
  addDebug('Extracting QR-Key from URL');
  
  const urlParams = new URLSearchParams(window.location.search);
  let key = urlParams.get('key');
  
  if (key) {
    addDebug('QR-Key found in query parameter', key);
    return key;
  }
  
  const path = window.location.pathname;
  addDebug('Path:', path);
  
  const match = path.match(/\/secure\/([A-Z0-9\-]+)/i);
  if (match) {
    addDebug('QR-Key found in path', match[1]);
    return match[1];
  }
  
  addDebug('No QR-Key found!');
  return null;
}

const qrKey = extractQRKey();

addDebug('Current URL', window.location.href);
addDebug('Extracted QR-Key', qrKey);

if (!qrKey) {
  showError('Kein QR-Code angegeben', 'Bitte scannen Sie einen g√ºltigen QR-Code oder verwenden Sie einen direkten Link.');
} else {
  loadDocument();
}

async function loadDocument() {
  try {
    addDebug('=== LOAD DOCUMENT START ===');
    
    contentDiv.innerHTML = `
      <div class="card loading">
        <div class="spinner"></div>
        <h2>Lade Dokument...</h2>
        <p style="color:var(--muted)">QR-Code: <code>${qrKey}</code></p>
      </div>
    `;
    
    addDebug('Reading localStorage...');
    const qrCodesRaw = localStorage.getItem('ffw_qr_codes');
    addDebug('Raw localStorage data', qrCodesRaw ? qrCodesRaw.substring(0, 100) + '...' : 'NULL');
    
    const qrCodes = JSON.parse(qrCodesRaw || '[]');
    addDebug('Total QR Codes in storage', qrCodes.length);
    
    const qrCode = qrCodes.find(q => q.id === qrKey);
    addDebug('Found QR Code', qrCode);
    
    if (!qrCode) {
      addDebug('‚ùå ERROR: QR-Code nicht im localStorage gefunden!');
      showDebugError('QR-Code nicht gefunden', `Der QR-Code "${qrKey}" wurde nicht im System gefunden.`);
      return;
    }
    
    addDebug('QR Code Status', qrCode.status);
    addDebug('Assigned To', qrCode.assignedTo);
    
    if (qrCode.status !== 'assigned') {
      addDebug('‚ùå ERROR: QR-Code ist nicht zugeordnet!');
      showDebugWarning('QR-Code noch nicht zugeordnet', 'Dieser QR-Code wurde noch keinem Dokument zugeordnet.');
      return;
    }
    
    // KORRIGIERTE QUERY - patient_docs
    addDebug('Loading document from Nhost...', qrCode.assignedTo);
    
    const QUERY = `query($id:uuid!) {
      patient_docs(where:{id:{_eq:$id}}) {
        id
        type
        title
        created_at
        payload
        status
      }
    }`;
    
    addDebug('GraphQL Query', QUERY);
    addDebug('GraphQL Variables', { id: qrCode.assignedTo });
    
    const result = await nhost.graphql.request(QUERY, { id: qrCode.assignedTo });
    
    addDebug('GraphQL Result', result);
    
    if (result.error) {
      addDebug('‚ùå GraphQL Error', result.error);
      throw new Error(result.error[0]?.message || 'GraphQL Error');
    }
    
    // KORRIGIERT: patient_docs
    const doc = result.data.patient_docs ? result.data.patient_docs[0] : null;
    addDebug('Document found', doc ? 'YES' : 'NO');
    addDebug('Document data', doc);
    
    if (!doc) {
      addDebug('‚ùå ERROR: Dokument nicht in Datenbank gefunden!');
      showDebugError('Dokument nicht gefunden', 'Das verkn√ºpfte Dokument konnte nicht geladen werden.');
      return;
    }
    
    addDebug('‚úÖ SUCCESS: Document loaded successfully');
    logAccess(qrKey, doc.id);
    renderDocument(doc, qrKey);
    
  } catch(e) {
    addDebug('‚ùå EXCEPTION', e.message);
    addDebug('Stack trace', e.stack);
    console.error('Load error:', e);
    showDebugError('Fehler beim Laden', `Technischer Fehler: ${e.message}`);
  }
}

function showDebugError(title, message) {
  contentDiv.innerHTML = `
    <div class="card">
      <div class="status-box error">
        <span class="status-icon">‚ùå</span>
        <div class="status-title">${title}</div>
        <p>${message}</p>
      </div>
      ${renderDebugLog()}
      <div class="actions">
        <button class="btn secondary" onclick="location.reload()">
          <i class="fa-solid fa-rotate"></i> Erneut versuchen
        </button>
        <button class="btn secondary" onclick="copyDebugLog()">
          <i class="fa-solid fa-copy"></i> Debug-Log kopieren
        </button>
      </div>
    </div>
  `;
}

function showDebugWarning(title, message) {
  contentDiv.innerHTML = `
    <div class="card">
      <div class="status-box warning">
        <span class="status-icon">‚ö†Ô∏è</span>
        <div class="status-title">${title}</div>
        <p>${message}</p>
      </div>
      ${renderDebugLog()}
    </div>
  `;
}

function renderDebugLog() {
  return `
    <div style="margin-top:1.5rem;">
      <h3 style="margin:0 0 0.5rem 0; color:var(--text);">üîç Debug-Informationen</h3>
      <div class="debug-box">
        ${debugLog.map(log => `
          <div class="debug-line">
            <strong style="color:#60a5fa;">[${log.timestamp}]</strong> ${log.message}
            ${log.data ? `<br><span style="color:#94a3b8;">${typeof log.data === 'object' ? JSON.stringify(log.data, null, 2) : log.data}</span>` : ''}
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

window.copyDebugLog = function() {
  const logText = debugLog.map(log => 
    `[${log.timestamp}] ${log.message}${log.data ? '\n' + JSON.stringify(log.data, null, 2) : ''}`
  ).join('\n\n');
  
  navigator.clipboard.writeText(logText).then(() => {
    alert('‚úÖ Debug-Log in Zwischenablage kopiert!');
  }).catch(() => {
    alert('‚ùå Fehler beim Kopieren.');
  });
};

function showError(title, message) {
  contentDiv.innerHTML = `
    <div class="card">
      <div class="status-box error">
        <span class="status-icon">‚ùå</span>
        <div class="status-title">${title}</div>
        <p>${message}</p>
      </div>
    </div>
  `;
}

function renderDocument(doc, qrKey) {
  addDebug('Rendering document...');
  
  const data = typeof doc.payload === 'string' ? JSON.parse(doc.payload) : doc.payload;
  const createdDate = new Date(doc.created_at).toLocaleString('de-DE');
  
  let gcsScore = data.qsofa_gcs || '‚Äî';
  let qsofaScore = '‚Äî';
  
  if (data.qsofa_gcs || data.af || data.rr_sys) {
    let score = 0;
    if (data.qsofa_gcs && data.qsofa_gcs < 15) score++;
    if (data.af && data.af >= 22) score++;
    if (data.rr_sys && data.rr_sys <= 100) score++;
    qsofaScore = score;
  }
  
  contentDiv.innerHTML = `
    <div class="card">
      <div class="status-box success">
        <span class="status-icon">‚úÖ</span>
        <div class="status-title">Dokument erfolgreich geladen</div>
        <p>Zugriff via QR-Code: <strong>${qrKey}</strong></p>
      </div>
      
      <div class="doc-header">
        <h2 class="doc-title">${doc.title || 'Patientendokumentation'}</h2>
        <div class="doc-meta">
          <strong>Dokument-ID:</strong> ${doc.id.slice(0, 8)}<br>
          <strong>Erstellt:</strong> ${createdDate}<br>
          <strong>Status:</strong> <span class="badge info">${doc.status}</span>
        </div>
      </div>
      
      ${data.name ? `
      <div class="section">
        <h3 class="section-title">
          <i class="fa-solid fa-user"></i> Patientendaten
        </h3>
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">Name</div>
            <div class="info-value">${data.vorname || ''} ${data.name}</div>
          </div>
          ${data.gebdatum ? `<div class="info-item">
            <div class="info-label">Geburtsdatum</div>
            <div class="info-value">${new Date(data.gebdatum).toLocaleDateString('de-DE')}</div>
          </div>` : ''}
          ${data.alter ? `<div class="info-item">
            <div class="info-label">Alter</div>
            <div class="info-value">${data.alter} Jahre</div>
          </div>` : ''}
          ${data.telefon ? `<div class="info-item">
            <div class="info-label">Telefon</div>
            <div class="info-value">${data.telefon}</div>
          </div>` : ''}
        </div>
      </div>` : ''}
      
      ${data.einsatz_nr || data.fahrzeug ? `
      <div class="section">
        <h3 class="section-title">
          <i class="fa-solid fa-truck-medical"></i> Einsatzdaten
        </h3>
        <div class="info-grid">
          ${data.einsatz_nr ? `<div class="info-item">
            <div class="info-label">Einsatz-Nr.</div>
            <div class="info-value">${data.einsatz_nr}</div>
          </div>` : ''}
          ${data.fahrzeug ? `<div class="info-item">
            <div class="info-label">Fahrzeug</div>
            <div class="info-value">${data.fahrzeug}</div>
          </div>` : ''}
          ${data.zeit_einsatz ? `<div class="info-item">
            <div class="info-label">Einsatzzeit</div>
            <div class="info-value">${new Date(data.zeit_einsatz).toLocaleString('de-DE')}</div>
          </div>` : ''}
          ${data.einsatz_art ? `<div class="info-item">
            <div class="info-label">Einsatz-Art</div>
            <div class="info-value">${data.einsatz_art}</div>
          </div>` : ''}
        </div>
      </div>` : ''}
      
      ${(data.rr_sys || data.hf || data.af || data.spo2 || data.temp || data.bz_mg) ? `
      <div class="section">
        <h3 class="section-title">
          <i class="fa-solid fa-heart-pulse"></i> Vitalwerte
        </h3>
        <div class="vital-signs">
          ${data.rr_sys ? `<div class="vital-card">
            <div class="vital-label">Blutdruck</div>
            <div class="vital-value">${data.rr_sys}/${data.rr_dia || '‚Äî'}</div>
            <div class="vital-unit">mmHg</div>
          </div>` : ''}
          ${data.hf ? `<div class="vital-card">
            <div class="vital-label">Herzfrequenz</div>
            <div class="vital-value">${data.hf}</div>
            <div class="vital-unit">/min</div>
          </div>` : ''}
          ${data.af ? `<div class="vital-card">
            <div class="vital-label">Atemfrequenz</div>
            <div class="vital-value">${data.af}</div>
            <div class="vital-unit">/min</div>
          </div>` : ''}
          ${data.spo2 ? `<div class="vital-card">
            <div class="vital-label">SpO‚ÇÇ</div>
            <div class="vital-value">${data.spo2}</div>
            <div class="vital-unit">%</div>
          </div>` : ''}
          ${data.temp ? `<div class="vital-card">
            <div class="vital-label">Temperatur</div>
            <div class="vital-value">${data.temp}</div>
            <div class="vital-unit">¬∞C</div>
          </div>` : ''}
          ${data.bz_mg ? `<div class="vital-card">
            <div class="vital-label">Blutzucker</div>
            <div class="vital-value">${data.bz_mg}</div>
            <div class="vital-unit">mg/dl</div>
          </div>` : ''}
        </div>
      </div>` : ''}
      
      ${(gcsScore !== '‚Äî' || qsofaScore !== '‚Äî') ? `
      <div class="section">
        <h3 class="section-title">
          <i class="fa-solid fa-brain"></i> Neurologische Scores
        </h3>
        <div class="info-grid">
          ${gcsScore !== '‚Äî' ? `<div class="info-item">
            <div class="info-label">Glasgow Coma Scale (GCS)</div>
            <div class="info-value">${gcsScore} Punkte</div>
          </div>` : ''}
          ${qsofaScore !== '‚Äî' ? `<div class="info-item">
            <div class="info-label">qSOFA Score</div>
            <div class="info-value">${qsofaScore} ${qsofaScore >= 2 ? '‚ö†Ô∏è Erh√∂ht!' : ''}</div>
          </div>` : ''}
        </div>
      </div>` : ''}
      
      ${data.medications && data.medications.length > 0 ? `
      <div class="section">
        <h3 class="section-title">
          <i class="fa-solid fa-pills"></i> Verabreichte Medikamente
        </h3>
        <table class="medications-table">
          <thead>
            <tr>
              <th>Medikament</th>
              <th>Dosis</th>
              <th>Route</th>
              <th>Uhrzeit</th>
            </tr>
          </thead>
          <tbody>
            ${data.medications.map(med => `
              <tr>
                <td><strong>${med.name}</strong></td>
                <td>${med.dose} ${med.unit || ''}</td>
                <td><span class="badge info">${med.route || '‚Äî'}</span></td>
                <td>${med.time || '‚Äî'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>` : ''}
      
      ${data.notfallgeschehen ? `
      <div class="section">
        <h3 class="section-title">
          <i class="fa-solid fa-notes-medical"></i> Notfallgeschehen / Anamnese
        </h3>
        <div style="background:#f8fafc;padding:1rem;border-radius:8px;border-left:4px solid var(--primary);white-space:pre-wrap">
${data.notfallgeschehen}
        </div>
      </div>` : ''}
      
      ${data.photos && data.photos.length > 0 ? `
      <div class="section">
        <h3 class="section-title">
          <i class="fa-solid fa-camera"></i> Dokumentationsfotos
        </h3>
        <div class="photo-grid">
          ${data.photos.map((photo, i) => `
            <div class="photo-item">
              <img src="${photo}" alt="Foto ${i+1}" onclick="window.open(this.src, '_blank')">
            </div>
          `).join('')}
        </div>
      </div>` : ''}
      
      ${data.signature ? `
      <div class="section">
        <h3 class="section-title">
          <i class="fa-solid fa-signature"></i> Unterschrift Sanit√§ter
        </h3>
        <div class="signature-box">
          <div style="margin-bottom:0.5rem">
            <strong>${data.ausfueller_name || 'Sanit√§ter'}</strong>
            ${data.ausfueller_zeit ? ` ‚Äì ${new Date(data.ausfueller_zeit).toLocaleString('de-DE')}` : ''}
          </div>
          <img src="${data.signature}" class="signature-img" alt="Unterschrift">
        </div>
      </div>` : ''}
      
      <div class="actions">
        <button class="btn primary" onclick="window.print()">
          <i class="fa-solid fa-print"></i> Drucken
        </button>
      </div>
      
      <div class="access-log">
        <strong>‚ÑπÔ∏è Hinweis:</strong> Dieser Zugriff wird gem√§√ü DSGVO Art. 9 protokolliert.
        Zugriffszeitpunkt: ${new Date().toLocaleString('de-DE')}
      </div>
    </div>
  `;
  
  addDebug('‚úÖ Document rendered successfully');
}

function logAccess(qrKey, docId) {
  const accessLog = JSON.parse(localStorage.getItem('ffw_access_log') || '[]');
  accessLog.push({
    qrKey: qrKey,
    docId: docId,
    timestamp: new Date().toISOString(),
    userAgent: navigator.userAgent
  });
  localStorage.setItem('ffw_access_log', JSON.stringify(accessLog));
  addDebug('Access logged', { qrKey, docId });
}

window.downloadPDF = function() {
  alert('PDF-Download: In Produktion w√ºrde hier eine PDF erstellt.\n\nTipp: Nutzen Sie die Drucken-Funktion und w√§hlen Sie "Als PDF speichern".');
};
</script>

</body>
</html>
