<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CIRS-Meldung ‚Äì Responda</title>
  
  <!-- Theme Color -->
  <meta name="theme-color" content="#667eea">
  
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/pocketbase@0.21.3/dist/pocketbase.umd.js"></script>
  
  <style>
    :root{
      --primary:#c8102e;
      --bg:#f8fafc;
      --card:#fff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --gradient-start:#667eea;
      --gradient-end:#764ba2;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
      min-height:100vh;
      color:var(--text);
      font-family:'Atkinson Hyperlegible',-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      line-height:1.45;
      opacity:0;
      transition:opacity 0.3s;
    }
    
    body.loaded{opacity:1}
    
    /* Header ganz oben */
    header{
      position:sticky;
      top:0;
      background:var(--gradient-start);
      color:#fff;
      z-index:10;
    }
    .bar{
      max-width:1100px;
      margin:0 auto;
      padding:.75rem 1rem;
      display:flex;
      gap:.5rem;
      align-items:center;
      flex-wrap:wrap;
    }
    h1{font-size:1.05rem;margin:0;font-weight:800}
    .toolbar{margin-left:auto;display:flex;gap:.5rem;flex-wrap:wrap}
    .btn{
      border:1px solid rgba(255,255,255,0.3);
      background:rgba(255,255,255,0.1);
      color:#fff;
      padding:.45rem .7rem;
      border-radius:.5rem;
      cursor:pointer;
      font-weight:700;
      font-size:.9rem;
      transition:all 0.2s;
    }
    .btn:hover{background:rgba(255,255,255,0.2)}
    
    .back-btn {
      color: #fff;
      text-decoration: none;
      background: rgba(255,255,255,0.2);
      padding: 7px 12px;
      border-radius: 8px;
      font-weight: 700;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .back-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .loading-box {
      background: #dbeafe;
      color: #1e40af;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      font-weight: 600;
      border: 2px solid #93c5fd;
      max-width: 1100px;
      margin: 20px auto;
    }
    
    .error-box {
      background: #fee2e2;
      color: #991b1b;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      font-weight: 600;
      border: 2px solid #fca5a5;
      max-width: 1100px;
      margin: 20px auto;
    }
    
    .wrap{max-width:1100px;margin:0 auto;padding:1rem 1rem 100px}
    .hint{color:#fff;margin:.5rem 0 1rem;font-size:.95rem;opacity:0.9}
    details{background:var(--card);border:1px solid var(--border);border-radius:.75rem;margin:0 0 .8rem 0;overflow:hidden}
    summary{list-style:none;padding:.9rem 1rem;cursor:pointer;font-weight:800;display:flex;align-items:center;gap:.6rem;font-size:1rem}
    summary::-webkit-details-marker{display:none}
    details[open] summary{border-bottom:1px solid var(--border);background:#fff7f7}
    .sec-body{padding:1rem}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:.75rem}
    .row{display:flex;gap:.75rem;flex-wrap:wrap;margin:.25rem 0}
    label{font-size:.92rem;color:#111827;font-weight:600}
    input[type="text"],input[type="date"],textarea,select{
      width:100%;padding:.55rem .6rem;border:1px solid var(--border);border-radius:.5rem;background:#fff;font-size:16px;
    }
    textarea{min-height:100px;resize:vertical}
    
    .info-box {
      background: #dbeafe;
      border: 2px solid #93c5fd;
      border-radius: .75rem;
      padding: 1rem;
      margin-bottom: .8rem;
      color: #1e40af;
    }
    .info-box strong {
      display: block;
      margin-bottom: .5rem;
    }

    /* Feste Sendeleiste unten */
    .sendbar{
      position:fixed;
      left:0;
      right:0;
      bottom:0;
      background:var(--gradient-start);
      border-top:1px solid rgba(0,0,0,0.2);
      padding:.6rem 1rem;
      z-index:20;
      box-shadow:0 -2px 10px rgba(0,0,0,.1);
    }
    .sendbar .inner{max-width:1100px;margin:0 auto;display:flex;gap:.6rem;align-items:center;justify-content:flex-end}
    .sendbtn{
      border:1px solid rgba(255,255,255,0.4);
      background:rgba(255,255,255,0.1);
      color:#fff;
      padding:.55rem .9rem;
      border-radius:.55rem;
      font-weight:800;
      cursor:pointer;
      font-size:1rem;
      transition:all 0.2s;
    }
    .sendbtn:hover{background:rgba(255,255,255,0.2)}
    .sendbtn:disabled{opacity:.6;cursor:not-allowed}

    /* Modal */
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:flex-start;
      justify-content:center;
      z-index:9999;
      padding:20px 16px;
      overflow-y:auto;
    }
    .modal.show{display:flex}
    
    .modal-box{
      background:#fff;
      border-radius:12px;
      box-shadow:0 6px 24px rgba(0,0,0,.3);
      padding:20px;
      max-width:500px;
      width:100%;
      max-height:calc(100vh - 40px);
      overflow-y:auto;
      margin:auto;
    }
    
    .modal-h{
      display:flex;
      gap:10px;
      align-items:center;
      margin-bottom:12px;
      border-bottom:2px solid var(--border);
      padding-bottom:10px;
    }
    
    .modal-h h3{
      margin:0;
      color:var(--primary);
      font-size:1.2rem;
      font-weight:800;
    }
    
    .success-box{
      background:#dcfce7;
      border:2px solid #16a34a;
      border-radius:8px;
      padding:12px;
      margin-bottom:12px;
    }
    
    .success-box strong{
      display:block;
      margin-bottom:4px;
    }
    
    #docIdDisplay{
      font-family:monospace;
      font-size:1rem;
      word-break:break-all;
      color:#15803d;
    }
    
    .modal-actions{
      display:flex;
      gap:10px;
      justify-content:stretch;
      margin-top:20px;
    }
    
    .modal-btn{
      flex:1;
      min-width:120px;
      padding:14px 16px;
      border:0;
      border-radius:8px;
      font-weight:700;
      font-size:1rem;
      cursor:pointer;
      transition:all 0.2s;
      font-family:inherit;
    }
    
    .modal-btn.primary{
      background:var(--primary);
      color:#fff;
    }
    
    .modal-btn.primary:active{
      background:#a00d26;
      transform:scale(0.98);
    }

    @media (max-width: 600px) {
      .modal{padding:10px;padding-top:20px}
      .modal-box{padding:16px}
      .modal-h h3{font-size:1.1rem}
      .btn{font-size:.85rem;padding:.4rem .6rem}
      h1{font-size:.95rem}
    }

    @media screen and (max-width: 768px) {
      input, textarea, select {
        font-size:16px !important;
      }
    }

    @media print{
      header,.hint,.btn,.sendbar,.modal{display:none!important} 
      body{background:#fff}
      details{border:none}
      details summary{display:none}
      .sec-body{padding:0}
    }
  </style>
</head>
<body>

<header>
  <div class="bar">
    <h1 id="pageTitle"><i class="fa-solid fa-triangle-exclamation"></i> CIRS-Meldung</h1>
    <div class="toolbar">
      <a href="#" class="back-btn" id="backBtn">‚Üê Zur√ºck</a>
      <button class="btn" onclick="resetFormConfirm()"><i class="fa-solid fa-eraser"></i> Zur√ºcksetzen</button>
    </div>
  </div>
</header>

<!-- Loading -->
<div id="loadingBox" class="loading-box">
  üîÑ Lade Organisation...
</div>

<!-- Fehler bei ung√ºltiger Organisation -->
<div id="errorBox" class="error-box" style="display:none">
  ‚ùå <span id="errorText">Ung√ºltige Organisation</span>
</div>

<div class="wrap" id="formContainer" style="display:none">
  <div class="hint">Anonymous kritische Ereignisse melden ‚Ä¢ Zur Verbesserung der Sicherheit</div>

  <!-- Info Box -->
  <div class="info-box">
    <strong>‚ÑπÔ∏è Was ist CIRS?</strong>
    CIRS (Critical Incident Reporting System) dient der anonymen Meldung von kritischen Ereignissen, Beinahe-Unf√§llen oder Zwischenf√§llen zur Verbesserung der Sicherheit.
  </div>

  <!-- Ereignis -->
  <details open>
    <summary><i class="fa-solid fa-calendar-days"></i> Ereignis</summary>
    <div class="sec-body">
      <div class="grid">
        <label>Datum des Ereignisses<input name="datum" type="date" required></label>
        <label>Ort<input name="ort" type="text" placeholder="z.B. Fahrzeughalle, Einsatzstelle" required></label>
      </div>
      
      <div class="grid">
        <label>Kategorie
          <select name="kategorie" required>
            <option value="">Bitte w√§hlen...</option>
            <option value="personal">Personal / Besetzung</option>
            <option value="kommunikation">Kommunikation</option>
            <option value="material">Material / Ausr√ºstung</option>
            <option value="fahrzeug">Fahrzeug</option>
            <option value="einsatz">Einsatztaktik</option>
            <option value="organisation">Organisation</option>
            <option value="sonstiges">Sonstiges</option>
          </select>
        </label>
        
        <label>Schweregrad
          <select name="schwere" required>
            <option value="">Bitte w√§hlen...</option>
            <option value="gering">Gering (keine Gef√§hrdung)</option>
            <option value="mittel">Mittel (potenzielle Gef√§hrdung)</option>
            <option value="hoch">Hoch (ernste Gef√§hrdung)</option>
          </select>
        </label>
      </div>
    </div>
  </details>

  <!-- Beschreibung -->
  <details open>
    <summary><i class="fa-solid fa-file-lines"></i> Beschreibung</summary>
    <div class="sec-body">
      <label>Was ist passiert?<textarea name="was" placeholder="Schildere das Ereignis sachlich und detailliert..." required></textarea></label>
      <p style="color:#64748b;font-size:.9rem;margin-top:.3rem">Beschreibe den Ablauf des Ereignisses chronologisch.</p>
      
      <label>Warum ist es passiert? (vermutete Ursache)<textarea name="warum" placeholder="Was war deiner Meinung nach die Ursache?"></textarea></label>
      
      <label>Welche Folgen hatte das Ereignis?<textarea name="folgen" placeholder="Gab es Auswirkungen? Wurden Personen gef√§hrdet?"></textarea></label>
    </div>
  </details>

  <!-- Verbesserungsvorschl√§ge -->
  <details open>
    <summary><i class="fa-solid fa-lightbulb"></i> Verbesserungsvorschl√§ge</summary>
    <div class="sec-body">
      <label>Wie k√∂nnte man das in Zukunft verhindern?<textarea name="vorschlag" placeholder="Deine Ideen zur Vermeidung solcher Ereignisse..."></textarea></label>
      <p style="color:#64748b;font-size:.9rem;margin-top:.3rem">Deine Vorschl√§ge helfen, die Sicherheit f√ºr alle zu verbessern.</p>
    </div>
  </details>

  <!-- Melder (optional) -->
  <details>
    <summary><i class="fa-solid fa-user-secret"></i> Melder (optional & anonym)</summary>
    <div class="sec-body">
      <p style="color:#64748b;font-size:.9rem;margin-bottom:1rem">
        Diese Angaben sind <strong>freiwillig</strong>. CIRS-Meldungen sind grunds√§tzlich anonym. 
        Falls du R√ºckfragen erm√∂glichen m√∂chtest, kannst du hier deine Kontaktdaten angeben.
      </p>
      
      <div class="grid">
        <label>Name (optional)<input name="melder_name" type="text" placeholder="Vor- und Nachname"></label>
        <label>Kontakt (optional)<input name="melder_kontakt" type="text" placeholder="E-Mail oder Telefon"></label>
      </div>
    </div>
  </details>
</div>

<!-- Feste Absende-Leiste unten -->
<div class="sendbar">
  <div class="inner">
    <button id="sendBtn" class="sendbtn" onclick="submitToBackend()">
      <i class="fa-solid fa-paper-plane"></i> Meldung absenden
    </button>
  </div>
</div>

<!-- Success Modal -->
<div class="modal" id="successModal">
  <div class="modal-box">
    <div class="modal-h">
      <h3>‚úÖ Erfolgreich gemeldet!</h3>
    </div>
    
    <div class="success-box">
      <strong>Vielen Dank f√ºr deinen Beitrag zur Sicherheit!</strong>
      <span id="docIdDisplay"></span>
    </div>
    
    <div class="modal-actions">
      <button class="modal-btn primary" onclick="location.reload()">
        <i class="fa-solid fa-plus"></i> Neue Meldung
      </button>
    </div>
  </div>
</div>

<script>
  const pb = new PocketBase('https://api.responda.systems');
  
  // Organisation aus URL lesen
  const urlParams = new URLSearchParams(window.location.search);
  const orgCode = urlParams.get('org');
  
  const loadingBoxEl = document.getElementById('loadingBox');
  const errorBoxEl = document.getElementById('errorBox');
  const errorTextEl = document.getElementById('errorText');
  const formContainerEl = document.getElementById('formContainer');
  const pageTitleEl = document.getElementById('pageTitle');
  const backBtn = document.getElementById('backBtn');
  
  let currentOrganization = null;
  let currentDocumentId = null;

  // Organisation laden
  async function loadOrganization() {
    console.log('üîç Loading organization:', orgCode);
    
    if (!orgCode) {
      showError('Keine Organisation in URL angegeben!');
      return;
    }
    
    try {
      const org = await pb.collection('organizations').getFirstListItem(
        `org_code = "${orgCode}"`
      );
      
      console.log('‚úÖ Organization loaded:', org);
      
      if (!org.is_active) {
        showError('Diese Organisation ist nicht aktiv!');
        return;
      }
      
      currentOrganization = org;
      
      pageTitleEl.textContent = `‚ö†Ô∏è CIRS-Meldung ‚Äì ${org.org_name}`;
      backBtn.href = `index-public.html?org=${orgCode}`;
      
      loadingBoxEl.style.display = 'none';
      errorBoxEl.style.display = 'none';
      formContainerEl.style.display = 'block';
      
      document.body.classList.add('loaded');
      
      // Initial setup
      initForm();
      
    } catch (error) {
      console.error('‚ùå Error loading organization:', error);
      
      if (error.status === 404) {
        showError('Organisation nicht gefunden!');
      } else {
        showError('Fehler beim Laden: ' + error.message);
      }
    }
  }
  
  function showError(message) {
    pageTitleEl.textContent = '‚ö†Ô∏è CIRS-Meldung ‚Äì Fehler';
    loadingBoxEl.style.display = 'none';
    errorBoxEl.style.display = 'block';
    errorTextEl.textContent = message;
    formContainerEl.style.display = 'none';
    document.body.classList.add('loaded');
  }
  
  // Beim Laden
  loadOrganization();

  // ===== FORM INIT =====
  function initForm() {
    // Datum vorbelegen
    const d = new Date();
    const pad = n => String(n).padStart(2,'0');
    document.querySelector('input[name="datum"]').value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }

  // ===== DATEN SAMMELN =====
  function collectFormData() {
    const data = {};
    
    document.querySelectorAll('input, textarea, select').forEach(el => {
      if (!el.name) return;
      data[el.name] = el.value;
    });
    
    return data;
  }

  // ===== RESET =====
  window.resetFormConfirm = function() {
    if (!confirm('Wirklich alle Eingaben zur√ºcksetzen?')) return;
    
    document.querySelectorAll('input, textarea, select').forEach(el => {
      if (el.name !== 'datum') {
        el.value = '';
      }
    });
    
    alert('‚úÖ Formular zur√ºckgesetzt!');
  };

  // ===== ABSENDEN =====
  window.submitToBackend = async function() {
    if (!currentOrganization) {
      alert('‚ùå Keine Organisation geladen!');
      return;
    }
    
    const btn = document.getElementById('sendBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Sende...';
    
    try {
      const data = collectFormData();
      
      // Validierung
      if (!data.datum || !data.ort || !data.kategorie || !data.schwere || !data.was) {
        alert('‚ùå Bitte alle Pflichtfelder ausf√ºllen:\n- Datum\n- Ort\n- Kategorie\n- Schweregrad\n- Was ist passiert?');
        btn.disabled = false;
        btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Meldung absenden';
        return;
      }
      
      const deDate = data.datum.split('-').reverse().join('.');
      const title = `CIRS: ${data.kategorie} (${deDate})`;
      
      console.log('üì§ Submitting CIRS report:', {
        title,
        organization_id: currentOrganization.id,
        org_code: orgCode
      });
      
      // An PocketBase senden
      const record = await pb.collection('cirs_reports').create({
        title: title,
        payload: data,
        status: 'offen',
        organization_id: currentOrganization.id
      });
      
      console.log('‚úÖ Document created:', record.id);
      
      currentDocumentId = record.id;
      
      // Success Modal zeigen
      document.getElementById('docIdDisplay').textContent = `Meldungs-ID: CIRS-${new Date().getFullYear()}-${record.id.slice(0,8)}`;
      document.getElementById('successModal').classList.add('show');
      
      btn.innerHTML = '<i class="fa-solid fa-check"></i> Gemeldet!';
      
    } catch(e) {
      console.error('‚ùå Submit error:', e);
      alert('‚ùå Fehler beim Senden: ' + e.message);
      btn.disabled = false;
      btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Meldung absenden';
    }
  };
</script>

</body>
</html>
