<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Patientendokumentation</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<style>
  :root{--primary:#c8102e;--bg:#f8fafc;--card:#fff;--text:#0f172a;--muted:#64748b;--border:#e2e8f0}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;line-height:1.45}
  header{position:sticky;top:0;background:linear-gradient(90deg,var(--primary),#981b1b);color:#fff;z-index:10}
  .bar{max-width:1100px;margin:0 auto;padding:.75rem 1rem;display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
  h1{font-size:1.05rem;margin:0;font-weight:800}
  .toolbar{margin-left:auto;display:flex;gap:.5rem;flex-wrap:wrap}
  .btn{border:1px solid #ffffff55;background:#ffffff1a;color:#fff;padding:.45rem .7rem;border-radius:.5rem;cursor:pointer;font-weight:700}
  .btn:hover{background:#ffffff2b}
  .wrap{max-width:1100px;margin:0 auto;padding:1rem 1rem 100px}
  .hint{color:var(--muted);margin:.5rem 0 1rem}
  details{background:var(--card);border:1px solid var(--border);border-radius:.75rem;margin:0 0 .8rem 0;overflow:hidden}
  summary{list-style:none;padding:.9rem 1rem;cursor:pointer;font-weight:800;display:flex;align-items:center;gap:.6rem}
  summary::-webkit-details-marker{display:none}
  details[open] summary{border-bottom:1px solid var(--border);background:#fff7f7}
  .sec-body{padding:1rem}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:.75rem}
  .row{display:flex;gap:.75rem;flex-wrap:wrap;margin:.25rem 0}
  label{font-size:.92rem;color:#111827}
  input[type="text"],input[type="number"],input[type="datetime-local"],input[type="date"],textarea,select{
    width:100%;padding:.55rem .6rem;border:1px solid var(--border);border-radius:.5rem;background:#fff;
  }
  textarea{min-height:88px;resize:vertical}
  fieldset{border:1px solid var(--border);border-radius:.6rem;padding:.75rem}
  fieldset legend{padding:0 .35rem;color:#111827;font-weight:700}
  .choice{display:flex;gap:.6rem;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:.4rem;border:1px solid var(--border);border-radius:999px;padding:.25rem .55rem;background:#fff}
  .badge{display:inline-block;padding:.2rem .5rem;border-radius:999px;background:#f1f5f9;color:#0f172a;border:1px solid var(--border);font-size:.8rem}
  .sum{font-weight:800}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid var(--border);padding:.5rem;text-align:left}
  th{background:#f8fafc}
  .table-actions{display:flex;gap:.5rem}
  .subbtn{border:1px solid var(--border);background:#fff;padding:.35rem .55rem;border-radius:.45rem;cursor:pointer}
  .thumbs{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem}
  .thumb{position:relative}
  .thumb img{width:120px;height:120px;object-fit:cover;border:1px solid var(--border);border-radius:.5rem}
  .thumb .rm{position:absolute;top:6px;right:6px;border:1px solid #0002;background:#0006;color:#fff;border-radius:.35rem;padding:.15rem .35rem;cursor:pointer}
  .sig-wrap{border:1px dashed var(--border);border-radius:.6rem;padding:.75rem;background:#fff}
  canvas#sig{width:100%;height:180px;border:1px solid var(--border);border-radius:.5rem;background:#fff;touch-action:none}

  /* Feste Sendeleiste unten */
  .sendbar{
    position:fixed;left:0;right:0;bottom:0;background:linear-gradient(90deg,var(--primary),#981b1b);
    border-top:1px solid #0003; padding:.6rem 1rem; z-index:20;
  }
  .sendbar .inner{max-width:1100px;margin:0 auto;display:flex;gap:.6rem;align-items:center;justify-content:flex-end}
  .sendbtn{border:1px solid #ffffff66;background:#ffffff1a;color:#fff;padding:.55rem .9rem;border-radius:.55rem;font-weight:800;cursor:pointer}
  .sendbtn:disabled{opacity:.6;cursor:not-allowed}
  @media print{header,.hint,.btn,.subbtn,.sendbar{display:none!important} body{background:#fff}}
</style>
</head>
<body>

<header>
  <div class="bar">
    <h1><i class="fa-solid fa-file-medical"></i> Patientendokumentation</h1>
    <div class="toolbar">
      <button class="btn" onclick="openAll()"><i class="fa-solid fa-plus-square"></i> Alle aufklappen</button>
      <button class="btn" onclick="closeAll()"><i class="fa-solid fa-minus-square"></i> Alle zuklappen</button>
      <button class="btn" onclick="saveForm()"><i class="fa-solid fa-floppy-disk"></i> Speichern</button>
      <button class="btn" onclick="loadForm()"><i class="fa-solid fa-rotate"></i> Laden</button>
      <button class="btn" onclick="resetFormConfirm()"><i class="fa-solid fa-eraser"></i> Zurücksetzen</button>
      <!-- Absenden-Button ist unten als feste Leiste -->
    </div>
  </div>
</header>

<div class="wrap">
  <div class="hint">Alle Punkte aus der Vorlage – GCS & qSOFA automatisch, Fotos in Anamnese, Unterschrift am Ende. Daten bleiben lokal (localStorage).</div>

  <!-- Einsatzdaten -->
  <details open>
    <summary><i class="fa-solid fa-truck-medical"></i> Einsatzdaten</summary>
    <div class="sec-body">
      <div class="grid">
        <label>Einsatz-Nr.<input name="einsatz_nr" type="text"></label>
        <label>Pat./Auftrags-Nr.<input name="auftrags_nr" type="text"></label>
        <label>Rufname<input name="rufname" type="text"></label>
        <label>Fahrzeug<input name="fahrzeug" type="text" placeholder="z. B. 46/1"></label>
        <label>Datum/Uhrzeit<input name="zeit_einsatz" type="datetime-local"></label>
      </div>
      <label>Einsatz-Art<input name="einsatz_art" type="text" placeholder="z. B. Notfall, Verlegung …"></label>
    </div>
  </details>

  <!-- Pat-Stammdaten (Überweisungsschein entfernt) -->
  <details>
    <summary><i class="fa-solid fa-id-card-clip"></i> Pat-Stammdaten</summary>
    <div class="sec-body">
      <div class="grid">
        <label>Name*<input name="name" type="text"></label>
        <label>Vorname*<input name="vorname" type="text"></label>
        <label>Geb.-Datum*<input name="gebdatum" type="date"></label>
        <label>Alter<input name="alter" type="number" min="0"></label>
        <label>Telefon<input name="telefon" type="text"></label>
        <label>Mobil<input name="mobil" type="text"></label>
        <label>Straße<input name="strasse" type="text"></label>
        <label>PLZ, Ort<input name="plz_ort" type="text"></label>
        <label>Kasse / Nr.<input name="kasse" type="text"></label>
        <label>Vers.-Nr.<input name="versnr" type="text"></label>
        <label>Hausarzt / Tel.<input name="hausarzt" type="text"></label>
        <label>Zust. Angehöriger / Tel.<input name="angehoeriger" type="text"></label>
      </div>
      <div class="row">
        <label style="flex:1">Informationen / Aspekte (Ethik, BEV, Patientenverfügung, FIT-Status …)
          <textarea name="infos"></textarea>
        </label>
      </div>
    </div>
  </details>

  <!-- Notfallgeschehen / Anamnese (+ Fotos) -->
  <details>
    <summary><i class="fa-solid fa-notes-medical"></i> Notfallgeschehen / Anamnese / Erstbefund / Vormedikation / Vorbehandlung</summary>
    <div class="sec-body">
      <textarea name="notfallgeschehen" placeholder="Freitext …"></textarea>

      <div style="margin-top:.75rem">
        <label><strong>Fotos</strong> (Medikamentenliste, Befunde, Szene)</label>
        <input id="photoInput" type="file" accept="image/*" capture="environment" multiple>
        <div class="thumbs" id="thumbs"></div>
      </div>
    </div>
  </details>

  <!-- Neurologie -->
  <details>
    <summary><i class="fa-solid fa-brain"></i> Erstbefunde – Neurologie</summary>
    <div class="sec-body">
      <div class="row">
        <label>Zeitpunkt<input name="neu_zeit" type="datetime-local"></label>
        <label class="pill"><input type="checkbox" name="neu_unauff"> ohne path. Befund</label>
      </div>
      <div class="grid">
        <fieldset><legend>Pupillenweite – rechts</legend>
          <div class="choice">
            <label class="pill"><input type="radio" name="pw_r" value="eng"> eng</label>
            <label class="pill"><input type="radio" name="pw_r" value="mittel"> mittel</label>
            <label class="pill"><input type="radio" name="pw_r" value="weit"> weit</label>
            <label class="pill"><input type="checkbox" name="pw_r_entrundet"> entrundet</label>
          </div>
          <div class="choice"><span class="badge">Lichtreaktion</span>
            <label class="pill"><input type="radio" name="lr_r" value="prompt"> prompt</label>
            <label class="pill"><input type="radio" name="lr_r" value="träge"> träge</label>
            <label class="pill"><input type="radio" name="lr_r" value="keine"> keine</label>
          </div>
        </fieldset>
        <fieldset><legend>Pupillenweite – links</legend>
          <div class="choice">
            <label class="pill"><input type="radio" name="pw_l" value="eng"> eng</label>
            <label class="pill"><input type="radio" name="pw_l" value="mittel"> mittel</label>
            <label class="pill"><input type="radio" name="pw_l" value="weit"> weit</label>
            <label class="pill"><input type="checkbox" name="pw_l_entrundet"> entrundet</label>
          </div>
          <div class="choice"><span class="badge">Lichtreaktion</span>
            <label class="pill"><input type="radio" name="lr_l" value="prompt"> prompt</label>
            <label class="pill"><input type="radio" name="lr_l" value="träge"> träge</label>
            <label class="pill"><input type="radio" name="lr_l" value="keine"> keine</label>
          </div>
        </fieldset>
      </div>
    </div>
  </details>

  <!-- GCS -->
  <details>
    <summary><i class="fa-solid fa-eye"></i> Glasgow Coma Scale (auto)</summary>
    <div class="sec-body">
      <div class="grid">
        <fieldset><legend>Augenöffnung (E)</legend>
          <div class="choice">
            <label class="pill"><input type="radio" name="gcs_e" value="4" onchange="calcGCS()"> spontan (4)</label>
            <label class="pill"><input type="radio" name="gcs_e" value="3" onchange="calcGCS()"> auf Geräusch (3)</label>
            <label class="pill"><input type="radio" name="gcs_e" value="2" onchange="calcGCS()"> auf Druck (2)</label>
            <label class="pill"><input type="radio" name="gcs_e" value="1" onchange="calcGCS()"> keine (1)</label>
          </div>
        </fieldset>
        <fieldset><legend>Verbale Antwort (V)</legend>
          <div class="choice">
            <label class="pill"><input type="radio" name="gcs_v" value="5" onchange="calcGCS()"> orientiert (5)</label>
            <label class="pill"><input type="radio" name="gcs_v" value="4" onchange="calcGCS()"> verwirrt (4)</label>
            <label class="pill"><input type="radio" name="gcs_v" value="3" onchange="calcGCS()"> Wörter (3)</label>
            <label class="pill"><input type="radio" name="gcs_v" value="2" onchange="calcGCS()"> Laute (2)</label>
            <label class="pill"><input type="radio" name="gcs_v" value="1" onchange="calcGCS()"> keine (1)</label>
          </div>
        </fieldset>
        <fieldset><legend>Motorische Antwort (M)</legend>
          <div class="choice">
            <label class="pill"><input type="radio" name="gcs_m" value="6" onchange="calcGCS()"> folgt (6)</label>
            <label class="pill"><input type="radio" name="gcs_m" value="5" onchange="calcGCS()"> lokalisiert (5)</label>
            <label class="pill"><input type="radio" name="gcs_m" value="4" onchange="calcGCS()"> beugt normal (4)</label>
            <label class="pill"><input type="radio" name="gcs_m" value="3" onchange="calcGCS()"> beugt abnormal (3)</label>
            <label class="pill"><input type="radio" name="gcs_m" value="2" onchange="calcGCS()"> streckt (2)</label>
            <label class="pill"><input type="radio" name="gcs_m" value="1" onchange="calcGCS()"> keine (1)</label>
          </div>
        </fieldset>
      </div>
      <div class="row"><span class="badge">GCS Summe: <span id="gcs_sum" class="sum">—</span></span></div>
    </div>
  </details>

  <!-- Haut -->
  <details><summary><i class="fa-regular fa-hand"></i> Haut</summary>
    <div class="sec-body">
      <div class="choice">
        <label class="pill"><input type="checkbox" name="haut_unauff"> unauffällig</label>
        <label class="pill"><input type="checkbox" name="haut_falten"> stehende Hautfalten</label>
        <label class="pill"><input type="checkbox" name="haut_oedeme"> Ödeme</label>
        <label class="pill"><input type="checkbox" name="haut_dekubitus"> Dekubitus</label>
        <label class="pill"><input type="checkbox" name="haut_kaltschweissig"> kaltschweißig</label>
        <label class="pill"><input type="checkbox" name="haut_exanthem"> Exanthem</label>
      </div>
    </div>
  </details>

  <!-- Psyche -->
  <details><summary><i class="fa-solid fa-user"></i> Psyche</summary>
    <div class="sec-body">
      <div class="choice">
        <label class="pill"><input type="checkbox" name="psy_erregt"> erregt</label>
        <label class="pill"><input type="checkbox" name="psy_aggr"> aggressiv</label>
        <label class="pill"><input type="checkbox" name="psy_verlangsamt"> verlangsamt/stuporös</label>
        <label class="pill"><input type="checkbox" name="psy_depressiv"> depressiv</label>
        <label class="pill"><input type="checkbox" name="psy_aengstlich"> ängstlich</label>
        <label class="pill"><input type="checkbox" name="psy_euphorisch"> euphorisch</label>
        <label class="pill"><input type="checkbox" name="psy_wahnhaft"> wahnhaft</label>
        <label class="pill"><input type="checkbox" name="psy_verwirrt"> verwirrt</label>
        <label class="pill"><input type="checkbox" name="psy_suizidal"> suizidal</label>
        <label class="pill"><input type="checkbox" name="psy_motor_unruhig"> motorisch unruhig</label>
      </div>
    </div>
  </details>

  <!-- Messwerte initial / Atmung + qSOFA -->
  <details>
    <summary><i class="fa-solid fa-stethoscope"></i> Messwerte initial / Atmung</summary>
    <div class="sec-body">
      <div class="grid">
        <label>RR syst. (mmHg)<input name="rr_sys" type="number" oninput="calcQSOFA()"></label>
        <label>RR diast. (mmHg)<input name="rr_dia" type="number"></label>
        <label>HF (/min)<input name="hf" type="number"></label>
        <label>AF (/min)<input name="af" type="number" oninput="calcQSOFA()"></label>
        <label>SpO₂ (%)<input name="spo2" type="number"></label>
        <label>etCO₂ (mmHg)<input name="etco2" type="number"></label>
        <label>Temp (°C)<input name="temp" type="number" step="0.1"></label>
        <label>BZ (mg/dl)<input name="bz_mg" type="number"></label>
        <label>BZ (mmol/l)<input name="bz_mmol" type="number" step="0.1"></label>
        <label>Schmerz (0–10)<input name="schmerz" type="number" min="0" max="10"></label>
      </div>

      <fieldset style="margin-top:.8rem"><legend>qSOFA (auto)</legend>
        <div class="grid">
          <label>GCS (aus GCS-Block)<input name="qsofa_gcs" type="number" readonly></label>
          <label>AF (/min)<input name="qsofa_af" type="number" readonly></label>
          <label>RR syst. (mmHg)<input name="qsofa_rr" type="number" readonly></label>
        </div>
        <div class="row" style="margin-top:.4rem">
          <span class="badge">qSOFA-Score: <span id="qsofa_sum" class="sum">—</span></span>
        </div>
      </fieldset>

      <fieldset style="margin-top:.6rem"><legend>Atmung – klinische Zeichen</legend>
        <div class="choice">
          <label class="pill"><input type="checkbox" name="atm_apnoe"> Apnoe</label>
          <label class="pill"><input type="checkbox" name="atm_stridor"> Stridor</label>
          <label class="pill"><input type="checkbox" name="atm_hypervent"> Hyperventilation</label>
          <label class="pill"><input type="checkbox" name="atm_dyspnoe"> Dyspnoe</label>
          <label class="pill"><input type="checkbox" name="atm_beatmung"> Beatmung</label>
          <label class="pill"><input type="checkbox" name="atm_zyanose"> Zyanose</label>
          <label class="pill"><input type="checkbox" name="atm_verlegung"> Atemwegsverlegung</label>
        </div>
        <textarea name="atm_sonst" placeholder="Sonstiges Atemmuster …"></textarea>
      </fieldset>
      <fieldset style="margin-top:.6rem"><legend>O₂-Gabe</legend>
        <div class="choice">
          <label class="pill"><input type="radio" name="o2" value="raumluft"> Raumluft</label>
          <label class="pill"><input type="radio" name="o2" value="unter_o2"> unter O₂</label>
          <label class="pill"><input type="checkbox" name="o2_nasal"> Nasensonde</label>
          <label class="pill"><input type="checkbox" name="o2_maske"> Maske</label>
          <label class="pill"><input type="checkbox" name="o2_reservoir"> Maske m. Reservoir</label>
        </div>
        <div class="grid" style="margin-top:.4rem">
          <label>Flow (l/min)<input name="o2_flow" type="number" step="0.5"></label>
          <label>Kommentar<input name="o2_comment" type="text"></label>
        </div>
      </fieldset>
    </div>
  </details>

  <!-- Rhythmus / EKG -->
  <details>
    <summary><i class="fa-solid fa-heart-pulse"></i> Rhythmus / EKG</summary>
    <div class="sec-body">
      <div class="choice">
        <label class="pill"><input type="checkbox" name="sr"> Sinusrhythmus</label>
        <label class="pill"><input type="checkbox" name="stemi"> STEMI</label>
        <label class="pill"><input type="checkbox" name="arrh_abs"> absolute Arrhythmie</label>
        <label class="pill"><input type="checkbox" name="vf"> Kammerflimmern</label>
        <label class="pill"><input type="checkbox" name="av3"> AV-Block III°</label>
        <label class="pill"><input type="checkbox" name="asystole"> Asystolie</label>
      </div>
      <div class="grid" style="margin-top:.5rem">
        <label>Standort<input name="ekg_standort" type="text"></label>
        <label>Pers-Nr.<input name="ekg_persnr" type="text"></label>
      </div>
    </div>
  </details>

  <!-- Verletzungen -->
  <details><summary><i class="fa-solid fa-kit-medical"></i> Verletzungen</summary>
    <div class="sec-body"><textarea name="verletz_text" placeholder="Beschreibung …"></textarea></div>
  </details>

  <!-- Erstdiagnosen -->
  <details><summary><i class="fa-solid fa-clipboard-list"></i> Erstdiagnosen (Auswahl)</summary>
    <div class="sec-body">
      <div class="grid">
        <fieldset><legend>Neuro</legend>
          <div class="choice">
            <label class="pill"><input type="checkbox" name="diag_krampf"> Konvulsionen</label>
            <label class="pill"><input type="checkbox" name="diag_synkope"> Synkope</label>
            <label class="pill"><input type="checkbox" name="diag_apoplex"> Apoplex</label>
            <label class="pill"><input type="checkbox" name="diag_sht"> SHT</label>
          </div>
        </fieldset>
        <fieldset><legend>Herz-Kreislauf</legend>
          <div class="choice">
            <label class="pill"><input type="checkbox" name="diag_acs"> ACS</label>
            <label class="pill"><input type="checkbox" name="diag_insuff"> akute Herzinsuffizienz</label>
            <label class="pill"><input type="checkbox" name="diag_lungenoedem"> Lungenödem</label>
            <label class="pill"><input type="checkbox" name="diag_luembol"> Lungenembolie</label>
          </div>
        </fieldset>
        <fieldset><legend>Atmung</legend>
          <div class="choice">
            <label class="pill"><input type="checkbox" name="diag_resp_insuff"> resp. Insuffizienz</label>
            <label class="pill"><input type="checkbox" name="diag_pneumothorax"> (Spannungs-)Pneumothorax</label>
            <label class="pill"><input type="checkbox" name="diag_asthma"> Asthma/COPD</label>
          </div>
        </fieldset>
        <fieldset><legend>Stoffwechsel / Schock</legend>
          <div class="choice">
            <label class="pill"><input type="checkbox" name="diag_hypo"> Hypoglykämie</label>
            <label class="pill"><input type="checkbox" name="diag_sept"> septischer Schock</label>
            <label class="pill"><input type="checkbox" name="diag_hypovol"> hypovolämischer Schock</label>
          </div>
        </fieldset>
      </div>
    </div>
  </details>

  <!-- Bewusstseinslage / AZ / Versorgung -->
  <details>
    <summary><i class="fa-solid fa-face-meh"></i> Bewusstseinslage, AZ, Versorgung</summary>
    <div class="sec-body">
      <div class="grid">
        <fieldset><legend>Bewusstseinslage</legend>
          <div class="choice">
            <label class="pill"><input type="checkbox" name="bew_wach"> wach</label>
            <label class="pill"><input type="checkbox" name="bew_ansprache"> Reaktion auf Ansprache</label>
            <label class="pill"><input type="checkbox" name="bew_schmerz"> Reaktion auf Schmerzreiz</label>
            <label class="pill"><input type="checkbox" name="bew_bewusstlos"> bewusstlos</label>
          </div>
        </fieldset>
        <fieldset><legend>Allgemeinzustand</legend>
          <div class="choice">
            <label class="pill"><input type="radio" name="az" value="gesund"> gesund</label>
            <label class="pill"><input type="radio" name="az" value="leicht"> leicht eingeschränkt</label>
            <label class="pill"><input type="radio" name="az" value="deutlich"> deutlich eingeschränkt</label>
          </div>
        </fieldset>
        <fieldset><legend>Versorgungssituation</legend>
          <div class="choice">
            <label class="pill"><input type="radio" name="versorgung" value="unabhaengig"> unabhängig</label>
            <label class="pill"><input type="radio" name="versorgung" value="pflege_zuhaus"> Pflege zuhause</label>
            <label class="pill"><input type="radio" name="versorgung" value="pflege_institution"> Pflege in Institution</label>
          </div>
        </fieldset>
      </div>
    </div>
  </details>

  <!-- Maßnahmen – Zugang & Infusion / Medikation -->
  <details>
    <summary><i class="fa-solid fa-syringe"></i> Maßnahmen – Zugang & Infusion / Medikation</summary>
    <div class="sec-body">
      <fieldset><legend>Zugang</legend>
        <div class="grid">
          <label>Art
            <select name="zugang_art">
              <option value=""></option><option value="iv">i.v.</option><option value="io">i.o.</option>
            </select>
          </label>
          <label>Seite/Region<input name="zugang_region" type="text"></label>
          <label>Größe (G)<input name="zugang_gauge" type="number" min="14" max="24"></label>
          <label>Versuche (#)<input name="zugang_versuche" type="number" min="0"></label>
          <label>Zeitpunkt<input name="zugang_zeit" type="datetime-local"></label>
        </div>
      </fieldset>

      <fieldset style="margin-top:.75rem"><legend>Infusion</legend>
        <div class="grid">
          <label>Art<input name="inf_art" type="text" placeholder="NaCl 0,9% …"></label>
          <label>Menge (ml)<input name="inf_menge" type="number" min="0" step="50"></label>
          <label>Laufrate (ml/h)<input name="inf_rate" type="number" min="0" step="10"></label>
          <label>Bemerkung<input name="inf_bem" type="text"></label>
        </div>
      </fieldset>

      <fieldset style="margin-top:.75rem"><legend>Medikamente</legend>
        <div class="table-actions">
          <button class="subbtn" type="button" onclick="addMedRow()"><i class="fa-solid fa-plus"></i> Zeile hinzufügen</button>
        </div>
        <div style="overflow:auto;margin-top:.5rem">
          <table id="medTable">
            <thead><tr>
              <th>#</th><th>Medikament</th><th>Dosis</th><th>Einheit</th><th>Route</th><th>Uhrzeit</th><th>Bemerkung</th><th>Aktion</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </fieldset>
    </div>
  </details>

  <!-- Beatmung / Atemweg -->
  <details>
    <summary><i class="fa-solid fa-wind"></i> Beatmung / Atemweg</summary>
    <div class="sec-body">
      <div class="choice">
        <label class="pill"><input type="checkbox" name="aw_guedel"> Guedel</label>
        <label class="pill"><input type="checkbox" name="aw_larynxtubus"> Larynxtubus</label>
        <label class="pill"><input type="checkbox" name="aw_ett"> ETT</label>
        <label class="pill"><input type="checkbox" name="aw_bvm"> BVM</label>
      </div>
      <div class="grid" style="margin-top:.5rem">
        <label>ETT-Größe<input name="aw_ett_size" type="number" step="0.5"></label>
        <label>PEEP (cmH₂O)<input name="vent_peep" type="number" step="1"></label>
        <label>FiO₂ (%)<input name="vent_fio2" type="number" min="21" max="100"></label>
      </div>
    </div>
  </details>

  <!-- Reanimation -->
  <details>
    <summary><i class="fa-solid fa-heart-circle-bolt"></i> Reanimation</summary>
    <div class="sec-body">
      <div class="grid">
        <label>Rea-Beginn<input name="rea_beginn" type="datetime-local"></label>
        <label>Erst-Rhythmus
          <select name="rea_initial"><option value=""></option><option>Asystolie</option><option>PEA</option><option>VF</option><option>pVT</option></select>
        </label>
        <label>Schocks (#)<input name="rea_shocks" type="number" min="0"></label>
        <label>ROSC?<select name="rea_rosc"><option value=""></option><option>ja</option><option>nein</option></select></label>
        <label>Rea-Ende (Uhrzeit)<input name="rea_ende" type="time"></label>
      </div>
    </div>
  </details>

  <!-- Übergabe / Transport / Ziel -->
  <details>
    <summary><i class="fa-solid fa-people-carry-box"></i> Übergabe / Transport / Ziel</summary>
    <div class="sec-body">
      <div class="grid">
        <label>Übergabe an (Name)<input name="ue_name" type="text"></label>
        <label>Zeitpunkt Übergabe<input name="ue_zeit" type="datetime-local"></label>
        <label>Ziel (Klinik/Praxis)<input name="ziel_bez" type="text"></label>
        <label>Adresse<input name="ziel_adr" type="text"></label>
        <label>Einsatzende<input name="einsatzende" type="datetime-local"></label>
      </div>
    </div>
  </details>

  <!-- qSOFA (Zusammenfassung unten optional sichtbar) -->
  <details>
    <summary><i class="fa-solid fa-scale-balanced"></i> qSOFA (auto)</summary>
    <div class="sec-body">
      <div class="grid">
        <label>GCS Summe (auto)<input name="qsofa_gcs2" type="number" readonly></label>
        <label>AF (/min)<input name="qsofa_af2" type="number" readonly></label>
        <label>RR syst. (mmHg)<input name="qsofa_rr2" type="number" readonly></label>
      </div>
      <div class="row" style="margin-top:.5rem"><span class="badge">qSOFA-Score: <span id="qsofa_sum2" class="sum">—</span></span></div>
    </div>
  </details>

  <!-- Ausfüller & digitale Unterschrift -->
  <details open>
    <summary><i class="fa-solid fa-signature"></i> Ausfüller & digitale Unterschrift</summary>
    <div class="sec-body">
      <div class="grid">
        <label>Name des Ausfüllers<input name="ausfueller_name" type="text" placeholder="z. B. M. Mustermann"></label>
        <label>Datum/Uhrzeit<input name="ausfueller_zeit" type="datetime-local"></label>
      </div>
      <div class="sig-wrap" style="margin-top:.5rem">
        <label>Unterschrift (Finger/Maus)</label>
        <canvas id="sig"></canvas>
        <div class="row" style="margin-top:.5rem">
          <button class="subbtn" type="button" id="sigClear"><i class="fa-solid fa-eraser"></i> Signatur löschen</button>
        </div>
      </div>
    </div>
  </details>
</div>

<!-- Feste Absende-Leiste unten -->
<div class="sendbar">
  <div class="inner">
    <button id="sendBtn" class="sendbtn" onclick="submitToBackend()">
      <i class="fa-solid fa-paper-plane"></i> Absenden
    </button>
  </div>
</div>

<script>
  /* ===== Accordion ===== */
  function openAll(){ document.querySelectorAll('details').forEach(d=>d.open=true); }
  function closeAll(){ document.querySelectorAll('details').forEach(d=>d.open=false); }

  /* ===== Medikamente-Tabelle ===== */
  const medTbody = () => document.querySelector('#medTable tbody');
  function addMedRow(data={}){ const tb=medTbody(); const idx=tb.children.length+1; const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${idx}</td>
      <td><input name="med_name_${idx}" type="text" value="${data.name||''}"></td>
      <td><input name="med_dose_${idx}" type="text" value="${data.dose||''}"></td>
      <td><input name="med_unit_${idx}" type="text" value="${data.unit||''}" placeholder="mg/ml/µg"></td>
      <td>
        <select name="med_route_${idx}">
          <option value=""></option>
          <option ${data.route==='i.v.'?'selected':''}>i.v.</option>
          <option ${data.route==='i.o.'?'selected':''}>i.o.</option>
          <option ${data.route==='i.m.'?'selected':''}>i.m.</option>
          <option ${data.route==='i.n.'?'selected':''}>i.n.</option>
          <option ${data.route==='p.o.'?'selected':''}>p.o.</option>
        </select>
      </td>
      <td><input name="med_time_${idx}" type="time" value="${data.time||''}"></td>
      <td><input name="med_note_${idx}" type="text" value="${data.note||''}"></td>
      <td><button class="subbtn" type="button" onclick="delMedRow(this)">Löschen</button></td>`;
    tb.appendChild(tr);
  }
  function delMedRow(btn){ const tr=btn.closest('tr'); tr.remove(); medTbody().querySelectorAll('tr').forEach((row,i)=> row.children[0].textContent=i+1 ); }
  addMedRow(); addMedRow(); addMedRow();

  /* ===== GCS & qSOFA ===== */
  function calcGCS(){
    const e=+document.querySelector('input[name="gcs_e"]:checked')?.value||0;
    const v=+document.querySelector('input[name="gcs_v"]:checked')?.value||0;
    const m=+document.querySelector('input[name="gcs_m"]:checked')?.value||0;
    const sum=e+v+m||null;
    document.getElementById('gcs_sum').textContent=sum??'—';
    document.querySelector('input[name="qsofa_gcs"]').value=sum??'';
    document.querySelector('input[name="qsofa_gcs2"]').value=sum??'';
    calcQSOFA();
  }
  function calcQSOFA(){
    const gcs=parseInt(document.querySelector('input[name="qsofa_gcs"]').value||0);
    const af =parseInt(document.querySelector('input[name="af"]').value||0);
    const rr =parseInt(document.querySelector('input[name="rr_sys"]').value||0);
    document.querySelector('input[name="qsofa_af"]').value = isNaN(af)?'':af;
    document.querySelector('input[name="qsofa_rr"]').value = isNaN(rr)?'':rr;
    document.querySelector('input[name="qsofa_af2"]').value= isNaN(af)?'':af;
    document.querySelector('input[name="qsofa_rr2"]').value= isNaN(rr)?'':rr;
    let score=0; if(gcs && gcs<15) score++; if(af && af>=22) score++; if(rr && rr<=100) score++;
    document.getElementById('qsofa_sum').textContent=score||'0';
    document.getElementById('qsofa_sum2').textContent=score||'0';
  }
  document.addEventListener('input',(e)=>{
    if(['af','rr_sys'].includes(e.target.name)) calcQSOFA();
    if(['gcs_e','gcs_v','gcs_m'].includes(e.target.name)) calcGCS();
  });

  /* ===== Fotos (lokal, mit Kompression) ===== */
  const photoInput=document.getElementById('photoInput'); const thumbs=document.getElementById('thumbs'); let photos=[];
  photoInput?.addEventListener('change', async (e)=>{
    const files=[...e.target.files||[]];
    for(const f of files){
      // stärkere Kompression:
      const url=await compressImage(f,1024,1024,0.65);
      photos.push(url);
    }
    renderThumbs(); autoSave(); photoInput.value='';
  });
  function renderThumbs(){ thumbs.innerHTML=''; photos.forEach((src,i)=>{ const d=document.createElement('div'); d.className='thumb';
    const img=new Image(); img.src=src; d.appendChild(img);
    const b=document.createElement('button'); b.className='rm'; b.innerHTML='&times;';
    b.onclick=()=>{ photos.splice(i,1); renderThumbs(); autoSave(); };
    d.appendChild(b); thumbs.appendChild(d);
  });}
  function compressImage(file,maxW,maxH,q){
    return new Promise((res,rej)=>{
      const r=new FileReader();
      r.onload=()=>{ const img=new Image(); img.onload=()=>{ const s=Math.min(maxW/img.width,maxH/img.height,1);
        const w=img.width*s,h=img.height*s; const c=document.createElement('canvas'); c.width=w;c.height=h;
        c.getContext('2d').drawImage(img,0,0,w,h); res(c.toDataURL('image/jpeg',q)); };
        img.onerror=rej; img.src=r.result; };
      r.onerror=rej; r.readAsDataURL(file);
    });
  }

  /* ===== Unterschrift (Canvas) ===== */
  const sig=document.getElementById('sig'); const sctx=sig.getContext('2d');
  let drawing=false,last={x:0,y:0}, signatureData='';
  function resizeSig(){ const dpr=window.devicePixelRatio||1; const w=sig.clientWidth,h=sig.clientHeight;
    sig.width=Math.floor(w*dpr); sig.height=Math.floor(h*dpr); sctx.setTransform(dpr,0,0,dpr,0,0);
    sctx.lineWidth=2; sctx.lineJoin='round'; sctx.lineCap='round'; sctx.strokeStyle='#111';
    if(signatureData){ const img=new Image(); img.onload=()=>sctx.drawImage(img,0,0,w,h); img.src=signatureData; }
  }
  function pos(ev){ const r=sig.getBoundingClientRect();
    if(ev.touches?.[0]) return {x:ev.touches[0].clientX-r.left,y:ev.touches[0].clientY-r.top};
    return {x:ev.clientX-r.left,y:ev.clientY-r.top};
  }
  function start(ev){ drawing=true; last=pos(ev); ev.preventDefault(); }
  function move(ev){ if(!drawing) return; const p=pos(ev); sctx.beginPath(); sctx.moveTo(last.x,last.y); sctx.lineTo(p.x,p.y); sctx.stroke(); last=p; ev.preventDefault(); autoSaveSig(); }
  function end(){ drawing=false; autoSaveSig(); }
  function autoSaveSig(){ try{
      const w=sig.clientWidth,h=sig.clientHeight; if(w&&h){ const tmp=document.createElement('canvas'); tmp.width=w; tmp.height=h;
        tmp.getContext('2d').drawImage(sig,0,0,w,h); signatureData=tmp.toDataURL('image/png'); autoSave(); }
    }catch(_){}
  }
  window.addEventListener('resize',resizeSig);
  sig.addEventListener('mousedown',start); sig.addEventListener('mousemove',move); sig.addEventListener('mouseup',end); sig.addEventListener('mouseleave',end);
  sig.addEventListener('touchstart',start,{passive:false}); sig.addEventListener('touchmove',move,{passive:false}); sig.addEventListener('touchend',end);
  document.getElementById('sigClear').addEventListener('click',()=>{ sctx.clearRect(0,0,sig.width,sig.height); signatureData=''; autoSave(); });

  /* ===== Speichern / Laden / Reset ===== */
  const STORAGE_KEY='patientendoku_v3_full';
  function serializeMedRows(){ const rows=[]; medTbody().querySelectorAll('tr').forEach((tr,i)=>{ const idx=i+1, get=n=>tr.querySelector(`[name="${n}_${idx}"]`);
    rows.push({name:get('med_name')?.value||'',dose:get('med_dose')?.value||'',unit:get('med_unit')?.value||'',route:get('med_route')?.value||'',time:get('med_time')?.value||'',note=get('med_note')?.value||''});
  }); return rows; }
  function hydrateMedRows(rows){ medTbody().innerHTML=''; (rows && rows.length? rows : [{},{},{}]).forEach(r=>addMedRow(r)); }
  function saveForm(){ const data=collectFormData(); localStorage.setItem(STORAGE_KEY,JSON.stringify(data)); alert('Formular lokal gespeichert.'); }
  function autoSave(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(collectFormData())); }catch(_){ } }
  function collectFormData(){
    const data={}; document.querySelectorAll('input, textarea, select').forEach(el=>{
      if(!el.name) return; if(el.type==='checkbox') data[el.name]=el.checked; else if(el.type==='radio'){ if(el.checked) data[el.name]=el.value; } else data[el.name]=el.value;
    });
    data.__gcs_sum=document.getElementById('gcs_sum')?.textContent||'';
    data.__qsofa_sum=document.getElementById('qsofa_sum')?.textContent||'';
    data.__qsofa_sum2=document.getElementById('qsofa_sum2')?.textContent||'';
    data.__med_rows=serializeMedRows(); data.__photos=photos.slice(); data.__signature=signatureData||'';
    return data;
  }
  function loadForm(){ const raw=localStorage.getItem(STORAGE_KEY); if(!raw){alert('Keine gespeicherten Daten.');return;}
    const data=JSON.parse(raw); applyData(data); alert('Formular geladen.'); }
  function applyData(data){
    hydrateMedRows(data.__med_rows);
    document.querySelectorAll('input, textarea, select').forEach(el=>{
      if(!(el.name in data)) return; if(el.type==='checkbox') el.checked=!!data[el.name]; else if(el.type==='radio') el.checked=(data[el.name]===el.value); else el.value=data[el.name];
    });
    document.getElementById('gcs_sum').textContent=data.__gcs_sum||'—';
    document.getElementById('qsofa_sum').textContent=data.__qsofa_sum||'—';
    document.getElementById('qsofa_sum2').textContent=data.__qsofa_sum2||'—';
    photos=Array.isArray(data.__photos)? data.__photos.slice() : []; renderThumbs(); signatureData=data.__signature||''; resizeSig(); calcQSOFA();
  }
  function resetFormConfirm(){ if(!confirm('Formular wirklich zurücksetzen?')) return;
    document.querySelectorAll('input, textarea, select').forEach(el=>{ if(el.type==='checkbox'||el.type==='radio') el.checked=false; else el.value=''; });
    hydrateMedRows(null); photos=[]; renderThumbs(); signatureData=''; resizeSig();
    document.getElementById('gcs_sum').textContent='—'; document.getElementById('qsofa_sum').textContent='—'; document.getElementById('qsofa_sum2').textContent='—';
    localStorage.removeItem(STORAGE_KEY);
  }

  /* ===== ABSENDEN an Backend ===== */
  const SUBMIT_URL='/.netlify/functions/patientendokumentation-dateien';

  async function submitToBackend(){
    const btn=document.getElementById('sendBtn');
    try{
      btn.disabled=true; btn.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Sende...';
      const data=collectFormData();
      const submitterName=data.ausfueller_name||''; const authorSignature=data.__signature||'';

      if(!data.name || !data.vorname){
        alert('Bitte Name und Vorname des Patienten ausfüllen.');
        btn.disabled=false; btn.innerHTML='<i class="fa-solid fa-paper-plane"></i> Absenden'; return;
      }

      const res=await fetch(SUBMIT_URL,{
        method:'POST',
        headers:{'Content-Type':'application/json','Accept':'application/json'},
        body:JSON.stringify({ formData:data, submitterName, authorSignature })
      });
      const text=await res.text(); let out={}; try{ out=JSON.parse(text);}catch{}
      if(!res.ok || !out?.ok) throw new Error(out?.error || ('HTTP '+res.status));

      alert('Einsendung erfolgreich.\nID: '+out.id+'\nDie Doku erscheint im Admin-Dashboard unter „Patientendokumentation“.');
      // resetFormConfirm(); // optional
    }catch(e){
      alert('Fehler beim Absenden: ' + (e?.message||e));
    }finally{
      btn.disabled=false; btn.innerHTML='<i class="fa-solid fa-paper-plane"></i> Absenden';
    }
  }

  // initial
  addEventListener('load',()=>{ resizeSig(); calcGCS(); calcQSOFA(); });
</script>
</body>
</html>
