<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FFW – Dokumente bearbeiten (Debug)</title>
<link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{ --rot:#c8102e; --grau:#6b7280 }
  *{ box-sizing:border-box }
  body{ font-family:'Atkinson Hyperlegible',system-ui,Arial,sans-serif; margin:0; background:#f7f7f7; color:#1f2937 }
  header{ background:var(--rot); color:#fff; padding:12px 16px; position:sticky; top:0; z-index:10 }
  .brand{ font-weight:800; font-size:18px; }
  .nav{ float:right; display:flex; gap:10px }
  .btn{ border:0; background:var(--rot); color:#fff; padding:9px 12px; border-radius:10px; font-weight:700; cursor:pointer }
  .btn.secondary{ background:#fff; color:var(--rot); border:2px solid #fff; }
  .btn.ghost{ background:#fff; color:var(--rot); border:2px solid var(--rot); }
  .btn.small{ padding:6px 10px; border-radius:8px; font-weight:700; }
  .wrap{ max-width:980px; margin:18px auto; padding:0 12px }
  .card{ background:#fff; border-radius:14px; box-shadow:0 6px 20px rgba(0,0,0,.06); padding:16px; }
  h1{ margin:0 0 6px 0; font-size:28px; color:var(--rot) }
  .tabs{ display:flex; gap:10px; margin:12px 0 8px }
  .tab{ background:#f1f5f9; color:#0f172a; border-radius:999px; padding:8px 14px; font-weight:800; cursor:pointer }
  .tab.active{ background:var(--rot); color:#fff }
  table{ width:100%; border-collapse:collapse; margin-top:8px }
  th,td{ padding:12px; border-bottom:1px solid #eef2f7; vertical-align:top }
  th{ color:var(--rot); background:#fff; text-align:left }
  tr:hover{ background:#fff8f8 }
  .muted{ color:var(--grau) }
  .status{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#fee2e2; color:#991b1b }
  .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
  .right{ margin-left:auto }
  .msg{ margin-top:10px; min-height:1.2em }
  .msg.err{ color:#b91c1c }
  .msg.ok{ color:#166534 }
  dialog{ width:min(820px, 96vw); border:0; border-radius:14px; padding:0; box-shadow:0 20px 60px rgba(0,0,0,.25) }
  dialog::backdrop{ background:rgba(0,0,0,.35) }
  .modal-hd{ background:var(--rot); color:#fff; padding:12px 16px; border-radius:14px 14px 0 0; font-weight:800 }
  .modal-bd{ padding:14px 16px; }
  pre.json{ background:#0f172a; color:#e5e7eb; padding:12px; border-radius:10px; overflow:auto; max-height:50vh }
  .kbd{ font-family:ui-monospace, SFMono-Regular, Menlo, monospace; background:#f3f4f6; padding:2px 6px; border-radius:6px; }
</style>
</head>
<body>
<header>
  <div class="row">
    <div class="brand">FFW – Dokumente bearbeiten</div>
    <div class="right nav">
      <a class="btn secondary" href="admin-dashboard.html">Dashboard</a>
      <button id="logoutBtn" class="btn">Logout</button>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <h1>Dokumente</h1>
    <div class="tabs">
      <button id="tab-open"   class="tab active">Offen</button>
      <button id="tab-archiv" class="tab">Archiv (30 Tage)</button>
    </div>

    <div id="docs-error" class="msg err"></div>

    <table>
      <thead>
        <tr>
          <th style="width:120px">Typ</th>
          <th>Titel</th>
          <th style="width:160px">Erstellt</th>
          <th style="width:260px">Aktionen</th>
        </tr>
      </thead>
      <tbody id="docs-body">
        <tr><td colspan="4" class="muted">Lade …</td></tr>
      </tbody>
    </table>
  </div>
</div>

<dialog id="dlg">
  <div class="modal-hd row">
    <div id="dlg-title">Dokument</div>
    <div class="right"><button class="btn small ghost" onclick="closeDlg()">Schließen</button></div>
  </div>
  <div class="modal-bd">
    <div class="row">
      <div><span class="muted">Typ:</span> <b id="dlg-type">–</b></div>
      <div><span class="muted">Erstellt:</span> <b id="dlg-created">–</b></div>
      <div class="right"><span class="status" id="dlg-status">–</span></div>
    </div>
    <h3>Inhalt</h3>
    <pre id="dlg-json" class="json">{}</pre>
    <div class="row">
      <button id="dlg-pdf" class="btn small">PDF erstellen</button>
      <button id="dlg-done" class="btn small" style="background:#065f46">Als erledigt markieren</button>
    </div>
  </div>
</dialog>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js" crossorigin="anonymous"></script>
<script src="nhost-js.umd.js"></script>

<script>
/* ===== 0) DEBUG-WATCHDOG: zeige JEDE Fehlermeldung sichtbar oben ===== */
const $err  = document.getElementById('docs-error');
window.addEventListener('error', (e) => {
  $err.textContent = 'JS-Fehler: ' + (e?.message || e);
});
window.addEventListener('unhandledrejection', (e) => {
  $err.textContent = 'Promise-Fehler: ' + (e?.reason?.message || e?.reason || '');
});

/* ===== 1) Admin-Guard (still, ohne Popup) ===== */
const NHOST_SUBDOMAIN = 'hpjfrhktprpuuxvvlpsb';
const NHOST_REGION    = 'eu-central-1';
if (!window.Nhost) {
  $err.textContent = 'Nhost-Bibliothek fehlt (nhost-js.umd.js nicht gefunden).';
}
const nhost = window.Nhost ? new window.Nhost.NhostClient({ subdomain: NHOST_SUBDOMAIN, region: NHOST_REGION }) : null;

async function ensureAdmin() {
  if (!nhost) return false;
  try { await nhost.auth.refreshSession().catch(()=>{}); } catch {}
  const u = await nhost.auth.getUser();
  if (!u.user) { location.href = 'admin-login.html?redirect=' + encodeURIComponent(location.pathname); return false; }
  const session = await nhost.auth.getSession();
  const token = session?.accessToken || '';
  let isAdmin = false;
  try {
    const payload = JSON.parse(atob((token.split('.')[1]||'e30=')));
    const roles = payload['https://hasura.io/jwt/claims']?.['x-hasura-allowed-roles'] || [];
    isAdmin = roles.includes('admin');
  } catch {}
  if (!isAdmin) { location.href = 'admin-login.html?redirect=' + encodeURIComponent(location.pathname); return false; }
  return true;
}

/* ===== 2) GraphQL über Netlify Function ===== */
async function gql(query, variables = {}) {
  const resp = await fetch('/.netlify/functions/graphql', {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    body: JSON.stringify({ query, variables })
  }).catch(err => {
    throw new Error('Netzwerkfehler zum Function-Endpoint (/.netlify/functions/graphql): ' + err.message);
  });
  if (!resp.ok) {
    const text = await resp.text().catch(()=> '');
    throw new Error(`HTTP ${resp.status}: ${text || 'Request failed'}`);
  }
  const json = await resp.json().catch(()=> ({}));
  if (json.errors?.length) {
    throw new Error(json.errors.map(e=>e.message).join(' · '));
  }
  return json.data;
}

/* ===== 3) UI-State ===== */
let activeTab = 'open';
const $body = document.getElementById('docs-body');
const $tabOpen   = document.getElementById('tab-open');
const $tabArchiv = document.getElementById('tab-archiv');

/* ===== 4) Laden & Rendern (mit 8s Timeout) ===== */
function fmtDate(s){ try{return new Date(s).toLocaleString('de-DE')}catch{return s||'–'} }
function escapeHtml(s){ return (s+'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&gt;','>':'&lt;','"':'&quot;',"'":'&#039;' }[m])); }
function slim(d){ return { id:d.id, type:d.type, title:d.title, status:d.status, created_at:d.created_at, payload:d.payload, archived_until:d.archived_until }; }

async function loadDocs(){
  $err.textContent = '';
  $body.innerHTML = `<tr><td colspan="4" class="muted">Lade …</td></tr>`;

  // Timeout gegen „ewig Laden“
  const timeout = new Promise((_,rej)=> setTimeout(()=>rej(new Error('Timeout nach 8s – keine Antwort vom Backend. Prüfe Netlify Function & Variablen.')), 8000));

  try {
    const openQuery = `
      query {
        documents(where:{status:{_eq:"offen"}}, order_by:{created_at:desc}){
          id type title status created_at payload
        }
      }`;
    const archQuery = `
      query {
        documents(
          where:{ _and:[
            {status:{_eq:"erledigt"}},
            {archived_until:{ _gt: "now()" }}
          ]}
          , order_by:{created_at:desc}
        ){
          id type title status created_at payload archived_until
        }
      }`;

    const data = await Promise.race([gql(activeTab==='open'?openQuery:archQuery), timeout]);
    const rows = data?.documents || [];
    if (!rows.length){
      $body.innerHTML = `<tr><td colspan="4" class="muted">Keine Dokumente vorhanden.</td></tr>`;
      return;
    }
    $body.innerHTML = rows.map(d => `
      <tr>
        <td><span class="kbd">${escapeHtml(d.type||'–')}</span></td>
        <td>${escapeHtml(d.title||'–')}</td>
        <td>${fmtDate(d.created_at)}</td>
        <td>
          <div class="row">
            <button class="btn small ghost" onclick='openDlg(${JSON.stringify(slim(d))})'>Ansehen</button>
            <button class="btn small" onclick='makePdf(${JSON.stringify(slim(d))})'>PDF</button>
            ${activeTab==='open'
              ? `<button class="btn small" style="background:#065f46" onclick='markDone("${d.id}")'>Als erledigt</button>`
              : `<span class="muted">bis ${fmtDate(d.archived_until)}</span>`
            }
          </div>
        </td>
      </tr>
    `).join('');
  } catch(e){
    $err.textContent = 'Fehler beim Laden: ' + e.message;
    $body.innerHTML = `<tr><td colspan="4" class="muted">–</td></tr>`;
  }
}

/* ===== 5) Detail / PDF / Erledigt ===== */
const $dlg = document.getElementById('dlg');
const $dlgTitle   = document.getElementById('dlg-title');
const $dlgType    = document.getElementById('dlg-type');
const $dlgCreated = document.getElementById('dlg-created');
const $dlgStatus  = document.getElementById('dlg-status');
const $dlgJson    = document.getElementById('dlg-json');
const $dlgPdf     = document.getElementById('dlg-pdf');
const $dlgDone    = document.getElementById('dlg-done');
let dlgDoc = null;

function openDlg(doc){
  dlgDoc = doc;
  $dlgTitle.textContent   = doc.title || 'Dokument';
  $dlgType.textContent    = doc.type || '–';
  $dlgCreated.textContent = fmtDate(doc.created_at);
  $dlgStatus.textContent  = doc.status || '–';
  $dlgJson.textContent    = JSON.stringify(doc.payload || {}, null, 2);
  $dlgDone.style.display  = (doc.status==='offen')?'inline-block':'none';
  $dlg.showModal();
}
function closeDlg(){ $dlg.close(); }
$dlgPdf.addEventListener('click', ()=> dlgDoc && makePdf(dlgDoc));
$dlgDone.addEventListener('click', ()=> dlgDoc && markDone(dlgDoc.id));

async function markDone(id){
  try{
    const until = new Date(Date.now()+30*24*60*60*1000).toISOString();
    await gql(`mutation($id:uuid!,$until:timestamptz!){
      update_documents_by_pk(pk_columns:{id:$id}, _set:{status:"erledigt", archived_until:$until}){ id }
    }`, { id, until });
    $err.className='msg ok'; $err.textContent='Als erledigt markiert.';
    closeDlg(); loadDocs();
  }catch(e){ $err.className='msg err'; $err.textContent='Fehler beim Aktualisieren: '+e.message; }
}

function makePdf(doc){
  const { jsPDF } = window.jspdf; const pdf = new jsPDF();
  pdf.setFontSize(16); pdf.text('FFW – Dokument', 14, 16);
  pdf.setFontSize(12);
  pdf.text(`Titel: ${doc.title||'-'}`, 14, 26);
  pdf.text(`Typ: ${doc.type||'-'}`, 14, 33);
  pdf.text(`Erstellt: ${fmtDate(doc.created_at)}`, 14, 40);
  pdf.text(`Status: ${doc.status||'-'}`, 14, 47);
  let y=60; const p=doc.payload||{};
  if (doc.type==='produktausgabe'){
    pdf.setFont(undefined,'bold'); pdf.text('Kopfdaten',14,y); pdf.setFont(undefined,'normal'); y+=7;
    pdf.text(`Einsatznummer: ${p.einsatznummer||'-'}`,14,y); y+=6;
    pdf.text(`Datum: ${p.datum||'-'}`,14,y); y+=10;
    const pos=Array.isArray(p.positionen)?p.positionen:[];
    if (pos.length){
      pdf.setFont(undefined,'bold'); pdf.text('Positionen',14,y); pdf.setFont(undefined,'normal'); y+=4;
      pdf.autoTable({ startY:y+2, head:[['Menge','Artikel / Beschreibung']], body:pos.map(x=>[x.qty??'', x.name??'']), styles:{fontSize:10}, theme:'grid' });
      y = pdf.lastAutoTable.finalY + 6;
    }
    pdf.text(`Ausgetragen von: ${(p.ausgetragen_vorname||'')} ${(p.ausgetragen_nachname||'')}`,14,y);
  } else {
    const lines = pdf.splitTextToSize(JSON.stringify(p,null,2), 180);
    pdf.text(lines,14,y);
  }
  pdf.save(`Dokument-${doc.id}.pdf`);
}

/* ===== 6) Tabs & Logout ===== */
document.getElementById('logoutBtn').addEventListener('click', async ()=>{ try{await nhost.auth.signOut()}catch{} location.href='admin-login.html' });
document.getElementById('tab-open').addEventListener('click', ()=>{ activeTab='open';   document.getElementById('tab-open').classList.add('active'); document.getElementById('tab-archiv').classList.remove('active'); loadDocs(); });
document.getElementById('tab-archiv').addEventListener('click', ()=>{ activeTab='archiv'; document.getElementById('tab-archiv').classList.add('active'); document.getElementById('tab-open').classList.remove('active'); loadDocs(); });

/* ===== 7) Start ===== */
(async function start(){
  if (!(await ensureAdmin())) return;
  loadDocs();
})();
</script>
</body>
</html>
