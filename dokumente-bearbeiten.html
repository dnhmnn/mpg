<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>FFW – Dokumente bearbeiten</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{--rot:#c9152b;--rot-d:#a20f21;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#fafafa;color:#111}
    header{background:var(--rot);color:#fff;padding:16px}
    header .bar{max-width:1000px;margin:0 auto;display:flex;gap:12px;align-items:center;justify-content:space-between}
    h1{font-size:22px;margin:0;line-height:1.3}
    .btn{appearance:none;border:0;border-radius:12px;background:#fff;color:var(--rot);padding:10px 16px;font-weight:700;cursor:pointer}
    .btn:hover{background:#ffe9eb}
    .btn.outline{background:transparent;border:2px solid #fff;color:#fff}
    .btn.sm{padding:6px 10px;border-radius:10px}
    main{max-width:1000px;margin:22px auto;padding:0 14px}
    .card{background:#fff;border-radius:16px;padding:18px 18px 6px;box-shadow:0 2px 14px rgba(0,0,0,.06)}
    .tabs{display:flex;gap:12px;margin:10px 0 12px}
    .tab{border-radius:999px;padding:9px 14px;font-weight:800;color:#a00;background:#ffe9eb;cursor:pointer;user-select:none}
    .tab.active{background:var(--rot);color:#fff}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px;border-bottom:1px solid #eee;font-size:15px}
    th{color:#444;text-align:left}
    .muted{color:#777}
    .right{display:flex;gap:8px;justify-content:flex-end}
    .pill{display:inline-block;background:#eef3ff;color:#2b4bb8;border-radius:999px;padding:4px 10px;font-weight:700}

    dialog{border:0;border-radius:14px;padding:0;max-width:820px;width:calc(100% - 24px)}
    dialog::backdrop{background:rgba(0,0,0,.35)}
    .dlg-head{padding:12px 16px;background:#f6f7fb;border-bottom:1px solid #eee;font-weight:800}
    .dlg-body{padding:16px}

    /* Guard-Overlay (kein Autoredirect) */
    .guard{position:fixed;inset:0;background:rgba(255,255,255,.96);backdrop-filter:saturate(120%) blur(2px);
           display:flex;align-items:center;justify-content:center;padding:20px;z-index:50}
    .guard .box{max-width:520px;background:#fff;border:1px solid #eee;border-radius:16px;padding:18px;box-shadow:0 2px 14px rgba(0,0,0,.06)}
    .danger{background:#ffecee;color:#8c0b1e;border:1px solid #ffd0d4;border-radius:12px;padding:12px 14px}
    a.btnlike{display:inline-block;text-decoration:none}
  </style>
</head>
<body>

<header>
  <div class="bar">
    <h1>FFW – Dokumente bearbeiten</h1>
    <div>
      <button id="toDash" class="btn">Dashboard</button>
      <button id="logout" class="btn outline">Logout</button>
    </div>
  </div>
</header>

<main>
  <section class="card">
    <h2 style="margin:0 0 8px 0;">Dokumente</h2>

    <div class="tabs">
      <div id="tabOpen" class="tab active">Offen</div>
      <div id="tabArch" class="tab">Archiv (30 Tage)</div>
    </div>

    <div id="err" class="danger" style="display:none"></div>

    <table>
      <thead>
        <tr>
          <th>Typ</th>
          <th>Titel</th>
          <th>Erstellt</th>
          <th class="right">Aktionen</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="4" class="muted">Lade …</td></tr>
      </tbody>
    </table>
  </section>
</main>

<dialog id="dlg">
  <div class="dlg-head">
    PDF-Vorschau
    <button id="dlgClose" class="btn sm" style="float:right;margin-top:-4px">Schließen</button>
  </div>
  <div class="dlg-body">
    <p class="muted">Das PDF öffnet in einem neuen Tab – dort „Als PDF sichern“ wählen.</p>
  </div>
</dialog>

<!-- Guard-Overlay (wird via JS ein/ausgeblendet) -->
<div id="guard" class="guard" hidden>
  <div class="box">
    <h3 style="margin:0 0 6px 0;">Anmeldung erforderlich</h3>
    <p class="muted" style="margin:0 0 12px 0;">
      Diese Seite ist nur für Admins. Bitte melde dich an. Nach dem Login kommst du hierher zurück.
    </p>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <a id="goLogin" class="btn a btnlike" href="admin-login.html">Zum Login</a>
      <button id="guardClose" class="btn outline">Später</button>
    </div>
  </div>
</div>

<script>
  /*************** Konfiguration ***************/
  const GRAPHQL_FN = '/.netlify/functions/graphql';   // Netlify Function Proxy
  const OPEN_STATUS  = 'offen';
  const DONE_STATUS  = 'erledigt';

  /*************** DOM Helfer ***************/
  const $ = s => document.querySelector(s);
  const rowsEl = $('#rows'), errEl = $('#err'), dlg = $('#dlg'), guard = $('#guard');
  let currentTab = 'open'; // 'open' | 'arch'

  function fmtDate(s){
    if(!s) return '—';
    const d = new Date(s);
    return d.toLocaleDateString('de-DE',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'});
  }
  function escapeHtml(x=''){
    return String(x).replace(/[&<>"']/g,m=>({'&':'&','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function showErr(msg){ errEl.textContent=msg; errEl.style.display='block'; }
  function clearErr(){ errEl.textContent=''; errEl.style.display='none'; }

  /*************** Login-Guard ohne Autoredirect ***************/
  function guardCheck(){
    const isAdmin = localStorage.getItem('isAdmin') === 'true';
    if(!isAdmin){
      // Overlay zeigen, Rücksprung vorbereiten
      const next = encodeURIComponent(location.pathname.replace(/^.*\//,'dokumente-bearbeiten.html'));
      $('#goLogin').href = `admin-login.html?next=${next}`;
      guard.hidden = false;
      return false;
    }
    guard.hidden = true;
    return true;
  }

  /*************** GraphQL via Netlify-Function ***************/
  async function gql(query, variables){
    const res = await fetch(GRAPHQL_FN, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ query, variables })
    });
    if(!res.ok){ throw new Error(`HTTP ${res.status}`); }
    const json = await res.json();
    if(json.errors?.length){ throw new Error(json.errors[0].message || 'GraphQL-Fehler'); }
    return json.data;
  }

  /*************** Render ***************/
  function row(doc){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><span class="pill">${escapeHtml(doc.type||'—')}</span></td>
      <td>${escapeHtml(doc.title||'—')}</td>
      <td class="muted">${fmtDate(doc.created_at)}</td>
      <td class="right">
        <button class="btn sm" data-pdf="${doc.id}">PDF</button>
        ${doc.status===OPEN_STATUS ? `<button class="btn sm" data-done="${doc.id}">Erledigt</button>` : ''}
      </td>`;
    tr.querySelector('[data-pdf]')?.addEventListener('click', ()=>printDoc(doc));
    tr.querySelector('[data-done]')?.addEventListener('click', ()=>markDone(doc.id));
    return tr;
  }

  async function load(){
    clearErr();
    rowsEl.innerHTML = `<tr><td colspan="4" class="muted">Lade …</td></tr>`;
    try{
      let query, variables;
      if(currentTab==='open'){
        query = `
          query ($status:String!) {
            documents(where:{status:{_eq:$status}}, order_by:{created_at:desc}) {
              id type title status created_at payload
            }
          }`;
        variables = { status: OPEN_STATUS };
      }else{
        const from = new Date(Date.now()-30*24*60*60*1000).toISOString();
        query = `
          query ($status:String!, $from:timestamptz!) {
            documents(
              where:{status:{_eq:$status}, created_at:{_gte:$from}},
              order_by:{created_at:desc}
            ){
              id type title status created_at payload
            }
          }`;
        variables = { status: DONE_STATUS, from };
      }

      const data = await gql(query, variables);
      const list = data.documents || [];
      if(!list.length){
        rowsEl.innerHTML = `<tr><td colspan="4" class="muted">Keine Einträge.</td></tr>`;
        return;
      }
      rowsEl.innerHTML = '';
      list.forEach(d => rowsEl.appendChild(row(d)));
    }catch(e){
      rowsEl.innerHTML = `<tr><td colspan="4" class="muted">Fehler beim Laden.</td></tr>`;
      showErr(`Fehler: ${e.message}`);
    }
  }

  async function markDone(id){
    clearErr();
    try{
      const mutation = `
        mutation($id:uuid!, $status:String!) {
          update_documents_by_pk(pk_columns:{id:$id}, _set:{status:$status}){ id status }
        }`;
      await gql(mutation, { id, status: DONE_STATUS });
      load();
    }catch(e){ showErr(`Konnte nicht auf „erledigt“ setzen: ${e.message}`); }
  }

  /*************** PDF ***************/
  function printDoc(doc){
    const p = doc.payload || {};
    const pos = Array.isArray(p.positionen)? p.positionen : [];
    const html = `
      <!doctype html><html><head>
      <meta charset="utf-8"><title>${escapeHtml(doc.title||'Dokument')}</title>
      <style>
        body{font-family:Arial, sans-serif; padding:24px}
        h1{margin:0 0 6px 0}
        .muted{color:#666}
        .kv{display:grid;grid-template-columns:180px 1fr;gap:6px 12px;margin-top:10px}
        ol{margin:6px 0 0 22px}
      </style></head><body>
      <h1>${escapeHtml(doc.title||'Dokument')}</h1>
      <div class="muted">Typ: ${escapeHtml(doc.type||'—')} • Erstellt: ${fmtDate(doc.created_at)}</div>
      <div class="kv">
        ${p.einsatznummer?`<div>Einsatznummer</div><div>${escapeHtml(p.einsatznummer)}</div>`:''}
        ${p.datum?`<div>Datum</div><div>${escapeHtml(p.datum)}</div>`:''}
        ${(p.ausgetragen_vorname||p.ausgetragen_nachname)?`<div>Ausgetragen von</div><div>${escapeHtml(p.ausgetragen_vorname||'')} ${escapeHtml(p.ausgetragen_nachname||'')}</div>`:''}
        <div>Positionen</div>
        <div>${
          pos.length?`<ol>${pos.map(i=>`<li>${escapeHtml(i.qty ?? i.q ?? 1)} × ${escapeHtml(i.name ?? i.artikel ?? '')}</li>`).join('')}</ol>`:'—'
        }</div>
      </div></body></html>`;
    const w = window.open('', '_blank');
    w.document.write(html); w.document.close(); w.focus();
    setTimeout(()=>{ try{ w.print(); }catch(_){} }, 250);
  }

  /*************** UI Events ***************/
  $('#toDash').onclick = ()=> location.href='admin-dashboard.html';
  $('#logout').onclick  = ()=> { localStorage.removeItem('isAdmin'); location.href='admin-login.html'; };
  $('#dlgClose').onclick = ()=> dlg.close();
  $('#guardClose').onclick = ()=> guard.hidden = true;

  const tabOpen = $('#tabOpen'), tabArch = $('#tabArch');
  tabOpen.onclick = ()=>{ currentTab='open'; tabOpen.classList.add('active'); tabArch.classList.remove('active'); load(); };
  tabArch.onclick = ()=>{ currentTab='arch'; tabArch.classList.add('active'); tabOpen.classList.remove('active'); load(); };

  /*************** Start ***************/
  (function init(){
    // Guard nur anzeigen (kein Redirect)
    const ok = guardCheck();
    if(ok) load(); else rowsEl.innerHTML = `<tr><td colspan="4" class="muted">Anmeldung erforderlich.</td></tr>`;
  })();
</script>
</body>
</html>
