<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>FFW – Dokumente bearbeiten</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{ --rot:#c8102e; --hell:#fff; --bg:#f7f7f7; --text:#222; --muted:#6b7280; }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:'Atkinson Hyperlegible', Arial, sans-serif; background:var(--bg); color:var(--text) }
    header{ background:var(--rot); color:#fff; padding:14px 16px; display:flex; align-items:center; gap:12px; flex-wrap:wrap }
    header .brand{ font-weight:700; font-size:20px; flex:1 }
    header .btn{ background:#fff1; color:#fff; border:2px solid #fff6; padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer }
    header .btn:hover{ background:#fff2 }

    .wrap{ max-width:980px; margin:18px auto; padding:0 12px }
    .card{ background:#fff; border-radius:14px; box-shadow:0 3px 12px rgba(0,0,0,.06); padding:16px; margin-bottom:12px }

    h1{ margin:0 0 10px 0; color:var(--rot); font-size:28px }
    .tabs{ display:flex; gap:10px; margin:10px 0 12px }
    .tab{ background:#f1f1f1; color:#333; padding:8px 12px; border-radius:100px; font-weight:700; cursor:pointer; border:2px solid transparent }
    .tab.active{ background:#ffe6ea; border-color:var(--rot); color:var(--rot) }

    .error{ color:#b00020; font-weight:700; margin:4px 0 10px }
    .muted{ color:var(--muted) }

    table{ width:100%; border-collapse:collapse }
    th, td{ padding:12px; border-bottom:1px solid #eee; text-align:left; vertical-align:top }
    th{ color:var(--rot); background:#fff; position:sticky; top:0 }
    tr:hover{ background:#fff8f9 }

    .btn-sm{ background:var(--rot); color:#fff; border:none; border-radius:8px; padding:7px 10px; font-weight:700; cursor:pointer }
    .btn-ghost{ background:#f3f4f6; color:#111827; border:none; border-radius:8px; padding:7px 10px; font-weight:700; cursor:pointer }
    .btn-row{ display:flex; gap:8px; flex-wrap:wrap }

    /* Modal */
    dialog{ border:none; border-radius:12px; max-width:780px; width:96%; padding:0; }
    dialog::backdrop{ background:rgba(0,0,0,.35) }
    .modal-head{ padding:14px 16px; background:var(--rot); color:#fff; border-radius:12px 12px 0 0; font-weight:700 }
    .modal-body{ padding:16px; max-height:70vh; overflow:auto; }
    .modal-foot{ padding:12px 16px; display:flex; justify-content:flex-end; gap:8px }

    .kv{ display:grid; grid-template-columns:160px 1fr; gap:6px 12px; }
    .chip{ display:inline-block; background:#f3f4f6; padding:2px 8px; border-radius:999px; margin-right:6px }
    .poslist{ margin:6px 0 0 0; padding:0 0 0 18px }
  </style>
</head>
<body>
  <header>
    <div class="brand">FFW – Dokumente bearbeiten</div>
    <button class="btn" id="toDash">Dashboard</button>
    <button class="btn" id="logout">Logout</button>
  </header>

  <div class="wrap">
    <div class="card">
      <h1>Dokumente</h1>
      <div class="tabs">
        <button class="tab active" id="tabOpen">Offen</button>
        <button class="tab" id="tabArchive">Archiv (30 Tage)</button>
      </div>

      <div id="err" class="error" style="display:none"></div>

      <table>
        <thead>
          <tr>
            <th>Typ</th>
            <th>Titel</th>
            <th>Erstellt</th>
            <th>Aktionen</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="4" class="muted" id="loading">Lade …</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Vorschau-Modal -->
  <dialog id="dlg">
    <div class="modal-head" id="dlgTitle">Dokument</div>
    <div class="modal-body" id="dlgBody"></div>
    <div class="modal-foot">
      <button class="btn-ghost" id="dlgClose">Schließen</button>
      <button class="btn-sm" id="dlgPdf">PDF / Drucken</button>
    </div>
  </dialog>

  <!-- Nhost von CDN (keine lokale Datei nötig) -->
  <script src="https://cdn.jsdelivr.net/npm/@nhost/nhost-js@latest/dist/nhost-js.umd.min.js"></script>

  <script>
    // ---------- Konfiguration ----------
    const NHOST_SUBDOMAIN = 'hpjfrhktprpuuxvvlpsb';
    const NHOST_REGION    = 'eu-central-1';
    const GRAPHQL_PROXY   = '/api/graphql'; // Netlify-Function (per netlify.toml gemappt)

    // ---------- Nützliche Helfer ----------
    const $ = sel => document.querySelector(sel);
    const rowsEl   = $('#rows');
    const errEl    = $('#err');
    const tabOpen  = $('#tabOpen');
    const tabArch  = $('#tabArchive');
    const dlg      = $('#dlg');
    const dlgBody  = $('#dlgBody');
    const dlgTitle = $('#dlgTitle');

    const nhost = new window.Nhost.NhostClient({ subdomain: NHOST_SUBDOMAIN, region: NHOST_REGION });

    function fmtDate(iso){
      if(!iso) return '—';
      const d = new Date(iso);
      return d.toLocaleString('de-DE', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
    }

    async function gql(query, variables){
      const res = await fetch(GRAPHQL_PROXY, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ query, variables })
      });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const json = await res.json();
      if(json.errors) throw new Error(json.errors.map(e=>e.message).join(' | '));
      return json.data;
    }

    function setError(msg){
      if(!msg){ errEl.style.display='none'; errEl.textContent=''; return; }
      errEl.textContent = msg;
      errEl.style.display = 'block';
    }

    // ---------- Admin-Guard (ohne Popup) ----------
    async function guard(){
      try{
        await nhost.auth.refreshSession().catch(()=>{});
        const u = await nhost.auth.getUser();
        if(!u?.user){
          location.href = 'admin-login.html?next=' + encodeURIComponent(location.pathname);
          return false;
        }
        // Prüfe Rolle admin aus dem JWT
        let isAdmin = false;
        try{
          const token = nhost.auth.getDecodedAccessToken?.();
          const roles = token?.['x-hasura-allowed-roles'] || [];
          isAdmin = roles.includes('admin');
        }catch(e){}
        if(!isAdmin){
          // Still no popup – einfach zurück zum Dashboard
          location.href = 'admin-dashboard.html';
          return false;
        }
        return true;
      }catch(e){
        location.href = 'admin-login.html?next=' + encodeURIComponent(location.pathname);
        return false;
      }
    }

    // ---------- Daten laden & rendern ----------
    let currentTab = 'open';

    const QUERY_OPEN = `
      query {
        documents(
          where: { status: { _eq: "offen" }, archived_at: { _is_null: true } }
          order_by: { created_at: desc }
        ){
          id type title created_at status archived_at archived_until payload
        }
      }`;

    const QUERY_ARCH = `
      query {
        documents(
          where: { archived_at: { _is_null: false } }
          order_by: { archived_at: desc }
        ){
          id type title created_at status archived_at archived_until payload
        }
      }`;

    function renderRows(list){
      rowsEl.innerHTML = '';
      if(!list.length){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="4" class="muted">Keine Einträge.</td>`;
        rowsEl.appendChild(tr);
        return;
      }

      list.forEach(doc=>{
        const tr = document.createElement('tr');

        // Titel anklickbar -> Vorschau
        const title = doc.title || '(ohne Titel)';
        const created = fmtDate(doc.created_at);

        const actions = document.createElement('div');
        actions.className = 'btn-row';

        const btnOpen = document.createElement('button');
        btnOpen.className = 'btn-ghost';
        btnOpen.textContent = 'Öffnen';
        btnOpen.onclick = ()=> showDoc(doc);
        actions.appendChild(btnOpen);

        const btnPdf = document.createElement('button');
        btnPdf.className = 'btn-ghost';
        btnPdf.textContent = 'PDF';
        btnPdf.onclick = ()=> printDoc(doc);
        actions.appendChild(btnPdf);

        if(currentTab==='open'){
          const btnDone = document.createElement('button');
          btnDone.className = 'btn-sm';
          btnDone.textContent = 'Erledigt & Archivieren';
          btnDone.onclick = ()=> markDone(doc.id);
          actions.appendChild(btnDone);
        }

        tr.innerHTML = `
          <td>${escapeHtml(doc.type || '—')}</td>
          <td><a href="javascript:void(0)">${escapeHtml(title)}</a></td>
          <td>${created}</td>
          <td></td>
        `;
        tr.querySelector('a').onclick = ()=> showDoc(doc);
        tr.children[3].appendChild(actions);
        rowsEl.appendChild(tr);
      });
    }

    function escapeHtml(s){
      return String(s ?? '')
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#039;');
    }

    async function load(){
      setError('');
      rowsEl.innerHTML = `<tr><td colspan="4" class="muted" id="loading">Lade …</td></tr>`;
      try{
        const data = await gql(currentTab==='open' ? QUERY_OPEN : QUERY_ARCH);
        renderRows(data.documents || []);
      }catch(e){
        setError('Fehler beim Laden: ' + e.message);
        rowsEl.innerHTML = '';
      }
    }

    // ---------- Aktionen ----------
    async function markDone(id){
      setError('');
      const now = new Date();
      const in30 = new Date(now.getTime() + 30*24*60*60*1000);
      const MUT = `
        mutation($id:uuid!, $arch:timestamptz!, $until:timestamptz!){
          update_documents_by_pk(
            pk_columns:{id:$id},
            _set:{ status:"erledigt", archived_at:$arch, archived_until:$until }
          ){ id }
        }`;
      try{
        await gql(MUT, { id, arch: now.toISOString(), until: in30.toISOString() });
        await load();
      }catch(e){
        setError('Konnte nicht archivieren: ' + e.message);
      }
    }

    function showDoc(doc){
      dlgTitle.textContent = doc.title || 'Dokument';
      const p = doc.payload || {};
      const pos = Array.isArray(p.positionen) ? p.positionen : [];
      const posHtml = pos.length
        ? `<ol class="poslist">` + pos.map(it=>`<li>${escapeHtml(it.qty ?? it.q ?? 1)} × ${escapeHtml(it.name ?? it.artikel ?? '')}</li>`).join('') + `</ol>`
        : `<div class="muted">Keine Positionen.</div>`;

      dlgBody.innerHTML = `
        <div class="kv">
          <div>Typ</div><div><span class="chip">${escapeHtml(doc.type||'—')}</span></div>
          <div>Status</div><div><span class="chip">${escapeHtml(doc.status||'—')}</span></div>
          <div>Erstellt</div><div>${fmtDate(doc.created_at)}</div>
          ${doc.archived_at ? `<div>Archiviert</div><div>${fmtDate(doc.archived_at)}</div>` : ''}
          ${doc.archived_until ? `<div>Archiv bis</div><div>${fmtDate(doc.archived_until)}</div>` : ''}

          ${p.einsatznummer ? `<div>Einsatznummer</div><div>${escapeHtml(p.einsatznummer)}</div>`:''}
          ${p.datum ? `<div>Datum</div><div>${escapeHtml(p.datum)}</div>`:''}
          ${(p.ausgetragen_vorname||p.ausgetragen_nachname) ? `<div>Ausgetragen von</div><div>${escapeHtml(p.ausgetragen_vorname||'')} ${escapeHtml(p.ausgetragen_nachname||'')}</div>`:''}
          <div>Positionen</div><div>${posHtml}</div>
          ${p.bemerkung ? `<div>Bemerkung</div><div>${escapeHtml(p.bemerkung)}</div>`:''}
        </div>
      `;
      dlg.showModal();
      // PDF Button koppeln
      $('#dlgPdf').onclick = ()=> printDoc(doc);
    }

    function printDoc(doc){
      // Simple Druckansicht in neuem Fenster
      const p = doc.payload || {};
      const pos = Array.isArray(p.positionen) ? p.positionen : [];
      const w = window.open('', '_blank');
      w.document.write(`
        <!doctype html><html><head>
        <meta charset="utf-8">
        <title>${escapeHtml(doc.title || 'Dokument')}</title>
        <style>
          body{ font-family:Arial, sans-serif; padding:20px }
          h1{ margin:0 0 8px 0; }
          .muted{ color:#666 }
          .kv{ display:grid; grid-template-columns:180px 1fr; gap:6px 12px; margin-top:10px }
          ol{ margin:6px 0 0 22px }
        </style>
        </head><body>
          <h1>${escapeHtml(doc.title || 'Dokument')}</h1>
          <div class="muted">Typ: ${escapeHtml(doc.type||'—')} • Erstellt: ${fmtDate(doc.created_at)}</div>
          <div class="kv">
            ${p.einsatznummer ? `<div>Einsatznummer</div><div>${escapeHtml(p.einsatznummer)}</div>`:''}
            ${p.datum ? `<div>Datum</div><div>${escapeHtml(p.datum)}</div>`:''}
            ${(p.ausgetragen_vorname||p.ausgetragen_nachname) ? `<div>Ausgetragen von</div><div>${escapeHtml(p.ausgetragen_vorname||'')} ${escapeHtml(p.ausgetragen_nachname||'')}</div>`:''}
            <div>Positionen</div><div>${pos.length ? `<ol>${pos.map(i=>`<li>${escapeHtml(i.qty ?? i.q ?? 1)} × ${escapeHtml(i.name ?? i.artikel ?? '')}</li>`).join('')}</ol>` : '—'}</div>
          </div>
          <script>window.onload = function(){ window.print(); }</script>
        </body></html>
      `);
      w.document.close();
    }

    // ---------- UI Events ----------
    $('#toDash').onclick = ()=> location.href = 'admin-dashboard.html';
    $('#logout').onclick  = async ()=>{
      try{ await nhost.auth.signOut(); }catch(e){}
      location.href = 'admin-login.html';
    };
    $('#dlgClose').onclick = ()=> dlg.close();

    tabOpen.onclick = ()=>{ currentTab='open'; tabOpen.classList.add('active'); tabArch.classList.remove('active'); load(); };
    tabArch.onclick = ()=>{ currentTab='arch'; tabArch.classList.add('active'); tabOpen.classList.remove('active'); load(); };

    // ---------- Start ----------
    (async function(){
      const ok = await guard();
      if(!ok) return;
      load();
    })();
  </script>
</body>
</html>
